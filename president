You are working in the Troll City codebase (Supabase Postgres + RLS + React). Implement a complete, realistic Presidency + Election system with strict DB enforcement (no frontend trust). Follow these requirements exactly and do not change any existing non-election app behavior.

HARD REQUIREMENTS (DO NOT DEVIATE)

Election voting period is exactly 3 weeks.

After 3 weeks, the winner becomes President.

President term is exactly 2 months from election finalization.

Candidates must create/upload a campaign banner and it must display in UI. No banner = cannot run.

Home page gets a new tab next to Explore feed called: “Troll President”

It displays Top 5 runners each week (ISO week) by vote count during the open election.

It also displays the election countdown timer.

Users vote using our voting system concept, but upgrade it to be ballot-based and secure:

Enforce one vote per voter per week per election (weekly voting cadence).

Winner receives:

a President badge (permanent badge record)

a gold username style while they are actively President (auto-reverts when term ends)

The President can raise payouts ONLY if President Treasury is funded (real money deposits from Stripe/PayPal). Must be DB-gated and atomic (reserve/deduct funds).

Add a Vice President role that the President can elect/appoint (President chooses the VP). VP expires with the President term (or earlier if removed).

Dashboards / routes:

/admin is admin only

/president is president only

/secretary is secretary + admin (NOT president unless explicitly stated; default: president cannot access secretary dashboard)

President cannot see or edit Admin Dashboard (block both UI and DB).

Admin can access other dashboards per above, but not president dashboard (keep president dashboard president-only).

Use RLS on all new tables. Clients must not be able to bypass via direct inserts/updates; sensitive writes happen only through SECURITY DEFINER functions with explicit authorization checks.

Log important actions in audit_logs (or create it if missing): election creation, candidate signup, vote cast, election finalized, president assigned, VP appointed/removed, payout policy raise attempts and funding reservations.

PART A — DATABASE: TABLES + FUNCTIONS + VIEWS + RLS
A1) Roles

Ensure system_roles contains president and vice_president and secretary if not present. President and Vice President are time-bound via user_roles.expires_at.

system_roles(name unique, hierarchy_rank int, is_staff bool, is_admin bool, ...)

user_roles(user_id, role_id, expires_at, is_elected bool default false, ...)

President term is granted by election finalization (2 months). Vice President is appointed by President and should expire at same time as President role by default.

A2) Elections schema (3-week election)

Create tables:

president_elections

id uuid pk

status: draft/open/closed/finalized/void

starts_at timestamptz

ends_at timestamptz (must be starts_at + 3 weeks when created)

created_by uuid

created_at timestamptz

metadata jsonb

president_candidates

id uuid pk

election_id fk

user_id uuid

status: pending/approved/rejected/withdrawn

banner_path text NOT NULL (required)

display_name, slogan, statement optional

created_at, approved_by, approved_at

unique(election_id, user_id)

president_votes

id uuid pk

election_id fk

candidate_id fk

voter_id uuid

created_at timestamptz

week_key text NOT NULL (ISO week like 2026-W05)

UNIQUE(election_id, voter_id, week_key) <-- enforces 1 vote per voter per week per election

Create a trigger that sets week_key based on created_at UTC, so clients cannot spoof it.

A3) Badges + Username style

Create:

badges(code unique, name, description)

user_badges(user_id, badge_id unique(user_id,badge_id), granted_at, granted_by, metadata)
Insert badge code president.

Add to user_profiles:

username_style text default 'default'

When President role is granted and active -> set username_style = 'gold' and grant president badge (idempotent). When term expires -> revert to default.

Because time expiry doesn’t trigger automatically, implement a scheduled cleanup function:

revert_expired_president_styles() updates profiles back to default if no active president role exists.

A4) Treasury & payout raise gate (President must fund app)

Create president_treasury_ledger:

amount_cents bigint (positive deposits, negative spends/reserves)

kind deposit/reserve/release/spend/refund

currency default USD

external_ref text

actor_id uuid

funded_by uuid nullable

created_at

metadata jsonb

Create view president_treasury_balance summing by currency.

Create payout_policy table (single active row is fine) with fields representing payout parameters (rate/caps). Lock down direct updates (RLS admin-only or service-only).

Create function president_raise_payouts(...) SECURITY DEFINER that:

checks caller is currently active President

computes/accepts required extra liability cents

checks treasury balance >= required

writes a reserve or spend row to ledger (atomic in same tx)

updates payout_policy upward

writes to audit_logs

NO OTHER PATH may increase payout_policy. Deny direct updates by RLS.

Deposits must be written by backend/webhook only (service role) after confirming Stripe/PayPal success.

A5) Vice President appointment (chosen by President)

Create president_appointments table:

id uuid pk

president_user_id uuid

vice_president_user_id uuid

starts_at timestamptz default now()

ends_at timestamptz not null (defaults to president role expiry)

status active/removed/expired

created_at

removed_at, removed_by

metadata jsonb

Also grant a time-bound user_roles role vice_president that expires at the same time as the president term. Provide functions:

appoint_vice_president(p_user_id uuid) SECURITY DEFINER:

Only callable by active President

Target user must be eligible (not banned/suspended)

Remove/expire any existing active VP

Create appointment record

Insert/Upsert user_roles grant for vice_president with expires_at = president_expires_at

Audit log

remove_vice_president() SECURITY DEFINER:

Only callable by active President

Expires VP grant + marks appointment removed

Audit log

Vice President does NOT grant admin powers.

A6) Election functions

Implement functions:

create_president_election() SECURITY DEFINER

Prevent if an election is already open/draft with ends_at > now()

Creates election with status open, starts_at now(), ends_at now()+3 weeks

is_eligible_president_candidate(user) function using user_profiles fields:

not banned/suspended

min account age (e.g. 14 days)

min credit_score (e.g. 600)
(Use existing columns; don’t invent new ones if already present.)

signup_president_candidate(election_id, banner_path, display_name, slogan, statement) SECURITY DEFINER

election must be open

must be eligible candidate

inserts candidate status pending (or auto-approved if no secretary flow)

banner_path required

vote_for_president_candidate(election_id, candidate_id) SECURITY DEFINER

election open

candidate approved

inserts into votes (week_key auto set by trigger)

relies on UNIQUE(election_id,voter_id,week_key) to enforce weekly vote limit

audit log

finalize_president_election(election_id) SECURITY DEFINER (cron/service role)

only if now() >= ends_at

picks winner by TOTAL votes across the entire election (all weeks)

expires any active president role grants

grants new president role for 2 months (expires_at now()+2 months, is_elected true)

calls grant badge + sets gold username

closes/finalizes election

audit log

Create views for UI:

president_weekly_leaderboard (votes per candidate per week)

president_total_leaderboard (total votes per candidate)

A7) RLS

Enable RLS on all new tables.
Policies:

Public can read:

open elections

approved candidates

leaderboard views

finalized results summary

Users can only see their own ballots/votes if exposed; ideally keep votes table not directly readable and use views.

Inserts/updates to sensitive tables must be blocked for client; use RPC functions only (SECURITY DEFINER).

Admin dashboard data remains admin-only and president must not be added to any admin policies.

PART B — FRONTEND UI
B1) Home tab “Troll President”

Add a tab next to Explore feed:

label “Troll President”

shows:

current open election countdown (ends_at)

candidate cards from weekly top 5 (current ISO week) sorted by votes desc

each card shows banner image, display_name, slogan, and a Vote button

Vote button calls RPC vote_for_president_candidate

Disable Vote if user already voted this week (check by attempting insert and handling unique constraint, or pre-check via lightweight RPC)

Add “Run for President” CTA:

visible only if eligible and election is open

opens candidate signup form

requires banner upload (Supabase Storage) -> store path in DB via signup_president_candidate

B2) President Dashboard (/president)

President-only page. Contents:

Current treasury balance + ledger (read-only)

Payout policy + “Raise payouts” action that calls president_raise_payouts

Vice President section:

appoint VP (select user)

remove VP

Election status summary (read-only)

Display President badge + gold username preview (from profile style)

B3) Secretary Dashboard (/secretary)

Accessible by secretary + admin only. NOT accessible by president.

Candidate approval queue (pending candidates)

Approve/reject candidate actions via SECURITY DEFINER functions (create them)

Election admin panel (view election windows, close/finalize triggers if allowed)

B4) Admin Dashboard (/admin)

Admin only. Do not grant president access. Ensure route guard and any data fetching remains admin-only.

B5) Guards

Implement RequireRole route guard (and nav gating) using a single “roles fetch” hook:

Fetch user roles from DB (user_roles join system_roles where active) and user_profiles.is_admin

Use it to guard routes:

/admin -> admin only

/president -> president only

/secretary -> secretary or admin
Do NOT treat president as admin.

PART C — SCHEDULER / JOBS

Add scheduled jobs (Edge cron preferred):

Check for ended elections and call finalize_president_election

Run revert_expired_president_styles() daily to remove gold style from expired presidents

(Optional) ensure an election exists if none active, or allow users to create election via CTA

PART D — ACCEPTANCE TESTS

User without banner cannot become candidate.

Candidate appears in Troll President tab only when approved.

User can vote only once per week (unique constraint).

Weekly Top 5 updates correctly.

After 3 weeks election ends, finalize assigns President role for 2 months, grants badge, sets gold username.

When President term expires, gold username auto-reverts.

President cannot access /admin at all (route + DB).

President can appoint/remove Vice President; VP expires with President term.

President cannot raise payouts unless treasury has enough funds; raising payouts reserves/deducts funds and is audited.

Deliverables:

SQL migration(s) for schema + RLS + functions

React pages/components and route wiring

Storage bucket config for campaign banners (document required paths)

Edge cron job(s) code for finalization and cleanup

Minimal UI that is functional and uses real data (no mock)

Do not break existing Troll City features; add this system cleanly.