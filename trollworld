TRAE — MASTER PROMPT (FINAL + LIVEKIT REQUIREMENT ADDED, AUTHORITATIVE)
======================================================================

ABSOLUTE RULE (READ FIRST)
----------------------------------------------------------------------
You MUST NOT modify, drop, rename, refactor, or reinterpret ANY existing Troll City tables,
columns, enums, functions, triggers, views, RLS policies, or economy logic.

You may ONLY:
- ADD new tables if required
- ADD new columns if required
- ADD new RPC/functions if required

All existing Troll City behavior, restrictions (including “cannot update restricted column” rules),
economy, permissions, and LiveKit usage patterns MUST remain intact.

======================================================================
0) OBJECTIVE
======================================================================
Build **Troll World** as a **3D world** using **PlayCanvas Engine (self-hosted)** that is fully
connected to **Troll City**.

Troll City and Troll World are TWO MODES of the SAME PLATFORM:
- Same auth user
- Same wallet/balance
- Same inventory/ownership
- Same permissions/roles
- Same rule enforcement and transactions
- Same LiveKit broadcasting/calling surfaces wherever Troll City uses LiveKit

Troll World is NOT a separate game.

======================================================================
1) ENGINE + CORE RULES (NON-NEGOTIABLE)
======================================================================

ENGINE
- Use PlayCanvas Engine (self-hosted). Babylon.js is strictly forbidden.

BACKEND AUTHORITY
- Supabase remains the single source of truth for durable state:
  - auth.users
  - existing user_profiles
  - all existing inventory tables
  - all existing housing/vehicles/items/roles systems
  - all existing coin/ledger/transactions systems
- Client must NEVER directly mutate restricted columns (coins, is_live, etc.)
- All economy mutations MUST go through existing secure backend logic / RPC functions.

COST SAFETY
- DO NOT use Supabase Realtime for movement/rotation/position spam.
- Use LiveKit Data Channels or WebSockets for movement replication.
- Supabase Realtime only for low-frequency durable updates (ownership, roles, onboarding flags).
- 3D assets hosted via CDN/object storage (NOT Supabase Storage).

======================================================================
2) AUTH PAGE — MODE SELECTION (REQUIRED)
======================================================================
On existing /auth:
- [ Enter Troll City ]
- [ Enter Troll World ]

Rules:
- Selection required before signup/signin.
- Persist selection in route state:
  - /auth?mode=city
  - /auth?mode=world
- Auth/session is identical for both.
- After login:
  - city  → redirect Troll City routes
  - world → redirect /world

This does NOT create new users. It is a mode selector only.

======================================================================
3) NEW USER FLOW — TROLL WORLD (MUST MATCH TROLL CITY GATING)
======================================================================
If a NEW USER selects Enter Troll World, they MUST complete the same gating steps as Troll City.

Order (no skips):
1) Terms & Agreements
2) Driver Test (existing driver test logic)
3) Profile Setup (existing user_profiles)
4) Spawn into Troll World city

If user already completed these steps in Troll City, do not force re-do.

Spawn rules:
- If user owns housing → spawn at their house/apartment
- If homeless → spawn at default street spawn

======================================================================
4) LIVEKIT REQUIREMENTS (CRITICAL)
======================================================================
ANYWHERE Troll City uses LiveKit, Troll World must mirror that capability in 3D.

This includes (at minimum):
- Users can be “LIVE” (broadcasting) and appear live in-world.
- “Troll Court” LiveKit sessions must be accessible/enterable from Troll World.
- Any LiveKit-based call/broadcast room used in Troll City must be reachable in Troll World.

IN-WORLD BEHAVIOR:
A) Live Presence in the City
- If a user is LIVE, Troll World must represent them as a “LIVE location” that others can approach.
- Users who walk/drive near a LIVE user/location should:
  - See a clear LIVE indicator (glow/crown/sign)
  - Have an interact prompt (Join/Watch/Listen)
  - Be able to enter the LiveKit experience (watch/participate) from within Troll World

B) Joining LiveKit From World
- Joining must reuse the same tokens/rooms logic Troll City uses.
- Do NOT create a separate LiveKit auth system.
- Use the same env keys and server endpoints already used in Troll City.

C) Movement + Proximity
- Movement replication uses LiveKit DataChannel or WebSocket.
- Proximity detection is computed client-side or in a lightweight world server;
  it must NOT cause DB write spam.
- Proximity events (entered/left radius of a live session) can be ephemeral (no DB persistence),
  unless Troll City already persists similar events.

D) LiveKit Surfaces/Portals
- In Troll World, implement “portals/buildings/interaction points” for:
  - Troll Court (enter courtroom session)
  - Any other LiveKit zones in Troll City (broadcast rooms, pods, lounges, etc.)
- The portal triggers must route the user into the correct LiveKit session UI overlay.

E) UI Strategy
- In-world interaction triggers a web overlay panel:
  - (a) minimal player controls + video/audio
  - (b) chat if Troll City has it
- The user should feel like they are still in-world while watching/joining LiveKit.

======================================================================
5) ADDITIVE DATABASE CHANGES (ONLY IF NEEDED)
======================================================================
DO NOT duplicate existing tables. Only add if there is no existing equivalent.

You MAY add these NEW tables ONLY if required:
A) user_onboarding
- user_id (uuid PK)
- terms_accepted_at
- driver_test_passed_at
- profile_completed_at
- onboarding_completed_at
- updated_at

B) user_mode_state (optional)
- user_id (uuid PK)
- last_mode ('city'|'world')
- last_entered_at

C) user_world_spawn (only spawn coordinates)
- user_id (uuid PK)
- spawn_type ('house'|'apartment'|'street')
- spawn_ref_id (uuid nullable)
- spawn_x/y/z numeric
- updated_at

If existing tables already store these things, DO NOT add any new table/column.

======================================================================
6) TROLL WORLD CLIENT REQUIREMENTS
======================================================================
Route: /world
- PlayCanvas scene embedded
- Loading screen
- Asset streaming
- Third-person camera + movement
- Collision + basic physics
- Multiplayer presence via LiveKit Data Channel / WebSocket
- Proximity interaction system:
  - detect distance to LIVE users/zones
  - show interact UI
  - open LiveKit session overlay

======================================================================
7) CITY ↔ WORLD SYNC RULES
======================================================================
- One wallet/balance across both
- One inventory/ownership across both
- One housing state and spawn logic
- One role/permission system

Examples:
- Buy car in City → car appears in World
- Housing changes → World spawn changes
- Role changes → World permissions match City
- LiveKit rooms available in City → accessible via World portals and proximity

No duplicated state. No mirrored economy logic.

======================================================================
8) SECURITY & PRODUCTION RULES
======================================================================
- No test coins
- No bypass logic
- No client-side mutation of restricted columns
- No new “shadow economy”
- Respect all existing RLS and server enforcement

======================================================================
9) ACCEPTANCE CHECKS (MUST PASS)
======================================================================
- New user → Enter Troll World → onboarding gates → world loads
- Existing user → Enter Troll World → skips completed steps
- Wallet/inventory always match City
- No Supabase realtime movement spam
- Users can walk/drive to LIVE users/zones and join LiveKit
- Troll Court LiveKit is accessible in-world
- No Babylon anywhere
- No existing table modified

END
