[{"filePath":"E:\\trollcity-1\\CITY_3D_IMPLEMENTATION_EXAMPLES.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\MOBILE_BROADCAST_QUICKSTART.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":211,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":211,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":223,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":223,"endColumn":36,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\add-test-coins.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\analyze_lint.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\analyze_lint_details.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\_shared\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\broadcast-seats.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\livekit-token.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\livekitconfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\payout-approve.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\payout-reject.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\payout-request.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\payouts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\paypal\\capture-order.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\paypal\\create-order.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\platform-fees.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe\\create-checkout-session.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe\\create-setup-intent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe\\delete-payment-method.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe\\save-payment-method.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe\\set-default-payment-method.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\stripe\\webhook.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\api\\telemetry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply-migration.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply-migrations.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_court_sessions.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_fix.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":16,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'runSql' is defined but never used. Allowed unused vars must match /^_/u.","line":20,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'statement' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":31,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js'\nimport fs from 'fs'\nimport path from 'path'\nimport dotenv from 'dotenv'\n\ndotenv.config()\n\nconst supabaseUrl = process.env.VITE_SUPABASE_URL\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error('‚ùå Missing Supabase env vars')\n  process.exit(1)\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: { persistSession: false, autoRefreshToken: false }\n})\n\nasync function runSql() {\n  const sql = fs.readFileSync(path.join(process.cwd(), 'fix_admin_broadcasts_permissions.sql'), 'utf8')\n  \n  // Split SQL into individual statements\n  const statements = sql\n    .split(';')\n    .map(s => s.trim())\n    .filter(s => s.length > 0)\n\n  console.log(`Found ${statements.length} statements to execute...`)\n\n  for (const statement of statements) {\n    // We can't execute raw SQL directly via JS client unless we use rpc or just pg\n    // But since we have many other scripts doing things differently, let's try to use\n    // the 'pg' library which is in devDependencies\n    console.log('Skipping direct SQL execution via supabase-js client as it does not support raw SQL.')\n  }\n}\n\n// Better approach: Use the postgres connection string if available, or just use the existing helper scripts\nconsole.log('Please use the existing run_migration.js script mechanism or similar.')\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_fix_properties_rls.cjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":50,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { createClient } = require('@supabase/supabase-js');\n\n// Initialize Supabase client\nconst supabase = createClient(\n  process.env.VITE_SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_ROLE_KEY\n);\n\nconst migrationSQL = `\n-- Fix RLS policies for properties table\n-- Allow users to insert their own properties (e.g. starter home)\n-- Fix potential issue with UPDATE policy referencing wrong column name\n\nDO $$\nBEGIN\n  -- Enable RLS (idempotent)\n  ALTER TABLE public.properties ENABLE ROW LEVEL SECURITY;\n\n  -- Drop incorrect policies if they exist\n  DROP POLICY IF EXISTS \"Owners update properties\" ON public.properties;\n  DROP POLICY IF EXISTS \"Users can insert own properties\" ON public.properties;\n  \n  -- Create \"Owners update properties\" policy\n  CREATE POLICY \"Owners update properties\"\n  ON public.properties\n  FOR UPDATE\n  USING (auth.uid() = owner_user_id);\n\n  -- Create \"Users can insert own properties\" policy\n  CREATE POLICY \"Users can insert own properties\"\n  ON public.properties\n  FOR INSERT\n  WITH CHECK (auth.uid() = owner_user_id);\n\n  -- Ensure \"Public read properties\" policy exists\n  IF NOT EXISTS (\n      SELECT 1 FROM pg_policies \n      WHERE schemaname = 'public' AND tablename = 'properties' AND policyname = 'Public read properties'\n  ) THEN\n      CREATE POLICY \"Public read properties\" ON public.properties FOR SELECT USING (true);\n  END IF;\nEND $$;\n`;\n\nasync function runMigration() {\n  try {\n    console.log('Running migration to fix properties RLS policies...');\n    \n    // Execute the migration SQL\n    const { data, error } = await supabase.rpc('execute_sql', { sql: migrationSQL });\n    \n    if (error) {\n      console.error('Migration failed:', error);\n      return;\n    }\n    \n    console.log('‚úì Migration completed successfully!');\n    console.log('RLS policies for \"properties\" table have been updated.');\n    \n  } catch (error) {\n    console.error('Error running migration:', error);\n  }\n}\n\nrunMigration();\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_fix_user_id.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_migration_pg.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_starter_vehicle_fix.mjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'funcExists' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":44,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Quick fix script to ensure starter vehicles are granted to new users\r\n * Run this to apply the migration that seeds vehicles_catalog and fixes the grant function\r\n */\r\n\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = process.env.SUPABASE_URL || 'https://yjxpwfalenorzrqxwmtr.supabase.co';\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseKey) {\r\n  console.error('Error: SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY environment variable required');\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function applyFix() {\r\n  console.log('üîß Applying starter vehicle fix...');\r\n\r\n  // 1. Seed vehicles_catalog with starter vehicle\r\n  console.log('üì¶ Seeding vehicles_catalog...');\r\n  \r\n  const vehicles = [\r\n    { name: 'Troll Compact S1', slug: 'troll_compact_s1', tier: 'Starter', style: 'Compact modern starter sedan', price: 5000, speed: 40, armor: 20, color_from: '#38bdf8', color_to: '#22c55e', image_url: '/assets/cars/troll_compact_s1.png', model_url: '/models/vehicles/troll_compact_s1.glb', category: 'Car' },\r\n    { name: 'Midline XR', slug: 'midline_xr', tier: 'Mid', style: 'Mid-size SUV / crossover', price: 12000, speed: 60, armor: 35, color_from: '#fbbf24', color_to: '#f87171', image_url: '/assets/cars/midline_xr.png', model_url: '/models/vehicles/midline_xr.glb', category: 'Car' },\r\n    { name: 'Urban Drift R', slug: 'urban_drift_r', tier: 'Mid', style: 'Aggressive street tuner coupe', price: 18000, speed: 75, armor: 30, color_from: '#a855f7', color_to: '#ec4899', image_url: '/assets/cars/urban_drift_r.png', model_url: '/models/vehicles/urban_drift_r.glb', category: 'Car' },\r\n  ];\r\n\r\n  for (const v of vehicles) {\r\n    const { error } = await supabase\r\n      .from('vehicles_catalog')\r\n      .upsert(v, { onConflict: 'name', ignoreDuplicates: true });\r\n    \r\n    if (error) {\r\n      console.error(`  Error inserting ${v.name}:`, error.message);\r\n    } else {\r\n      console.log(`  ‚úÖ Inserted/verified: ${v.name}`);\r\n    }\r\n  }\r\n\r\n  // 2. Check if grant_starter_vehicle function exists\r\n  console.log('\\nüîç Checking grant_starter_vehicle function...');\r\n  const { data: funcExists, error: funcError } = await supabase\r\n    .rpc('grant_starter_vehicle', { p_user_id: '00000000-0000-0000-0000-000000000000' })\r\n    .then(() => ({ data: true, error: null }))\r\n    .catch(e => ({ data: false, error: e }));\r\n\r\n  if (funcError && funcError.message.includes('function')) {\r\n    console.log('  ‚ö†Ô∏è  Function does not exist, needs manual SQL execution');\r\n    console.log('  Please run the migration: supabase/migrations/20270211000003_ensure_starter_vehicle_data.sql');\r\n  } else {\r\n    console.log('  ‚úÖ Function exists');\r\n  }\r\n\r\n  // 3. Check if trigger exists\r\n  console.log('\\nüîç Checking trigger...');\r\n  const { data: triggers, error: triggerError } = await supabase\r\n    .from('information_schema.triggers')\r\n    .select('trigger_name')\r\n    .eq('trigger_name', 'on_auth_user_created_credit');\r\n\r\n  if (triggerError || !triggers?.length) {\r\n    console.log('  ‚ö†Ô∏è  Trigger may not exist, needs manual SQL execution');\r\n  } else {\r\n    console.log('  ‚úÖ Trigger exists');\r\n  }\r\n\r\n  // 4. List current vehicles in catalog\r\n  console.log('\\nüìã Current vehicles in catalog:');\r\n  const { data: catalog } = await supabase.from('vehicles_catalog').select('name, tier, price');\r\n  if (catalog) {\r\n    catalog.forEach(v => {\r\n      console.log(`  - ${v.name} (${v.tier}) - ${v.price.toLocaleString()} coins`);\r\n    });\r\n  }\r\n\r\n  console.log('\\n‚ú® Fix application complete!');\r\n  console.log('\\nNote: If the grant_starter_vehicle function was missing, please run:');\r\n  console.log('  supabase db push or supabase migration up');\r\n}\r\n\r\napplyFix().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\apply_voucher_migration.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check-admin-profile.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check-users.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_constraint.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_court_schema.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_db_state.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_db_status_v2.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_id_deep.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_schema.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_specific_user_v2.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_tiers.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_tiers_pg.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\check_user_v3.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\comprehensive_testing_script.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\create-support-tickets-table.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\create_and_seed_tables.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\debug_court_status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\debug_script_placeholder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\debug_secretary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\extract_funcs.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-admin.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-admin.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-courtroom.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-courtroom.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-existing-users-terms.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-orphaned-user.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-profiles.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-support-tickets.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix-user-issues.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix_profile_ts.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\fix_profile_v2.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\generate_fix_migration.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\grant-200-coins.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\lib\\supabaseAdmin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\public\\push-sw.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\public\\sw.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\remove-troll-officer-role.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\reproduce_profile_error.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\reset-admin-paid-coins.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run-migration.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_all_fixes_migration.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_all_pending.cjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":27,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { createClient } = require('@supabase/supabase-js');\nconst fs = require('fs');\nconst path = require('path');\nconst dotenv = require('dotenv');\n\n// Load environment variables\nconst envPath = path.resolve(__dirname, '.env');\nif (fs.existsSync(envPath)) {\n  dotenv.config({ path: envPath });\n}\n\nconst supabaseUrl = process.env.VITE_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error('Error: Missing VITE_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in .env');\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function runMigration(filePath) {\n  try {\n    const sql = fs.readFileSync(filePath, 'utf8');\n    console.log(`Applying migration: ${path.basename(filePath)}`);\n    \n    const { data, error } = await supabase.rpc('exec_sql', { sql_query: sql });\n\n    if (error) {\n      console.error(`Migration ${path.basename(filePath)} failed:`, error);\n      return false;\n    } else {\n      console.log(`Migration ${path.basename(filePath)} applied successfully!`);\n      return true;\n    }\n  } catch (err) {\n    console.error('Error reading migration file:', err);\n    return false;\n  }\n}\n\nasync function runAll() {\n  const migrations = [\n    'supabase/migrations/20270210000002_housing_rpcs.sql',\n    'supabase/migrations/20270210000003_fix_bank_loans.sql',\n    'supabase/migrations/20270210000004_admin_week_logic.sql'\n  ];\n\n  for (const file of migrations) {\n    const fullPath = path.join(__dirname, file);\n    if (fs.existsSync(fullPath)) {\n        await runMigration(fullPath);\n    } else {\n        console.warn(`File not found: ${fullPath}`);\n    }\n  }\n}\n\nrunAll();\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_fix0_admin_week.cjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabaseKey' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":13,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":35,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { createClient } = require('@supabase/supabase-js');\nconst fs = require('fs');\nconst path = require('path');\nconst dotenv = require('dotenv');\n\n// Load environment variables\nconst envPath = path.resolve(__dirname, '.env');\nif (fs.existsSync(envPath)) {\n  dotenv.config({ path: envPath });\n}\n\nconst supabaseUrl = process.env.VITE_SUPABASE_URL;\nconst supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY; // Prefer service role for migrations\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error('Error: Missing VITE_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in .env');\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function runMigration() {\n  const migrationPath = path.join(__dirname, 'supabase', 'migrations', '20270210000004_admin_week_logic.sql');\n  \n  try {\n    const sql = fs.readFileSync(migrationPath, 'utf8');\n    console.log(`Applying migration: ${path.basename(migrationPath)}`);\n    \n    // We use the exec_sql RPC if available, or just raw query if possible with service role?\n    // The previous turn used exec_sql. Let's assume it exists.\n    // If not, we might need to use the SQL editor or a direct connection.\n    // However, since we are using the JS client, we rely on the RPC 'exec_sql' created in the setup.\n    \n    const { data, error } = await supabase.rpc('exec_sql', { sql_query: sql });\n\n    if (error) {\n      console.error('Migration failed:', error);\n    } else {\n      console.log('Migration applied successfully!');\n    }\n  } catch (err) {\n    console.error('Error reading migration file:', err);\n  }\n}\n\nrunMigration();\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_fix0_broadcast.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_fix2_housing.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_fix3_loans.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_fix_migration.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_latest_migration.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\run_pending_migrations.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\admin_cleanup_orphans.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pErr' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":51,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport dotenv from 'dotenv'\nimport { createClient } from '@supabase/supabase-js'\n\ndotenv.config()\n\nconst SUPABASE_URL = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL\nconst SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nif (!SUPABASE_URL || !SERVICE_KEY) {\n  console.error('Missing env vars')\n  process.exit(1)\n}\n\nconst supabase = createClient(SUPABASE_URL, SERVICE_KEY, {\n    auth: {\n        autoRefreshToken: false,\n        persistSession: false\n    }\n})\n\nasync function cleanupOrphans() {\n  console.log('Starting orphan cleanup...')\n  let page = 1;\n  const perPage = 50;\n  let deletedCount = 0;\n  let errorCount = 0;\n  let checkedCount = 0;\n\n  try {\n    while (true) {\n        const { data: { users }, error } = await supabase.auth.admin.listUsers({\n            page: page,\n            perPage: perPage\n        });\n\n        if (error) {\n            console.error('Error fetching users:', error);\n            break;\n        }\n\n        if (!users || users.length === 0) {\n            break;\n        }\n\n        console.log(`Checking batch ${page} (${users.length} users)...`);\n\n        for (const user of users) {\n            checkedCount++;\n            // Check if profile exists\n            const { data: profile, error: pErr } = await supabase\n                .from('user_profiles')\n                .select('id')\n                .eq('id', user.id)\n                .single();\n\n            if (!profile) {\n                console.log(`üóëÔ∏è Orphan found: ${user.email} (${user.id}). Deleting...`);\n                const { error: dErr } = await supabase.auth.admin.deleteUser(user.id);\n                if (dErr) {\n                    console.error(`‚ùå Failed to delete ${user.id}:`, dErr.message);\n                    errorCount++;\n                } else {\n                    console.log(`‚úÖ Deleted.`);\n                    deletedCount++;\n                }\n            }\n        }\n\n        if (users.length < perPage) {\n            break;\n        }\n        page++;\n    }\n\n    console.log('--- Cleanup Complete ---');\n    console.log(`Total Checked: ${checkedCount}`);\n    console.log(`Deleted Orphans: ${deletedCount}`);\n    console.log(`Errors: ${errorCount}`);\n\n  } catch (e) {\n    console.error('Unexpected error:', e)\n  }\n}\n\ncleanupOrphans()\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply-welcome-bonus.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_call_minutes_fix.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_fix_migration.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_fix_migrations.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_fix_remote.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_fix_via_rpc.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":27,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'dotenv/config'\nimport fs from 'fs'\nimport { createClient } from '@supabase/supabase-js'\n\nconst sqlPath = './fix_admin_broadcasts_permissions.sql'\n\nasync function run() {\n  const supabaseUrl = process.env.VITE_SUPABASE_URL\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!supabaseUrl || !supabaseServiceKey) {\n    console.error('‚ùå Missing Supabase env vars')\n    process.exit(1)\n  }\n\n  console.log('Connecting to Supabase...')\n  const supabase = createClient(supabaseUrl, supabaseServiceKey)\n\n  const sql = fs.readFileSync(sqlPath, 'utf-8')\n  \n  // Try to execute via rpc if a generic sql execution function exists\n  // If not, we might need to rely on the user to run it via SQL editor\n  // OR we can try to use the REST API if we had a function for it\n  \n  console.log('Attempting to execute SQL via RPC \"exec_sql\" or similar if available...')\n  \n  const { data, error } = await supabase.rpc('exec_sql', { sql_query: sql })\n  \n  if (error) {\n    console.log('RPC exec_sql failed (likely does not exist).')\n    console.log('Error:', error.message)\n    console.log('\\n‚ö†Ô∏è  Please run the contents of \"fix_admin_broadcasts_permissions.sql\" manually in the Supabase SQL Editor.')\n  } else {\n    console.log('‚úÖ SQL executed successfully via RPC!')\n  }\n}\n\nrun()\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_migration_pg.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_migration_rpc.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_temp_migration.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_update_summon_rpc.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\apply_vehicle_fix.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\check_and_fix.mjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profileError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":70,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { createClient } from '@supabase/supabase-js'\nimport dotenv from 'dotenv'\nimport path from 'path'\n\ndotenv.config({ path: path.resolve(process.cwd(), '.env') })\n\nconst supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nif (!supabaseUrl || !supabaseKey) {\n  console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY')\n  process.exit(1)\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false\n  }\n})\n\nasync function main() {\n  console.log('--- Starting Check and Fix ---')\n\n  // 1. Check Schema via RPC (if exec_sql exists)\n  console.log('\\n1. Checking Schema...')\n  const { data: schemaData, error: schemaError } = await supabase.rpc('exec_sql', {\n    sql: `\n      SELECT table_name, column_name, data_type \n      FROM information_schema.columns \n      WHERE table_name IN ('user_cars', 'vehicles_catalog', 'user_vouchers') \n      AND column_name IN ('car_id', 'vehicle_id', 'id', 'slug', 'item_id');\n    `\n  })\n\n  if (schemaError) {\n    console.log('RPC exec_sql failed, trying direct inspection via Postgrest if possible (unlikely for schema)...')\n    console.error('RPC Error:', schemaError.message)\n  } else {\n    console.log('Schema Info:', JSON.stringify(schemaData, null, 2))\n  }\n\n  // Check function definition\n  const { data: funcData, error: funcError } = await supabase.rpc('exec_sql', {\n    sql: `select prosrc from pg_proc where proname = 'handle_new_user_credit';`\n  })\n  \n  if (!funcError) {\n      console.log('handle_new_user_credit source:', JSON.stringify(funcData, null, 2))\n  }\n\n  // 2. Check for Orphaned Users\n  console.log('\\n2. Checking for Orphaned Users...')\n  \n  // List all users (pagination might be needed for large DBs, but start simple)\n  const { data: { users }, error: listError } = await supabase.auth.admin.listUsers({ perPage: 1000 })\n  \n  if (listError) {\n    console.error('Error listing users:', listError)\n    return\n  }\n\n  console.log(`Found ${users.length} users in auth.users`)\n\n  let orphansFound = 0\n  \n  for (const user of users) {\n    // Check if profile exists\n    const { data: profile, error: profileError } = await supabase\n      .from('user_profiles')\n      .select('id')\n      .eq('id', user.id)\n      .single()\n\n    if (!profile) {\n      console.log(`\\n[ORPHAN DETECTED] User: ${user.email} (ID: ${user.id})`)\n      console.log('  -> No profile found in user_profiles.')\n      orphansFound++\n\n      // Delete the orphan\n      console.log(`  -> Deleting orphaned user...`)\n      const { error: deleteError } = await supabase.auth.admin.deleteUser(user.id)\n      \n      if (deleteError) {\n        console.error(`  -> Failed to delete: ${deleteError.message}`)\n      } else {\n        console.log(`  -> Successfully deleted.`)\n      }\n    }\n  }\n\n  if (orphansFound === 0) {\n    console.log('\\nNo orphaned users found.')\n  } else {\n    console.log(`\\nCleaned up ${orphansFound} orphaned users.`)\n  }\n\n  console.log('\\n--- Done ---')\n}\n\nmain()\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\check_db_state.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\check_golive.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\check_sounds.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\debug_item_id_types.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\debug_signup_error.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\e2e-cancel-cashout.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\end_all_streams.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\fix-spend-coins.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\generate_assets.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\get-test-token.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\headless-check.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\inspect_theme_rpc.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\run_migrations.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\sendGlobalNotification.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\test_log.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\scripts\\verify_critical_paths.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\seed_data.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\seed_data_simple.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\seed_data_simple.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\server\\api\\livekit-token.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\server\\api\\telemetry.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\server\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\server\\voice-server.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\set-level-32.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\set-my-level-32.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\setup-coins-and-badges.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\setup-fake-interview.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\App.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AuctionsPage' is defined but never used. Allowed unused vars must match /^_/u.","line":47,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":20,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AuctionsPage"},"fix":{"range":[2308,2356],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/App.tsx\r\nimport React, { useEffect, Suspense, useState, useRef, lazy } from \"react\";\r\nimport { Routes, Route, Navigate, Outlet, useLocation, useNavigate } from \"react-router-dom\";\r\nimport { useAuthStore } from \"./lib/store\";\r\n\r\nimport { useEligibilityStore } from \"./lib/eligibilityStore\";\r\nimport { supabase, UserRole, reportError } from \"./lib/supabase\";\r\nimport { Toaster, toast } from \"sonner\";\r\nimport GlobalLoadingOverlay from \"./components/GlobalLoadingOverlay\";\r\nimport GlobalErrorBanner from \"./components/GlobalErrorBanner\";\r\nimport GlobalGiftBanner from \"./components/GlobalGiftBanner\";\r\nimport GlobalPayoutBanner from \"./components/GlobalPayoutBanner\";\r\nimport BroadcastAnnouncement from \"./components/BroadcastAnnouncement\";\r\nimport GlobalPodBanner from \"./components/GlobalPodBanner\";\r\nimport DailyChurchNotification from \"./components/church/DailyChurchNotification\";\r\nimport GlobalEventsBanner from \"./components/GlobalEventsBanner\";\r\nimport { useGlobalApp } from \"./contexts/GlobalAppContext\";\r\nimport { updateRoute } from \"./utils/sessionStorage\";\r\nimport { useDebouncedProfileUpdate } from \"./hooks/useDebouncedProfileUpdate\";\r\nimport { APP_DATA_REFETCH_EVENT_NAME } from \"./lib/appEvents\";\r\nimport { autoUnlockPayouts } from \"./lib/supabase\";\r\nimport { initTelemetry } from \"./lib/telemetry\";\r\n\r\n// Layout\r\nimport OfficerAlertBanner from \"./components/OfficerAlertBanner\";\r\nimport AdminOfficerQuickMenu from \"./components/AdminOfficerQuickMenu\";\r\nimport TrollsTownControl from \"./components/TrollsTownControl\";\r\n\r\nimport AdminErrors from \"./pages/admin/AdminErrors\";\r\nimport ProfileSetupModal from \"./components/ProfileSetupModal\";\r\nimport RequireRole from \"./components/RequireRole\";\r\nimport { RequireLeadOrOwner } from \"./components/auth/RequireLeadOrOwner\";\r\nimport ErrorBoundary from \"./components/ErrorBoundary\";\r\n\r\nimport AppLayout from \"./components/layout/AppLayout\";\r\n\r\n// Static pages (fast load)\r\nimport LandingHome from \"./pages/Home\";\r\nimport Auth from \"./pages/Auth\";\r\nimport AuthCallback from \"./pages/AuthCallback\";\r\nimport SessionMonitor from \"./components/auth/SessionMonitor\";\r\nimport TermsAgreement from \"./pages/TermsAgreement\";\r\nimport ExitPage from \"./pages/ExitPage\";\r\n\r\nimport TrollBank from \"./pages/TrollBank\";\r\nimport CityHall from \"./pages/CityHall\";\r\nimport AuctionsPage from \"./pages/AuctionsPage\";\r\nconst LivingPage = lazy(() => import(\"./pages/LivingPage\"));\r\nconst ChurchPage = lazy(() => import(\"./pages/ChurchPage\"));\r\nconst PastorDashboard = lazy(() => import(\"./pages/church/PastorDashboard\"));\r\nconst XPSimulatorPage = lazy(() => import(\"./pages/dev/XPSimulatorPage\"));\r\nconst BadgePopup = lazy(() => import(\"./components/BadgePopup\"));\r\n\r\n\r\n\r\n// Sidebar pages (instant load)\r\nconst TCPS = lazy(() => import(\"./pages/TCPS\"));\r\nconst TrollPodsListing = lazy(() => import(\"./pages/pods/TrollPodsListing\"));\r\nconst TrollPodRoom = lazy(() => import(\"./pages/pods/TrollPodRoom\"));\r\n\r\n// Lazy-loaded pages\r\nconst Following = lazy(() => import(\"./pages/Following\"));\r\nconst ExploreFeed = lazy(() => import(\"./pages/ExploreFeed\"));\r\nconst CoinStore = lazy(() => import(\"./pages/CoinStore\"));\r\nconst Marketplace = lazy(() => import(\"./pages/Marketplace\"));\r\nconst PublicPool = lazy(() => import(\"./pages/PublicPool\"));\r\nconst UserInventory = lazy(() => import(\"./pages/UserInventory\"));\r\nconst Troting = lazy(() => import(\"./pages/Troting\"));\r\nconst ProfileSettings = lazy(() => import(\"./pages/ProfileSettings\"));\r\nconst SellOnTrollCity = lazy(() => import(\"./pages/SellOnTrollCity\"));\r\nconst Leaderboard = lazy(() => import(\"./pages/Leaderboard\"));\r\nconst TrollCityWall = lazy(() => import(\"./pages/TrollCityWall\"));\r\nconst WallPostPage = lazy(() => import(\"./pages/WallPostPage\"));\r\nconst TrollCourt = lazy(() => import(\"./pages/TrollCourt\"));\r\nconst EmpirePartnerDashboard = lazy(() => import(\"./pages/EmpirePartnerDashboard\"));\r\n// Gift store pages removed\r\nconst Application = lazy(() => import(\"./pages/Application\"));\r\nconst ApplicationPage = lazy(() => import(\"./pages/ApplicationPage\"));\r\nconst TrollsTownPage = lazy(() => import(\"./pages/TrollsTownPage\"));\r\nconst DistrictTour = lazy(() => import(\"./pages/DistrictTour\"));\r\nconst TrollOfficerLounge = lazy(() => import(\"./pages/TrollOfficerLounge\"));\r\nconst OfficerModeration = lazy(() => import(\"./pages/OfficerModeration\"));\r\nconst TrollFamily = lazy(() => import(\"./pages/TrollFamily\"));\r\nconst FamilyLounge = lazy(() => import(\"./pages/FamilyLounge.jsx\"));\r\nconst FamilyWarsHub = lazy(() => import(\"./pages/FamilyWarsHub.jsx\"));\r\nconst FamilyLeaderboard = lazy(() => import(\"./pages/FamilyLeaderboard.jsx\"));\r\nconst FamilyShop = lazy(() => import(\"./pages/FamilyShop.jsx\"));\r\nconst FamilyBrowse = lazy(() => import(\"./pages/FamilyBrowse\"));\r\nconst Support = lazy(() => import(\"./pages/Support\"));\r\nconst Safety = lazy(() => import(\"./pages/Safety\"));\r\nconst AdminRFC = lazy(() => import(\"./components/AdminRFC\"));\r\nconst AdminEarningsDashboard = lazy(() => import(\"./pages/admin/AdminEarningsDashboard\"));\r\nconst AdminDashboard = lazy(() => import(\"./pages/admin/AdminDashboard\"));\r\nconst ApplicationsPage = lazy(() => import(\"./pages/admin/Applications\"));\r\nconst AdminMarketplace = lazy(() => import(\"./pages/admin/AdminMarketplace\"));\r\nconst AdminOfficerReports = lazy(() => import(\"./pages/admin/AdminOfficerReports\"));\r\nconst MaiTalentPage = lazy(() => import(\"./pages/MaiTalentPage\"));\r\nconst StoreDebug = lazy(() => import(\"./pages/admin/StoreDebug\"));\r\nconst Changelog = lazy(() => import(\"./pages/Changelog\"));\r\nconst AccessDenied = lazy(() => import(\"./pages/AccessDenied\"));\r\nconst ReferralBonusPanel = lazy(() => import(\"./pages/admin/ReferralBonusPanel\"));\r\nconst SecretaryConsole = lazy(() => import(\"./pages/secretary/SecretaryConsole\"));\r\nimport { systemManagementRoutes } from \"./pages/admin/adminRoutes\";\r\n\r\nconst TermsOfService = lazy(() => import(\"./pages/TermsOfService\"));\r\nconst RefundPolicy = lazy(() => import(\"./pages/RefundPolicy\"));\r\nconst LandingPage = lazy(() => import(\"./pages/LandingPage\"));\r\nconst PrivacyPolicy = lazy(() => import(\"./pages/PrivacyPolicy\"));\r\nconst PaymentTerms = lazy(() => import(\"./pages/PaymentTerms\"));\r\nconst CreatorAgreement = lazy(() => import(\"./pages/CreatorAgreement\"));\r\nconst TaxOnboarding = lazy(() => import(\"./pages/TaxOnboarding\"));\r\nconst MyEarnings = lazy(() => import(\"./pages/MyEarnings\"));\r\nconst EarningsPage = lazy(() => import(\"./pages/EarningsPage\"));\r\nconst VerificationPage = lazy(() => import(\"./pages/VerificationPage\"));\r\nconst VerificationComplete = lazy(() => import(\"./pages/VerificationComplete\"));\r\nconst PayoutStatus = lazy(() => import(\"./pages/PayoutStatus\"));\r\nconst FoundingOfficerTrial = lazy(() => import(\"./pages/FoundingOfficerTrial\"));\r\nconst AdminLaunchTrial = lazy(() => import(\"./pages/admin/LaunchTrial\"));\r\n\r\nconst GoLive = lazy(() => import(\"./pages/GoLive\"));\r\nconst JoinPage = lazy(() => import(\"./pages/Join\"));\r\nconst LazyLivePage = lazy(() => import(\"./pages/LivePage\"));\r\nconst BroadcastSummary = lazy(() => import(\"./pages/BroadcastSummary\"));\r\nconst KickFee = lazy(() => import(\"./pages/KickFee\"));\r\nconst BanFee = lazy(() => import(\"./pages/BanFee\"));\r\nconst MobileShell = lazy(() => import(\"./pages/MobileShell\"));\r\nconst TrollCourtSession = lazy(() => import(\"./pages/TrollCourtSession\"));\r\nconst TromodyShow = lazy(() => import(\"./pages/TromodyShow\"));\r\nconst TromodyShowBroadcast = lazy(() => import(\"./pages/TromodyShowBroadcast\"));\r\nconst OfficerLoungeStream = lazy(() => import(\"./pages/OfficerLoungeStream\"));\r\nconst StreamPicture = lazy(() => import(\"./pages/StreamPicture\"));\r\nconst Call = lazy(() => import(\"./pages/Call\"));\r\nconst Notifications = lazy(() => import(\"./pages/Notifications\"));\r\nconst Trollifications = lazy(() => import(\"./pages/Trollifications\"));\r\nconst OfficerScheduling = lazy(() => import(\"./pages/OfficerScheduling\"));\r\nconst OfficerPayrollDashboard = lazy(() => import(\"./pages/officer/OfficerPayrollDashboard\"));\r\nconst OfficerDashboard = lazy(() => import(\"./pages/officer/OfficerDashboard\"));\r\nconst OfficerOWCDashboard = lazy(() => import(\"./pages/OfficerOWCDashboard\"));\r\nconst OfficerVote = lazy(() => import(\"./pages/OfficerVote\"));\r\nconst GovernmentStreams = lazy(() => import(\"./pages/government/GovernmentStreams\"));\r\nconst ReportDetailsPage = lazy(() => import(\"./pages/ReportDetailsPage\"));\r\nconst TrollFamilyCity = lazy(() => import(\"./pages/TrollFamilyCity\"));\r\nconst FamilyProfilePage = lazy(() => import(\"./pages/FamilyProfilePage\"));\r\nconst FamilyWarsPage = lazy(() => import(\"./pages/FamilyWarsPage\"));\r\nconst FamilyChatPage = lazy(() => import(\"./pages/FamilyChatPage\"));\r\nconst TransactionHistory = lazy(() => import(\"./pages/TransactionHistory\"));\r\nconst CashoutPage = lazy(() => import(\"./pages/CashoutPage\"));\r\nconst FamilyApplication = lazy(() => import(\"./pages/FamilyApplication\"));\r\nconst OfficerApplication = lazy(() => import(\"./pages/OfficerApplication\"));\r\nconst TrollerApplication = lazy(() => import(\"./pages/TrollerApplication\"));\r\nconst Career = lazy(() => import(\"./pages/Career\"));\r\nconst LeadOfficerApplication = lazy(() => import(\"./pages/LeadOfficerApplication\"));\r\nconst PastorApplication = lazy(() => import(\"./pages/PastorApplication\"));\r\nconst ShopEarnings = lazy(() => import(\"./pages/ShopEarnings\"));\r\nconst AdminPayoutMobile = lazy(() => import(\"./pages/admin/AdminPayoutMobile\"));\r\nconst MobileAdminDashboard = lazy(() => import(\"./pages/admin/MobileAdminDashboard\"));\r\nconst PaymentsDashboard = lazy(() => import(\"./pages/admin/PaymentsDashboard\"));\r\nconst EconomyDashboard = lazy(() => import(\"./pages/admin/EconomyDashboard\"));\r\nconst TaxUpload = lazy(() => import(\"./pages/TaxUpload\"));\r\nconst TaxReviewPanel = lazy(() => import(\"./pages/admin/TaxReviewPanel\"));\r\nconst PaymentCallback = lazy(() => import(\"./pages/PaymentCallback\"));\r\nconst CoinsComplete = lazy(() => import(\"./pages/CoinsComplete\"));\r\nconst PayoutSetupPage = lazy(() => import(\"./pages/PayoutSetupPage\"));\r\nconst Withdraw = lazy(() => import(\"./pages/Withdraw\"));\r\nconst Profile = lazy(() => import(\"./pages/Profile\"));\r\nconst ProfileSetup = lazy(() => import(\"./pages/ProfileSetup\"));\r\nconst BadgesPage = lazy(() => import(\"./pages/BadgesPage\"));\r\nconst Stats = lazy(() => import(\"./pages/Stats\"));\r\nconst EmpirePartnerApply = lazy(() => import(\"./pages/EmpirePartnerApply\"));\r\nconst EarningsDashboard = lazy(() => import(\"./pages/EarningsDashboard\"));\r\nconst CreatorOnboarding = lazy(() => import(\"./pages/CreatorOnboarding\"));\r\nconst CreatorSwitchProgram = lazy(() => import(\"./pages/CreatorSwitchProgram\"));\r\nconst PolicyCenter = lazy(() => import(\"./pages/PolicyCenter\"));\r\nconst TermsOfServiceLegal = lazy(() => import(\"./pages/legal/TermsOfService\"));\r\nconst RefundPolicyLegal = lazy(() => import(\"./pages/legal/RefundPolicy\"));\r\nconst PayoutPolicyLegal = lazy(() => import(\"./pages/legal/PayoutPolicy\"));\r\nconst SafetyGuidelinesLegal = lazy(() => import(\"./pages/legal/SafetyGuidelines\"));\r\nconst CreatorEarnings = lazy(() => import(\"./pages/legal/CreatorEarnings\"));\r\nconst GamblingDisclosure = lazy(() => import(\"./pages/legal/GamblingDisclosure\"));\r\nconst PartnerProgram = lazy(() => import(\"./pages/legal/PartnerProgram\"));\r\nconst Wallet = lazy(() => import(\"./pages/Wallet\"));\r\nconst PayoutRequest = lazy(() => import(\"./pages/PayoutRequest\"));\r\nconst AdminPayoutDashboard = lazy(() => import(\"./pages/admin/components/AdminPayoutDashboard\"));\r\nconst AdminLiveOfficersTracker = lazy(() => import(\"./pages/admin/AdminLiveOfficersTracker\"));\r\nconst AdminVerifiedUsers = lazy(() => import(\"./pages/admin/AdminVerifiedUsers\"));\r\nconst AdminVerificationReview = lazy(() => import(\"./pages/admin/AdminVerificationReview\"));\r\nconst AdminPoliciesDocs = lazy(() => import(\"./pages/admin/AdminPoliciesDocs\"));\r\nconst ExecutiveSecretaries = lazy(() => import(\"./pages/admin/ExecutiveSecretaries\"));\r\nconst GiftCardsManager = lazy(() => import(\"./pages/admin/GiftCardsManager\"));\r\nconst ExecutiveIntake = lazy(() => import(\"./pages/admin/ExecutiveIntake\"));\r\nconst ExecutiveReports = lazy(() => import(\"./pages/admin/ExecutiveReports\"));\r\nconst AdminManualOrders = lazy(() => import(\"./pages/admin/components/AdminManualOrders\"));\r\nconst CashoutManager = lazy(() => import(\"./pages/admin/CashoutManager\"));\r\nconst CriticalAlertsManager = lazy(() => import(\"./pages/admin/CriticalAlertsManager\"));\r\nconst OfficerManager = lazy(() => import(\"./pages/admin/OfficerManager\"));\r\nconst AdminTrollTownDeeds = lazy(() => import(\"./pages/admin/AdminTrollTownDeeds\"));\r\nconst LeadOfficerReview = lazy(() => import(\"./pages/lead-officer/Review\"));\r\nconst LeadOfficerDashboard = lazy(() => import(\"./pages/lead-officer/LeadOfficerDashboard\").then(module => ({ default: module.LeadOfficerDashboard })));\r\nconst ShopPartnerPage = lazy(() => import(\"./pages/ShopPartnerPage\"));\r\nconst CommandBattleGoLive = lazy(() => import(\"./pages/CommandBattleGoLive\"));\r\nconst TrollBattleSetup = lazy(() => import(\"./pages/TrollBattleSetup\"));\r\nconst ShopView = lazy(() => import(\"./pages/ShopView\"));\r\nconst CourtRoom = lazy(() => import(\"./pages/CourtRoom\"));\r\nconst InterviewRoom = lazy(() => import(\"./pages/InterviewRoom\"));\r\nconst InterviewRoomPage = lazy(() => import(\"./pages/InterviewRoomPage\"));\r\nconst AdminInterviewDashboard = lazy(() => import(\"./pages/AdminInterviewDashboard\"));\r\nconst PasswordReset = lazy(() => import(\"./pages/PasswordReset\"));\r\nconst CreditScorePage = lazy(() => import(\"./pages/CreditScorePage\"));\r\nconst TMVPage = lazy(() => import(\"./pages/TMVPage\"));\r\n\r\n// Admin pages\r\nconst BanManagement = lazy(() => import(\"./pages/admin/BanManagement\"));\r\nconst RoleManagement = lazy(() => import(\"./pages/admin/RoleManagement\"));\r\nconst MediaLibrary = lazy(() => import(\"./pages/admin/MediaLibrary\"));\r\nconst ChatModeration = lazy(() => import(\"./pages/admin/ChatModeration\"));\r\nconst Announcements = lazy(() => import(\"./pages/admin/Announcements\"));\r\nconst SendNotifications = lazy(() => import(\"./pages/admin/SendNotifications\"));\r\nconst BroadcastLockDashboard = lazy(() => import(\"./pages/admin/components/BroadcastLockDashboard\"));\r\nconst ExportData = lazy(() => import(\"./pages/admin/ExportData\"));\r\nconst UserSearch = lazy(() => import(\"./pages/admin/UserSearch\"));\r\nconst ReportsQueue = lazy(() => import(\"./pages/admin/ReportsQueue\"));\r\nconst StreamMonitorPage = lazy(() => import(\"./pages/admin/StreamMonitorPage\"));\r\nconst TrotingAdminPage = lazy(() => import(\"./pages/admin/TrotingAdminPage\"));\r\nconst PaymentLogs = lazy(() => import(\"./pages/admin/PaymentLogs\"));\r\nconst StorePriceEditor = lazy(() => import(\"./pages/admin/components/StorePriceEditor\"));\r\nconst AdminFinanceDashboard = lazy(() => import(\"./pages/admin/AdminFinanceDashboard\"));\r\nconst CreateSchedule = lazy(() => import(\"./pages/admin/CreateSchedule\"));\r\nconst OfficerShifts = lazy(() => import(\"./pages/admin/OfficerShifts\"));\r\nconst EmpireApplicationsPage = lazy(() => import(\"./pages/admin/EmpireApplicationsPage\"));\r\nconst ReferralBonuses = lazy(() => import(\"./pages/admin/ReferralBonuses\"));\r\nconst ControlPanel = lazy(() => import(\"./pages/admin/ControlPanel\"));\r\nconst TestDiagnosticsPage = lazy(() => import(\"./pages/admin/TestDiagnosticsPage\"));\r\nconst ResetMaintenance = lazy(() => import(\"./pages/admin/ResetMaintenance\"));\r\nconst AdminHR = lazy(() => import(\"./pages/admin/AdminHR\"));\r\nconst UserFormsTab = lazy(() => import(\"./pages/admin/components/UserFormsTab\"));\r\nconst BucketsDashboard = lazy(() => import(\"./pages/admin/BucketsDashboard\"));\r\nconst GrantCoins = lazy(() => import(\"./pages/admin/GrantCoins\"));\r\nconst OfficerOperations = lazy(() => import(\"./pages/admin/OfficerOperations\"));\r\nconst CreatorSwitchApprovals = lazy(() => import(\"./pages/admin/components/CreatorSwitchApprovals\"));\r\n\r\nconst LoadingScreen = () => (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-[#0A0814] text-white\">\r\n      <div className=\"animate-pulse px-6 py-3 rounded bg-[#121212] border border-[#2C2C2C]\">\r\n        Loading‚Ä¶\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  // üîê Route Guard\r\n  const RequireAuth = () => {\r\n    const user = useAuthStore((s) => s.user);\r\n    const profile = useAuthStore((s) => s.profile);\r\n    const isLoading = useAuthStore((s) => s.isLoading);\r\n    const location = useLocation();\r\n\r\n    if (isLoading) return <LoadingScreen />;\r\n    if (!user) return <Navigate to=\"/auth\" replace />;\r\n    \r\n    if (\r\n      profile &&\r\n      !profile.username &&\r\n      location.pathname !== \"/profile/setup\" &&\r\n      location.pathname !== \"/auth\" &&\r\n      location.pathname !== \"/callback\"\r\n    ) {\r\n      return <Navigate to=\"/profile/setup\" replace />;\r\n    }\r\n    \r\n    if (\r\n      profile &&\r\n      profile.role !== \"admin\" &&\r\n      (!profile.terms_accepted || !profile.court_recording_consent) &&\r\n      location.pathname !== \"/terms\"\r\n    ) {\r\n      return <Navigate to=\"/terms\" replace />;\r\n    }\r\n    if (\r\n      profile && // Add this check\r\n      profile?.application_required &&\r\n      !profile?.application_submitted &&\r\n      location.pathname !== \"/application\"\r\n    ) {\r\n      return <Navigate to=\"/application\" replace />;\r\n    }\r\n    return <Outlet />;\r\n  };\r\n\r\nimport ChatBubble from \"./components/ChatBubble\";\r\nimport AdminPoolTab from './pages/admin/components/AdminPoolTab'\r\n\r\nfunction AppContent() {\r\n  // Lightweight render counter (dev only)\r\n  if (process.env.NODE_ENV === 'development' && typeof window !== 'undefined') {\r\n    const w = window as any;\r\n    w.__tc_app_renders = (w.__tc_app_renders || 0) + 1;\r\n    if (w.__tc_app_renders % 50 === 0) {\r\n      console.debug('[App] render count', w.__tc_app_renders);\r\n    }\r\n  }\r\n\r\n  // Narrow selectors to avoid returning a fresh object from the selector\r\n  const user = useAuthStore((s) => s.user);\r\n\r\n  // Some legacy logic needs the full profile object in several effects\r\n  const profile = useAuthStore((s) => s.profile);\r\n\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const mainRef = useRef<HTMLElement | null>(null);\r\n  const [profileModalOpen, setProfileModalOpen] = useState(false);\r\n  const [profileModalLoading] = useState(false);\r\n  const [isStandalone, setIsStandalone] = useState(false);\r\n  const [updateAvailable, setUpdateAvailable] = useState(false);\r\n  const [waitingServiceWorker, setWaitingServiceWorker] = useState<ServiceWorker | null>(null);\r\n  const [trollsTownControlOpen, setTrollsTownControlOpen] = useState(false);\r\n\r\n  const refreshProfile = useAuthStore((s) => s.refreshProfile);\r\n  const eligibilityRefresh = useEligibilityStore((s) => s.refresh);\r\n\r\n  // Global app context for loading and error states\r\n  const {\r\n    isLoading: globalLoading,\r\n    loadingMessage,\r\n    error,\r\n    retryLastAction,\r\n    isReconnecting,\r\n    reconnectMessage,\r\n  } = useGlobalApp();\r\n\r\n  // Global unhandled rejection handler for AuthApiError\r\n  useEffect(() => {\r\n    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {\r\n      // Check if the error is related to \"Invalid Refresh Token\" or similar auth errors\r\n      const reason = event.reason;\r\n      const message = reason?.message || reason?.error_description || '';\r\n      \r\n      if (\r\n        message.includes('Invalid Refresh Token') ||\r\n        message.includes('Refresh Token Not Found')\r\n      ) {\r\n        console.warn('Caught invalid refresh token error, signing out...');\r\n        event.preventDefault(); // Prevent default console error\r\n        \r\n        // Clear session and redirect to auth\r\n        useAuthStore.getState().logout()\r\n        window.location.href = '/auth';\r\n      }\r\n    };\r\n\r\n    window.addEventListener('unhandledrejection', handleUnhandledRejection);\r\n\r\n    return () => {\r\n      window.removeEventListener('unhandledrejection', handleUnhandledRejection);\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    const standalone =\r\n      (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||\r\n      ((window.navigator as any).standalone === true);\r\n    setIsStandalone(standalone);\r\n  }, []);\r\n\r\n  // Warrant Access Restriction\r\n  useEffect(() => {\r\n    if (profile?.has_active_warrant) {\r\n       // Allow access to court pages, auth pages, and static assets\r\n       const allowedPaths = ['/troll-court', '/court', '/auth', '/legal', '/support'];\r\n       const isAllowed = allowedPaths.some(path => location.pathname.startsWith(path));\r\n       \r\n       if (!isAllowed) {\r\n         toast.error(\"Active Warrant Issued! You must appear in Troll Court.\");\r\n         navigate('/troll-court');\r\n       }\r\n    }\r\n  }, [profile?.has_active_warrant, location.pathname, navigate]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    if (!('serviceWorker' in navigator)) return;\r\n\r\n    const handleUpdateAvailable = async () => {\r\n      try {\r\n        const registration = await navigator.serviceWorker.getRegistration();\r\n        const waiting = registration?.waiting;\r\n        if (waiting) {\r\n          setWaitingServiceWorker(waiting);\r\n          setUpdateAvailable(true);\r\n        }\r\n      } catch {}\r\n    };\r\n\r\n    window.addEventListener('pwa-update-available', handleUpdateAvailable);\r\n\r\n    return () => {\r\n      window.removeEventListener('pwa-update-available', handleUpdateAvailable);\r\n    };\r\n  }, []);\r\n\r\n  // Show update toast when update is available\r\n  useEffect(() => {\r\n    if (!updateAvailable || !waitingServiceWorker) return;\r\n\r\n    if (isStandalone) {\r\n      waitingServiceWorker.postMessage({ type: 'SKIP_WAITING' });\r\n      setTimeout(() => {\r\n        window.location.reload();\r\n      }, 500);\r\n      return;\r\n    }\r\n\r\n    toast.info(\"New update available!\", {\r\n      duration: Infinity,\r\n      description: \"A new version of Troll City is available.\",\r\n      action: {\r\n        label: \"Update Now\",\r\n        onClick: () => {\r\n          waitingServiceWorker.postMessage({ type: 'SKIP_WAITING' });\r\n          setTimeout(() => {\r\n            window.location.reload();\r\n          }, 500);\r\n        }\r\n      },\r\n      onDismiss: () => {}\r\n    });\r\n  }, [updateAvailable, waitingServiceWorker, isStandalone]);\r\n\r\n  useEffect(() => {\r\n    if (!user || !isStandalone) return;\r\n    if (location.pathname === '/' || location.pathname === '/auth') {\r\n      navigate('/mobile', { replace: true });\r\n    }\r\n  }, [user, isStandalone, location.pathname, navigate]);\r\n\r\n  // Track route changes for session persistence\r\n  useEffect(() => {\r\n    updateRoute(location.pathname);\r\n  }, [location.pathname]);\r\n\r\n  // Check payouts unlock on mount\r\n  useEffect(() => {\r\n    void autoUnlockPayouts();\r\n  }, []);\r\n\r\n  // üîπ Auto-routing after approval (only on home page, not on every route change)\r\n  useEffect(() => {\r\n    // Only auto-route from home page (/) - never redirect from other pages\r\n    if (location.pathname !== '/') {\r\n      return;\r\n    }\r\n\r\n    // Don't redirect if user is not logged in\r\n    if (!user || !profile) {\r\n      return;\r\n    }\r\n\r\n    // üöó Redirect to Driver Test if no license\r\n    const licenseStatus = (profile as any).drivers_license_status;\r\n    if (!licenseStatus || licenseStatus === 'none') {\r\n        // Only redirect if not already there (though the outer check covers /)\r\n        navigate('/tmv', { replace: true });\r\n        return;\r\n    }\r\n\r\n    if (profile?.role === 'troll_family') {\r\n      navigate('/family', { replace: true });\r\n    }\r\n  }, [profile, location.pathname, navigate, user]);\r\n\r\n  // Global keyboard shortcut: 'g' opens District Tour\r\n  useEffect(() => {\r\n    const handleKeyDown = (event: KeyboardEvent) => {\r\n      // Only trigger if 'g' is pressed and not in an input/textarea\r\n      if (event.key === 'g' || event.key === 'G') {\r\n        const target = event.target as HTMLElement\r\n        if (\r\n          target.tagName !== 'INPUT' &&\r\n          target.tagName !== 'TEXTAREA' &&\r\n          !target.isContentEditable\r\n        ) {\r\n          navigate('/district/main_plaza', { replace: true })\r\n        }\r\n      }\r\n    }\r\n\r\n    window.addEventListener('keydown', handleKeyDown)\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown)\r\n    }\r\n  }, [navigate])\r\n\r\n  // üîπ Check if user is kicked or banned and route to fee pages\r\n  useEffect(() => {\r\n    if (!profile) return;\r\n\r\n    if (profile.is_banned && location.pathname !== '/ban-fee') {\r\n      navigate('/ban-fee', { replace: true });\r\n      return;\r\n    }\r\n\r\n    if (profile.is_kicked && location.pathname !== '/kick-fee') {\r\n      navigate('/kick-fee', { replace: true });\r\n    }\r\n  }, [profile, location.pathname, navigate]);\r\n\r\n  // üîπ Track user IP address and check for IP bans\r\n  useEffect(() => {\r\n    const trackIP = async () => {\r\n      if (!user?.id) return\r\n\r\n      try {\r\n        // Get user's IP address\r\n        const ipResponse = await fetch('https://api.ipify.org?format=json')\r\n        const ipData = await ipResponse.json()\r\n        const userIP = ipData.ip\r\n\r\n        // Check if IP is banned\r\n        const { data: isBanned, error: banError } = await supabase.rpc('is_ip_banned', {\r\n          p_ip_address: userIP\r\n        })\r\n\r\n        if (banError) {\r\n          console.error('Error checking IP ban:', banError)\r\n          return\r\n        }\r\n\r\n        if (isBanned) {\r\n          toast.error('Your IP address has been banned. Please contact support.')\r\n          // Sign out user (defensive)\r\n          try {\r\n            const { data: sessionData } = await supabase.auth.getSession()\r\n            const hasSession = !!sessionData?.session\r\n            if (hasSession) {\r\n              const { error } = await supabase.auth.signOut()\r\n              if (error) console.warn('supabase.signOut returned error:', error)\r\n            } else {\r\n              console.debug('No active session; skipping supabase.auth.signOut()')\r\n            }\r\n          } catch (innerErr) {\r\n            console.warn('Error during sign-out (ignored):', innerErr)\r\n          }\r\n\r\n          useAuthStore.getState().logout()\r\n          navigate('/auth', { replace: true })\r\n          return\r\n        }\r\n\r\n        // Update user's last known IP\r\n        const { data: currentProfile } = await supabase\r\n          .from('user_profiles')\r\n          .select('ip_address_history')\r\n          .eq('id', user.id)\r\n          .single()\r\n\r\n        const ipHistory = currentProfile?.ip_address_history || []\r\n        const newIPEntry = {\r\n          ip: userIP,\r\n          timestamp: new Date().toISOString()\r\n        }\r\n\r\n        // Add to history if not already present\r\n        const updatedHistory = [...ipHistory, newIPEntry].slice(-10) // Keep last 10 IPs\r\n\r\n        await supabase\r\n          .from('user_profiles')\r\n          .update({\r\n            last_known_ip: userIP,\r\n            ip_address_history: updatedHistory\r\n          })\r\n          .eq('id', user.id)\r\n      } catch (error) {\r\n        console.error('Error tracking IP:', error)\r\n      }\r\n    }\r\n\r\n    if (user) {\r\n      trackIP()\r\n    }\r\n  }, [user, navigate])\r\n\r\n  // üîπ Check Daily Login for XP\r\n  useEffect(() => {\r\n    if (user?.id) {\r\n      const checkLogin = async () => {\r\n        try {\r\n          // This function checks the date, updates streak, and awards XP if valid\r\n          await supabase.rpc('check_daily_login');\r\n        } catch (e) {\r\n          console.error('Error checking daily login:', e);\r\n        }\r\n      };\r\n      checkLogin();\r\n    }\r\n  }, [user?.id]);\r\n\r\n  // üîπ Real-time Profile Updates (Debounced to prevent double renders)\r\n  useDebouncedProfileUpdate(user?.id)\r\n\r\n  useEffect(() => {\r\n    const onError = (event: ErrorEvent) => {\r\n      void reportError({\r\n        message: event.message || 'window.onerror',\r\n        stack: event.error?.stack,\r\n        userId: user?.id || null,\r\n        url: window.location.pathname,\r\n        component: 'global'\r\n      })\r\n    }\r\n    const onRejection = (event: PromiseRejectionEvent) => {\r\n      const reason = event.reason\r\n      \r\n      // Handle Invalid Refresh Token error by logging out\r\n      const reasonMsg = reason?.message || String(reason)\r\n      if (reasonMsg.includes('Invalid Refresh Token') || reasonMsg.includes('Refresh Token Not Found')) {\r\n        console.warn('Invalid refresh token detected, logging out...')\r\n        useAuthStore.getState().logout()\r\n        return\r\n      }\r\n\r\n      void reportError({\r\n        message: (reason?.message || String(reason) || 'unhandledrejection'),\r\n        stack: reason?.stack,\r\n        userId: user?.id || null,\r\n        url: window.location.pathname,\r\n        component: 'global'\r\n      })\r\n    }\r\n    const originalConsoleError = console.error\r\n    console.error = (...args: any[]) => {\r\n      try {\r\n        const msg = typeof args[0] === 'string' ? args[0] : (args[0]?.message || JSON.stringify(args[0]))\r\n        void reportError({\r\n          message: msg || 'console.error',\r\n          userId: user?.id || null,\r\n          url: window.location.pathname,\r\n          component: 'console',\r\n          context: { args }\r\n        })\r\n      } catch {}\r\n      originalConsoleError(...args)\r\n    }\r\n    window.addEventListener('error', onError)\r\n    window.addEventListener('unhandledrejection', onRejection)\r\n    return () => {\r\n      window.removeEventListener('error', onError)\r\n      window.removeEventListener('unhandledrejection', onRejection)\r\n      console.error = originalConsoleError\r\n    }\r\n  }, [user?.id])\r\n\r\n  // üîπ Tab Visibility Change Handler\r\n  useEffect(() => {\r\n    if (!user?.id) return\r\n \r\n    const handleVisibilityChange = () => {\r\n      if (!document.hidden) {\r\n        // Tab became visible, refresh data\r\n        console.log('Tab became visible, refreshing data...')\r\n        refreshProfile()\r\n        eligibilityRefresh(user.id)\r\n        // Dispatch global refetch event for all components\r\n        window.dispatchEvent(new CustomEvent(APP_DATA_REFETCH_EVENT_NAME))\r\n      }\r\n    }\r\n \r\n    document.addEventListener('visibilitychange', handleVisibilityChange)\r\n    return () => document.removeEventListener('visibilitychange', handleVisibilityChange)\r\n  }, [user?.id, refreshProfile, eligibilityRefresh])\r\n\r\n  // üîπ Scroll to top on route change\r\n  useEffect(() => {\r\n    const targets = [mainRef.current, document.scrollingElement, document.body]\r\n    targets.forEach((el) => {\r\n      if (el && typeof (el as HTMLElement).scrollTo === \"function\") {\r\n        ;(el as HTMLElement).scrollTo({ top: 0, left: 0 })\r\n      }\r\n    })\r\n  }, [location.pathname])\r\n\r\n  const handleUpdateClick = () => {\r\n    if (!waitingServiceWorker) return;\r\n    waitingServiceWorker.postMessage({ type: 'SKIP_WAITING' });\r\n    setUpdateAvailable(false);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <SessionMonitor />\r\n      {updateAvailable && (\r\n        <div className=\"fixed bottom-0 inset-x-0 z-[60] flex items-center justify-between bg-purple-900 text-white px-4 py-3\">\r\n          <span className=\"text-sm\">A new version of Troll City is available.</span>\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleUpdateClick}\r\n            className=\"ml-4 rounded bg-white text-black text-sm font-semibold px-3 py-1\"\r\n          >\r\n            Update now\r\n          </button>\r\n        </div>\r\n      )}\r\n      {/* Global Error Banner */}\r\n              <GlobalErrorBanner />\r\n              \r\n              <GlobalPayoutBanner />\r\n              <GlobalEventsBanner />\r\n              {/* Officer Alert Banner */}\r\n              <OfficerAlertBanner />\r\n              \r\n              {/* Global Gift Banner */}\r\n              <GlobalGiftBanner />\r\n\r\n              {/* Broadcast Announcement */}\r\n              <BroadcastAnnouncement />\r\n              <GlobalPodBanner />\r\n              <DailyChurchNotification />\r\n\r\n              {/* Global Loading Overlay */}\r\n      <GlobalLoadingOverlay\r\n        isVisible={globalLoading}\r\n        message={loadingMessage}\r\n        type=\"loading\"\r\n      />\r\n\r\n      {/* Global Reconnecting Overlay */}\r\n      <GlobalLoadingOverlay\r\n        isVisible={isReconnecting}\r\n        message={reconnectMessage}\r\n        type=\"reconnecting\"\r\n      />\r\n\r\n      {/* Global Error Overlay (for critical errors) */}\r\n      <GlobalLoadingOverlay\r\n        isVisible={!!error && !isReconnecting}\r\n        message={error || ''}\r\n        type=\"error\"\r\n        onRetry={retryLastAction}\r\n      />\r\n\r\n\r\n      <AppLayout showSidebar={!!user} showHeader={!!user} showBottomNav={!!user}>\r\n        {user && <AdminOfficerQuickMenu />}\r\n        {user && (\r\n          <Suspense fallback={null}>\r\n            <BadgePopup />\r\n          </Suspense>\r\n        )}\r\n        <TrollsTownControl isOpen={trollsTownControlOpen} onClose={() => setTrollsTownControlOpen(false)} />\r\n\r\n        <ErrorBoundary>\r\n          <Suspense fallback={<LoadingScreen />}>\r\n            <Routes>\r\n                {/* üö™ Public Routes */}\r\n                <Route path=\"/\" element={user ? <LandingHome /> : <LandingPage />} />\r\n              <Route path=\"/auth\" element={user ? <Navigate to=\"/\" replace /> : <Auth />} />\r\n                <Route path=\"/auth/callback\" element={<AuthCallback />} />\r\n                <Route path=\"/exit\" element={<ExitPage />} />\r\n                <Route path=\"/terms\" element={<TermsAgreement />} />\r\n                <Route path=\"/access-denied\" element={<AccessDenied />} />\r\n                <Route path=\"/terms-of-service\" element={<TermsOfService />} />\r\n                <Route path=\"/refund-policy\" element={<RefundPolicy />} />\r\n                <Route path=\"/privacy-policy\" element={<PrivacyPolicy />} />\r\n                <Route path=\"/payment-terms\" element={<PaymentTerms />} />\r\n                <Route path=\"/creator-agreement\" element={<CreatorAgreement />} />\r\n                <Route path=\"/reset-password\" element={<PasswordReset />} />\r\n                <Route path=\"/tax-onboarding\" element={<TaxOnboarding />} />\r\n                <Route path=\"/verification\" element={<VerificationPage />} />\r\n                <Route path=\"/verification/complete\" element={<VerificationComplete />} />\r\n                <Route path=\"/founding-officer-trial\" element={<FoundingOfficerTrial />} />\r\n                  <Route path=\"/account/earnings\" element={<EarningsDashboard />} />\r\n                  <Route path=\"/payout-status\" element={<PayoutStatus />} />\r\n                 \r\n                {/* Legal/Policy Pages */}\r\n                <Route path=\"/legal\" element={<PolicyCenter />} />\r\n                <Route path=\"/legal/terms\" element={<TermsOfServiceLegal />} />\r\n                <Route path=\"/legal/refunds\" element={<RefundPolicyLegal />} />\r\n                <Route path=\"/legal/refund\" element={<RefundPolicyLegal />} />\r\n                <Route path=\"/legal/payouts\" element={<PayoutPolicyLegal />} />\r\n                <Route path=\"/legal/safety\" element={<SafetyGuidelinesLegal />} />\r\n                <Route path=\"/legal/creator-earnings\" element={<CreatorEarnings />} />\r\n                <Route path=\"/legal/gambling-disclosure\" element={<GamblingDisclosure />} />\r\n                <Route path=\"/legal/partner-program\" element={<PartnerProgram />} />\r\n                 \r\n                <Route path=\"/badges\" element={<BadgesPage />} />\r\n                <Route path=\"/badges/:userId\" element={<BadgesPage />} />\r\n\r\n                {/* Safety Page (standalone) */}\r\n                <Route path=\"/safety\" element={<Safety />} />\r\n\r\n                {/* üîê Protected Routes */}\r\n                <Route element={<RequireAuth />}>\r\n                  <Route path=\"/mobile\" element={<MobileShell />} />\r\n                  <Route path=\"/live\" element={<LandingHome />} />\r\n                  <Route path=\"/messages\" element={<Navigate to=\"/tcps\" replace />} />\r\n                  <Route path=\"/tcps\" element={<TCPS />} />\r\n          <Route path=\"/city-hall\" element={<CityHall />} />\r\n                  <Route path=\"/call/:roomId/:type/:userId\" element={<Call />} />\r\n                  <Route path=\"/notifications\" element={<Notifications />} />\r\n                  <Route path=\"/following\" element={<Following />} />\r\n                  <Route path=\"/following/:userId\" element={<Following />} />\r\n                <Route path=\"/explore\" element={<ExploreFeed />} />\r\n                  <Route path=\"/trollifications\" element={<Trollifications />} />\r\n                  <Route path=\"/marketplace\" element={<Marketplace />} />\r\n                  <Route path=\"/pool\" element={<PublicPool />} />\r\n                  <Route path=\"/social/mai-talent\" element={<MaiTalentPage />} />\r\n                  <Route path=\"/shop/:username\" element={<ShopView />} />\r\n                  <Route path=\"/inventory\" element={<UserInventory />} />\r\n          <Route path=\"/troting\" element={<Troting />} />\r\n          <Route path=\"/profile/settings\" element={<ProfileSettings />} />\r\n                  <Route path=\"/bank\" element={<TrollBank />} />\r\n                  <Route path=\"/leaderboard\" element={<Leaderboard />} />\r\n                  <Route path=\"/credit-scores\" element={<CreditScorePage />} />\r\n                  <Route path=\"/support\" element={<Support />} />\r\n                  <Route path=\"/tmv\" element={<TMVPage />} />\r\n                  <Route path=\"/wall\" element={<TrollCityWall />} />\r\n                  <Route path=\"/wall/:postId\" element={<WallPostPage />} />\r\n                  <Route path=\"/profile/setup\" element={<ProfileSetup />} />\r\n                  <Route path=\"/profile/id/:userId\" element={<Profile />} />\r\n                  <Route path=\"/profile/:username\" element={<Profile />} />\r\n                  <Route path=\"/trollstown\" element={<TrollsTownPage />} />\r\n                  <Route path=\"/district/:districtName\" element={<DistrictTour />} />\r\n                  <Route path=\"/g\" element={<Navigate to=\"/district/main_plaza\" replace />} />\r\n                  <Route path=\"/living\" element={<LivingPage />} />\r\n                  \r\n                  <Route path=\"/pods\" element={<TrollPodsListing />} />\r\n                  <Route path=\"/pods/:roomId\" element={<TrollPodRoom />} />\r\n                  \r\n                  <Route path=\"/church\" element={<ChurchPage />} />\r\n                  <Route path=\"/church/pastor\" element={<PastorDashboard />} />\r\n                  <Route path=\"/dev/xp\" element={<XPSimulatorPage />} />\r\n                  \r\n                  {/* üé• Streaming */}\r\n                  <Route path=\"/go-live\" element={<GoLive />} />\r\n                  <Route path=\"/live/:streamId\" element={<LazyLivePage />} />\r\n                  <Route path=\"/broadcast/:streamId\" element={<Navigate to={`/live/${location.pathname.split('/').pop()}`} replace />} />\r\n                  <Route path=\"/watch/:streamId\" element={<Navigate to={`/live/${location.pathname.split('/').pop()}`} replace />} />\r\n                  <Route path=\"/join\" element={<JoinPage />} />\r\n                  <Route path=\"/broadcast\" element={<Navigate to=\"/go-live\" replace />} />\r\n                  <Route path=\"/broadcast-summary\" element={<BroadcastSummary />} />\r\n                  <Route path=\"/stream-summary/:streamId\" element={<BroadcastSummary />} />\r\n                  <Route path=\"/kick-fee\" element={<KickFee />} />\r\n                  <Route path=\"/ban-fee\" element={<BanFee />} />\r\n                  <Route path=\"/troll-court/session\" element={<TrollCourtSession />} />\r\n                  <Route path=\"/tromody\" element={<TromodyShow />} />\r\n                  <Route path=\"/tromody-show/broadcast\" element={<TromodyShowBroadcast />} />\r\n                  <Route path=\"/live/:streamId\" element={<Navigate to=\"/live\" replace />} />\r\n                  <Route path=\"/interview/:sessionId\" element={<InterviewRoom />} />\r\n                  <Route path=\"/stream/:id\" element={<Navigate to=\"/live\" replace />} />\r\n                  <Route path=\"/stream/:streamId\" element={<Navigate to=\"/live\" replace />} />\r\n                  <Route path=\"/stream/:id/summary\" element={<Navigate to=\"/live\" replace />} />\r\n                  <Route path=\"/stream-ended\" element={<Navigate to=\"/live\" replace />} />\r\n                  <Route path=\"/stream-picture/:streamId\" element={<StreamPicture />} />\r\n\r\n                  {/* ‚öñÔ∏è Court */}\r\n                  <Route path=\"/troll-court\" element={<TrollCourt />} />\r\n                  <Route path=\"/court/:courtId\" element={<CourtRoom />} />\r\n                   \r\n                  {/* üéÆ Multi-Box Streaming */}\r\n                  <Route path=\"/command-battle-go-live\" element={<CommandBattleGoLive />} />\r\n                  <Route path=\"/troll-battle-setup\" element={<TrollBattleSetup />} />\r\n                   \r\n                  {/* üë• Empire Partner Program */}\r\n                  <Route path=\"/empire-partner\" element={<EmpirePartnerDashboard />} />\r\n                  <Route path=\"/empire-partner/apply\" element={<EmpirePartnerApply />} />\r\n\r\n\r\n                  {/* üí≥ Payment Methods */}\r\n                  <Route path=\"/add-card\" element={<Navigate to=\"/profile/setup\" replace />} />\r\n                   \r\n                  {/* üìù Creator Onboarding */}\r\n                  <Route path=\"/onboarding/creator\" element={<CreatorOnboarding />} />\r\n                  <Route path=\"/creator-switch\" element={<CreatorSwitchProgram />} />\r\n\r\n                  {/* üí∞ Earnings & Coins */}\r\n                  <Route path=\"/store\" element={<CoinStore />} />\r\n                  <Route path=\"/coins\" element={<CoinStore />} />\r\n                  <Route path=\"/coins/complete\" element={<CoinsComplete />} />\r\n                  <Route path=\"/wallet\" element={<Wallet />} />\r\n                  <Route path=\"/stats\" element={<Stats />} />\r\n                  <Route path=\"/payouts/setup\" element={<PayoutSetupPage />} />\r\n                  <Route path=\"/payouts/request\" element={<PayoutRequest />} />\r\n                  <Route path=\"/payment/callback\" element={<PaymentCallback />} />\r\n                  <Route path=\"/earnings\" element={<EarningsPage />} />\r\n                  <Route path=\"/my-earnings\" element={<MyEarnings />} />\r\n                  <Route path=\"/cashout\" element={<CashoutPage />} />\r\n                  <Route path=\"/withdraw\" element={<Withdraw />} />\r\n                  <Route path=\"/transactions\" element={<TransactionHistory />} />\r\n                  <Route path=\"/shop-partner\" element={<ShopPartnerPage />} />\r\n                  <Route path=\"/sell\" element={<SellOnTrollCity />} />\r\n                  <Route path=\"/seller/earnings\" element={<ShopEarnings />} />\r\n                  {/* Gift store routes removed */}\r\n\r\n                  {/* üë®‚Äçüë©‚Äçüëß Family */}\r\n                  <Route path=\"/family\" element={<TrollFamily />} />\r\n                  <Route path=\"/family/browse\" element={<FamilyBrowse />} />\r\n                  <Route path=\"/family/city\" element={<TrollFamilyCity />} />\r\n                  <Route path=\"/family/profile/:id\" element={<FamilyProfilePage />} />\r\n                  <Route path=\"/family/chat\" element={<FamilyChatPage />} />\r\n                  <Route path=\"/family/wars\" element={<FamilyWarsPage />} />\r\n\r\n                  {/* üè∞ Troll Family Ecosystem */}\r\n                  <Route path=\"/family/lounge\" element={<FamilyLounge />} />\r\n                  <Route path=\"/family/wars-hub\" element={<FamilyWarsHub />} />\r\n                  <Route path=\"/family/leaderboard\" element={<FamilyLeaderboard />} />\r\n                  <Route path=\"/family/shop\" element={<FamilyShop />} />\r\n\r\n                  {/* üìù Applications */}\r\n                  <Route path=\"/apply\" element={<Application />} />\r\n                  <Route path=\"/application\" element={<ApplicationPage />} />\r\n                  <Route path=\"/apply/family\" element={<FamilyApplication />} />\r\n                  <Route path=\"/apply/officer\" element={<OfficerApplication />} />\r\n                  <Route path=\"/apply/troller\" element={<TrollerApplication />} />\r\n                  <Route path=\"/apply/lead-officer\" element={<LeadOfficerApplication />} />\r\n                  <Route path=\"/apply/pastor\" element={<PastorApplication />} />\r\n                  <Route path=\"/career\" element={<Career />} />\r\n                  <Route path=\"/interview-room\" element={<InterviewRoomPage />} />\r\n                  <Route path=\"/admin/interview-test\" element={<AdminInterviewDashboard />} />\r\n\r\n                  {/* üëÆ Officer */}\r\n                  <Route\r\n                    path=\"/lead-officer/review\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER]}>\r\n                        <LeadOfficerReview />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/lead-officer\"\r\n                    element={\r\n                      <RequireLeadOrOwner>\r\n                        <LeadOfficerDashboard />\r\n                      </RequireLeadOrOwner>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/lounge\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <TrollOfficerLounge />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/moderation\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <OfficerModeration />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/report/:id\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <ReportDetailsPage />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/scheduling\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <OfficerScheduling />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/stream\"\r\n                    element={\r\n                      <RequireRole\r\n                        roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER, UserRole.LEAD_TROLL_OFFICER]}\r\n                      >\r\n                        <OfficerLoungeStream />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/dashboard\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <OfficerDashboard />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/officer/owc\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <OfficerOWCDashboard />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n\r\n                  <Route\r\n                    path=\"/officer/payroll\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.ADMIN]}>\r\n                        <OfficerPayrollDashboard />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route path=\"/officer/vote\" element={<OfficerVote />} />\r\n                  <Route\r\n                    path=\"/government/streams\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.TROLL_OFFICER, UserRole.LEAD_TROLL_OFFICER, UserRole.ADMIN, UserRole.SECRETARY]}>\r\n                        <GovernmentStreams />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n\r\n                  {/* üëë Admin */}\r\n                  <Route\r\n                    path=\"/admin\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <AdminDashboard />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/admin/creator-approvals\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN, UserRole.SECRETARY, UserRole.LEAD_TROLL_OFFICER]}>\r\n                        <div className=\"p-6 md:p-8 max-w-6xl mx-auto space-y-5\">\r\n                          <CreatorSwitchApprovals />\r\n                        </div>\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/admin/officer-operations\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <OfficerOperations />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/store-debug\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <StoreDebug />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/admin/payouts-mobile\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <AdminPayoutMobile />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/admin-mobile\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <MobileAdminDashboard />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/admin/officer-reports\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <AdminOfficerReports />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route\r\n                    path=\"/admin/earnings\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <AdminEarningsDashboard />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                    <Route\r\n                      path=\"/admin/payments\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER]}>\r\n                          <PaymentsDashboard />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/economy\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER]}>\r\n                          <EconomyDashboard />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/tax-reviews\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER]}>\r\n                          <TaxReviewPanel />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/tax/upload\"\r\n                      element={<TaxUpload />}\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/referrals\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER]}>\r\n                          <ReferralBonusPanel />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/payouts\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminPayoutDashboard />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/officers-live\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminLiveOfficersTracker />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/verified-users\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminVerifiedUsers />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/verification\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminVerificationReview />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/applications\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ApplicationsPage />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/docs/policies\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminPoliciesDocs />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/marketplace\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminMarketplace />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    {systemManagementRoutes.map((route) => {\r\n                      const Component = route.component\r\n                      return (\r\n                        <Route\r\n                          key={route.id}\r\n                          path={route.path}\r\n                          element={\r\n                            <RequireRole roles={route.roles ?? [UserRole.ADMIN]}>\r\n                              <Component />\r\n                            </RequireRole>\r\n                          }\r\n                        />\r\n                      )\r\n                    })}\r\n                    <Route\r\n                      path=\"/admin/pool\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminPoolTab />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/ban-management\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <BanManagement />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n\r\n                    <Route\r\n                      path=\"/admin/user-forms\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <UserFormsTab />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    \r\n\r\n                    \r\n                    {/* Executive Office Routes */}\r\n                    <Route\r\n                      path=\"/admin/executive-secretaries\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ExecutiveSecretaries />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/gift-cards\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <GiftCardsManager />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/executive-intake\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ExecutiveIntake />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/executive-reports\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ExecutiveReports />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/troll-town-deeds\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminTrollTownDeeds />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/cashout-manager\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <CashoutManager />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/critical-alerts\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <CriticalAlertsManager />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/officer-management\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <OfficerManager />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    \r\n                    {/* Secretary Console - Protected by internal logic */}\r\n                    <Route\r\n                      path=\"/secretary\"\r\n                      element={\r\n                        <SecretaryConsole />\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/role-management\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <RoleManagement />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/media-library\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <MediaLibrary />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/chat-moderation\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ChatModeration />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/announcements\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <Announcements />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/send-notifications\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <SendNotifications />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/broadcast-lock\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <BroadcastLockDashboard />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/export-data\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ExportData />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/user-search\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <UserSearch />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/reports-queue\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ReportsQueue />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/stream-monitor\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <StreamMonitorPage />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/voting\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <TrotingAdminPage />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                  \r\n                    <Route\r\n                      path=\"/admin/payment-logs\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <PaymentLogs />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/launch-trial\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminLaunchTrial />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/store-pricing\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <StorePriceEditor />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/errors\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminErrors />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/finance\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <AdminFinanceDashboard />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/manual-orders\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN, UserRole.SECRETARY]}>\r\n                          <AdminManualOrders />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/buckets\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <BucketsDashboard />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/grant-coins\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <GrantCoins />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/create-schedule\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <CreateSchedule />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/officer-shifts\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <OfficerShifts />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/empire-applications\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <EmpireApplicationsPage />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/referral-bonuses\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ReferralBonuses />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/control-panel\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ControlPanel />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/test-diagnostics\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <TestDiagnosticsPage />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                    <Route\r\n                      path=\"/admin/reset-maintenance\"\r\n                      element={\r\n                        <RequireRole roles={[UserRole.ADMIN]}>\r\n                          <ResetMaintenance />\r\n                        </RequireRole>\r\n                      }\r\n                    />\r\n                  <Route\r\n                    path=\"/admin/hr\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN, UserRole.TROLL_OFFICER, UserRole.HR_ADMIN]}>\r\n                        <AdminHR />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  <Route path=\"/rfc\" element={<AdminRFC />} />\r\n                  <Route\r\n                    path=\"/changelog\"\r\n                    element={\r\n                      <RequireRole roles={[UserRole.ADMIN]}>\r\n                        <Changelog />\r\n                      </RequireRole>\r\n                    }\r\n                  />\r\n                  {/* Account routes removed - Settings/Account pages no longer in sidebar */}\r\n                </Route>\r\n\r\n                {/* üîô Catch-all */}\r\n                <Route path=\"*\" element={<Navigate to=\"/\" replace />} />\r\n                  </Routes>\r\n                </Suspense>\r\n              </ErrorBoundary>\r\n        <ChatBubble />\r\n        <GlobalPodBanner />\r\n      </AppLayout>\r\n\r\n      {/* Profile setup modal */}\r\n      <ProfileSetupModal\r\n        isOpen={profileModalOpen}\r\n        onSubmit={() => {}}\r\n        loading={profileModalLoading}\r\n        onClose={() => setProfileModalOpen(false)}\r\n      />\r\n\r\n      {/* Toast system */}\r\n      <Toaster\r\n        position=\"top-right\"\r\n        duration={5000}\r\n        toastOptions={{\r\n          style: {\r\n            background: \"#2e1065\",\r\n            color: \"#fff\",\r\n            border: \"1px solid #22c55e\",\r\n          },\r\n        }}\r\n      />\r\n  </>)\r\n}\r\n\r\nfunction App() {\r\n  useEffect(() => {\r\n    initTelemetry();\r\n  }, []);\r\n\r\n  return <AppContent />;\r\n}\r\n\r\nexport default App;\r\n// Removed stray JSX outside of App component\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\FamilyCityMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AdminForWeekModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":13,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { supabase } from '../lib/supabase';\nimport { useAuthStore } from '../lib/store';\nimport { toast } from 'sonner';\nimport { Crown, Clock, Users, X } from 'lucide-react';\n\nexport default function AdminForWeekModal({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {\n  const { user } = useAuthStore();\n  const [queue, setQueue] = useState<any[]>([]);\n  const [loading, setLoading] = useState(false);\n\n  const fetchQueue = async () => {\n    const { data, error } = await supabase\n      .from('admin_for_week_queue')\n      .select('*, user:user_profiles(username, avatar_url)')\n      .in('status', ['active', 'queued'])\n      .order('created_at', { ascending: true });\n    \n    if (data) setQueue(data);\n  };\n\n  useEffect(() => {\n    if (isOpen) fetchQueue();\n  }, [isOpen]);\n\n  const handlePurchase = async () => {\n    if (!confirm('Purchase Admin for a Week for 5,000 Coins?')) return;\n    setLoading(true);\n    try {\n      const { data, error } = await supabase.rpc('purchase_admin_for_week');\n      if (error) throw error;\n      if (data && !data.success) throw new Error(data.error);\n      \n      toast.success('Joined the Admin Queue!');\n      fetchQueue();\n    } catch (err: any) {\n      toast.error(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  const activeAdmin = queue.find(q => q.status === 'active');\n  const waitingQueue = queue.filter(q => q.status === 'queued');\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4\">\n      <div className=\"bg-zinc-900 border border-yellow-500/30 rounded-2xl w-full max-w-md overflow-hidden relative\">\n        <button onClick={onClose} className=\"absolute top-3 right-3 text-zinc-400 hover:text-white\"><X className=\"w-5 h-5\" /></button>\n        \n        <div className=\"bg-gradient-to-r from-yellow-900/50 to-zinc-900 p-6 border-b border-yellow-500/20\">\n            <h2 className=\"text-xl font-bold text-yellow-400 flex items-center gap-2\">\n                <Crown className=\"w-6 h-6\" /> Admin For A Week\n            </h2>\n            <p className=\"text-xs text-yellow-200/70 mt-1\">Rule the city. Enforce the law. Be the boss.</p>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n            {/* Active Admin */}\n            <div className=\"bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4 flex items-center gap-4\">\n                <div className=\"w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-2xl border border-yellow-500/50 overflow-hidden\">\n                    {activeAdmin?.user?.avatar_url ? <img src={activeAdmin.user.avatar_url} className=\"w-full h-full object-cover\" /> : 'üëë'}\n                </div>\n                <div>\n                    <div className=\"text-xs uppercase tracking-wider text-yellow-500 font-bold mb-1\">Current Ruler</div>\n                    <div className=\"text-white font-bold text-lg\">{activeAdmin?.user?.username || 'None'}</div>\n                    {activeAdmin && <div className=\"text-xs text-zinc-400\">Ends: {new Date(activeAdmin.ended_at).toLocaleDateString()}</div>}\n                </div>\n            </div>\n\n            {/* Queue List */}\n            <div>\n                <div className=\"flex items-center justify-between mb-2\">\n                    <span className=\"text-sm font-bold text-zinc-300 flex items-center gap-2\"><Users className=\"w-4 h-4\" /> Queue Line</span>\n                    <span className=\"text-xs text-zinc-500\">{waitingQueue.length} waiting</span>\n                </div>\n                <div className=\"bg-zinc-950/50 rounded-lg border border-zinc-800 p-2 max-h-40 overflow-y-auto space-y-2\">\n                    {waitingQueue.length === 0 ? (\n                        <div className=\"text-center text-zinc-600 py-4 text-sm\">The line is empty. Be next!</div>\n                    ) : (\n                        waitingQueue.map((item, idx) => (\n                            <div key={item.id} className=\"flex items-center justify-between bg-zinc-900 p-2 rounded border border-zinc-800\">\n                                <span className=\"text-zinc-400 font-mono text-xs\">#{idx + 1}</span>\n                                <span className=\"text-zinc-200 text-sm font-medium\">{item.user?.username}</span>\n                                <span className=\"text-zinc-600 text-xs\"><Clock className=\"w-3 h-3\" /></span>\n                            </div>\n                        ))\n                    )}\n                </div>\n            </div>\n\n            <button \n                onClick={handlePurchase}\n                disabled={loading || queue.some(q => q.user_id === user?.id)}\n                className=\"w-full bg-yellow-600 hover:bg-yellow-500 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-3 rounded-xl transition-all shadow-lg hover:shadow-yellow-500/20 flex items-center justify-center gap-2\"\n            >\n                {loading ? 'Processing...' : (\n                    <>\n                        <span>Join Queue</span>\n                        <span className=\"bg-black/20 px-2 py-0.5 rounded text-xs\">200k ü™ô</span>\n                    </>\n                )}\n            </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AdminOfficerQuickMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AdminOnly.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AdminProfilePanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AdminRFC.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":212,"column":40,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[9962,10047],"text":"\r\n                  ‚Ä¢ Earn 5% of streamer&apos;s earned coins once they reach 40,000/month"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[9962,10047],"text":"\r\n                  ‚Ä¢ Earn 5% of streamer&lsquo;s earned coins once they reach 40,000/month"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[9962,10047],"text":"\r\n                  ‚Ä¢ Earn 5% of streamer&#39;s earned coins once they reach 40,000/month"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[9962,10047],"text":"\r\n                  ‚Ä¢ Earn 5% of streamer&rsquo;s earned coins once they reach 40,000/month"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { Shield, Coins, Banknote, Gift, Crown, DollarSign, ChevronDown, ChevronUp } from 'lucide-react'\r\n\r\nexport default function AdminRFC() {\r\n  const { profile } = useAuthStore()\r\n\r\n  if (!profile || profile.role !== 'admin') {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0D0D1A] text-white p-6\">\r\n        <div className=\"max-w-3xl mx-auto text-center\">\r\n          <h1 className=\"text-3xl font-bold mb-2\">Admin Only</h1>\r\n          <p className=\"text-gray-400 text-sm\">This RFC document is restricted to Administrators. Please contact an Admin for access.</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0D0D1A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n\r\n        {/* PAGE HEADER */}\r\n        <h1 className=\"text-3xl font-bold flex items-center gap-3 mb-6\">\r\n          <Shield className=\"text-purple-400 w-8 h-8\" />\r\n          RFC ‚Äî Rules, Fees & Costs (Admin Only)\r\n        </h1>\r\n\r\n        <p className=\"text-gray-400 text-sm mb-10\">\r\n          Internal document defining how Troll City handles pricing, payouts, moderation rewards, and platform fees.\r\n        </p>\r\n\r\n        {/* COIN STORE */}\r\n        <Section title=\"Coin Store Pricing\" icon={<Coins className=\"text-yellow-400 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Package Name', 'Coins', 'Price (USD)', 'Value per $1']}\r\n            rows={[\r\n              ['Baby Troll', '500', '$6.49', '77'],\r\n              ['Little Troller', '1,440', '$12.99', '110'],\r\n              ['Mischief Pack', '3,200', '$24.99', '128'],\r\n              ['Troll Family Pack', '6,000', '$44.99', '133'],\r\n              ['Royal Troll Pack', '12,500', '$104.99', '119'],\r\n              ['Ultimate Troll Pack', '51,800', '$279.99', '185'],\r\n            ]}\r\n          />\r\n        </Section>\r\n\r\n        {/* CASH OUT RULES */}\r\n        <Section title=\"Cash-Out Rules\" icon={<Banknote className=\"text-green-400 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Free Coins Required', 'Cash Payout', 'Platform Fee', 'Profit Margin']}\r\n            rows={[\r\n              ['7,000', '$21', '$4', '$4.50'],\r\n              ['14,000', '$49.50', '$9', '$7.00'],\r\n              ['27,000', '$90', '$13', '$10.50'],\r\n              ['47,000', '$155', '$19', '$14.50'],\r\n            ]}\r\n          />\r\n          <p className=\"text-gray-400 text-sm mt-2\">\r\n            ‚ö† troll_coins cannot be cashed out. Only free coins earned via streaming or gifting.\r\n          </p>\r\n        </Section>\r\n\r\n        {/* GIFT SYSTEM */}\r\n        <Section title=\"Gift Rules & Rewards\" icon={<Gift className=\"text-pink-400 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Gift Name', 'Cost (Coins)', 'Streamer Earns', 'Special Effect']}\r\n            rows={[\r\n              ['Blunt', '1', '0.8', 'No effect'],\r\n              ['Lighter', '5', '4', 'Spark flash'],\r\n              ['Pack of Cigs', '15', '12', 'Smoke puff'],\r\n              ['Bong', '25', '20', 'Green vapor'],\r\n              ['Troll Hat', '40', '32', 'Rotating hat'],\r\n              ['Tool Box (Admin)', '75', '35', '+1% Store Profit'],\r\n              ['Basketball - VIVED', '100', '5 troll_coins', 'Tracks 5000 coin goal'],\r\n              ['SAV Cat Scratch', '200', '5 troll_coins', 'Screen-wide scratch'],\r\n            ]}\r\n          />\r\n        </Section>\r\n\r\n        {/* OFFICER PAY STRUCTURE */}\r\n        <Section title=\"Troll Officer Earnings\" icon={<Shield className=\"text-blue-400 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Action', 'Reputation Gain', 'troll_coins?', 'Bonus']}\r\n            rows={[\r\n              ['Kick', '+3', 'No', 'Light violation'],\r\n              ['Mute', '+1', 'No', 'Temporary discipline'],\r\n              ['Ban', '+7', '1% future payout', 'Permanent block'],\r\n              ['False Ban/Report', '-10', 'No', 'Penalty'],\r\n            ]}\r\n          />\r\n          <p className=\"text-gray-400 text-sm mt-2\">\r\n            Officers do not get instant pay; rewards depend on streamer‚Äôs future payouts.\r\n          </p>\r\n        </Section>\r\n\r\n        {/* PAYMENT PROCESSORS */}\r\n        <Section title=\"Payment Processing Fees\" icon={<DollarSign className=\"text-orange-400 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Provider', 'Fee Structure', 'Avg Cost']}\r\n            rows={[\r\n              ['Venmo / Cash App', '1.5%', 'Wallet to wallet'],\r\n              ['Apple Pay / Google Pay', '2.8% + $0.30', 'Tokenized payments'],\r\n            ]}\r\n          />\r\n        </Section>\r\n\r\n        {/* ENTRANCE EFFECTS */}\r\n        <Section title=\"Entrance Effects (troll_coins)\" icon={<Crown className=\"text-yellow-500 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Effect Name', 'Coin Cost', 'Duration', 'Eligibility']}\r\n            rows={[\r\n              ['Neon Troll Explosion', '5,000', '5s', 'VIP, Elite'],\r\n              ['Royal Sparkle Crown', '10,000', '8s', 'VIP Only'],\r\n              ['VIVED Meteor Shower', '50,000', '10s', 'Limited VIP'],\r\n              ['SAV Thunder Scratch', '75,000', '12s', 'Elite Only'],\r\n            ]}\r\n          />\r\n        </Section>\r\n\r\n        {/* EMPIRE PROGRAM */}\r\n        <Section title=\"Empire Partner Program\" icon={<Crown className=\"text-purple-400 w-6 h-6\" />}>\r\n          <Table\r\n            headers={['Program Level', 'Application Fee', 'Recruiter Bonus', 'Eligibility Requirements']}\r\n            rows={[\r\n              ['Empire Partner', '$15 USD', '5% of recruit earnings', 'Approved creator + admin review'],\r\n              ['TrollTract Contract', '20,000 coins', 'Creator access required', 'Purchase contract first'],\r\n              ['Referral Tracking', 'Manual assignment', 'Permanent relationships', 'Admin-controlled only'],\r\n            ]}\r\n          />\r\n          \r\n          <h3 className=\"text-lg font-semibold text-white mt-6 mb-3\">üèÜ Empire Partner Benefits</h3>\r\n          <ul className=\"text-gray-300 space-y-2 pl-6 list-disc text-sm mb-4\">\r\n            <li>5% commission on all recruited creator earnings</li>\r\n            <li>Exclusive Empire Partner badge and profile recognition</li>\r\n            <li>Access to Empire Partner dashboard and analytics</li>\r\n            <li>Priority support and direct admin contact</li>\r\n            <li>Exclusive promo codes for Empire Partners only</li>\r\n            <li>Manual recruit assignment by admins (prevents abuse)</li>\r\n          </ul>\r\n\r\n          <h3 className=\"text-lg font-semibold text-white mb-3\">üìã Application Process</h3>\r\n          <Table\r\n            headers={['Step', 'Action', 'Cost', 'Processing Time']}\r\n            rows={[\r\n              ['1', 'Purchase TrollTract Contract', '20,000 coins', 'Instant'],\r\n              ['2', 'Submit Creator Application', 'Free', 'Admin review'],\r\n              ['3', 'Pay Empire Partner Fee', '$15 USD', 'Instant'],\r\n              ['4', 'Empire Partner Review', 'Free', 'Admin decision'],\r\n              ['5', 'Admin Assigns Recruits', 'Free', 'Manual process'],\r\n            ]}\r\n          />\r\n\r\n          <h3 className=\"text-lg font-semibold text-white mt-6 mb-3\">‚ö†Ô∏è Empire Partner Rules</h3>\r\n          <ul className=\"text-gray-300 space-y-2 pl-6 list-disc text-sm\">\r\n            <li>Must be approved creator before Empire Partner application</li>\r\n            <li>$15 application fee is non-refundable</li>\r\n            <li>Recruits are manually assigned by admins only</li>\r\n            <li>No self-assignment or referral link abuse allowed</li>\r\n            <li>5% commission only applies to earnings over 40,000 coins/month</li>\r\n            <li>Commission paid in troll_coins (not cash withdrawable)</li>\r\n            <li>Abuse of system results in permanent ban from program</li>\r\n            <li>Recruit relationships are permanent and cannot be changed</li>\r\n          </ul>\r\n\r\n          <h3 className=\"text-lg font-semibold text-white mt-6 mb-3\">üõ°Ô∏è Admin Controls</h3>\r\n          <Table\r\n            headers={['Admin Action', 'Permission Level', 'Description', 'Audit Trail']}\r\n            rows={[\r\n              ['Review Applications', 'Admin/Officer', 'Approve/deny creator and Empire Partner apps', 'Logged with notes'],\r\n              ['Assign Recruits', 'Admin Only', 'Manual partner-recruit relationship assignment', 'Permanent records'],\r\n              ['Revoke Status', 'Admin Only', 'Remove Empire Partner privileges for violations', 'Full audit trail'],\r\n              ['View Analytics', 'Admin/Officer', 'Empire Partner earnings and performance tracking', 'Comprehensive logs'],\r\n            ]}\r\n          />\r\n        </Section>\r\n\r\n        {/* PLATFORM POLICIES */}\r\n        <div className=\"mt-8\">\r\n          <h2 className=\"text-2xl font-bold text-white mb-4\">\r\n            üìú Platform Policies, Rules & Economy Regulations\r\n          </h2>\r\n\r\n          {[\r\n            {\r\n              title: \"ü§ë Coin & Fee Policy\",\r\n              content: (\r\n                <>\r\n                  ‚Ä¢ 100 coins = $1 USD<br />\r\n                  ‚Ä¢ Minimum withdrawal: 12,000 coins (‚âà $36)<br />\r\n                  ‚Ä¢ Platform commission: 5% per gifted coin<br />\r\n                  ‚Ä¢ Finix / Square payout processing fee: 2.9% + $0.30<br />\r\n                  ‚Ä¢ 1099-K issued for earnings over $600 per year (US law)<br />\r\n                </>\r\n              )\r\n            },\r\n            {\r\n              title: \"üé§ Broadcaster Rules\",\r\n              content: (\r\n                <>\r\n                  ‚Ä¢ Must complete onboarding + ID verification before going live<br />\r\n                  ‚Ä¢ Must enable 18+ age restriction for payouts<br />\r\n                  ‚Ä¢ Streaming misleading content is a violation (fake earnings, scams)<br />\r\n                  ‚Ä¢ Repeated policy violations ‚Üí stream suspension ‚Üí account ban<br />\r\n                </>\r\n              )\r\n            },\r\n            {\r\n              title: \"üíº Recruiter Program Rules\",\r\n              content: (\r\n                <>\r\n                  ‚Ä¢ Earn 5% of streamer's earned coins once they reach 40,000/month<br />\r\n                  ‚Ä¢ Bonus paid in troll_coins (not cash withdrawable)<br />\r\n                  ‚Ä¢ Referrals must be REAL and unique active users<br />\r\n                  ‚Ä¢ Abuse = Permanent Recruiter program ban<br />\r\n                </>\r\n              )\r\n            },\r\n            {\r\n              title: \"üõ°Ô∏è Troll Officer Compliance\",\r\n              content: (\r\n                <>\r\n                  ‚Ä¢ Level 1: Mute & Chat freeze<br />\r\n                  ‚Ä¢ Level 2: Kick users + stream lockdown<br />\r\n                  ‚Ä¢ Level 3: Full ban / report to admin<br />\r\n                  ‚Ä¢ Every moderation action is logged in Supabase (audit log)<br />\r\n                  ‚Ä¢ Abuse = demotion/banning from program<br />\r\n                </>\r\n              )\r\n            },\r\n            {\r\n              title: \"‚öñÔ∏è Legal & Policy Requirements\",\r\n              content: (\r\n                <>\r\n                  ‚Ä¢ You must be 18+ to receive payouts or host live streams<br />\r\n                  ‚Ä¢ Refund policy is governed by digital goods law and Square<br />\r\n                  ‚Ä¢ Chargeback fraud = permanent account termination<br />\r\n                  ‚Ä¢ COPPA compliance: Viewers under 13 are not permitted<br />\r\n                </>\r\n              )\r\n            }\r\n          ].map((section, index) => (\r\n            <PolicySection key={index} title={section.title} content={section.content} />\r\n          ))}\r\n        </div>\r\n\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n/* POLICY SECTION COMPONENT */\r\nconst PolicySection = ({ title, content }: { title: string; content: React.ReactNode }) => {\r\n  const [open, setOpen] = useState(false);\r\n\r\n  return (\r\n    <div className=\"mb-4 bg-zinc-900 text-white p-4 rounded-xl\">\r\n      <button \r\n        onClick={() => setOpen(!open)} \r\n        className=\"flex justify-between w-full text-lg font-semibold items-center hover:opacity-80 transition-opacity\"\r\n      >\r\n        {title}\r\n        {open ? <ChevronUp className=\"w-5 h-5\" /> : <ChevronDown className=\"w-5 h-5\" />}\r\n      </button>\r\n      {open && <div className=\"mt-3 text-sm leading-relaxed text-gray-300\">{content}</div>}\r\n    </div>\r\n  );\r\n};\r\n\r\n/* SECTION WRAPPER */\r\nfunction Section({ title, icon, children }: any) {\r\n  return (\r\n    <div className=\"bg-[#151520] p-6 rounded-lg mb-10 border border-gray-800 shadow-md\">\r\n      <h2 className=\"text-xl font-bold flex items-center gap-3 mb-4\">{icon} {title}</h2>\r\n      {children}\r\n    </div>\r\n  )\r\n}\r\n\r\n/* REUSABLE TABLE */\r\nfunction Table({ headers, rows }: any) {\r\n  return (\r\n    <div className=\"overflow-x-auto\">\r\n      <table className=\"w-full border border-gray-800 text-sm\">\r\n        <thead>\r\n          <tr>\r\n            {headers.map((h: string, idx: number) => (\r\n              <th\r\n                key={idx}\r\n                className=\"border border-gray-800 bg-[#1E1E2D] px-3 py-2 text-left text-gray-300 font-semibold\"\r\n              >\r\n                {h}\r\n              </th>\r\n            ))}\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n          {rows.map((row: any[], i: number) => (\r\n            <tr key={i}>\r\n              {row.map((cell: any, j: number) => (\r\n                <td key={j} className=\"border border-gray-800 px-3 py-2 text-gray-400\">\r\n                  {cell}\r\n                </td>\r\n              ))}\r\n            </tr>\r\n          ))}\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AuthorityPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\AuthorityPresenceBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\BadgePopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\BanPage.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":31,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1409,1523],"text":"\r\n              You have violated Troll City&apos;s community guidelines. This action cannot be reversed.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1409,1523],"text":"\r\n              You have violated Troll City&lsquo;s community guidelines. This action cannot be reversed.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1409,1523],"text":"\r\n              You have violated Troll City&#39;s community guidelines. This action cannot be reversed.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1409,1523],"text":"\r\n              You have violated Troll City&rsquo;s community guidelines. This action cannot be reversed.\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { X, Ban, AlertTriangle } from 'lucide-react'\r\n\r\ninterface BanPageProps {\r\n  onClose: () => void\r\n}\r\n\r\nexport default function BanPage({ onClose }: BanPageProps) {\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/90 backdrop-blur-lg flex items-center justify-center p-6 z-50\">\r\n      <div className=\"bg-[#1A0000] border-2 border-red-600 rounded-xl p-8 w-full max-w-2xl shadow-[0_0_60px_rgba(255,0,0,0.8)] relative\">\r\n        <button\r\n          onClick={onClose}\r\n          className=\"absolute top-4 right-4 text-gray-400 hover:text-white transition-colors\"\r\n        >\r\n          <X size={24} />\r\n        </button>\r\n\r\n        <div className=\"text-center mb-8\">\r\n          <div className=\"flex justify-center mb-6\">\r\n            <div className=\"relative\">\r\n              <Ban className=\"w-24 h-24 text-red-500 animate-pulse\" />\r\n              <div className=\"absolute inset-0 bg-red-500/20 rounded-full animate-ping\" />\r\n            </div>\r\n          </div>\r\n          <h1 className=\"text-4xl font-bold text-red-400 mb-4\">Account Banned</h1>\r\n          <div className=\"bg-red-900/30 border border-red-500/50 rounded-lg p-4 mb-6\">\r\n            <AlertTriangle className=\"w-8 h-8 text-red-400 mx-auto mb-2\" />\r\n            <p className=\"text-red-300 text-lg font-semibold mb-2\">Your account has been permanently banned</p>\r\n            <p className=\"text-gray-300 text-sm\">\r\n              You have violated Troll City's community guidelines. This action cannot be reversed.\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"space-y-4 mb-6\">\r\n          <div className=\"bg-[#0A0000] border border-red-500/30 rounded-lg p-4\">\r\n            <h3 className=\"text-red-400 font-semibold mb-2\">Ban Details</h3>\r\n            <div className=\"text-sm text-gray-300 space-y-1\">\r\n              <p><strong>Reason:</strong> Multiple violations of community guidelines</p>\r\n              <p><strong>Date:</strong> {new Date().toLocaleDateString()}</p>\r\n              <p><strong>Status:</strong> Permanent</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-[#0A0000] border border-red-500/30 rounded-lg p-4\">\r\n            <h3 className=\"text-red-400 font-semibold mb-2\">What This Means</h3>\r\n            <ul className=\"text-sm text-gray-300 list-disc list-inside space-y-1\">\r\n              <li>You cannot access Troll City</li>\r\n              <li>All your data and progress are locked</li>\r\n              <li>You cannot create a new account</li>\r\n              <li>This ban is permanent and cannot be appealed</li>\r\n            </ul>\r\n          </div>\r\n\r\n          <div className=\"bg-yellow-900/20 border border-yellow-500/50 rounded-lg p-4\">\r\n            <h3 className=\"text-yellow-400 font-semibold mb-2\">Restore Your Account</h3>\r\n            <p className=\"text-sm text-gray-300 mb-3\">\r\n              You can restore your account by paying <strong className=\"text-yellow-400\">2000 troll_coins</strong>.\r\n              Your account will be reset to level 0 with 0 coins.\r\n            </p>\r\n            <button \r\n              onClick={async () => {\r\n                try {\r\n                  const { data, error } = await import('../lib/supabase').then(m => m.supabase.rpc('restore_banned_account'));\r\n                  if (error) throw error;\r\n                  if (data && data.success) {\r\n                    window.location.reload();\r\n                  } else {\r\n                    alert(data?.message || 'Failed to restore account');\r\n                  }\r\n                } catch (e) {\r\n                  console.error(e);\r\n                  alert('Error restoring account');\r\n                }\r\n              }}\r\n              className=\"w-full py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-semibold transition-colors\"\r\n            >\r\n              Pay 2000 Coins to Restore Account\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"text-center\">\r\n          <button\r\n            onClick={onClose}\r\n            className=\"px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors\"\r\n          >\r\n            Done\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\BottomNavigation.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Gift' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":218,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":222,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Gift"},"fix":{"range":[334,340],"text":""},"desc":"Remove unused variable \"Gift\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { Link, useLocation, useNavigate } from 'react-router-dom'\r\nimport { Home, MessageSquare, Store, Video, User, Shield, Gavel, Star, Zap, DollarSign, Users, AlertTriangle, Ban, Settings, Heart, LogOut, FileText, ShoppingBag, Briefcase, Banknote, Gamepad2, Music, Swords, Camera, Gift } from 'lucide-react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { toast } from 'sonner'\r\n\r\nexport default function BottomNavigation() {\r\n  const { user, profile, logout } = useAuthStore()\r\n  const location = useLocation()\r\n  const navigate = useNavigate()\r\n  const [isMenuOpen, setIsMenuOpen] = useState(false)\r\n  const [isLiveMenuOpen, setIsLiveMenuOpen] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (isMenuOpen || isLiveMenuOpen) {\r\n      document.body.classList.add('no-scroll')\r\n    } else {\r\n      document.body.classList.remove('no-scroll')\r\n    }\r\n    return () => {\r\n      document.body.classList.remove('no-scroll')\r\n    }\r\n  }, [isMenuOpen, isLiveMenuOpen])\r\n\r\n  useEffect(() => {\r\n    setIsMenuOpen(false)\r\n    setIsLiveMenuOpen(false)\r\n  }, [location.pathname])\r\n\r\n  const liveCategories = [\r\n    { label: 'All Streams', icon: Video, path: '/live' },\r\n    { label: 'Just Chatting', icon: MessageSquare, path: '/live/just-chatting' },\r\n    { label: 'Gaming', icon: Gamepad2, path: '/live/gaming' },\r\n    { label: 'Music', icon: Music, path: '/live/music' },\r\n    { label: 'Battles', icon: Swords, path: '/live/battles' },\r\n    { label: 'IRL', icon: Camera, path: '/live/irl' }\r\n  ]\r\n\r\n  const handleLogout = async () => {\r\n    try {\r\n      // Check for active session first\r\n      try {\r\n        const { data: sessionData } = await supabase.auth.getSession()\r\n        if (sessionData?.session) {\r\n          await supabase.auth.signOut()\r\n        }\r\n      } catch (e) {\r\n        console.warn('Error checking/signing out session:', e)\r\n      }\r\n\r\n      logout() // Clear store state\r\n\r\n      // Clear client storage\r\n      try {\r\n        localStorage.clear()\r\n        sessionStorage.clear()\r\n      } catch (e) {\r\n        console.error('Error clearing storage:', e)\r\n      }\r\n\r\n      toast.success('Logged out successfully')\r\n      setIsMenuOpen(false)\r\n      navigate('/exit')\r\n    } catch (error) {\r\n      console.error('Logout error:', error)\r\n      toast.error('Error logging out')\r\n    }\r\n  }\r\n\r\n  if (!user || !profile) return null\r\n\r\n  // Determine Role\r\n  const role = profile.role || 'viewer' // viewer, broadcaster, admin, officer, vip\r\n\r\n  const isActive = (path: string) => {\r\n    if (path === '/') {\r\n      return location.pathname === '/' || location.pathname === '/live'\r\n    }\r\n    return location.pathname.startsWith(path)\r\n  }\r\n\r\n  // Define Center Button based on Role\r\n  const getCenterButton = () => {\r\n    switch (role as string) {\r\n      case 'admin':\r\n        return { label: 'Admin Panel', icon: Shield, action: () => setIsMenuOpen(true) }\r\n      case 'broadcaster':\r\n        return { label: 'Go Live', icon: Video, action: () => setIsMenuOpen(true) }\r\n      case 'officer':\r\n        return { label: 'Moderation', icon: Gavel, action: () => setIsMenuOpen(true) }\r\n      case 'vip':\r\n        return { label: 'Talent Tools', icon: Star, action: () => setIsMenuOpen(true) }\r\n      default: // viewer\r\n        return { label: 'Explore Live', icon: Zap, action: () => setIsMenuOpen(true) }\r\n    }\r\n  }\r\n\r\n  const centerBtn = getCenterButton()\r\n\r\n  // Re-ordering to match: Home, Live, CENTER, Inbox, Profile\r\n  const orderedItems: any[] = [\r\n    { icon: Home, label: 'Home', path: '/', active: isActive('/') && location.pathname !== '/live' },\r\n    { \r\n      icon: Video, \r\n      label: 'Live', \r\n      path: '/live',\r\n      action: () => setIsLiveMenuOpen(true), \r\n      active: isActive('/live') || isLiveMenuOpen \r\n    },\r\n    { isCenter: true, ...centerBtn },\r\n    { icon: MessageSquare, label: 'TCPS', path: '/tcps', active: isActive('/tcps') },\r\n    { icon: User, label: 'Profile', path: `/profile/${profile?.username || profile?.id}`, active: isActive('/profile') }\r\n  ]\r\n\r\n  // Popup Menu Options\r\n  const getMenuOptions = () => {\r\n    switch (role as string) {\r\n      case 'broadcaster':\r\n        return [\r\n          { category: 'Streaming', label: 'Start Stream', icon: Video, path: '/go-live' },\r\n          { category: 'Streaming', label: 'Summary', icon: FileText, path: '/broadcast-summary' },\r\n          { category: 'Finance', label: 'My Earnings', icon: DollarSign, path: '/earnings' },\r\n          { category: 'Community', label: 'My Guests', icon: Users, path: '/guests' }\r\n        ]\r\n      case 'admin':\r\n        return [\r\n          { category: 'Management', label: 'Court', icon: Gavel, path: '/troll-court' },\r\n          { category: 'Management', label: 'Ban User', icon: Ban, path: '/admin/bans' },\r\n          { category: 'Content', label: 'Applications', icon: FileText, path: '/admin/applications' },\r\n          { category: 'Content', label: 'Marketplace', icon: ShoppingBag, path: '/admin/marketplace' },\r\n          { category: 'Content', label: 'Reports', icon: Shield, path: '/admin/officer-reports' },\r\n          { category: 'Finance', label: 'Earnings', icon: DollarSign, path: '/admin/earnings' },\r\n          { category: 'System', label: 'System Tools', icon: Settings, path: '/admin/dashboard' }\r\n        ]\r\n      case 'officer':\r\n        return [\r\n          { category: 'Moderation', label: 'Mute User', icon: MicOffIcon, path: '/officer/mute' },\r\n          { category: 'Moderation', label: 'Kick User', icon: AlertTriangle, path: '/officer/kick' },\r\n          { category: 'Moderation', label: 'Report', icon: Shield, path: '/officer/reports' },\r\n          { category: 'Lounge', label: 'Officer Lounge', icon: Briefcase, path: '/officer/lounge' },\r\n          { category: 'Finance', label: 'Payroll', icon: Banknote, path: '/officer/payroll' }\r\n        ]\r\n      case 'viewer':\r\n      default:\r\n        return [\r\n          { category: 'General', label: 'Go Live', icon: Video, path: '/go-live' },\r\n          { category: 'General', label: 'Buy Coins', icon: Store, path: '/store' },\r\n          { category: 'Creative', label: 'Troll Pods', icon: Mic, path: '/pods' },\r\n          { category: 'General', label: 'Support', icon: Heart, path: '/support' }\r\n        ]\r\n    }\r\n  }\r\n\r\n  // Helper for icons not in top import\r\n  const MicOffIcon = ({ size, className }: { size: number, className?: string }) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width={size} height={size} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className={className}><line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"></line><path d=\"M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6\"></path><path d=\"M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23\"></path><line x1=\"12\" y1=\"19\" x2=\"12\" y2=\"23\"></line><line x1=\"8\" y1=\"23\" x2=\"16\" y2=\"23\"></line></svg>\r\n  )\r\n\r\n  const menuOptions = getMenuOptions()\r\n\r\n  return (\r\n    <>\r\n      <nav className=\"bottom-nav bg-[#0D0D0D] border-t border-purple-700/30\">\r\n        <div className=\"bottom-nav-inner flex items-center justify-around px-0\">\r\n          {orderedItems.map((item: any, idx) => {\r\n            const Icon = item.icon\r\n            \r\n            if (item.isCenter) {\r\n               return (\r\n                 <button\r\n                   key=\"center-btn\"\r\n                   onClick={item.action}\r\n                   className=\"flex flex-col items-center justify-center w-1/5 h-full -mt-4\"\r\n                 >\r\n                   <div className=\"w-14 h-14 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 p-[2px] shadow-[0_0_15px_rgba(124,58,237,0.5)]\">\r\n                     <div className=\"w-full h-full rounded-full bg-[#0D0D0D] flex items-center justify-center hover:bg-[#1a1a1a] transition-colors\">\r\n                       <Icon size={24} className=\"text-white\" />\r\n                     </div>\r\n                   </div>\r\n                   <span className=\"text-[10px] font-bold mt-1 text-purple-400\">{item.label}</span>\r\n                 </button>\r\n               )\r\n            }\r\n\r\n            if (item.action) {\r\n               return (\r\n                 <button\r\n                   key={idx}\r\n                   onClick={item.action}\r\n                   className={`flex flex-col items-center justify-center w-1/5 h-full transition-all active:scale-95 active:opacity-80 ${\r\n                     item.active\r\n                       ? 'text-troll-gold'\r\n                       : 'text-gray-400 hover:text-gray-200'\r\n                   }`}\r\n                 >\r\n                   <Icon size={24} className=\"mb-1\" />\r\n                   <span className=\"text-[10px] font-medium truncate\">{item.label}</span>\r\n                 </button>\r\n               )\r\n            }\r\n\r\n            return (\r\n              <button\r\n                key={idx}\r\n                onClick={() => navigate(item.path!)}\r\n                className={`flex flex-col items-center justify-center w-1/5 h-full transition-all active:scale-95 active:opacity-80 ${\r\n                  item.active\r\n                    ? 'text-troll-gold'\r\n                    : 'text-gray-400 hover:text-gray-200'\r\n                }`}\r\n              >\r\n                <Icon size={24} className=\"mb-1\" />\r\n                <span className=\"text-[10px] font-medium truncate\">{item.label}</span>\r\n              </button>\r\n            )\r\n          })}\r\n        </div>\r\n      </nav>\r\n\r\n      {/* Role Action Popup */}\r\n      <AnimatePresence>\r\n        {isLiveMenuOpen && (\r\n          <>\r\n            <motion.div\r\n              initial={{ opacity: 0 }}\r\n              animate={{ opacity: 1 }}\r\n              exit={{ opacity: 0 }}\r\n              onClick={() => setIsLiveMenuOpen(false)}\r\n              className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60]\"\r\n            />\r\n            \r\n            <motion.div\r\n              initial={{ y: '100%' }}\r\n              animate={{ y: 0 }}\r\n              exit={{ y: '100%' }}\r\n              transition={{ type: 'spring', damping: 25, stiffness: 300 }}\r\n              className=\"fixed bottom-0 left-0 right-0 bg-[#121212] border-t border-purple-500/30 rounded-t-3xl p-6 z-[70] safe-area-bottom\"\r\n            >\r\n              <div className=\"w-12 h-1 bg-gray-700 rounded-full mx-auto mb-6\" />\r\n              \r\n              <div className=\"flex items-center justify-between mb-6\">\r\n                <h3 className=\"text-lg font-bold text-white\">Live Categories</h3>\r\n                <button\r\n                  onClick={() => setIsLiveMenuOpen(false)}\r\n                  className=\"p-2 text-gray-400 hover:text-white\"\r\n                >\r\n                  <Ban size={20} />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                {liveCategories.map((cat, i) => {\r\n                  const CatIcon = cat.icon\r\n                  return (\r\n                    <Link\r\n                      key={i}\r\n                      to={cat.path}\r\n                      onClick={() => setIsLiveMenuOpen(false)}\r\n                      className=\"flex flex-col items-center justify-center p-4 bg-white/5 hover:bg-white/10 rounded-xl border border-white/5 transition-colors gap-2\"\r\n                    >\r\n                      <div className=\"p-3 rounded-full bg-purple-500/20 text-purple-400\">\r\n                        <CatIcon size={24} />\r\n                      </div>\r\n                      <span className=\"text-white font-medium text-sm\">{cat.label}</span>\r\n                    </Link>\r\n                  )\r\n                })}\r\n              </div>\r\n            </motion.div>\r\n          </>\r\n        )}\r\n      </AnimatePresence>\r\n\r\n      <AnimatePresence>\r\n        {isMenuOpen && (\r\n          <>\r\n            {/* Backdrop */}\r\n            <motion.div\r\n              initial={{ opacity: 0 }}\r\n              animate={{ opacity: 1 }}\r\n              exit={{ opacity: 0 }}\r\n              onClick={() => setIsMenuOpen(false)}\r\n              className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60]\"\r\n            />\r\n            \r\n            {/* Menu */}\r\n            <motion.div\r\n              initial={{ y: '100%' }}\r\n              animate={{ y: 0 }}\r\n              exit={{ y: '100%' }}\r\n              transition={{ type: 'spring', damping: 25, stiffness: 300 }}\r\n              className=\"fixed bottom-0 left-0 right-0 bg-[#121212] border-t border-purple-500/30 rounded-t-3xl p-6 z-[70] safe-area-bottom\"\r\n            >\r\n              <div className=\"w-12 h-1 bg-gray-700 rounded-full mx-auto mb-6\" />\r\n              \r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <h3 className=\"text-lg font-bold text-white text-center flex-1\">\r\n                  {centerBtn.label} Actions\r\n                </h3>\r\n                <button\r\n                  onClick={handleLogout}\r\n                  className=\"p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-full transition-colors\"\r\n                  title=\"Logout\"\r\n                >\r\n                  <LogOut size={20} />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-6 max-h-[60vh] overflow-y-auto pr-2\">\r\n                {Object.entries(\r\n                  menuOptions.reduce((acc: any, opt: any) => {\r\n                    const cat = opt.category || 'General'\r\n                    if (!acc[cat]) acc[cat] = []\r\n                    acc[cat].push(opt)\r\n                    return acc\r\n                  }, {})\r\n                ).map(([category, options]: [string, any]) => (\r\n                  <div key={category}>\r\n                    <h4 className=\"text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 px-1\">{category}</h4>\r\n                    <div className=\"grid grid-cols-1 gap-2\">\r\n                      {options.map((opt: any, i: number) => {\r\n                        const OptIcon = opt.icon\r\n                        return (\r\n                          <Link\r\n                            key={i}\r\n                            to={opt.path}\r\n                            onClick={() => setIsMenuOpen(false)}\r\n                            className=\"flex items-center gap-4 p-3 bg-white/5 hover:bg-white/10 rounded-xl border border-white/5 transition-colors\"\r\n                          >\r\n                            <div className=\"p-2 rounded-lg bg-purple-500/20 text-purple-400\">\r\n                              <OptIcon size={18} />\r\n                            </div>\r\n                            <span className=\"text-white font-medium text-sm\">{opt.label}</span>\r\n                          </Link>\r\n                        )\r\n                      })}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </motion.div>\r\n          </>\r\n        )}\r\n      </AnimatePresence>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\BroadcastAnnouncement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CarUpgradesModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":36,"column":6,"nodeType":"ArrayExpression","endLine":36,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [loadData, userCarId]","fix":{"range":[1016,1027],"text":"[loadData, userCarId]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":75,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getUpgradeIcon' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":93,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":93,"endColumn":23},{"ruleId":"react/jsx-no-undef","severity":2,"message":"'Settings' is not defined.","line":96,"column":36,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":96,"endColumn":44},{"ruleId":"react/jsx-no-undef","severity":2,"message":"'Zap' is not defined.","line":99,"column":29,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":99,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ZapIcon' is defined but never used. Allowed unused vars must match /^_/u.","line":195,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":195,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SettingsIcon' is defined but never used. Allowed unused vars must match /^_/u.","line":214,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":214,"endColumn":22}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { X, Wrench, ArrowUp, Coins, AlertCircle } from 'lucide-react';\nimport { supabase } from '../lib/supabase';\nimport { toast } from 'sonner';\n\ninterface CarUpgradesModalProps {\n  userCarId: string;\n  onClose: () => void;\n  onUpdate: () => void;\n}\n\ninterface Upgrade {\n  id: string;\n  name: string;\n  type: string; // 'engine', 'transmission', 'tires', 'body', 'nitro'\n  cost: number;\n  value_increase_amount: number;\n  description: string;\n  tier: number;\n}\n\ninterface UserUpgrade {\n  id: string;\n  upgrade_id: string;\n  upgrade: Upgrade;\n}\n\nexport default function CarUpgradesModal({ userCarId, onClose, onUpdate }: CarUpgradesModalProps) {\n  const [availableUpgrades, setAvailableUpgrades] = useState<Upgrade[]>([]);\n  const [installedUpgrades, setInstalledUpgrades] = useState<UserUpgrade[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [purchasing, setPurchasing] = useState<string | null>(null);\n\n  useEffect(() => {\n    loadData();\n  }, [userCarId]);\n\n  const loadData = async () => {\n    setLoading(true);\n    try {\n      // Fetch all available upgrades\n      const { data: upgradesData, error: upgradesError } = await supabase\n        .from('car_upgrades')\n        .select('*')\n        .order('cost', { ascending: true });\n\n      if (upgradesError) throw upgradesError;\n\n      // Fetch installed upgrades for this car\n      const { data: installedData, error: installedError } = await supabase\n        .from('user_car_upgrades')\n        .select('*, upgrade:car_upgrades(*)')\n        .eq('user_car_id', userCarId);\n\n      if (installedError) throw installedError;\n\n      setAvailableUpgrades(upgradesData || []);\n      setInstalledUpgrades(installedData || []);\n    } catch (error) {\n      console.error('Error loading upgrades:', error);\n      toast.error('Failed to load upgrades');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handlePurchase = async (upgrade: Upgrade) => {\n    // Check if already installed (or higher tier installed?)\n    // For simplicity, just check if this specific upgrade is installed\n    const isInstalled = installedUpgrades.some(u => u.upgrade_id === upgrade.id);\n    if (isInstalled) return;\n\n    setPurchasing(upgrade.id);\n    try {\n      const { data, error } = await supabase.rpc('apply_car_upgrade', {\n        p_user_car_id: userCarId,\n        p_upgrade_id: upgrade.id\n      });\n\n      if (error) throw error;\n\n      toast.success(`Purchased ${upgrade.name}!`);\n      await loadData();\n      onUpdate(); // Refresh parent to update value\n    } catch (error: any) {\n      console.error('Purchase failed:', error);\n      toast.error(error.message || 'Failed to purchase upgrade');\n    } finally {\n      setPurchasing(null);\n    }\n  };\n\n  const getUpgradeIcon = (type: string) => {\n    switch (type) {\n      case 'engine': return <Wrench className=\"w-5 h-5 text-red-400\" />;\n      case 'transmission': return <Settings className=\"w-5 h-5 text-blue-400\" />;\n      case 'tires': return <div className=\"w-5 h-5 rounded-full border-4 border-zinc-400\" />;\n      case 'body': return <div className=\"w-5 h-5 bg-zinc-400 rounded\" />;\n      case 'nitro': return <Zap className=\"w-5 h-5 text-yellow-400\" />;\n      default: return <Wrench className=\"w-5 h-5 text-gray-400\" />;\n    }\n  };\n\n  const categories = ['engine', 'transmission', 'tires', 'body', 'nitro'];\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm\">\n      <div className=\"bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl\">\n        <div className=\"p-4 border-b border-zinc-800 flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Wrench className=\"w-6 h-6 text-emerald-400\" />\n            <h2 className=\"text-xl font-bold text-white\">Car Upgrades</h2>\n          </div>\n          <button onClick={onClose} className=\"p-2 hover:bg-zinc-800 rounded-lg transition-colors\">\n            <X className=\"w-5 h-5 text-zinc-400\" />\n          </button>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-4 space-y-6\">\n          {loading ? (\n            <div className=\"flex items-center justify-center py-10\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500\" />\n            </div>\n          ) : (\n            categories.map(category => {\n              const categoryUpgrades = availableUpgrades.filter(u => u.type === category);\n              if (categoryUpgrades.length === 0) return null;\n\n              return (\n                <div key={category} className=\"space-y-3\">\n                  <h3 className=\"text-sm font-bold uppercase text-zinc-500 tracking-wider flex items-center gap-2\">\n                    {category}\n                  </h3>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    {categoryUpgrades.map(upgrade => {\n                      const isInstalled = installedUpgrades.some(u => u.upgrade_id === upgrade.id);\n                      // Check if a better upgrade of same type is installed? \n                      // For now, allow mixing if the logic permits, but usually it's one per type.\n                      // The UI will just show list.\n                      \n                      return (\n                        <div key={upgrade.id} className={`p-3 rounded-xl border ${isInstalled ? 'bg-emerald-900/10 border-emerald-500/50' : 'bg-zinc-800/50 border-zinc-700'} flex flex-col gap-2 transition-all hover:border-zinc-600`}>\n                          <div className=\"flex items-start justify-between\">\n                            <div>\n                              <h4 className={`font-bold ${isInstalled ? 'text-emerald-400' : 'text-white'}`}>{upgrade.name}</h4>\n                              <p className=\"text-xs text-zinc-400\">{upgrade.description}</p>\n                            </div>\n                            {isInstalled && <div className=\"bg-emerald-500/20 text-emerald-400 text-[10px] px-2 py-0.5 rounded uppercase font-bold\">Installed</div>}\n                          </div>\n                          \n                          <div className=\"mt-2 flex items-center justify-between\">\n                             <div className=\"text-xs text-emerald-400 flex items-center gap-1\">\n                               <ArrowUp className=\"w-3 h-3\" />\n                               Value +{upgrade.value_increase_amount.toLocaleString()}\n                             </div>\n                             \n                             {!isInstalled && (\n                               <button\n                                 onClick={() => handlePurchase(upgrade)}\n                                 disabled={purchasing === upgrade.id}\n                                 className=\"px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed\"\n                               >\n                                 {purchasing === upgrade.id ? (\n                                   <div className=\"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                                 ) : (\n                                   <>\n                                     <Coins className=\"w-3 h-3\" />\n                                     {upgrade.cost.toLocaleString()}\n                                   </>\n                                 )}\n                               </button>\n                             )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              );\n            })\n          )}\n          \n          {!loading && availableUpgrades.length === 0 && (\n             <div className=\"text-center py-10 text-zinc-500\">\n               <AlertCircle className=\"w-10 h-10 mx-auto mb-2 opacity-50\" />\n               <p>No upgrades available at the moment.</p>\n             </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ZapIcon(props: any) {\n  return (\n    <svg\n      {...props}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      width=\"24\"\n      height=\"24\"\n      viewBox=\"0 0 24 24\"\n      fill=\"none\"\n      stroke=\"currentColor\"\n      strokeWidth=\"2\"\n      strokeLinecap=\"round\"\n      strokeLinejoin=\"round\"\n    >\n      <polygon points=\"13 2 3 14 12 14 11 22 21 10 12 10 13 2\" />\n    </svg>\n  )\n}\n\nfunction SettingsIcon(props: any) {\n    return (\n      <svg\n        {...props}\n        xmlns=\"http://www.w3.org/2000/svg\"\n        width=\"24\"\n        height=\"24\"\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n      >\n        <path d=\"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z\" />\n        <circle cx=\"12\" cy=\"12\" r=\"3\" />\n      </svg>\n    )\n  }\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ChatBubble.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MessageSquare' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MessageSquare"},"fix":{"range":[82,97],"text":""},"desc":"Remove unused variable \"MessageSquare\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toggleChatBubble' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":25,"column":84,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":100},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setIsTyping' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":32,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'typingTimeoutRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":33,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'channelRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":34,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setActiveSoundUrl' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":43},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'activeSoundUrl', 'profile?.avatar_url', 'profile?.rgb_username_expires_at', and 'profile?.username'. Either include them or remove the dependency array.","line":223,"column":6,"nodeType":"ArrayExpression","endLine":223,"endColumn":101,"suggestions":[{"desc":"Update the dependencies array to be: [actualConversationId, profile?.id, isOpen, user?.id, scrollToBottom, fetchMessagesWithSenders, profile?.username, profile?.avatar_url, profile?.rgb_username_expires_at, activeSoundUrl]","fix":{"range":[7629,7724],"text":"[actualConversationId, profile?.id, isOpen, user?.id, scrollToBottom, fetchMessagesWithSenders, profile?.username, profile?.avatar_url, profile?.rgb_username_expires_at, activeSoundUrl]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":255,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":255,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isTyping' is defined but never used. Allowed unused args must match /^_/u.","line":290,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":290,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState, useCallback } from 'react'\nimport { X, Minus, MessageSquare, Check, CheckCheck } from 'lucide-react'\nimport { supabase, createConversation, getConversationMessages, markConversationRead } from '../lib/supabase'\nimport { useAuthStore } from '../lib/store'\nimport { useChatStore } from '../lib/chatStore'\nimport ClickableUsername from './ClickableUsername'\nimport MessageInput from '../pages/tcps/components/MessageInput'\nimport { toast } from 'sonner'\n\ninterface Message {\n  id: string\n  conversation_id: string\n  sender_id: string\n  content: string\n  created_at: string\n  read_at?: string | null\n  sender_username?: string\n  sender_avatar_url?: string | null\n  sender_rgb_expires_at?: string | null\n  isPending?: boolean\n}\n\nexport default function ChatBubble() {\n  const { user, profile } = useAuthStore()\n  const { isOpen, activeUserId, activeUsername, activeUserAvatar, closeChatBubble, toggleChatBubble } = useChatStore()\n  \n  const messagesContainerRef = useRef<HTMLDivElement>(null)\n  const [messages, setMessages] = useState<Message[]>([])\n  const [loading, setLoading] = useState(false)\n  const [actualConversationId, setActualConversationId] = useState<string | null>(null)\n  const [isMinimized, setIsMinimized] = useState(false)\n  const [isTyping, setIsTyping] = useState(false)\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null)\n  const channelRef = useRef<any>(null)\n  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null)\n\n  // Audio ref for message sounds\n  const audioRef = useRef<HTMLAudioElement | null>(null)\n  const [activeSoundUrl, setActiveSoundUrl] = useState<string | null>(null)\n\n  // Initialize conversation when bubble opens\n  useEffect(() => {\n    if (!isOpen || !user?.id || !activeUserId) return\n\n    const initChat = async () => {\n      // Try to find existing conversation\n      const { data: existingConvs } = await supabase\n        .from('conversation_members')\n        .select('conversation_id')\n        .eq('user_id', user.id)\n\n      let targetConvId: string | null = null\n\n      if (existingConvs) {\n         const myConvIds = existingConvs.map(c => c.conversation_id)\n         // Check if other user is in any of these\n         const { data: shared } = await supabase\n           .from('conversation_members')\n           .select('conversation_id')\n           .in('conversation_id', myConvIds)\n           .eq('user_id', activeUserId)\n           .maybeSingle()\n         \n         if (shared) {\n           targetConvId = shared.conversation_id\n         } else {\n           // Create new conversation\n           try {\n              const newConv = await createConversation([activeUserId])\n              targetConvId = newConv.id\n           } catch (err) {\n              console.error('Failed to create conversation', err)\n              toast.error('Failed to start chat')\n              return\n           }\n         }\n      }\n\n      setActualConversationId(targetConvId)\n    }\n\n    initChat()\n  }, [isOpen, activeUserId, user?.id])\n\n  const scrollToBottom = useCallback(() => {\n    if (messagesContainerRef.current) {\n      messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight\n    }\n  }, [])\n\n  // Fetch messages and sender info\n  const fetchMessagesWithSenders = useCallback(async (convId: string) => {\n    const messagesData = await getConversationMessages(convId, { limit: 50 })\n    \n    // Enhance with sender info\n    const senderIds = [...new Set(messagesData.map(m => m.sender_id))]\n    const senderMap: Record<string, any> = {}\n    \n    if (senderIds.length > 0) {\n      const { data: usersData } = await supabase\n        .from('user_profiles')\n        .select('id,username,avatar_url,rgb_username_expires_at')\n        .in('id', senderIds)\n      \n      usersData?.forEach(u => {\n        senderMap[u.id] = u\n      })\n    }\n\n    return messagesData.map(m => ({\n      id: m.id,\n      conversation_id: m.conversation_id,\n      sender_id: m.sender_id,\n      content: m.body,\n      created_at: m.created_at,\n      read_at: m.read_at,\n      sender_username: senderMap[m.sender_id]?.username,\n      sender_avatar_url: senderMap[m.sender_id]?.avatar_url,\n      sender_rgb_expires_at: senderMap[m.sender_id]?.rgb_username_expires_at\n    })).reverse()\n  }, [])\n\n  // Load messages\n  useEffect(() => {\n    if (!actualConversationId || !profile?.id || !isOpen) return\n\n    const loadMessages = async () => {\n      setLoading(true)\n      try {\n        const mappedMessages = await fetchMessagesWithSenders(actualConversationId)\n        setMessages(mappedMessages)\n        \n        // Mark as read\n        await markConversationRead(actualConversationId)\n        \n        setTimeout(scrollToBottom, 100)\n\n      } catch (error) {\n        console.error('Error loading messages:', error)\n      } finally {\n        setLoading(false)\n      }\n    }\n\n    loadMessages()\n\n    // Subscribe to new messages\n    const channel = supabase\n      .channel(`chat-bubble:${actualConversationId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'conversation_messages',\n          filter: `conversation_id=eq.${actualConversationId}`\n        },\n        async (payload) => {\n          const newMsgRaw = payload.new\n          // Fetch sender info\n          let senderInfo = {\n             username: 'Unknown',\n             avatar_url: null,\n             rgb_username_expires_at: null\n          }\n          \n          if (newMsgRaw.sender_id === user?.id) {\n             senderInfo = {\n               username: profile?.username || 'You',\n               avatar_url: profile?.avatar_url || null,\n               rgb_username_expires_at: profile?.rgb_username_expires_at || null\n             }\n          } else {\n             const { data } = await supabase.from('user_profiles').select('username,avatar_url,rgb_username_expires_at').eq('id', newMsgRaw.sender_id).single()\n             if (data) senderInfo = data as any\n          }\n\n          const newMsg: Message = {\n            id: newMsgRaw.id,\n            conversation_id: newMsgRaw.conversation_id,\n            sender_id: newMsgRaw.sender_id,\n            content: newMsgRaw.body,\n            created_at: newMsgRaw.created_at,\n            read_at: newMsgRaw.read_at,\n            sender_username: senderInfo.username,\n            sender_avatar_url: senderInfo.avatar_url,\n            sender_rgb_expires_at: senderInfo.rgb_username_expires_at\n          }\n\n          setMessages(prev => {\n            // Remove any pending message that matches (by comparing content and sender)\n            const withoutPending = prev.filter(msg => {\n              if (msg.isPending && msg.sender_id === user?.id && msg.content === newMsg.content) {\n                return false\n              }\n              return true\n            })\n            return [...withoutPending, newMsg]\n          })\n          \n          if (newMsg.sender_id !== user?.id) {\n            await markConversationRead(actualConversationId)\n            // Play sound\n            if (audioRef.current) {\n              if (activeSoundUrl) {\n                audioRef.current.src = activeSoundUrl\n              } else {\n                 // Default sound if none equipped (using a known file)\n                 audioRef.current.src = '/sounds/pop.mp3'\n              }\n              // Simple play attempt\n              audioRef.current.play().catch(e => console.log('Audio play blocked:', e))\n            }\n          }\n          setTimeout(scrollToBottom, 100)\n        }\n      )\n      .subscribe()\n\n    return () => {\n      supabase.removeChannel(channel)\n    }\n  }, [actualConversationId, profile?.id, isOpen, user?.id, scrollToBottom, fetchMessagesWithSenders])\n\n  // Poll for new messages and read status updates every second\n  useEffect(() => {\n    if (!actualConversationId || !isOpen) return\n\n    const pollMessages = async () => {\n      try {\n        const mappedMessages = await fetchMessagesWithSenders(actualConversationId)\n        \n        setMessages(prev => {\n          const prevIds = new Set(prev.map(m => m.id))\n          \n          // Check if there are new messages\n          const hasNewMessages = mappedMessages.some(m => !prevIds.has(m.id))\n          if (hasNewMessages) {\n            return mappedMessages\n          }\n          \n          // Check for read status updates on existing messages\n          const hasReadUpdate = mappedMessages.some((m, idx) => {\n            if (idx < prev.length) {\n              return prev[idx].read_at !== m.read_at\n            }\n            return false\n          })\n          if (hasReadUpdate) {\n            return mappedMessages\n          }\n          \n          return prev\n        })\n      } catch (error) {\n        // Silent fail for polling\n      }\n    }\n\n    // Initial poll\n    pollMessages()\n\n    // Poll every second\n    pollIntervalRef.current = setInterval(pollMessages, 1000)\n\n    return () => {\n      if (pollIntervalRef.current) {\n        clearInterval(pollIntervalRef.current)\n      }\n    }\n  }, [actualConversationId, isOpen, fetchMessagesWithSenders])\n\n  const handleLocalNewMessage = (newMsg: any) => {\n    // Add message as pending with sender info\n    const pendingMsg: Message = {\n      id: `temp-${Date.now()}`,\n      conversation_id: actualConversationId || '',\n      sender_id: user?.id || '',\n      content: newMsg.content || newMsg.body,\n      created_at: new Date().toISOString(),\n      sender_username: profile?.username,\n      sender_avatar_url: profile?.avatar_url,\n      sender_rgb_expires_at: profile?.rgb_username_expires_at,\n      isPending: true\n    }\n    setMessages(prev => [...prev, pendingMsg])\n    scrollToBottom()\n  }\n\n  const handleLocalTyping = (isTyping: boolean) => {\n    // Optional: handle local typing indication if needed\n  }\n\n  if (!isOpen) return null\n\n  if (isMinimized) {\n    return (\n      <div className=\"fixed bottom-4 right-4 z-50\">\n        <button\n          onClick={() => setIsMinimized(false)}\n          className=\"bg-purple-600 hover:bg-purple-500 text-white p-3 rounded-full shadow-lg shadow-purple-900/50 flex items-center justify-center transition-all hover:scale-105\"\n        >\n          <div className=\"relative\">\n            <img \n              src={activeUserAvatar || `https://ui-avatars.com/api/?name=${activeUsername}&background=random`}\n              alt={activeUsername || ''}\n              className=\"w-10 h-10 rounded-full border-2 border-white/20\"\n            />\n            <div className=\"absolute -bottom-1 -right-1 bg-green-500 w-3 h-3 rounded-full border-2 border-purple-600\" />\n          </div>\n        </button>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"fixed bottom-0 right-4 w-80 h-[500px] bg-[#14141F] border border-purple-500/20 rounded-t-xl shadow-2xl flex flex-col z-50 animate-in slide-in-from-bottom-10 duration-200\">\n      <audio ref={audioRef} className=\"hidden\" />\n      \n      {/* Header */}\n      <div className=\"bg-[#1F1F2E] p-3 flex items-center justify-between border-b border-purple-500/20 shrink-0\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"relative\">\n             <img \n              src={activeUserAvatar || `https://ui-avatars.com/api/?name=${activeUsername}&background=random`}\n              alt={activeUsername || ''}\n              className=\"w-8 h-8 rounded-full border border-purple-500/20\"\n            />\n            <div className=\"absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-[#1F1F2E]\" />\n          </div>\n          <div>\n            {activeUsername && (\n              <ClickableUsername \n                username={activeUsername} \n                className=\"font-bold text-white hover:text-purple-400 transition-colors text-sm\"\n              />\n            )}\n            <div className=\"text-[10px] text-green-400 flex items-center gap-1\">\n              <span className=\"w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse\" />\n              Online\n            </div>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <button \n            onClick={() => setIsMinimized(true)}\n            className=\"p-1.5 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors\"\n          >\n            <Minus className=\"w-4 h-4\" />\n          </button>\n          <button \n            onClick={closeChatBubble}\n            className=\"p-1.5 hover:bg-red-500/20 rounded-lg text-gray-400 hover:text-red-400 transition-colors\"\n          >\n            <X className=\"w-4 h-4\" />\n          </button>\n        </div>\n      </div>\n\n      {/* Messages */}\n      <div \n        ref={messagesContainerRef}\n        className=\"flex-1 overflow-y-auto p-4 space-y-4 bg-[#0F0F1A] no-scrollbar\"\n      >\n        {loading ? (\n          <div className=\"flex justify-center py-8\">\n            <div className=\"w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin\" />\n          </div>\n        ) : messages.length === 0 ? (\n          <div className=\"text-center text-gray-500 text-sm mt-8\">\n            Start a conversation with {activeUsername}\n          </div>\n        ) : (\n          messages.map((msg) => {\n            const isMe = msg.sender_id === user?.id\n            return (\n              <div \n                key={msg.id} \n                className={`flex gap-3 ${isMe ? 'flex-row-reverse' : ''}`}\n              >\n                {!isMe && (\n                   <img \n                    src={msg.sender_avatar_url || `https://ui-avatars.com/api/?name=${msg.sender_username}&background=random`}\n                    alt={msg.sender_username}\n                    className={`w-8 h-8 rounded-full border border-purple-500/20 flex-shrink-0 ${msg.isPending ? 'opacity-50' : ''}`}\n                  />\n                )}\n                \n                <div className={`max-w-[75%] space-y-1 ${isMe ? 'items-end' : 'items-start'} flex flex-col`}>\n                  <div className=\"flex items-center gap-2\">\n                    {!isMe && msg.sender_username && (\n                       <ClickableUsername \n                         username={msg.sender_username}\n                         className=\"text-xs font-bold text-gray-400 hover:text-purple-400\"\n                         profile={{ rgb_username_expires_at: msg.sender_rgb_expires_at || undefined }}\n                       />\n                    )}\n                    <span className=\"text-[10px] text-gray-600\">\n                      {new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                    </span>\n                  </div>\n                  \n                  <div className={`p-3 rounded-2xl text-sm ${\n                    isMe \n                      ? 'bg-purple-600 text-white rounded-tr-none' \n                      : 'bg-[#1F1F2E] text-gray-200 rounded-tl-none border border-purple-500/10'\n                  } ${msg.isPending ? 'opacity-70' : ''}`}>\n                    {msg.content}\n                  </div>\n                  \n                  {/* Read status for own messages */}\n                  {isMe && (\n                    <div className=\"flex items-center gap-1 justify-end\">\n                      {msg.read_at ? (\n                        <CheckCheck className=\"w-3 h-3 text-purple-400\" />\n                      ) : (\n                        <Check className={`w-3 h-3 ${msg.isPending ? 'text-gray-600' : 'text-gray-400'}`} />\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            )\n          })\n        )}\n        \n        {isTyping && (\n          <div className=\"flex items-center gap-2 p-2 text-gray-400 text-xs\">\n            <div className=\"flex gap-1\">\n              <span className=\"animate-bounce delay-0\">.</span>\n              <span className=\"animate-bounce delay-100\">.</span>\n              <span className=\"animate-bounce delay-200\">.</span>\n            </div>\n            <span>{activeUsername} is typing</span>\n          </div>\n        )}\n      </div>\n\n      {/* Input */}\n        <div className=\"p-3 border-t border-[#2C2C2C] bg-[#1A1A1A]\">\n          {actualConversationId && activeUserId && (\n            <MessageInput \n              conversationId={actualConversationId}\n              otherUserId={activeUserId}\n              onMessageSent={scrollToBottom}\n              onNewMessage={handleLocalNewMessage}\n              onTyping={handleLocalTyping}\n            />\n          )}\n        </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ClickableUsername.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ClickableUsernameWithReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtAIAssistant.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtAIController.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtChat.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtDocketDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'softDeleteDocket' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":71,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":71,"endColumn":25},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":292,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11326,11327],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11326,11327],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11326,11327],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11326,11327],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":292,"column":79,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11340,11341],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11340,11341],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11340,11341],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11340,11341],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { Clock, CheckCircle, XCircle, AlertTriangle, Gavel, FileText, Trash2 } from 'lucide-react';\r\nimport ClickableUsername from './ClickableUsername';\r\n\r\ninterface DocketEntry {\r\n  id: string;\r\n  user_id: string;\r\n  username: string;\r\n  case_type: string;\r\n  scheduled_at: string;\r\n  status: string;\r\n  assigned_officer: string | null;\r\n  officer_username: string | null;\r\n  notes: string | null;\r\n  court_session_id: string | null;\r\n}\r\n\r\nconst CourtDocketDashboard: React.FC = (): JSX.Element => {\r\n  const { profile } = useAuthStore();\r\n  const [docketEntries, setDocketEntries] = useState<DocketEntry[]>([]);\r\n  const [profiles, setProfiles] = useState<Record<string, any>>({});\r\n  const [loading, setLoading] = useState(true);\r\n  const [filter, setFilter] = useState<'all' | 'scheduled' | 'in_session' | 'completed' | 'missed'>('all');\r\n\r\n  useEffect(() => {\r\n    loadAllDocketEntries();\r\n  }, []);\r\n\r\n  const loadAllDocketEntries = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const { data, error } = await supabase.rpc('get_all_docket_entries');\r\n\r\n      if (error) throw error;\r\n      setDocketEntries(data || []);\r\n\r\n      // Fetch profiles for RGB\r\n      const userIds = (data || []).map((e: any) => e.user_id).filter(Boolean);\r\n      const officerIds = (data || []).map((e: any) => e.assigned_officer).filter((id: any) => id && typeof id === 'string' && id.length > 10); // Simple check for UUID-like\r\n      const allIds = Array.from(new Set([...userIds, ...officerIds]));\r\n\r\n      if (allIds.length > 0) {\r\n        const { data: profileData } = await supabase\r\n          .from('profiles')\r\n          .select('id, username, role, is_admin, is_troll_officer, is_troller, is_verified, rgb_username_expires_at')\r\n          .in('id', allIds);\r\n        \r\n        const profileMap: Record<string, any> = {};\r\n        profileData?.forEach(p => profileMap[p.id] = p);\r\n        setProfiles(profileMap);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading docket entries:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const updateDocketStatus = async (docketId: string, newStatus: string, notes?: string) => {\r\n    try {\r\n      const updateData: any = { status: newStatus, updated_at: new Date().toISOString() };\r\n      if (notes) updateData.notes = notes;\r\n\r\n      const { error } = await supabase\r\n        .from('court_docket')\r\n        .update(updateData)\r\n        .eq('id', docketId);\r\n  // Soft delete function\r\n  const softDeleteDocket = async (docketId: string) => {\r\n    if (!confirm('Are you sure you want to delete this docket entry?')) return;\r\n    await updateDocketStatus(docketId, 'deleted', 'Entry deleted');\r\n  };\r\n\r\n      if (error) throw error;\r\n\r\n      // Reload data\r\n      await loadAllDocketEntries();\r\n    } catch (error) {\r\n      console.error('Error updating docket:', error);\r\n    }\r\n  };\r\n\r\n  const dismissCase = async (docketId: string) => {\r\n    if (!confirm('Are you sure you want to dismiss this case?')) return;\r\n    await updateDocketStatus(docketId, 'dismissed', 'Case dismissed by authority');\r\n  };\r\n\r\n  const markMissed = async (docketId: string) => {\r\n    await updateDocketStatus(docketId, 'missed');\r\n  };\r\n\r\n  const completeCase = async (docketId: string) => {\r\n    const verdict = prompt('Enter verdict/resolution:');\r\n    if (verdict) {\r\n      await updateDocketStatus(docketId, 'completed', verdict);\r\n    }\r\n  };\r\n\r\n  // Filter out deleted entries\r\n  const filteredEntries = docketEntries.filter(entry => {\r\n    if (entry.status === 'deleted') return false;\r\n    if (filter === 'all') return true;\r\n    return entry.status === filter;\r\n  });\r\n\r\n  const getStatusIcon = (status: string) => {\r\n    switch (status) {\r\n      case 'scheduled':\r\n        return <Clock className=\"w-4 h-4 text-blue-400\" />;\r\n      case 'in_session':\r\n        return <Gavel className=\"w-4 h-4 text-yellow-400 animate-pulse\" />;\r\n      case 'completed':\r\n        return <CheckCircle className=\"w-4 h-4 text-green-400\" />;\r\n      case 'missed':\r\n        return <XCircle className=\"w-4 h-4 text-red-400\" />;\r\n      case 'dismissed':\r\n        return <AlertTriangle className=\"w-4 h-4 text-gray-400\" />;\r\n      default:\r\n        return <Clock className=\"w-4 h-4 text-gray-400\" />;\r\n    }\r\n  };\r\n\r\n  const getStatusColor = (status: string) => {\r\n    switch (status) {\r\n      case 'scheduled':\r\n        return 'border-blue-500/20 bg-blue-900/10';\r\n      case 'in_session':\r\n        return 'border-yellow-500/20 bg-yellow-900/10';\r\n      case 'completed':\r\n        return 'border-green-500/20 bg-green-900/10';\r\n      case 'missed':\r\n        return 'border-red-500/20 bg-red-900/10';\r\n      case 'dismissed':\r\n        return 'border-gray-500/20 bg-gray-900/10';\r\n      default:\r\n        return 'border-gray-500/20 bg-gray-900/10';\r\n    }\r\n  };\r\n\r\n  const formatDateTime = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    return {\r\n      date: date.toLocaleDateString(),\r\n      time: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })\r\n    };\r\n  };\r\n\r\n  const canManageCases = profile?.role === 'admin' || profile?.is_lead_officer || profile?.is_admin;\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n        <div className=\"animate-pulse\">\r\n          <div className=\"h-6 bg-gray-700 rounded mb-4\"></div>\r\n          <div className=\"space-y-3\">\r\n            <div className=\"h-20 bg-gray-700 rounded\"></div>\r\n            <div className=\"h-20 bg-gray-700 rounded\"></div>\r\n            <div className=\"h-20 bg-gray-700 rounded\"></div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <Gavel className=\"w-6 h-6 text-purple-400\" />\r\n          <div>\r\n            <h3 className=\"text-xl font-bold\">Court Docket Management</h3>\r\n            <p className=\"text-sm text-gray-400\">Manage all scheduled court cases</p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2\">\r\n          <span className=\"text-sm text-gray-400\">Filter:</span>\r\n          <select\r\n            value={filter}\r\n            onChange={(e) => setFilter(e.target.value as any)}\r\n            className=\"bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm\"\r\n          >\r\n            <option value=\"all\">All Cases</option>\r\n            <option value=\"scheduled\">Scheduled</option>\r\n            <option value=\"in_session\">In Session</option>\r\n            <option value=\"completed\">Completed</option>\r\n            <option value=\"missed\">Missed</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"mb-4 grid grid-cols-5 gap-4 text-sm font-semibold text-gray-400 border-b border-gray-700 pb-2\">\r\n        <div>User</div>\r\n        <div>Case Type</div>\r\n        <div>Scheduled</div>\r\n        <div>Status</div>\r\n        <div>Actions</div>\r\n      </div>\r\n\r\n      <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n        {filteredEntries.length === 0 ? (\r\n          <div className=\"text-center py-8\">\r\n            <FileText className=\"w-12 h-12 text-gray-600 mx-auto mb-4\" />\r\n            <p className=\"text-gray-400\">No docket entries found</p>\r\n          </div>\r\n        ) : (\r\n          filteredEntries.map((entry) => {\r\n            const { date, time } = formatDateTime(entry.scheduled_at);\r\n\r\n            return (\r\n              <div\r\n                key={entry.id}\r\n                className={`border rounded-lg p-4 ${getStatusColor(entry.status)}`}\r\n              >\r\n                <div className=\"grid grid-cols-5 gap-4 items-center\">\r\n                  <div>\r\n                    <div className=\"font-semibold text-sm\">{entry.username}</div>\r\n                    <div className=\"text-xs text-gray-400\">ID: {entry.user_id.slice(0, 8)}</div>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <span className=\"capitalize text-sm\">\r\n                      {entry.case_type.replace('_', ' ')}\r\n                    </span>\r\n                  </div>\r\n\r\n                  <div className=\"text-sm\">\r\n                    <div>{date}</div>\r\n                    <div className=\"text-gray-400\">{time}</div>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center gap-2\">\r\n                    {getStatusIcon(entry.status)}\r\n                    <span className=\"capitalize text-sm\">\r\n                      {entry.status.replace('_', ' ')}\r\n                    </span>\r\n                  </div>\r\n\r\n                  <div className=\"flex gap-1\">\r\n                    {canManageCases && (entry.status === 'scheduled' || entry.status === 'in_session') && (\r\n                      <>\r\n                        {entry.status === 'scheduled' && (\r\n                          <>\r\n                            <button\r\n                              onClick={() => completeCase(entry.id)}\r\n                              className=\"p-1 bg-green-600 hover:bg-green-700 rounded text-xs\"\r\n                              title=\"Mark Completed\"\r\n                            >\r\n                              <CheckCircle className=\"w-3 h-3\" />\r\n                            </button>\r\n                            <button\r\n                              onClick={() => markMissed(entry.id)}\r\n                              className=\"p-1 bg-red-600 hover:bg-red-700 rounded text-xs\"\r\n                              title=\"Mark Missed\"\r\n                            >\r\n                              <XCircle className=\"w-3 h-3\" />\r\n                            </button>\r\n                            <button\r\n                              onClick={() => dismissCase(entry.id)}\r\n                              className=\"p-1 bg-gray-600 hover:bg-gray-700 rounded text-xs\"\r\n                              title=\"Dismiss Case\"\r\n                            >\r\n                              <Trash2 className=\"w-3 h-3\" />\r\n                            </button>\r\n                          </>\r\n                        )}\r\n                        <button\r\n                          onClick={() => softDeleteDocket(entry.id)}\r\n                          className=\"p-1 bg-black hover:bg-red-800 rounded text-xs ml-1\"\r\n                          title=\"Delete (Soft)\"\r\n                        >\r\n                          <Trash2 className=\"w-3 h-3 text-red-400\" />\r\n                        </button>\r\n                      </>\r\n                    )}\r\n\r\n                    {entry.status === 'in_session' && (\r\n                      <button\r\n                        onClick={() => completeCase(entry.id)}\r\n                        className=\"px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs font-semibold\"\r\n                      >\r\n                        Resolve\r\n                      </button>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                {entry.notes && (\r\n                  <div className=\"mt-3 pt-3 border-t border-gray-700\">\r\n                    <p className=\"text-sm text-gray-400 italic\">\"{entry.notes}\"</p>\r\n                  </div>\r\n                )}\r\n\r\n                {entry.assigned_officer && (\r\n                  <div className=\"mt-2 text-xs text-gray-500 flex items-center gap-1\">\r\n                    Assigned: \r\n                    {profiles[entry.assigned_officer] ? (\r\n                      <ClickableUsername \r\n                        username={profiles[entry.assigned_officer].username} \r\n                        userId={entry.assigned_officer}\r\n                        profile={profiles[entry.assigned_officer]}\r\n                      />\r\n                    ) : (\r\n                      entry.officer_username || entry.assigned_officer\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            );\r\n          })\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"mt-6 grid grid-cols-5 gap-4 text-sm\">\r\n        <div className=\"text-center\">\r\n          <div className=\"text-lg font-bold text-blue-400\">\r\n            {docketEntries.filter(e => e.status === 'scheduled').length}\r\n          </div>\r\n          <div className=\"text-gray-400\">Scheduled</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-lg font-bold text-yellow-400\">\r\n            {docketEntries.filter(e => e.status === 'in_session').length}\r\n          </div>\r\n          <div className=\"text-gray-400\">In Session</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-lg font-bold text-green-400\">\r\n            {docketEntries.filter(e => e.status === 'completed').length}\r\n          </div>\r\n          <div className=\"text-gray-400\">Completed</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-lg font-bold text-red-400\">\r\n            {docketEntries.filter(e => e.status === 'missed').length}\r\n          </div>\r\n          <div className=\"text-gray-400\">Missed</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-lg font-bold text-gray-400\">\r\n            {docketEntries.filter(e => e.status === 'dismissed').length}\r\n          </div>\r\n          <div className=\"text-gray-400\">Dismissed</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CourtDocketDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtDocketModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtDocketView.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":189,"column":27,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[7590,7619],"text":"\r\n                          &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[7590,7619],"text":"\r\n                          &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[7590,7619],"text":"\r\n                          &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[7590,7619],"text":"\r\n                          &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":189,"column":41,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[7632,7659],"text":"&quot;\r\n                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[7632,7659],"text":"&ldquo;\r\n                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[7632,7659],"text":"&#34;\r\n                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[7632,7659],"text":"&rdquo;\r\n                        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { Calendar, Clock, CheckCircle, XCircle, AlertTriangle, Gavel } from 'lucide-react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport ClickableUsername from './ClickableUsername';\r\n\r\ninterface DocketEntry {\r\n  id: string;\r\n  case_type: string;\r\n  scheduled_at: string;\r\n  status: string;\r\n  assigned_officer: string | null;\r\n  notes: string | null;\r\n  court_session_id: string | null;\r\n}\r\n\r\nconst CourtDocketView: React.FC = () => {\r\n  const { user } = useAuthStore();\r\n  const navigate = useNavigate();\r\n  const [docketEntries, setDocketEntries] = useState<DocketEntry[]>([]);\r\n  const [officerProfiles, setOfficerProfiles] = useState<Record<string, any>>({});\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadUserDocket();\r\n    }\r\n  }, [user]);\r\n\r\n  const loadUserDocket = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const { data, error } = await supabase.rpc('get_user_docket');\r\n\r\n      if (error) throw error;\r\n      setDocketEntries(data || []);\r\n\r\n      // Fetch officer profiles for RGB\r\n      const officerIds = (data || []).map((e: any) => e.assigned_officer).filter((id: any) => id && typeof id === 'string' && id.length > 10);\r\n      if (officerIds.length > 0) {\r\n         const { data: profileData } = await supabase\r\n           .from('profiles')\r\n           .select('id, username, role, is_admin, is_troll_officer, is_troller, is_verified, rgb_username_expires_at')\r\n           .in('id', officerIds);\r\n         \r\n         const profileMap: Record<string, any> = {};\r\n         profileData?.forEach(p => profileMap[p.id] = p);\r\n         setOfficerProfiles(profileMap);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading docket:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleEnterCourtroom = () => {\r\n    // Navigate to court room - the session ID will be determined by the active court session\r\n    navigate('/troll-court/session/active'); // We'll handle session lookup in the component\r\n  };\r\n\r\n  const getStatusIcon = (status: string) => {\r\n    switch (status) {\r\n      case 'scheduled':\r\n        return <Clock className=\"w-4 h-4 text-blue-400\" />;\r\n      case 'in_session':\r\n        return <Gavel className=\"w-4 h-4 text-yellow-400 animate-pulse\" />;\r\n      case 'completed':\r\n        return <CheckCircle className=\"w-4 h-4 text-green-400\" />;\r\n      case 'missed':\r\n        return <XCircle className=\"w-4 h-4 text-red-400\" />;\r\n      case 'dismissed':\r\n        return <AlertTriangle className=\"w-4 h-4 text-gray-400\" />;\r\n      default:\r\n        return <Clock className=\"w-4 h-4 text-gray-400\" />;\r\n    }\r\n  };\r\n\r\n  const getStatusColor = (status: string) => {\r\n    switch (status) {\r\n      case 'scheduled':\r\n        return 'border-blue-500/20 bg-blue-900/10';\r\n      case 'in_session':\r\n        return 'border-yellow-500/20 bg-yellow-900/10';\r\n      case 'completed':\r\n        return 'border-green-500/20 bg-green-900/10';\r\n      case 'missed':\r\n        return 'border-red-500/20 bg-red-900/10';\r\n      case 'dismissed':\r\n        return 'border-gray-500/20 bg-gray-900/10';\r\n      default:\r\n        return 'border-gray-500/20 bg-gray-900/10';\r\n    }\r\n  };\r\n\r\n  const formatDateTime = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    return {\r\n      date: date.toLocaleDateString(),\r\n      time: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })\r\n    };\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n        <div className=\"animate-pulse\">\r\n          <div className=\"h-6 bg-gray-700 rounded mb-4\"></div>\r\n          <div className=\"space-y-3\">\r\n            <div className=\"h-16 bg-gray-700 rounded\"></div>\r\n            <div className=\"h-16 bg-gray-700 rounded\"></div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n      <div className=\"flex items-center gap-3 mb-6\">\r\n        <Calendar className=\"w-6 h-6 text-purple-400\" />\r\n        <div>\r\n          <h3 className=\"text-xl font-bold\">Your Court Docket</h3>\r\n          <p className=\"text-sm text-gray-400\">Scheduled court appearances and case status</p>\r\n        </div>\r\n      </div>\r\n\r\n      {docketEntries.length === 0 ? (\r\n        <div className=\"text-center py-8\">\r\n          <Calendar className=\"w-12 h-12 text-gray-600 mx-auto mb-4\" />\r\n          <p className=\"text-gray-400\">No court cases scheduled</p>\r\n          <p className=\"text-sm text-gray-500 mt-1\">Your docket is clear</p>\r\n        </div>\r\n      ) : (\r\n        <div className=\"space-y-4\">\r\n          {docketEntries.map((entry) => {\r\n            const { date, time } = formatDateTime(entry.scheduled_at);\r\n            const isUpcoming = new Date(entry.scheduled_at) > new Date();\r\n            const canEnter = entry.status === 'scheduled' || entry.status === 'in_session';\r\n\r\n            return (\r\n              <div\r\n                key={entry.id}\r\n                className={`border rounded-lg p-4 ${getStatusColor(entry.status)}`}\r\n              >\r\n                <div className=\"flex items-start justify-between\">\r\n                  <div className=\"flex items-start gap-3\">\r\n                    {getStatusIcon(entry.status)}\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center gap-2 mb-1\">\r\n                        <span className=\"font-semibold capitalize\">\r\n                          {entry.case_type.replace('_', ' ')} Case\r\n                        </span>\r\n                        <span className={`px-2 py-1 rounded-full text-xs font-medium capitalize ${\r\n                          entry.status === 'scheduled' ? 'bg-blue-600 text-white' :\r\n                          entry.status === 'in_session' ? 'bg-yellow-600 text-white' :\r\n                          entry.status === 'completed' ? 'bg-green-600 text-white' :\r\n                          entry.status === 'missed' ? 'bg-red-600 text-white' :\r\n                          'bg-gray-600 text-white'\r\n                        }`}>\r\n                          {entry.status.replace('_', ' ')}\r\n                        </span>\r\n                      </div>\r\n\r\n                      <div className=\"text-sm text-gray-300 mb-2\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Calendar className=\"w-3 h-3\" />\r\n                          {date} at {time}\r\n                        </div>\r\n                        {entry.assigned_officer && (\r\n                          <div className=\"text-xs text-gray-400 mt-1 flex items-center gap-1\">\r\n                            Assigned Officer: \r\n                            {officerProfiles[entry.assigned_officer] ? (\r\n                              <ClickableUsername \r\n                                username={officerProfiles[entry.assigned_officer].username} \r\n                                userId={entry.assigned_officer}\r\n                                profile={officerProfiles[entry.assigned_officer]}\r\n                              />\r\n                            ) : (\r\n                              entry.assigned_officer\r\n                            )}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n\r\n                      {entry.notes && (\r\n                        <p className=\"text-sm text-gray-400 italic\">\r\n                          \"{entry.notes}\"\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  {canEnter && isUpcoming && (\r\n                    <button\r\n                      onClick={() => handleEnterCourtroom()}\r\n                      className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-semibold transition-colors\"\r\n                    >\r\n                      Enter Courtroom\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"mt-6 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg\">\r\n        <div className=\"flex items-start gap-2\">\r\n          <AlertTriangle className=\"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5\" />\r\n          <div className=\"text-sm\">\r\n            <p className=\"font-semibold text-blue-300 mb-1\">Court Attendance Required</p>\r\n            <p className=\"text-blue-200\">\r\n              Missing a scheduled court appearance will result in reputation penalties and may lead to additional consequences.\r\n              Arrive on time and be prepared to present your case.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CourtDocketView;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtEntryModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtGeminiModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CourtRulingArchive.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CreatorSafetyPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CreditScoreBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\CropPhotoModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\DistrictNavigation.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\DistrictOnboardingTour.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":136,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3852,3895],"text":"You&apos;ve successfully explored this district."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3852,3895],"text":"You&lsquo;ve successfully explored this district."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3852,3895],"text":"You&#39;ve successfully explored this district."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3852,3895],"text":"You&rsquo;ve successfully explored this district."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { X, ChevronLeft, ChevronRight, CheckCircle, Sparkles } from 'lucide-react'\r\n\r\ninterface TourStep {\r\n  step_number: number\r\n  title: string\r\n  description: string\r\n  target_feature: string\r\n  route_path: string\r\n  action_type: string\r\n}\r\n\r\ninterface DistrictOnboardingTourProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  districtName: string\r\n  onComplete: () => void\r\n}\r\n\r\nexport default function DistrictOnboardingTour({\r\n  isOpen,\r\n  onClose,\r\n  districtName,\r\n  onComplete\r\n}: DistrictOnboardingTourProps) {\r\n  const { user } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [tourSteps, setTourSteps] = useState<TourStep[]>([])\r\n  const [currentStep, setCurrentStep] = useState(0)\r\n  const [loading, setLoading] = useState(true)\r\n  const [completed, setCompleted] = useState(false)\r\n\r\n  const loadTourSteps = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      const { data, error } = await supabase.rpc('get_district_onboarding_tour', {\r\n        p_district_name: districtName\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      setTourSteps(data || [])\r\n      setCurrentStep(0)\r\n      setCompleted(false)\r\n    } catch (error) {\r\n      console.error('Error loading tour steps:', error)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [districtName])\r\n\r\n  useEffect(() => {\r\n    if (isOpen && districtName) {\r\n      loadTourSteps()\r\n    }\r\n  }, [isOpen, districtName, loadTourSteps])\r\n\r\n  const nextStep = () => {\r\n    if (currentStep < tourSteps.length - 1) {\r\n      setCurrentStep(currentStep + 1)\r\n    } else {\r\n      completeTour()\r\n    }\r\n  }\r\n\r\n  const prevStep = () => {\r\n    if (currentStep > 0) {\r\n      setCurrentStep(currentStep - 1)\r\n    }\r\n  }\r\n\r\n  const completeTour = async () => {\r\n    if (!user?.id) return\r\n\r\n    try {\r\n      // Mark tour as completed\r\n      const { data: districts } = await supabase.rpc('get_user_accessible_districts', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      const district = districts?.find((d: any) => d.name === districtName)\r\n      if (district) {\r\n        await supabase.rpc('update_district_progress', {\r\n          p_user_id: user.id,\r\n          p_district_id: district.id,\r\n          p_onboarding_completed: true\r\n        })\r\n      }\r\n\r\n      setCompleted(true)\r\n      setTimeout(() => {\r\n        onComplete()\r\n        onClose()\r\n      }, 2000)\r\n    } catch (error) {\r\n      console.error('Error completing tour:', error)\r\n    }\r\n  }\r\n\r\n  const navigateToFeature = () => {\r\n    const step = tourSteps[currentStep]\r\n    if (step?.route_path) {\r\n      navigate(step.route_path)\r\n      // Close tour after navigation\r\n      setTimeout(() => {\r\n        onClose()\r\n      }, 500)\r\n    }\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\r\n        <div className=\"bg-[#0A0A14] rounded-xl p-6 border border-purple-500/30\">\r\n          <div className=\"animate-pulse space-y-4\">\r\n            <div className=\"h-6 bg-gray-700 rounded w-48\"></div>\r\n            <div className=\"h-16 bg-gray-700 rounded\"></div>\r\n            <div className=\"h-10 bg-gray-700 rounded w-32\"></div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (completed) {\r\n    return (\r\n      <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\r\n        <div className=\"bg-[#0A0A14] rounded-xl p-8 border border-green-500/30 text-center\">\r\n          <CheckCircle className=\"w-16 h-16 text-green-400 mx-auto mb-4\" />\r\n          <h2 className=\"text-2xl font-bold text-white mb-2\">Tour Completed!</h2>\r\n          <p className=\"text-gray-400\">You've successfully explored this district.</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const currentStepData = tourSteps[currentStep]\r\n  const progress = ((currentStep + 1) / tourSteps.length) * 100\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-[#0A0A14] rounded-xl border border-purple-500/30 max-w-2xl w-full max-h-[90vh] overflow-hidden\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-6 border-b border-[#2C2C2C]\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Sparkles className=\"w-6 h-6 text-purple-400\" />\r\n            <div>\r\n              <h2 className=\"text-xl font-bold text-white\">District Tour</h2>\r\n              <p className=\"text-sm text-gray-400\">\r\n                Step {currentStep + 1} of {tourSteps.length}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"p-2 hover:bg-[#1F1F2E] rounded-lg transition-colors\"\r\n          >\r\n            <X className=\"w-5 h-5 text-gray-400\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Progress Bar */}\r\n        <div className=\"px-6 py-3\">\r\n          <div className=\"w-full bg-[#1F1F2E] rounded-full h-2\">\r\n            <div\r\n              className=\"bg-purple-500 h-2 rounded-full transition-all duration-300\"\r\n              style={{ width: `${progress}%` }}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"px-6 pb-6\">\r\n          {currentStepData && (\r\n            <div className=\"space-y-6\">\r\n              <div>\r\n                <h3 className=\"text-2xl font-bold text-white mb-3\">\r\n                  {currentStepData.title}\r\n                </h3>\r\n                <p className=\"text-gray-300 text-lg leading-relaxed\">\r\n                  {currentStepData.description}\r\n                </p>\r\n              </div>\r\n\r\n              {currentStepData.target_feature && (\r\n                <div className=\"bg-[#1F1F2E] rounded-lg p-4 border border-purple-500/20\">\r\n                  <div className=\"flex items-center gap-3 mb-2\">\r\n                    <div className=\"w-3 h-3 bg-purple-400 rounded-full\"></div>\r\n                    <span className=\"font-semibold text-purple-300\">\r\n                      Featured: {currentStepData.target_feature}\r\n                    </span>\r\n                  </div>\r\n                  {currentStepData.route_path && (\r\n                    <p className=\"text-sm text-gray-400\">\r\n                      Navigate to: {currentStepData.route_path}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n              )}\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"flex items-center justify-between\">\r\n                <button\r\n                  onClick={prevStep}\r\n                  disabled={currentStep === 0}\r\n                  className=\"flex items-center gap-2 px-4 py-2 bg-[#1F1F2E] hover:bg-[#252530] disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors\"\r\n                >\r\n                  <ChevronLeft className=\"w-4 h-4\" />\r\n                  Previous\r\n                </button>\r\n\r\n                <div className=\"flex gap-3\">\r\n                  {currentStepData.action_type === 'navigate' && (\r\n                    <button\r\n                      onClick={navigateToFeature}\r\n                      className=\"px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors font-semibold\"\r\n                    >\r\n                      Go There\r\n                    </button>\r\n                  )}\r\n\r\n                  <button\r\n                    onClick={nextStep}\r\n                    className=\"flex items-center gap-2 px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors font-semibold\"\r\n                  >\r\n                    {currentStep === tourSteps.length - 1 ? (\r\n                      <>\r\n                        <CheckCircle className=\"w-4 h-4\" />\r\n                        Complete Tour\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        Next\r\n                        <ChevronRight className=\"w-4 h-4\" />\r\n                      </>\r\n                    )}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\DnaProfileCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\EmpireBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\Empty.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\EscalateReportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ExpandedStatsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\FileLawsuitModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GeminiChatButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GiftActionPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GiftModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"supabase"},"fix":{"range":[41,85],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Zap' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Zap"},"fix":{"range":[234,239],"text":""},"desc":"Remove unused variable \"Zap\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { supabase } from '../supabaseClient'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { useCoins } from '../lib/hooks/useCoins'\r\nimport { toast } from 'sonner'\r\nimport { Gift, Coins, Zap, X, Loader2 } from 'lucide-react'\r\n\r\ninterface GiftModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  recipientId: string\r\n  recipientUsername: string\r\n}\r\n\r\nconst presetAmounts = [50, 100, 200, 500, 1000, 2500, 5000]\r\n\r\nconst GiftModal: React.FC<GiftModalProps> = ({ isOpen, onClose, recipientId, recipientUsername }) => {\r\n  const { user } = useAuthStore()\r\n  const { balances, spendCoins } = useCoins()\r\n  const [amount, setAmount] = useState<number>(100)\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  if (!isOpen) return null\r\n\r\n  const sendGift = async () => {\r\n    if (!user || amount <= 0 || amount > (balances.troll_coins || 0)) {\r\n      toast.error('Invalid gift amount or insufficient balance')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      const success = await spendCoins({\r\n        senderId: user.id,\r\n        receiverId: recipientId,\r\n        amount: amount,\r\n        source: 'gift',\r\n        item: 'Coin Gift'\r\n      })\r\n\r\n      if (success) {\r\n        toast.success('Gift sent successfully!')\r\n        setTimeout(() => {\r\n          onClose()\r\n          setAmount(100)\r\n        }, 1500)\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Gift error:', err)\r\n      toast.error(err.message || 'Failed to send gift')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-40 flex items-center justify-center p-4\">\r\n        <div className=\"bg-gray-800 rounded-xl max-w-md w-full p-6 relative\">\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"p-2 bg-purple-500/20 rounded-lg\">\r\n                <Gift className=\"w-6 h-6 text-purple-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-white\">Send Gift</h3>\r\n                <p className=\"text-sm text-gray-400\">to {recipientUsername}</p>\r\n              </div>\r\n            </div>\r\n            <button onClick={onClose} className=\"p-1 hover:bg-gray-700 rounded-lg transition-colors\">\r\n              <X className=\"w-5 h-5 text-gray-400\" />\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"bg-gray-700 rounded-lg p-4 mb-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Coins className=\"w-4 h-4 text-yellow-400\" />\r\n                <span className=\"text-sm text-gray-400\">Troll Coins</span>\r\n              </div>\r\n              <span className=\"text-lg font-bold text-yellow-400\">\r\n                {balances.troll_coins?.toLocaleString?.() ?? '0'}\r\n              </span>\r\n            </div>\r\n          </div>\r\n\r\n          <label className=\"block text-sm font-medium text-gray-300 mb-3\">Gift Amount</label>\r\n\r\n          <div className=\"grid grid-cols-4 gap-2 mb-4\">\r\n            {presetAmounts.map((preset) => (\r\n              <button\r\n                key={preset}\r\n                onClick={() => setAmount(preset)}\r\n                className={`py-2 px-3 rounded-lg text-sm font-medium transition-colors ${\r\n                  amount === preset ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'\r\n                }`}\r\n              >\r\n                {preset.toLocaleString()}\r\n              </button>\r\n            ))}\r\n          </div>\r\n\r\n          <div className=\"relative mb-6\">\r\n            <input\r\n              type=\"number\"\r\n              value={amount}\r\n              onChange={(e) => setAmount(Math.max(1, parseInt(e.target.value) || 0))}\r\n              className=\"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n              placeholder=\"Enter amount\"\r\n              min=\"1\"\r\n            />\r\n            <Coins className=\"absolute right-3 top-3 w-5 h-5 text-yellow-400\" />\r\n          </div>\r\n\r\n          <button\r\n            onClick={sendGift}\r\n            disabled={loading || amount <= 0 || amount > (balances.troll_coins || 0)}\r\n            className=\"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-gray-600 disabled:to-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 disabled:cursor-not-allowed\"\r\n          >\r\n            {loading ? (\r\n              <>\r\n                <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n                Sending...\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Gift className=\"w-5 h-5\" />\r\n                Send Gift ({amount.toLocaleString()} Coins)\r\n              </>\r\n            )}\r\n          </button>\r\n\r\n          {amount > (balances.troll_coins || 0) && (\r\n            <p className=\"text-red-400 text-sm mt-2 text-center\">Insufficient Troll Coins balance</p>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nexport default GiftModal\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GiftTray.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GiftersModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalErrorBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalEventsBanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mapVoteEventToGlobal' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":25,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Clock, Gift, Trophy, Zap, Crown, Flame, X } from 'lucide-react';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\ninterface GlobalEvent {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  type: 'double_gift' | 'court_night' | 'family_war_finale' | 'bonus_hour' | 'special_event';\r\n  startTime: Date;\r\n  endTime: Date;\r\n  isActive: boolean;\r\n  multiplier?: number;\r\n  linkPath?: string;\r\n}\r\n\r\ninterface VoteEventRow {\r\n  id: string;\r\n  event_type: string;\r\n  created_at: string;\r\n}\r\n\r\nconst mapVoteEventToGlobal = (row: VoteEventRow): GlobalEvent => {\r\n  const baseStart = row.created_at ? new Date(row.created_at) : new Date();\r\n  const baseEnd = new Date(baseStart.getTime() + 60 * 60 * 1000);\r\n\r\n  if (row.event_type === 'officer_cycle_started') {\r\n    return {\r\n      id: row.id,\r\n      title: 'Vote: Troll Officer of the Week',\r\n      description: 'Support your favorite broadcaster and cast your vote.',\r\n      type: 'special_event',\r\n      startTime: baseStart,\r\n      endTime: baseEnd,\r\n      isActive: true,\r\n      linkPath: '/officer/vote',\r\n    };\r\n  }\r\n\r\n  if (row.event_type === 'officer_cycle_winner') {\r\n    return {\r\n      id: row.id,\r\n      title: 'Troll Officer of the Week Selected',\r\n      description: 'A new Troll Officer has been chosen by the community.',\r\n      type: 'special_event',\r\n      startTime: baseStart,\r\n      endTime: baseEnd,\r\n      isActive: true,\r\n      linkPath: '/officer/vote',\r\n    };\r\n  }\r\n\r\n  return {\r\n    id: row.id,\r\n    title: 'Troll City Event',\r\n    description: 'A new city event just dropped. Jump in and participate.',\r\n    type: 'special_event',\r\n    startTime: baseStart,\r\n    endTime: baseEnd,\r\n    isActive: true,\r\n  };\r\n};\r\n\r\nconst GlobalEventsBanner: React.FC = () => {\r\n  const { user } = useAuthStore();\r\n  const navigate = useNavigate();\r\n  const [currentEvent, setCurrentEvent] = useState<GlobalEvent | null>(null);\r\n  const [timeLeft, setTimeLeft] = useState<string>('');\r\n  const [isVisible, setIsVisible] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!user?.id) {\r\n      setCurrentEvent(null);\r\n      setIsVisible(false);\r\n      return;\r\n    }\r\n\r\n    let cancelled = false;\r\n\r\n    const loadEvents = async () => {\r\n      // Use officer_vote_cycles instead of vote_events\r\n      const { data: cycles, error } = await supabase\r\n        .from('officer_vote_cycles')\r\n        .select('id, starts_at, ends_at, status, created_at')\r\n        .eq('status', 'active')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error || !cycles || cycles.length === 0 || cancelled) {\r\n        setCurrentEvent(null);\r\n        setIsVisible(false);\r\n        return;\r\n      }\r\n\r\n      const activeCycle = cycles[0];\r\n      \r\n      // Check dismissals\r\n      const { data: dismissals } = await supabase\r\n        .from('user_event_dismissals')\r\n        .select('event_id')\r\n        .eq('user_id', user.id)\r\n        .eq('event_id', activeCycle.id);\r\n\r\n      if (dismissals && dismissals.length > 0) {\r\n         setCurrentEvent(null);\r\n         setIsVisible(false);\r\n         return;\r\n      }\r\n\r\n      // Map to GlobalEvent\r\n      setCurrentEvent({\r\n          id: activeCycle.id,\r\n          title: 'Vote: Troll Officer of the Week',\r\n          description: 'Support your favorite broadcaster and cast your vote.',\r\n          type: 'special_event',\r\n          startTime: new Date(activeCycle.starts_at),\r\n          endTime: new Date(activeCycle.ends_at),\r\n          isActive: true,\r\n          linkPath: '/officer/vote',\r\n      });\r\n    };\r\n\r\n    void loadEvents();\r\n\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [user?.id]);\r\n\r\n  useEffect(() => {\r\n    if (!currentEvent) return;\r\n\r\n    const updateTimer = () => {\r\n      const now = new Date();\r\n      const targetTime = currentEvent.isActive ? currentEvent.endTime : currentEvent.startTime;\r\n      const diff = targetTime.getTime() - now.getTime();\r\n\r\n      if (diff <= 0) {\r\n        setTimeLeft('');\r\n        return;\r\n      }\r\n\r\n      const hours = Math.floor(diff / (1000 * 60 * 60));\r\n      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\r\n      const seconds = Math.floor((diff % (1000 * 60)) / 1000);\r\n\r\n      if (hours > 0) {\r\n        setTimeLeft(`${hours}h ${minutes}m`);\r\n      } else if (minutes > 0) {\r\n        setTimeLeft(`${minutes}m ${seconds}s`);\r\n      } else {\r\n        setTimeLeft(`${seconds}s`);\r\n      }\r\n    };\r\n\r\n    updateTimer();\r\n    const interval = setInterval(updateTimer, 1000);\r\n    return () => clearInterval(interval);\r\n  }, [currentEvent]);\r\n\r\n  useEffect(() => {\r\n    if (!user?.id || !currentEvent) {\r\n      setIsVisible(false);\r\n      return;\r\n    }\r\n\r\n    const dismissedKey = `global-event-banner-dismissed-${user.id}-${currentEvent.id}`;\r\n    const shownKey = `global-event-banner-shown-${user.id}-${currentEvent.id}`;\r\n    const isDismissed = sessionStorage.getItem(dismissedKey) === 'true';\r\n    const alreadyShown = sessionStorage.getItem(shownKey) === 'true';\r\n\r\n    if (isDismissed || alreadyShown) {\r\n      setIsVisible(false);\r\n      return;\r\n    }\r\n\r\n    setIsVisible(true);\r\n    sessionStorage.setItem(shownKey, 'true');\r\n  }, [user?.id, currentEvent]);\r\n\r\n  const getEventIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'double_gift':\r\n        return <Gift className=\"w-5 h-5 text-yellow-400\" />;\r\n      case 'court_night':\r\n        return <Crown className=\"w-5 h-5 text-purple-400\" />;\r\n      case 'family_war_finale':\r\n        return <Trophy className=\"w-5 h-5 text-orange-400\" />;\r\n      case 'bonus_hour':\r\n        return <Zap className=\"w-5 h-5 text-blue-400\" />;\r\n      default:\r\n        return <Flame className=\"w-5 h-5 text-red-400\" />;\r\n    }\r\n  };\r\n\r\n  const getEventColors = (type: string) => {\r\n    switch (type) {\r\n      case 'double_gift':\r\n        return 'from-yellow-600 to-orange-600 border-yellow-500';\r\n      case 'court_night':\r\n        return 'from-purple-600 to-pink-600 border-purple-500';\r\n      case 'family_war_finale':\r\n        return 'from-orange-600 to-red-600 border-orange-500';\r\n      case 'bonus_hour':\r\n        return 'from-blue-600 to-cyan-600 border-blue-500';\r\n      default:\r\n        return 'from-red-600 to-pink-600 border-red-500';\r\n    }\r\n  };\r\n\r\n  const handleDismiss = () => {\r\n    if (!user?.id) return;\r\n    if (!currentEvent) {\r\n      setIsVisible(false);\r\n      return;\r\n    }\r\n    const dismissedKey = `global-event-banner-dismissed-${user.id}-${currentEvent.id}`;\r\n    sessionStorage.setItem(dismissedKey, 'true');\r\n    setIsVisible(false);\r\n    void (async () => {\r\n      try {\r\n        await supabase\r\n          .from('user_event_dismissals')\r\n          .insert({ event_id: currentEvent.id, user_id: user.id });\r\n      } catch {\r\n      }\r\n    })();\r\n  };\r\n\r\n  if (!currentEvent || !isVisible) return null;\r\n\r\n  const handleClick = () => {\r\n    if (currentEvent.linkPath) {\r\n      navigate(currentEvent.linkPath);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={`fixed top-0 left-0 right-0 z-50 bg-gradient-to-r ${getEventColors(\r\n        currentEvent.type\r\n      )} border-b-2 shadow-lg ${currentEvent.linkPath ? 'cursor-pointer' : ''}`}\r\n      onClick={handleClick}\r\n    >\r\n      <div className=\"max-w-7xl mx-auto px-4 py-3\">\r\n        <div className=\"flex items-center justify-between gap-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"animate-bounce\">{getEventIcon(currentEvent.type)}</div>\r\n            <div>\r\n              <h3 className=\"text-white font-bold text-lg\">\r\n                {currentEvent.isActive ? 'LIVE: ' : 'COMING UP: '}\r\n                {currentEvent.title}\r\n              </h3>\r\n              <p className=\"text-white/90 text-sm\">{currentEvent.description}</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-3\">\r\n            {timeLeft && (\r\n              <div className=\"flex items-center gap-2 bg-black/20 rounded-lg px-3 py-1\">\r\n                <Clock className=\"w-4 h-4 text-white\" />\r\n                <span className=\"text-white font-mono font-bold\">\r\n                  {currentEvent.isActive ? `ENDS IN: ${timeLeft}` : `STARTS IN: ${timeLeft}`}\r\n                </span>\r\n              </div>\r\n            )}\r\n\r\n            {currentEvent.multiplier && (\r\n              <div className=\"bg-white/20 rounded-lg px-3 py-1\">\r\n                <span className=\"text-white font-bold\">{currentEvent.multiplier}x MULTIPLIER</span>\r\n              </div>\r\n            )}\r\n\r\n            <button\r\n              onClick={handleDismiss}\r\n              className=\"ml-2 inline-flex items-center justify-center rounded-full bg-black/20 hover:bg-black/30 text-white p-2 transition\"\r\n              aria-label=\"Dismiss event banner\"\r\n            >\r\n              <X className=\"w-4 h-4\" />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GlobalEventsBanner;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalGiftBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalLoadingOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalPayoutBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalPodBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlobalPodNotification.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":55,"column":73,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2049,2059],"text":" started &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2049,2059],"text":" started &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2049,2059],"text":" started &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2049,2059],"text":" started &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":55,"column":86,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2071,2072],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2071,2072],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2071,2072],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2071,2072],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payload' is defined but never used. Allowed unused args must match /^_/u.","line":69,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":23}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react';\nimport { supabase } from '../lib/supabase';\nimport { useAuthStore } from '../lib/store';\nimport { toast } from 'sonner';\nimport { Mic } from 'lucide-react';\nimport { useNavigate } from 'react-router-dom';\n\nexport default function GlobalPodNotification() {\n  const { profile } = useAuthStore();\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    // Only listen if user has notifications enabled (default true)\n    // If profile is not loaded yet, we might miss it, but that's acceptable for now.\n    // We default to true if the column is missing or null.\n    const notificationsEnabled = (profile as any)?.banner_notifications_enabled ?? true;\n    \n    if (!notificationsEnabled) return;\n\n    const channel = supabase\n      .channel('global_pod_notifications')\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'pod_rooms',\n          filter: 'is_live=eq.true'\n        },\n        async (payload) => {\n          const room = payload.new;\n          \n          // Fetch host name\n          const { data: host } = await supabase\n            .from('user_profiles')\n            .select('username')\n            .eq('id', room.host_id)\n            .single();\n\n          const hostName = host?.username || 'Someone';\n\n          toast.custom((t) => (\n            <div \n              className=\"bg-gray-900 border border-purple-500/50 rounded-xl p-4 shadow-2xl shadow-purple-500/20 cursor-pointer flex items-center gap-4 w-full max-w-md hover:bg-gray-800 transition-colors\"\n              onClick={() => {\n                toast.dismiss(t);\n                navigate(`/pods/${room.id}`);\n              }}\n            >\n              <div className=\"bg-purple-600/20 p-3 rounded-full animate-pulse\">\n                <Mic className=\"w-6 h-6 text-purple-400\" />\n              </div>\n              <div>\n                <h4 className=\"font-bold text-white text-sm\">New Pod Live!</h4>\n                <p className=\"text-gray-300 text-xs\">{hostName} started \"{room.title}\"</p>\n              </div>\n            </div>\n          ), { duration: 8000, position: 'top-center' });\n        }\n      )\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'pod_rooms',\n          filter: 'is_live=eq.true'\n        },\n        async (payload) => {\n            // Check if it WASN'T live before (using old record if available, but UPDATE payload doesn't always have old)\n            // However, usually we only care about INSERT for new rooms.\n            // If a room toggles live, we might want to notify.\n            // But standard flow is Insert -> Live.\n            // We'll stick to INSERT for now to avoid spam on updates (like viewer count).\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [profile, navigate]);\n\n  return null;\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\GlowingUsernameColorPicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\Header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\HomeLiveGrid.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Mic' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Mic"},"fix":{"range":[186,191],"text":""},"desc":"Remove unused variable \"Mic\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { supabase } from '../lib/supabase';\nimport { Crown, Users, Video, Shield, Star, Mic } from 'lucide-react';\n\ninterface Stream {\n  id: string;\n  title: string;\n  thumbnail_url?: string;\n  viewer_count: number;\n  broadcaster: {\n    id: string;\n    username: string;\n    avatar_url?: string;\n    role: string;\n    troll_role?: string;\n    is_lead_officer?: boolean;\n    is_admin?: boolean;\n  };\n}\n\nexport default function HomeLiveGrid() {\n  const navigate = useNavigate();\n  const [streams, setStreams] = useState<Stream[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    fetchStreams();\n    const interval = setInterval(fetchStreams, 30000); // Refresh every 30s\n    return () => clearInterval(interval);\n  }, []);\n\n  const fetchStreams = async () => {\n    try {\n      const { data, error } = await supabase\n        .from('streams')\n        .select(`\n          id,\n          title,\n          thumbnail_url,\n          viewer_count,\n          user_profiles!broadcaster_id (\n            id,\n            username,\n            avatar_url,\n            role,\n            troll_role,\n            is_lead_officer,\n            is_admin\n          )\n        `)\n        .eq('is_live', true)\n        .eq('status', 'live');\n\n      if (error) throw error;\n\n      const formatted: Stream[] = (data || []).map((s: any) => ({\n        id: s.id,\n        title: s.title,\n        thumbnail_url: s.thumbnail_url,\n        viewer_count: s.viewer_count || 0,\n        broadcaster: Array.isArray(s.user_profiles) ? s.user_profiles[0] : s.user_profiles\n      }));\n\n      // Sorting Logic\n      formatted.sort((a, b) => {\n        const getWeight = (s: Stream) => {\n          const p = s.broadcaster;\n          // Admin #1\n          if (p.role === 'admin' || p.is_admin || p.troll_role === 'admin') return 1000;\n          // Secretary #2\n          if (p.role === 'secretary' || p.troll_role === 'secretary') return 900;\n          // Lead Troll Officer\n          if (p.is_lead_officer || p.role === 'lead_troll_officer' || p.troll_role === 'lead_troll_officer') return 800;\n          // Troll Officer\n          if (p.role === 'troll_officer' || p.troll_role === 'troll_officer') return 700;\n          \n          return 0; // Regular users\n        };\n\n        return getWeight(b) - getWeight(a);\n      });\n\n      setStreams(formatted);\n    } catch (err) {\n      console.error('Error fetching live streams:', err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n        {[1, 2, 3, 4].map((i) => (\n          <div key={i} className=\"aspect-video bg-slate-800/50 rounded-xl animate-pulse\" />\n        ))}\n      </div>\n    );\n  }\n\n  if (streams.length === 0) {\n    return (\n      <div className=\"text-center py-12 bg-slate-900/30 rounded-2xl border border-white/5\">\n        <Video className=\"w-12 h-12 text-slate-600 mx-auto mb-4\" />\n        <h3 className=\"text-xl font-bold text-white mb-2\">No active broadcasts</h3>\n        <p className=\"text-slate-400\">Be the first to go live!</p>\n        <button \n          onClick={() => navigate('/go-live')}\n          className=\"mt-6 px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-medium transition-colors\"\n        >\n          Go Live\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n      {streams.map((stream) => {\n        // Determine badge\n        let BadgeIcon = null;\n        let badgeColor = '';\n        let badgeLabel = '';\n\n        const p = stream.broadcaster;\n        if (p.role === 'admin' || p.is_admin || p.troll_role === 'admin') {\n          BadgeIcon = Crown;\n          badgeColor = 'text-yellow-400';\n          badgeLabel = 'Admin';\n        } else if (p.role === 'secretary' || p.troll_role === 'secretary') {\n          BadgeIcon = Star;\n          badgeColor = 'text-pink-400';\n          badgeLabel = 'Secretary';\n        } else if (p.is_lead_officer || p.role === 'lead_troll_officer' || p.troll_role === 'lead_troll_officer') {\n          BadgeIcon = Shield;\n          badgeColor = 'text-emerald-400';\n          badgeLabel = 'Lead Officer';\n        } else if (p.role === 'troll_officer' || p.troll_role === 'troll_officer') {\n          BadgeIcon = Shield;\n          badgeColor = 'text-blue-400';\n          badgeLabel = 'Officer';\n        }\n\n        return (\n          <div \n            key={stream.id}\n            onClick={() => navigate(`/live/${stream.id}`)}\n            className=\"group relative bg-slate-900/50 rounded-2xl overflow-hidden border border-white/5 hover:border-purple-500/50 transition-all duration-300 hover:shadow-[0_0_30px_rgba(168,85,247,0.15)] cursor-pointer\"\n          >\n            {/* Thumbnail */}\n            <div className=\"aspect-video relative bg-slate-950\">\n              {stream.thumbnail_url ? (\n                <img src={stream.thumbnail_url} alt={stream.title} className=\"w-full h-full object-cover\" />\n              ) : (\n                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800\">\n                  <Video className=\"w-12 h-12 text-slate-700 group-hover:text-purple-500/50 transition-colors\" />\n                </div>\n              )}\n              \n              {/* Live Badge */}\n              <div className=\"absolute top-3 left-3 px-2 py-1 bg-red-600 text-white text-xs font-bold rounded flex items-center gap-1.5 animate-pulse\">\n                <span className=\"w-1.5 h-1.5 rounded-full bg-white\" />\n                LIVE\n              </div>\n\n              {/* Viewer Count */}\n              <div className=\"absolute top-3 right-3 px-2 py-1 bg-black/60 backdrop-blur-md text-white text-xs font-medium rounded flex items-center gap-1.5\">\n                <Users className=\"w-3 h-3\" />\n                {stream.viewer_count.toLocaleString()}\n              </div>\n            </div>\n\n            {/* Info */}\n            <div className=\"p-4\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"relative\">\n                  <img \n                    src={stream.broadcaster.avatar_url || `https://ui-avatars.com/api/?name=${stream.broadcaster.username}`}\n                    alt={stream.broadcaster.username}\n                    className=\"w-10 h-10 rounded-full border-2 border-slate-800 object-cover\"\n                  />\n                  {BadgeIcon && (\n                    <div className=\"absolute -bottom-1 -right-1 bg-slate-900 rounded-full p-0.5 border border-slate-700\">\n                      <BadgeIcon className={`w-3 h-3 ${badgeColor}`} />\n                    </div>\n                  )}\n                </div>\n                \n                <div className=\"flex-1 min-w-0\">\n                  <h3 className=\"font-semibold text-white truncate group-hover:text-purple-400 transition-colors\">\n                    {stream.title || `${stream.broadcaster.username}'s Stream`}\n                  </h3>\n                  <p className=\"text-sm text-slate-400 flex items-center gap-2\">\n                    {stream.broadcaster.username}\n                    {badgeLabel && (\n                      <span className={`text-[10px] px-1.5 py-0.5 rounded-full bg-slate-800 border border-slate-700 ${badgeColor}`}>\n                        {badgeLabel}\n                      </span>\n                    )}\n                  </p>\n                </div>\n              </div>\n            </div>\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\HomePageStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\IdVerifyClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\IncomingCallPopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\InstallButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\IosInstallModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":88,"column":31,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select &quot;Add to Home Screen\"\r\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select &ldquo;Add to Home Screen\"\r\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select &#34;Add to Home Screen\"\r\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select &rdquo;Add to Home Screen\"\r\n                  "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":88,"column":50,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select \"Add to Home Screen&quot;\r\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select \"Add to Home Screen&ldquo;\r\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select \"Add to Home Screen&#34;\r\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3560,3632],"text":"\r\n                    2. Select \"Add to Home Screen&rdquo;\r\n                  "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":91,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3694,3779],"text":"\r\n                    Scroll down if you don&apos;t see it immediately\r\n                  "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3694,3779],"text":"\r\n                    Scroll down if you don&lsquo;t see it immediately\r\n                  "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3694,3779],"text":"\r\n                    Scroll down if you don&#39;t see it immediately\r\n                  "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3694,3779],"text":"\r\n                    Scroll down if you don&rsquo;t see it immediately\r\n                  "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":103,"column":28,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap &quot;Add\"\r\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap &ldquo;Add\"\r\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap &#34;Add\"\r\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap &rdquo;Add\"\r\n                  "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":103,"column":32,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap \"Add&quot;\r\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap \"Add&ldquo;\r\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap \"Add&#34;\r\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4303,4357],"text":"\r\n                    3. Tap \"Add&rdquo;\r\n                  "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":122,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5207,5277],"text":"\r\n                  Don&apos;t show this again for 7 days\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5207,5277],"text":"\r\n                  Don&lsquo;t show this again for 7 days\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5207,5277],"text":"\r\n                  Don&#39;t show this again for 7 days\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5207,5277],"text":"\r\n                  Don&rsquo;t show this again for 7 days\r\n                "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * IosInstallModal Component\r\n * Shows iOS Safari \"Add to Home Screen\" instructions in a bottom sheet\r\n */\r\n\r\nimport React from 'react';\r\nimport { X, Share, Plus } from 'lucide-react';\r\nimport { dismissIosInstructions } from '../pwa/install';\r\n\r\ninterface IosInstallModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  enableDontShowAgain?: boolean;\r\n}\r\n\r\nexport default function IosInstallModal({ \r\n  isOpen, \r\n  onClose,\r\n  enableDontShowAgain = true \r\n}: IosInstallModalProps) {\r\n  const [dontShowAgain, setDontShowAgain] = React.useState(false);\r\n\r\n  const handleClose = () => {\r\n    if (dontShowAgain && enableDontShowAgain) {\r\n      dismissIosInstructions(7); // Don't show for 7 days\r\n    }\r\n    onClose();\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[9999] flex items-end justify-center pointer-events-none animate-fade-in\">\r\n      {/* Backdrop */}\r\n      <div \r\n        className=\"absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity\" \r\n        onClick={handleClose}\r\n        aria-label=\"Close modal\"\r\n      />\r\n      \r\n      {/* Bottom Sheet */}\r\n      <div className=\"relative w-full max-w-md pointer-events-auto animate-slide-up-smooth safe-bottom\">\r\n        <div className=\"bg-gradient-to-b from-slate-900 to-slate-950 border-t border-purple-500/20 rounded-t-3xl shadow-2xl shadow-purple-900/50\">\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between p-6 pb-4\">\r\n            <h3 className=\"text-2xl font-bold bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent\">\r\n              Install Troll City\r\n            </h3>\r\n            <button\r\n              onClick={handleClose}\r\n              className=\"p-2 bg-white/5 hover:bg-white/10 rounded-full text-white/70 hover:text-white transition-all\"\r\n              aria-label=\"Close\"\r\n            >\r\n              <X size={20} />\r\n            </button>\r\n          </div>\r\n\r\n          {/* Content */}\r\n          <div className=\"px-6 pb-6\">\r\n            <p className=\"text-slate-400 mb-6 text-sm\">\r\n              Install our app for the best experience. Get instant access from your home screen!\r\n            </p>\r\n\r\n            {/* Steps */}\r\n            <div className=\"flex flex-col gap-4 mb-6\">\r\n              {/* Step 1 */}\r\n              <div className=\"flex items-start gap-4 p-3 bg-slate-800/50 rounded-xl border border-purple-500/10\">\r\n                <div className=\"flex-shrink-0 p-3 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-lg border border-blue-400/20\">\r\n                  <Share size={24} className=\"text-blue-400\" />\r\n                </div>\r\n                <div className=\"flex-1 pt-1\">\r\n                  <p className=\"text-white font-medium mb-1\">\r\n                    1. Tap the Share button\r\n                  </p>\r\n                  <p className=\"text-slate-400 text-xs\">\r\n                    Look for <Share size={12} className=\"inline\" /> in your Safari toolbar\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Step 2 */}\r\n              <div className=\"flex items-start gap-4 p-3 bg-slate-800/50 rounded-xl border border-purple-500/10\">\r\n                <div className=\"flex-shrink-0 p-3 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-lg border border-purple-400/20\">\r\n                  <Plus size={24} className=\"text-purple-400\" />\r\n                </div>\r\n                <div className=\"flex-1 pt-1\">\r\n                  <p className=\"text-white font-medium mb-1\">\r\n                    2. Select \"Add to Home Screen\"\r\n                  </p>\r\n                  <p className=\"text-slate-400 text-xs\">\r\n                    Scroll down if you don't see it immediately\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Step 3 */}\r\n              <div className=\"flex items-start gap-4 p-3 bg-slate-800/50 rounded-xl border border-purple-500/10\">\r\n                <div className=\"flex-shrink-0 p-3 bg-gradient-to-br from-cyan-500/20 to-teal-500/20 rounded-lg border border-cyan-400/20\">\r\n                  <div className=\"text-2xl\">‚úì</div>\r\n                </div>\r\n                <div className=\"flex-1 pt-1\">\r\n                  <p className=\"text-white font-medium mb-1\">\r\n                    3. Tap \"Add\"\r\n                  </p>\r\n                  <p className=\"text-slate-400 text-xs\">\r\n                    The app will appear on your home screen\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Don't Show Again Option */}\r\n            {enableDontShowAgain && (\r\n              <label className=\"flex items-center gap-3 mb-4 cursor-pointer group\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={dontShowAgain}\r\n                  onChange={(e) => setDontShowAgain(e.target.checked)}\r\n                  className=\"w-5 h-5 rounded border-2 border-purple-500/30 bg-slate-800 checked:bg-purple-600 checked:border-purple-600 cursor-pointer transition-all\"\r\n                />\r\n                <span className=\"text-sm text-slate-400 group-hover:text-slate-300 transition-colors\">\r\n                  Don't show this again for 7 days\r\n                </span>\r\n              </label>\r\n            )}\r\n\r\n            {/* Got It Button */}\r\n            <button\r\n              onClick={handleClose}\r\n              className=\"w-full py-4 bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-500 hover:to-cyan-500 text-white font-semibold rounded-xl shadow-lg shadow-purple-500/30 hover:shadow-cyan-500/30 transition-all active:scale-[0.98]\"\r\n            >\r\n              Got it!\r\n            </button>\r\n          </div>\r\n\r\n          {/* Visual indicator arrow pointing to Safari toolbar */}\r\n          <div className=\"absolute -bottom-8 left-1/2 -translate-x-1/2 text-cyan-400/50 animate-bounce pointer-events-none\">\r\n            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n              <path d=\"M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z\" transform=\"rotate(90 12 12)\" />\r\n            </svg>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <style>{`\r\n        @keyframes fade-in {\r\n          from { opacity: 0; }\r\n          to { opacity: 1; }\r\n        }\r\n        \r\n        @keyframes slide-up-smooth {\r\n          from { \r\n            opacity: 0;\r\n            transform: translateY(100%); \r\n          }\r\n          to { \r\n            opacity: 1;\r\n            transform: translateY(0); \r\n          }\r\n        }\r\n        \r\n        .animate-fade-in {\r\n          animation: fade-in 0.2s ease-out;\r\n        }\r\n        \r\n        .animate-slide-up-smooth {\r\n          animation: slide-up-smooth 0.3s cubic-bezier(0.16, 1, 0.3, 1);\r\n        }\r\n      `}</style>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\JudgeRulingModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":64,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[2495,2511],"text":"Judge&apos;s Chambers"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[2495,2511],"text":"Judge&lsquo;s Chambers"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[2495,2511],"text":"Judge&#39;s Chambers"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[2495,2511],"text":"Judge&rsquo;s Chambers"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":181,"column":83,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8373,8614],"text":"\r\n                  This amount will be automatically transferred from the Defendant&apos;s balance to the Plaintiff.\r\n                  If the Defendant has insufficient funds, the maximum available balance will be transferred.\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8373,8614],"text":"\r\n                  This amount will be automatically transferred from the Defendant&lsquo;s balance to the Plaintiff.\r\n                  If the Defendant has insufficient funds, the maximum available balance will be transferred.\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8373,8614],"text":"\r\n                  This amount will be automatically transferred from the Defendant&#39;s balance to the Plaintiff.\r\n                  If the Defendant has insufficient funds, the maximum available balance will be transferred.\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8373,8614],"text":"\r\n                  This amount will be automatically transferred from the Defendant&rsquo;s balance to the Plaintiff.\r\n                  If the Defendant has insufficient funds, the maximum available balance will be transferred.\r\n                "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport { supabase } from '../supabaseClient';\r\nimport { X, Gavel, Scale, ExternalLink } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\n\r\ninterface JudgeRulingModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  caseData: any;\r\n  onSuccess: () => void;\r\n}\r\n\r\nexport default function JudgeRulingModal({ isOpen, onClose, caseData, onSuccess }: JudgeRulingModalProps) {\r\n  const [rulingType, setRulingType] = useState<'dismissed' | 'plaintiff_favored' | 'defendant_favored' | ''>('');\r\n  const [rulingNotes, setRulingNotes] = useState('');\r\n  const [awardAmount, setAwardAmount] = useState<number>(0);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  if (!isOpen || !caseData) return null;\r\n\r\n  const handleRuling = async () => {\r\n    if (!rulingType) return toast.error('Please select a verdict');\r\n    if (!rulingNotes) return toast.error('Please provide ruling notes');\r\n    if (rulingType === 'plaintiff_favored' && awardAmount < 0) return toast.error('Award amount cannot be negative');\r\n\r\n    setLoading(true);\r\n    try {\r\n      const { data, error } = await supabase.rpc('rule_civil_lawsuit', {\r\n        p_case_id: caseData.id,\r\n        p_verdict: rulingType,\r\n        p_ruling_notes: rulingNotes,\r\n        p_award_amount: rulingType === 'plaintiff_favored' ? awardAmount : 0\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data && data.success) {\r\n        toast.success('Ruling issued successfully');\r\n        onSuccess();\r\n        onClose();\r\n      } else {\r\n        toast.error(data?.message || 'Failed to issue ruling');\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Error issuing ruling:', err);\r\n      toast.error(err.message || 'An unexpected error occurred');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n      <div className=\"bg-[#120F1D] border border-purple-500/30 rounded-xl max-w-3xl w-full shadow-2xl overflow-hidden flex flex-col max-h-[90vh]\">\r\n        \r\n        {/* Header */}\r\n        <div className=\"p-6 border-b border-white/10 flex items-center justify-between bg-[#1A1625]\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"bg-purple-500/20 p-2 rounded-lg\">\r\n              <Gavel className=\"w-6 h-6 text-purple-400\" />\r\n            </div>\r\n            <div>\r\n              <h2 className=\"text-xl font-bold text-white\">Judge's Chambers</h2>\r\n              <p className=\"text-xs text-gray-400\">Case #{caseData.case_number} ‚Ä¢ {caseData.category}</p>\r\n            </div>\r\n          </div>\r\n          <button onClick={onClose} className=\"text-gray-400 hover:text-white transition-colors\">\r\n            <X size={24} />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Body */}\r\n        <div className=\"p-6 overflow-y-auto flex-1 grid md:grid-cols-2 gap-6\">\r\n          \r\n          {/* Case Details (Left) */}\r\n          <div className=\"space-y-6 border-r border-white/5 pr-6\">\r\n            <div>\r\n              <h3 className=\"text-sm font-bold text-purple-400 mb-2 uppercase tracking-wider\">Parties Involved</h3>\r\n              <div className=\"bg-black/20 p-4 rounded-lg space-y-3\">\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"text-gray-400 text-sm\">Plaintiff</span>\r\n                  <span className=\"text-white font-semibold\">{caseData.plaintiff?.username}</span>\r\n                </div>\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"text-gray-400 text-sm\">Defendant</span>\r\n                  <span className=\"text-white font-semibold\">{caseData.defendant?.username}</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <h3 className=\"text-sm font-bold text-purple-400 mb-2 uppercase tracking-wider\">Complaint</h3>\r\n              <div className=\"bg-black/20 p-4 rounded-lg\">\r\n                <p className=\"text-gray-300 text-sm whitespace-pre-wrap\">{caseData.description}</p>\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <h3 className=\"text-sm font-bold text-purple-400 mb-2 uppercase tracking-wider\">Claim</h3>\r\n              <div className=\"bg-black/20 p-4 rounded-lg flex justify-between items-center\">\r\n                <span className=\"text-gray-400 text-sm\">Seeking Damages</span>\r\n                <span className=\"text-yellow-400 font-bold\">{caseData.claim_amount} Coins</span>\r\n              </div>\r\n            </div>\r\n\r\n            {caseData.evidence_url && (\r\n               <div>\r\n                <h3 className=\"text-sm font-bold text-purple-400 mb-2 uppercase tracking-wider\">Evidence</h3>\r\n                <a \r\n                  href={caseData.evidence_url} \r\n                  target=\"_blank\" \r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"flex items-center gap-2 text-blue-400 hover:text-blue-300 text-sm bg-blue-900/20 p-3 rounded-lg border border-blue-500/20\"\r\n                >\r\n                  <ExternalLink size={16} />\r\n                  View Submitted Evidence\r\n                </a>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Ruling Form (Right) */}\r\n          <div className=\"space-y-6\">\r\n             <div>\r\n              <h3 className=\"text-sm font-bold text-purple-400 mb-4 uppercase tracking-wider\">Official Ruling</h3>\r\n              \r\n              <div className=\"space-y-3\">\r\n                <button\r\n                  onClick={() => setRulingType('dismissed')}\r\n                  className={`w-full p-4 rounded-lg border flex items-center justify-between transition-all ${\r\n                    rulingType === 'dismissed' \r\n                      ? 'bg-gray-700 border-gray-500 text-white' \r\n                      : 'bg-black/20 border-white/10 text-gray-400 hover:bg-white/5'\r\n                  }`}\r\n                >\r\n                  <span className=\"font-semibold\">Dismiss Case</span>\r\n                  <span className=\"text-xs\">No Action Taken</span>\r\n                </button>\r\n\r\n                <button\r\n                  onClick={() => setRulingType('plaintiff_favored')}\r\n                  className={`w-full p-4 rounded-lg border flex items-center justify-between transition-all ${\r\n                    rulingType === 'plaintiff_favored' \r\n                      ? 'bg-green-900/40 border-green-500 text-green-100' \r\n                      : 'bg-black/20 border-white/10 text-gray-400 hover:bg-white/5'\r\n                  }`}\r\n                >\r\n                  <span className=\"font-semibold\">Rule for Plaintiff</span>\r\n                  <span className=\"text-xs\">Award Damages</span>\r\n                </button>\r\n\r\n                <button\r\n                  onClick={() => setRulingType('defendant_favored')}\r\n                  className={`w-full p-4 rounded-lg border flex items-center justify-between transition-all ${\r\n                    rulingType === 'defendant_favored' \r\n                      ? 'bg-red-900/40 border-red-500 text-red-100' \r\n                      : 'bg-black/20 border-white/10 text-gray-400 hover:bg-white/5'\r\n                  }`}\r\n                >\r\n                  <span className=\"font-semibold\">Rule for Defendant</span>\r\n                  <span className=\"text-xs\">No Damages</span>\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {rulingType === 'plaintiff_favored' && (\r\n              <div className=\"space-y-2 animate-in fade-in slide-in-from-top-2\">\r\n                <label className=\"text-sm font-medium text-gray-300\">Award Amount (Coins)</label>\r\n                <div className=\"relative\">\r\n                  <input\r\n                    type=\"number\"\r\n                    value={awardAmount}\r\n                    onChange={(e) => setAwardAmount(parseInt(e.target.value) || 0)}\r\n                    className=\"w-full bg-black/30 border border-green-500/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-400\"\r\n                    placeholder=\"Enter amount to transfer\"\r\n                  />\r\n                  <span className=\"absolute right-4 top-3 text-gray-500 text-sm\">MAX: {caseData.claim_amount}</span>\r\n                </div>\r\n                <p className=\"text-xs text-gray-500\">\r\n                  This amount will be automatically transferred from the Defendant's balance to the Plaintiff.\r\n                  If the Defendant has insufficient funds, the maximum available balance will be transferred.\r\n                </p>\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-300\">Ruling Notes / Justification</label>\r\n              <textarea\r\n                value={rulingNotes}\r\n                onChange={(e) => setRulingNotes(e.target.value)}\r\n                placeholder=\"Explain the reasoning for this verdict...\"\r\n                className=\"w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white h-32 resize-none focus:outline-none focus:border-purple-500\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <div className=\"p-6 border-t border-white/10 bg-[#1A1625] flex items-center justify-between\">\r\n          <div className=\"text-xs text-gray-500\">\r\n            * All rulings are final and recorded in the immutable court ledger.\r\n          </div>\r\n          <div className=\"flex gap-3\">\r\n            <button\r\n              onClick={onClose}\r\n              className=\"px-4 py-2 text-gray-400 hover:text-white transition-colors\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              onClick={handleRuling}\r\n              disabled={loading || !rulingType || !rulingNotes}\r\n              className={`px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold transition-all flex items-center gap-2 ${\r\n                (loading || !rulingType || !rulingNotes) ? 'opacity-50 cursor-not-allowed' : ''\r\n              }`}\r\n            >\r\n              {loading ? 'Submitting...' : 'Issue Final Ruling'}\r\n              <Scale size={18} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\KickPage.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":32,"column":16,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1367,1411],"text":"\r\n            You&apos;ve Been Kicked\r\n          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1367,1411],"text":"\r\n            You&lsquo;ve Been Kicked\r\n          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1367,1411],"text":"\r\n            You&#39;ve Been Kicked\r\n          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1367,1411],"text":"\r\n            You&rsquo;ve Been Kicked\r\n          "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { X, UserX, AlertTriangle } from 'lucide-react'\r\n\r\ninterface KickPageProps {\r\n  onClose: () => void\r\n  kickCount?: number\r\n}\r\n\r\nexport default function KickPage({ onClose, kickCount = 1 }: KickPageProps) {\r\n  const isLastWarning = kickCount >= 2\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/90 backdrop-blur-lg flex items-center justify-center p-6 z-50\">\r\n      <div className={`border-2 rounded-xl p-8 w-full max-w-2xl shadow-[0_0_60px_rgba(255,165,0,0.8)] relative ${\r\n        isLastWarning ? 'bg-[#2A1A00] border-orange-600' : 'bg-[#1A1A00] border-yellow-600'\r\n      }`}>\r\n        <button\r\n          onClick={onClose}\r\n          className=\"absolute top-4 right-4 text-gray-400 hover:text-white transition-colors\"\r\n        >\r\n          <X size={24} />\r\n        </button>\r\n\r\n        <div className=\"text-center mb-8\">\r\n          <div className=\"flex justify-center mb-6\">\r\n            <div className=\"relative\">\r\n              <UserX className={`w-24 h-24 ${isLastWarning ? 'text-orange-500' : 'text-yellow-500'} animate-pulse`} />\r\n              <div className={`absolute inset-0 ${isLastWarning ? 'bg-orange-500/20' : 'bg-yellow-500/20'} rounded-full animate-ping`} />\r\n            </div>\r\n          </div>\r\n          <h1 className={`text-4xl font-bold mb-4 ${isLastWarning ? 'text-orange-400' : 'text-yellow-400'}`}>\r\n            You've Been Kicked\r\n          </h1>\r\n          <div className={`border rounded-lg p-4 mb-6 ${\r\n            isLastWarning \r\n              ? 'bg-orange-900/30 border-orange-500/50' \r\n              : 'bg-yellow-900/30 border-yellow-500/50'\r\n          }`}>\r\n            <AlertTriangle className={`w-8 h-8 mx-auto mb-2 ${isLastWarning ? 'text-orange-400' : 'text-yellow-400'}`} />\r\n            <p className={`text-lg font-semibold mb-2 ${isLastWarning ? 'text-orange-300' : 'text-yellow-300'}`}>\r\n              {isLastWarning ? '‚ö†Ô∏è Final Warning!' : 'You have been removed from the stream'}\r\n            </p>\r\n            <p className=\"text-gray-300 text-sm\">\r\n              {isLastWarning \r\n                ? 'This is your final warning. One more kick will result in a permanent ban.'\r\n                : 'You can pay to re-enter, but be careful - after 3 kicks, you\\'ll be permanently banned.'}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"space-y-4 mb-6\">\r\n          <div className={`border rounded-lg p-4 ${\r\n            isLastWarning \r\n              ? 'bg-[#0A0000] border-orange-500/30' \r\n              : 'bg-[#0A0A00] border-yellow-500/30'\r\n          }`}>\r\n            <h3 className={`font-semibold mb-2 ${isLastWarning ? 'text-orange-400' : 'text-yellow-400'}`}>\r\n              Kick Details\r\n            </h3>\r\n            <div className=\"text-sm text-gray-300 space-y-1\">\r\n              <p><strong>Kick Count:</strong> {kickCount}/3</p>\r\n              <p><strong>Date:</strong> {new Date().toLocaleDateString()}</p>\r\n              <p><strong>Reason:</strong> Violation of community guidelines</p>\r\n            </div>\r\n          </div>\r\n\r\n          {isLastWarning && (\r\n            <div className=\"bg-red-900/20 border border-red-500/50 rounded-lg p-4\">\r\n              <h3 className=\"text-red-400 font-semibold mb-2\">‚ö†Ô∏è Critical Warning</h3>\r\n              <p className=\"text-sm text-gray-300\">\r\n                You have been kicked <strong className=\"text-red-400\">{kickCount} times</strong>. \r\n                One more kick will result in a <strong className=\"text-red-400\">permanent ban</strong>.\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          <div className={`border rounded-lg p-4 ${\r\n            isLastWarning \r\n              ? 'bg-[#0A0000] border-orange-500/30' \r\n              : 'bg-[#0A0A00] border-yellow-500/30'\r\n          }`}>\r\n            <h3 className={`font-semibold mb-2 ${isLastWarning ? 'text-orange-400' : 'text-yellow-400'}`}>\r\n              Re-enter Troll City\r\n            </h3>\r\n            <p className=\"text-sm text-gray-300 mb-3\">\r\n              Pay <strong className=\"text-yellow-400\">250 troll_coins</strong> to re-enter the app.\r\n            </p>\r\n            <button className={`w-full py-3 rounded-lg font-semibold transition-colors ${\r\n              isLastWarning \r\n                ? 'bg-orange-600 hover:bg-orange-500' \r\n                : 'bg-yellow-600 hover:bg-yellow-500'\r\n            }`}>\r\n              Pay 250 Coins to Re-enter\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"text-center\">\r\n          <button\r\n            onClick={onClose}\r\n            className=\"px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors\"\r\n          >\r\n            Done\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\KickReentryModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":134,"column":71,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4825,4846],"text":"‚ö†Ô∏è You&apos;ve Been Kicked"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4825,4846],"text":"‚ö†Ô∏è You&lsquo;ve Been Kicked"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4825,4846],"text":"‚ö†Ô∏è You&#39;ve Been Kicked"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4825,4846],"text":"‚ö†Ô∏è You&rsquo;ve Been Kicked"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":140,"column":35,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5123,5222],"text":" to re-enter the app.\r\n                After 3 kicks, you&apos;ll be permanently banned.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5123,5222],"text":" to re-enter the app.\r\n                After 3 kicks, you&lsquo;ll be permanently banned.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5123,5222],"text":" to re-enter the app.\r\n                After 3 kicks, you&#39;ll be permanently banned.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5123,5222],"text":" to re-enter the app.\r\n                After 3 kicks, you&rsquo;ll be permanently banned.\r\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { X } from 'lucide-react'\r\n\r\ninterface KickReentryModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  onSuccess: () => void\r\n}\r\n\r\nexport default function KickReentryModal({ isOpen, onClose, onSuccess }: KickReentryModalProps) {\r\n  const { user, profile } = useAuthStore()\r\n  const [loading, setLoading] = useState(false)\r\n  const [kickCount, setKickCount] = useState(0)\r\n  const [isBanned, setIsBanned] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (isOpen && profile) {\r\n      setKickCount(profile.kick_count || 0)\r\n      setIsBanned(profile.is_banned || false)\r\n    }\r\n  }, [isOpen, profile])\r\n\r\n  const handlePayReentry = async () => {\r\n    if (!user || !profile) return\r\n\r\n    if (profile.troll_coins < 250) {\r\n      toast.error('You need 250 troll_coins to re-enter')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      const { data, error } = await supabase.rpc('pay_kick_reentry_fee', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success('Re-entry fee paid! You can now access the app.')\r\n        onSuccess()\r\n        onClose()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to pay re-entry fee')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error paying re-entry fee:', error)\r\n      toast.error(error?.message || 'Failed to pay re-entry fee')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handlePayBanRestoration = async () => {\r\n    if (!user || !profile) return\r\n\r\n    if (profile.troll_coins < 3000) {\r\n      toast.error('You need 3000 troll_coins to restore your account')\r\n      return\r\n    }\r\n\r\n    // No confirmation - proceed directly\r\n\r\n    setLoading(true)\r\n    try {\r\n      const { data, error } = await supabase.rpc('pay_ban_restoration_fee', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success('Account restored! Fresh start!')\r\n        onSuccess()\r\n        onClose()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to restore account')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error restoring account:', error)\r\n      toast.error(error?.message || 'Failed to restore account')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/80 backdrop-blur-lg flex items-center justify-center p-6 z-50\">\r\n      <div className=\"bg-[#08010A] p-6 rounded-xl border border-purple-600 w-full max-w-md shadow-[0_0_40px_rgba(130,0,200,0.6)]\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h2 className=\"text-xl font-bold text-purple-400\">Account Status</h2>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-gray-400 hover:text-white transition-colors\"\r\n          >\r\n            <X size={20} />\r\n          </button>\r\n        </div>\r\n\r\n        {isBanned ? (\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-red-900/20 border border-red-500 rounded-lg p-4\">\r\n              <p className=\"text-red-400 font-semibold mb-2\">‚ö†Ô∏è Account Banned</p>\r\n              <p className=\"text-sm text-gray-300\">\r\n                You have been kicked 3 times. Your account is now banned.\r\n              </p>\r\n              <p className=\"text-sm text-gray-300 mt-2\">\r\n                Pay <strong className=\"text-yellow-400\">3000 troll_coins</strong> to restore your account.\r\n                Your account will be reset to level 0 with 0 coins.\r\n              </p>\r\n              <div className=\"mt-3 p-3 bg-blue-900/20 border border-blue-500/50 rounded-lg\">\r\n                <p className=\"text-xs text-blue-300\">\r\n                  üí° <strong>Important:</strong> Being honest about why you were banned will help you get back on the app. \r\n                  Honesty and understanding the reason for your ban can lead to account restoration.\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={handlePayBanRestoration}\r\n              disabled={loading || (profile?.troll_coins || 0) < 3000}\r\n              className=\"w-full py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {loading ? 'Processing...' : 'Pay 3000 Coins to Restore Account'}\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-yellow-900/20 border border-yellow-500 rounded-lg p-4\">\r\n              <p className=\"text-yellow-400 font-semibold mb-2\">‚ö†Ô∏è You've Been Kicked</p>\r\n              <p className=\"text-sm text-gray-300\">\r\n                Kick count: <strong>{kickCount}/3</strong>\r\n              </p>\r\n              <p className=\"text-sm text-gray-300 mt-2\">\r\n                Pay <strong className=\"text-yellow-400\">500 troll_coins</strong> to re-enter the app.\r\n                After 3 kicks, you'll be permanently banned.\r\n              </p>\r\n              <div className=\"mt-3 p-3 bg-blue-900/20 border border-blue-500/50 rounded-lg\">\r\n                <p className=\"text-xs text-blue-300\">\r\n                  üí° <strong>Important:</strong> Being honest about why you were kicked will help you get back on the app. \r\n                  If you believe this was a mistake, please contact support.\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={handlePayReentry}\r\n              disabled={loading || (profile?.troll_coins || 0) < 500}\r\n              className=\"w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {loading ? 'Processing...' : 'Pay 500 Coins to Re-enter'}\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\KickUserButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\LandingHero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\LegalLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\LiveAvatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\LiveKitGuard.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":50,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":50,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\LiveKitRoles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\LiveKitVideoGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\MaiDialogBubble.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ModerationPanel.tsx","messages":[{"ruleId":"react/jsx-no-undef","severity":2,"message":"'IPBanModal' is not defined.","line":210,"column":8,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":210,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport {\r\n  Shield,\r\n  ChevronRight,\r\n  ChevronDown,\r\n} from \"lucide-react\";\r\nimport api from \"../lib/api\";\r\n\r\ninterface ModerationPanelProps {\r\n  room: any; // LiveKit Room\r\n  targetUserId: string;\r\n  roomId: string;\r\n}\r\n\r\nexport default function ModerationPanel({ room, targetUserId, roomId }: ModerationPanelProps) {\r\n  const [open, setOpen] = useState(false);\r\n\r\n  const handleBan = async () => {\r\n    const reason = window.prompt(\"Enter ban reason:\");\r\n    if (!reason) return;\r\n\r\n    try {\r\n      await api.post(api.endpoints.moderation.takeAction, { \r\n        action: 'take_action',\r\n        action_type: 'ban_user',\r\n        target_user_id: targetUserId,\r\n        reason,\r\n        ban_duration_hours: 24 // Default to 24h\r\n      });\r\n      room?.disconnectParticipant(targetUserId);\r\n    } catch (error) {\r\n      console.error(\"Ban failed:\", error);\r\n      alert(\"Failed to ban user\");\r\n    }\r\n  };\r\n\r\n  const handleShadowBan = async () => {\r\n    const reason = window.prompt(\"Enter shadow ban reason:\");\r\n    if (!reason) return;\r\n\r\n    try {\r\n      await api.post(api.endpoints.moderation.shadowBan, { \r\n        targetUserId,\r\n        streamId: roomId,\r\n        reason,\r\n        durationMinutes: 60\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Shadow ban failed:\", error);\r\n      alert(\"Failed to shadow ban user\");\r\n    }\r\n  };\r\n\r\n  const handleKick = async () => {\r\n    const reason = window.prompt(\"Enter kick reason (optional):\") || \"Kicked by moderator\";\r\n    \r\n    // Disconnect first for immediate effect\r\n    room?.disconnectParticipant(targetUserId);\r\n\r\n    try {\r\n        await api.post(api.endpoints.moderation.logEvent, {\r\n            actionType: 'kick',\r\n            targetUserId,\r\n            streamId: roomId,\r\n            reason\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Failed to log kick:\", error);\r\n    }\r\n  };\r\n\r\n  const handleMute = async () => {\r\n    room?.localParticipant.setParticipantPermissions(targetUserId, {\r\n      canPublishAudio: false,\r\n      canPublishData: true,\r\n      canSubscribe: true\r\n    });\r\n    \r\n    try {\r\n        await api.post(api.endpoints.moderation.logEvent, {\r\n            actionType: 'mute',\r\n            targetUserId,\r\n            streamId: roomId,\r\n            reason: \"Muted by moderator\"\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Failed to log mute:\", error);\r\n    }\r\n  };\r\n\r\n  const handleGiftFreeze = async () => {\r\n    const reason = window.prompt(\"Enter gift freeze reason:\");\r\n    if (!reason) return;\r\n\r\n    try {\r\n      await api.post(api.endpoints.moderation.takeAction, { \r\n        action: 'take_action',\r\n        action_type: 'gift_freeze',\r\n        target_user_id: targetUserId,\r\n        reason\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Gift freeze failed:\", error);\r\n      alert(\"Failed to freeze gifts\");\r\n    }\r\n  };\r\n\r\n  const handleChatPurge = async () => {\r\n    if (!window.confirm(\"Are you sure you want to purge chat?\")) return;\r\n\r\n    try {\r\n      await api.post(api.endpoints.moderation.takeAction, { \r\n        action: 'take_action',\r\n        action_type: 'chat_purge',\r\n        stream_id: roomId,\r\n        reason: 'Manual purge'\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Chat purge failed:\", error);\r\n      alert(\"Failed to purge chat\");\r\n    }\r\n  };\r\n\r\n  const handleDisableStream = async () => {\r\n    const reason = window.prompt(\"Enter stream disable reason:\");\r\n    if (!reason) return;\r\n\r\n    try {\r\n      await api.post(api.endpoints.moderation.takeAction, { \r\n        action: 'take_action',\r\n        action_type: 'suspend_stream',\r\n        stream_id: roomId,\r\n        reason\r\n      });\r\n      room?.disconnect();\r\n    } catch (error) {\r\n      console.error(\"Disable stream failed:\", error);\r\n      alert(\"Failed to disable stream\");\r\n    }\r\n  };\r\n\r\n  const handleCourtSummon = async () => {\r\n    try {\r\n      await api.post(\"/court/summon\", {\r\n        userId: targetUserId,\r\n        fromRoom: roomId\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Court summon failed:\", error);\r\n    }\r\n  };\r\n\r\n  const handleEvidenceCapture = async () => {\r\n    try {\r\n      await api.post(\"/moderation/evidence\", {\r\n        roomId,\r\n        targetUserId,\r\n        timestamp: Date.now()\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Evidence capture failed:\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n    <div onClick={(e) => e.stopPropagation()} className=\"fixed right-4 bottom-24 z-50 w-56\">\r\n      {/* Header */}\r\n      <button\r\n        onClick={() => setOpen(!open)}\r\n        className=\"flex items-center justify-between w-full px-4 py-3 rounded-lg bg-[#1a0f2e] border border-purple-700 text-white shadow-lg\"\r\n      >\r\n        <div className=\"flex items-center gap-2\">\r\n          <Shield size={18} />\r\n          <span className=\"font-semibold\">Moderation</span>\r\n        </div>\r\n        {open ? <ChevronDown size={18} /> : <ChevronRight size={18} />}\r\n      </button>\r\n\r\n      {/* Actions */}\r\n      {open && (\r\n        <div className=\"mt-2 space-y-2 bg-[#0c0818] p-2 rounded-xl border border-purple-800\">\r\n          <Action label=\"Ban User\" color=\"bg-red-700\" onClick={handleBan} />\r\n          <Action label=\"Ban IP Address\" color=\"bg-red-900\" onClick={async () => {\r\n            // Fetch IP first if possible\r\n             const { data } = await supabase\r\n              .from('user_profiles')\r\n              .select('last_known_ip')\r\n              .eq('id', targetUserId)\r\n              .single()\r\n            \r\n            if (data?.last_known_ip) {\r\n              setTargetIP(data.last_known_ip)\r\n            }\r\n            setShowIPBanModal(true)\r\n          }} />\r\n          <Action label=\"Shadow Ban\" color=\"bg-amber-700\" onClick={handleShadowBan} />\r\n          <Action label=\"Kick\" color=\"bg-yellow-600\" onClick={handleKick} />\r\n          <Action label=\"Mute\" color=\"bg-gray-700\" onClick={handleMute} />\r\n          <Action label=\"Gift Freeze\" color=\"bg-fuchsia-700\" onClick={handleGiftFreeze} />\r\n          <Action label=\"Chat Purge\" color=\"bg-blue-700\" onClick={handleChatPurge} />\r\n          <Action label=\"Disable Stream\" color=\"bg-red-900\" onClick={handleDisableStream} />\r\n          <Action label=\"Court Summon\" color=\"bg-purple-700\" onClick={handleCourtSummon} />\r\n          <Action label=\"Evidence Capture\" color=\"bg-emerald-700\" onClick={handleEvidenceCapture} />\r\n        </div>\r\n      )}\r\n    </div>\r\n\r\n    {showIPBanModal && (\r\n      <IPBanModal \r\n        isOpen={showIPBanModal}\r\n        onClose={() => {\r\n          setShowIPBanModal(false);\r\n          setTargetIP(null);\r\n        }}\r\n        onSuccess={() => {\r\n          setShowIPBanModal(false);\r\n          // Optional: disconnect user after IP ban\r\n          room?.disconnectParticipant(targetUserId);\r\n        }}\r\n        targetUserId={targetUserId}\r\n        targetIP={targetIP || undefined}\r\n      />\r\n    )}\r\n    </>\r\n  );\r\n}\r\n\r\nfunction Action({\r\n  label,\r\n  color,\r\n  onClick,\r\n}: {\r\n  label: string;\r\n  color: string;\r\n  onClick: () => void;\r\n}) {\r\n  return (\r\n    <button\r\n      onClick={onClick}\r\n      className={`w-full px-3 py-2 rounded-md text-white text-sm font-medium ${color} hover:opacity-90`}\r\n    >\r\n      {label}\r\n    </button>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\MoneyRain.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\NewUserApplicationModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\OfficerAlertBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\OfficerTierBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\OnboardingWizard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PWAInstallPrompt.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PayoutAdmin.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PayoutHistoryCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PayoutRequest.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PlatformWallet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ProfileSetupModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ProfitSummary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PublicDocketBoard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\PurchaseRequiredModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ReelCommentsOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ReportDetailsModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ReportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\RequestPayoutModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":196,"column":29,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7514,7554],"text":"You don&apos;t have enough coins. Available: "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7514,7554],"text":"You don&lsquo;t have enough coins. Available: "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7514,7554],"text":"You don&#39;t have enough coins. Available: "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7514,7554],"text":"You don&rsquo;t have enough coins. Available: "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react'\r\nimport { supabase, getSystemSettings } from '../lib/supabase'\r\nimport { isPayoutWindowOpen, PAYOUT_WINDOW_LABEL } from '../lib/payoutWindow'\r\nimport { toast } from 'sonner'\r\nimport { X, DollarSign, AlertCircle } from 'lucide-react'\r\nimport { RequestPayoutResponse } from '../types/earnings'\r\n\r\ninterface RequestPayoutModalProps {\r\n  userId: string\r\n  availableCoins: number\r\n  onClose: () => void\r\n  onSuccess: () => void\r\n}\r\n\r\nexport default function RequestPayoutModal({\r\n  userId,\r\n  availableCoins,\r\n  onClose,\r\n  onSuccess\r\n}: RequestPayoutModalProps) {\r\n  const [coinsToRedeem, setCoinsToRedeem] = useState<string>('')\r\n  const [loading, setLoading] = useState(false)\r\n  const payoutWindowOpen = isPayoutWindowOpen()\r\n  const payoutsDisabled = true\r\n\r\n  const MINIMUM_COINS = 7000 // $21 minimum\r\n  // Conversion rate varies by tier: $21/7k = $0.003, $49.50/14k = $0.0035357, $90/27k = $0.00333, $150/47k = $0.00319\r\n  // Using average rate for display purposes\r\n  const CONVERSION_RATE = 0.003 // Approximate rate for display\r\n\r\n  const coinsNum = parseInt(coinsToRedeem, 10) || 0\r\n  const usdAmount = coinsNum * CONVERSION_RATE\r\n  const isValid = coinsNum >= MINIMUM_COINS && coinsNum <= availableCoins\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    \r\n    if (!isValid) {\r\n      toast.error(`Please enter between ${MINIMUM_COINS.toLocaleString()} and ${availableCoins.toLocaleString()} coins`)\r\n      return\r\n    }\r\n\r\n    if (!payoutWindowOpen) {\r\n      toast.error(PAYOUT_WINDOW_LABEL)\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      const s = await getSystemSettings()\r\n      if (s?.payout_lock_enabled) {\r\n        toast.error('Payouts are locked during Launch Trial Mode.')\r\n        setLoading(false)\r\n        return\r\n      }\r\n      // Call RPC function\r\n      const { data, error } = await supabase\r\n        .rpc('request_payout', {\r\n          p_user_id: userId,\r\n          p_coins_to_redeem: coinsNum\r\n        })\r\n\r\n      if (error) throw error\r\n\r\n      const response = data as RequestPayoutResponse\r\n\r\n      if (!response.success) {\r\n        toast.error(response.error || 'Failed to submit payout request')\r\n        return\r\n      }\r\n\r\n      toast.success(`Payout request submitted! ${coinsNum.toLocaleString()} coins = $${usdAmount.toFixed(2)}`)\r\n      onSuccess()\r\n    } catch (err: any) {\r\n      console.error('Payout request error:', err)\r\n      toast.error(err?.message || 'Failed to submit payout request')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  if (payoutsDisabled) {\r\n    return (\r\n      <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n        <div className=\"bg-zinc-900 rounded-xl border border-purple-500/30 max-w-md w-full p-6 relative\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onClose}\r\n            className=\"absolute top-4 right-4 text-gray-400 hover:text-white transition\"\r\n          >\r\n            <X className=\"w-5 h-5\" />\r\n          </button>\r\n          <div className=\"mb-4\">\r\n            <h2 className=\"text-2xl font-bold text-white\">Payouts Unavailable</h2>\r\n            <p className=\"text-sm text-gray-300 mt-2\">\r\n              Cash payouts and gift card cashouts are currently disabled.\r\n            </p>\r\n            <p className=\"text-xs text-gray-500 mt-2\">\r\n              You can still earn and spend coins inside Troll City while payouts are paused.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n      <div className=\"bg-zinc-900 rounded-xl border border-purple-500/30 max-w-md w-full p-6 relative\">\r\n        {/* Close Button */}\r\n        <button\r\n          type=\"button\"\r\n          onClick={onClose}\r\n          className=\"absolute top-4 right-4 text-gray-400 hover:text-white transition\"\r\n        >\r\n          <X className=\"w-5 h-5\" />\r\n        </button>\r\n\r\n        {/* Header */}\r\n        <div className=\"mb-6\">\r\n          <h2 className=\"text-2xl font-bold text-white flex items-center gap-2\">\r\n            <DollarSign className=\"w-6 h-6 text-green-400\" />\r\n            Request Payout\r\n          </h2>\r\n          <p className=\"text-sm text-gray-400 mt-1\">\r\n            Convert your coins to cash\r\n          </p>\r\n          {!payoutWindowOpen && (\r\n            <div className=\"mt-3 rounded-lg border border-yellow-500/40 bg-yellow-900/20 px-3 py-2 text-xs text-yellow-200\">\r\n              {PAYOUT_WINDOW_LABEL}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Available Balance */}\r\n        <div className=\"bg-zinc-800 rounded-lg p-4 mb-4 border border-gray-700\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <span className=\"text-gray-400\">Available Coins:</span>\r\n            <span className=\"text-xl font-bold text-yellow-400\">\r\n              {availableCoins.toLocaleString()}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex justify-between items-center mt-2\">\r\n            <span className=\"text-gray-400\">USD Value:</span>\r\n            <span className=\"text-lg font-semibold text-green-400\">\r\n              ${(availableCoins * CONVERSION_RATE).toFixed(2)}\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Form */}\r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              Coins to Redeem\r\n            </label>\r\n            <input\r\n              type=\"number\"\r\n              min={MINIMUM_COINS}\r\n              max={availableCoins}\r\n              value={coinsToRedeem}\r\n              onChange={(e) => setCoinsToRedeem(e.target.value)}\r\n              placeholder={`Min: ${MINIMUM_COINS.toLocaleString()} coins`}\r\n              className=\"w-full px-4 py-3 bg-zinc-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n              required\r\n            />\r\n            <p className=\"text-xs text-gray-500 mt-1\">\r\n              Minimum: {MINIMUM_COINS.toLocaleString()} coins (${(MINIMUM_COINS * CONVERSION_RATE).toFixed(2)})\r\n            </p>\r\n          </div>\r\n\r\n          {/* Conversion Display */}\r\n          {coinsNum > 0 && (\r\n            <div className=\"bg-purple-900/30 border border-purple-500/30 rounded-lg p-4\">\r\n              <div className=\"flex justify-between items-center mb-2\">\r\n                <span className=\"text-gray-300\">You will receive:</span>\r\n                <span className=\"text-2xl font-bold text-green-400\">\r\n                  ${usdAmount.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <p className=\"text-xs text-gray-400\">\r\n                Conversion rate: 100 coins = $1.00\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Validation Errors */}\r\n          {coinsToRedeem && !isValid && (\r\n            <div className=\"bg-red-900/30 border border-red-500/30 rounded-lg p-3 flex items-start gap-2\">\r\n              <AlertCircle className=\"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5\" />\r\n              <div className=\"text-sm text-red-300\">\r\n                {coinsNum < MINIMUM_COINS && (\r\n                  <p>Minimum withdrawal is {MINIMUM_COINS.toLocaleString()} coins</p>\r\n                )}\r\n                {coinsNum > availableCoins && (\r\n                  <p>You don't have enough coins. Available: {availableCoins.toLocaleString()}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Action Buttons */}\r\n          <div className=\"flex gap-3 pt-4\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              className=\"flex-1 px-4 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg font-semibold transition-colors\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={!isValid || loading || !payoutWindowOpen}\r\n              className=\"flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {loading ? 'Submitting...' : 'Submit Request'}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\RequireRole.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\RequireWeeklyReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\RoyalCoronationAnimation.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":71,"column":27,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[2195,2226],"text":"\r\n              is now Admin&apos;s "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[2195,2226],"text":"\r\n              is now Admin&lsquo;s "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[2195,2226],"text":"\r\n              is now Admin&#39;s "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[2195,2226],"text":"\r\n              is now Admin&rsquo;s "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { Crown, Sparkles, Star } from 'lucide-react'\r\n\r\ninterface RoyalCoronationAnimationProps {\r\n  isVisible: boolean\r\n  titleType: 'wife' | 'husband'\r\n  username: string\r\n  onComplete: () => void\r\n}\r\n\r\nexport default function RoyalCoronationAnimation({\r\n  isVisible,\r\n  titleType,\r\n  username,\r\n  onComplete\r\n}: RoyalCoronationAnimationProps) {\r\n  const [stage, setStage] = useState(0)\r\n  const [showParticles, setShowParticles] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (!isVisible) return\r\n\r\n    // Animation sequence\r\n    const sequence = [\r\n      () => setStage(1), // Crown appears\r\n      () => setStage(2), // Title appears\r\n      () => setShowParticles(true), // Particles start\r\n      () => setStage(3), // Celebration\r\n    ]\r\n\r\n    let currentStep = 0\r\n    const timer = setInterval(() => {\r\n      if (currentStep < sequence.length) {\r\n        sequence[currentStep]()\r\n        currentStep++\r\n      } else {\r\n        // Animation complete\r\n        setTimeout(() => {\r\n          onComplete()\r\n          setStage(0)\r\n          setShowParticles(false)\r\n        }, 2000)\r\n      }\r\n    }, 800) // Each stage lasts 800ms\r\n\r\n    return () => clearInterval(timer)\r\n  }, [isVisible, onComplete])\r\n\r\n  if (!isVisible) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 backdrop-blur-sm\">\r\n      <div className=\"relative text-center\">\r\n        {/* Crown Animation */}\r\n        {stage >= 1 && (\r\n          <div className={`transition-all duration-1000 ${stage >= 2 ? 'scale-110' : 'scale-50'}`}>\r\n            <Crown className=\"w-24 h-24 text-yellow-400 mx-auto mb-4 drop-shadow-2xl animate-bounce\" />\r\n          </div>\r\n        )}\r\n\r\n        {/* Title Text */}\r\n        {stage >= 2 && (\r\n          <div className=\"transition-all duration-1000 opacity-0 animate-fade-in\">\r\n            <h2 className=\"text-4xl font-bold text-yellow-300 mb-2 drop-shadow-lg\">\r\n              üëë Coronation! üëë\r\n            </h2>\r\n            <p className=\"text-2xl text-white font-semibold mb-1\">\r\n              @{username}\r\n            </p>\r\n            <p className=\"text-xl text-yellow-200\">\r\n              is now Admin's {titleType === 'wife' ? 'Wife' : 'Husband'}!\r\n            </p>\r\n          </div>\r\n        )}\r\n\r\n        {/* Particle Effects */}\r\n        {showParticles && (\r\n          <div className=\"absolute inset-0 pointer-events-none\">\r\n            {/* Crown particles */}\r\n            {[...Array(12)].map((_, i) => (\r\n              <div\r\n                key={`crown-${i}`}\r\n                className=\"absolute w-3 h-3 text-yellow-400 animate-ping\"\r\n                style={{\r\n                  top: '20%',\r\n                  left: '50%',\r\n                  transform: `rotate(${i * 30}deg) translateY(-60px)`,\r\n                  animationDelay: `${i * 0.1}s`,\r\n                  animationDuration: '2s'\r\n                }}\r\n              >\r\n                <Crown className=\"w-3 h-3\" />\r\n              </div>\r\n            ))}\r\n\r\n            {/* Sparkle particles */}\r\n            {[...Array(20)].map((_, i) => (\r\n              <div\r\n                key={`sparkle-${i}`}\r\n                className=\"absolute animate-bounce\"\r\n                style={{\r\n                  top: `${30 + Math.random() * 40}%`,\r\n                  left: `${20 + Math.random() * 60}%`,\r\n                  animationDelay: `${Math.random() * 2}s`,\r\n                  animationDuration: `${1 + Math.random()}s`\r\n                }}\r\n              >\r\n                <Sparkles\r\n                  className={`w-4 h-4 ${\r\n                    i % 3 === 0 ? 'text-yellow-400' :\r\n                    i % 3 === 1 ? 'text-pink-400' :\r\n                    'text-purple-400'\r\n                  }`}\r\n                />\r\n              </div>\r\n            ))}\r\n\r\n            {/* Star burst */}\r\n            {stage >= 3 && [...Array(8)].map((_, i) => (\r\n              <div\r\n                key={`star-${i}`}\r\n                className=\"absolute animate-pulse\"\r\n                style={{\r\n                  top: `${40 + Math.sin(i * 45 * Math.PI / 180) * 30}%`,\r\n                  left: `${50 + Math.cos(i * 45 * Math.PI / 180) * 30}%`,\r\n                  animationDelay: `${i * 0.2}s`\r\n                }}\r\n              >\r\n                <Star className=\"w-6 h-6 text-yellow-300 fill-yellow-300\" />\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {/* Celebration Text */}\r\n        {stage >= 3 && (\r\n          <div className=\"mt-8 text-yellow-300 font-bold text-lg animate-pulse\">\r\n            üéâ Long Live the Royal Family! üéâ\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\RoyalCrownOverlay.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":223,"column":20,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7659,7683],"text":"\r\n              Admin&apos;s "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7659,7683],"text":"\r\n              Admin&lsquo;s "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7659,7683],"text":"\r\n              Admin&#39;s "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7659,7683],"text":"\r\n              Admin&rsquo;s "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { Crown, Sparkles } from 'lucide-react'\r\nimport RoyalCoronationAnimation from './RoyalCoronationAnimation'\r\n\r\ninterface RoyalCrownOverlayProps {\r\n  isAdminStream: boolean\r\n  participants: any[]\r\n}\r\n\r\ninterface RoyalFamilyMember {\r\n  user_id: string\r\n  title_type: string\r\n  duration_days: number\r\n  is_active: boolean\r\n}\r\n\r\nexport default function RoyalCrownOverlay({\r\n  isAdminStream,\r\n  participants\r\n}: RoyalCrownOverlayProps) {\r\n  const [royalMember, setRoyalMember] = useState<RoyalFamilyMember | null>(null)\r\n  const [crownLevel, setCrownLevel] = useState(0)\r\n  const [showSparkles, setShowSparkles] = useState(false)\r\n  const [showCoronation, setShowCoronation] = useState(false)\r\n  const [coronationData, setCoronationData] = useState<{\r\n    titleType: 'wife' | 'husband'\r\n    username: string\r\n  } | null>(null)\r\n  const [previousMemberId, setPreviousMemberId] = useState<string | null>(null)\r\n\r\n  const loadRoyalFamilyStatus = useCallback(async () => {\r\n    try {\r\n      const { data, error } = await supabase.rpc('get_royal_family_status')\r\n\r\n      if (error) {\r\n        console.warn('Error loading royal family status:', error)\r\n        return\r\n      }\r\n\r\n      // Find active wife or husband\r\n      const adminData = data?.[0]\r\n      const activeMember = adminData?.current_wife || adminData?.current_husband\r\n\r\n      if (activeMember) {\r\n        const currentMemberId = activeMember.user_id\r\n        const titleType = adminData.current_wife ? 'wife' : 'husband'\r\n\r\n        // Check if this is a new royal family member (coronation)\r\n        if (previousMemberId && previousMemberId !== currentMemberId) {\r\n          // Trigger coronation animation\r\n          setCoronationData({\r\n            titleType: titleType as 'wife' | 'husband',\r\n            username: activeMember.username\r\n          })\r\n          setShowCoronation(true)\r\n        }\r\n\r\n        setPreviousMemberId(currentMemberId)\r\n\r\n        setRoyalMember({\r\n          user_id: currentMemberId,\r\n          title_type: titleType,\r\n          duration_days: activeMember.duration_days || 0,\r\n          is_active: true\r\n        })\r\n\r\n        // Determine crown level based on duration\r\n        const days = activeMember.duration_days || 0\r\n        let level = 0\r\n        if (days >= 90) level = 5 // Imperial Crown\r\n        else if (days >= 60) level = 4 // Regal Crown\r\n        else if (days >= 30) level = 3 // Enhanced Crown\r\n        else if (days >= 14) level = 2 // Decorated Crown\r\n        else if (days >= 7) level = 1 // Base Crown\r\n\r\n        setCrownLevel(level)\r\n\r\n        // Show sparkles occasionally for higher level crowns\r\n        if (level >= 3) {\r\n          const sparkleInterval = setInterval(() => {\r\n            setShowSparkles(true)\r\n            setTimeout(() => setShowSparkles(false), 2000)\r\n          }, 15000) // Every 15 seconds\r\n\r\n          return () => clearInterval(sparkleInterval)\r\n        }\r\n      } else {\r\n        setRoyalMember(null)\r\n        setCrownLevel(0)\r\n        setPreviousMemberId(null)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading royal family status:', error)\r\n    }\r\n  }, [previousMemberId])\r\n\r\n  useEffect(() => {\r\n    if (!isAdminStream) return\r\n    loadRoyalFamilyStatus()\r\n    const interval = setInterval(loadRoyalFamilyStatus, 30000)\r\n    return () => clearInterval(interval)\r\n  }, [isAdminStream, loadRoyalFamilyStatus])\r\n\r\n  // Handle coronation animation completion\r\n  const handleCoronationComplete = () => {\r\n    setShowCoronation(false)\r\n    setCoronationData(null)\r\n  }\r\n\r\n  // Only show crowns in Admin streams\r\n  if (!isAdminStream || !royalMember) {\r\n    return (\r\n      <>\r\n        {/* Show coronation animation even when no crown is displayed */}\r\n        {showCoronation && coronationData && (\r\n          <RoyalCoronationAnimation\r\n            isVisible={showCoronation}\r\n            titleType={coronationData.titleType}\r\n            username={coronationData.username}\r\n            onComplete={handleCoronationComplete}\r\n          />\r\n        )}\r\n      </>\r\n    )\r\n  }\r\n\r\n  // Find the participant who is the royal family member\r\n  const royalParticipant = participants.find(p =>\r\n    p.identity === royalMember.user_id ||\r\n    p.userId === royalMember.user_id\r\n  )\r\n\r\n  if (!royalParticipant) {\r\n    return null\r\n  }\r\n\r\n  const getCrownStyle = () => {\r\n    switch (crownLevel) {\r\n      case 1: // Base Crown (7+ days)\r\n        return {\r\n          icon: <Crown className=\"w-8 h-8 text-yellow-400 drop-shadow-lg\" />,\r\n          glow: 'shadow-yellow-400/50',\r\n          animation: 'animate-pulse'\r\n        }\r\n      case 2: // Decorated Crown (14+ days)\r\n        return {\r\n          icon: <Crown className=\"w-10 h-10 text-yellow-300 drop-shadow-xl\" />,\r\n          glow: 'shadow-yellow-300/60',\r\n          animation: 'animate-pulse'\r\n        }\r\n      case 3: // Enhanced Crown (30+ days)\r\n        return {\r\n          icon: <Crown className=\"w-12 h-12 text-yellow-200 drop-shadow-2xl\" />,\r\n          glow: 'shadow-yellow-200/70',\r\n          animation: 'animate-bounce'\r\n        }\r\n      case 4: // Regal Crown (60+ days)\r\n        return {\r\n          icon: (\r\n            <div className=\"relative\">\r\n              <Crown className=\"w-14 h-14 text-yellow-100 drop-shadow-2xl\" />\r\n              <Sparkles className=\"w-6 h-6 text-blue-300 absolute -top-2 -right-2 animate-ping\" />\r\n            </div>\r\n          ),\r\n          glow: 'shadow-yellow-100/80',\r\n          animation: 'animate-pulse'\r\n        }\r\n      case 5: // Imperial Crown (90+ days)\r\n        return {\r\n          icon: (\r\n            <div className=\"relative\">\r\n              <Crown className=\"w-16 h-16 text-yellow-50 drop-shadow-2xl\" />\r\n              <Sparkles className=\"w-8 h-8 text-purple-300 absolute -top-3 -right-3 animate-ping\" />\r\n              <Sparkles className=\"w-6 h-6 text-pink-300 absolute -bottom-2 -left-2 animate-pulse\" />\r\n            </div>\r\n          ),\r\n          glow: 'shadow-yellow-50/90',\r\n          animation: 'animate-bounce'\r\n        }\r\n      default:\r\n        return {\r\n          icon: <Crown className=\"w-6 h-6 text-yellow-500\" />,\r\n          glow: 'shadow-yellow-500/30',\r\n          animation: ''\r\n        }\r\n    }\r\n  }\r\n\r\n  const crownStyle = getCrownStyle()\r\n\r\n  return (\r\n    <>\r\n      {/* Crown Overlay */}\r\n      <div className=\"absolute top-4 right-4 z-50 pointer-events-none\">\r\n        <div className={`relative ${crownStyle.animation}`}>\r\n          {/* Crown */}\r\n          <div className={`shadow-2xl ${crownStyle.glow} rounded-full p-2 bg-black/20 backdrop-blur-sm`}>\r\n            {crownStyle.icon}\r\n          </div>\r\n\r\n          {/* Sparkle effects for high-level crowns */}\r\n          {showSparkles && crownLevel >= 3 && (\r\n            <div className=\"absolute -inset-4 pointer-events-none\">\r\n              {[...Array(6)].map((_, i) => (\r\n                <div\r\n                  key={i}\r\n                  className=\"absolute w-2 h-2 bg-yellow-300 rounded-full animate-ping\"\r\n                  style={{\r\n                    top: `${Math.random() * 100}%`,\r\n                    left: `${Math.random() * 100}%`,\r\n                    animationDelay: `${i * 0.2}s`,\r\n                    animationDuration: '2s'\r\n                  }}\r\n                />\r\n              ))}\r\n            </div>\r\n          )}\r\n\r\n          {/* Title indicator */}\r\n          <div className=\"absolute -bottom-8 left-1/2 transform -translate-x-1/2\">\r\n            <div className=\"bg-black/70 backdrop-blur-sm rounded-lg px-3 py-1 text-xs font-bold text-yellow-300 whitespace-nowrap border border-yellow-500/30\">\r\n              Admin's {royalMember.title_type === 'wife' ? 'Wife' : 'Husband'}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Coronation Animation */}\r\n      {showCoronation && coronationData && (\r\n        <RoyalCoronationAnimation\r\n          isVisible={showCoronation}\r\n          titleType={coronationData.titleType}\r\n          username={coronationData.username}\r\n          onComplete={handleCoronationComplete}\r\n        />\r\n      )}\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\SendGiftModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ShopConsumablesSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\Sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isCategoryUpdated' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":52,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from 'react'\r\nimport { useLocation, Link } from 'react-router-dom'\r\nimport CourtEntryModal from './CourtEntryModal'\r\nimport SidebarGroup from './ui/SidebarGroup'\r\nimport {\r\n  Home,\r\n  MessageSquare,\r\n  Coins,\r\n  Shield,\r\n  Gavel,\r\n  LayoutDashboard,\r\n  Banknote,\r\n  FileText,\r\n  Store,\r\n  Crown,\r\n  Trophy,\r\n  Package,\r\n  Scale,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  LifeBuoy,\r\n  Shuffle,\r\n  Star,\r\n  Building2,\r\n  RefreshCw,\r\n  Vote,\r\n  TrendingUp,\r\n  Mars,\r\n  Venus,\r\n  Waves,\r\n  Car,\r\n  BookOpen,\r\n  Radio,\r\n  Warehouse,\r\n  Landmark,\r\n  Video,\r\n  Mic\r\n} from 'lucide-react'\r\n\r\nimport { useAuthStore } from '@/lib/store'\r\nimport { supabase, UserRole } from '@/lib/supabase'\r\nimport { useCoins } from '@/lib/hooks/useCoins'\r\nimport { useXPStore } from '@/stores/useXPStore'\r\nimport { useSidebarUpdates } from '@/hooks/useSidebarUpdates'\r\n\r\nimport SidebarTopBroadcasters from './sidebar/SidebarTopBroadcasters'\r\n\r\nexport default function Sidebar() {\r\n  const { profile } = useAuthStore()\r\n  const { level, fetchXP, subscribeToXP, unsubscribe } = useXPStore()\r\n  const { balances, loading } = useCoins()\r\n  const { isUpdated, isCategoryUpdated, markAsViewed } = useSidebarUpdates()\r\n  const location = useLocation()\r\n  const isActive = (path: string) => location.pathname === path\r\n\r\n  // badge placeholder not currently used\r\n\r\n  const [canSeeOfficer, setCanSeeOfficer] = useState(false)\r\n  const [canSeeFamilyLounge, setCanSeeFamilyLounge] = useState(false)\r\n  const [canSeeSecretary, setCanSeeSecretary] = useState(false)\r\n\r\n  const handleClearCacheReload = () => {\r\n    try {\r\n      if (profile?.id) {\r\n        const keysToRemove = [\r\n          `tc-profile-${profile.id}`,\r\n          `trollcity_car_${profile.id}`,\r\n          `trollcity_owned_vehicles_${profile.id}`,\r\n          `trollcity_car_insurance_${profile.id}`,\r\n          `trollcity_vehicle_condition_${profile.id}`,\r\n          `trollcity_home_owned_${profile.id}`\r\n        ]\r\n\r\n        keysToRemove.forEach((key) => localStorage.removeItem(key))\r\n      }\r\n\r\n      localStorage.removeItem('pwa-installed')\r\n      sessionStorage.clear()\r\n    } catch {}\r\n\r\n    window.location.reload()\r\n  }\r\n  const [showCourtModal, setShowCourtModal] = useState(false)\r\n  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false)\r\n\r\n  // Role definitions\r\n  const isAdmin = profile?.role === UserRole.ADMIN || profile?.troll_role === UserRole.ADMIN || profile?.role === UserRole.HR_ADMIN || profile?.is_admin;\r\n  const isSecretary = profile?.role === UserRole.SECRETARY || profile?.troll_role === UserRole.SECRETARY;\r\n  \r\n  const isLead = profile?.role === UserRole.LEAD_TROLL_OFFICER || profile?.is_lead_officer || profile?.troll_role === UserRole.LEAD_TROLL_OFFICER || isAdmin;\r\n  // Officer check matches the logic in useEffect (isAdmin || isOfficer)\r\n  const isOfficer = profile?.role === UserRole.TROLL_OFFICER || profile?.role === UserRole.LEAD_TROLL_OFFICER || profile?.is_lead_officer || profile?.troll_role === UserRole.TROLL_OFFICER || profile?.troll_role === UserRole.LEAD_TROLL_OFFICER || isAdmin;\r\n  const canSeeCourt = isOfficer || isSecretary;\r\n  \r\n  // Check for driver license status\r\n  const needsLicense = useMemo(() => {\r\n    if (!profile) return false\r\n    const status = (profile as any).drivers_license_status\r\n    return !status || status === 'none'\r\n  }, [profile])\r\n\r\n  const hasRgb = useMemo(() => {\r\n    if (!profile?.rgb_username_expires_at) return false\r\n    return new Date(profile.rgb_username_expires_at) > new Date()\r\n  }, [profile?.rgb_username_expires_at])\r\n\r\n  useEffect(() => {\r\n    if (profile?.id) {\r\n        fetchXP(profile.id)\r\n        subscribeToXP(profile.id)\r\n        return () => unsubscribe()\r\n    }\r\n  }, [profile?.id, fetchXP, subscribeToXP, unsubscribe])\r\n\r\n  useEffect(() => {\r\n    const checkAccess = async () => {\r\n      if (!profile) { \r\n        setCanSeeOfficer(false)\r\n        setCanSeeFamilyLounge(false)\r\n        setCanSeeSecretary(false)\r\n        return \r\n      }\r\n      \r\n      // Check Admin for Week\r\n      let activeAdmin = false\r\n      try {\r\n        const { data } = await supabase\r\n            .from('admin_for_week_queue')\r\n            .select('user_id')\r\n            .eq('status', 'active')\r\n            .eq('user_id', profile.id)\r\n            .maybeSingle()\r\n        activeAdmin = !!data\r\n      } catch {}\r\n\r\n      // Troll Officer Lounge: Only admin and troll_officer role (or Admin for Week)\r\n      setCanSeeOfficer(isOfficer || activeAdmin)\r\n\r\n      // Troll Family Lounge: Admin, troll_officer, OR approved family application\r\n      if (isOfficer) { \r\n        setCanSeeFamilyLounge(true)\r\n      } else {\r\n        // Check if user has an approved family application\r\n        try {\r\n          const { data: familyApp } = await supabase\r\n            .from('applications')\r\n            .select('status')\r\n            .eq('user_id', profile.id)\r\n            .eq('type', 'troll_family')\r\n            .eq('status', 'approved')\r\n            .maybeSingle()\r\n\r\n          setCanSeeFamilyLounge(!!familyApp)\r\n        } catch {\r\n          setCanSeeFamilyLounge(false)\r\n        }\r\n      }\r\n\r\n      // Check Secretary Access\r\n      if (isAdmin || isSecretary) {\r\n        setCanSeeSecretary(true)\r\n      } else {\r\n        try {\r\n          const { data: secData } = await supabase\r\n            .from('secretary_assignments')\r\n            .select('id')\r\n            .eq('secretary_id', profile.id)\r\n            .maybeSingle()\r\n          \r\n          setCanSeeSecretary(!!secData)\r\n        } catch {\r\n          setCanSeeSecretary(false)\r\n        }\r\n      }\r\n    }\r\n    checkAccess()\r\n  }, [profile, isOfficer, isAdmin, isSecretary])\r\n\r\n  // Define visible paths for each group to calculate highlights correctly\r\n  const mainPaths = ['/', '/trollstown', '/inventory', '/troting', '/wall', '/marketplace', '/leaderboard', '/credit-scores', '/store', '/creator-switch', '/troll-court']\r\n  \r\n  const supportPaths = ['/support', '/safety']\r\n  \r\n  const socialPaths = ['/tcps', '/pool']\r\n  if (canSeeFamilyLounge) socialPaths.push('/family/lounge')\r\n  \r\n  const specialAccessPaths: string[] = []\r\n  if (canSeeCourt) specialAccessPaths.push('/admin/court-dockets')\r\n  if (canSeeOfficer) specialAccessPaths.push('/officer/dashboard', '/officer/lounge', '/officer/moderation')\r\n  if (isLead) specialAccessPaths.push('/lead-officer')\r\n  if (canSeeSecretary) specialAccessPaths.push('/secretary')\r\n  if (isAdmin) specialAccessPaths.push('/admin/applications')\r\n\r\n  const systemPaths = ['/application', '/interview-room', '/wallet']\r\n\r\n  const isAnyUpdated = (paths: string[]) => paths.some(path => isUpdated(path))\r\n\r\n  if (!profile) return null\r\n\r\n  return (\r\n    <div className={`flex flex-col h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 backdrop-blur-xl border-r border-white/10 shadow-[10px_0_40px_rgba(0,0,0,0.35)] transition-all duration-300 ${isSidebarCollapsed ? 'w-20' : 'w-64'} fixed left-0 top-0 z-50`}>\r\n\r\n      {/* Header */}\r\n      <div className=\"p-4 flex items-center justify-between border-b border-white/5 bg-white/5/10\">\r\n        {!isSidebarCollapsed && (\r\n          <Link to=\"/\" className=\"flex items-center gap-2\">\r\n            <div className=\"w-9 h-9 bg-gradient-to-tr from-purple-600 via-pink-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-[0_10px_30px_rgba(99,102,241,0.35)]\">\r\n              <span className=\"text-xl font-bold text-white\">T</span>\r\n            </div>\r\n            <span className=\"font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-white via-slate-200 to-slate-400\">\r\n              TrollCity\r\n            </span>\r\n          </Link>\r\n        )}\r\n        <button \r\n          onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)}\r\n          className={`p-1.5 hover:bg-white/10 rounded-lg text-gray-300 transition-colors ${isSidebarCollapsed ? 'mx-auto' : ''}`}\r\n        >\r\n          {isSidebarCollapsed ? <ChevronRight size={18} /> : <ChevronLeft size={18} />}\r\n        </button>\r\n      </div>\r\n\r\n      {/* User Profile Summary (Level & XP) */}\r\n      {!isSidebarCollapsed && (\r\n        <div className=\"p-4 border-b border-white/5 bg-white/5 mx-4 mt-4 rounded-2xl shadow-[0_15px_40px_rgba(0,0,0,0.35)]\">\r\n          <div className=\"flex items-center gap-3 mb-3\">\r\n            <div className=\"relative\">\r\n              <img \r\n                src={profile.avatar_url || `https://ui-avatars.com/api/?name=${profile.username}&background=random`} \r\n                alt={profile.username}\r\n                className=\"w-12 h-12 rounded-xl border border-white/15 shadow-[0_10px_30px_rgba(99,102,241,0.3)] object-cover\"\r\n              />\r\n              <div className=\"absolute -bottom-1.5 -right-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-slate-900 shadow-[0_0_10px_rgba(59,130,246,0.35)]\">\r\n                {level}\r\n              </div>\r\n            </div>\r\n            <div className=\"flex-1 min-w-0\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <h3 className={`font-semibold text-sm truncate text-slate-50 ${hasRgb ? 'rgb-username' : ''}`}>{profile.username}</h3>\r\n                {(profile as any).gender === 'male' && (\r\n                  <Mars size={14} className=\"text-blue-400\" />\r\n                )}\r\n                {(profile as any).gender === 'female' && (\r\n                  <Venus size={14} className=\"text-pink-400\" />\r\n                )}\r\n                <button\r\n                  onClick={handleClearCacheReload}\r\n                  className=\"p-1 rounded-md bg-white/10 hover:bg-white/20 text-gray-200\"\r\n                  aria-label=\"Clear cache and reload\"\r\n                  title=\"Clear cache and reload\"\r\n                >\r\n                  <RefreshCw size={12} />\r\n                </button>\r\n              </div>\r\n              <div className=\"flex items-center gap-2 text-xs text-gray-400\">\r\n                <span className=\"px-2 py-0.5 rounded-full bg-white/5 text-purple-200 border border-white/10\">{profile.role === 'admin' ? 'Admin' : (profile.title || 'Citizen')}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Level Progress Bar */}\r\n          <div className=\"space-y-1\">\r\n            <div className=\"flex justify-between text-[10px] text-gray-400\">\r\n              <span>Level Progress</span>\r\n              <span>{level} ‚Üí {level + 1}</span>\r\n            </div>\r\n            <div className=\"h-2 bg-slate-900/70 rounded-full overflow-hidden border border-white/10\">\r\n              <div \r\n                className=\"h-full bg-gradient-to-r from-purple-500 via-pink-500 to-cyan-400 rounded-full shadow-[0_0_20px_rgba(59,130,246,0.45)]\"\r\n                style={{ width: `${Math.min((level / (level + 1)) * 100, 100)}%` }}\r\n              ></div>\r\n            </div>\r\n            <div className=\"text-[9px] text-gray-500 text-right\">\r\n                {Math.round((level / (level + 1)) * 100)}% to next level\r\n            </div>\r\n          </div>\r\n\r\n          {/* Currency */}\r\n          <div className=\"flex items-center gap-4 mt-3 pt-3 border-t border-white/10\">\r\n            <div className=\"flex items-center gap-1.5 text-xs text-yellow-300 bg-white/5 px-2 py-1 rounded-lg border border-white/10\">\r\n                <Coins size={14} />\r\n                <span>{loading ? '...' : balances.troll_coins.toLocaleString()}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-1.5 text-xs text-blue-200 bg-white/5 px-2 py-1 rounded-lg border border-white/10\">\r\n                <Crown size={14} />\r\n                <span>{profile.perk_tokens || 0}</span>\r\n              </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Navigation */}\r\n      <div className=\"flex-1 overflow-y-auto py-4 space-y-6 custom-scrollbar min-h-0\">\r\n        \r\n        {/* Top Broadcasters */}\r\n        <SidebarTopBroadcasters isCollapsed={isSidebarCollapsed} />\r\n\r\n        {/* Main Group */}\r\n        <SidebarGroup title={isSidebarCollapsed ? '' : \"City Center\"} isCollapsed={isSidebarCollapsed} highlight={isAnyUpdated(mainPaths)}>\r\n          <SidebarItem icon={Home} label=\"Home\" to=\"/\" active={isActive('/')} collapsed={isSidebarCollapsed} highlight={isUpdated('/')} onClick={() => markAsViewed('/')} />\r\n          <SidebarItem icon={Building2} label=\"Troll Town\" to=\"/trollstown\" active={isActive('/trollstown')} collapsed={isSidebarCollapsed} highlight={isUpdated('/trollstown')} onClick={() => markAsViewed('/trollstown')} />\r\n          <SidebarItem icon={Landmark} label=\"City Hall\" to=\"/city-hall\" active={isActive('/city-hall')} collapsed={isSidebarCollapsed} highlight={isUpdated('/city-hall')} onClick={() => markAsViewed('/city-hall')} />\r\n          <SidebarItem icon={Warehouse} label=\"Living\" to=\"/living\" active={isActive('/living')} collapsed={isSidebarCollapsed} highlight={isUpdated('/living')} onClick={() => markAsViewed('/living')} />\r\n          <SidebarItem icon={Package} label=\"Inventory\" to=\"/inventory\" active={isActive('/inventory')} collapsed={isSidebarCollapsed} highlight={isUpdated('/inventory')} onClick={() => markAsViewed('/inventory')} />\r\n          <SidebarItem icon={Vote} label=\"Troting\" to=\"/troting\" active={isActive('/troting')} collapsed={isSidebarCollapsed} highlight={isUpdated('/troting')} onClick={() => markAsViewed('/troting')} />\r\n          <SidebarItem icon={FileText} label=\"The Wall\" to=\"/wall\" active={isActive('/wall')} collapsed={isSidebarCollapsed} highlight={isUpdated('/wall')} onClick={() => markAsViewed('/wall')} />\r\n          <SidebarItem icon={Store} label=\"Marketplace\" to=\"/marketplace\" active={isActive('/marketplace')} collapsed={isSidebarCollapsed} highlight={isUpdated('/marketplace')} onClick={() => markAsViewed('/marketplace')} />\r\n          <SidebarItem icon={Trophy} label=\"Leaderboard\" to=\"/leaderboard\" active={isActive('/leaderboard')} collapsed={isSidebarCollapsed} highlight={isUpdated('/leaderboard')} onClick={() => markAsViewed('/leaderboard')} />\r\n          <SidebarItem icon={TrendingUp} label=\"Credit Scores\" to=\"/credit-scores\" active={isActive('/credit-scores')} collapsed={isSidebarCollapsed} highlight={isUpdated('/credit-scores')} onClick={() => markAsViewed('/credit-scores')} />\r\n          <SidebarItem icon={Coins} label=\"Coin Store\" to=\"/store\" active={isActive('/store')} collapsed={isSidebarCollapsed} highlight={isUpdated('/store')} onClick={() => markAsViewed('/store')} />\r\n          <SidebarItem icon={Shuffle} label=\"Creator Switch\" to=\"/creator-switch\" active={isActive('/creator-switch')} collapsed={isSidebarCollapsed} highlight={isUpdated('/creator-switch')} onClick={() => markAsViewed('/creator-switch')} />\r\n          <SidebarItem icon={Scale} label=\"Troll Court\" to=\"/troll-court\" active={isActive('/troll-court')} collapsed={isSidebarCollapsed} highlight={isUpdated('/troll-court')} onClick={() => markAsViewed('/troll-court')} />\r\n        </SidebarGroup>\r\n\r\n\r\n\r\n        {/* Support & Safety */}\r\n        <SidebarGroup title={isSidebarCollapsed ? '' : \"Public Services\"} isCollapsed={isSidebarCollapsed} highlight={isAnyUpdated(supportPaths)}>\r\n          <SidebarItem icon={BookOpen} label=\"Troll Church\" to=\"/church\" active={isActive('/church')} collapsed={isSidebarCollapsed} highlight={isUpdated('/church')} onClick={() => markAsViewed('/church')} />\r\n          {/* Pastor Dashboard - Visible to Pastors/Admins */}\r\n          {((profile as any)?.is_pastor || profile?.role === 'admin' || (profile as any)?.is_admin) && (\r\n            <SidebarItem \r\n              icon={LayoutDashboard} \r\n              label=\"Pastor Dashboard\" \r\n              to=\"/church/pastor\" \r\n              active={isActive('/church/pastor')} \r\n              collapsed={isSidebarCollapsed} \r\n              className=\"text-purple-400 hover:text-purple-300\"\r\n            />\r\n          )}\r\n          <SidebarItem icon={Car} label=\"TMV\" to=\"/tmv\" active={isActive('/tmv')} collapsed={isSidebarCollapsed} highlight={isUpdated('/tmv') || needsLicense} onClick={() => markAsViewed('/tmv')} />\r\n          <SidebarItem icon={LifeBuoy} label=\"Support\" to=\"/support\" active={isActive('/support')} collapsed={isSidebarCollapsed} highlight={isUpdated('/support')} onClick={() => markAsViewed('/support')} />\r\n          <SidebarItem icon={Shield} label=\"Safety\" to=\"/safety\" active={isActive('/safety')} collapsed={isSidebarCollapsed} highlight={isUpdated('/safety')} onClick={() => markAsViewed('/safety')} />\r\n        </SidebarGroup>\r\n\r\n        {/* Social */}\r\n        <SidebarGroup title={isSidebarCollapsed ? '' : \"Social\"} isCollapsed={isSidebarCollapsed} highlight={isAnyUpdated(socialPaths)}>\r\n          <SidebarItem icon={MessageSquare} label=\"Troll City Postal Service\" to=\"/tcps\" active={isActive('/tcps') || isActive('/messages')} collapsed={isSidebarCollapsed} highlight={isUpdated('/tcps')} onClick={() => markAsViewed('/tcps')} />\r\n          <SidebarItem \r\n            icon={Mic} \r\n            label=\"Troll Pods\" \r\n            to=\"/pods\" \r\n            active={isActive('/pods')} \r\n            collapsed={isSidebarCollapsed}\r\n            highlight={isUpdated('/pods')} onClick={() => markAsViewed('/pods')}\r\n            className=\"text-purple-400 hover:text-purple-300\"\r\n          />\r\n          <SidebarItem \r\n            icon={Mic} \r\n            label=\"Mai Talent\" \r\n            to=\"/social/mai-talent\" \r\n            active={isActive('/social/mai-talent')} \r\n            collapsed={isSidebarCollapsed}\r\n            highlight={isUpdated('/social/mai-talent')} onClick={() => markAsViewed('/social/mai-talent')}\r\n            className=\"text-pink-400 hover:text-pink-300\"\r\n          />\r\n          <SidebarItem \r\n            icon={Waves} \r\n            label=\"Public Pool\" \r\n            to=\"/pool\" \r\n            active={isActive('/pool')} \r\n            collapsed={isSidebarCollapsed}\r\n            highlight={isUpdated('/pool')} onClick={() => markAsViewed('/pool')}\r\n            className=\"text-cyan-400 hover:text-cyan-300\"\r\n          />\r\n          {canSeeFamilyLounge && (\r\n            <SidebarItem \r\n              icon={Crown} \r\n              label=\"Family Lounge\" \r\n              to=\"/family/lounge\" \r\n              active={location.pathname.startsWith('/family')} \r\n              collapsed={isSidebarCollapsed}\r\n              highlight={isUpdated('/family/lounge')} onClick={() => markAsViewed('/family/lounge')}\r\n              className=\"text-amber-400 hover:text-amber-300\"\r\n            />\r\n          )}\r\n        </SidebarGroup>\r\n\r\n        {/* Special Access */}\r\n        {(canSeeOfficer || canSeeFamilyLounge || canSeeSecretary || canSeeCourt) && (\r\n          <SidebarGroup title={isSidebarCollapsed ? '' : \"Government Sector\"} isCollapsed={isSidebarCollapsed} highlight={isAnyUpdated(specialAccessPaths)}>\r\n             {(canSeeOfficer || canSeeSecretary) && (\r\n              <SidebarItem \r\n                icon={Radio} \r\n                label=\"Streams\" \r\n                to=\"/government/streams\" \r\n                active={location.pathname.startsWith('/government/streams')} \r\n                collapsed={isSidebarCollapsed}\r\n                highlight={isUpdated('/government/streams')} onClick={() => markAsViewed('/government/streams')}\r\n                className=\"text-red-400 hover:text-red-300\"\r\n              />\r\n            )}\r\n            {canSeeCourt && (\r\n              <SidebarItem \r\n                icon={Gavel} \r\n                label=\"Court Dockets\" \r\n                to=\"/admin/court-dockets\" \r\n                active={location.pathname.startsWith('/admin/court-dockets')} \r\n                collapsed={isSidebarCollapsed}\r\n                highlight={isUpdated('/admin/court-dockets')} onClick={() => markAsViewed('/admin/court-dockets')}\r\n                className=\"text-orange-400 hover:text-orange-300\"\r\n              />\r\n            )}\r\n            {canSeeOfficer && (\r\n              <>\r\n                <SidebarItem \r\n                  icon={LayoutDashboard} \r\n                  label=\"Officer Dashboard\" \r\n                  to=\"/officer/dashboard\" \r\n                  active={location.pathname.startsWith('/officer/dashboard')} \r\n                  collapsed={isSidebarCollapsed}\r\n                  highlight={isUpdated('/officer/dashboard')} onClick={() => markAsViewed('/officer/dashboard')}\r\n                  className=\"text-emerald-400 hover:text-emerald-300\"\r\n                />\r\n                <SidebarItem \r\n                  icon={Shield} \r\n                  label=\"Officer Lounge\" \r\n                  to=\"/officer/lounge\" \r\n                  active={location.pathname.startsWith('/officer/lounge')} \r\n                  collapsed={isSidebarCollapsed}\r\n                  highlight={isUpdated('/officer/lounge')} onClick={() => markAsViewed('/officer/lounge')}\r\n                  className=\"text-purple-400 hover:text-purple-300\"\r\n                />\r\n                <SidebarItem \r\n                  icon={Shield} \r\n                  label=\"Officer Moderation\" \r\n                  to=\"/officer/moderation\" \r\n                  active={location.pathname.startsWith('/officer/moderation')} \r\n                  collapsed={isSidebarCollapsed}\r\n                  highlight={isUpdated('/officer/moderation')} onClick={() => markAsViewed('/officer/moderation')}\r\n                  className=\"text-blue-400 hover:text-blue-300\"\r\n                />\r\n              </>\r\n            )}\r\n            {isLead && (\r\n              <SidebarItem \r\n                icon={Star} \r\n                label=\"Lead HQ\" \r\n                to=\"/lead-officer\" \r\n                active={location.pathname.startsWith('/lead-officer')} \r\n                collapsed={isSidebarCollapsed}\r\n                highlight={isUpdated('/lead-officer')} onClick={() => markAsViewed('/lead-officer')}\r\n                className=\"text-yellow-400 hover:text-yellow-300\"\r\n              />\r\n            )}\r\n            {canSeeSecretary && (\r\n               <SidebarItem \r\n                  icon={LayoutDashboard} \r\n                  label=\"Secretary Console\" \r\n                  to=\"/secretary\" \r\n                  active={location.pathname.startsWith('/secretary')} \r\n                  collapsed={isSidebarCollapsed}\r\n                  highlight={isUpdated('/secretary')} onClick={() => markAsViewed('/secretary')}\r\n                  className=\"text-pink-400 hover:text-pink-300\"\r\n                />\r\n            )}\r\n            {isAdmin && (\r\n               <SidebarItem \r\n                  icon={FileText} \r\n                  label=\"Review Applications\" \r\n                  to=\"/admin/applications\" \r\n                  active={location.pathname.startsWith('/admin/applications')} \r\n                  collapsed={isSidebarCollapsed}\r\n                  highlight={isUpdated('/admin/applications')} onClick={() => markAsViewed('/admin/applications')}\r\n                  className=\"text-red-400 hover:text-red-300\"\r\n                />\r\n            )}\r\n          </SidebarGroup>\r\n        )}\r\n\r\n        {/* System */}\r\n        <SidebarGroup title={isSidebarCollapsed ? '' : \"City Registry\"} isCollapsed={isSidebarCollapsed} highlight={isAnyUpdated(systemPaths)}>\r\n          <SidebarItem icon={FileText} label=\"Careers\" to=\"/application\" active={isActive('/application')} collapsed={isSidebarCollapsed} highlight={isUpdated('/application')} onClick={() => markAsViewed('/application')} />\r\n          <SidebarItem icon={Video} label=\"Interview Room\" to=\"/interview-room\" active={isActive('/interview-room')} collapsed={isSidebarCollapsed} highlight={isUpdated('/interview-room')} onClick={() => markAsViewed('/interview-room')} />\r\n          <SidebarItem icon={Banknote} label=\"Wallet\" to=\"/wallet\" active={isActive('/wallet')} collapsed={isSidebarCollapsed} highlight={isUpdated('/wallet')} onClick={() => markAsViewed('/wallet')} />\r\n        </SidebarGroup>\r\n      </div>\r\n\r\n      {/* Footer Actions */}\r\n      <div className=\"p-4 border-t border-white/10 space-y-2\">\r\n        <Link \r\n          to=\"/stats\"\r\n          className={`flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/5 text-gray-400 transition-colors ${isSidebarCollapsed ? 'justify-center' : ''}`}\r\n        >\r\n          <LayoutDashboard size={20} />\r\n          {!isSidebarCollapsed && <span className=\"text-sm font-medium\">Stats</span>}\r\n        </Link>\r\n      </div>\r\n\r\n      {/* Modals */}\r\n      {showCourtModal && <CourtEntryModal isOpen={true} onClose={() => setShowCourtModal(false)} />}\r\n    </div>\r\n  )\r\n}\r\n\r\n// Helper Component for Sidebar Items\r\nfunction SidebarItem({ \r\n  icon: Icon, \r\n  label, \r\n  to, \r\n  active, \r\n  collapsed, \r\n  badge, \r\n  highlight,\r\n  onClick,\r\n  className = '' \r\n}: { \r\n  icon: any, \r\n  label: string, \r\n  to: string, \r\n  active: boolean, \r\n  collapsed: boolean, \r\n  badge?: string, \r\n  highlight?: boolean,\r\n  onClick?: () => void,\r\n  className?: string \r\n}) {\r\n  return (\r\n    <Link\r\n      to={to}\r\n      onClick={onClick}\r\n      className={`\r\n        relative z-0 \r\n        flex items-center gap-3 px-4 py-2 mx-2 rounded-xl transition-all duration-200 group\r\n        sidebar-item-rgb\r\n        ${active ? 'active-rgb' : ''}\r\n        ${highlight && !active ? 'text-white bg-gradient-to-r from-red-500/20 via-green-500/20 to-blue-500/20 border border-white/30 shadow-[0_0_15px_rgba(255,255,255,0.3)] animate-pulse' : ''}\r\n        ${!active && !highlight ? 'text-gray-300 border border-transparent' : ''}\r\n        ${collapsed ? 'justify-center px-2' : ''}\r\n        ${className}\r\n      `}\r\n      title={collapsed ? label : undefined}\r\n    >\r\n      <span className={`absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1 rounded-full bg-gradient-to-b from-purple-500 to-cyan-400 ${active ? 'opacity-100' : 'opacity-0'} transition-opacity duration-200`} />\r\n      <Icon size={20} className={`min-w-[20px] ${active ? 'text-purple-200' : highlight ? 'text-white drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]' : 'group-hover:text-white'}`} />\r\n      \r\n      {!collapsed && (\r\n        <div className=\"flex items-center justify-between flex-1 min-w-0\">\r\n          <span className=\"text-sm font-medium truncate\">{label}</span>\r\n          {badge && (\r\n            <span className=\"px-1.5 py-0.5 text-[10px] font-bold bg-purple-600 text-white rounded-full\">\r\n              {badge}\r\n            </span>\r\n          )}\r\n          {highlight && !badge && (\r\n            <span className=\"w-2 h-2 rounded-full bg-gradient-to-r from-red-500 via-green-500 to-blue-500 shadow-[0_0_8px_rgba(255,255,255,0.8)] animate-pulse\" />\r\n          )}\r\n        </div>\r\n      )}\r\n      \r\n      {collapsed && (badge || highlight) && (\r\n        <div className={`absolute top-0 right-0 w-2 h-2 rounded-full ${highlight ? 'bg-gradient-to-r from-red-500 via-green-500 to-blue-500 shadow-[0_0_8px_rgba(255,255,255,0.8)]' : 'bg-purple-600'}`}></div>\r\n      )}\r\n    </Link>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\StreamDiagnostics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\SummonModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TaxBlocker.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":21,"column":16,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[669,732],"text":"\r\n            You&apos;ve earned over $600 this year! üéâ\r\n          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[669,732],"text":"\r\n            You&lsquo;ve earned over $600 this year! üéâ\r\n          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[669,732],"text":"\r\n            You&#39;ve earned over $600 this year! üéâ\r\n          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[669,732],"text":"\r\n            You&rsquo;ve earned over $600 this year! üéâ\r\n          "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useNavigate } from 'react-router-dom'\r\nimport { AlertTriangle, FileText } from 'lucide-react'\r\n\r\ninterface TaxBlockerProps {\r\n  taxStatus: string | null | undefined\r\n}\r\n\r\nexport default function TaxBlocker({ taxStatus }: TaxBlockerProps) {\r\n  const navigate = useNavigate()\r\n\r\n  if (taxStatus !== 'required') {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <div className=\"rounded-lg p-4 bg-red-900/30 border border-red-600 text-red-300 mb-6\">\r\n      <div className=\"flex items-start gap-3\">\r\n        <AlertTriangle className=\"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5\" />\r\n        <div className=\"flex-1\">\r\n          <p className=\"font-semibold text-red-300 mb-1\">\r\n            You've earned over $600 this year! üéâ\r\n          </p>\r\n          <p className=\"text-sm text-red-200 mb-3\">\r\n            To continue cashing out, you must submit a W-9 form for tax compliance.\r\n          </p>\r\n          <button\r\n            onClick={() => navigate('/tax/upload')}\r\n            className=\"px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors flex items-center gap-2\"\r\n          >\r\n            <FileText className=\"w-4 h-4\" />\r\n            Submit Tax Form\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TestingModeControl.tsx","messages":[{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'jsx' found","line":115,"column":14,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":115,"endColumn":17},{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'global' found","line":115,"column":18,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":115,"endColumn":24}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport api from '../lib/api'\r\nimport { toast } from 'sonner'\r\nimport { TestTube, Users, RotateCcw, Power, PowerOff, Info } from 'lucide-react'\r\n\r\ninterface TestingModeData {\r\n  enabled: boolean\r\n  signup_limit: number\r\n  current_signups: number\r\n}\r\n\r\ninterface Benefits {\r\n  free_coins: number\r\n  bypass_family_fee: boolean\r\n  bypass_admin_message_fee: boolean\r\n}\r\n\r\nexport function TestingModeControl() {\r\n  const [testingMode, setTestingMode] = useState<TestingModeData>({\r\n    enabled: false,\r\n    signup_limit: 15,\r\n    current_signups: 0\r\n  })\r\n  const [benefits, setBenefits] = useState<Benefits>({\r\n    free_coins: 5000,\r\n    bypass_family_fee: true,\r\n    bypass_admin_message_fee: true\r\n  })\r\n  const [actualTestUsers, setActualTestUsers] = useState(0)\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  const fetchStatus = async () => {\r\n    try {\r\n      const { data: { session } } = await supabase.auth.getSession()\r\n      if (!session?.access_token) return\r\n\r\n      const data = await api.post('/admin', { action: 'testing-mode', command: 'status' })\r\n      if (data.success) {\r\n        setTestingMode(data.testingMode)\r\n        setBenefits(data.benefits)\r\n        setActualTestUsers(data.actualTestUsers)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching testing mode status:', error)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    fetchStatus()\r\n    const interval = setInterval(fetchStatus, 10000)\r\n    return () => clearInterval(interval)\r\n  }, [])\r\n\r\n  const toggleTestingMode = async (enabled: boolean, resetCounter: boolean = false) => {\r\n    setLoading(true)\r\n    try {\r\n      const { data: { session } } = await supabase.auth.getSession()\r\n      if (!session?.access_token) {\r\n        toast.error('Not authenticated')\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      const data = await api.post('/admin', { action: 'testing-mode', command: 'toggle', enabled, resetCounter })\r\n      \r\n      if (data.success && data.testingMode) {\r\n        setTestingMode(data.testingMode)\r\n        toast.success(`Testing mode ${enabled ? 'enabled' : 'disabled'}${resetCounter ? ' and counter reset' : ''}`)\r\n      } else if (data.success) {\r\n        await fetchStatus()\r\n        toast.success(`Testing mode ${enabled ? 'enabled' : 'disabled'}${resetCounter ? ' and counter reset' : ''}`)\r\n      } else {\r\n        const errorMsg = data.error || 'Failed to toggle testing mode'\r\n        console.error('Toggle testing mode error:', errorMsg, data)\r\n        toast.error(errorMsg)\r\n        await fetchStatus()\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Toggle testing mode exception:', error)\r\n      toast.error(error.message || 'Failed to toggle testing mode')\r\n      await fetchStatus()\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const resetCounter = async () => {\r\n    setLoading(true)\r\n    try {\r\n      const { data: { session } } = await supabase.auth.getSession()\r\n      if (!session?.access_token) {\r\n        toast.error('Not authenticated')\r\n        return\r\n      }\r\n\r\n      const data = await api.post('/admin', { action: 'testing-mode', command: 'reset' })\r\n      if (data.success) {\r\n        setTestingMode(data.testingMode)\r\n        toast.success('Signup counter reset to 0')\r\n      }\r\n    } catch (error: any) {\r\n      toast.error(error.message || 'Failed to reset counter')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const signupsRemaining = testingMode.signup_limit - testingMode.current_signups\r\n  const progressPercent = (testingMode.current_signups / testingMode.signup_limit) * 100\r\n\r\n  return (\r\n    <div className=\"bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-xl p-6 border border-purple-500/30\">\r\n      {/* @ts-expect-error: styled-jsx global support */}\r\n      <style jsx global>{`\r\n        .purple-neon {\r\n          border: 2px solid #A78BFA;\r\n          box-shadow: 0 0 15px rgba(167, 139, 250, 0.6), inset 0 0 15px rgba(167, 139, 250, 0.2);\r\n        }\r\n      `}</style>\r\n      \r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <TestTube className=\"w-6 h-6 text-purple-400\" />\r\n          <h2 className=\"text-xl font-bold text-white\">Testing Mode Control</h2>\r\n        </div>\r\n        <div className={`px-3 py-1 rounded-full text-sm font-medium ${\r\n          testingMode.enabled \r\n            ? 'bg-green-500/20 text-green-400 border border-green-500/30' \r\n            : 'bg-gray-500/20 text-gray-400 border border-gray-500/30'\r\n        }`}>\r\n          {testingMode.enabled ? 'ACTIVE' : 'INACTIVE'}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Status Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\r\n        <div className=\"bg-purple-500/10 rounded-lg p-4 border border-purple-500/30 purple-neon\">\r\n          <div className=\"flex items-center gap-2 mb-2\">\r\n            <Users className=\"w-4 h-4 text-purple-400\" />\r\n            <p className=\"text-sm text-gray-400\">Signups</p>\r\n          </div>\r\n          <p className=\"text-2xl font-bold text-white\">\r\n            {testingMode.current_signups} / {testingMode.signup_limit}\r\n          </p>\r\n          <div className=\"mt-2 h-2 bg-gray-700 rounded-full overflow-hidden\">\r\n            <div \r\n              className=\"h-full bg-purple-500 transition-all duration-300\"\r\n              style={{ width: `${Math.min(progressPercent, 100)}%` }}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-pink-500/10 rounded-lg p-4 border border-pink-500/30 purple-neon\">\r\n          <div className=\"flex items-center gap-2 mb-2\">\r\n            <TestTube className=\"w-4 h-4 text-pink-400\" />\r\n            <p className=\"text-sm text-gray-400\">Test Users</p>\r\n          </div>\r\n          <p className=\"text-2xl font-bold text-white\">{actualTestUsers}</p>\r\n          <p className=\"text-xs text-gray-400 mt-1\">Actual count in database</p>\r\n        </div>\r\n\r\n        <div className=\"bg-purple-500/10 rounded-lg p-4 border border-purple-500/30 purple-neon\">\r\n          <div className=\"flex items-center gap-2 mb-2\">\r\n            <Info className=\"w-4 h-4 text-purple-400\" />\r\n            <p className=\"text-sm text-gray-400\">Remaining</p>\r\n          </div>\r\n          <p className=\"text-2xl font-bold text-white\">\r\n            {testingMode.enabled ? Math.max(0, signupsRemaining) : '‚àû'}\r\n          </p>\r\n          <p className=\"text-xs text-gray-400 mt-1\">\r\n            {testingMode.enabled ? 'slots available' : 'unlimited signups'}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Benefits Info */}\r\n      <div className=\"bg-purple-500/10 rounded-lg p-4 border border-purple-500/30 purple-neon mb-6\">\r\n        <h3 className=\"text-sm font-semibold text-purple-400 mb-2\">Test User Benefits:</h3>\r\n        <ul className=\"text-sm text-gray-300 space-y-1\">\r\n          <li>‚Ä¢ {benefits.free_coins.toLocaleString()} free coins on signup</li>\r\n          <li>‚Ä¢ {benefits.bypass_family_fee ? 'No fee' : 'Fee required'} for Troll Family applications</li>\r\n          <li>‚Ä¢ {benefits.bypass_admin_message_fee ? 'Free' : 'Paid'} admin messaging</li>\r\n          <li>‚Ä¢ Admin searchable by @admin username</li>\r\n        </ul>\r\n      </div>\r\n\r\n      {/* Control Buttons */}\r\n      <div className=\"flex flex-wrap gap-3\">\r\n        {!testingMode.enabled ? (\r\n          <button\r\n            onClick={() => toggleTestingMode(true, true)}\r\n            disabled={loading}\r\n            className=\"flex-1 min-w-[200px] px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2 purple-neon\"\r\n          >\r\n            <Power className=\"w-4 h-4\" />\r\n            Enable Testing Mode\r\n          </button>\r\n        ) : (\r\n          <button\r\n            onClick={() => toggleTestingMode(false, false)}\r\n            disabled={loading}\r\n            className=\"flex-1 min-w-[200px] px-4 py-3 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2 purple-neon\"\r\n          >\r\n            <PowerOff className=\"w-4 h-4\" />\r\n            Disable Testing Mode\r\n          </button>\r\n        )}\r\n\r\n        <button\r\n          onClick={resetCounter}\r\n          disabled={loading || !testingMode.enabled}\r\n          className=\"px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2 purple-neon\"\r\n        >\r\n          <RotateCcw className=\"w-4 h-4\" />\r\n          Reset Counter\r\n        </button>\r\n      </div>\r\n\r\n      {testingMode.enabled && signupsRemaining === 0 && (\r\n        <div className=\"mt-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg\">\r\n          <p className=\"text-red-400 text-sm font-medium\">\r\n            ‚ö†Ô∏è Signup limit reached! New signups are currently blocked.\r\n          </p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TitleDeedModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useState' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useState"},"fix":{"range":[12,26],"text":""},"desc":"Remove unused variable \"useState\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { X, Car, Home, Calendar, User, Tag, FileText } from 'lucide-react';\r\n\r\ninterface TitleDeedModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  item: {\r\n    type: 'title' | 'deed';\r\n    id: string;\r\n    name?: string;\r\n    description?: string;\r\n    owner?: string;\r\n    purchased_at?: string;\r\n    issue_date?: string;\r\n    current_value?: number;\r\n    car_id?: string;\r\n    address?: string;\r\n    rent_amount?: number;\r\n    serial_id?: string;\r\n    rarity?: string;\r\n    metadata?: Record<string, any>;\r\n    carDef?: {\r\n      name: string;\r\n      price: number;\r\n      description?: string;\r\n    };\r\n  } | null;\r\n}\r\n\r\nexport default function TitleDeedModal({ isOpen, onClose, item }: TitleDeedModalProps) {\r\n  if (!isOpen || !item) return null;\r\n\r\n  const isTitle = item.type === 'title';\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm\">\r\n      <div className={`bg-zinc-900 border rounded-2xl w-full max-w-lg overflow-hidden relative ${\r\n        isTitle ? 'border-emerald-500/30' : 'border-amber-500/30'\r\n      }`}>\r\n        <button \r\n          onClick={onClose} \r\n          className=\"absolute top-3 right-3 text-zinc-400 hover:text-white p-2 rounded-lg hover:bg-zinc-800 transition-colors\"\r\n        >\r\n          <X className=\"w-5 h-5\" />\r\n        </button>\r\n        \r\n        {/* Header */}\r\n        <div className={`p-6 border-b ${isTitle ? 'bg-emerald-900/20 border-emerald-500/20' : 'bg-amber-900/20 border-amber-500/20'}`}>\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            {isTitle ? (\r\n              <Car className=\"w-8 h-8 text-emerald-400\" />\r\n            ) : (\r\n              <Home className=\"w-8 h-8 text-amber-400\" />\r\n            )}\r\n            <div>\r\n              <h2 className=\"text-xl font-bold text-white\">\r\n                {isTitle ? 'Vehicle Title' : 'Property Deed'}\r\n              </h2>\r\n              <p className=\"text-xs text-zinc-400 uppercase tracking-wider\">\r\n                Official {isTitle ? 'Troll City' : 'Troll City'} Document\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"p-6 space-y-4\">\r\n          {/* Item Name */}\r\n          <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n            <div className=\"flex items-center gap-2 mb-1\">\r\n              <Tag className=\"w-4 h-4 text-zinc-400\" />\r\n              <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Item Name</span>\r\n            </div>\r\n            <p className=\"text-lg font-bold text-white\">\r\n              {item.name || (isTitle ? item.carDef?.name : `Property #${item.id.slice(0, 8)}`)}\r\n            </p>\r\n          </div>\r\n\r\n          {/* Description */}\r\n          {item.description || item.carDef?.description && (\r\n            <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n              <div className=\"flex items-center gap-2 mb-1\">\r\n                <FileText className=\"w-4 h-4 text-zinc-400\" />\r\n                <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Description</span>\r\n              </div>\r\n              <p className=\"text-sm text-gray-300\">\r\n                {item.description || item.carDef?.description}\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Grid of details */}\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            {/* Owner */}\r\n            <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n              <div className=\"flex items-center gap-2 mb-1\">\r\n                <User className=\"w-4 h-4 text-zinc-400\" />\r\n                <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Owner</span>\r\n              </div>\r\n              <p className=\"text-sm font-medium text-white\">{item.owner || 'You'}</p>\r\n            </div>\r\n\r\n            {/* Issue/Purchase Date */}\r\n            <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n              <div className=\"flex items-center gap-2 mb-1\">\r\n                <Calendar className=\"w-4 h-4 text-zinc-400\" />\r\n                <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">\r\n                  {isTitle ? 'Purchase Date' : 'Issue Date'}\r\n                </span>\r\n              </div>\r\n              <p className=\"text-sm font-medium text-white\">\r\n                {item.purchased_at || item.issue_date \r\n                  ? new Date(item.purchased_at || item.issue_date).toLocaleDateString()\r\n                  : 'N/A'}\r\n              </p>\r\n            </div>\r\n\r\n            {/* Value */}\r\n            <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n              <div className=\"flex items-center gap-2 mb-1\">\r\n                <Tag className=\"w-4 h-4 text-zinc-400\" />\r\n                <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Current Value</span>\r\n              </div>\r\n              <p className=\"text-sm font-bold text-emerald-400\">\r\n                {(item.current_value || item.carDef?.price || 0).toLocaleString()} coins\r\n              </p>\r\n            </div>\r\n\r\n            {/* Serial ID */}\r\n            {item.serial_id && (\r\n              <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n                <div className=\"flex items-center gap-2 mb-1\">\r\n                  <Tag className=\"w-4 h-4 text-zinc-400\" />\r\n                  <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Serial ID</span>\r\n                </div>\r\n                <p className=\"text-sm font-mono text-zinc-300\">{item.serial_id}</p>\r\n              </div>\r\n            )}\r\n\r\n            {/* Rarity */}\r\n            {item.rarity && (\r\n              <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n                <div className=\"flex items-center gap-2 mb-1\">\r\n                  <Tag className=\"w-4 h-4 text-zinc-400\" />\r\n                  <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Rarity</span>\r\n                </div>\r\n                <p className={`text-sm font-bold ${\r\n                  item.rarity === 'legendary' ? 'text-yellow-400' :\r\n                  item.rarity === 'epic' ? 'text-purple-400' :\r\n                  item.rarity === 'rare' ? 'text-blue-400' :\r\n                  'text-gray-400'\r\n                }`}>\r\n                  {item.rarity.charAt(0).toUpperCase() + item.rarity.slice(1)}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Property-specific details */}\r\n          {!isTitle && item.address && (\r\n            <div className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n              <div className=\"flex items-center gap-2 mb-1\">\r\n                <Home className=\"w-4 h-4 text-zinc-400\" />\r\n                <span className=\"text-xs text-zinc-400 uppercase tracking-wider\">Address</span>\r\n              </div>\r\n              <p className=\"text-sm text-white\">{item.address}</p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Rent Income for properties */}\r\n          {!isTitle && item.rent_amount !== undefined && (\r\n            <div className=\"bg-amber-900/20 border border-amber-500/20 rounded-lg p-4\">\r\n              <div className=\"flex items-center gap-2 mb-1\">\r\n                <Tag className=\"w-4 h-4 text-amber-400\" />\r\n                <span className=\"text-xs text-amber-400 uppercase tracking-wider\">Rent Income</span>\r\n              </div>\r\n              <p className=\"text-lg font-bold text-amber-400\">\r\n                {item.rent_amount.toLocaleString()} coins/week\r\n              </p>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <div className=\"p-4 bg-zinc-950/50 border-t border-zinc-800\">\r\n          <p className=\"text-xs text-center text-zinc-500\">\r\n            Document ID: {item.id} ‚Ä¢ Issued by Troll City Authority\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TopBroadcasters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TopBroadcastersGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TrollBattleArena.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TrollCitySpinner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TrollEvent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TrollsTownControl.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\TrotingAdminView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'duration' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setDuration' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":31}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadContests'. Either include it or remove the dependency array.","line":44,"column":6,"nodeType":"ArrayExpression","endLine":44,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadContests]","fix":{"range":[1401,1403],"text":"[loadContests]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { Check, X, Loader2, DollarSign, Settings, Trash2 } from 'lucide-react'\r\n\r\ninterface Pitch {\r\n  id: string\r\n  title: string\r\n  description: string\r\n  status: string\r\n  vote_count: number\r\n  up_votes: number\r\n  down_votes: number\r\n  author: {\r\n    username: string\r\n    avatar_url: string\r\n  }\r\n}\r\n\r\ninterface Contest {\r\n  id: string\r\n  status: string\r\n  week_start: string\r\n  week_end: string\r\n  title?: string\r\n}\r\n\r\nexport default function TrotingAdminView() {\r\n  const [contests, setContests] = useState<Contest[]>([])\r\n  const [selectedContest, setSelectedContest] = useState<string | null>(null)\r\n  const [pitches, setPitches] = useState<Pitch[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [actionLoading, setActionLoading] = useState<string | null>(null)\r\n  const [showSplitsModal, setShowSplitsModal] = useState<string | null>(null) // pitch_id\r\n  const [splits, setSplits] = useState<any[]>([])\r\n  const [newSplitUser, setNewSplitUser] = useState('')\r\n  const [newSplitPercent, setNewSplitPercent] = useState('')\r\n  const [formTitle, setFormTitle] = useState('')\r\n  const [duration, setDuration] = useState('7') // Default 1 week\r\n\r\n  useEffect(() => {\r\n    loadContests()\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (selectedContest) {\r\n      loadPitches(selectedContest)\r\n    }\r\n  }, [selectedContest])\r\n\r\n  useEffect(() => {\r\n    if (showSplitsModal) {\r\n      loadSplits(showSplitsModal)\r\n    }\r\n  }, [showSplitsModal])\r\n\r\n  const loadSplits = async (pitchId: string) => {\r\n    const { data } = await supabase\r\n      .from('revenue_splits')\r\n      .select('*, recipient:user_profiles(username)')\r\n      .eq('pitch_id', pitchId)\r\n    if (data) setSplits(data)\r\n  }\r\n\r\n  const addSplit = async () => {\r\n    if (!showSplitsModal || !newSplitUser || !newSplitPercent) return\r\n\r\n    try {\r\n      // Find user by username\r\n      const { data: userData } = await supabase\r\n        .from('user_profiles')\r\n        .select('id')\r\n        .eq('username', newSplitUser)\r\n        .single()\r\n      \r\n      if (!userData) {\r\n        toast.error('User not found')\r\n        return\r\n      }\r\n\r\n      const { error } = await supabase\r\n        .from('revenue_splits')\r\n        .insert({\r\n          pitch_id: showSplitsModal,\r\n          recipient_id: userData.id,\r\n          percentage: parseFloat(newSplitPercent)\r\n        })\r\n\r\n      if (error) throw error\r\n      \r\n      toast.success('Revenue split added')\r\n      setNewSplitUser('')\r\n      setNewSplitPercent('')\r\n      loadSplits(showSplitsModal)\r\n    } catch {\r\n      toast.error('Failed to add split')\r\n    }\r\n  }\r\n\r\n  const deleteSplit = async (id: string) => {\r\n    const { error } = await supabase.from('revenue_splits').delete().eq('id', id)\r\n    if (!error) {\r\n      toast.success('Split removed')\r\n      if (showSplitsModal) loadSplits(showSplitsModal)\r\n    }\r\n  }\r\n\r\n  const loadContests = async () => {\r\n    const { data } = await supabase\r\n      .from('pitch_contests')\r\n      .select('*')\r\n      .order('created_at', { ascending: false })\r\n    \r\n    if (data) {\r\n      setContests(data)\r\n      if (data.length > 0 && !selectedContest) {\r\n        setSelectedContest(data[0].id)\r\n      }\r\n    }\r\n  }\r\n\r\n  const loadPitches = async (contestId: string) => {\r\n    setLoading(true)\r\n    const { data } = await supabase\r\n      .from('pitches')\r\n      .select('*, author:user_profiles(username, avatar_url)')\r\n      .eq('contest_id', contestId)\r\n      .order('vote_count', { ascending: false })\r\n    \r\n    if (data) setPitches(data)\r\n    setLoading(false)\r\n  }\r\n\r\n  const deletePitch = async (pitchId: string) => {\n    if (!window.confirm('Are you sure you want to delete this pitch?')) return\n    \n    setActionLoading(pitchId)\n    try {\n      const { error } = await supabase\n        .from('pitches')\n        .delete()\n        .eq('id', pitchId)\n\n      if (error) throw error\n      \n      setPitches(current => current.filter(p => p.id !== pitchId))\n      toast.success('Pitch deleted')\n    } catch (err) {\n      console.error('Error deleting pitch:', err)\n      toast.error('Failed to delete pitch')\n    } finally {\n      setActionLoading(null)\n    }\n  }\n\n  const updatePitchStatus = async (pitchId: string, status: string) => {\r\n    setActionLoading(pitchId)\r\n    try {\r\n      const { error } = await supabase\r\n        .from('pitches')\r\n        .update({ status })\r\n        .eq('id', pitchId)\r\n\r\n      if (error) throw error\r\n      \r\n      setPitches(current => \r\n        current.map(p => p.id === pitchId ? { ...p, status } : p)\r\n      )\r\n      toast.success(`Pitch marked as ${status}`)\r\n    } catch (err) {\r\n      console.error('Error updating pitch:', err)\r\n      toast.error('Failed to update status')\r\n    } finally {\r\n      setActionLoading(null)\r\n    }\r\n  }\r\n\r\n  const updateContestStatus = async (status: string) => {\r\n    if (!selectedContest) return\r\n    try {\r\n      const { error } = await supabase\r\n        .from('pitch_contests')\r\n        .update({ status })\r\n        .eq('id', selectedContest)\r\n\r\n      if (error) throw error\r\n\r\n      setContests(current =>\r\n        current.map(c => c.id === selectedContest ? { ...c, status } : c)\r\n      )\r\n      toast.success(`Contest status updated to ${status}`)\r\n    } catch {\r\n      toast.error('Failed to update contest status')\r\n    }\r\n  }\r\n\r\n  const createContest = async () => {\r\n    try {\r\n      const today = new Date()\r\n      const nextWeek = new Date(today)\r\n      nextWeek.setDate(today.getDate() + 7)\r\n      const weekStartStr = today.toISOString().split('T')[0]\r\n      \r\n      const titleToUse = formTitle.trim() || `Pitch Contest ${weekStartStr}`\r\n      \r\n      const { data, error } = await supabase\r\n        .from('pitch_contests')\r\n        .insert({\r\n            week_start: weekStartStr,\r\n            week_end: nextWeek.toISOString().split('T')[0],\r\n            status: 'submission',\r\n            title: titleToUse\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (error) throw error\r\n\r\n      setContests([data, ...contests])\r\n      setSelectedContest(data.id)\r\n      setFormTitle('')\r\n      toast.success('New contest created!')\r\n    } catch (err) {\r\n      console.error(err)\r\n      toast.error('Failed to create contest')\r\n    }\r\n  }\r\n\r\n  const deleteAllContests = async () => {\r\n    if (!window.confirm('WARNING: This will delete ALL contests, pitches, votes, and revenue splits. This action cannot be undone. Are you sure?')) return\r\n    \r\n    if (!window.confirm('Last chance: Are you absolutely sure you want to wipe all contest data?')) return\r\n\r\n    try {\r\n      // Delete all contests where id is not empty (effectively all)\r\n      const { error } = await supabase\r\n        .from('pitch_contests')\r\n        .delete()\r\n        .neq('id', '00000000-0000-0000-0000-000000000000')\r\n\r\n      if (error) throw error\r\n      \r\n      setContests([])\r\n      setSelectedContest(null)\r\n      setPitches([])\r\n      toast.success('All contests deleted')\r\n    } catch (err) {\r\n      console.error(err)\r\n      toast.error('Failed to delete all contests')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-8 animate-fade-in\">\r\n      <div className=\"bg-zinc-900/50 border border-zinc-800 rounded-xl p-6\">\r\n        <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n          <Settings className=\"w-5 h-5 text-purple-400\" />\r\n          Contest Management\r\n        </h2>\r\n        \r\n        <div className=\"flex flex-wrap gap-4 items-center\">\r\n          <select \r\n            value={selectedContest || ''}\r\n            onChange={(e) => setSelectedContest(e.target.value)}\r\n            className=\"bg-black/50 border border-zinc-700 rounded-lg px-4 py-2 text-white\"\r\n          >\r\n            {contests.map(c => (\r\n              <option key={c.id} value={c.id}>\r\n                {c.title || `Week of ${new Date(c.week_start).toLocaleDateString()}`} ({c.status})\r\n              </option>\r\n            ))}\r\n          </select>\r\n          \r\n          <input\r\n            type=\"text\"\r\n            placeholder=\"Contest Title (optional)\"\r\n            value={formTitle}\r\n            onChange={(e) => setFormTitle(e.target.value)}\r\n            className=\"bg-black/50 border border-zinc-700 rounded-lg px-4 py-2 text-white w-64\"\r\n          />\r\n\r\n          <button\r\n            onClick={createContest}\r\n            className=\"px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors\"\r\n          >\r\n            + New Contest\r\n          </button>\r\n\r\n          <button\r\n            onClick={deleteAllContests}\r\n            className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\r\n            title=\"Delete ALL Contests\"\r\n          >\r\n            <Trash2 className=\"w-5 h-5\" />\r\n          </button>\r\n\r\n          <div className=\"h-8 w-px bg-zinc-700 mx-2\" />\r\n\r\n          <div className=\"flex gap-2\">\r\n            {['submission', 'voting', 'review', 'completed'].map(status => (\r\n              <button\r\n                key={status}\r\n                onClick={() => updateContestStatus(status)}\r\n                disabled={!selectedContest || contests.find(c => c.id === selectedContest)?.status === status}\r\n                className={`px-3 py-1 rounded text-sm font-medium transition-colors ${\r\n                  contests.find(c => c.id === selectedContest)?.status === status\r\n                    ? 'bg-purple-600 text-white'\r\n                    : 'bg-zinc-800 text-gray-400 hover:text-white'\r\n                }`}\r\n              >\r\n                {status.charAt(0).toUpperCase() + status.slice(1)}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"space-y-4\">\r\n        <h3 className=\"text-lg font-semibold text-gray-300\">Pitches ({pitches.length})</h3>\r\n        \r\n        {loading ? (\r\n          <div className=\"flex justify-center py-12\">\r\n            <Loader2 className=\"w-8 h-8 animate-spin text-purple-500\" />\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid gap-4\">\r\n            {pitches.map(pitch => (\r\n              <div key={pitch.id} className=\"bg-zinc-900/50 border border-zinc-800 rounded-xl p-4 flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-4\">\r\n                  <div className=\"w-10 h-10 rounded-full bg-zinc-800 overflow-hidden\">\r\n                    <img src={pitch.author?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${pitch.author.username}`} alt=\"\" />\r\n                  </div>\r\n                  <div>\r\n                    <h4 className=\"font-semibold text-white\">{pitch.title}</h4>\r\n                    <p className=\"text-sm text-gray-400\">\r\n                      by {pitch.author?.username} ‚Ä¢ \r\n                      <span className=\"text-green-400 ml-1\">+{pitch.up_votes || 0}</span> / \r\n                      <span className=\"text-red-400 ml-1\">-{pitch.down_votes || 0}</span> ‚Ä¢ \r\n                      Total: {pitch.vote_count}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${\r\n                    pitch.status === 'approved' ? 'bg-green-500/20 text-green-400' :\r\n                    pitch.status === 'rejected' ? 'bg-red-500/20 text-red-400' :\r\n                    'bg-yellow-500/20 text-yellow-400'\r\n                  }`}>\r\n                    {pitch.status}\r\n                  </span>\r\n                  \r\n                  <div className=\"h-6 w-px bg-zinc-700 mx-2\" />\r\n\r\n                  <button\r\n                    onClick={() => updatePitchStatus(pitch.id, 'approved')}\r\n                    disabled={actionLoading === pitch.id || pitch.status === 'approved'}\r\n                    className=\"p-2 hover:bg-green-500/20 text-gray-400 hover:text-green-400 rounded-lg transition-colors\"\r\n                    title=\"Approve\"\r\n                  >\r\n                    <Check className=\"w-4 h-4\" />\r\n                  </button>\r\n                  <button\r\n                    onClick={() => updatePitchStatus(pitch.id, 'rejected')}\r\n                    disabled={actionLoading === pitch.id || pitch.status === 'rejected'}\r\n                    className=\"p-2 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded-lg transition-colors\"\r\n                    title=\"Reject\"\r\n                  >\r\n                    <X className=\"w-4 h-4\" />\r\n                  </button>\r\n                  <button\r\n                    onClick={() => setShowSplitsModal(pitch.id)}\r\n                    className=\"p-2 hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 rounded-lg transition-colors\"\r\n                    title=\"Manage Revenue Splits\"\r\n                  >\r\n                    <DollarSign className=\"w-4 h-4\" />\r\n                  </button>\r\n                  <button\r\n                    onClick={() => deletePitch(pitch.id)}\r\n                    disabled={actionLoading === pitch.id}\r\n                    className=\"p-2 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded-lg transition-colors\"\r\n                    title=\"Delete Pitch\"\r\n                  >\r\n                    <Trash2 className=\"w-4 h-4\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {showSplitsModal && (\r\n        <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-lg space-y-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"text-xl font-bold text-white\">Revenue Splits</h3>\r\n              <button \r\n                onClick={() => setShowSplitsModal(null)}\r\n                className=\"text-gray-400 hover:text-white\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex gap-2\">\r\n                <input\r\n                  type=\"text\"\r\n                  value={newSplitUser}\r\n                  onChange={(e) => setNewSplitUser(e.target.value)}\r\n                  placeholder=\"Username\"\r\n                  className=\"flex-1 bg-black/50 border border-zinc-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500\"\r\n                />\r\n                <input\r\n                  type=\"number\"\r\n                  value={newSplitPercent}\r\n                  onChange={(e) => setNewSplitPercent(e.target.value)}\r\n                  placeholder=\"%\"\r\n                  className=\"w-20 bg-black/50 border border-zinc-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500\"\r\n                />\r\n                <button\r\n                  onClick={addSplit}\r\n                  disabled={!newSplitUser || !newSplitPercent}\r\n                  className=\"px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  Add\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                {splits.map(split => (\r\n                  <div key={split.id} className=\"flex items-center justify-between bg-zinc-800/50 p-3 rounded-lg\">\r\n                    <div>\r\n                      <span className=\"font-medium text-white\">{split.recipient?.username}</span>\r\n                      <span className=\"text-gray-400 text-sm ml-2\">{split.percentage}%</span>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => deleteSplit(split.id)}\r\n                      className=\"text-gray-500 hover:text-red-400 transition-colors\"\r\n                    >\r\n                      <X className=\"w-4 h-4\" />\r\n                    </button>\r\n                  </div>\r\n                ))}\r\n                {splits.length === 0 && (\r\n                  <p className=\"text-center text-gray-500 py-4\">No revenue splits configured</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserCompliancePrompt.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserHistoryCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserIdentityBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserNameWithLevels.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserProfilePopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserRecord.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\UserSearchDropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\VerifiedBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\WalletSummary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\WeeklyReportForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\WeeklyReportsList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\XPProgressBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\ActionGroup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\AssignRecruitPanel.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":349,"column":78,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[13566,13635],"text":"Partners will earn commissions from their assigned recruits&apos; activity"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[13566,13635],"text":"Partners will earn commissions from their assigned recruits&lsquo; activity"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[13566,13635],"text":"Partners will earn commissions from their assigned recruits&#39; activity"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[13566,13635],"text":"Partners will earn commissions from their assigned recruits&rsquo; activity"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Card, CardHeader, CardTitle, CardContent } from '../ui/card';\r\nimport { Button } from '../ui/button';\r\nimport { Badge } from '../ui/badge';\r\nimport { Loader2, UserPlus, Search, Crown, Users } from 'lucide-react';\r\nimport { supabase } from '../../lib/supabase';\r\n\r\nexport function AssignRecruitPanel() {\r\n  interface PartnerProfile {\r\n    id: string;\r\n    username?: string;\r\n    display_name?: string;\r\n    role?: string;\r\n  }\r\n  interface EmpirePartner {\r\n    user_id: string;\r\n    empire_partner_request: boolean;\r\n    status: string;\r\n    profiles?: PartnerProfile | null;\r\n  }\r\n  interface Recruit {\r\n    id: string;\r\n    username?: string;\r\n    display_name?: string;\r\n    is_contracted?: boolean;\r\n    recruiter_id?: string | null;\r\n  }\r\n  const [partners, setPartners] = useState<EmpirePartner[]>([]);\r\n  const [recruits, setRecruits] = useState<Recruit[]>([]);\r\n  const [selectedPartner, setSelectedPartner] = useState('');\r\n  const [selectedRecruit, setSelectedRecruit] = useState('');\r\n  const [loading, setLoading] = useState(true);\r\n  const [assigning, setAssigning] = useState(false);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n\r\n  const loadData = React.useCallback(async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      // Load Empire Partners (users with approved applications and empire_partner_request)\r\n      const { data: partnersData, error: partnersError } = await supabase\r\n        .from('creator_applications')\r\n        .select(`\r\n          user_id,\r\n          empire_partner_request,\r\n          status,\r\n          profiles!inner(\r\n            id,\r\n            username,\r\n            display_name,\r\n            role\r\n          )\r\n        `)\r\n        .eq('status', 'approved')\r\n        .eq('empire_partner_request', true);\r\n\r\n      if (partnersError) throw partnersError;\r\n      const partnerRows = (partnersData || []) as any[];\r\n      const mappedPartners: EmpirePartner[] = partnerRows.map((row) => ({\r\n        user_id: row.user_id,\r\n        empire_partner_request: row.empire_partner_request,\r\n        status: row.status,\r\n        profiles: Array.isArray(row.profiles) ? row.profiles[0] : row.profiles,\r\n      }));\r\n      setPartners(mappedPartners);\r\n\r\n      // Load available recruits (users with approved TrollTract but not assigned to a partner)\r\n      const { data: recruitsData, error: recruitsError } = await supabase\r\n        .from('profiles')\r\n        .select(`\r\n          id,\r\n          username,\r\n          display_name,\r\n          is_contracted,\r\n          recruiter_id\r\n        `)\r\n        .eq('is_contracted', true)\r\n        .is('recruiter_id', null)\r\n        .neq('role', 'admin');\r\n\r\n      if (recruitsError) throw recruitsError;\r\n      setRecruits((recruitsData as Recruit[]) || []);\r\n      \r\n    } catch (error) {\r\n      console.error('Error loading data:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n  }, [loadData]);\r\n\r\n  const handleAssignRecruit = async () => {\r\n    if (!selectedPartner || !selectedRecruit) {\r\n      alert('Please select both a partner and a recruit.');\r\n      return;\r\n    }\r\n\r\n    if (selectedPartner === selectedRecruit) {\r\n      alert('A user cannot recruit themselves.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setAssigning(true);\r\n      \r\n      const { error } = await supabase\r\n        .from('profiles')\r\n        .update({ recruiter_id: selectedPartner })\r\n        .eq('id', selectedRecruit);\r\n\r\n      if (error) throw error;\r\n\r\n      // Refresh data\r\n      await loadData();\r\n      setSelectedPartner('');\r\n      setSelectedRecruit('');\r\n      \r\n      alert('Recruit assigned successfully!');\r\n    } catch (error) {\r\n      console.error('Error assigning recruit:', error);\r\n      alert('Failed to assign recruit. Please try again.');\r\n    } finally {\r\n      setAssigning(false);\r\n    }\r\n  };\r\n\r\n  const filteredPartners = partners.filter(partner => \r\n    partner.profiles?.username?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    partner.profiles?.display_name?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  const filteredRecruits = recruits.filter(recruit => \r\n    recruit.username?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    recruit.display_name?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"bg-slate-950/60 border-slate-800\">\r\n        <CardContent className=\"p-6\">\r\n          <div className=\"flex items-center gap-2 text-slate-300\">\r\n            <Loader2 className=\"w-6 h-6 animate-spin\" />\r\n            <span>Loading data...</span>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <Card className=\"bg-slate-950/60 border-slate-800\">\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2 text-slate-50\">\r\n            <UserPlus className=\"w-5 h-5 text-purple-400\" />\r\n            Assign Recruit to Empire Partner\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <p className=\"text-slate-300 text-sm\">\r\n            Manually assign recruits to Empire Partners instead of using automatic referral links.\r\n          </p>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Search */}\r\n      <Card className=\"bg-slate-950/60 border-slate-800\">\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"relative\">\r\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n            <input\r\n              type=\"text\"\r\n              value={searchTerm}\r\n              onChange={(e) => setSearchTerm(e.target.value)}\r\n              placeholder=\"Search users...\"\r\n              className=\"w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n            />\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <div className=\"grid lg:grid-cols-2 gap-6\">\r\n        {/* Empire Partners */}\r\n        <Card className=\"bg-slate-950/60 border-slate-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2 text-slate-50\">\r\n              <Crown className=\"w-5 h-5 text-yellow-400\" />\r\n              Empire Partners\r\n              <Badge variant=\"outline\" className=\"text-xs\">\r\n                {filteredPartners.length} available\r\n              </Badge>\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-2 max-h-96 overflow-y-auto\">\r\n            {filteredPartners.length === 0 ? (\r\n              <p className=\"text-slate-400 text-center py-4\">No Empire Partners found.</p>\r\n            ) : (\r\n              filteredPartners.map((partner) => (\r\n                <div\r\n                  key={partner.user_id}\r\n                  className={`p-3 rounded-lg border cursor-pointer transition ${\r\n                    selectedPartner === partner.user_id\r\n                      ? 'border-purple-500 bg-purple-500/10'\r\n                      : 'border-slate-700 hover:border-slate-600'\r\n                  }`}\r\n                  onClick={() => setSelectedPartner(partner.user_id)}\r\n                >\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"w-8 h-8 bg-yellow-500/20 rounded-full flex items-center justify-center\">\r\n                      <Crown className=\"w-4 h-4 text-yellow-400\" />\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <p className=\"font-medium text-slate-200\">\r\n                        {partner.profiles?.display_name || partner.profiles?.username || 'Unknown'}\r\n                      </p>\r\n                      {partner.profiles?.username && (\r\n                        <p className=\"text-sm text-slate-400\">@{partner.profiles.username}</p>\r\n                      )}\r\n                    </div>\r\n                    {selectedPartner === partner.user_id && (\r\n                      <div className=\"w-2 h-2 bg-purple-400 rounded-full\"></div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Available Recruits */}\r\n        <Card className=\"bg-slate-950/60 border-slate-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2 text-slate-50\">\r\n              <Users className=\"w-5 h-5 text-blue-400\" />\r\n              Available Recruits\r\n              <Badge variant=\"outline\" className=\"text-xs\">\r\n                {filteredRecruits.length} unassigned\r\n              </Badge>\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-2 max-h-96 overflow-y-auto\">\r\n            {filteredRecruits.length === 0 ? (\r\n              <p className=\"text-slate-400 text-center py-4\">No available recruits found.</p>\r\n            ) : (\r\n              filteredRecruits.map((recruit) => (\r\n                <div\r\n                  key={recruit.id}\r\n                  className={`p-3 rounded-lg border cursor-pointer transition ${\r\n                    selectedRecruit === recruit.id\r\n                      ? 'border-blue-500 bg-blue-500/10'\r\n                      : 'border-slate-700 hover:border-slate-600'\r\n                  }`}\r\n                  onClick={() => setSelectedRecruit(recruit.id)}\r\n                >\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center\">\r\n                      <Users className=\"w-4 h-4 text-blue-400\" />\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <p className=\"font-medium text-slate-200\">\r\n                        {recruit.display_name || recruit.username || 'Unknown'}\r\n                      </p>\r\n                      {recruit.username && (\r\n                        <p className=\"text-sm text-slate-400\">@{recruit.username}</p>\r\n                      )}\r\n                    </div>\r\n                    {selectedRecruit === recruit.id && (\r\n                      <div className=\"w-2 h-2 bg-blue-400 rounded-full\"></div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Assignment Summary */}\r\n      {selectedPartner && selectedRecruit && (\r\n        <Card className=\"bg-slate-950/60 border-slate-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-slate-50\">Assignment Summary</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex items-center justify-between p-4 bg-slate-800/50 rounded-lg\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"w-8 h-8 bg-yellow-500/20 rounded-full flex items-center justify-center\">\r\n                  <Crown className=\"w-4 h-4 text-yellow-400\" />\r\n                </div>\r\n                <div>\r\n                  <p className=\"font-medium text-slate-200\">\r\n                    {partners.find(p => p.user_id === selectedPartner)?.profiles?.display_name ||\r\n                     partners.find(p => p.user_id === selectedPartner)?.profiles?.username}\r\n                  </p>\r\n                  <p className=\"text-sm text-slate-400\">Empire Partner</p>\r\n                </div>\r\n              </div>\r\n              \r\n              <div className=\"text-slate-400\">‚Üí</div>\r\n              \r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center\">\r\n                  <Users className=\"w-4 h-4 text-blue-400\" />\r\n                </div>\r\n                <div>\r\n                  <p className=\"font-medium text-slate-200\">\r\n                    {recruits.find(r => r.id === selectedRecruit)?.display_name ||\r\n                     recruits.find(r => r.id === selectedRecruit)?.username}\r\n                  </p>\r\n                  <p className=\"text-sm text-slate-400\">Recruit</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <Button\r\n              onClick={handleAssignRecruit}\r\n              disabled={assigning}\r\n              className=\"w-full mt-4 bg-purple-600 hover:bg-purple-700\"\r\n            >\r\n              {assigning ? (\r\n                <>\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                  Assigning...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <UserPlus className=\"w-4 h-4 mr-2\" />\r\n                  Assign Recruit\r\n                </>\r\n              )}\r\n            </Button>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Info Card */}\r\n      <Card className=\"bg-slate-950/60 border-slate-800\">\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"text-sm text-slate-300 space-y-2\">\r\n            <p><strong>How it works:</strong></p>\r\n            <ul className=\"list-disc list-inside space-y-1 text-slate-400\">\r\n              <li>Empire Partners are users who requested Empire Partner status in their application</li>\r\n              <li>Available recruits are contracted users not yet assigned to a partner</li>\r\n              <li>Assignments are permanent and cannot be changed without admin intervention</li>\r\n              <li>Partners will earn commissions from their assigned recruits' activity</li>\r\n            </ul>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\BroadcastLockdownToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\CreatorApplicationsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\SectionCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\StatCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\admin\\UserDetailsModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\auth\\RequireLeadOrOwner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\auth\\RequireSecretary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\auth\\SessionMonitor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'React' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"React"},"fix":{"range":[7,13],"text":""},"desc":"Remove unused variable \"React\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":25,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react'\nimport { supabase } from '../../lib/supabase'\nimport { useAuthStore } from '../../lib/store'\nimport { toast } from 'sonner'\n\nexport default function SessionMonitor() {\n  const { user, logout } = useAuthStore()\n\n  useEffect(() => {\n    if (!user) return\n\n    const sessionId = localStorage.getItem('current_device_session_id')\n    if (!sessionId) {\n      // If no session ID is found (e.g. legacy login), we could optionally\n      // force a logout or just ignore it. \n      // For strict enforcement, we should probably ignore it until next login \n      // or generate one. But generating one now implies calling register_session\n      // which might kick other devices.\n      // Let's just monitor if we have one.\n      return\n    }\n\n    // Initial check\n    const checkSession = async () => {\n      const { data, error } = await supabase\n        .from('active_sessions')\n        .select('is_active')\n        .eq('session_id', sessionId)\n        .single()\n\n      if (data && data.is_active === false) {\n        console.log('[SessionMonitor] Session is marked inactive. Logging out.')\n        toast.error('Session expired. You have logged in on another device.')\n        logout()\n      }\n    }\n    \n    checkSession()\n\n    // Subscribe to changes\n    const channel = supabase\n      .channel(`session_monitor_${sessionId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'active_sessions',\n          filter: `session_id=eq.${sessionId}`\n        },\n        (payload) => {\n          if (payload.new && payload.new.is_active === false) {\n            console.log('[SessionMonitor] Session deactivated via realtime. Logging out.')\n            toast.error('Session expired. You have logged in on another device.')\n            logout()\n          }\n        }\n      )\n      .subscribe()\n\n    return () => {\n      supabase.removeChannel(channel)\n    }\n  }, [user, logout])\n\n  return null\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\avatar\\Avatar3D.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\badges\\BadgeCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\badges\\BadgesGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\battle\\BattleArena.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\battle\\BattleWinnerModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":47,"column":66,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1417,1428],"text":"It&apos;s a Tie!"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1417,1428],"text":"It&lsquo;s a Tie!"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1417,1428],"text":"It&#39;s a Tie!"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1417,1428],"text":"It&rsquo;s a Tie!"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { Trophy, Coins, X } from 'lucide-react'\r\nimport { useAuthStore } from '../../lib/store'\r\n\r\ninterface BattleWinnerModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  winnerId: string | null\r\n  broadcaster1Id: string\r\n  broadcaster2Id: string\r\n  broadcaster1Coins: number\r\n  broadcaster2Coins: number\r\n  broadcaster1Name?: string\r\n  broadcaster2Name?: string\r\n}\r\n\r\nexport default function BattleWinnerModal({\r\n  isOpen,\r\n  onClose,\r\n  winnerId,\r\n  broadcaster1Id,\r\n  broadcaster2Id,\r\n  broadcaster1Coins,\r\n  broadcaster2Coins,\r\n  broadcaster1Name,\r\n  broadcaster2Name,\r\n}: BattleWinnerModalProps) {\r\n  const { user } = useAuthStore()\r\n  const isWinner = winnerId === user?.id\r\n  const isTie = winnerId === null\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm\">\r\n      <div className=\"bg-troll-dark-bg border-4 border-troll-gold rounded-lg p-8 w-full max-w-lg relative\">\r\n        <button\r\n          onClick={onClose}\r\n          className=\"absolute top-4 right-4 text-gray-400 hover:text-white transition-colors\"\r\n        >\r\n          <X className=\"w-6 h-6\" />\r\n        </button>\r\n\r\n        {isTie ? (\r\n          <div className=\"text-center\">\r\n            <Trophy className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n            <h2 className=\"text-3xl font-bold text-white mb-2\">It's a Tie!</h2>\r\n            <p className=\"text-gray-400 mb-6\">Both broadcasters received the same amount of troll_coins.</p>\r\n            <div className=\"bg-black/50 rounded-lg p-4 mb-4\">\r\n              <div className=\"flex justify-between items-center mb-2\">\r\n                <span className=\"text-gray-400\">@{broadcaster1Name || 'Broadcaster 1'}</span>\r\n                <span className=\"text-troll-gold font-bold\">{broadcaster1Coins.toLocaleString()} coins</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-400\">@{broadcaster2Name || 'Broadcaster 2'}</span>\r\n                <span className=\"text-troll-gold font-bold\">{broadcaster2Coins.toLocaleString()} coins</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-center\">\r\n            <div className=\"relative mb-6\">\r\n              <Trophy className=\"w-24 h-24 text-troll-gold mx-auto animate-bounce\" />\r\n              {isWinner && (\r\n                <div className=\"absolute inset-0 flex items-center justify-center\">\r\n                  <div className=\"text-4xl font-bold text-troll-gold animate-pulse\">YOU WON!</div>\r\n                </div>\r\n              )}\r\n            </div>\r\n            \r\n            <h2 className=\"text-3xl font-bold text-white mb-2\">\r\n              {isWinner ? 'Victory!' : 'Battle Complete'}\r\n            </h2>\r\n            \r\n            <p className=\"text-gray-400 mb-6\">\r\n              {isWinner\r\n                ? 'Congratulations! You won the battle and earned rewards!'\r\n                : `@${winnerId === broadcaster1Id ? broadcaster1Name : broadcaster2Name} won the battle!`}\r\n            </p>\r\n\r\n            <div className=\"bg-black/50 rounded-lg p-4 mb-4\">\r\n              <div className=\"flex justify-between items-center mb-2\">\r\n                <span className={`${winnerId === broadcaster1Id ? 'text-troll-gold font-bold' : 'text-gray-400'}`}>\r\n                  @{broadcaster1Name || 'Broadcaster 1'}\r\n                  {winnerId === broadcaster1Id && <Trophy className=\"w-4 h-4 inline ml-2\" />}\r\n                </span>\r\n                <span className=\"text-troll-gold font-bold\">{broadcaster1Coins.toLocaleString()} coins</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className={`${winnerId === broadcaster2Id ? 'text-troll-gold font-bold' : 'text-gray-400'}`}>\r\n                  @{broadcaster2Name || 'Broadcaster 2'}\r\n                  {winnerId === broadcaster2Id && <Trophy className=\"w-4 h-4 inline ml-2\" />}\r\n                </span>\r\n                <span className=\"text-troll-gold font-bold\">{broadcaster2Coins.toLocaleString()} coins</span>\r\n              </div>\r\n            </div>\r\n\r\n            {isWinner && (\r\n              <div className=\"bg-troll-neon-green/20 border border-troll-neon-green rounded-lg p-4 mb-4\">\r\n                <div className=\"flex items-center gap-2 text-troll-neon-green mb-2\">\r\n                  <Coins className=\"w-5 h-5\" />\r\n                  <span className=\"font-semibold\">Rewards Earned:</span>\r\n                </div>\r\n                <ul className=\"text-left text-sm text-gray-300 space-y-1\">\r\n                  <li>üèÜ Trophy Badge: Battle Champion</li>\r\n                  <li>üí∞ Coin Multiplier: 10% bonus for 24 hours</li>\r\n                  <li>üìä Battle added to your profile history</li>\r\n                </ul>\r\n              </div>\r\n            )}\r\n\r\n            <button\r\n              onClick={onClose}\r\n              className=\"w-full px-6 py-3 bg-troll-neon-blue hover:bg-troll-neon-green text-white rounded-lg font-semibold transition-colors\"\r\n            >\r\n              Continue\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\battle\\StartBattleModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\BroadcastLayout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'className' is defined but never used. Allowed unused args must match /^_/u.","line":42,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'backgroundStyle' is defined but never used. Allowed unused args must match /^_/u.","line":51,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":18}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'participantIds'. Either include it or remove the dependency array.","line":94,"column":6,"nodeType":"ArrayExpression","endLine":94,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [participantIds, participantIdsKey]","fix":{"range":[2733,2752],"text":"[participantIds, participantIdsKey]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from 'react'\nimport { useRoomParticipants } from '../../hooks/useRoomParticipants'\nimport { Room, Participant } from 'livekit-client'\nimport ResponsiveVideoGrid from '../stream/ResponsiveVideoGrid'\nimport { supabase } from '../../lib/supabase'\n\n\ninterface BroadcastLayoutProps {\n  children?: React.ReactNode\n  room: Room\n  streamId?: string\n  broadcasterId: string\n  isHost: boolean\n  className?: string\n  joinPrice?: number\n  boxCount?: number\n  seats?: any[]\n  lastGift?: any\n  onJoinRequest?: (seatIndex: number) => void\n  onLeaveSession?: () => void\n  onDisableGuestMedia?: (participantId: string, disableVideo?: boolean, disableAudio?: boolean) => void\n  giftBalanceDelta?: { userId: string; delta: number; key: number } | null\n  backgroundStyle?: React.CSSProperties\n  onSeatAction?: (params: { seatIndex: number; seat: any; participant?: any }) => void\n  hostSeatIndex?: number\n  onHostSeatChange?: (seatIndex: number) => void\n  onUserClick?: (participant: Participant) => void;\n  onToggleCamera?: () => void;\n  isCameraOn?: boolean;\n  onSetPrice?: (price: number) => void;\n  frameMode?: 'none' | 'rgb';\n  onFrameModeChange?: (mode: 'none' | 'rgb') => void;\n}\n\n\nexport default function BroadcastLayout({\n  giftBalanceDelta,\n  room,\n  streamId,\n  broadcasterId,\n  isHost,\n  className,\n  joinPrice = 0,\n  boxCount = 5,\n  seats,\n  lastGift,\n  onJoinRequest,\n  onLeaveSession,\n  onDisableGuestMedia,\n  onSeatAction,\n  backgroundStyle,\n  hostSeatIndex,\n  onHostSeatChange,\n  onUserClick,\n  onToggleCamera,\n  isCameraOn,\n  onSetPrice: _onSetPrice,\n  frameMode = 'none',\n  onFrameModeChange,\n  children\n}: BroadcastLayoutProps) {\n  const participants = useRoomParticipants(room);\n  const [coinBalances, setCoinBalances] = useState<Record<string, number>>({});\n\n  const participantIds = useMemo(\n    () => participants.map((p) => p.identity).filter(Boolean) as string[],\n    [participants]\n  );\n  const participantIdsKey = useMemo(\n    () => participantIds.slice().sort().join('|'),\n    [participantIds]\n  );\n\n  useEffect(() => {\n    if (!participantIds.length) return;\n    let isActive = true;\n    const loadBalances = async () => {\n      const { data, error } = await supabase\n        .from('user_profiles')\n        .select('id,troll_coins')\n        .in('id', participantIds);\n      if (!isActive || error || !data) return;\n      const next = data.reduce<Record<string, number>>((acc, row: any) => {\n        acc[row.id] = Number(row.troll_coins || 0);\n        return acc;\n      }, {});\n      setCoinBalances((prev) => ({ ...prev, ...next }));\n    };\n    loadBalances();\n    return () => {\n      isActive = false;\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [participantIdsKey]);\n\n  useEffect(() => {\n    if (!streamId) return;\n\n    const channel = supabase\n      .channel(`gifts-${streamId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: '*',\n          schema: 'public',\n          table: 'gifts',\n          filter: `stream_id=eq.${streamId}`,\n        },\n        async (payload) => {\n          const eventType = (payload as any).eventType;\n          if (eventType && eventType !== 'INSERT' && eventType !== 'UPDATE') {\n            return;\n          }\n          const newGift: any = payload.new;\n          const receiverId =\n            newGift?.receiver_id ||\n            newGift?.to_user_id ||\n            newGift?.receiverId ||\n            null;\n          const senderId =\n            newGift?.sender_id ||\n            newGift?.from_user_id ||\n            newGift?.senderId ||\n            null;\n          const amount = Number(\n            newGift?.coin_amount ??\n              newGift?.coinAmount ??\n              newGift?.coins ??\n              newGift?.amount ??\n              0\n          );\n\n          if (receiverId && amount) {\n            setCoinBalances((prev) => ({\n              ...prev,\n              [receiverId]: (prev[receiverId] || 0) + amount,\n            }));\n          }\n\n          if (senderId && amount) {\n            setCoinBalances((prev) => ({\n              ...prev,\n              [senderId]: (prev[senderId] || 0) - amount,\n            }));\n          }\n\n          if (receiverId) {\n            const { data } = await supabase\n              .from('user_profiles')\n              .select('id,troll_coins')\n              .eq('id', receiverId)\n              .maybeSingle();\n            if (data?.id) {\n              setCoinBalances((prev) => ({\n                ...prev,\n                [data.id]: Number(data.troll_coins || 0),\n              }));\n            }\n          }\n\n          if (senderId) {\n            const { data } = await supabase\n              .from('user_profiles')\n              .select('id,troll_coins')\n              .eq('id', senderId)\n              .maybeSingle();\n            if (data?.id) {\n              setCoinBalances((prev) => ({\n                ...prev,\n                [data.id]: Number(data.troll_coins || 0),\n              }));\n            }\n          }\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [streamId]);\n\n  useEffect(() => {\n    const receiverId =\n      lastGift?.receiver_id ||\n      lastGift?.to_user_id ||\n      lastGift?.receiverId ||\n      lastGift?.receiverID ||\n      null;\n    if (!receiverId) return;\n    let isActive = true;\n    const refreshReceiverBalance = async () => {\n      const { data } = await supabase\n        .from('user_profiles')\n        .select('id,troll_coins')\n        .eq('id', receiverId)\n        .maybeSingle();\n      if (!isActive || !data?.id) return;\n      setCoinBalances((prev) => ({\n        ...prev,\n        [data.id]: Number(data.troll_coins || 0)\n      }));\n    };\n    refreshReceiverBalance();\n    return () => {\n      isActive = false;\n    };\n  }, [lastGift]);\n\n  useEffect(() => {\n    if (!giftBalanceDelta?.userId || giftBalanceDelta.delta === 0) return;\n    setCoinBalances((prev) => {\n      const current = prev[giftBalanceDelta.userId] || 0;\n      return {\n        ...prev,\n        [giftBalanceDelta.userId]: current + giftBalanceDelta.delta,\n      };\n    });\n  }, [giftBalanceDelta?.key, giftBalanceDelta?.userId, giftBalanceDelta?.delta]);\n\n  if (!room) return null;\n\n  return (\n    <div className=\"flex flex-1 min-h-0 bg-black text-white\">\n      {/* VIDEO AREA */}\n      <div className=\"flex-1 p-4\">\n        <ResponsiveVideoGrid\n          participants={participants}\n          localParticipant={room.localParticipant}\n          broadcasterId={broadcasterId}\n          seats={seats}\n          isHost={isHost}\n          hostSeatIndex={hostSeatIndex}\n          joinPrice={joinPrice}\n          onLeaveSession={onLeaveSession}\n          onJoinRequest={onJoinRequest}\n          onDisableGuestMedia={onDisableGuestMedia}\n          coinBalances={coinBalances}\n          onHostSeatChange={onHostSeatChange}\n          onSeatAction={onSeatAction}\n          boxCount={boxCount}\n          onUserClick={onUserClick}\n          onToggleCamera={onToggleCamera}\n          isCameraOn={isCameraOn}\n          frameMode={frameMode}\n          onFrameModeChange={onFrameModeChange}\n        />\n        {children}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\BroadcastLevelBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\BroadcastPreview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\BroadcastThemePicker.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ownedThemeIds' is defined but never used. Allowed unused args must match /^_/u.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\nexport interface BroadcastTheme {\r\n  id: string;\r\n  name: string;\r\n  image_url: string;\r\n  description: string;\r\n  price_coins?: number;\r\n  slug?: string;\r\n}\r\n\r\nexport default function BroadcastThemePicker({\r\n  themes,\r\n  selected,\r\n  onSelect,\r\n  ownedThemeIds\r\n}: {\r\n  themes: BroadcastTheme[];\r\n  selected: string | null;\r\n  onSelect: (id: string) => void;\r\n  ownedThemeIds?: Set<string>;\r\n}) {\r\n  return (\r\n    <div className=\"mb-4\">\r\n      <label htmlFor=\"broadcast-theme-select\" className=\"block text-white font-semibold mb-2\">Choose a Theme</label>\r\n      <select\r\n        id=\"broadcast-theme-select\"\r\n        value={selected || ''}\r\n        onChange={e => onSelect(e.target.value)}\r\n        className=\"w-full p-2 rounded-lg bg-zinc-900 border border-zinc-700 text-white\"\r\n      >\r\n        <option value=\"\">Default Theme</option>\r\n        {themes.map(theme => (\r\n          <option key={theme.id} value={theme.id}>\r\n            {theme.name}\r\n          </option>\r\n        ))}\r\n      </select>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\BroadcasterBox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\CashAppPaymentModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":270,"column":28,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[10746,10787],"text":"‚úì You&apos;ll get a notification when complete"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[10746,10787],"text":"‚úì You&lsquo;ll get a notification when complete"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[10746,10787],"text":"‚úì You&#39;ll get a notification when complete"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[10746,10787],"text":"‚úì You&rsquo;ll get a notification when complete"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":282,"column":23,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[11148,11206],"text":"\r\n              Done - I&apos;ll Complete Payment\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[11148,11206],"text":"\r\n              Done - I&lsquo;ll Complete Payment\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[11148,11206],"text":"\r\n              Done - I&#39;ll Complete Payment\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[11148,11206],"text":"\r\n              Done - I&rsquo;ll Complete Payment\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { X, AlertCircle, Loader2, Copy, Send } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { useAuthStore } from '../../lib/store';\r\n\r\ninterface CashAppPaymentModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  packageId?: string;\r\n  coins: number;\r\n  amount: number;\r\n  itemName?: string;\r\n  purchaseType?: string;\r\n  onSuccess?: (orderId: string) => void;\r\n}\r\n\r\nexport default function CashAppPaymentModal({\r\n  isOpen,\r\n  onClose,\r\n  coins,\r\n  amount,\r\n  itemName,\r\n  packageId,\r\n  purchaseType,\r\n  onSuccess,\r\n}: CashAppPaymentModalProps) {\r\n  const { user, profile } = useAuthStore();\r\n  const [step, setStep] = useState<'confirm' | 'awaiting' | 'success'>('confirm');\r\n  const [orderId, setOrderId] = useState<string | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [noteSuggested, setNoteSuggested] = useState<string>('');\r\n  const [copied, setCopied] = useState(false);\r\n  const [cashTag, setCashTag] = useState('');\r\n  const [cashTagError, setCashTagError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!isOpen) {\r\n      setStep('confirm');\r\n      setOrderId(null);\r\n      setLoading(false);\r\n      setCopied(false);\r\n      setCashTag('');\r\n      setCashTagError(null);\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const normalizeCashTag = (value: string) => {\r\n    const trimmed = (value || '').trim();\r\n    const withoutDollar = trimmed.replace(/^\\$+/, '');\r\n    if (!withoutDollar) return { tag: '', error: 'Enter your Cash App tag (no $)' };\r\n    if (!/^[A-Za-z0-9._-]{2,20}$/.test(withoutDollar)) {\r\n      return { tag: '', error: 'Cash App tag must be 2-20 letters/numbers (no $).' };\r\n    }\r\n    return { tag: withoutDollar, error: '' };\r\n  };\r\n\r\n  const ensureCashTag = () => {\r\n    const { tag, error } = normalizeCashTag(cashTag);\r\n    if (error) {\r\n      setCashTagError(error);\r\n      toast.error(error);\r\n      return null;\r\n    }\r\n    setCashTagError(null);\r\n    setCashTag(tag);\r\n    return tag;\r\n  };\r\n\r\n  const handleCreateOrder = async () => {\r\n    if (!user) {\r\n      toast.error('You must be logged in');\r\n      return;\r\n    }\r\n\r\n    const tag = ensureCashTag();\r\n    if (!tag) return;\r\n\r\n    setLoading(true);\r\n    try {\r\n      const { data: sessionData } = await supabase.auth.getSession();\r\n      const token = sessionData.session?.access_token;\r\n      if (!token) throw new Error('Not authenticated');\r\n\r\n      const res = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/manual-coin-order`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`,\r\n          'apikey': import.meta.env.VITE_SUPABASE_ANON_KEY,\r\n        },\r\n        body: JSON.stringify({\r\n          action: 'create',\r\n          coins,\r\n          amount_usd: amount,\r\n          username: profile?.username || user.email?.split('@')[0] || 'user',\r\n          cashapp_tag: tag,\r\n          package_id: packageId,\r\n          purchase_type: purchaseType,\r\n        }),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}));\r\n        throw new Error(errorData.error || `Failed to create order (${res.status})`);\r\n      }\r\n\r\n      const data = await res.json();\r\n      if (!data.success || !data.orderId) {\r\n        throw new Error('No order ID returned');\r\n      }\r\n\r\n      setOrderId(data.orderId);\r\n      setNoteSuggested(data.instructions?.note || '');\r\n      setStep('awaiting');\r\n      toast.success('Payment request created! Follow the Cash App instructions below.');\r\n      // Do not call onSuccess immediately - wait for user to complete payment flow\r\n    } catch (err: any) {\r\n      console.error('Failed to create manual order:', err);\r\n      toast.error(err?.message || 'Failed to create payment request');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleCopyNote = () => {\r\n    if (noteSuggested) {\r\n      navigator.clipboard.writeText(noteSuggested);\r\n      setCopied(true);\r\n      toast.success('Copied to clipboard!');\r\n      setTimeout(() => setCopied(false), 2000);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-gray-900 rounded-xl p-6 max-w-md w-full border border-purple-500/30\">\r\n        <div className=\"flex items-center justify-between mb-6\">\r\n          <h2 className=\"text-xl font-bold text-white\">Cash App Payment</h2>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"p-1 hover:bg-gray-800 rounded transition-colors\"\r\n          >\r\n            <X size={20} />\r\n          </button>\r\n        </div>\r\n\r\n        {step === 'confirm' && (\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-gradient-to-r from-green-500/10 to-blue-500/10 border border-green-500/30 rounded-lg p-4 space-y-2\">\r\n            <div className=\"flex justify-between items-center\">\r\n              <span className=\"text-gray-300\">Item</span>\r\n              <span className=\"text-xl font-bold text-white\">{itemName || `${coins.toLocaleString()} Coins`}</span>\r\n            </div>\r\n            <div className=\"flex justify-between items-center\">\r\n              <span className=\"text-gray-300\">Amount</span>\r\n              <span className=\"text-xl font-bold text-green-400\">${amount.toFixed(2)}</span>\r\n            </div>\r\n          </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-xs text-gray-300 font-semibold\">Your Cash App tag (no $)</label>\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"px-2 py-2 bg-gray-800 rounded border border-gray-700 text-gray-200 text-sm\">$</span>\r\n                <input\r\n                  value={cashTag}\r\n                  onChange={(e) => setCashTag(e.target.value)}\r\n                  onBlur={() => cashTag && ensureCashTag()}\r\n                  placeholder=\"yourcashtag\"\r\n                  className=\"flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:border-green-400 outline-none\"\r\n                />\r\n              </div>\r\n              {cashTagError && <p className=\"text-xs text-red-300\">{cashTagError}</p>}\r\n              <p className=\"text-[11px] text-gray-400\">We include this tag for admins/secretaries to match your Cash App payment.</p>\r\n            </div>\r\n\r\n            <div className=\"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 flex gap-3\">\r\n              <AlertCircle size={20} className=\"text-blue-400 flex-shrink-0 mt-0.5\" />\r\n              <div className=\"text-sm text-blue-100\">\r\n                <p className=\"font-semibold mb-1\">How it works:</p>\r\n                <ol className=\"space-y-1 text-xs list-decimal list-inside\">\r\n                  <li>Send ${amount.toFixed(2)} via Cash App to <span className=\"font-bold\">$trollcity95</span></li>\r\n                  <li>Our team verifies the payment</li>\r\n                  <li>Coins are granted to your account</li>\r\n                </ol>\r\n              </div>\r\n            </div>\r\n\r\n            <button\r\n              onClick={handleCreateOrder}\r\n              disabled={loading}\r\n              className=\"w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2\"\r\n            >\r\n              {loading ? (\r\n                <>\r\n                  <Loader2 size={18} className=\"animate-spin\" />\r\n                  Creating Request...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Send size={18} />\r\n                  Proceed to Cash App\r\n                </>\r\n              )}\r\n            </button>\r\n\r\n            <button\r\n              onClick={onClose}\r\n              className=\"w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded-lg transition-colors\"\r\n            >\r\n              Cancel\r\n            </button>\r\n          </div>\r\n        )}\r\n\r\n        {step === 'awaiting' && (\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 space-y-3\">\r\n              <h3 className=\"font-semibold text-white\">Your Payment Instructions</h3>\r\n\r\n              <div className=\"space-y-2\">\r\n                <div>\r\n                  <p className=\"text-xs text-gray-400 mb-1\">Send to</p>\r\n                  <div className=\"bg-gray-800 rounded px-3 py-2 font-mono text-white flex items-center justify-between\">\r\n                    <span className=\"font-bold\">$trollcity95</span>\r\n                    <button\r\n                      onClick={() => {\r\n                        navigator.clipboard.writeText('$trollcity95');\r\n                        toast.success('Copied!');\r\n                      }}\r\n                      className=\"hover:bg-gray-700 p-1 rounded transition-colors\"\r\n                    >\r\n                      <Copy size={16} />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n\r\n                <div>\r\n                  <p className=\"text-xs text-gray-400 mb-1\">Amount</p>\r\n                  <div className=\"bg-gray-800 rounded px-3 py-2 font-mono text-green-400 font-bold\">\r\n                    ${amount.toFixed(2)}\r\n                  </div>\r\n                </div>\r\n\r\n                <div>\r\n                  <p className=\"text-xs text-gray-400 mb-1\">Payment Note</p>\r\n                  <div className=\"bg-gray-800 rounded px-3 py-2 font-mono text-white flex items-center justify-between gap-2\">\r\n                    <span className=\"font-bold\">{noteSuggested}</span>\r\n                    <button\r\n                      onClick={handleCopyNote}\r\n                      className=\"hover:bg-gray-700 p-1 rounded transition-colors flex-shrink-0\"\r\n                    >\r\n                      <Copy size={16} className={copied ? 'text-green-400' : ''} />\r\n                    </button>\r\n                  </div>\r\n                  <p className=\"text-xs text-gray-500 mt-1\">\r\n                    This reference code helps us identify your payment\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gray-800 rounded p-3 text-sm text-gray-300\">\r\n                <p className=\"font-semibold mb-1\">What happens next?</p>\r\n                <ul className=\"space-y-1 text-xs\">\r\n                  <li>‚úì We receive your Cash App notification</li>\r\n                  <li>‚úì Admin verifies the payment (usually within 24 hours)</li>\r\n                  <li>‚úì {coins.toLocaleString()} coins are added to your account</li>\r\n                  <li>‚úì You'll get a notification when complete</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n\r\n            <button\r\n              onClick={() => {\r\n                if (orderId) onSuccess?.(orderId);\r\n                onClose();\r\n              }}\r\n              className=\"w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors\"\r\n            >\r\n              Done - I'll Complete Payment\r\n            </button>\r\n\r\n            <p className=\"text-xs text-gray-500 text-center\">\r\n              Order ID: <span className=\"font-mono\">{orderId}</span>\r\n            </p>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\ChatBottomSheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\ChatBox.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'trackChatMessage' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'shadowBannedUsers' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":71,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":71,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentUserId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":72,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\r\nimport { Send, Coins, Shield, Image as ImageIcon } from \"lucide-react\";\r\nimport { supabase } from \"../../lib/supabase\";\r\nimport { toast } from \"sonner\";\r\nimport ClickableUsername from \"../ClickableUsername\";\r\nimport { UserBadge } from \"../UserBadge\";\r\nimport { useXPTracking } from '../../lib/hooks/useXPTracking';\r\n\r\ninterface ChatBoxProps {\r\n  streamId: string;\r\n  onProfileClick?: (profile: any) => void;\r\n  onCoinSend?: (user: string, amount: number) => void;\r\n  room?: any; // LiveKit Room\r\n  isBroadcaster?: boolean;\r\n}\r\n\r\ninterface Message {\r\n  id: string;\r\n  user_id: string;\r\n  content: string;\r\n  message_type: string;\r\n  created_at: string;\r\n  sender_profile?: {\r\n    id: string;\r\n    username: string;\r\n    perks: string[];\r\n    hasInsurance?: boolean;\r\n    rgbExpiresAt?: string;\r\n    avatar_url?: string;\r\n    is_ghost_mode?: boolean;\r\n    role?: string | null;\r\n    is_admin?: boolean;\r\n    drivers_license_status?: string;\r\n    is_banned?: boolean;\r\n  };\r\n}\r\n\r\nexport default function ChatBox({ streamId, onProfileClick, onCoinSend, isBroadcaster }: ChatBoxProps) {\r\n  const { trackChatMessage } = useXPTracking();\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [inputValue, setInputValue] = useState(\"\");\r\n  const chatEndRef = useRef<HTMLDivElement>(null);\r\n  const chatContainerRef = useRef<HTMLDivElement>(null);\r\n  const suppressAutoScrollRef = useRef(false);\r\n  const [isMuted, setIsMuted] = useState(false);\r\n  const [imageUploading, setImageUploading] = useState(false);\r\n  const imageInputRef = useRef<HTMLInputElement>(null);\r\n  const userCacheRef = useRef<\r\n    Record<\r\n      string,\r\n      {\r\n        id: string;\r\n        username: string;\r\n        perks: string[];\r\n        hasInsurance: boolean;\r\n        rgbExpiresAt?: string;\r\n        avatar_url?: string;\r\n        is_ghost_mode?: boolean;\r\n        role?: string | null;\r\n        is_admin?: boolean;\r\n        drivers_license_status?: string;\r\n        is_banned?: boolean;\r\n      }\r\n    >\r\n  >({});\r\n  \r\n  const [showCoinInput, setShowCoinInput] = useState<string | null>(null);\r\n  const [coinAmount, setCoinAmount] = useState(10);\r\n\r\n  const [isGlobalBanned, setIsGlobalBanned] = useState(false);\r\n  const [shadowBannedUsers, setShadowBannedUsers] = useState<Set<string>>(new Set());\r\n  const [currentUserId, setCurrentUserId] = useState<string | null>(null);\r\n\r\n  const fetchUserProfile = useCallback(async (userId: string) => {\r\n    if (userCacheRef.current[userId]) return userCacheRef.current[userId];\r\n\r\n    try {\r\n      const { data: profile } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, rgb_username_expires_at, avatar_url, is_ghost_mode, role, is_admin, drivers_license_status, is_banned')\r\n        .eq('id', userId)\r\n        .single();\r\n        \r\n      const { data: perks } = await supabase\r\n        .from('user_perks')\r\n        .select('perk_id')\r\n        .eq('user_id', userId)\r\n        .eq('is_active', true);\r\n\r\n      const { data: insurance } = await supabase\r\n        .from('user_insurances')\r\n        .select('insurance_id')\r\n        .eq('user_id', userId)\r\n        .eq('is_active', true)\r\n        .gt('expires_at', new Date().toISOString())\r\n        .limit(1);\r\n\r\n      const userData = {\r\n        id: profile?.id || userId,\r\n        username: profile?.username || 'Unknown Troll',\r\n        perks: perks?.map((p) => p.perk_id) || [],\r\n        hasInsurance: Boolean(insurance && insurance.length > 0),\r\n        rgbExpiresAt: profile?.rgb_username_expires_at,\r\n        avatar_url: profile?.avatar_url,\r\n        is_ghost_mode: profile?.is_ghost_mode,\r\n        role: profile?.role ?? null,\r\n        is_admin: profile?.is_admin ?? false,\r\n        drivers_license_status: profile?.drivers_license_status,\r\n        is_banned: profile?.is_banned ?? false\r\n      };\r\n\r\n      userCacheRef.current[userId] = userData;\r\n      return userData;\r\n    } catch (e) {\r\n      console.error('Failed to fetch user profile', e);\r\n      return {\r\n        id: userId,\r\n        username: 'Unknown',\r\n        perks: [],\r\n        hasInsurance: false,\r\n      };\r\n    }\r\n  }, []);\r\n\r\n  // Fetch active shadow bans\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n\r\n    const fetchShadowBans = async () => {\r\n      const { data } = await supabase\r\n        .from('shadow_bans')\r\n        .select('target_user_id')\r\n        .eq('stream_id', streamId)\r\n        .eq('is_active', true)\r\n        .gt('expires_at', new Date().toISOString());\r\n      \r\n      if (data) {\r\n        setShadowBannedUsers(new Set(data.map(b => b.target_user_id)));\r\n      }\r\n    };\r\n\r\n    fetchShadowBans();\r\n\r\n    const channel = supabase\r\n      .channel(`shadow_bans:${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'shadow_bans',\r\n          filter: `stream_id=eq.${streamId}`\r\n        },\r\n        () => {\r\n          fetchShadowBans();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId]);\r\n\r\n  // Check global ban status and get current user\r\n  useEffect(() => {\r\n    const checkBanStatus = async () => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (user) {\r\n        setCurrentUserId(user.id);\r\n        const profile = await fetchUserProfile(user.id);\r\n        if (profile.is_banned) {\r\n          setIsGlobalBanned(true);\r\n        }\r\n      }\r\n    };\r\n    checkBanStatus();\r\n  }, [fetchUserProfile]);\r\n\r\n  // Listen for new messages\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n\r\n    const fetchMessages = async () => {\r\n      const { data } = await supabase\r\n        .from('messages')\r\n        .select('*')\r\n        .eq('stream_id', streamId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(50);\r\n\r\n      if (data) {\r\n        const reversed = data.reverse();\r\n        // Fetch profiles for all senders - use user_id consistently\r\n        const uniqueUsers = [...new Set(reversed.map(m => m.user_id))];\r\n        \r\n        const cacheUpdates: Record<string, any> = {};\r\n        await Promise.all(uniqueUsers.map(async (uid) => {\r\n           if (uid) cacheUpdates[uid] = await fetchUserProfile(uid);\r\n        }));\r\n\r\n        setMessages(reversed.map(m => ({\r\n          ...m,\r\n          user_id: m.user_id || m.sender_id, // Ensure user_id is always set\r\n          sender_profile: cacheUpdates[m.user_id || m.sender_id]\r\n        })));\r\n      }\r\n    };\r\n\r\n    fetchMessages();\r\n\r\n    // Subscribe to new messages\r\n    const channel = supabase\r\n      .channel(`chat-${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'messages',\r\n          filter: `stream_id=eq.${streamId}`,\r\n        },\r\n        async (payload) => {\r\n          const newMsg = payload.new as Message;\r\n          \r\n          // Ensure user_id is set (handle sender_id fallback)\r\n          const msgUserId = newMsg.user_id || (newMsg as any).sender_id;\r\n          if (!msgUserId) return; // Skip if no user ID\r\n          \r\n          // Get createdAt timestamp for duplicate detection\r\n          const createdAt = new Date(newMsg.created_at).getTime();\r\n          \r\n          // Fetch sender profile if not in cache\r\n          let senderProfile = userCacheRef.current[msgUserId];\r\n          if (!senderProfile) {\r\n            senderProfile = await fetchUserProfile(msgUserId);\r\n          }\r\n\r\n          setMessages(prev => {\r\n            // Check if this message already exists (optimistic update or duplicate)\r\n            const exists = prev.some(msg => {\r\n              const existingUserId = msg.user_id || (msg as any).sender_id;\r\n              if (existingUserId !== msgUserId) return false;\r\n              if (msg.content !== newMsg.content) return false;\r\n              const existingTime = new Date(msg.created_at).getTime();\r\n              return Math.abs(existingTime - createdAt) <= 1000; // Within 1 second = same message\r\n            });\r\n            if (exists) return prev;\r\n            \r\n            const cleaned = prev.filter((msg) => {\r\n              if ((msg.user_id || (msg as any).sender_id) !== msgUserId) return true;\r\n              if (msg.content !== newMsg.content) return true;\r\n              const msgTime = new Date(msg.created_at).getTime();\r\n              return Math.abs(msgTime - createdAt) > 3000;\r\n            });\r\n            return [...cleaned, { ...newMsg, user_id: msgUserId, sender_profile: senderProfile }];\r\n          });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId, fetchUserProfile]);\r\n\r\n  // Auto-remove messages older than 30 seconds\r\n  useEffect(() => {\r\n    const interval = setInterval(() => {\r\n      setMessages((prev) => {\r\n        const now = Date.now();\r\n        const hasOld = prev.some(m => now - new Date(m.created_at).getTime() > 30000);\r\n        if (!hasOld) return prev;\r\n        \r\n        return prev.filter((msg) => {\r\n          const age = now - new Date(msg.created_at).getTime();\r\n          return age <= 30000;\r\n        });\r\n      });\r\n    }, 1000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, []);\r\n\r\n  // Check stream-level mute status for current user\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      try {\r\n        const { data: session } = await supabase.auth.getUser();\r\n        const uid = session.user?.id;\r\n        if (!uid || !streamId) return;\r\n        const { data: sp } = await supabase\r\n          .from('streams_participants')\r\n          .select('can_chat, chat_mute_until')\r\n          .eq('stream_id', streamId)\r\n          .eq('user_id', uid)\r\n          .maybeSingle();\r\n        if (!mounted) return;\r\n        const now = Date.now();\r\n        const mutedUntil = sp?.chat_mute_until ? new Date(sp.chat_mute_until).getTime() : 0;\r\n        const muted = sp?.can_chat === false || mutedUntil > now;\r\n        setIsMuted(Boolean(muted));\r\n      } catch {}\r\n    })();\r\n\r\n    // Listen for changes\r\n    const channel = supabase\r\n      .channel(`sp_mute_${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        { event: 'UPDATE', schema: 'public', table: 'streams_participants', filter: `stream_id=eq.${streamId}` },\r\n        async () => {\r\n          try {\r\n            const { data: session } = await supabase.auth.getUser();\r\n            const uid = session.user?.id;\r\n            if (!uid || !streamId) return;\r\n            const { data: sp } = await supabase\r\n              .from('streams_participants')\r\n              .select('can_chat, chat_mute_until')\r\n              .eq('stream_id', streamId)\r\n              .eq('user_id', uid)\r\n              .maybeSingle();\r\n            const now = Date.now();\r\n            const mutedUntil = sp?.chat_mute_until ? new Date(sp.chat_mute_until).getTime() : 0;\r\n            const muted = sp?.can_chat === false || mutedUntil > now;\r\n            setIsMuted(Boolean(muted));\r\n          } catch {}\r\n        }\r\n      )\r\n      .subscribe();\r\n    return () => {\r\n      mounted = false;\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId]);\r\n\r\n  const scrollToBottom = (smooth = true) => {\r\n    const el = chatContainerRef.current;\r\n    if (!el) return;\r\n    const shouldScroll = el.scrollHeight - (el.scrollTop + el.clientHeight) < 200;\r\n    if (suppressAutoScrollRef.current) return;\r\n    if (shouldScroll) {\r\n      el.scrollTo({ top: el.scrollHeight, behavior: smooth ? \"smooth\" : \"auto\" });\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    scrollToBottom(true);\r\n  }, [messages]);\r\n\r\n  const handleSendMessage = async () => {\r\n    if (inputValue.trim() === \"\") return;\r\n\r\n    if (isMuted) {\r\n        toast.error(\"You are muted in this stream.\");\r\n        return;\r\n    }\r\n\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) {\r\n        toast.error('You must be logged in to chat');\r\n        return;\r\n      }\r\n\r\n      const { error } = await supabase.from('messages').insert({\r\n        stream_id: streamId,\r\n        user_id: user.id,\r\n        content: inputValue,\r\n        message_type: 'chat'\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      const profile = await fetchUserProfile(user.id);\r\n      const optimisticMessage: Message = {\r\n        id: (globalThis.crypto && 'randomUUID' in globalThis.crypto)\r\n          ? (globalThis.crypto as Crypto).randomUUID()\r\n          : `local-${Date.now()}-${Math.random().toString(16).slice(2)}`,\r\n        user_id: user.id,\r\n        content: inputValue,\r\n        message_type: 'chat',\r\n        created_at: new Date().toISOString(),\r\n        sender_profile: profile,\r\n      };\r\n      setMessages((prev) => [...prev, optimisticMessage]);\r\n\r\n      setInputValue(\"\");\r\n      suppressAutoScrollRef.current = true;\r\n      setTimeout(() => {\r\n        suppressAutoScrollRef.current = false;\r\n        scrollToBottom();\r\n      }, 300);\r\n    } catch (e) {\r\n      console.error('Failed to send message', e);\r\n      toast.error('Failed to send message');\r\n    }\r\n  };\r\n\r\n  const handleUploadImage = async (file: File) => {\r\n    if (!file) return;\r\n    if (isMuted) {\r\n      toast.error(\"You are muted in this stream.\");\r\n      return;\r\n    }\r\n    try {\r\n      setImageUploading(true);\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) {\r\n        toast.error('You must be logged in to chat');\r\n        setImageUploading(false);\r\n        return;\r\n      }\r\n      const ext = file.name.split('.').pop() || 'jpg';\r\n      const name = `${user.id}-${Date.now()}.${ext}`;\r\n      const attempts = [\r\n        { bucket: 'covers', path: `chat/${name}` },\r\n        { bucket: 'profile-avatars', path: `chat/${name}` },\r\n        { bucket: 'public', path: name }\r\n      ];\r\n      let uploadedUrl: string | null = null;\r\n      let lastErr: any = null;\r\n      for (const attempt of attempts) {\r\n        try {\r\n          const { error: uploadErr } = await supabase.storage\r\n            .from(attempt.bucket)\r\n            .upload(attempt.path, file, { cacheControl: '3600', upsert: true });\r\n          if (uploadErr) {\r\n            lastErr = uploadErr;\r\n            continue;\r\n          }\r\n          const { data: urlData } = supabase.storage.from(attempt.bucket).getPublicUrl(attempt.path);\r\n          if (urlData?.publicUrl) {\r\n            uploadedUrl = urlData.publicUrl;\r\n            break;\r\n          }\r\n        } catch (err) {\r\n          lastErr = err;\r\n        }\r\n      }\r\n      if (!uploadedUrl) {\r\n        throw lastErr || new Error('Failed to upload image');\r\n      }\r\n      const { error } = await supabase.from('messages').insert({\r\n        stream_id: streamId,\r\n        user_id: user.id,\r\n        content: uploadedUrl,\r\n        message_type: 'image'\r\n      });\r\n      if (error) {\r\n        throw error;\r\n      }\r\n      const profile = await fetchUserProfile(user.id);\r\n      const optimisticMessage: Message = {\r\n        id: (globalThis.crypto && 'randomUUID' in globalThis.crypto)\r\n          ? (globalThis.crypto as Crypto).randomUUID()\r\n          : `local-${Date.now()}-${Math.random().toString(16).slice(2)}`,\r\n        user_id: user.id,\r\n        content: uploadedUrl,\r\n        message_type: 'image',\r\n        created_at: new Date().toISOString(),\r\n        sender_profile: profile,\r\n      };\r\n      setMessages((prev) => [...prev, optimisticMessage]);\r\n      setTimeout(() => scrollToBottom(), 200);\r\n    } catch (e: any) {\r\n      console.error('Image upload failed', e);\r\n      toast.error(e?.message || 'Failed to upload image');\r\n    } finally {\r\n      setImageUploading(false);\r\n      if (imageInputRef.current) imageInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  const handleKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  };\r\n\r\n  const getUsernameStyle = (perks: string[] = [], rgbExpiresAt?: string) => {\r\n    let classes = \"font-bold transition-colors \";\r\n    // Prioritize RGB Username\r\n    if (rgbExpiresAt && new Date(rgbExpiresAt) > new Date()) {\r\n      classes += \"rgb-username \";\r\n    } else if (perks.includes('perk_rgb_username')) { // Legacy check\r\n      classes += \"rgb-username \";\r\n    } else if (perks.includes('perk_global_highlight')) {\r\n      classes += \"text-neon-green drop-shadow-[0_0_5px_rgba(57,255,20,0.8)] \";\r\n    } else {\r\n      classes += \"text-purple-300 hover:text-purple-200 \";\r\n    }\r\n    return classes;\r\n  };\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col min-h-0 bg-gradient-to-b from-gray-900 to-black rounded-lg p-[clamp(8px,2.5vw,16px)] purple-neon\">\r\n      <h3 className=\"text-[clamp(11px,3.5vw,14px)] font-bold mb-3\">LIVE CHAT</h3>\r\n\r\n      <div ref={chatContainerRef} className=\"flex-1 overflow-y-auto overscroll-contain space-y-2 mb-3 min-h-0 pr-2\">\r\n        {/** Render messages deduplicated by `id` to avoid duplicate React keys */}\r\n        {useMemo(() => {\r\n          const map = new Map<string, Message>();\r\n          for (const m of messages) {\r\n            if (!m || !m.id) continue;\r\n            if (!map.has(m.id)) map.set(m.id, m);\r\n          }\r\n          return Array.from(map.values()).filter((msg) => {\r\n            // Filter out ghost mode officers\r\n            if ((msg.sender_profile as any)?.is_ghost_mode) return false;\r\n            return true;\r\n          });\r\n        }, [messages]).map((msg) => {\r\n          if (msg.message_type === 'entrance' || msg.message_type === 'system-join') {\r\n            return null;\r\n          }\r\n\r\n          if (msg.message_type === 'system' && msg.content === 'ACTION:LIKE') {\r\n             return (\r\n               <div key={msg.id} className=\"text-xs text-center text-pink-400 italic animate-pulse\">\r\n                 {msg.sender_profile?.username} sent a like! ‚ù§Ô∏è\r\n               </div>\r\n             );\r\n          }\r\n\r\n          return (\r\n            <div\r\n              key={msg.id}\r\n              className=\"text-xs animate-fadeIn rgb-neon rounded p-2 bg-gray-800/50 group hover:bg-gray-800/70 transition-colors\"\r\n            >\r\n              <div className=\"flex items-center justify-between mb-1\">\r\n                <div className=\"flex items-center gap-1 flex-wrap\">\r\n                  {msg.sender_profile?.hasInsurance && (\r\n                    <Shield size={12} className=\"text-blue-400\" fill=\"currentColor\" />\r\n                  )}\r\n                  {msg.sender_profile?.perks?.includes('perk_flex_banner') && 'üëë '}\r\n                  <ClickableUsername\r\n                    username={msg.sender_profile?.username || 'Unknown'}\r\n                    profile={msg.sender_profile as any}\r\n                    userId={msg.user_id}\r\n                    isBroadcaster={isBroadcaster}\r\n                    streamId={streamId}\r\n                    className={getUsernameStyle(msg.sender_profile?.perks, msg.sender_profile?.rgbExpiresAt)}\r\n                    onClick={() => {\r\n                      const base = msg.sender_profile || { username: 'Unknown' };\r\n                      const payload = { id: msg.user_id, ...base };\r\n                      onProfileClick?.(payload);\r\n                    }}\r\n                  />\r\n                  <UserBadge profile={msg.sender_profile ? { level: 1, ...msg.sender_profile } : undefined} />\r\n                </div>\r\n                <button\r\n                  onClick={() =>\r\n                    setShowCoinInput(showCoinInput === msg.id ? null : msg.id)\r\n                  }\r\n                  className=\"text-yellow-400 hover:text-yellow-300 transition-colors opacity-0 group-hover:opacity-100\"\r\n                >\r\n                  <Coins size={14} />\r\n                </button>\r\n              </div>\r\n              {msg.message_type === 'image' ? (\r\n                <img\r\n                  src={msg.content}\r\n                  alt=\"image\"\r\n                  className=\"mt-1 max-h-64 rounded border border-white/10 object-contain\"\r\n                />\r\n              ) : (\r\n                <span className=\"text-gray-300 break-words\">{msg.content}</span>\r\n              )}\r\n\r\n              {showCoinInput === msg.id && (\r\n                <div className=\"mt-2 flex gap-2 items-center\">\r\n                  <input\r\n                    type=\"number\"\r\n                    value={coinAmount}\r\n                    onChange={(e) =>\r\n                      setCoinAmount(Math.max(1, parseInt(e.target.value) || 1))\r\n                    }\r\n                    className=\"flex-1 bg-gray-700 text-white rounded px-2 py-1 text-xs\"\r\n                    placeholder=\"Amount\"\r\n                  />\r\n                  <button\r\n                    onClick={() => {\r\n                      onCoinSend?.(msg.sender_profile?.username || 'User', coinAmount);\r\n                      setShowCoinInput(null);\r\n                      setCoinAmount(10);\r\n                    }}\r\n                    className=\"bg-yellow-500 hover:bg-yellow-600 text-black px-2 py-1 rounded text-xs font-bold\"\r\n                  >\r\n                    Send\r\n                  </button>\r\n                </div>\r\n              )}\r\n            </div>\r\n          );\r\n        })}\r\n        <div ref={chatEndRef} />\r\n      </div>\r\n\r\n      <div className=\"flex gap-2 sticky bottom-0 bg-gray-900/95 px-1 py-2 -mx-1 sm:static sm:bg-transparent sm:px-0 sm:py-0 sm:mx-0\">\r\n        <input\r\n          ref={imageInputRef}\r\n          type=\"file\"\r\n          accept=\"image/*\"\r\n          capture=\"environment\"\r\n          className=\"hidden\"\r\n          onChange={(e) => {\r\n            const f = e.target.files?.[0] || null;\r\n            if (f) handleUploadImage(f);\r\n          }}\r\n        />\r\n        <button\r\n          onClick={() => imageInputRef.current?.click()}\r\n          disabled={imageUploading}\r\n          className=\"bg-white/10 hover:bg-white/20 p-2 rounded transition-colors disabled:opacity-60\"\r\n        >\r\n          <ImageIcon size={16} />\r\n        </button>\r\n        <input\r\n          type=\"text\"\r\n          value={inputValue}\r\n          onChange={(e) => setInputValue(e.target.value)}\r\n          onKeyDown={handleKeyPress}\r\n          placeholder={isGlobalBanned ? \"You are banned\" : isMuted ? \"You are muted\" : \"Type a message...\"}\r\n          className=\"flex-1 bg-white/10 border-none rounded px-3 py-2 text-xs text-white focus:ring-1 focus:ring-purple-500 disabled:opacity-50\"\r\n          disabled={isMuted || isGlobalBanned}\r\n        />\r\n        <button\r\n          onClick={handleSendMessage}\r\n          disabled={isMuted || isGlobalBanned || !inputValue.trim()}\r\n          className=\"bg-purple-600 hover:bg-purple-500 p-2 rounded text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n        >\r\n          <Send size={16} />\r\n        </button>\r\n      </div>\r\n\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\CoinStoreModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\EntranceEffect.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\FloatingActionCluster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\FlyingChatOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\GiftBox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\GiftModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\MobileBroadcastLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\MoreControlsDrawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\ParticipantBoxes.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\ParticipantStrip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\ProfileModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\SeatCostPopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\StatsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\TopLiveBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\TrollBattleOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\TrollBattlesSetup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\TrollLikeButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\UserActionsMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\broadcast\\VideoTile.tsx","messages":[{"ruleId":"react/no-unknown-property","severity":2,"message":"Invalid property 'playsInline' found on tag 'audio', but it is only allowed on: video","line":328,"column":38,"nodeType":"JSXAttribute","messageId":"invalidPropOnTag","endLine":328,"endColumn":49}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react'\r\nimport { Participant, Track, LocalParticipant } from 'livekit-client'\r\nimport { User, Mic, MicOff, Camera, CameraOff, X, RefreshCw, Maximize2, Minimize2, Crown, Coins } from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\n\r\nconst CAMERA_ZOOM = 0.9;\r\n\r\ninterface VideoTileProps {\r\n  participant: Participant\r\n  isBroadcaster?: boolean\r\n  className?: string\r\n  style?: React.CSSProperties\r\n  onLeave?: () => void\r\n  isLocal?: boolean\r\n  showControls?: boolean\r\n  fit?: 'cover' | 'contain'\r\n  price?: number\r\n  coinBalance?: number\r\n  compact?: boolean\r\n  isHost?: boolean\r\n  onDisableGuestMedia?: (participantId: string, disableVideo: boolean, disableAudio: boolean) => void\r\n  onClick?: (participant: Participant) => void\r\n  frameMode?: 'none' | 'rgb'\r\n}\r\n\r\nexport default function VideoTile({\r\n  participant,\r\n  isBroadcaster,\r\n  className = '',\r\n  style,\r\n  onLeave,\r\n  isLocal,\r\n  fit = 'cover',\r\n  price,\r\n  coinBalance,\r\n  compact = false,\r\n  isHost = false,\r\n  onDisableGuestMedia,\r\n  onClick,\r\n  frameMode = 'none',\r\n}: VideoTileProps) {\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const audioRef = useRef<HTMLAudioElement>(null);\r\n  const [speaking, setSpeaking] = useState(false);\r\n  const [isVideoEnabled, setIsVideoEnabled] = useState(false);\r\n  const [isAudioEnabled, setIsAudioEnabled] = useState(false);\r\n  const [showLocalControls, setShowLocalControls] = useState(false);\r\n  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n  const [objectFit, setObjectFit] = useState<'cover' | 'contain'>(fit);\r\n\r\n  // Sync prop fit with state\r\n  useEffect(() => {\r\n    setObjectFit(fit);\r\n  }, [fit]);\r\n\r\n  // Fetch profile for avatar\r\n  useEffect(() => {\r\n    const fetchProfile = async () => {\r\n        if (!participant.identity) return;\r\n        const { data } = await supabase.from('user_profiles').select('avatar_url').eq('id', participant.identity).maybeSingle();\r\n        if (data?.avatar_url) setAvatarUrl(data.avatar_url);\r\n    };\r\n    fetchProfile();\r\n  }, [participant.identity]);\r\n\r\n  useEffect(() => {\r\n    const attachVideo = () => {\r\n        const vidPub = participant.getTrackPublication(Track.Source.Camera);\r\n        // For LocalParticipant, isSubscribed might be false/undefined but track is present\r\n        const isLocalParticipant = participant instanceof LocalParticipant;\r\n        const canAttach = vidPub && (vidPub.isSubscribed || isLocalParticipant) && vidPub.videoTrack;\r\n        \r\n        if (canAttach && videoRef.current) {\r\n          console.log(`[VideoTile] Attaching video track for ${participant.identity} (Local: ${isLocalParticipant})`);\r\n          vidPub.videoTrack!.attach(videoRef.current);\r\n          if (isLocalParticipant) {\r\n            videoRef.current.muted = true;\r\n            videoRef.current.volume = 0;\r\n          }\r\n          videoRef.current.playsInline = true;\r\n          videoRef.current.play().catch(e => console.error(\"Video play failed\", e));\r\n          // Show video as soon as a track is attached (don't hide video just because it's muted)\r\n          setIsVideoEnabled(Boolean(vidPub.videoTrack));\r\n        } else {\r\n           // If we can't attach yet, maybe it's because track isn't subscribed/published\r\n           console.log(`[VideoTile] Cannot attach video for ${participant.identity}. Pub: ${!!vidPub}, Track: ${!!vidPub?.videoTrack}`);\r\n        }\r\n    };\r\n    const attachAudio = () => {\r\n      const micPub = participant.getTrackPublication(Track.Source.Microphone);\r\n      const audioTrack = micPub?.audioTrack;\r\n      if (audioTrack && audioRef.current) {\r\n        audioTrack.attach(audioRef.current);\r\n        audioRef.current.muted = isLocal ?? false;\r\n        audioRef.current.volume = isLocal ? 0 : 1;\r\n        audioRef.current.play().catch(() => {});\r\n      }\r\n    };\r\n    const detachAudio = () => {\r\n        const micPub = participant.getTrackPublication(Track.Source.Microphone);\r\n        const audioTrack = micPub?.audioTrack;\r\n        if (audioTrack && audioRef.current) {\r\n            audioTrack.detach(audioRef.current);\r\n        }\r\n    };\r\n    const detachVideo = () => {\r\n      const vidPub = participant.getTrackPublication(Track.Source.Camera);\r\n      const videoTrack = vidPub?.videoTrack;\r\n      if (videoTrack && videoRef.current) {\r\n        try {\r\n          videoTrack.detach(videoRef.current);\r\n        } catch {\r\n          // ignore\r\n        }\r\n      }\r\n    };\r\n\r\n    const onSpeakingChanged = () => setSpeaking(participant.isSpeaking);\r\n    const onTrackMuted = (pub: any) => {\r\n      // When a video track is muted we should not hide the video element\r\n      // Keep the attached video visible; only hide when unsubscribed/removed\r\n      if (pub.kind === Track.Kind.Audio) setIsAudioEnabled(false);\r\n    };\r\n    const onTrackUnmuted = (pub: any) => {\r\n        if (pub.kind === Track.Kind.Video) {\r\n            setIsVideoEnabled(true);\r\n            attachVideo(); // Re-attach just in case\r\n        }\r\n        if (pub.kind === Track.Kind.Audio) setIsAudioEnabled(true);\r\n    };\r\n    const onTrackSubscribed = (track: Track) => {\r\n        if (track.kind === Track.Kind.Video) {\r\n            attachVideo();\r\n        }\r\n        if (track.kind === Track.Kind.Audio) {\r\n            attachAudio();\r\n            setIsAudioEnabled(true);\r\n        }\r\n    };\r\n        const onTrackUnsubscribed = (track: Track) => {\r\n          if (track.kind === Track.Kind.Video) {\r\n           setIsVideoEnabled(false);\r\n           detachVideo();\r\n          }\r\n          if (track.kind === Track.Kind.Audio) detachAudio();\r\n        };\r\n\r\n    const onTrackPublished = (pub: any) => {\r\n        if (pub.kind === Track.Kind.Video) {\r\n             // Small delay to ensure track is fully ready\r\n             setTimeout(attachVideo, 100);\r\n        }\r\n    };\r\n\r\n    (participant as any).on('speakingChanged', onSpeakingChanged);\r\n    (participant as any).on('trackMuted', onTrackMuted);\r\n    (participant as any).on('trackUnmuted', onTrackUnmuted);\r\n    (participant as any).on('trackSubscribed', onTrackSubscribed);\r\n    (participant as any).on('trackUnsubscribed', onTrackUnsubscribed);\r\n    (participant as any).on('trackPublished', onTrackPublished);\r\n    \r\n    // Initial state check\r\n    setSpeaking(participant.isSpeaking);\r\n    attachVideo();\r\n    attachAudio();\r\n    const audPub = participant.getTrackPublication(Track.Source.Microphone);\r\n    if (audPub) {\r\n        setIsAudioEnabled(!audPub.isMuted);\r\n    }\r\n\r\n    return () => {\r\n        (participant as any).off('speakingChanged', onSpeakingChanged);\r\n        (participant as any).off('trackMuted', onTrackMuted);\r\n        (participant as any).off('trackUnmuted', onTrackUnmuted);\r\n        (participant as any).off('trackSubscribed', onTrackSubscribed);\r\n        (participant as any).off('trackUnsubscribed', onTrackUnsubscribed);\r\n        (participant as any).off('trackPublished', onTrackPublished);\r\n      detachAudio();\r\n      detachVideo();\r\n    };\r\n  }, [participant, isLocal]);\r\n\r\n  const toggleCamera = async (e: React.MouseEvent) => {\r\n      e.stopPropagation();\r\n      if (participant instanceof LocalParticipant) {\r\n          const enabled = await participant.setCameraEnabled(!isVideoEnabled);\r\n          setIsVideoEnabled(!!enabled);\r\n      }\r\n  };\r\n\r\n  const toggleMic = async (e: React.MouseEvent) => {\r\n      e.stopPropagation();\r\n      if (participant instanceof LocalParticipant) {\r\n          await participant.setMicrophoneEnabled(!isAudioEnabled);\r\n          const pub = participant.getTrackPublication(Track.Source.Microphone);\r\n          setIsAudioEnabled(pub ? !pub.isMuted : false);\r\n      }\r\n  };\r\n\r\n  const switchCamera = async (e: React.MouseEvent) => {\r\n      e.stopPropagation();\r\n      if (participant instanceof LocalParticipant) {\r\n         try {\r\n             const devices = await navigator.mediaDevices.enumerateDevices();\r\n             const videoDevices = devices.filter(d => d.kind === 'videoinput');\r\n             if (videoDevices.length > 1) {\r\n                 const currentTrack = participant.getTrackPublication(Track.Source.Camera)?.videoTrack;\r\n                 const currentDeviceId = currentTrack?.mediaStreamTrack.getSettings().deviceId;\r\n                 const nextDevice = videoDevices.find(d => d.deviceId !== currentDeviceId);\r\n                 if (nextDevice) {\r\n                     await participant.setCameraEnabled(false);\r\n                     await participant.setCameraEnabled(true, { deviceId: nextDevice.deviceId });\r\n                 }\r\n             }\r\n         } catch (err) {\r\n             console.error(\"Failed to switch camera\", err);\r\n         }\r\n      }\r\n  };\r\n\r\n  const toggleFit = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    setObjectFit(prev => prev === 'cover' ? 'contain' : 'cover');\r\n  };\r\n\r\n  // Extract metadata\r\n  const metadata = React.useMemo(() => {\r\n    try {\r\n      return JSON.parse(participant.metadata || '{}');\r\n    } catch {\r\n      return {};\r\n    }\r\n  }, [participant.metadata]);\r\n\r\n  const level = (metadata as any).level || 1;\r\n  const role = (metadata as any).role || 'Guest';\r\n  const carMetadata = (metadata as any).car || null;\r\n  const roleColor = role === 'Admin' ? 'text-yellow-400 border-yellow-500/30 bg-yellow-500/10' : 'text-purple-400 border-purple-500/30 bg-purple-500/10';\r\n  const seatUsernameStyle: React.CSSProperties = { fontSize: 'var(--seat-username-size)' };\r\n  const seatCoinStyle: React.CSSProperties = { fontSize: 'var(--seat-coin-size)', padding: 'var(--seat-chip-padding)' };\r\n  const videoTransformParts = [];\r\n  if (isLocal) {\r\n    videoTransformParts.push('scaleX(-1)');\r\n  }\r\n  videoTransformParts.push(`scale(${CAMERA_ZOOM})`);\r\n  const videoTransform = videoTransformParts.join(' ');\r\n\r\n  const handleBroadcasterClick = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n\r\n    if (onClick) {\r\n      onClick(participant);\r\n      return;\r\n    }\r\n\r\n    // Prevent any action if this is the broadcaster's own tile\r\n    if (isBroadcaster) {\r\n      return;\r\n    }\r\n    if (isHost && !isLocal && !isBroadcaster && onDisableGuestMedia) {\r\n      // Disable guest media when broadcaster clicks on guest box\r\n      onDisableGuestMedia(participant.identity, true, true);\r\n    } else if (isLocal && !isHost) {\r\n      setShowLocalControls(!showLocalControls);\r\n    }\r\n  };\r\n\r\n  const handleDisableVideo = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    if (onDisableGuestMedia) {\r\n      onDisableGuestMedia(participant.identity, true, false);\r\n      setShowLocalControls(false);\r\n    }\r\n  };\r\n\r\n  const handleDisableAudio = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    if (onDisableGuestMedia) {\r\n      onDisableGuestMedia(participant.identity, false, true);\r\n      setShowLocalControls(false);\r\n    }\r\n  };\r\n\r\n  const handleDisableBoth = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    if (onDisableGuestMedia) {\r\n      onDisableGuestMedia(participant.identity, true, true);\r\n      setShowLocalControls(false);\r\n    }\r\n  };\r\n\r\n  // Border Style Logic\r\n  const getBorderStyle = () => {\r\n    if (speaking) {\r\n      return 'border-2 border-yellow-400 shadow-[0_0_30px_rgba(250,204,21,0.8)] z-20';\r\n    }\r\n\r\n    if (frameMode === 'rgb') {\r\n      return 'border-2 border-transparent rgb-frame';\r\n    }\r\n\r\n    return 'border border-white/10 hover:border-white/30';\r\n  };\r\n\r\n  const borderClass = getBorderStyle();\r\n\r\n  return (\r\n    <div className={`relative w-full h-full transition-all duration-300 ${speaking ? 'scale-[1.02]' : ''}`} style={style}>\r\n      <div\r\n        className={`tile-inner relative w-full h-full rounded-2xl overflow-hidden transition-all duration-300 group shadow-lg ${className} ${borderClass}`}\r\n        onClick={handleBroadcasterClick}\r\n      >\r\n      {/* Video Element */}\r\n      <video\r\n        ref={videoRef}\r\n        className=\"w-full h-full transition-all duration-300 seatTile-video\"\r\n        muted={!!isLocal}\r\n        playsInline\r\n        autoPlay\r\n        style={{\r\n          objectFit,\r\n          transform: videoTransform,\r\n          filter: 'none',\r\n          backdropFilter: 'none',\r\n          WebkitBackdropFilter: 'none'\r\n        }}\r\n      />\r\n      <audio ref={audioRef} autoPlay playsInline muted={!!isLocal} className=\"hidden\" />\r\n      \r\n      {/* Fallback Profile Picture */}\r\n        {!isVideoEnabled && (\r\n          <div className={`absolute inset-0 flex flex-col items-center justify-center ${compact ? 'bg-transparent' : 'bg-transparent'}`}>\r\n              <div className={`relative ${speaking ? 'animate-pulse' : ''}`}>\r\n                  {avatarUrl ? (\r\n                      <img src={avatarUrl} alt={participant.identity} className=\"w-24 h-24 rounded-full border-4 border-purple-500/30 shadow-xl\" />\r\n                  ) : (\r\n                      <div className=\"w-24 h-24 rounded-full bg-white/5 flex items-center justify-center border-4 border-white/10\">\r\n                        <User size={40} className=\"text-white/20\" />\r\n                      </div>\r\n                  )}\r\n                  {!isAudioEnabled && (\r\n                    <div className=\"absolute bottom-0 right-0 bg-red-500 rounded-full p-1.5 border-2 border-[#1a1625]\">\r\n                        <MicOff size={12} className=\"text-white\" />\r\n                    </div>\r\n                  )}\r\n              </div>\r\n              <p className=\"mt-3 text-white/50 text-sm font-medium\">Camera Off</p>\r\n          </div>\r\n      )}\r\n\r\n      {/* Broadcaster Crown */}\r\n      {isBroadcaster && (\r\n         <div className=\"absolute top-3 left-3 z-10 drop-shadow-lg filter\">\r\n             <div className=\"relative\">\r\n                <Crown size={compact ? 16 : 24} className=\"text-yellow-400 fill-yellow-400 animate-pulse\" />\r\n                <div className=\"absolute inset-0 bg-yellow-400/50 rounded-full\" />\r\n             </div>\r\n         </div>\r\n      )}\r\n\r\n      {/* User Info Badge (Bottom Left) */}\r\n      {compact ? (\r\n        <div className=\"absolute bottom-2 left-2 right-2 z-10\">\r\n          <div className=\"flex items-center justify-between gap-2 bg-black/60 px-2 py-1 rounded-full border border-white/10 w-full\">\r\n            <span className=\"text-white/90 font-semibold truncate\" style={seatUsernameStyle}>\r\n              {participant.name || participant.identity || 'Guest'}\r\n            </span>\r\n            {typeof coinBalance === 'number' && (\r\n              <span\r\n                className=\"text-yellow-300 bg-yellow-500/10 border border-yellow-500/30 rounded-full flex items-center gap-1\"\r\n                style={seatCoinStyle}\r\n              >\r\n                <Coins className=\"w-3 h-3\" />\r\n                {coinBalance.toLocaleString()}\r\n              </span>\r\n            )}\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"absolute bottom-4 left-4 z-10 flex flex-col gap-2 max-w-[85%]\">\r\n          {/* Name Badge */}\r\n          <div className={`flex items-center gap-2 ${compact ? 'bg-transparent' : 'bg-[#1a0b2e]/90'} px-3 py-1.5 rounded-full border border-purple-500/30 shadow-lg w-fit`}>\r\n              {/* Connection Indicator */}\r\n              <div className={`w-2 h-2 rounded-full ${(participant as any).isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`} />\r\n              <span className=\"text-sm font-bold text-white truncate max-w-[120px]\">\r\n                  {participant.name || participant.identity || 'Guest'}\r\n              </span>\r\n              {!isAudioEnabled && <MicOff size={12} className=\"text-red-400\" />}\r\n          </div>\r\n          \r\n          {/* Role/Level Badge */}\r\n          <div className=\"flex items-center gap-2\">\r\n              <div className=\"flex items-center gap-1 bg-black/60 px-2 py-0.5 rounded border border-white/10\">\r\n                  <span className=\"text-[10px] font-bold text-yellow-500\">LV {level}</span>\r\n              </div>\r\n              <div className={`flex items-center gap-1 px-2 py-0.5 rounded border ${roleColor}`}>\r\n                  <span className=\"text-[10px] font-medium uppercase tracking-wider\">{role}</span>\r\n              </div>\r\n              {carMetadata && (\r\n                <div className=\"flex items-center gap-1\">\r\n                  <div\r\n                    className=\"h-4 w-8 rounded-full border border-white/20\"\r\n                    style={{\r\n                      background: carMetadata.colorFrom && carMetadata.colorTo\r\n                        ? `linear-gradient(90deg, ${carMetadata.colorFrom}, ${carMetadata.colorTo})`\r\n                        : 'linear-gradient(90deg, #4b5563, #111827)'\r\n                    }}\r\n                  />\r\n                  {carMetadata.name && (\r\n                    <span className=\"text-[9px] font-medium text-gray-200 truncate max-w-[80px]\">\r\n                      {carMetadata.name}\r\n                    </span>\r\n                  )}\r\n                </div>\r\n              )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Balance / Price Badges (Bottom Right) */}\r\n      {!compact && (typeof coinBalance === 'number' || (typeof price === 'number' && price > 0)) && (\r\n          <div className=\"absolute bottom-4 right-4 z-10 flex flex-col items-end gap-2\">\r\n          {typeof coinBalance === 'number' && (\r\n            <div className=\"bg-black/60 px-3 py-1.5 rounded-full border border-yellow-500/30 text-yellow-300 text-sm flex items-center gap-1\">\r\n              <Coins className=\"w-4 h-4\" />\r\n              <span>{coinBalance.toLocaleString()}</span>\r\n            </div>\r\n          )}\r\n          {typeof price === 'number' && price > 0 && (\r\n            <div className=\"bg-black/60 px-3 py-1.5 rounded-full border border-yellow-500/30 text-yellow-300 text-sm flex items-center gap-1\">\r\n              <Coins className=\"w-4 h-4\" />\r\n              <span>{price.toLocaleString()} coins</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {/* View Fit Toggle (Hover only) */}\r\n      <button \r\n        onClick={toggleFit}\r\n        className=\"absolute top-3 right-3 p-2 bg-black/40 rounded-full text-white/70 hover:text-white hover:bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity z-20\"\r\n        title=\"Toggle Fit\"\r\n      >\r\n        {objectFit === 'cover' ? <Minimize2 size={14} /> : <Maximize2 size={14} />}\r\n      </button>\r\n\r\n      {/* Local Controls Overlay */}\r\n        {isLocal && showLocalControls && (\r\n          <div className=\"absolute inset-0 bg-black/80 z-30 flex flex-col items-center justify-center gap-6 animate-fadeIn\">\r\n              <div className=\"flex items-center gap-6\">\r\n                  <button onClick={toggleMic} className={`p-4 rounded-full transition-transform hover:scale-110 ${isAudioEnabled ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/20'}`}>\r\n                      {isAudioEnabled ? <Mic size={28} /> : <MicOff size={28} />}\r\n                  </button>\r\n                  <button onClick={toggleCamera} className={`p-4 rounded-full transition-transform hover:scale-110 ${isVideoEnabled ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/20'}`}>\r\n                      {isVideoEnabled ? <Camera size={28} /> : <CameraOff size={28} />}\r\n                  </button>\r\n                  <button onClick={switchCamera} className=\"p-4 rounded-full bg-white/10 hover:bg-white/20 text-white transition-transform hover:scale-110\">\r\n                      <RefreshCw size={28} />\r\n                  </button>\r\n              </div>\r\n              {onLeave && (\r\n                  <button\r\n                    onClick={(e) => { e.stopPropagation(); onLeave(); }}\r\n                    className=\"px-6 py-2 bg-red-600/20 border border-red-500/50 hover:bg-red-600 hover:text-white text-red-400 rounded-full font-bold text-sm flex items-center gap-2 transition-all\"\r\n                  >\r\n                      <X size={16} /> Leave Seat\r\n                  </button>\r\n              )}\r\n              <p className=\"text-white/30 text-xs mt-4\">Tap anywhere to close</p>\r\n          </div>\r\n      )}\r\n      \r\n      {/* Broadcaster Controls Overlay (for disabling guest media) */}\r\n        {isHost && !isLocal && !isBroadcaster && showLocalControls && (\r\n          <div className=\"absolute inset-0 bg-black/80 z-30 flex flex-col items-center justify-center gap-6 animate-fadeIn\">\r\n              <h3 className=\"text-white font-bold text-lg\">Control Guest Media</h3>\r\n              <div className=\"flex items-center gap-4\">\r\n                  <button onClick={handleDisableVideo} className=\"p-4 rounded-full bg-red-600 hover:bg-red-700 text-white transition-transform hover:scale-110\">\r\n                      <CameraOff size={28} />\r\n                  </button>\r\n                  <button onClick={handleDisableAudio} className=\"p-4 rounded-full bg-red-600 hover:bg-red-700 text-white transition-transform hover:scale-110\">\r\n                      <MicOff size={28} />\r\n                  </button>\r\n                  <button onClick={handleDisableBoth} className=\"p-4 rounded-full bg-red-700 hover:bg-red-800 text-white transition-transform hover:scale-110\">\r\n                      <CameraOff size={20} />\r\n                      <MicOff size={20} />\r\n                  </button>\r\n              </div>\r\n              <div className=\"flex gap-4 text-sm text-white/80\">\r\n                  <span>Disable Video</span>\r\n                  <span>Disable Audio</span>\r\n                  <span>Disable Both</span>\r\n              </div>\r\n              <p className=\"text-white/30 text-xs mt-4\">Tap anywhere to close</p>\r\n          </div>\r\n      )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\church\\DailyChurchNotification.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\church\\DailyPassage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":25,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'insertError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":49,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":53},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":92,"column":13,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2767,2781],"text":"\n            &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2767,2781],"text":"\n            &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2767,2781],"text":"\n            &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2767,2781],"text":"\n            &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":92,"column":35,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2802,2814],"text":"&quot;\n          "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2802,2814],"text":"&ldquo;\n          "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2802,2814],"text":"&#34;\n          "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2802,2814],"text":"&rdquo;\n          "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport React, { useEffect, useState } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport { BookOpen, Loader2, Calendar } from 'lucide-react';\n\ninterface Passage {\n  reference: string;\n  text: string;\n  date: string;\n}\n\nexport default function DailyPassage() {\n  const [passage, setPassage] = useState<Passage | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    fetchDailyPassage();\n  }, []);\n\n  const fetchDailyPassage = async () => {\n    try {\n      const today = new Date().toISOString().split('T')[0];\n      \n      // 1. Check DB cache\n      const { data, error } = await supabase\n        .from('church_passages')\n        .select('*')\n        .eq('date', today)\n        .maybeSingle();\n\n      if (data) {\n        setPassage(data);\n        setLoading(false);\n        return;\n      }\n\n      // 2. Fetch from API if not in DB\n      const res = await fetch('https://bible-api.com/?random=verse');\n      const json = await res.json();\n      \n      const newPassage = {\n        date: today,\n        reference: json.reference,\n        text: json.text,\n      };\n\n      // 3. Cache in DB\n      // We use upsert to handle race conditions (if multiple users hit it at once)\n      const { data: insertedData, error: insertError } = await supabase\n        .from('church_passages')\n        .upsert(newPassage, { onConflict: 'date' })\n        .select()\n        .single();\n\n      if (insertedData) {\n        setPassage(insertedData);\n      } else {\n        // If upsert failed (e.g. race condition), just show the API data\n        setPassage(newPassage);\n      }\n      \n    } catch (err) {\n      console.error('Error fetching passage:', err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center p-8 bg-white/5 rounded-2xl border border-white/10\">\n        <Loader2 className=\"animate-spin text-purple-400\" />\n      </div>\n    );\n  }\n\n  if (!passage) return null;\n\n  return (\n    <div className=\"bg-gradient-to-br from-indigo-900/50 to-purple-900/50 p-6 rounded-2xl border border-indigo-500/30 shadow-lg relative overflow-hidden group\">\n       <div className=\"absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\n          <BookOpen size={100} />\n       </div>\n       \n       <div className=\"relative z-10 text-center\">\n          <div className=\"inline-flex items-center gap-2 px-3 py-1 bg-white/10 rounded-full text-xs font-medium text-indigo-200 mb-4 border border-white/10\">\n            <Calendar size={12} />\n            <span>Daily Word ‚Ä¢ {new Date().toLocaleDateString()}</span>\n          </div>\n          \n          <blockquote className=\"text-xl md:text-2xl font-serif text-white italic leading-relaxed mb-4\">\n            \"{passage.text.trim()}\"\n          </blockquote>\n          \n          <cite className=\"block text-indigo-300 font-bold tracking-wide uppercase text-sm not-italic\">\n            ‚Äî {passage.reference}\n          </cite>\n       </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\church\\PrayerFeed.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchPrayers' and 'subscribeToPrayers'. Either include them or remove the dependency array.","line":40,"column":6,"nodeType":"ArrayExpression","endLine":40,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [fetchPrayers, profile.id, subscribeToPrayers]","fix":{"range":[1143,1156],"text":"[fetchPrayers, profile.id, subscribeToPrayers]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":152,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":152,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":184,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport React, { useEffect, useState } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport { useAuthStore } from '@/lib/store';\nimport { Heart, Trash2, Send, MessageCircle, AlertTriangle, Loader2, Gavel } from 'lucide-react';\nimport { toast } from 'sonner';\n\ninterface Prayer {\n  id: string;\n  user_id: string;\n  content: string;\n  created_at: string;\n  likes_count: number;\n  user_profiles: {\n    username: string;\n    avatar_url: string;\n    role: string;\n    is_pastor: boolean;\n  };\n  has_liked?: boolean;\n}\n\nexport default function PrayerFeed({ isOpen }: { isOpen: boolean }) {\n  const { profile } = useAuthStore();\n  const [prayers, setPrayers] = useState<Prayer[]>([]);\n  const [newPrayer, setNewPrayer] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [sending, setSending] = useState(false);\n\n  // Check if user is pastor or admin\n  const isPastorOrAdmin = profile?.is_pastor || profile?.role === 'admin' || (profile as any)?.is_admin;\n\n  useEffect(() => {\n    fetchPrayers();\n    subscribeToPrayers();\n\n    return () => {\n      supabase.channel('church_prayers_channel').unsubscribe();\n    };\n  }, [profile?.id]);\n\n  const fetchPrayers = async () => {\n    try {\n      const { data, error } = await supabase\n        .from('church_prayers')\n        .select(`\n          *,\n          user_profiles:user_id (username, avatar_url, role, is_pastor)\n        `)\n        .order('created_at', { ascending: false })\n        .limit(50);\n\n      if (error) throw error;\n\n      // Check likes for current user\n      let prayersWithLikes = data || [];\n      if (profile) {\n        const { data: likes } = await supabase\n          .from('church_prayer_likes')\n          .select('prayer_id')\n          .eq('user_id', profile.id);\n        \n        const likedIds = new Set(likes?.map(l => l.prayer_id));\n        prayersWithLikes = prayersWithLikes.map(p => ({\n          ...p,\n          has_liked: likedIds.has(p.id)\n        }));\n      }\n\n      setPrayers(prayersWithLikes);\n    } catch (err) {\n      console.error('Error fetching prayers:', err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const subscribeToPrayers = () => {\n    supabase\n      .channel('church_prayers_channel')\n      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'church_prayers' }, (payload) => {\n        // Fetch full prayer to get user profile\n        fetchNewPrayer(payload.new.id);\n      })\n      .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'church_prayers' }, (payload) => {\n        setPrayers(prev => prev.filter(p => p.id !== payload.old.id));\n      })\n      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'church_prayers' }, (payload) => {\n         setPrayers(prev => prev.map(p => p.id === payload.new.id ? { ...p, likes_count: payload.new.likes_count } : p));\n      })\n      .subscribe();\n  };\n\n  const fetchNewPrayer = async (id: string) => {\n    const { data } = await supabase\n      .from('church_prayers')\n      .select(`\n        *,\n        user_profiles:user_id (username, avatar_url, role, is_pastor)\n      `)\n      .eq('id', id)\n      .single();\n    \n    if (data) {\n      setPrayers(prev => [data, ...prev]);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newPrayer.trim() || !isOpen) return;\n    \n    setSending(true);\n    try {\n      const { error } = await supabase\n        .from('church_prayers')\n        .insert({\n          user_id: profile?.id,\n          content: newPrayer.trim()\n        });\n\n      if (error) throw error;\n      \n      setNewPrayer('');\n      toast.success('Prayer posted successfully');\n      \n      // Award badge logic could go here or be a trigger\n      checkChurchBadge();\n      \n    } catch (err) {\n      toast.error('Failed to post prayer');\n      console.error(err);\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const checkChurchBadge = async () => {\n    if (!profile) return;\n    // Simple check: Insert badge if not exists\n    await supabase.from('user_badges').insert({\n        user_id: profile.id,\n        badge_id: (await supabase.from('badge_catalog').select('id').eq('slug', 'church_attendee').single()).data?.id\n    }).maybeSingle(); // Ignore if duplicate\n  };\n\n  const handleDelete = async (id: string) => {\n    if (!confirm('Are you sure you want to delete this prayer?')) return;\n    try {\n      await supabase.from('church_prayers').delete().eq('id', id);\n      toast.success('Prayer deleted');\n    } catch (err) {\n      toast.error('Failed to delete');\n    }\n  };\n\n  const handleKick = async (userId: string, username: string) => {\n    // This is a placeholder for the kick functionality.\n    // In a real implementation, you might want to call a backend API or open a modal.\n    toast.info(`Kicking ${username}... (Feature coming soon)`);\n  };\n\n  const handleLike = async (prayer: Prayer) => {\n     if (!profile) return;\n     \n     // Optimistic update\n     setPrayers(prev => prev.map(p => {\n        if (p.id === prayer.id) {\n           return {\n              ...p,\n              likes_count: p.has_liked ? p.likes_count - 1 : p.likes_count + 1,\n              has_liked: !p.has_liked\n           };\n        }\n        return p;\n     }));\n\n     try {\n       if (prayer.has_liked) {\n          await supabase.from('church_prayer_likes').delete().eq('prayer_id', prayer.id).eq('user_id', profile.id);\n       } else {\n          await supabase.from('church_prayer_likes').insert({ prayer_id: prayer.id, user_id: profile.id });\n       }\n     } catch (err) {\n       // Revert on error (fetching again is easiest)\n       fetchPrayers();\n     }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n       {/* Input Section */}\n       <div className=\"bg-zinc-900/50 p-4 rounded-xl border border-zinc-800\">\n          <h3 className=\"text-lg font-bold text-white mb-2 flex items-center gap-2\">\n             <MessageCircle size={20} className=\"text-purple-400\" />\n             Share Your Prayer\n          </h3>\n          \n          {isOpen ? (\n            <form onSubmit={handleSubmit} className=\"space-y-3\">\n               <textarea\n                 value={newPrayer}\n                 onChange={e => setNewPrayer(e.target.value)}\n                 placeholder=\"Write your prayer or reflection here...\"\n                 className=\"w-full bg-black/40 border border-zinc-700 rounded-lg p-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 min-h-[100px]\"\n                 maxLength={500}\n               />\n               <div className=\"flex justify-between items-center\">\n                  <span className=\"text-xs text-gray-500\">{newPrayer.length}/500</span>\n                  <button\n                    type=\"submit\"\n                    disabled={sending || !newPrayer.trim()}\n                    className=\"px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg font-medium flex items-center gap-2 transition-all\"\n                  >\n                    {sending ? <Loader2 className=\"animate-spin\" size={16} /> : <Send size={16} />}\n                    Post Prayer\n                  </button>\n               </div>\n            </form>\n          ) : (\n            <div className=\"flex items-center gap-3 p-3 bg-red-900/20 border border-red-500/20 rounded-lg text-red-200\">\n               <AlertTriangle size={20} />\n               <p className=\"text-sm\">Prayers can only be posted during church hours (1 PM - 3 PM).</p>\n            </div>\n          )}\n       </div>\n\n       {/* Feed */}\n       <div className=\"space-y-4\">\n          {prayers.map(prayer => (\n             <div key={prayer.id} className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800 hover:border-zinc-700 transition-colors\">\n                <div className=\"flex justify-between items-start mb-3\">\n                   <div className=\"flex items-center gap-3\">\n                      <img \n                        src={prayer.user_profiles?.avatar_url || `https://ui-avatars.com/api/?name=${prayer.user_profiles?.username || 'User'}`} \n                        alt={prayer.user_profiles?.username}\n                        className=\"w-10 h-10 rounded-full border border-zinc-700\"\n                      />\n                      <div>\n                         <div className=\"flex items-center gap-2\">\n                            <span className=\"font-bold text-white\">{prayer.user_profiles?.username}</span>\n                            {prayer.user_profiles?.is_pastor && (\n                               <span className=\"px-1.5 py-0.5 bg-purple-500/20 text-purple-300 border border-purple-500/30 text-[10px] font-bold rounded uppercase\">\n                                  Pastor\n                               </span>\n                            )}\n                         </div>\n                         <span className=\"text-xs text-gray-500\">{new Date(prayer.created_at).toLocaleString()}</span>\n                      </div>\n                   </div>\n                   \n                   {(isPastorOrAdmin || prayer.user_id === profile?.id) && (\n                      <div className=\"flex gap-1\">\n                        {isPastorOrAdmin && prayer.user_id !== profile?.id && (\n                          <button \n                            onClick={() => handleKick(prayer.user_id, prayer.user_profiles?.username)}\n                            className=\"p-1.5 text-gray-500 hover:text-red-400 hover:bg-red-900/20 rounded transition-colors\"\n                            title=\"Kick from Church & Summon to Court\"\n                          >\n                             <Gavel size={16} />\n                          </button>\n                        )}\n                        <button \n                          onClick={() => handleDelete(prayer.id)}\n                          className=\"p-1.5 text-gray-500 hover:text-red-400 hover:bg-red-900/20 rounded transition-colors\"\n                        >\n                           <Trash2 size={16} />\n                        </button>\n                      </div>\n                   )}\n                </div>\n                \n                <p className=\"text-gray-200 text-sm leading-relaxed mb-4 whitespace-pre-wrap\">\n                   {prayer.content}\n                </p>\n                \n                <div className=\"flex items-center gap-4 pt-3 border-t border-zinc-800\">\n                   <button \n                     onClick={() => handleLike(prayer)}\n                     className={`flex items-center gap-1.5 text-sm transition-colors ${prayer.has_liked ? 'text-pink-500' : 'text-gray-500 hover:text-pink-400'}`}\n                   >\n                      <Heart size={16} className={prayer.has_liked ? 'fill-current' : ''} />\n                      <span>{prayer.likes_count}</span>\n                   </button>\n                   \n                   {/* Reply button only for pastors? The prompt says \"Only pastor(s) can reply\" */}\n                   {isPastorOrAdmin && (\n                      <button className=\"flex items-center gap-1.5 text-sm text-gray-500 hover:text-white\">\n                         <MessageCircle size={16} />\n                         <span>Reply</span>\n                      </button>\n                   )}\n                </div>\n             </div>\n          ))}\n          \n          {prayers.length === 0 && !loading && (\n             <div className=\"text-center py-12 text-gray-500\">\n                <p>No prayers yet. Be the first to share.</p>\n             </div>\n          )}\n       </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\examples\\LiveKitErrorDemo.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":75,"column":55,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2712,2752],"text":"How to Fix the &quot;no room provided\" Error:"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2712,2752],"text":"How to Fix the &ldquo;no room provided\" Error:"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2712,2752],"text":"How to Fix the &#34;no room provided\" Error:"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2712,2752],"text":"How to Fix the &rdquo;no room provided\" Error:"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":75,"column":72,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2712,2752],"text":"How to Fix the \"no room provided&quot; Error:"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2712,2752],"text":"How to Fix the \"no room provided&ldquo; Error:"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2712,2752],"text":"How to Fix the \"no room provided&#34; Error:"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2712,2752],"text":"How to Fix the \"no room provided&rdquo; Error:"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { useLiveKit } from '../../hooks/useLiveKit'\r\nimport { useSafeLiveKit, useLiveKitAvailable } from '../../hooks/useSafeLiveKit'\r\nimport { LiveKitGuard } from '../LiveKitGuard'\r\n\r\n/**\r\n * Demo component showing the difference between unsafe and safe LiveKit usage\r\n */\r\n\r\nexport function UnsafeLiveKitExample() {\r\n  // This will throw an error if LiveKit context is not available\r\n  const liveKit = useLiveKit()\r\n  \r\n  return (\r\n    <div className=\"p-4 bg-red-100 border border-red-300 rounded\">\r\n      <h3 className=\"font-bold text-red-800\">Unsafe Example</h3>\r\n      <p className=\"text-red-600\">This component uses useLiveKit() directly and will crash if context is missing.</p>\r\n      <p>Connected: {liveKit.isConnected ? 'Yes' : 'No'}</p>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport function SafeLiveKitExample() {\r\n  // This safely checks for LiveKit availability\r\n  const liveKit = useSafeLiveKit()\r\n  const isAvailable = useLiveKitAvailable()\r\n  \r\n  if (!isAvailable) {\r\n    return (\r\n      <div className=\"p-4 bg-yellow-100 border border-yellow-300 rounded\">\r\n        <h3 className=\"font-bold text-yellow-800\">Safe Example</h3>\r\n        <p className=\"text-yellow-600\">LiveKit context is not available yet. Please wait...</p>\r\n      </div>\r\n    )\r\n  }\r\n  \r\n  return (\r\n    <div className=\"p-4 bg-green-100 border border-green-300 rounded\">\r\n      <h3 className=\"font-bold text-green-800\">Safe Example</h3>\r\n      <p className=\"text-green-600\">This component gracefully handles missing LiveKit context.</p>\r\n      <p>Connected: {liveKit.isConnected ? 'Yes' : 'No'}</p>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport function GuardedLiveKitExample() {\r\n  return (\r\n    <LiveKitGuard fallback={\r\n      <div className=\"p-4 bg-blue-100 border border-blue-300 rounded\">\r\n        <h3 className=\"font-bold text-blue-800\">Guarded Example</h3>\r\n        <p className=\"text-blue-600\">Loading LiveKit context...</p>\r\n      </div>\r\n    }>\r\n      <div className=\"p-4 bg-purple-100 border border-purple-300 rounded\">\r\n        <h3 className=\"font-bold text-purple-800\">Guarded Example</h3>\r\n        <p className=\"text-purple-600\">This component is only rendered when LiveKit is available.</p>\r\n        <p>Using LiveKitGuard component for protection.</p>\r\n      </div>\r\n    </LiveKitGuard>\r\n  )\r\n}\r\n\r\nexport function LiveKitErrorDemo() {\r\n  return (\r\n    <div className=\"space-y-4 p-4\">\r\n      <h2 className=\"text-2xl font-bold\">LiveKit Error Handling Demo</h2>\r\n      \r\n      <div className=\"space-y-4\">\r\n        <UnsafeLiveKitExample />\r\n        <SafeLiveKitExample />\r\n        <GuardedLiveKitExample />\r\n      </div>\r\n      \r\n      <div className=\"mt-8 p-4 bg-gray-100 rounded\">\r\n        <h3 className=\"font-bold mb-2\">How to Fix the \"no room provided\" Error:</h3>\r\n        <ol className=\"list-decimal list-inside space-y-1\">\r\n          <li>Use <code>useSafeLiveKit()</code> instead of <code>useLiveKit()</code> for conditional logic</li>\r\n          <li>Wrap components with <code>LiveKitGuard</code> for automatic protection</li>\r\n          <li>Use <code>useLiveKitAvailable()</code> to check context before usage</li>\r\n          <li>Provide fallback UI when LiveKit is not available</li>\r\n        </ol>\r\n      </div>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\game\\GameNavigation.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\layout\\AppLayout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isStaff' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":31,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react'\r\nimport BottomNavigation from '../BottomNavigation'\r\nimport Sidebar from '../Sidebar'\r\nimport Header from '../Header'\r\nimport { useLocation } from 'react-router-dom'\r\nimport PWAInstallPrompt from '../PWAInstallPrompt'\r\nimport UserCompliancePrompt from '../UserCompliancePrompt'\r\nimport PurchaseRequiredModal from '../PurchaseRequiredModal'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { UserRole } from '../../lib/supabase'\r\nimport ChatBubble from '../ChatBubble'\r\n\r\ninterface AppLayoutProps {\r\n  children: React.ReactNode\r\n  showSidebar?: boolean\r\n  showHeader?: boolean\r\n  showBottomNav?: boolean\r\n}\r\n\r\nexport default function AppLayout({ \r\n  children, \r\n  showSidebar = true, \r\n  showHeader = true, \r\n  showBottomNav = true \r\n}: AppLayoutProps) {\r\n  const location = useLocation();\r\n  const profile = useAuthStore((s) => s.profile)\r\n  const showLegacySidebar = useAuthStore((s) => s.showLegacySidebar)\r\n  const isAuthPage = location.pathname.startsWith('/auth');\r\n  const isLivePage = location.pathname.startsWith('/live/') || location.pathname.startsWith('/broadcast/');\r\n  const isStaff = Boolean(\r\n    profile &&\r\n      (\r\n        profile.role === UserRole.ADMIN ||\r\n        profile.role === UserRole.TROLL_OFFICER ||\r\n        profile.role === UserRole.LEAD_TROLL_OFFICER ||\r\n        profile.role === UserRole.HR_ADMIN ||\r\n        profile.is_admin ||\r\n        profile.is_troll_officer ||\r\n        profile.is_lead_officer\r\n      )\r\n  )\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n  }, []);\r\n\r\n  const effectiveShowSidebar = showSidebar && showLegacySidebar && !isAuthPage && !isLivePage;\r\n  const effectiveShowHeader = showHeader && !isAuthPage && !isLivePage;\r\n  const effectiveShowBottomNav = showBottomNav && !isAuthPage;\r\n  const mainPaddingClass = effectiveShowBottomNav ? 'app-content app-content--with-nav' : 'app-content app-content--no-nav';\r\n\r\n  return (\r\n    <div className=\"app-viewport w-screen overflow-hidden text-white flex relative\">\r\n      <PurchaseRequiredModal />\r\n      <PWAInstallPrompt />\r\n      {/* Desktop Sidebar - Hidden on Mobile */}\r\n      {effectiveShowSidebar && (\r\n        <div className=\"hidden md:block w-64 h-full shrink-0 border-r border-white/5 bg-[#0A0814] z-20\">\r\n          <Sidebar />\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex-1 flex flex-col h-full min-w-0 relative\">\r\n        {/* Header - Sticky or Fixed */}\r\n        {effectiveShowHeader && (\r\n          <div className=\"shrink-0 z-20\">\r\n            <Header />\r\n          </div>\r\n        )}\r\n\r\n        {/* User Compliance Prompt */}\r\n        {!isAuthPage && <UserCompliancePrompt />}\r\n\r\n        {/* Main Content Area */}\r\n        <main className={`flex-1 w-full h-full relative overflow-x-hidden scrollbar-thin scrollbar-thumb-purple-900/50 scrollbar-track-transparent ${mainPaddingClass}`}>\r\n          {children}\r\n        </main>\r\n\r\n        {/* Mobile Bottom Navigation - Fixed at bottom */}\r\n        {effectiveShowBottomNav && (\r\n          <div className=\"md:hidden shrink-0 z-30\">\r\n            <BottomNavigation />\r\n          </div>\r\n        )}\r\n\r\n        {/* Global Chat Bubble */}\r\n        <ChatBubble />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\levels\\LevelBadge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\levels\\LevelUpModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\levels\\ProfileLevelWidget.jsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getMainLevelMeta' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":26,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"getMainLevelMeta"},"fix":{"range":[250,304],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/levels/ProfileLevelWidget.jsx\r\nimport React, { useEffect, useRef, useState } from \"react\";\r\nimport { useUserLevels } from \"@/hooks/useUserLevels\";\r\nimport LevelBadge from \"./LevelBadge\";\r\nimport LevelUpModal from \"./LevelUpModal\";\r\nimport { getMainLevelMeta } from \"@/lib/levelsConfig\";\r\n\r\nexport default function ProfileLevelWidget() {\r\n  const { levels, loading } = useUserLevels();\r\n  const prevBuyerLevel = useRef(null);\r\n  const prevStreamLevel = useRef(null);\r\n  const prevMainLevel = useRef(null);\r\n  const [showBuyerModal, setShowBuyerModal] = useState(false);\r\n  const [showStreamModal, setShowStreamModal] = useState(false);\r\n  const [showMainModal, setShowMainModal] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!levels) return;\r\n\r\n    if (\r\n      prevBuyerLevel.current !== null &&\r\n      levels.buyer_level > prevBuyerLevel.current\r\n    ) {\r\n      setShowBuyerModal(true);\r\n    }\r\n    if (\r\n      prevStreamLevel.current !== null &&\r\n      levels.stream_level > prevStreamLevel.current\r\n    ) {\r\n      setShowStreamModal(true);\r\n    }\r\n    // Main level check (levels.level or levels.current_level)\r\n    const currentMain = levels.level || levels.current_level || 1;\r\n    if (\r\n      prevMainLevel.current !== null &&\r\n      currentMain > prevMainLevel.current\r\n    ) {\r\n      setShowMainModal(true);\r\n    }\r\n\r\n    prevBuyerLevel.current = levels.buyer_level;\r\n    prevStreamLevel.current = levels.stream_level;\r\n    prevMainLevel.current = currentMain;\r\n  }, [levels]);\r\n\r\n  if (loading) return null;\r\n  if (!levels) return null;\r\n\r\n  const mainLevel = levels.level || levels.current_level || 1;\r\n\r\n  return (\r\n    <div className=\"bg-gray-900 border border-gray-800 rounded-xl p-4 space-y-3\">\r\n      <div className=\"text-sm text-gray-400 mb-1\">Troll City Levels</div>\r\n\r\n      <div className=\"flex items-center justify-between gap-2\">\r\n        <span className=\"text-xs text-gray-400\">Troll Level</span>\r\n        <LevelBadge type=\"main\" level={mainLevel} />\r\n      </div>\r\n\r\n      <div className=\"flex items-center justify-between gap-2\">\r\n        <span className=\"text-xs text-gray-400\">Supporter Level</span>\r\n        <LevelBadge type=\"buyer\" level={levels.buyer_level} />\r\n      </div>\r\n\r\n      <div className=\"flex items-center justify-between gap-2\">\r\n        <span className=\"text-xs text-gray-400\">Broadcast Level</span>\r\n        <LevelBadge type=\"stream\" level={levels.stream_level} />\r\n      </div>\r\n\r\n      {showMainModal && (\r\n        <LevelUpModal\r\n          type=\"main\"\r\n          oldLevel={prevMainLevel.current}\r\n          newLevel={mainLevel}\r\n          onClose={() => setShowMainModal(false)}\r\n        />\r\n      )}\r\n      {showBuyerModal && (\r\n        <LevelUpModal\r\n          type=\"buyer\"\r\n          oldLevel={prevBuyerLevel.current}\r\n          newLevel={levels.buyer_level}\r\n          onClose={() => setShowBuyerModal(false)}\r\n        />\r\n      )}\r\n      {showStreamModal && (\r\n        <LevelUpModal\r\n          type=\"stream\"\r\n          oldLevel={prevStreamLevel.current}\r\n          newLevel={levels.stream_level}\r\n          onClose={() => setShowStreamModal(false)}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\levels\\StreamLevelOverlay.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\mai\\MAIAuthorityPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\officer\\IPBanModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":193,"column":85,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[6722,6830],"text":"\r\n                IP addresses are only visible to admins. You can still ban this user&apos;s IP.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[6722,6830],"text":"\r\n                IP addresses are only visible to admins. You can still ban this user&lsquo;s IP.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[6722,6830],"text":"\r\n                IP addresses are only visible to admins. You can still ban this user&#39;s IP.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[6722,6830],"text":"\r\n                IP addresses are only visible to admins. You can still ban this user&rsquo;s IP.\r\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { X, AlertTriangle } from 'lucide-react'\r\n\r\ninterface IPBanModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  onSuccess: () => void\r\n  targetUserId?: string\r\n  targetUsername?: string\r\n  targetIP?: string\r\n}\r\n\r\nconst BAN_REASONS = [\r\n  { value: 'nudity', label: 'Nudity / Sexual Content' },\r\n  { value: 'fraud', label: 'Fraud / Scamming' },\r\n  { value: 'death_threats', label: 'Death Threats' },\r\n  { value: 'abuse', label: 'Abuse / Harassment' },\r\n  { value: 'other', label: 'Other Violation' },\r\n] as const\r\n\r\nexport default function IPBanModal({ \r\n  isOpen, \r\n  onClose, \r\n  onSuccess,\r\n  targetUserId,\r\n  targetUsername,\r\n  targetIP \r\n}: IPBanModalProps) {\r\n  const { user, profile } = useAuthStore()\r\n  const [ipAddress, setIPAddress] = useState(targetIP || '')\r\n  const [internalTargetIP, setInternalTargetIP] = useState(targetIP || '')\r\n  const [banReason, setBanReason] = useState<string>('abuse')\r\n  const [banDetails, setBanDetails] = useState('')\r\n  const [banDuration, setBanDuration] = useState<'permanent' | 'temporary'>('permanent')\r\n  const [temporaryDays, setTemporaryDays] = useState(7)\r\n  const [banning, setBanning] = useState(false)\r\n\r\n  const handleBan = async () => {\r\n    if (!user || !profile) {\r\n      toast.error('You must be logged in')\r\n      return\r\n    }\r\n\r\n    // Officers can ban IPs but can't see them - only admins can see IP addresses\r\n    if (!profile.is_admin && !profile.is_troll_officer) {\r\n      toast.error('Only troll officers and admins can ban IP addresses')\r\n      return\r\n    }\r\n\r\n    // For officers, use internalTargetIP if available, otherwise require admin to enter IP\r\n    let ipToBan = ''\r\n    \r\n    if (!profile.is_admin) {\r\n      // Officers can't see IPs, but can ban using internalTargetIP if provided\r\n      if (internalTargetIP) {\r\n        ipToBan = internalTargetIP\r\n      } else {\r\n        toast.error('IP address is required. Only admins can view and enter IP addresses.')\r\n        return\r\n      }\r\n    } else {\r\n      // Admins must enter IP address\r\n      if (!ipAddress.trim()) {\r\n        toast.error('Please enter an IP address')\r\n        return\r\n      }\r\n\r\n      // Validate IP address format (only for admins)\r\n      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/\r\n      if (!ipRegex.test(ipAddress.trim())) {\r\n        toast.error('Invalid IP address format')\r\n        return\r\n      }\r\n      \r\n      ipToBan = ipAddress.trim()\r\n    }\r\n\r\n    if (!banReason) {\r\n      toast.error('Please select a ban reason')\r\n      return\r\n    }\r\n\r\n    // No confirmation - proceed directly\r\n\r\n    setBanning(true)\r\n    try {\r\n      // Calculate banned_until date\r\n      let bannedUntil: string | null = null\r\n      if (banDuration === 'temporary') {\r\n        const untilDate = new Date()\r\n        untilDate.setDate(untilDate.getDate() + temporaryDays)\r\n        bannedUntil = untilDate.toISOString()\r\n      }\r\n\r\n      const { data, error } = await supabase.rpc('ban_ip_address', {\r\n        p_ip_address: ipToBan,\r\n        p_ban_reason: banReason,\r\n        p_officer_id: user.id,\r\n        p_ban_details: banDetails.trim() || null,\r\n        p_banned_until: bannedUntil\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        const displayIP = profile.is_admin ? ipToBan : '***.***.***.***'\r\n        toast.success(`IP address ${displayIP} banned successfully${data.affected_users ? ` (${data.affected_users} users affected)` : ''}`)\r\n        onSuccess()\r\n        onClose()\r\n        // Reset form\r\n        setIPAddress('')\r\n        setBanReason('abuse')\r\n        setBanDetails('')\r\n        setBanDuration('permanent')\r\n        setTemporaryDays(7)\r\n      } else {\r\n        toast.error(data?.error || 'Failed to ban IP address')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error banning IP:', error)\r\n      toast.error(error?.message || 'Failed to ban IP address')\r\n    } finally {\r\n      setBanning(false)\r\n    }\r\n  }\r\n\r\n  // Fetch user's IP if targetUserId is provided (only for admins to see, but officers can still ban)\r\n  useEffect(() => {\r\n    if (targetUserId && !targetIP && isOpen) {\r\n      supabase\r\n        .from('user_profiles')\r\n        .select('last_known_ip')\r\n        .eq('id', targetUserId)\r\n        .single()\r\n        .then(({ data }) => {\r\n          if (data?.last_known_ip) {\r\n            // Only set IPAddress for admins to see\r\n            if (profile?.is_admin) {\r\n              setIPAddress(data.last_known_ip)\r\n            }\r\n            // Always set internalTargetIP for banning (officers can use it but won't see it)\r\n            setInternalTargetIP(data.last_known_ip)\r\n          }\r\n        })\r\n    }\r\n  }, [targetUserId, targetIP, isOpen, profile?.is_admin])\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/80 backdrop-blur-lg flex items-center justify-center p-6 z-50\">\r\n      <div className=\"bg-[#08010A] p-6 rounded-xl border border-purple-600 w-full max-w-md shadow-[0_0_40px_rgba(130,0,200,0.6)]\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <AlertTriangle className=\"text-red-400\" size={24} />\r\n            <h2 className=\"text-xl font-bold text-purple-400\">Ban IP Address</h2>\r\n          </div>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-gray-400 hover:text-white transition-colors\"\r\n          >\r\n            <X size={20} />\r\n          </button>\r\n        </div>\r\n\r\n        {targetUsername && (\r\n          <div className=\"mb-4 p-3 bg-yellow-900/20 border border-yellow-500 rounded-lg\">\r\n            <p className=\"text-sm text-yellow-400\">\r\n              Banning IP for user: <strong>{targetUsername}</strong>\r\n            </p>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"space-y-4\">\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              IP Address *\r\n            </label>\r\n            {profile?.is_admin ? (\r\n              <input\r\n                type=\"text\"\r\n                value={ipAddress}\r\n                onChange={(e) => setIPAddress(e.target.value)}\r\n                placeholder=\"192.168.1.1\"\r\n                className=\"w-full bg-black/50 border border-purple-600 p-3 rounded-lg text-sm text-white placeholder-gray-500\"\r\n                disabled={!!targetIP}\r\n              />\r\n            ) : (\r\n              <div className=\"w-full bg-black/50 border border-purple-600 p-3 rounded-lg text-sm text-gray-500\">\r\n                IP addresses are only visible to admins. You can still ban this user's IP.\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              Ban Reason *\r\n            </label>\r\n            <select\r\n              value={banReason}\r\n              onChange={(e) => setBanReason(e.target.value)}\r\n              className=\"w-full bg-black/50 border border-purple-600 p-3 rounded-lg text-sm text-white\"\r\n            >\r\n              {BAN_REASONS.map((reason) => (\r\n                <option key={reason.value} value={reason.value}>\r\n                  {reason.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              Additional Details\r\n            </label>\r\n            <textarea\r\n              value={banDetails}\r\n              onChange={(e) => setBanDetails(e.target.value)}\r\n              placeholder=\"Provide additional context about the violation...\"\r\n              rows={3}\r\n              className=\"w-full bg-black/50 border border-purple-600 p-3 rounded-lg text-sm text-white placeholder-gray-500\"\r\n            />\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              Ban Duration\r\n            </label>\r\n            <div className=\"space-y-2\">\r\n              <label className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"radio\"\r\n                  value=\"permanent\"\r\n                  checked={banDuration === 'permanent'}\r\n                  onChange={(e) => setBanDuration(e.target.value as 'permanent')}\r\n                  className=\"text-purple-600\"\r\n                />\r\n                <span className=\"text-sm text-gray-300\">Permanent Ban</span>\r\n              </label>\r\n              <label className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"radio\"\r\n                  value=\"temporary\"\r\n                  checked={banDuration === 'temporary'}\r\n                  onChange={(e) => setBanDuration(e.target.value as 'temporary')}\r\n                  className=\"text-purple-600\"\r\n                />\r\n                <span className=\"text-sm text-gray-300\">Temporary Ban</span>\r\n                {banDuration === 'temporary' && (\r\n                  <input\r\n                    type=\"number\"\r\n                    min=\"1\"\r\n                    max=\"365\"\r\n                    value={temporaryDays}\r\n                    onChange={(e) => setTemporaryDays(parseInt(e.target.value) || 7)}\r\n                    className=\"ml-2 w-20 bg-black/50 border border-purple-600 p-1 rounded text-sm text-white\"\r\n                  />\r\n                )}\r\n                {banDuration === 'temporary' && (\r\n                  <span className=\"text-xs text-gray-400\">days</span>\r\n                )}\r\n              </label>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex gap-3 pt-2\">\r\n            <button\r\n              onClick={onClose}\r\n              className=\"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              onClick={handleBan}\r\n              disabled={banning || (!profile?.is_admin && !targetIP) || (profile?.is_admin && !ipAddress.trim()) || !banReason}\r\n              className=\"flex-1 px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {banning ? 'Banning...' : 'Ban IP Address'}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\officer\\OfficerClock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\officer\\OfficerShiftCalendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\officer\\OfficerStreamGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\payments\\PaymentMethodManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\profile\\PostItem.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MoreHorizontal' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":60,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MoreHorizontal"},"fix":{"range":[198,214],"text":""},"desc":"Remove unused variable \"MoreHorizontal\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Reply' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":75,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Reply"},"fix":{"range":[222,229],"text":""},"desc":"Remove unused variable \"Reply\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadingComments' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":34,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'gifting' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\nimport { supabase } from '../../lib/supabase';\nimport { useAuthStore } from '../../lib/store';\nimport { Heart, MessageCircle, Gift, Share2, MoreHorizontal, Trash2, Reply, Smile } from 'lucide-react';\nimport { toast } from 'sonner';\nimport ClickableUsername from '../ClickableUsername';\nimport EmojiPicker, { EmojiClickData, Theme } from 'emoji-picker-react';\nimport GiftModal from '../trollWall/GiftModal';\n\ninterface Comment {\n  id: string;\n  post_id: string;\n  user_id: string;\n  parent_id: string | null;\n  content: string;\n  created_at: string;\n  user_profiles: {\n    username: string;\n    avatar_url: string | null;\n  };\n  replies?: Comment[];\n  likes_count?: number; // Future proofing\n}\n\ninterface PostItemProps {\n  post: any;\n  onDelete?: (id: string) => void;\n}\n\nexport default function PostItem({ post, onDelete }: PostItemProps) {\n  const { user } = useAuthStore();\n  const [comments, setComments] = useState<Comment[]>([]);\n  const [showComments, setShowComments] = useState(false);\n  const [loadingComments, setLoadingComments] = useState(false);\n  const [commentText, setCommentText] = useState('');\n  const [replyingTo, setReplyingTo] = useState<Comment | null>(null);\n  const [likesCount, setLikesCount] = useState(post.likes_count || 0);\n  const [liked, setLiked] = useState(false);\n  const [gifting, setGifting] = useState(false);\n  const [showGiftModal, setShowGiftModal] = useState(false);\n  const [showEmojiPicker, setShowEmojiPicker] = useState(false);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const emojiPickerRef = useRef<HTMLDivElement>(null);\n\n  // Close emoji picker when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (emojiPickerRef.current && !emojiPickerRef.current.contains(event.target as Node)) {\n        setShowEmojiPicker(false);\n      }\n    };\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const onEmojiClick = (emojiData: EmojiClickData) => {\n    setCommentText(prev => prev + emojiData.emoji);\n    setShowEmojiPicker(false);\n    inputRef.current?.focus();\n  };\n\n  // Check if user liked this post on mount\n  useEffect(() => {\n    if (user && post.id) {\n        supabase\n            .from('troll_post_reactions')\n            .select('id')\n            .eq('post_id', post.id)\n            .eq('user_id', user.id)\n            .eq('reaction_type', 'like')\n            .maybeSingle()\n            .then(({ data }) => {\n                if (data) setLiked(true);\n            });\n    }\n  }, [user, post.id]);\n\n  const toggleLike = async () => {\n    if (!user) {\n        toast.error('Login to like');\n        return;\n    }\n\n    // Optimistic update\n    const previousLiked = liked;\n    const previousCount = likesCount;\n    setLiked(!liked);\n    setLikesCount(prev => liked ? prev - 1 : prev + 1);\n\n    try {\n        const { data, error } = await supabase.rpc('toggle_post_like', {\n            p_post_id: post.id\n        });\n\n        if (error) throw error;\n        if (data && data.success) {\n            setLiked(data.liked);\n            setLikesCount(data.count);\n        } else {\n             // Revert\n             setLiked(previousLiked);\n             setLikesCount(previousCount);\n        }\n    } catch (err) {\n        console.error('Error toggling like:', err);\n        setLiked(previousLiked);\n        setLikesCount(previousCount);\n        toast.error('Failed to like post');\n    }\n  };\n\n  // Load comments\n  const loadComments = async () => {\n    if (showComments) {\n      setShowComments(false);\n      return;\n    }\n    \n    setLoadingComments(true);\n    try {\n      const { data, error } = await supabase\n        .from('troll_post_comments')\n        .select(`\n          *,\n          user_profiles (username, avatar_url)\n        `)\n        .eq('post_id', post.id)\n        .order('created_at', { ascending: true });\n\n      if (error) throw error;\n\n      // Organize into tree\n      const commentMap = new Map<string, Comment>();\n      const rootComments: Comment[] = [];\n\n      data?.forEach((c: any) => {\n        c.replies = [];\n        commentMap.set(c.id, c);\n      });\n\n      data?.forEach((c: any) => {\n        if (c.parent_id) {\n          const parent = commentMap.get(c.parent_id);\n          if (parent) {\n            parent.replies?.push(c);\n          } else {\n            rootComments.push(c); // Orphaned or parent not found, treat as root\n          }\n        } else {\n          rootComments.push(c);\n        }\n      });\n\n      setComments(rootComments);\n      setShowComments(true);\n    } catch (err) {\n      console.error('Error loading comments:', err);\n    } finally {\n      setLoadingComments(false);\n    }\n  };\n\n  const handlePostComment = async () => {\n    if (!commentText.trim()) return;\n    if (!user) {\n      toast.error('Login to comment');\n      return;\n    }\n\n    try {\n      const { data, error } = await supabase\n        .from('troll_post_comments')\n        .insert({\n          post_id: post.id,\n          user_id: user.id,\n          content: commentText.trim(),\n          parent_id: replyingTo?.id || null\n        })\n        .select(`\n          *,\n          user_profiles (username, avatar_url)\n        `)\n        .single();\n\n      if (error) throw error;\n\n      // Add to local state\n      const newComment = { ...data, replies: [] } as Comment;\n      \n      if (replyingTo) {\n        // Find parent and append (this is tricky with recursive state, simplified for now: reload or naive append)\n        // For deep nesting, it's easier to reload or flatten. \n        // Let's just reload for correctness or try to append if simple.\n         // A simple reload is safer for now to ensure tree structure\n         loadComments();\n         setShowComments(true); // Ensure open\n      } else {\n        setComments([...comments, newComment]);\n      }\n\n      setCommentText('');\n      setReplyingTo(null);\n      toast.success('Comment posted');\n    } catch (err) {\n      console.error('Error posting comment:', err);\n      toast.error('Failed to post comment');\n    }\n  };\n\n  const handleGift = async (amount: number) => {\n    if (!user) return toast.error('Login to gift');\n    setGifting(true);\n    try {\n      const { data, error } = await supabase.rpc('gift_post', {\n        p_post_id: post.id,\n        p_amount: amount,\n        p_message: 'Loved your post!'\n      });\n\n      if (error) throw error;\n      if (data && !data.success) throw new Error(data.error);\n\n      toast.success(`Gifted ${amount} coins!`);\n    } catch (err: any) {\n      toast.error(err.message || 'Failed to gift');\n    } finally {\n      setGifting(false);\n    }\n  };\n\n  const handleGiftSent = async (giftType: string, cost: number) => {\n    await handleGift(cost);\n    setShowGiftModal(false);\n  };\n\n  const CommentNode = ({ comment, depth = 0 }: { comment: Comment, depth?: number }) => (\n    <div className={`flex gap-3 mb-4 ${depth > 0 ? 'ml-8 relative' : ''}`}>\n      {depth > 0 && (\n         <div className=\"absolute -left-4 top-0 bottom-0 w-0.5 bg-white/10 rounded-full\" />\n      )}\n      <div className=\"flex-shrink-0\">\n         {comment.user_profiles?.avatar_url ? (\n            <img \n              src={comment.user_profiles.avatar_url} \n              alt={comment.user_profiles.username} \n              className=\"w-8 h-8 rounded-full object-cover border border-white/10\"\n            />\n         ) : (\n            <div className=\"w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-xs font-bold text-white\">\n                {comment.user_profiles?.username?.substring(0, 2).toUpperCase()}\n            </div>\n         )}\n      </div>\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"bg-white/5 rounded-2xl px-4 py-2 inline-block max-w-full\">\n            <ClickableUsername username={comment.user_profiles?.username} className=\"font-bold text-sm text-white hover:underline block\" />\n            <p className=\"text-sm text-gray-200 break-words\">{comment.content}</p>\n        </div>\n        <div className=\"flex items-center gap-4 mt-1 ml-2 text-xs text-gray-400 font-medium\">\n            <span>{new Date(comment.created_at).toLocaleDateString()}</span>\n            {/* <button className=\"hover:text-white\">Like</button> */}\n            <button \n                onClick={() => {\n                    setReplyingTo(comment);\n                    const input = document.getElementById(`comment-input-${post.id}`);\n                    if (input) input.focus();\n                }}\n                className=\"hover:text-white text-gray-400\"\n            >\n                Reply\n            </button>\n        </div>\n\n        {/* Nested Replies */}\n        {comment.replies && comment.replies.length > 0 && (\n            <div className=\"mt-3\">\n                {comment.replies.map(reply => (\n                    <CommentNode key={reply.id} comment={reply} depth={depth + 1} />\n                ))}\n            </div>\n        )}\n      </div>\n    </div>\n  );\n\n  return (\n    <div className=\"bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-4 mb-4 hover:border-purple-500/30 transition-all\">\n      {/* Header */}\n      <div className=\"flex items-start justify-between mb-3\">\n        <div className=\"flex items-center gap-3\">\n           <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 p-0.5\">\n              {post.user_profiles?.avatar_url ? (\n                <img \n                  src={post.user_profiles.avatar_url} \n                  className=\"w-full h-full rounded-full object-cover bg-black\" \n                  alt={post.user_profiles.username}\n                />\n              ) : (\n                <div className=\"w-full h-full rounded-full bg-black flex items-center justify-center text-white font-bold\">\n                    {post.user_profiles?.username?.substring(0, 2).toUpperCase()}\n                </div>\n              )}\n           </div>\n           <div>\n              <ClickableUsername username={post.user_profiles?.username} className=\"font-bold text-white hover:text-purple-400\" />\n              <div className=\"text-xs text-gray-400\">{new Date(post.created_at).toLocaleString()}</div>\n           </div>\n        </div>\n        \n        {user?.id === post.user_id && onDelete && (\n            <button onClick={() => onDelete(post.id)} className=\"text-gray-500 hover:text-red-500 p-1\">\n                <Trash2 className=\"w-4 h-4\" />\n            </button>\n        )}\n      </div>\n\n      {/* Content */}\n      <div className=\"mb-4 text-gray-100 whitespace-pre-wrap leading-relaxed\">\n        {post.content}\n      </div>\n      \n      {post.image_url && (\n        <div className=\"mb-4 rounded-lg overflow-hidden border border-white/10 bg-black/50\">\n            <img src={post.image_url} alt=\"Post content\" className=\"w-full max-h-[500px] object-contain\" />\n        </div>\n      )}\n\n      {post.video_url && (\n        <div className=\"mb-4 rounded-lg overflow-hidden border border-white/10 bg-black/50\">\n            <video src={post.video_url} controls className=\"w-full max-h-[400px] object-contain\" />\n        </div>\n      )}\n\n      {/* Actions */}\n      <div className=\"flex items-center gap-2 border-t border-white/5 pt-3 mb-2\">\n        <button \n            className={`flex-1 flex items-center justify-center gap-2 py-2 hover:bg-white/5 rounded-lg transition-colors ${liked ? 'text-pink-500' : 'text-gray-400 hover:text-pink-500'}`}\n            onClick={toggleLike}\n        >\n            <Heart className={`w-5 h-5 ${liked ? 'fill-pink-500' : ''}`} />\n            <span className=\"text-sm\">{likesCount} Likes</span>\n        </button>\n        \n        <button \n            className=\"flex-1 flex items-center justify-center gap-2 py-2 hover:bg-white/5 rounded-lg text-gray-400 hover:text-blue-400 transition-colors\"\n            onClick={loadComments}\n        >\n            <MessageCircle className=\"w-5 h-5\" />\n            <span className=\"text-sm\">Comment</span>\n        </button>\n\n        <button \n            className=\"flex-1 px-4 flex items-center justify-center gap-2 py-2 hover:bg-white/5 rounded-lg text-gray-400 hover:text-yellow-400 transition-colors\"\n            onClick={() => setShowGiftModal(true)}\n        >\n            <Gift className=\"w-5 h-5\" />\n            <span className=\"text-sm\">Gift</span>\n        </button>\n      </div>\n\n      {showGiftModal && (\n        <GiftModal \n            postId={post.id}\n            onClose={() => setShowGiftModal(false)}\n            onGiftSent={handleGiftSent}\n        />\n      )}\n\n      {/* Comments Section */}\n      {showComments && (\n        <div className=\"mt-4 pt-4 border-t border-white/5 animate-in fade-in slide-in-from-top-2\">\n            {/* Input */}\n            <div className=\"flex gap-3 mb-6\">\n                 <div className=\"w-8 h-8 rounded-full bg-gray-700 flex-shrink-0\" />\n                 <div className=\"flex-1\">\n                    {replyingTo && (\n                        <div className=\"flex items-center justify-between text-xs text-blue-400 mb-1 bg-blue-500/10 px-2 py-1 rounded\">\n                            <span>Replying to @{replyingTo.user_profiles?.username}</span>\n                            <button onClick={() => setReplyingTo(null)} className=\"hover:text-white\"><XIcon className=\"w-3 h-3\" /></button>\n                        </div>\n                    )}\n                    <div className=\"relative\">\n                        <input\n                            ref={inputRef}\n                            id={`comment-input-${post.id}`}\n                            type=\"text\"\n                            value={commentText}\n                            onChange={e => setCommentText(e.target.value)}\n                            onKeyDown={e => e.key === 'Enter' && handlePostComment()}\n                            placeholder={replyingTo ? \"Write a reply...\" : \"Write a comment...\"}\n                            className=\"w-full bg-white/5 border border-white/10 rounded-full pl-4 pr-20 py-2 text-sm text-white focus:outline-none focus:border-purple-500 transition-colors\"\n                        />\n                        <div className=\"absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1\">\n                            <div className=\"relative\" ref={emojiPickerRef}>\n                                <button \n                                    onClick={() => setShowEmojiPicker(!showEmojiPicker)}\n                                    className=\"p-1.5 text-gray-400 hover:text-yellow-400 transition-colors\"\n                                >\n                                    <Smile className=\"w-4 h-4\" />\n                                </button>\n                                {showEmojiPicker && (\n                                    <div className=\"absolute bottom-full right-0 mb-2 z-50\">\n                                        <EmojiPicker \n                                            onEmojiClick={onEmojiClick}\n                                            theme={Theme.DARK}\n                                            width={300}\n                                            height={400}\n                                        />\n                                    </div>\n                                )}\n                            </div>\n                            <button \n                                onClick={handlePostComment}\n                                className=\"p-1.5 text-purple-400 hover:text-purple-300 transition-colors\"\n                            >\n                                <Share2 className=\"w-4 h-4 rotate-90\" />\n                            </button>\n                        </div>\n                    </div>\n                 </div>\n            </div>\n\n            {/* List */}\n            <div className=\"space-y-4\">\n                {comments.map(comment => (\n                    <CommentNode key={comment.id} comment={comment} />\n                ))}\n            </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction XIcon({ className }: { className?: string }) {\n    return (\n        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className={className}>\n            <path d=\"M18 6 6 18\"/><path d=\"m6 6 18 18\"/>\n        </svg>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\profile\\ProfileFeed.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Video' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Video"},"fix":{"range":[217,224],"text":""},"desc":"Remove unused variable \"Video\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":184,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback, useRef } from 'react';\nimport { supabase } from '../../lib/supabase';\nimport { useAuthStore } from '../../lib/store';\nimport PostItem from './PostItem';\nimport { Image, Video, Send, Smile, X, Loader2 } from 'lucide-react';\nimport { toast } from 'sonner';\nimport EmojiPicker, { EmojiClickData, Theme } from 'emoji-picker-react';\n\ninterface ProfileFeedProps {\n  userId: string;\n}\n\nexport default function ProfileFeed({ userId }: ProfileFeedProps) {\n  const { user } = useAuthStore();\n  const [posts, setPosts] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [content, setContent] = useState('');\n  const [isPosting, setIsPosting] = useState(false);\n  const [showEmojiPicker, setShowEmojiPicker] = useState(false);\n  const [mediaFile, setMediaFile] = useState<File | null>(null);\n  const [mediaPreview, setMediaPreview] = useState<string | null>(null);\n  const [mediaType, setMediaType] = useState<'image' | 'video' | null>(null);\n  \n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const emojiPickerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (emojiPickerRef.current && !emojiPickerRef.current.contains(event.target as Node)) {\n        setShowEmojiPicker(false);\n      }\n    };\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (file.size > 50 * 1024 * 1024) { // 50MB limit\n        toast.error('File size must be less than 50MB');\n        return;\n    }\n\n    const type = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : null;\n    if (!type) {\n        toast.error('Invalid file type. Please upload an image or video.');\n        return;\n    }\n\n    setMediaFile(file);\n    setMediaType(type);\n    setMediaPreview(URL.createObjectURL(file));\n  };\n\n  const clearMedia = () => {\n    setMediaFile(null);\n    setMediaType(null);\n    if (mediaPreview) URL.revokeObjectURL(mediaPreview);\n    setMediaPreview(null);\n    if (fileInputRef.current) fileInputRef.current.value = '';\n  };\n\n  const onEmojiClick = (emojiData: EmojiClickData) => {\n    setContent(prev => prev + emojiData.emoji);\n    setShowEmojiPicker(false);\n  };\n\n\n  const fetchPosts = useCallback(async () => {\n    setLoading(true);\n    try {\n      const { data, error } = await supabase\n        .from('troll_posts')\n        .select(`\n            *,\n            user_profiles (username, avatar_url),\n            likes_count: troll_post_reactions(count),\n            comments_count: troll_post_comments(count)\n        `)\n        .eq('user_id', userId)\n        .order('created_at', { ascending: false })\n        .limit(20);\n\n      if (error) throw error;\n      \n      // Transform data if needed (e.g. likes_count is array of objects)\n      const formattedPosts = data?.map(post => ({\n         ...post,\n         likes_count: post.likes_count?.[0]?.count || 0,\n         comments_count: post.comments_count?.[0]?.count || 0\n      }));\n\n      setPosts(formattedPosts || []);\n    } catch (err) {\n      console.error('Error fetching posts:', err);\n    } finally {\n      setLoading(false);\n    }\n  }, [userId]);\n\n  useEffect(() => {\n    fetchPosts();\n\n    const channel = supabase\n      .channel(`profile-feed-${userId}`)\n      .on(\n        'postgres_changes',\n        { event: '*', schema: 'public', table: 'troll_posts', filter: `user_id=eq.${userId}` },\n        () => fetchPosts()\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [userId, fetchPosts]);\n\n  const handleCreatePost = async () => {\n    if (!content.trim() && !mediaFile) return;\n    if (!user) return toast.error('Login to post');\n\n    setIsPosting(true);\n    try {\n      let mediaUrl = null;\n      let postType = 'text';\n\n      if (mediaFile) {\n        const fileExt = mediaFile.name.split('.').pop();\n        const fileName = `${user.id}/${Date.now()}.${fileExt}`;\n        const { error: uploadError } = await supabase.storage\n          .from('post-media')\n          .upload(fileName, mediaFile);\n\n        if (uploadError) throw uploadError;\n\n        const { data: { publicUrl } } = supabase.storage\n          .from('post-media')\n          .getPublicUrl(fileName);\n          \n        mediaUrl = publicUrl;\n        postType = mediaType || 'image';\n      }\n\n      const postData: any = {\n        user_id: user.id,\n        content: content.trim(),\n        post_type: postType\n      };\n\n      if (postType === 'image') postData.image_url = mediaUrl;\n      if (postType === 'video') postData.video_url = mediaUrl;\n\n      const { error } = await supabase\n        .from('troll_posts')\n        .insert(postData);\n\n      if (error) throw error;\n      \n      setContent('');\n      clearMedia();\n      toast.success('Post created!');\n      fetchPosts(); // Refresh immediately\n    } catch (err: any) {\n      console.error('Post error:', err);\n      toast.error(err.message || 'Failed to post');\n    } finally {\n      setIsPosting(false);\n    }\n  };\n\n  const handleDeletePost = async (postId: string) => {\n    if (!confirm('Are you sure you want to delete this post?')) return;\n    try {\n        const { error } = await supabase\n            .from('troll_posts')\n            .delete()\n            .eq('id', postId);\n        \n        if (error) throw error;\n        toast.success('Post deleted');\n        setPosts(prev => prev.filter(p => p.id !== postId));\n    } catch (err) {\n        toast.error('Failed to delete post');\n    }\n  };\n\n  return (\n    <div className=\"max-w-2xl mx-auto py-4\">\n      {/* Create Post Input */}\n      {user?.id === userId && (\n        <div className=\"bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-4 mb-6\">\n          <div className=\"flex gap-4\">\n            <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 p-0.5 flex-shrink-0\">\n               <div className=\"w-full h-full rounded-full bg-black flex items-center justify-center text-white font-bold\">\n                  {user.username?.substring(0, 2).toUpperCase()}\n               </div>\n            </div>\n            <div className=\"flex-1 relative\">\n              <textarea\n                value={content}\n                onChange={(e) => setContent(e.target.value)}\n                placeholder=\"What's on your mind?\"\n                className=\"w-full bg-transparent text-white placeholder-gray-500 focus:outline-none resize-none min-h-[80px]\"\n              />\n              \n              {mediaPreview && (\n                <div className=\"relative mb-4 mt-2 rounded-lg overflow-hidden bg-black/50 border border-white/10 inline-block\">\n                  <button \n                    onClick={clearMedia}\n                    className=\"absolute top-2 right-2 p-1 bg-black/60 hover:bg-black/80 text-white rounded-full transition-colors z-10\"\n                  >\n                    <X size={16} />\n                  </button>\n                  {mediaType === 'image' ? (\n                    <img src={mediaPreview} alt=\"Preview\" className=\"max-h-60 rounded-lg object-contain\" />\n                  ) : (\n                    <video src={mediaPreview} className=\"max-h-60 rounded-lg\" controls />\n                  )}\n                </div>\n              )}\n\n              <div className=\"flex items-center justify-between border-t border-white/5 pt-3 mt-2 relative\">\n                <div className=\"flex gap-2\">\n                    <input\n                        type=\"file\"\n                        ref={fileInputRef}\n                        onChange={handleFileSelect}\n                        accept=\"image/*,video/*\"\n                        className=\"hidden\"\n                    />\n                    <button \n                        onClick={() => fileInputRef.current?.click()}\n                        className=\"p-2 hover:bg-white/5 rounded-full text-green-400 transition-colors\"\n                        title=\"Upload Image/Video\"\n                    >\n                        <Image className=\"w-5 h-5\" />\n                    </button>\n                    <div className=\"relative\" ref={emojiPickerRef}>\n                        <button \n                            onClick={() => setShowEmojiPicker(!showEmojiPicker)}\n                            className=\"p-2 hover:bg-white/5 rounded-full text-yellow-400 transition-colors\"\n                        >\n                            <Smile className=\"w-5 h-5\" />\n                        </button>\n                        {showEmojiPicker && (\n                            <div className=\"absolute top-full left-0 mt-2 z-50\">\n                                <EmojiPicker\n                                    onEmojiClick={onEmojiClick}\n                                    theme={Theme.DARK}\n                                    width={300}\n                                    height={400}\n                                />\n                            </div>\n                        )}\n                    </div>\n                </div>\n                <button\n                    onClick={handleCreatePost}\n                    disabled={isPosting || (!content.trim() && !mediaFile)}\n                    className=\"bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-all\"\n                >\n                    {isPosting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\n                    Post\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Feed */}\n      {loading ? (\n        <div className=\"text-center py-10 text-gray-500\">Loading posts...</div>\n      ) : posts.length === 0 ? (\n        <div className=\"text-center py-10 text-gray-500 bg-white/5 rounded-xl border border-white/5\">\n            No posts yet. Be the first to share something!\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n            {posts.map(post => (\n                <PostItem key={post.id} post={post} onDelete={handleDeletePost} />\n            ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\sidebar\\SidebarTopBroadcasters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\AdminBroadcast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\AdminEntrance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\BattleChatOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\BattleScoreboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\BirthdayOverlay.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":36,"column":26,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1570,1597],"text":"&apos;s Birthday! üéÇ\r\n          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1570,1597],"text":"&lsquo;s Birthday! üéÇ\r\n          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1570,1597],"text":"&#39;s Birthday! üéÇ\r\n          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1570,1597],"text":"&rsquo;s Birthday! üéÇ\r\n          "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { PartyPopper, Cake, Sparkles } from 'lucide-react'\r\n\r\ninterface BirthdayOverlayProps {\r\n  username: string\r\n}\r\n\r\nexport default function BirthdayOverlay({ username }: BirthdayOverlayProps) {\r\n  return (\r\n    <div className=\"absolute inset-0 pointer-events-none z-50 overflow-hidden\">\r\n      {/* Animated Birthday Background */}\r\n      <div className=\"absolute inset-0 bg-gradient-to-br from-pink-500/20 via-purple-500/20 to-yellow-500/20 animate-pulse\" />\r\n      \r\n      {/* Floating Confetti Effect */}\r\n      <div className=\"absolute inset-0\">\r\n        {Array.from({ length: 20 }).map((_, i) => (\r\n          <div\r\n            key={i}\r\n            className=\"absolute w-3 h-3 rounded-full animate-bounce\"\r\n            style={{\r\n              left: `${Math.random() * 100}%`,\r\n              top: `${Math.random() * 100}%`,\r\n              backgroundColor: ['#FF6B9D', '#C44569', '#F8B500', '#FFC93C', '#FF6B6B'][i % 5],\r\n              animationDelay: `${Math.random() * 2}s`,\r\n              animationDuration: `${2 + Math.random() * 2}s`,\r\n            }}\r\n          />\r\n        ))}\r\n      </div>\r\n      \r\n      {/* Birthday Banner Top */}\r\n      <div className=\"absolute top-4 left-1/2 transform -translate-x-1/2 z-10\">\r\n        <div className=\"bg-gradient-to-r from-pink-500 via-purple-500 to-yellow-500 rounded-full px-6 py-3 shadow-lg animate-pulse flex items-center gap-3\">\r\n          <PartyPopper className=\"w-6 h-6 text-white animate-bounce\" />\r\n          <span className=\"text-white font-bold text-lg\">\r\n            üéâ {username}'s Birthday! üéÇ\r\n          </span>\r\n          <Cake className=\"w-6 h-6 text-white animate-bounce\" style={{ animationDelay: '0.5s' }} />\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Sparkle Effects */}\r\n      <div className=\"absolute inset-0\">\r\n        {Array.from({ length: 10 }).map((_, i) => (\r\n          <Sparkles\r\n            key={i}\r\n            className=\"absolute text-yellow-400 animate-ping\"\r\n            style={{\r\n              left: `${Math.random() * 100}%`,\r\n              top: `${Math.random() * 100}%`,\r\n              animationDelay: `${Math.random() * 3}s`,\r\n              animationDuration: `${1 + Math.random()}s`,\r\n            }}\r\n            size={20}\r\n          />\r\n        ))}\r\n      </div>\r\n      \r\n      {/* Corner Decorations */}\r\n      <div className=\"absolute top-0 left-0 w-32 h-32 bg-gradient-to-br from-pink-500/30 to-transparent rounded-br-full\" />\r\n      <div className=\"absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-purple-500/30 to-transparent rounded-bl-full\" />\r\n      <div className=\"absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-yellow-500/30 to-transparent rounded-tr-full\" />\r\n      <div className=\"absolute bottom-0 right-0 w-32 h-32 bg-gradient-to-tl from-pink-500/30 to-transparent rounded-tl-full\" />\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\BroadcastOverlays.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ChatInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ChatOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ChatWindow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ControlBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\EntranceChatPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\EntranceEffect.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftBlast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftBonusPopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftBoxButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftBurst.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftBurstSimple.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftParticles.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GiftPopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GuestGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GuestSlot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\GuestSlots.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\HostVideoStream.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\JoinRequestsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ModerationMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\OfficerEntrance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\OfficerInviteModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ReactionBubble.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ReactionBubbles.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\ResponsiveVideoGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\StreamControls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\StreamLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\StreamReactions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\StudioComponents.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TopBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollCatch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollDrop.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollEventOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollRain.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollSurprise.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollWalking.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\TrollerEntrance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\VideoBox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\VideoFeed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\stream\\streamUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tmv\\DriversTest.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":68,"column":53,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3374,3403],"text":"Driver&apos;s License Written Test"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3374,3403],"text":"Driver&lsquo;s License Written Test"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3374,3403],"text":"Driver&#39;s License Written Test"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3374,3403],"text":"Driver&rsquo;s License Written Test"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport { toast } from 'sonner';\n\nconst QUESTIONS = [\n  { q: \"What is the speed limit in Troll City?\", options: [\"40 mph\", \"No Limit\", \"100 mph\", \"Whatever you want\"], a: \"A\" }, \n  { q: \"What happens if your license expires?\", options: [\"Nothing\", \"Court Summons\", \"Free Gas\", \"You get a medal\"], a: \"B\" },\n   { q: \"How often must you renew your license? (Admins never need to renew)\", options: [\"Every year\", \"Every 30 days\", \"Never (Admins only)\", \"Every week\"], a: \"B\" },\n  { q: \"Who pays for gas?\", options: [\"Admins\", \"Staff\", \"Everyone except Staff\", \"Nobody\"], a: \"C\" },\n  { q: \"What is the gas consumption per action?\", options: [\"1%\", \"5%\", \"10%\", \"20%\"], a: \"B\" },\n  { q: \"Can you drive with a suspended license?\", options: [\"Yes\", \"No\", \"Maybe\", \"Only at night\"], a: \"B\" },\n  { q: \"How much does gas refill cost?\", options: [\"Free\", \"100 coins\", \"300 coins per 5%\", \"1000 coins\"], a: \"C\" },\n  { q: \"What does TMV stand for?\", options: [\"Troll Motor Vehicle\", \"Too Many Vehicles\", \"The Motor Van\", \"Troll Money Vault\"], a: \"A\" },\n  { q: \"Where do you check your vehicle status?\", options: [\"Bank\", \"TMV Dashboard\", \"Hospital\", \"Church\"], a: \"B\" },\n  { q: \"What happens if you fail this test?\", options: [\"Banned\", \"Try again\", \"Pay fine\", \"Nothing\"], a: \"B\" },\n];\n\nexport default function DriversTest({ onComplete }: { onComplete: () => void }) {\n  const [answers, setAnswers] = useState<Record<number, string>>({});\n  const [submitting, setSubmitting] = useState(false);\n  const [result, setResult] = useState<{ passed: boolean; score: number } | null>(null);\n\n  const handleSubmit = async () => {\n     if (Object.keys(answers).length < 10) return toast.error('Answer all questions');\n     \n     setSubmitting(true);\n     try {\n        const payload: Record<string, string> = {};\n        QUESTIONS.forEach((_, i) => {\n           payload[(i + 1).toString()] = answers[i] || '';\n        });\n        \n        const { data, error } = await supabase.rpc('submit_driver_test', { answers: payload });\n        if (error) throw error;\n        \n        setResult(data);\n        if (data.passed) {\n           toast.success('Congratulations! You passed!');\n        } else {\n           toast.error('You failed. Try again.');\n        }\n     } catch (e: any) {\n        toast.error(e.message || 'Error submitting test');\n        // Fallback for dev if RPC not applied\n        if (e.message?.includes('function public.submit_driver_test') && e.message?.includes('does not exist')) {\n            toast.info('Dev Mode: Assuming pass for UI test');\n            setResult({ passed: true, score: 10 });\n        }\n     } finally {\n        setSubmitting(false);\n     }\n  };\n\n  if (result) {\n     return (\n        <div className=\"bg-zinc-900 p-8 rounded-xl border border-zinc-800 text-center\">\n           <h2 className=\"text-2xl font-bold mb-4\">{result.passed ? 'PASSED!' : 'FAILED'}</h2>\n           <p className=\"text-4xl font-bold mb-6\">{result.score} / 10</p>\n           <button onClick={onComplete} className=\"px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg\">\n              {result.passed ? 'Get License' : 'Try Again'}\n           </button>\n        </div>\n     );\n  }\n\n  return (\n    <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\n       <h2 className=\"text-xl font-bold mb-6\">Driver's License Written Test</h2>\n       <div className=\"space-y-6\">\n          {QUESTIONS.map((q, i) => (\n             <div key={i} className=\"space-y-2\">\n                <p className=\"font-medium text-white\">{i + 1}. {q.q}</p>\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n                   {q.options.map((opt, optIndex) => {\n                      const letter = String.fromCharCode(65 + optIndex); // A, B, C, D\n                      return (\n                         <button\n                           key={letter}\n                           onClick={() => setAnswers(prev => ({ ...prev, [i]: letter }))}\n                           className={`p-2 rounded text-left text-sm border transition ${answers[i] === letter ? 'bg-purple-600 border-purple-500 text-white' : 'bg-zinc-800 border-zinc-700 text-gray-300 hover:bg-zinc-700'}`}\n                         >\n                            <span className=\"font-bold mr-2\">{letter}.</span> {opt}\n                         </button>\n                      );\n                   })}\n                </div>\n             </div>\n          ))}\n       </div>\n       <div className=\"mt-8 flex justify-end\">\n          <button \n            onClick={handleSubmit} \n            disabled={submitting}\n            className=\"px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold disabled:opacity-50\"\n          >\n             {submitting ? 'Grading...' : 'Submit Test'}\n          </button>\n       </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tmv\\GasHUD.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tmv\\GasStationModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchFollowing'. Either include it or remove the dependency array.","line":21,"column":6,"nodeType":"ArrayExpression","endLine":21,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [fetchFollowing, isOpen, tab]","fix":{"range":[811,824],"text":"[fetchFollowing, isOpen, tab]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":208,"column":114,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[8953,8980],"text":"No friends found matching &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[8953,8980],"text":"No friends found matching &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[8953,8980],"text":"No friends found matching &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[8953,8980],"text":"No friends found matching &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":208,"column":127,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[8992,8993],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[8992,8993],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[8992,8993],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[8992,8993],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { useAuthStore } from '@/lib/store';\nimport { supabase } from '@/lib/supabase';\nimport { X, Fuel, Users } from 'lucide-react';\nimport { toast } from 'sonner';\n\nexport default function GasStationModal({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {\n  const { profile, refreshProfile } = useAuthStore();\n  const [loading, setLoading] = useState(false);\n  const [tab, setTab] = useState<'refill' | 'request'>('refill');\n  const [targetUser, setTargetUser] = useState('');\n  \n  // New state for following list\n  const [followingUsers, setFollowingUsers] = useState<any[]>([]);\n  const [followingLoading, setFollowingLoading] = useState(false);\n\n  useEffect(() => {\n    if (isOpen && tab === 'request') {\n      fetchFollowing();\n    }\n  }, [isOpen, tab]);\n\n  if (!isOpen || !profile) return null;\n\n  const fetchFollowing = async () => {\n    if (!profile) return;\n    setFollowingLoading(true);\n    try {\n      const { data } = await supabase\n        .from('user_follows')\n        .select('following:user_profiles!user_follows_following_id_fkey(id, username, avatar_url)')\n        .eq('follower_id', profile.id)\n        .limit(50); // Limit to recent/top 50 for performance\n\n      if (data) {\n        const users = data.map((d: any) => d.following).filter(Boolean);\n        setFollowingUsers(users);\n      }\n    } catch (e) {\n      console.error('Error fetching following:', e);\n    } finally {\n      setFollowingLoading(false);\n    }\n  };\n\n  const filteredUsers = followingUsers.filter(u => \n    u.username.toLowerCase().includes(targetUser.toLowerCase())\n  );\n  \n  const gas = profile.gas_balance ?? 100;\n  \n  // Cost: 300 coins per 5%\n  const handleRefill = async (amount: number) => {\n    setLoading(true);\n    try {\n      const { error } = await supabase.rpc('refill_gas', { p_amount_percent: amount });\n      if (error) throw error;\n      toast.success(`Refilled ${amount}% gas!`);\n      await refreshProfile();\n      // onClose(); // Keep open to see result? Or close.\n    } catch (e: any) {\n      toast.error(e.message || 'Failed to refill');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleRequest = async () => {\n    if (!targetUser) return toast.error('Enter a username');\n    setLoading(true);\n    try {\n       // Search user first to get ID\n       const { data: users } = await supabase.from('user_profiles').select('id').eq('username', targetUser).single();\n       if (!users) throw new Error('User not found');\n       \n       const { error } = await supabase.rpc('request_gas', { \n         p_target_user_id: users.id,\n         p_amount: 20 // Request 20% by default\n       });\n       if (error) throw error;\n       toast.success('Gas request sent!');\n       onClose();\n    } catch (e: any) {\n      toast.error(e.message || 'Failed to send request');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Pre-calculate options\n  const options = [5, 25, 50, 100];\n\n  return (\n    <div className=\"fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4\">\n      <div className=\"bg-zinc-900 border border-zinc-700 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-200\">\n        <div className=\"p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950\">\n          <h2 className=\"text-xl font-bold flex items-center gap-2\">\n            <Fuel className=\"text-yellow-500\" /> Gas Station\n          </h2>\n          <button onClick={onClose}><X className=\"text-gray-400 hover:text-white\" /></button>\n        </div>\n        \n        <div className=\"p-6\">\n           {/* Tabs */}\n           <div className=\"flex gap-2 mb-6 bg-zinc-950 p-1 rounded-lg\">\n             <button \n               onClick={() => setTab('refill')}\n               className={`flex-1 py-2 rounded-md text-sm font-medium transition ${tab === 'refill' ? 'bg-yellow-600 text-white' : 'text-gray-400 hover:text-white'}`}\n             >\n               Refill\n             </button>\n             <button \n               onClick={() => setTab('request')}\n               className={`flex-1 py-2 rounded-md text-sm font-medium transition ${tab === 'request' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}\n             >\n               Request Gas\n             </button>\n           </div>\n\n           {tab === 'refill' && (\n             <div className=\"space-y-4\">\n                <div className=\"text-center mb-4\">\n                   <p className=\"text-gray-400\">Current Tank</p>\n                   <div className=\"text-4xl font-bold text-white flex justify-center items-end gap-1\">\n                     {Math.floor(gas)}<span className=\"text-lg text-yellow-500 mb-1\">%</span>\n                   </div>\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-3\">\n                   {options.map(pct => {\n                     // Can't refill more than what's missing\n                     // But let's just cap it visually or logic-wise. \n                     // The logic in RPC handles capping at 100.\n                     // But we shouldn't show +100% if we have 90%.\n                     \n                     if (gas + pct > 100) {\n                         // Optional: Adjust to exact fill? \n                         // \"Fill Up\" button might be better.\n                     }\n                     \n                     const cost = Math.ceil((pct / 5) * 300);\n                     const wouldOverflow = gas >= 100;\n                     \n                     return (\n                       <button\n                         key={pct}\n                         disabled={wouldOverflow || loading}\n                         onClick={() => handleRefill(pct)}\n                         className=\"flex flex-col items-center p-3 bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl border border-zinc-700 transition\"\n                       >\n                         <span className=\"text-lg font-bold text-white\">+{pct}%</span>\n                         <span className=\"text-xs text-yellow-400\">{cost} Coins</span>\n                       </button>\n                     );\n                   })}\n                   <button\n                     disabled={gas >= 100 || loading}\n                     onClick={() => handleRefill(100 - gas)}\n                     className=\"col-span-2 flex flex-col items-center p-3 bg-green-900/50 hover:bg-green-900/70 border border-green-700 rounded-xl transition\"\n                   >\n                      <span className=\"text-lg font-bold text-white\">Fill Tank</span>\n                      <span className=\"text-xs text-green-300\">\n                        {Math.ceil(((100 - gas) / 5) * 300)} Coins\n                      </span>\n                   </button>\n                </div>\n                \n                <p className=\"text-xs text-center text-gray-500 mt-4\">\n                  Staff members refill for free.\n                </p>\n             </div>\n           )}\n\n           {tab === 'request' && (\n             <div className=\"space-y-4\">\n               <p className=\"text-sm text-gray-400\">Ask a friend to send you gas.</p>\n               <div className=\"relative\">\n                 <Users className=\"absolute left-3 top-3 text-gray-500 w-5 h-5\" />\n                 <input \n                   type=\"text\" \n                   placeholder=\"Enter username...\"\n                   value={targetUser}\n                   onChange={e => setTargetUser(e.target.value)}\n                   className=\"w-full pl-10 pr-4 py-2 bg-zinc-950 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-blue-500\"\n                 />\n               </div>\n\n               {/* Following List */}\n               <div className=\"max-h-48 overflow-y-auto space-y-2 pr-1 custom-scrollbar\">\n                 {followingLoading ? (\n                   <p className=\"text-center text-xs text-gray-500 py-2\">Loading friends...</p>\n                 ) : filteredUsers.length > 0 ? (\n                   filteredUsers.map(u => (\n                     <button\n                       key={u.id}\n                       onClick={() => setTargetUser(u.username)}\n                       className=\"w-full flex items-center gap-3 p-2 rounded-lg hover:bg-zinc-800 transition text-left group\"\n                     >\n                       <img \n                         src={u.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.username}`} \n                         alt={u.username}\n                         className=\"w-8 h-8 rounded-full bg-zinc-800 object-cover\"\n                       />\n                       <span className=\"text-sm text-gray-300 group-hover:text-white transition-colors\">@{u.username}</span>\n                     </button>\n                   ))\n                 ) : (\n                   targetUser && <p className=\"text-center text-xs text-gray-500 py-2\">No friends found matching \"{targetUser}\"</p>\n                 )}\n               </div>\n\n               <button \n                 onClick={handleRequest}\n                 disabled={loading}\n                 className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition disabled:opacity-50\"\n               >\n                 {loading ? 'Sending...' : 'Send Request'}\n               </button>\n             </div>\n           )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tmv\\TMVDrivingManual.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tmv\\TMVRouter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tmv\\TMVTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[168,175],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":69,"column":60,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[2927,2958],"text":" Driver&apos;s License\n             "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[2927,2958],"text":" Driver&lsquo;s License\n             "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[2927,2958],"text":" Driver&#39;s License\n             "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[2927,2958],"text":" Driver&rsquo;s License\n             "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":151,"column":89,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7044,7154],"text":"\n              Insurance covers 30 days. Cost: 2000 Coins. Upgrades increase your vehicle&apos;s value.\n           "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7044,7154],"text":"\n              Insurance covers 30 days. Cost: 2000 Coins. Upgrades increase your vehicle&lsquo;s value.\n           "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7044,7154],"text":"\n              Insurance covers 30 days. Cost: 2000 Coins. Upgrades increase your vehicle&#39;s value.\n           "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7044,7154],"text":"\n              Insurance covers 30 days. Cost: 2000 Coins. Upgrades increase your vehicle&rsquo;s value.\n           "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'loadVehicles'. Either include it or remove the dependency array.","line":172,"column":6,"nodeType":"ArrayExpression","endLine":172,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [loadVehicles, userId]","fix":{"range":[7804,7812],"text":"[loadVehicles, userId]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\nimport { useAuthStore } from '@/lib/store';\nimport { supabase } from '@/lib/supabase';\nimport { Car, AlertTriangle, CheckCircle, Clock, Shield, XCircle, Gavel, Wrench } from 'lucide-react';\nimport { toast } from 'sonner';\nimport DriversTest from './DriversTest';\nimport CarUpgradesModal from '@/components/CarUpgradesModal';\n\nexport default function TMVTab({ profile, isOwnProfile }: { profile: any, isOwnProfile: boolean }) {\n   const { user, refreshProfile } = useAuthStore();\n   const [takingTest, setTakingTest] = useState(false);\n   const [loading, setLoading] = useState(false);\n\n   if (!profile) return null;\n   \n   const licenseStatus = profile.drivers_license_status || 'none';\n   const licenseExpiry = profile.drivers_license_expiry;\n   const isExpired = licenseExpiry ? new Date(licenseExpiry) < new Date() : false;\n\n   // Check if viewer is staff (Secretary or Admin)\n   const isStaff = user && (user.role === 'admin' || user.role === 'secretary' || (user as any).is_admin);\n   // Check if profile is admin (for infinite license)\n   const isAdminProfile = profile.role === 'admin' || profile.is_admin;\n\n   const handlePurchaseInsurance = async (carId: string) => {\n     setLoading(true);\n     try {\n       const { error } = await supabase.rpc('purchase_insurance', { p_car_id: carId });\n       if (error) throw error;\n       toast.success('Insurance purchased!');\n       await refreshProfile();\n       // We also need to trigger a refresh of the profile being viewed if it's the same\n       // But refreshProfile() only refreshes the logged in user. \n       // Profile.tsx handles real-time updates for the viewed profile, so it should be fine.\n     } catch (e: any) {\n       toast.error(e.message || 'Failed to purchase insurance');\n     } finally {\n       setLoading(false);\n     }\n   };\n\n   const handleAdminAction = async (action: 'suspend' | 'revoke' | 'reinstate') => {\n       if (!confirm(`Are you sure you want to ${action} this license?`)) return;\n       setLoading(true);\n       try {\n           const { error } = await supabase.rpc('admin_suspend_license', { \n               p_target_user_id: profile.id,\n               p_action: action\n           });\n           if (error) throw error;\n           toast.success(`License ${action}ed`);\n       } catch (e: any) {\n           toast.error(e.message || 'Action failed');\n       } finally {\n           setLoading(false);\n       }\n   };\n   \n   if (takingTest && isOwnProfile) {\n      return <DriversTest onComplete={() => { setTakingTest(false); refreshProfile(); }} />;\n   }\n\n   return (\n     <div className=\"space-y-6\">\n        {/* License Status */}\n        <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\n           <div className=\"flex justify-between items-start mb-4\">\n             <h3 className=\"text-lg font-bold flex items-center gap-2\">\n                 <Car className=\"text-purple-400\" /> Driver's License\n             </h3>\n             {isStaff && !isOwnProfile && (\n                 <div className=\"flex gap-2\">\n                     {licenseStatus !== 'suspended' && (\n                         <button \n                             onClick={() => handleAdminAction('suspend')}\n                             className=\"px-3 py-1 bg-red-900/50 hover:bg-red-900 text-red-200 text-xs rounded border border-red-700 flex items-center gap-1\"\n                         >\n                             <Gavel size={12}/> Suspend\n                         </button>\n                     )}\n                     {licenseStatus === 'suspended' && (\n                         <button \n                             onClick={() => handleAdminAction('reinstate')}\n                             className=\"px-3 py-1 bg-green-900/50 hover:bg-green-900 text-green-200 text-xs rounded border border-green-700\"\n                         >\n                             Reinstate\n                         </button>\n                     )}\n                 </div>\n             )}\n           </div>\n           \n           <div className=\"flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n              <div className=\"flex items-center gap-4\">\n                 {licenseStatus === 'active' && !isExpired ? (\n                    <div className=\"w-16 h-10 bg-green-500/20 text-green-400 flex items-center justify-center rounded-lg border border-green-500/40\">\n                       <CheckCircle />\n                    </div>\n                 ) : licenseStatus === 'suspended' ? (\n                    <div className=\"w-16 h-10 bg-red-500/20 text-red-400 flex items-center justify-center rounded-lg border border-red-500/40\">\n                       <XCircle />\n                    </div>\n                 ) : (\n                    <div className=\"w-16 h-10 bg-yellow-500/20 text-yellow-400 flex items-center justify-center rounded-lg border border-yellow-500/40\">\n                       <AlertTriangle />\n                    </div>\n                 )}\n                 \n                 <div>\n                    <p className=\"font-bold text-lg capitalize text-white\">\n                       {licenseStatus === 'none' ? 'No License' : licenseStatus}\n                    </p>\n                    {isAdminProfile ? (\n                       <p className=\"text-sm text-blue-400\" title=\"Admins never need to renew\">\n                         Expires: <span style={{fontFamily:'monospace', fontWeight:'bold'}}>‚àû</span> (Admin)\n                       </p>\n                    ) : licenseExpiry && (\n                       <p className={`text-sm ${isExpired ? 'text-red-400' : 'text-gray-400'}`}>\n                          Expires: {new Date(licenseExpiry).toLocaleDateString()}\n                          {isExpired && ' (EXPIRED)'}\n                       </p>\n                    )}\n                 </div>\n              </div>\n              \n              <div>\n                 {isOwnProfile && (licenseStatus === 'none' || isExpired) && licenseStatus !== 'suspended' && (\n                    <button \n                      onClick={() => setTakingTest(true)}\n                      className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition\"\n                    >\n                      {licenseStatus === 'none' ? 'Take Driver Test' : 'Renew License'}\n                    </button>\n                 )}\n                 {licenseStatus === 'suspended' && (\n                    <span className=\"text-red-400 text-sm font-medium px-3 py-1 bg-red-900/20 rounded-lg border border-red-500/20\">\n                       Suspended by Court\n                    </span>\n                 )}\n              </div>\n           </div>\n        </div>\n        \n        {/* Vehicles & Insurance */}\n        <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\n           <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\n              <Shield className=\"text-blue-400\" /> Vehicle Insurance & Upgrades\n           </h3>\n           \n           <p className=\"text-gray-400 text-sm mb-4\">\n              Insurance covers 30 days. Cost: 2000 Coins. Upgrades increase your vehicle's value.\n           </p>\n           \n           <VehicleList \n             userId={profile.id} \n             onPurchaseInsurance={handlePurchaseInsurance} \n             loading={loading} \n             canPurchase={isOwnProfile}\n           />\n        </div>\n     </div>\n   );\n}\n\nfunction VehicleList({ userId, onPurchaseInsurance, loading, canPurchase }: { userId: string, onPurchaseInsurance: (id: string) => void, loading: boolean, canPurchase: boolean }) {\n  const [vehicles, setVehicles] = useState<any[]>([]);\n  const [selectedCarId, setSelectedCarId] = useState<string | null>(null);\n  \n  React.useEffect(() => {\n     if (!userId) return;\n     loadVehicles();\n  }, [userId]);\n\n  const loadVehicles = async () => {\n    const { data } = await supabase\n      .from('user_cars')\n      .select('*')\n      .eq('user_id', userId);\n    if (data) setVehicles(data);\n  };\n\n  if (vehicles.length === 0) return <p className=\"text-gray-500\">No vehicles owned.</p>;\n\n  return (\n    <>\n      <CarUpgradesModal\n        userCarId={selectedCarId!}\n        onClose={() => {\n          setSelectedCarId(null);\n          loadVehicles();\n        }}\n        onUpdate={loadVehicles}\n      />\n      <div className=\"space-y-3\">\n         {vehicles.map(v => {\n            const insuranceExpiry = v.insurance_expiry;\n            const isInsured = insuranceExpiry && new Date(insuranceExpiry) > new Date();\n            const currentValue = v.current_value || 0;\n            \n            return (\n               <div key={v.id} className=\"flex items-center justify-between p-3 bg-zinc-800 rounded-lg border border-zinc-700\">\n                  <div>\n                     <p className=\"font-bold text-white capitalize\">{v.car_id.replace(/_/g, ' ')} <span className=\"text-xs text-gray-500\">({v.tier || 'Car'})</span></p>\n                     <div className=\"flex items-center gap-3 mt-1\">\n                        <p className=\"text-xs text-gray-400\">\n                           {isInsured ? `Insured until ${new Date(insuranceExpiry).toLocaleDateString()}` : 'No Active Insurance'}\n                        </p>\n                        <p className=\"text-xs text-emerald-400 font-mono\">\n                          Value: {currentValue.toLocaleString()} coins\n                        </p>\n                     </div>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-2\">\n                     {canPurchase && (\n                       <button \n                         onClick={() => setSelectedCarId(v.id)}\n                         className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 text-xs rounded font-medium flex items-center gap-1\"\n                       >\n                         <Wrench size={12} /> Upgrades\n                       </button>\n                     )}\n                     {canPurchase && !isInsured && (\n                       <button \n                         onClick={() => onPurchaseInsurance(v.id)}\n                         disabled={loading}\n                         className=\"px-3 py-1 bg-green-600 hover:bg-green-700 text-xs rounded font-medium disabled:opacity-50\"\n                       >\n                          Buy Insurance (2k)\n                       </button>\n                     )}\n                     {isInsured && (\n                       <span className=\"text-green-400 flex items-center gap-1 text-xs font-bold\">\n                          <Shield size={12} /> Protected\n                       </span>\n                     )}\n                  </div>\n               </div>\n            );\n         })}\n      </div>\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\trollWall\\CreatePostModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\trollWall\\DailyLoginWall.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'submitDailyPost' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":22,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { Calendar, Zap, Send } from 'lucide-react'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { useDailyLoginPost } from '../../lib/hooks/useDailyLoginPost'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { toast } from 'sonner'\r\n\r\ninterface DailyLoginWallProps {\r\n  onPostCreated?: (postId: string) => void\r\n}\r\n\r\n/**\r\n * Daily Login Wall Component\r\n * Allows users to make a post once per day to earn random coins (0-100)\r\n */\r\nexport default function DailyLoginWall({ onPostCreated }: DailyLoginWallProps) {\r\n  const { user } = useAuthStore()\r\n  const {\r\n    loading,\r\n    canPostToday,\r\n    checkDailyPostStatus,\r\n    submitDailyPost,\r\n    generateRandomReward,\r\n  } = useDailyLoginPost()\r\n\r\n  const [content, setContent] = useState('')\r\n  const [posting, setPosting] = useState(false)\r\n  const [previewReward, setPreviewReward] = useState<number | null>(null)\r\n\r\n  // Check daily post status on mount\r\n  useEffect(() => {\r\n    checkDailyPostStatus()\r\n  }, [checkDailyPostStatus])\r\n\r\n  // Update preview reward when user hovers\r\n  const handleMouseEnter = () => {\r\n    if (canPostToday) {\r\n      setPreviewReward(generateRandomReward())\r\n    }\r\n  }\r\n\r\n  const handleMouseLeave = () => {\r\n    setPreviewReward(null)\r\n  }\r\n\r\n  // Submit the daily post\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n\r\n    if (!user?.id) {\r\n      toast.error('You must be logged in')\r\n      return\r\n    }\r\n\r\n    if (!content.trim()) {\r\n      toast.error('Please write something to post')\r\n      return\r\n    }\r\n\r\n    // Double-check before submitting - refresh the daily post status\r\n    if (!canPostToday) {\r\n      toast.error('You have already posted today!')\r\n      return\r\n    }\r\n\r\n    setPosting(true)\r\n\r\n    try {\r\n      // Re-check daily post status to prevent race conditions\r\n      const { data: existingPost, error: checkErr } = await supabase\r\n        .from('daily_login_posts')\r\n        .select('id')\r\n        .eq('user_id', user.id)\r\n        .gte('posted_at', new Date(new Date().setHours(0, 0, 0, 0)).toISOString())\r\n        .lte('posted_at', new Date(new Date().setHours(23, 59, 59, 999)).toISOString())\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      if (checkErr && checkErr.code !== 'PGRST116') {\r\n        toast.error('Failed to verify post status')\r\n        return\r\n      }\r\n\r\n      if (existingPost) {\r\n        toast.error('You have already posted today! Come back tomorrow.')\r\n        // Update local state to reflect actual database state\r\n        await checkDailyPostStatus()\r\n        return\r\n      }\r\n\r\n      // Create wall post\r\n      const { data: postData, error: postError } = await supabase\r\n        .from('troll_wall_posts')\r\n        .insert({\r\n          user_id: user.id,\r\n          post_type: 'text',\r\n          content: content.trim(),\r\n          is_daily_login_post: true,\r\n          metadata: {\r\n            type: 'daily_login',\r\n            posted_at: new Date().toISOString(),\r\n          },\r\n        })\r\n        .select('id')\r\n        .single()\r\n\r\n      if (postError) {\r\n        toast.error('Failed to create post')\r\n        console.error('Post creation error:', postError)\r\n        return\r\n      }\r\n\r\n      // Just reset form and callback, no coin reward\r\n      setContent('')\r\n      setPreviewReward(null)\r\n      if (onPostCreated) {\r\n        onPostCreated(postData.id)\r\n      }\r\n    } catch (err) {\r\n      console.error('Error submitting daily post:', err)\r\n      toast.error('An error occurred')\r\n    } finally {\r\n      setPosting(false)\r\n    }\r\n  }\r\n\r\n  if (!user?.id) {\r\n    return (\r\n      <div className=\"bg-slate-900/50 border border-slate-700 rounded-lg p-6 text-center\">\r\n        <Calendar className=\"w-8 h-8 text-cyan-400 mx-auto mb-3\" />\r\n        <p className=\"text-gray-400\">\r\n          Log in to post daily and earn Troll Coins!\r\n        </p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-700 rounded-lg p-6 mb-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center gap-3 mb-4\">\r\n        <Calendar className=\"w-5 h-5 text-cyan-400\" />\r\n        <h3 className=\"text-lg font-bold text-white\">Daily Login Post</h3>\r\n        {!canPostToday && (\r\n          <span className=\"ml-auto text-sm bg-slate-700 text-yellow-300 px-3 py-1 rounded-full\">\r\n            ‚úì Posted Today\r\n          </span>\r\n        )}\r\n      </div>\r\n\r\n      {/* Status Message */}\r\n      <div className=\"mb-4 p-3 bg-slate-800/50 border border-slate-700 rounded-lg\">\r\n        <p className=\"text-sm text-gray-300\">\r\n          {canPostToday ? (\r\n            <span className=\"flex items-center gap-2\">\r\n              <Zap className=\"w-4 h-4 text-yellow-400\" />\r\n              Post once daily to earn <span className=\"font-bold text-cyan-400\">0-100 Troll Coins</span>\r\n            </span>\r\n          ) : (\r\n            <span className=\"flex items-center gap-2\">\r\n              <span className=\"text-green-400\">‚úì</span>\r\n              Great! You already posted today. Come back tomorrow!\r\n            </span>\r\n          )}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Form */}\r\n      {canPostToday ? (\r\n        <form onSubmit={handleSubmit}>\r\n          {/* Textarea */}\r\n          <textarea\r\n            value={content}\r\n            onChange={(e) => setContent(e.target.value)}\r\n            placeholder=\"What's on your mind? Share your daily troll thoughts...\"\r\n            maxLength={500}\r\n            disabled={posting || loading}\r\n            className=\"w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white placeholder-gray-500 resize-none focus:outline-none focus:border-cyan-400 disabled:opacity-50\"\r\n            rows={4}\r\n          />\r\n\r\n          {/* Character count */}\r\n          <div className=\"text-right text-xs text-gray-500 mt-2\">\r\n            {content.length}/500\r\n          </div>\r\n\r\n          {/* Submit Button */}\r\n          <button\r\n            type=\"submit\"\r\n            disabled={!content.trim() || posting || loading}\r\n            onMouseEnter={handleMouseEnter}\r\n            onMouseLeave={handleMouseLeave}\r\n            className=\"w-full mt-4 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2\"\r\n          >\r\n            <Send className=\"w-4 h-4\" />\r\n            {posting ? 'Posting...' : 'Post & Earn Coins'}\r\n            {previewReward !== null && (\r\n              <span className=\"ml-auto text-yellow-300 font-bold\">\r\n                +{previewReward} ü™ô\r\n              </span>\r\n            )}\r\n          </button>\r\n        </form>\r\n      ) : (\r\n        /* Disabled State */\r\n        <div className=\"p-4 bg-slate-800/50 border border-slate-700 rounded-lg text-center\">\r\n          <p className=\"text-gray-400 mb-2\">You can post again tomorrow!</p>\r\n          <p className=\"text-xs text-gray-500\">\r\n            Posts reset daily at midnight UTC\r\n          </p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\trollWall\\GiftModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tromody\\StageFrame.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tromody\\TromodyChat.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tromody\\TromodyGiftBox.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tromody\\TromodyInstructions.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tromody\\TromodyLikeButton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\tromody\\TromodyVideoBox.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\EmptyStateLiveNow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\ProfileDropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\SidebarGroup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\Skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\TrollPassBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\badge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\button.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\card.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\components\\ui\\input.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\config\\LEVEL_CONFIG.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\config\\levelSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\contexts\\AuthProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\contexts\\GlobalAppContext.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":76,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":76,"endColumn":26,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\contexts\\LiveKitContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\contexts\\LiveKitProvider.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":545,"column":5,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":545,"endColumn":18,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[20742,20755],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\data\\perks_insurance_themes_summary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\data\\vehicles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\fixes\\admin-reset-api-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\fixes\\application-lead-officer-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\fixes\\boo-sound-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\fixes\\chat-broadcast-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\fixes\\profile-flash-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\fixes\\profile-gift-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useAdmin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useBackgroundProfileRefresh.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useBattleGifts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useBattleQueue.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useBattleTimer.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useBroadcastLayout.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useCheckOfficerOnboarding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useDebouncedProfileUpdate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useEntranceEffects.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useEquippedVehicle.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useGoLiveFlow.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'user.id'. Either include it or remove the dependency array.","line":411,"column":6,"nodeType":"ArrayExpression","endLine":411,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [stream?.id, user.id, publishTracks]","fix":{"range":[15094,15117],"text":"[stream?.id, user.id, publishTracks]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCallback, useState, useRef } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { ConnectionState, Room, RoomEvent, Track } from 'livekit-client'\r\nimport { toast } from 'sonner'\r\nimport { getLiveKitToken, type LiveKitTokenResponse } from '../lib/livekit-utils'\r\n\r\nexport interface StreamConfig {\r\n  title: string\r\n  category: 'Just Chatting' | 'Family Stream' | 'Music' | 'Other' | 'Officer Stream' | 'Tromody Show' | 'Troll Battles'\r\n  description?: string\r\n  audience?: 'public' | 'followers' | 'family'\r\n  allowGifts?: boolean\r\n  guestSlots?: number\r\n}\r\n\r\n\r\n\r\nexport const useGoLiveFlow = () => {\r\n  const { user, profile } = useAuthStore()\r\n  \r\n  const [stream, setStream] = useState<any>(null)\r\n  const [room, setRoom] = useState<Room | null>(null)\r\n  const [connectionState, setConnectionState] = useState<'idle' | 'connecting' | 'connected' | 'publishing' | 'error'>('idle')\r\n  const [permissionState, setPermissionState] = useState<'idle' | 'requesting' | 'granted' | 'denied'>('idle')\r\n  const [localStream, setLocalStream] = useState<MediaStream | null>(null)\r\n  const [error, setError] = useState<string | null>(null)\r\n  \r\n  const roomRef = useRef<Room | null>(null)\r\n  const localTracksRef = useRef<any[]>([])\r\n\r\n  const createStreamRecord = useCallback(\r\n    async (config: StreamConfig) => {\r\n      if (!user || !profile) {\r\n        setError('You must be logged in')\r\n        return null\r\n      }\r\n\r\n      try {\r\n        const streamId = crypto.randomUUID()\r\n        \r\n        const categoryDefaults: Record<string, any> = {\r\n          'Just Chatting': { guestSlots: 3 },\r\n          'Family Stream': { guestSlots: 4, familyBonus: true },\r\n          'Music': { guestSlots: 2 },\r\n          'Other': { guestSlots: 3 },\r\n          'Officer Stream': { guestSlots: 2 },\r\n          'Tromody Show': { guestSlots: 0 },\r\n          'Troll Battles': { guestSlots: 1 },\r\n        }\r\n\r\n        const defaults = categoryDefaults[config.category] || { guestSlots: 3 }\r\n\r\n        const { data, error: insertError } = await supabase\r\n          .from('streams')\r\n          .insert({\r\n            id: streamId,\r\n            broadcaster_id: profile.id,\r\n            title: config.title,\r\n            category: config.category,\r\n            description: config.description || '',\r\n            audience_type: config.audience || 'public',\r\n            allow_gifts: config.allowGifts !== false,\r\n            room_name: `stream-${streamId}`,\r\n            is_live: false,\r\n            status: 'preparing',\r\n            viewer_count: 0,\r\n            current_viewers: 0,\r\n            total_gifts_coins: 0,\r\n            popularity: 0,\r\n            max_guest_slots: config.guestSlots ?? defaults.guestSlots,\r\n            created_at: new Date().toISOString(),\r\n          })\r\n          .select()\r\n          .single()\r\n\r\n        if (insertError) {\r\n          console.error('[useGoLiveFlow] Stream creation failed:', insertError)\r\n          setError('Failed to create stream')\r\n          return null\r\n        }\r\n\r\n        console.log(`[useGoLiveFlow] Stream created: ${streamId} category=${config.category}`)\r\n        setStream(data)\r\n        return data\r\n      } catch (err: any) {\r\n        console.error('[useGoLiveFlow] Error creating stream:', err)\r\n        setError(err.message || 'Failed to create stream')\r\n        return null\r\n      }\r\n    },\r\n    [user, profile]\r\n  )\r\n\r\n  const getToken = useCallback(\r\n    async (streamId: string, allowPublish: boolean) => {\r\n      if (!user) {\r\n        setError('You must be logged in')\r\n        return null\r\n      }\r\n\r\n      if (!profile?.id || !profile?.username || !profile?.role) {\r\n        setError('Profile not fully loaded. Please try again.')\r\n        console.error('[useGoLiveFlow] Profile incomplete:', {\r\n          id: profile?.id,\r\n          username: profile?.username,\r\n          role: profile?.role,\r\n        })\r\n        return null\r\n      }\r\n\r\n      try {\r\n        const tokenData = await getLiveKitToken(streamId, allowPublish)\r\n        console.log(`[useGoLiveFlow] Token obtained: allowPublish=${tokenData.allowPublish} room=${tokenData.room}`)\r\n        return tokenData\r\n      } catch (err: any) {\r\n        console.error('[useGoLiveFlow] Token request failed:', err.message)\r\n        setError(err.message || 'Failed to get token')\r\n        return null\r\n      }\r\n    },\r\n    [user, profile]\r\n  )\r\n\r\n  const connectToRoom = useCallback(\r\n    async (streamId: string, allowPublish: boolean, providedToken?: LiveKitTokenResponse) => {\r\n      console.log(`[useGoLiveFlow] connectToRoom called: streamId=${streamId} allowPublish=${allowPublish} state=${connectionState} tokenProvided=${Boolean(providedToken)}`)\r\n      \r\n      if (connectionState === 'connecting' || connectionState === 'connected' || connectionState === 'publishing') {\r\n        console.warn('[useGoLiveFlow] Already connecting or connected')\r\n        return roomRef.current\r\n      }\r\n\r\n      setConnectionState('connecting')\r\n      setError(null)\r\n\r\n      try {\r\n        const tokenData = providedToken ?? (await getToken(streamId, allowPublish))\r\n        \r\n        if (!tokenData) {\r\n          console.error('[useGoLiveFlow] Failed to get token')\r\n          setConnectionState('error')\r\n          return null\r\n        }\r\n\r\n        console.log(`[useGoLiveFlow] Token received - allowPublish=${tokenData.allowPublish} room=${tokenData.room}`)\r\n\r\n        const newRoom = new Room({\r\n          adaptiveStream: true,\r\n          dynacast: true,\r\n          stopLocalTrackOnUnpublish: true,\r\n        })\r\n\r\n        newRoom.on(RoomEvent.Connected, () => {\r\n          console.log(`[useGoLiveFlow] ‚úÖ Room connected: ${streamId}`)\r\n          setConnectionState('connected')\r\n        })\r\n\r\n        newRoom.on(RoomEvent.Disconnected, () => {\r\n          console.log('[useGoLiveFlow] Room disconnected')\r\n          setConnectionState('idle')\r\n        })\r\n\r\n        newRoom.on(RoomEvent.ParticipantConnected, (participant) => {\r\n          console.log(`[useGoLiveFlow] Participant connected: ${participant.identity}`)\r\n        })\r\n\r\n        console.log(`[useGoLiveFlow] Connecting to LiveKit URL: ${tokenData.livekitUrl || import.meta.env.VITE_LIVEKIT_URL}`)\r\n        await newRoom.connect(tokenData.livekitUrl || import.meta.env.VITE_LIVEKIT_URL, tokenData.token)\r\n        setConnectionState('connected')\r\n\r\n        roomRef.current = newRoom\r\n        setRoom(newRoom)\r\n        \r\n        console.log('[useGoLiveFlow] Room connection established')\r\n        console.log('[useGoLiveFlow] Room state after connect:', {\r\n          roomState: newRoom.state,\r\n          localParticipantId: newRoom.localParticipant?.identity,\r\n          isCameraEnabled: newRoom.localParticipant?.isCameraEnabled,\r\n          isMicrophoneEnabled: newRoom.localParticipant?.isMicrophoneEnabled,\r\n        })\r\n        return newRoom\r\n      } catch (err: any) {\r\n        console.error('[useGoLiveFlow] Room connection failed:', err.message || err)\r\n        setConnectionState('error')\r\n        setError(err.message || 'Failed to connect to room')\r\n        return null\r\n      }\r\n    },\r\n    [getToken, connectionState]\r\n  )\r\n\r\n  const requestPermissions = useCallback(async () => {\r\n    setPermissionState('requesting')\r\n    setError(null)\r\n    console.log('[useGoLiveFlow] Requesting camera and microphone permissions...')\r\n\r\n      try {\r\n      console.log('[useGoLiveFlow] Calling getUserMedia with video=true, audio=true')\r\n      const mediaStream = await navigator.mediaDevices.getUserMedia({\r\n        video: { facingMode: 'user' },\r\n        audio: {\r\n          echoCancellation: true,\r\n          noiseSuppression: true,\r\n          autoGainControl: true,\r\n        },\r\n      })\r\n\r\n      const videoTracks = mediaStream.getVideoTracks()\r\n      const audioTracks = mediaStream.getAudioTracks()\r\n      \r\n      console.log(`[useGoLiveFlow] ‚úÖ Permissions granted - video=${videoTracks.length} audio=${audioTracks.length}`)\r\n      \r\n      setLocalStream(mediaStream)\r\n      setPermissionState('granted')\r\n      return mediaStream\r\n    } catch (err: any) {\r\n      console.error('[useGoLiveFlow] ‚ùå Permission request failed:', err.name, err.message)\r\n      setPermissionState('denied')\r\n      setError('Camera/Microphone blocked. Please enable permissions and try again.')\r\n      return null\r\n    }\r\n  }, [])\r\n\r\n  const publishTracks = useCallback(\r\n    async (stream?: MediaStream) => {\r\n      const activeStream = stream ?? localStream\r\n      const currentRoom = roomRef.current\r\n      console.log(\r\n        `[useGoLiveFlow] publishTracks called - room=${!!currentRoom} stream=${!!activeStream} state=${connectionState}`\r\n      )\r\n\r\n      if (!currentRoom) {\r\n        const err = 'Room not connected'\r\n        console.error('[useGoLiveFlow]', err)\r\n        setError(err)\r\n        return false\r\n      }\r\n\r\n      if (!activeStream) {\r\n        const err = 'Camera and microphone not enabled'\r\n        console.error('[useGoLiveFlow]', err)\r\n        setError(err)\r\n        return false\r\n      }\r\n\r\n      const roomState = currentRoom.state\r\n      if (roomState !== ConnectionState.Connected) {\r\n        const err = `Not connected to room - roomState=${roomState} state=${connectionState}`\r\n        console.error('[useGoLiveFlow]', err)\r\n        setError(err)\r\n        return false\r\n      }\r\n\r\n      try {\r\n        setConnectionState('publishing')\r\n        console.log('[useGoLiveFlow] Starting track publishing...')\r\n\r\n        const videoTrack = activeStream.getVideoTracks()[0]\r\n        const audioTrack = activeStream.getAudioTracks()[0]\r\n\r\n        console.log(`[useGoLiveFlow] Available tracks - video=${!!videoTrack} audio=${!!audioTrack}`)\r\n\r\n        if (!videoTrack || !audioTrack) {\r\n          throw new Error('Missing video or audio track')\r\n        }\r\n\r\n        console.log('[useGoLiveFlow] Publishing video track...')\r\n        await currentRoom.localParticipant.publishTrack(videoTrack, {\r\n          name: 'camera',\r\n          source: Track.Source.Camera,\r\n        })\r\n\r\n        console.log('[useGoLiveFlow] Publishing audio track...')\r\n        console.log('[useGoLiveFlow] Audio Track Diagnostics:', {\r\n          readyState: audioTrack.readyState,\r\n          enabled: audioTrack.enabled,\r\n          muted: audioTrack.muted,\r\n          settings: audioTrack.getSettings()\r\n        });\r\n\r\n        await currentRoom.localParticipant.publishTrack(audioTrack, {\r\n          name: 'microphone',\r\n          source: Track.Source.Microphone,\r\n        })\r\n\r\n        localTracksRef.current = [videoTrack, audioTrack]\r\n\r\n        console.log(`[useGoLiveFlow] ‚úÖ Successfully published ${localTracksRef.current.length} tracks`)\r\n        setConnectionState('connected')\r\n\r\n        return true\r\n      } catch (err: any) {\r\n        console.error('[useGoLiveFlow] Track publish failed:', err.message || err)\r\n        setConnectionState('error')\r\n        setError(err.message || 'Failed to publish tracks')\r\n        return false\r\n      }\r\n  }, [roomRef, localStream, connectionState])\r\n\r\n  const initializeGoLive = useCallback(\r\n    async (config: StreamConfig) => {\r\n      console.log(`[useGoLiveFlow] initializeGoLive: category=${config.category} title=${config.title}`)\r\n      \r\n      try {\r\n        if (!profile?.is_broadcaster && !profile?.is_admin) {\r\n          const err = 'You are not approved to broadcast'\r\n          console.error('[useGoLiveFlow]', err)\r\n          setError(err)\r\n          return null\r\n        }\r\n\r\n        if (config.category === 'Officer Stream' && !profile?.is_troll_officer && !profile?.is_admin) {\r\n          const err = 'Only officers and admins can start officer streams'\r\n          console.error('[useGoLiveFlow]', err)\r\n          setError(err)\r\n          return null\r\n        }\r\n\r\n        console.log('[useGoLiveFlow] Creating stream record...')\r\n        const newStream = await createStreamRecord(config)\r\n        if (!newStream) {\r\n          console.error('[useGoLiveFlow] Failed to create stream')\r\n          return null\r\n        }\r\n\r\n        console.log(`[useGoLiveFlow] Stream created: ${newStream.id}`)\r\n\r\n        return newStream\r\n      } catch (err: any) {\r\n        console.error('[useGoLiveFlow] initializeGoLive error:', err.message || err)\r\n        setError(err.message || 'Failed to initialize go live')\r\n        return null\r\n      }\r\n    },\r\n    [profile, createStreamRecord]\r\n  )\r\n\r\n  const finishGoingLive = useCallback(async (streamIdOverride?: string) => {\r\n    const targetStreamId = streamIdOverride || stream?.id\r\n    console.log(`[useGoLiveFlow] finishGoingLive called - stream=${targetStreamId}`)\r\n    \r\n    if (!targetStreamId) {\r\n      const err = 'Stream not initialized'\r\n      console.error('[useGoLiveFlow]', err)\r\n      setError(err)\r\n      return false\r\n    }\r\n\r\n    try {\r\n\r\n      console.log('[useGoLiveFlow] Enabling camera and microphone via LiveKit...')\r\n      try {\r\n        if (roomRef.current?.localParticipant?.enableCameraAndMicrophone) {\r\n          await roomRef.current.localParticipant.enableCameraAndMicrophone()\r\n          console.log('[useGoLiveFlow] ‚úÖ Camera and microphone enabled via LiveKit')\r\n        } else {\r\n          console.log('[useGoLiveFlow] enableCameraAndMicrophone not available, publishing tracks manually...')\r\n          const publishSuccess = await publishTracks()\r\n          if (!publishSuccess) {\r\n            console.error('[useGoLiveFlow] Failed to publish tracks')\r\n            return false\r\n          }\r\n        }\r\n      } catch (enableErr: any) {\r\n        console.warn('[useGoLiveFlow] enableCameraAndMicrophone failed, trying manual publish:', enableErr.message)\r\n        const publishSuccess = await publishTracks()\r\n        if (!publishSuccess) {\r\n          console.error('[useGoLiveFlow] Manual track publishing also failed')\r\n          return false\r\n        }\r\n      }\r\n\r\n      const r = targetStreamId\r\n      console.log(`[useGoLiveFlow] Updating stream ${r} status to live...`)\r\n      const { error: updateError } = await supabase\r\n        .from('streams')\r\n        .update({\r\n          is_live: true,\r\n          status: 'live',\r\n          start_time: new Date().toISOString(),\r\n        })\r\n        .eq('id', r)\r\n\r\n      if (updateError) {\r\n        console.error('[useGoLiveFlow] Stream update failed:', updateError)\r\n        setError('Failed to update stream status')\r\n        return false\r\n      }\r\n\r\n      console.log(`[useGoLiveFlow] ‚úÖ Stream ${r} is now live`)\r\n            \r\n            // Auto-track family task: Host a Clan Stream\r\n            if (user?.id) {\r\n              supabase.rpc('track_family_event', { \r\n                p_user_id: user.id, \r\n                p_metric: 'streams_started', \r\n                p_increment: 1 \r\n              }).then(({ error }) => {\r\n                if (error) console.error('Error tracking family stream task:', error)\r\n              })\r\n            }\r\n\r\n            toast.success('You are live!')\r\n      return true\r\n    } catch (err: any) {\r\n      console.error('[useGoLiveFlow] finishGoingLive error:', err.message || err)\r\n      setError(err.message || 'Failed to finish going live')\r\n      return false\r\n    }\r\n  }, [stream, publishTracks])\r\n\r\n  const disconnect = useCallback(() => {\r\n    localTracksRef.current.forEach((track) => track.stop?.())\r\n    localTracksRef.current = []\r\n    localStream?.getTracks().forEach((track) => track.stop())\r\n    setLocalStream(null)\r\n    roomRef.current?.disconnect()\r\n    roomRef.current = null\r\n    setRoom(null)\r\n    setConnectionState('idle')\r\n    console.log('[useGoLiveFlow] Disconnected')\r\n  }, [localStream])\r\n\r\n  return {\r\n    stream,\r\n    room,\r\n    connectionState,\r\n    permissionState,\r\n    localStream,\r\n    error,\r\n    createStreamRecord,\r\n    getToken,\r\n    connectToRoom,\r\n    requestPermissions,\r\n    publishTracks,\r\n    initializeGoLive,\r\n    finishGoingLive,\r\n    disconnect,\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useInsurance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useLiveKit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useLiveKitRoom.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useLiveKitSession.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useLiveKitToken.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useLiveSettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useMediaStream.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useOfficerBroadcastTracking.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useOfficerStreamTracking.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\usePerks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useProfileViewPayment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\usePurchases.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useQueries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useRoom.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useRoomParticipants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useSafeLiveKit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useSeatRoster.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useSidebarUpdates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useStreamEndListener.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useStreamStats.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useTheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useUnifiedLiveKit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useUserLevels.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\hooks\\useViewerTracking.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\LiveKitConfig.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\LiveKitService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\adminCoins.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\adminEconomy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\adminRoles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\aiTasks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\appEvents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\appSettingsStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\badges\\mergeBadges.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\badges\\mergeBadges.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\battleHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\birthdayUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\chatStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\coinMath.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\coinRotation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\coinTransactions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\coinUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\courtAi.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\courtSessions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\courtSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\downloads.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\economy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\eligibilityStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\endStream.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\entranceAnimations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\entranceEffects.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\familySeasons.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\familyTasks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\familyWars.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\fetchApplications.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\giftCatalog.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\giftEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\giftIcons.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\gifts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\glowingUsernameSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\holidayThemes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useAllCreditScores.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useAvatar.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useBadges.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useBank.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useBroadcastLockdown.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MaxBroadcastersSettings' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\nimport { supabase } from '../supabase';\nimport { useAuthStore } from '../store';\nimport { toast } from 'sonner';\n\ninterface BroadcastLockdownSettings {\n  enabled: boolean;\n  admin_broadcast_room: string | null;\n}\n\ninterface MaxBroadcastersSettings {\n  limit: number;\n}\n\nexport function useBroadcastLockdown() {\n  const { profile } = useAuthStore();\n  const [settings, setSettings] = useState<BroadcastLockdownSettings>({\n    enabled: false,\n    admin_broadcast_room: null\n  });\n  const [maxBroadcasters, setMaxBroadcasters] = useState<number>(100);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  // Load settings\n  useEffect(() => {\n    const loadSettings = async () => {\n      try {\n        // Load lockdown settings\n        const { data: lockdownData, error: lockdownError } = await supabase\n          .from('admin_settings')\n          .select('setting_value')\n          .eq('setting_key', 'broadcast_lockdown_enabled')\n          .maybeSingle();\n\n        if (lockdownError) throw lockdownError;\n        \n        if (lockdownData?.setting_value) {\n          setSettings(lockdownData.setting_value);\n        }\n\n        // Load max broadcasters\n        const { data: limitData, error: limitError } = await supabase\n          .from('admin_settings')\n          .select('setting_value')\n          .eq('setting_key', 'max_broadcasters')\n          .maybeSingle();\n\n        if (limitError && limitError.code !== 'PGRST116') throw limitError;\n\n        if (limitData?.setting_value?.limit) {\n          setMaxBroadcasters(limitData.setting_value.limit);\n        }\n\n      } catch (err: any) {\n        console.error('Failed to load broadcast settings:', err);\n        setError(err.message);\n      }\n    };\n\n    loadSettings();\n\n    // Subscribe to changes using realtime\n    const subscription = supabase\n      .channel('admin_settings_changes')\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'admin_settings'\n        },\n        (payload) => {\n          if (payload.new?.setting_key === 'broadcast_lockdown_enabled') {\n            setSettings(payload.new.setting_value);\n          }\n          if (payload.new?.setting_key === 'max_broadcasters') {\n            setMaxBroadcasters(payload.new.setting_value.limit);\n          }\n        }\n      )\n      .subscribe();\n\n    return () => {\n      subscription.unsubscribe();\n    };\n  }, []);\n\n  // Update lockdown settings (admin only)\n  const updateSettings = async (newSettings: BroadcastLockdownSettings) => {\n    if (!profile?.is_admin && profile?.role !== 'admin') {\n      toast.error('Only admins can change broadcast settings');\n      return false;\n    }\n\n    setLoading(true);\n    try {\n      const { error: updateError } = await supabase\n        .from('admin_settings')\n        .update({\n          setting_value: newSettings,\n          updated_at: new Date().toISOString()\n        })\n        .eq('setting_key', 'broadcast_lockdown_enabled');\n\n      if (updateError) throw updateError;\n\n      setSettings(newSettings);\n      toast.success('Broadcast settings updated');\n      return true;\n    } catch (err: any) {\n      console.error('Failed to update broadcast lockdown settings:', err);\n      toast.error('Failed to update settings: ' + err.message);\n      return false;\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Update max broadcasters (admin only)\n  const updateMaxBroadcasters = async (limit: number) => {\n    if (!profile?.is_admin && profile?.role !== 'admin') {\n      toast.error('Only admins can change broadcast settings');\n      return false;\n    }\n\n    setLoading(true);\n    try {\n      // Upsert the setting\n      const { error: updateError } = await supabase\n        .from('admin_settings')\n        .upsert({\n          setting_key: 'max_broadcasters',\n          setting_value: { limit },\n          description: 'Maximum number of authorized broadcasters',\n          updated_at: new Date().toISOString()\n        }, { onConflict: 'setting_key' });\n\n      if (updateError) throw updateError;\n\n      setMaxBroadcasters(limit);\n      toast.success('Max broadcasters limit updated');\n      return true;\n    } catch (err: any) {\n      console.error('Failed to update max broadcasters:', err);\n      toast.error('Failed to update limit: ' + err.message);\n      return false;\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Check if current user can broadcast (RPC check)\n  const checkEligibility = async (): Promise<{ allowed: boolean; reason?: string }> => {\n    try {\n      // 1. Check RPC first for hard logic\n      const { data: allowed, error } = await supabase.rpc('can_start_broadcast');\n      if (error) throw error;\n\n      if (allowed) return { allowed: true };\n\n      // If not allowed, determine why (client side estimation or specific RPC)\n      // For now, we can guess based on flags or just say \"Not authorized\"\n      // But we can check badge status explicitly if we want to be helpful\n      if (!profile) return { allowed: false, reason: 'Not logged in' };\n\n      // Check badge\n      if (!profile.is_admin && profile.role !== 'admin') {\n         // Refresh profile to get latest flags?\n         const { data: user } = await supabase\n            .from('user_profiles')\n            .select('is_broadcast_locked, has_broadcast_badge')\n            .eq('id', profile.id)\n            .single();\n         \n         if (user?.is_broadcast_locked) return { allowed: false, reason: 'Your broadcasting privileges are locked.' };\n         if (settings.enabled) return { allowed: false, reason: 'Global broadcast lockdown is active.' };\n         if (!user?.has_broadcast_badge) return { allowed: false, reason: 'You do not have a Broadcast Badge. Slots may be full.' };\n      }\n\n      return { allowed: false, reason: 'Not authorized to broadcast.' };\n    } catch (err: any) {\n      console.error('Eligibility check failed:', err);\n      return { allowed: false, reason: err.message };\n    }\n  };\n\n  // Attempt to claim a badge\n  const attemptGrantBadge = async (): Promise<{ success: boolean; message: string }> => {\n    try {\n      const { data, error } = await supabase.rpc('ensure_broadcaster_badge');\n      if (error) throw error;\n      return data as { success: boolean; message: string };\n    } catch (err: any) {\n      return { success: false, message: err.message };\n    }\n  };\n\n  return {\n    settings,\n    maxBroadcasters,\n    loading,\n    error,\n    updateSettings,\n    updateMaxBroadcasters,\n    checkEligibility,\n    attemptGrantBadge\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useCity3DDataLoader.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useCoins.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useCreditScore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useDailyLoginPost.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toast' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"toast"},"fix":{"range":[167,197],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DailyLoginPostReward' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'refreshCoins' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":21,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":22,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'postId' is defined but never used. Allowed unused args must match /^_/u.","line":66,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback } from 'react'\r\nimport { supabase } from '../supabase'\r\nimport { useAuthStore } from '../store'\r\nimport { useCoins } from './useCoins'\r\nimport { toast } from 'sonner'\r\n\r\ninterface DailyLoginPostReward {\r\n  success: boolean\r\n  coinsEarned: number\r\n  message: string\r\n  canPostToday: boolean\r\n  lastPostDate?: string\r\n}\r\n\r\n/**\r\n * Hook for managing daily login wall posts with coin rewards\r\n * Users can post once per day to earn random coins (0-100)\r\n */\r\nexport function useDailyLoginPost() {\r\n  const { user } = useAuthStore()\r\n  const { refreshCoins } = useCoins()\r\n  const [loading, setLoading] = useState(false)\r\n  const [canPostToday, setCanPostToday] = useState(true)\r\n  const [lastPostDate, setLastPostDate] = useState<string | null>(null)\r\n\r\n  // Check if user has already posted today\r\n  const checkDailyPostStatus = useCallback(async () => {\r\n    if (!user?.id) return\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('daily_login_posts')\r\n        .select('posted_at')\r\n        .eq('user_id', user.id)\r\n        .gte('posted_at', new Date(new Date().setHours(0, 0, 0, 0)).toISOString())\r\n        .lte('posted_at', new Date(new Date().setHours(23, 59, 59, 999)).toISOString())\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      if (error && error.code !== 'PGRST116') {\r\n        console.error('Error checking daily post status:', error)\r\n        return\r\n      }\r\n\r\n      // If there's a record from today, user cannot post\r\n      if (data) {\r\n        setCanPostToday(false)\r\n        setLastPostDate(data.posted_at)\r\n      } else {\r\n        setCanPostToday(true)\r\n        setLastPostDate(null)\r\n      }\r\n    } catch (err) {\r\n      console.error('Error checking daily post status:', err)\r\n      setCanPostToday(true)\r\n    }\r\n  }, [user?.id])\r\n\r\n  // Generate random coin reward (0-100)\r\n  const generateRandomReward = useCallback(() => {\r\n    return Math.floor(Math.random() * 101) // 0-100 inclusive\r\n  }, [])\r\n\r\n\r\n  // No-op for submitDailyPost, just for compatibility\r\n  const submitDailyPost = useCallback(async (postId: string) => ({\r\n    success: true,\r\n    coinsEarned: 0,\r\n    message: 'Posted',\r\n    canPostToday: false,\r\n    lastPostDate: new Date().toISOString(),\r\n  }), [])\r\n\r\n  return {\r\n    loading,\r\n    canPostToday,\r\n    lastPostDate,\r\n    checkDailyPostStatus,\r\n    submitDailyPost,\r\n    generateRandomReward,\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useGiftEvents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useGiftSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useStreamEarnings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useStreamMomentum.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useXPSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\hooks\\useXPTracking.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\insuranceSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\leadActions.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\leaderboards.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\levelStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\levelsConfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\liveContextStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\liveUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\livekit-debug.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\livekit-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\maiEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\mobilePlatform.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\ntfyNotify.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\ntfySubscribe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\officerActivity.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\officerOWC.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\officerPay.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\officerPayrollPDF.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payments\\CashAppProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payments\\PayPalButtonShim.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payments\\PayPalProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payments\\PaymentProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payments\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payoutConfig.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\payoutWindow.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\perkEffects.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\perkSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\permissions.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\profileViewPayment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\progressionEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\purchaseGate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\purchaseSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\purchases.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\roles.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\roomManager.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\sendNotification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\sessionUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\stores\\cityScene3D.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\streamUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\telemetry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\test-promise.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\themeContext.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":50,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":50,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\tierSystem.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused args must match /^_/u.","line":36,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused args must match /^_/u.","line":63,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":63,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// XP-based tier system for Troll City\r\n\r\nexport interface TierInfo {\r\n  level: number\r\n  minXP: number\r\n  maxXP: number\r\n  title: string\r\n  perks: string[]\r\n}\r\n\r\nexport const TIER_LEVELS: TierInfo[] = [\r\n  { level: 1, minXP: 0, maxXP: 4999, title: \"Dusty Baby Troll\", perks: [\"Basic chat access\", \"default badge\"] },\r\n  { level: 5, minXP: 5000, maxXP: 9999, title: \"Meme Spark Starter\", perks: [\"Free coin spins\", \"emoji reactions\"] },\r\n  { level: 10, minXP: 10000, maxXP: 19999, title: \"Chaos Hatchling\", perks: [\"Animated profile frame\", \"small entrance effects\"] },\r\n  { level: 20, minXP: 20000, maxXP: 29999, title: \"Glitched Gremlin\", perks: [\"Gift sending\", \"basic streamer eligibility\"] },\r\n  { level: 30, minXP: 30000, maxXP: 39999, title: \"Digital Menace\", perks: [\"Profile themes\", \"custom titles\", \"streamer boosting\"] },\r\n  { level: 40, minXP: 40000, maxXP: 49999, title: \"Neon Mayhem Freak\", perks: [\"VIP applause animation\", \"advanced entrance effects\"] },\r\n  { level: 50, minXP: 50000, maxXP: 59999, title: \"Coin-Devouring Goblin\", perks: [\"Live streaming upgrades\", \"coin multiplier\", \"small revenue share\"] },\r\n  { level: 60, minXP: 60000, maxXP: 69999, title: \"Carnival Hexcaster\", perks: [\"Special animated entrance\", \"priority support\", \"creator tools\"] },\r\n  { level: 70, minXP: 70000, maxXP: 79999, title: \"Royal Crowned Mischief\", perks: [\"Diamond profile frame\", \"premium gifts\", \"priority in stream lists\"] },\r\n  { level: 80, minXP: 80000, maxXP: 89999, title: \"Neon God of Trollers\", perks: [\"Troll-themed blast effects\", \"leaderboard eligibility\"] },\r\n  { level: 90, minXP: 90000, maxXP: 99999, title: \"Immortal Viral Phantom\", perks: [\"Neon animated avatar ring\", \"super gifts\", \"streamer enhancements\"] },\r\n  { level: 100, minXP: 100000, maxXP: 100999, title: \"Eternal Original (OG) Troll Overlord üëë\", perks: [\"OG Crown\", \"OG Badge\", \"animated wings\", \"platform influencer\", \"staff eligibility\"] },\r\n  { level: 101, minXP: 101000, maxXP: Infinity, title: \"Admin Overlord üëë\", perks: [\"All perks\", \"Admin powers\", \"Infinite coins\", \"Platform control\"] },\r\n]\r\n\r\nexport function getTierFromXP(xp: number): TierInfo {\r\n  for (let i = TIER_LEVELS.length - 1; i >= 0; i--) {\r\n    if (xp >= TIER_LEVELS[i].minXP) {\r\n      return TIER_LEVELS[i]\r\n    }\r\n  }\r\n  return TIER_LEVELS[0]\r\n}\r\n\r\nexport function getLevelFromXP(xp: number, isAdmin: boolean = false): number {\r\n  // Use the standard formula matching SQL calculate_level_details\r\n  // Levels 1-50: 100 * 1.1^(L-1)\r\n  // Levels 50+: 10000 flat per level\r\n  \r\n  let curr_lvl = 1;\r\n  let xp_accum = 0;\r\n  let xp_needed = 100;\r\n  \r\n  while (true) {\r\n    if (curr_lvl < 50) {\r\n      xp_needed = Math.floor(100 * Math.pow(1.1, curr_lvl - 1));\r\n    } else {\r\n      xp_needed = 10000;\r\n    }\r\n\r\n    if (xp < (xp_accum + xp_needed)) {\r\n      return curr_lvl;\r\n    }\r\n\r\n    xp_accum += xp_needed;\r\n    curr_lvl++;\r\n    // Safety break for extremely high XP (e.g. level 10000+)\r\n    if (curr_lvl >= 20000) return curr_lvl;\r\n  }\r\n}\r\n\r\nexport function getXPForNextLevel(currentXp: number, isAdmin: boolean = false): { current: number; needed: number; percentage: number } {\r\n  let curr_lvl = 1;\r\n  let xp_accum = 0;\r\n  let xp_needed = 100;\r\n  \r\n  // Re-run the loop to find current level state\r\n  while (true) {\r\n    if (curr_lvl < 50) {\r\n      xp_needed = Math.floor(100 * Math.pow(1.1, curr_lvl - 1));\r\n    } else {\r\n      xp_needed = 10000;\r\n    }\r\n\r\n    if (currentXp < (xp_accum + xp_needed)) {\r\n      // Found current level\r\n      const xpInLevel = currentXp - xp_accum;\r\n      const percentage = (xpInLevel / xp_needed) * 100;\r\n      return {\r\n        current: currentXp,\r\n        needed: xp_needed - xpInLevel,\r\n        percentage: Math.min(Math.max(percentage, 0), 100)\r\n      };\r\n    }\r\n\r\n    xp_accum += xp_needed;\r\n    curr_lvl++;\r\n    if (curr_lvl >= 20000) {\r\n        return { current: currentXp, needed: 0, percentage: 100 };\r\n    }\r\n  }\r\n}\r\n\r\nexport function getProgressToNextLevel(currentXP: number): number {\r\n  const { percentage } = getXPForNextLevel(currentXP)\r\n  return percentage\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\translation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\trollDropUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\vip.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\weatherService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\weeklyTasks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\lib\\xp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AIVerificationPage.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":30,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1227,1251],"text":"You&apos;re Already Verified!"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1227,1251],"text":"You&lsquo;re Already Verified!"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1227,1251],"text":"You&#39;re Already Verified!"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1227,1251],"text":"You&rsquo;re Already Verified!"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { CheckCircle, Shield } from 'lucide-react'\r\n\r\nexport default function AIVerificationPage() {\r\n  const { user, profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"mb-4\">Please log in to get verified</p>\r\n          <button\r\n            onClick={() => navigate('/auth')}\r\n            className=\"px-4 py-2 bg-purple-600 rounded-lg\"\r\n          >\r\n            Log In\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n  if (profile?.is_verified) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"max-w-lg mx-auto bg-[#1A1A1A] border-2 border-green-500/30 rounded-xl p-8 text-center\">\r\n          <CheckCircle className=\"w-16 h-16 text-green-400 mx-auto mb-4\" />\r\n          <h1 className=\"text-2xl font-bold mb-2\">You're Already Verified!</h1>\r\n          <button\r\n            onClick={() => navigate('/')}\r\n            className=\"px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg mt-4\"\r\n          >\r\n            Go Home\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center p-6\">\r\n      <div className=\"max-w-lg mx-auto bg-[#1A1A1A] border-2 border-purple-500/30 rounded-xl p-8\">\r\n        <div className=\"flex items-center gap-3 mb-4\">\r\n          <Shield className=\"w-8 h-8 text-purple-400\" />\r\n          <h1 className=\"text-3xl font-bold\">Verification</h1>\r\n        </div>\r\n        <p className=\"opacity-80 mb-6\">\r\n          ID verification is now handled by our standard verification flow. AI-based ID checks are no longer required.\r\n        </p>\r\n        <div className=\"space-y-3\">\r\n          <button\r\n            onClick={() => navigate('/verification')}\r\n            className=\"w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold\"\r\n          >\r\n            Go to Verification\r\n          </button>\r\n          <button\r\n            onClick={() => navigate('/profile/setup')}\r\n            className=\"w-full px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg font-semibold border border-purple-500/60\"\r\n          >\r\n            Manage ID in Profile Setup\r\n          </button>\r\n          <button\r\n            onClick={() => navigate('/')}\r\n            className=\"w-full px-6 py-3 bg-transparent hover:bg-white/5 rounded-lg font-semibold border border-white/20\"\r\n          >\r\n            Go Home\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AccessDenied.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":15,"column":20,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[624,696],"text":"\r\n            You don&apos;t have permission to access this page.\r\n          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[624,696],"text":"\r\n            You don&lsquo;t have permission to access this page.\r\n          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[624,696],"text":"\r\n            You don&#39;t have permission to access this page.\r\n          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[624,696],"text":"\r\n            You don&rsquo;t have permission to access this page.\r\n          "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { Lock, ArrowLeft } from 'lucide-react';\r\n\r\nconst AccessDenied: React.FC = () => {\r\n  const navigate = useNavigate();\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center p-6\">\r\n      <div className=\"max-w-md mx-auto text-center\">\r\n        <div className=\"mb-6\">\r\n          <Lock className=\"w-16 h-16 text-red-500 mx-auto mb-4\" />\r\n          <h1 className=\"text-3xl font-bold mb-2\">Access Denied</h1>\r\n          <p className=\"text-gray-400\">\r\n            You don't have permission to access this page.\r\n          </p>\r\n        </div>\r\n\r\n        <button\r\n          onClick={() => navigate('/')}\r\n          className=\"inline-flex items-center px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors\"\r\n        >\r\n          <ArrowLeft className=\"w-5 h-5 mr-2\" />\r\n          Go Home\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AccessDenied;","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AccountPaymentLinkedSuccess.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AccountPaymentsSuccess.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AdminInterviewDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[239,249],"text":""},"desc":"Remove unused variable \"Calendar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FileText"},"fix":{"range":[256,266],"text":""},"desc":"Remove unused variable \"FileText\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XCircle"},"fix":{"range":[279,292],"text":""},"desc":"Remove unused variable \"XCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertCircle"},"fix":{"range":[292,305],"text":""},"desc":"Remove unused variable \"AlertCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MessageSquare' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MessageSquare"},"fix":{"range":[312,327],"text":""},"desc":"Remove unused variable \"MessageSquare\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profile' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":25,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showCreateModal' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":28,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowCreateModal' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":28,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":45},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":226,"column":21,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[8988,9074],"text":"\r\n              Click &quot;Create Test Interview\" to set up a fake interview\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[8988,9074],"text":"\r\n              Click &ldquo;Create Test Interview\" to set up a fake interview\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[8988,9074],"text":"\r\n              Click &#34;Create Test Interview\" to set up a fake interview\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[8988,9074],"text":"\r\n              Click &rdquo;Create Test Interview\" to set up a fake interview\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":226,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[8988,9074],"text":"\r\n              Click \"Create Test Interview&quot; to set up a fake interview\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[8988,9074],"text":"\r\n              Click \"Create Test Interview&ldquo; to set up a fake interview\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[8988,9074],"text":"\r\n              Click \"Create Test Interview&#34; to set up a fake interview\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[8988,9074],"text":"\r\n              Click \"Create Test Interview&rdquo; to set up a fake interview\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":230,"column":21,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9199,9280],"text":"\r\n              Click &quot;Start Interview\" to enter the interview room\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9199,9280],"text":"\r\n              Click &ldquo;Start Interview\" to enter the interview room\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9199,9280],"text":"\r\n              Click &#34;Start Interview\" to enter the interview room\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9199,9280],"text":"\r\n              Click &rdquo;Start Interview\" to enter the interview room\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":230,"column":37,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9199,9280],"text":"\r\n              Click \"Start Interview&quot; to enter the interview room\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9199,9280],"text":"\r\n              Click \"Start Interview&ldquo; to enter the interview room\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9199,9280],"text":"\r\n              Click \"Start Interview&#34; to enter the interview room\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9199,9280],"text":"\r\n              Click \"Start Interview&rdquo; to enter the interview room\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":234,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle &quot;Test Mode\" to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle &ldquo;Test Mode\" to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle &#34;Test Mode\" to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle &rdquo;Test Mode\" to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":234,"column":32,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle \"Test Mode&quot; to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle \"Test Mode&ldquo; to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle \"Test Mode&#34; to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9405,9497],"text":"\r\n              Toggle \"Test Mode&rdquo; to see fake avatars instead of camera feeds\r\n            "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { \r\n  Video, Calendar, Clock, FileText, CheckCircle, \r\n  XCircle, AlertCircle, Users, MessageSquare, Play\r\n} from 'lucide-react'\r\n\r\ninterface InterviewSession {\r\n  id: string\r\n  application_id: string\r\n  user_id: string\r\n  interviewer_id: string\r\n  scheduled_at: string\r\n  status: 'scheduled' | 'in_progress' | 'completed' | 'cancelled'\r\n  notes: string\r\n  applicant_name: string\r\n  applicant_username: string\r\n}\r\n\r\nexport default function AdminInterviewDashboard() {\r\n  const navigate = useNavigate()\r\n  const { profile, user } = useAuthStore()\r\n  const [loading, setLoading] = useState(true)\r\n  const [interviews, setInterviews] = useState<InterviewSession[]>([])\r\n  const [showCreateModal, setShowCreateModal] = useState(false)\r\n\r\n  useEffect(() => {\r\n    fetchInterviews()\r\n  }, [])\r\n\r\n  const fetchInterviews = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('interview_sessions')\r\n        .select('*')\r\n        .in('status', ['active', 'completed'])\r\n        .order('scheduled_at', { ascending: true })\r\n\r\n      if (error) throw error\r\n\r\n      // Get user profiles for each interview\r\n      const userIds = [...new Set(data.map((i: any) => i.user_id))]\r\n      const { data: profiles } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, full_name')\r\n        .in('id', userIds)\r\n\r\n      const profileMap = new Map(profiles?.map((p: any) => [p.id, p]) || [])\r\n\r\n      const formattedInterviews = data.map((interview: any) => {\r\n        const profile = profileMap.get(interview.user_id)\r\n        return {\r\n          ...interview,\r\n          applicant_name: profile?.full_name || profile?.username || 'Unknown',\r\n          applicant_username: profile?.username || 'unknown'\r\n        }\r\n      })\r\n\r\n      setInterviews(formattedInterviews)\r\n    } catch (error) {\r\n      console.error('Error fetching interviews:', error)\r\n      toast.error('Failed to load interviews')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const createFakeInterview = async () => {\r\n    if (!user) return\r\n\r\n    try {\r\n      // Create fake application\r\n      const { data: application, error: appError } = await supabase\r\n        .from('applications')\r\n        .insert({\r\n          user_id: user.id,\r\n          type: 'troll_officer',\r\n          status: 'approved',\r\n          experience: 'Test applicant for demo',\r\n          motivation: 'I want to help moderate!',\r\n          availability: 'Full time',\r\n          skills: ['Communication'],\r\n          created_at: new Date().toISOString(),\r\n          reviewed_at: new Date().toISOString(),\r\n          reviewed_by: user.id\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (appError) throw appError\r\n\r\n      // Create fake interview session\r\n      const { data: interview, error: interviewError } = await supabase\r\n        .from('interview_sessions')\r\n        .insert({\r\n          application_id: application.id,\r\n          user_id: user.id,\r\n          interviewer_id: user.id,\r\n          scheduled_at: new Date().toISOString(),\r\n          status: 'active',\r\n          notes: 'üé≠ Test interview session for demo purposes'\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (interviewError) throw interviewError\r\n\r\n      toast.success('Fake interview created!')\r\n      navigate(`/interview/${interview.id}`)\r\n    } catch (error: any) {\r\n      console.error('Error creating fake interview:', error)\r\n      toast.error(error.message || 'Failed to create fake interview')\r\n    }\r\n  }\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    const colors: Record<string, string> = {\r\n      active: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30',\r\n      completed: 'bg-gray-500/20 text-gray-400 border border-gray-500/30',\r\n      hired: 'bg-green-500/20 text-green-400 border border-green-500/30',\r\n      rejected: 'bg-red-500/20 text-red-400 border border-red-500/30',\r\n    }\r\n    return colors[status] || colors.active\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-400\">Loading admin dashboard...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] p-6\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-6 mb-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-4\">\r\n              <div className=\"p-3 bg-purple-500/20 rounded-lg\">\r\n                <Video className=\"w-8 h-8 text-purple-400\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-2xl font-bold text-white\">Admin Interview Dashboard</h1>\r\n                <p className=\"text-gray-400\">Manage and test interview sessions</p>\r\n              </div>\r\n            </div>\r\n            \r\n            <button\r\n              onClick={createFakeInterview}\r\n              className=\"px-6 py-3 bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-lg font-bold hover:shadow-lg hover:shadow-cyan-500/30 transition-all flex items-center gap-2\"\r\n            >\r\n              <Play className=\"w-5 h-5\" />\r\n              Create Test Interview\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Scheduled Interviews */}\r\n        <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] overflow-hidden\">\r\n          <div className=\"p-6 border-b border-[#2C2C2C]\">\r\n            <h2 className=\"text-lg font-semibold text-white\">Scheduled Interviews</h2>\r\n            <p className=\"text-gray-400 text-sm\">{interviews.length} interview(s)</p>\r\n          </div>\r\n\r\n          {interviews.length === 0 ? (\r\n            <div className=\"p-12 text-center\">\r\n              <Users className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\r\n              <h3 className=\"text-xl font-bold text-white mb-2\">No Interviews Scheduled</h3>\r\n              <p className=\"text-gray-400 mb-6\">Create a test interview to get started</p>\r\n              <button\r\n                onClick={createFakeInterview}\r\n                className=\"px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-medium transition-colors\"\r\n              >\r\n                Create Test Interview\r\n              </button>\r\n            </div>\r\n          ) : (\r\n            <div className=\"divide-y divide-[#2C2C2C]\">\r\n              {interviews.map((interview) => (\r\n                <div key={interview.id} className=\"p-6 flex items-center justify-between hover:bg-[#252525] transition-colors\">\r\n                  <div className=\"flex items-center gap-4\">\r\n                    <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center\">\r\n                      <Users className=\"w-6 h-6 text-white\" />\r\n                    </div>\r\n                    <div>\r\n                      <h4 className=\"font-semibold text-white\">{interview.applicant_name}</h4>\r\n                      <p className=\"text-gray-400 text-sm flex items-center gap-2\">\r\n                        <Clock className=\"w-4 h-4\" />\r\n                        {new Date(interview.scheduled_at).toLocaleString()}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div className=\"flex items-center gap-4\">\r\n                    <span className={`px-3 py-1 rounded-lg text-sm font-medium ${getStatusBadge(interview.status)}`}>\r\n                      {interview.status === 'in_progress' ? 'Live' : interview.status}\r\n                    </span>\r\n                    <button\r\n                      onClick={() => navigate(`/interview/${interview.id}`)}\r\n                      className=\"px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg text-sm transition-colors flex items-center gap-2\"\r\n                    >\r\n                      <Video className=\"w-4 h-4\" />\r\n                      {interview.status === 'scheduled' ? 'Start Interview' : 'Rejoin'}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Instructions */}\r\n        <div className=\"mt-6 bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-6\">\r\n          <h3 className=\"text-lg font-semibold text-white mb-4\">üé≠ Test Mode Instructions</h3>\r\n          <ul className=\"space-y-2 text-gray-400\">\r\n            <li className=\"flex items-center gap-2\">\r\n              <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n              Click \"Create Test Interview\" to set up a fake interview\r\n            </li>\r\n            <li className=\"flex items-center gap-2\">\r\n              <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n              Click \"Start Interview\" to enter the interview room\r\n            </li>\r\n            <li className=\"flex items-center gap-2\">\r\n              <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n              Toggle \"Test Mode\" to see fake avatars instead of camera feeds\r\n            </li>\r\n            <li className=\"flex items-center gap-2\">\r\n              <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n              The fake avatar shows an animated character with a unique identity\r\n            </li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Application.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":209,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7944,8009],"text":"‚Ä¢ You&apos;ll receive a notification when your application is reviewed"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7944,8009],"text":"‚Ä¢ You&lsquo;ll receive a notification when your application is reviewed"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7944,8009],"text":"‚Ä¢ You&#39;ll receive a notification when your application is reviewed"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7944,8009],"text":"‚Ä¢ You&rsquo;ll receive a notification when your application is reviewed"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { Shield, Users, Skull, Crown, Store, CheckCircle, XCircle, BookOpen } from 'lucide-react'\r\n\r\ntype ApplicationType = 'troll_officer' | 'troll_family' | 'troller' | 'lead_officer' | 'seller' | 'pastor' | null\r\n\r\nexport default function Application() {\r\n  const { user, profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/auth')\r\n      return\r\n    }\r\n  }, [user, navigate])\r\n\r\n  const handleApplication = async (type: ApplicationType) => {\r\n    if (!user || !type) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      // Check if user already has this role\r\n      if (type === 'troll_officer' && (profile?.is_troll_officer || profile?.role === 'troll_officer')) {\r\n        toast.error('You are already a Troll Officer')\r\n        return\r\n      }\r\n\r\n      if (type === 'lead_officer' && profile?.is_lead_officer) {\r\n        toast.error('You are already a Lead Officer')\r\n        return\r\n      }\r\n\r\n      // Navigate to specific application page\r\n      if (type === 'troll_officer') {\r\n        navigate('/apply/officer')\r\n      } else if (type === 'troll_family') {\r\n        navigate('/apply/family')\r\n      } else if (type === 'troller') {\r\n        navigate('/apply/troller')\r\n      } else if (type === 'lead_officer') {\r\n        // Navigate to lead officer application page (if exists) or show form\r\n        navigate('/apply/lead-officer')\r\n      } else if (type === 'pastor') {\r\n        navigate('/apply/pastor')\r\n      } else if (type === 'seller') {\r\n        // Navigate to seller application - go to sell page\r\n        navigate('/sell')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error starting application:', error)\r\n      toast.error('Failed to start application')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"mb-4\">Please log in to apply</p>\r\n          <button\r\n            onClick={() => navigate('/auth')}\r\n            className=\"px-4 py-2 bg-purple-600 rounded-lg\"\r\n          >\r\n            Log In\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const applicationTypes = [\r\n    {\r\n      type: 'troll_officer' as ApplicationType,\r\n      title: 'Troll Officer',\r\n      icon: Shield,\r\n      description: 'Moderate streams, enforce rules, and keep Troll City safe',\r\n      color: 'purple',\r\n      disabled: profile?.is_troll_officer || profile?.role === 'troll_officer',\r\n      disabledText: 'You are already a Troll Officer'\r\n    },\r\n    {\r\n      type: 'troll_family' as ApplicationType,\r\n      title: 'Troll Family',\r\n      icon: Users,\r\n      description: 'Join or create a family, participate in family wars',\r\n      color: 'blue',\r\n      disabled: profile?.role === 'troll_family',\r\n      disabledText: 'You are already in a family'\r\n    },\r\n    {\r\n      type: 'troller' as ApplicationType,\r\n      title: 'Troller',\r\n      icon: Skull,\r\n      description: 'Become a certified troller with special privileges',\r\n      color: 'red',\r\n      disabled: profile?.is_troller || profile?.role === 'troller',\r\n      disabledText: 'You are already a Troller'\r\n    },\r\n    {\r\n      type: 'lead_officer' as ApplicationType,\r\n      title: 'Lead Officer',\r\n      icon: Crown,\r\n      description: 'Lead and manage Troll Officers',\r\n      color: 'yellow',\r\n      disabled: profile?.is_lead_officer,\r\n      disabledText: 'You are already a Lead Officer'\r\n    },\r\n    {\r\n      type: 'pastor' as ApplicationType,\r\n      title: 'Pastor',\r\n      icon: BookOpen,\r\n      description: 'Lead the Troll Church and host Sunday Services',\r\n      color: 'purple',\r\n      disabled: profile?.is_pastor,\r\n      disabledText: 'You are already a Pastor'\r\n    },\r\n    {\r\n      type: 'seller' as ApplicationType,\r\n      title: 'Sell on Troll City',\r\n      icon: Store,\r\n      description: 'Create a shop and sell items to other users',\r\n      color: 'green',\r\n      disabled: false,\r\n      disabledText: ''\r\n    }\r\n  ]\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        <div className=\"text-center mb-8\">\r\n          <h1 className=\"text-4xl font-bold mb-2\">Apply for Roles</h1>\r\n          <p className=\"text-gray-400\">Choose a role to apply for in Troll City</p>\r\n        </div>\r\n\r\n        <div className=\"grid md:grid-cols-2 gap-6\">\r\n          {applicationTypes.map((app) => {\r\n            const Icon = app.icon\r\n            const isDisabled = app.disabled || loading\r\n            const colorClasses = {\r\n              purple: 'border-purple-600 bg-purple-900/20',\r\n              blue: 'border-blue-600 bg-blue-900/20',\r\n              red: 'border-red-600 bg-red-900/20',\r\n              yellow: 'border-yellow-600 bg-yellow-900/20',\r\n              green: 'border-green-600 bg-green-900/20'\r\n            }\r\n\r\n            return (\r\n              <div\r\n                key={app.type}\r\n                className={`rounded-xl border-2 p-6 transition-all ${\r\n                  isDisabled\r\n                    ? 'opacity-50 cursor-not-allowed'\r\n                    : 'hover:scale-105 cursor-pointer hover:shadow-lg'\r\n                } ${colorClasses[app.color as keyof typeof colorClasses]}`}\r\n                onClick={() => !isDisabled && handleApplication(app.type)}\r\n              >\r\n                <div className=\"flex items-center gap-4 mb-4\">\r\n                  <div className={`p-3 rounded-lg bg-${app.color}-600/20`}>\r\n                    <Icon className={`w-8 h-8 text-${app.color}-400`} />\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <h2 className=\"text-xl font-bold\">{app.title}</h2>\r\n                  </div>\r\n                  {app.disabled && (\r\n                    <div className=\"flex items-center gap-2\">\r\n                      {profile?.is_lead_officer || profile?.is_troll_officer ? (\r\n                        <CheckCircle className=\"w-6 h-6 text-green-400\" />\r\n                      ) : (\r\n                        <XCircle className=\"w-6 h-6 text-gray-400\" />\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                <p className=\"text-gray-300 mb-4\">{app.description}</p>\r\n                {app.disabled && (\r\n                  <p className=\"text-sm text-gray-400 italic\">{app.disabledText}</p>\r\n                )}\r\n                {!app.disabled && (\r\n                  <button\r\n                    onClick={(e) => {\r\n                      e.stopPropagation()\r\n                      handleApplication(app.type)\r\n                    }}\r\n                    disabled={loading}\r\n                    className={`w-full px-4 py-2 rounded-lg font-semibold bg-${app.color}-600 hover:bg-${app.color}-700 disabled:opacity-50`}\r\n                  >\r\n                    {loading ? 'Loading...' : 'Apply Now'}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n\r\n        <div className=\"mt-8 bg-black/60 border border-purple-600/30 rounded-xl p-6\">\r\n          <h3 className=\"text-lg font-semibold mb-2\">Application Process</h3>\r\n          <ul className=\"space-y-2 text-sm text-gray-300\">\r\n            <li>‚Ä¢ Select a role above to start your application</li>\r\n            <li>‚Ä¢ Complete the application form with required information</li>\r\n            <li>‚Ä¢ Pay any required application fees (if applicable)</li>\r\n            <li>‚Ä¢ Wait for admin review and approval</li>\r\n            <li>‚Ä¢ You'll receive a notification when your application is reviewed</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ApplicationPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AuctionsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Auth.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleGoogle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":344,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":344,"endColumn":21},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":626,"column":51,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[25917,26003],"text":"\r\n              Tell our team about the issue and we&apos;ll help you fix it.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[25917,26003],"text":"\r\n              Tell our team about the issue and we&lsquo;ll help you fix it.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[25917,26003],"text":"\r\n              Tell our team about the issue and we&#39;ll help you fix it.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[25917,26003],"text":"\r\n              Tell our team about the issue and we&rsquo;ll help you fix it.\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { AuthApiError } from '@supabase/supabase-js'\r\nimport { supabase, isAdminEmail } from '../lib/supabase'\r\nimport { post, API_ENDPOINTS } from '../lib/api'\r\nimport { toast } from 'sonner'\r\nimport { useNavigate, useSearchParams, Link } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { Mail, Lock, User, Eye, EyeOff, AlertTriangle } from 'lucide-react'\r\n\r\nconst Auth = () => {\r\n  const [loading, setLoading] = useState(false)\r\n  const [searchParams] = useSearchParams()\n  const initialIsLogin = searchParams.get('mode') === 'signup' ? false : true\n  const [isLogin, setIsLogin] = useState(initialIsLogin)\r\n  const [email, setEmail] = useState('')\r\n  const [password, setPassword] = useState('')\r\n  const [username, setUsername] = useState('')\r\n  const [acceptedTerms, setAcceptedTerms] = useState(false)\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const [showAlertAdmin, setShowAlertAdmin] = useState(false)\r\n  const [alertEmail, setAlertEmail] = useState('')\r\n  const [alertDetails, setAlertDetails] = useState('')\r\n  const [alertSubmitting, setAlertSubmitting] = useState(false)\r\n  const navigate = useNavigate()\r\n  const { user, profile, setAuth, setProfile } = useAuthStore()\r\n  const [installPrompt, setInstallPrompt] = useState<any>(null)\r\n  const [installed, setInstalled] = useState(() => {\r\n    try { return localStorage.getItem('pwa-installed') === 'true' } catch { return false }\r\n  })\r\n  \r\n  // Get referral code from URL\r\n  const referralCode = searchParams.get('ref') || ''\r\n\r\n  const executeLogin = async (loginEmail: string, loginPassword: string) => {\r\n    console.log('Attempting email login...')\r\n    const { data, error } = await supabase.auth.signInWithPassword({\r\n      email: loginEmail,\r\n      password: loginPassword,\r\n    })\r\n    \r\n    if (error) {\r\n      console.error('Login error:', error)\r\n      // Handle specific auth errors\r\n      if (error.message.includes('Email not confirmed')) {\r\n        throw new Error('Login failed. Please try again or contact support if the issue persists.')\r\n      }\r\n      if (error.message.includes('Invalid login credentials')) {\r\n        throw new Error('Invalid email or password.')\r\n      }\r\n      throw error\r\n    }\r\n    \r\n    if (data.user && data.session) {\r\n      console.log('Email login successful:', data.user.email)\r\n      \r\n      const sessionId = crypto.randomUUID()\r\n      // Store session ID for device enforcement\r\n      try {\r\n        localStorage.setItem('current_device_session_id', sessionId)\r\n      } catch (e) {\r\n        console.error('Failed to store session ID', e)\r\n      }\r\n\r\n      // Register this session\r\n      try {\r\n        const deviceInfo = {\r\n          browser: navigator.userAgent,\r\n          platform: navigator.platform,\r\n          screen: { width: window.screen.width, height: window.screen.height }\r\n        }\r\n        \r\n        if (sessionId) {\r\n          await supabase\r\n            .rpc('register_session', {\r\n              p_user_id: data.user.id,\r\n              p_session_id: sessionId,\r\n              p_device_info: JSON.stringify(deviceInfo),\r\n              p_ip_address: null,\r\n              p_user_agent: navigator.userAgent\r\n            })\r\n        } else {\r\n          console.warn('[Auth] Skipping register_session because session access_token is missing')\r\n        }\r\n      } catch (sessionError) {\r\n        console.error('Error registering session:', sessionError)\r\n        // Continue with login even if session registration fails\r\n      }\r\n      \r\n      setAuth(data.user, data.session)\r\n      \r\n      // Check if profile exists\r\n      let profileData = null\r\n      const { data: fetchedProfile, error: profileError } = await supabase\r\n        .from('user_profiles')\r\n        .select('*')\r\n        .eq('id', data.user.id)\r\n        .maybeSingle()\r\n      \r\n      if (profileError) {\r\n         console.error('Error fetching profile:', profileError)\r\n         // Don't throw here, try to recover or redirect to setup\r\n      }\r\n      profileData = fetchedProfile\r\n\r\n      if (profileData) {\r\n        // Check if admin BEFORE setting profile\r\n        if (isAdminEmail(data.user.email) && profileData.role !== 'admin') {\r\n          try {\r\n            const now = new Date().toISOString()\r\n            const { data: updated } = await supabase\r\n              .from('user_profiles')\r\n              .update({ role: 'admin', updated_at: now })\r\n              .eq('id', data.user.id)\r\n              .select('*')\r\n              .single()\r\n            setProfile(updated || profileData)\r\n          } catch (err) {\r\n            console.error('Failed to update admin role:', err)\r\n            setProfile(profileData)\r\n          }\r\n        } else {\r\n          setProfile(profileData)\r\n        }\r\n        \r\n        if (profileData.username) {\r\n          toast.success('Welcome back!', { duration: 2000 })\r\n          try {\r\n            const ipRes = await fetch('https://api.ipify.org?format=json')\r\n            const ipJson = await ipRes.json()\r\n            const userIP = ipJson.ip\r\n            const { data: current } = await supabase\r\n              .from('user_profiles')\r\n              .select('ip_address_history')\r\n              .eq('id', data.user.id)\r\n              .single()\r\n            const history = current?.ip_address_history || []\r\n            const entry = { ip: userIP, timestamp: new Date().toISOString() }\r\n            const updated = [...history, entry].slice(-10)\r\n            await supabase\r\n              .from('user_profiles')\r\n              .update({ last_known_ip: userIP, ip_address_history: updated })\r\n              .eq('id', data.user.id)\r\n          } catch {}\r\n          navigate('/')\r\n        } else {\r\n          toast.success('Login successful! Please complete your profile.')\r\n          navigate('/profile/setup')\r\n        }\r\n      } else {\r\n        // Profile doesn't exist, try polling for it\r\n        let tries = 0\r\n        let prof: any = null\r\n        while (tries < 3 && !prof) {\r\n          const { data: p } = await supabase\r\n            .from('user_profiles')\r\n            .select('*')\r\n            .eq('id', data.user.id)\r\n            .maybeSingle()\r\n          if (p) prof = p\r\n          else {\r\n            await new Promise(r => setTimeout(r, 500))\r\n            tries++\r\n          }\r\n        }\r\n        if (prof) {\r\n          setProfile(prof)\r\n          if (prof.username) {\r\n            toast.success('Welcome back!', { duration: 2000 })\r\n            try {\r\n              const ipRes = await fetch('https://api.ipify.org?format=json')\r\n              const ipJson = await ipRes.json()\r\n              const userIP = ipJson.ip\r\n              const { data: current } = await supabase\r\n                .from('user_profiles')\r\n                .select('ip_address_history')\r\n              .eq('id', data.user.id)\r\n                .single()\r\n              const history = current?.ip_address_history || []\r\n              const entry = { ip: userIP, timestamp: new Date().toISOString() }\r\n              const updated = [...history, entry].slice(-10)\r\n              await supabase\r\n                .from('user_profiles')\r\n                .update({ last_known_ip: userIP, ip_address_history: updated })\r\n                .eq('id', data.user.id)\r\n            } catch {}\r\n            navigate('/')\r\n          } else {\r\n            toast.success('Login successful! Please complete your profile.')\r\n            navigate('/profile/setup')\r\n          }\r\n        } else {\r\n          // Still no profile found - redirect to setup to let it handle creation/fetching\r\n          console.log('No profile found after polling, redirecting to setup')\r\n          toast.success('Login successful! Please complete your profile.')\r\n          navigate('/profile/setup')\r\n        }\r\n      }\r\n    } else if (data.user && !data.session) {\r\n      throw new Error('Login failed. Please try again or contact support if the issue persists.')\r\n    } else {\r\n      throw new Error('Login failed - no user data returned')\r\n    }\r\n  }\r\n\r\n  const handleEmailAuth = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (loading) return // Prevent double submission\r\n    setLoading(true)\r\n    \r\n    try {\r\n      if (isLogin) {\r\n        await executeLogin(email, password)\r\n      } else {\r\n        if (!username.trim()) {\r\n          toast.error('Username is required for sign up')\r\n          setLoading(false)\r\n          return\r\n        }\r\n\r\n        if (!acceptedTerms) {\r\n          toast.error('You must accept the terms and agreements to sign up')\r\n          setLoading(false)\r\n          return\r\n        }\r\n        \r\n        // Use Edge Function for signup\r\n        console.log('Creating new user account...')\r\n        \r\n        const { success, error: signUpError } = await post(API_ENDPOINTS.auth.signup, {\r\n          email,\r\n          password,\r\n          username: username.trim(),\r\n          referral_code: referralCode || localStorage.getItem('recruited_by') || undefined,\r\n          data: {\r\n            terms_accepted: true,\r\n            accepted_at: new Date().toISOString()\r\n          }\r\n        })\r\n\r\n        if (!success || signUpError) {\r\n          console.error('Signup failed:', signUpError)\r\n          toast.error(signUpError || 'Signup failed')\r\n          setLoading(false)\r\n          return\r\n        }\r\n        \r\n        toast.success('Account created! Logging you in...')\r\n        await executeLogin(email, password)\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Email auth error:', err)\r\n      if (err instanceof AuthApiError) {\r\n        const msg = String(err.message || '')\r\n        const lowerMsg = msg.toLowerCase()\r\n        if (lowerMsg.includes('invalid refresh token') || lowerMsg.includes('refresh token not found')) {\r\n          try {\r\n            await supabase.auth.signOut()\r\n          } catch {}\r\n          try {\r\n            useAuthStore.getState().logout()\r\n          } catch {}\r\n          toast.error('Your session has expired. Please sign in again.')\r\n          navigate('/auth')\r\n          return\r\n        }\r\n      }\r\n      const rawMessage = String(err?.message || '')\r\n      const lower = rawMessage.toLowerCase()\r\n      if (err?.name === 'AbortError' || lower.includes('aborted')) {\r\n        toast.error('Request was interrupted. Please check your connection and try again.')\r\n      } else {\r\n        toast.error(rawMessage || 'Authentication failed')\r\n      }\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleAlertAdminSubmit = async () => {\r\n    if (alertSubmitting) return\r\n    const trimmedDetails = alertDetails.trim()\r\n    const emailToSend = alertEmail.trim() || email.trim()\r\n    if (!emailToSend) {\r\n      toast.error('Please enter your email so we can contact you')\r\n      return\r\n    }\r\n    if (!trimmedDetails) {\r\n      toast.error('Please describe the issue you are having')\r\n      return\r\n    }\r\n    setAlertSubmitting(true)\r\n    try {\r\n      const { error } = await supabase.from('critical_alerts').insert({\r\n        message: `AUTH LOGIN ISSUE from ${emailToSend}: ${trimmedDetails}`,\r\n        severity: 'critical',\r\n        resolved: false,\r\n        source: 'auth_login_issue'\r\n      })\r\n      if (error) {\r\n        throw error\r\n      }\r\n      toast.success('Alert sent. Please check your email within 5 minutes.')\r\n      setShowAlertAdmin(false)\r\n      setAlertDetails('')\r\n    } catch (err: any) {\r\n      console.error('Failed to send login alert:', err)\r\n      toast.error(err?.message || 'Failed to send alert, please try again')\r\n    } finally {\r\n      setAlertSubmitting(false)\r\n    }\r\n  }\r\n\r\n  React.useEffect(() => {\r\n    if (user && profile) {\r\n      if (profile.username) {\r\n        navigate('/')\r\n      } else {\r\n        navigate('/profile/setup')\r\n      }\r\n    }\r\n  }, [user, profile, navigate])\r\n\r\n  \r\n\r\n  React.useEffect(() => {\r\n    const handleBeforeInstall = (e: any) => {\r\n      e.preventDefault()\r\n      setInstallPrompt(e)\r\n    }\r\n    const handleInstalled = () => {\r\n      try { localStorage.setItem('pwa-installed', 'true') } catch {}\r\n      setInstalled(true)\r\n      setInstallPrompt(null)\r\n      toast.success('App installed')\r\n    }\r\n    window.addEventListener('beforeinstallprompt', handleBeforeInstall as any)\r\n    window.addEventListener('appinstalled', handleInstalled as any)\r\n    return () => {\r\n      window.removeEventListener('beforeinstallprompt', handleBeforeInstall as any)\r\n      window.removeEventListener('appinstalled', handleInstalled as any)\r\n    }\r\n  }, [])\r\n\r\n  const handleGoogle = async () => {\r\n    setLoading(true)\r\n    try {\r\n      const envSiteUrl = (import.meta as any).env.VITE_PUBLIC_SITE_URL as string | undefined\r\n      let redirectBase = window.location.origin\r\n      if (envSiteUrl && !/localhost/i.test(envSiteUrl)) {\r\n        try {\r\n          redirectBase = new URL(envSiteUrl).origin\r\n        } catch {\r\n          redirectBase = window.location.origin\r\n        }\r\n      }\r\n      const { error } = await supabase.auth.signInWithOAuth({ \r\n        provider: 'google', \r\n        options: { \r\n          redirectTo: String(redirectBase).replace(/\\/$/, '') + '/auth/callback',\r\n          queryParams: {\r\n            access_type: 'offline',\r\n            prompt: 'consent',\r\n          }\r\n        } \r\n      })\r\n      if (error) throw error\r\n    } catch (err: any) {\r\n      toast.error(err.message || 'Google login failed')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <>\r\n    <div className=\"auth-container flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white overflow-x-hidden relative font-sans\">\r\n      {/* Animated Background Gradients */}\r\n      <div className=\"absolute inset-0 overflow-hidden\">\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_20%_30%,rgba(147,51,234,0.15),transparent)]\" />\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_80%_70%,rgba(236,72,153,0.12),transparent)]\" />\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(56,189,248,0.1),transparent)]\" />\r\n      </div>\r\n\r\n      {/* Floating Particles */}\r\n      <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\r\n        {Array.from({ length: 15 }).map((_, i) => (\r\n          <div\r\n            key={i}\r\n            className=\"absolute w-1 h-1 bg-cyan-400/20 rounded-full\"\r\n            style={{\r\n              left: `${Math.random() * 100}%`,\r\n              top: `${Math.random() * 100}%`,\r\n              animation: `float-particle ${5 + Math.random() * 10}s ease-in-out infinite`,\r\n              animationDelay: `${Math.random() * 5}s`,\r\n            }}\r\n          />\r\n        ))}\r\n      </div>\r\n\r\n      {/* Auth Card */}\r\n      <div className=\"relative z-10 w-full max-w-md px-4 py-8\">\r\n        <div className=\"backdrop-blur-xl bg-slate-900/60 border border-white/10 rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] p-8\">\r\n          {/* Header */}\r\n          <div className=\"flex flex-col items-center mb-8\">\r\n            <h1 className=\"text-4xl md:text-5xl font-black\">\r\n              <span className=\"bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent\">\r\n                Troll City\r\n              </span>\r\n            </h1>\r\n            <p className=\"text-slate-400 text-sm mt-2 font-semibold tracking-widest\">\r\n              {isLogin ? 'Welcome Back' : 'Join the City'}\r\n            </p>\r\n          </div>\r\n\r\n          {/* Tab Navigation */}\r\n          <div className=\"flex justify-center mb-8\">\r\n            <div className=\"flex bg-slate-800/50 border border-white/5 rounded-xl p-1\">\r\n              <button\r\n                onClick={() => setIsLogin(true)}\r\n                className={`px-6 py-2 rounded-lg font-semibold transition-all duration-300 ${\r\n                  isLogin \r\n                    ? 'bg-gradient-to-r from-purple-600 to-cyan-500 text-white shadow-lg' \r\n                    : 'text-slate-400 hover:text-slate-200'\r\n                }`}\r\n              >\r\n                Sign In\r\n              </button>\r\n              <button\r\n                onClick={() => setIsLogin(false)}\r\n                className={`px-6 py-2 rounded-lg font-semibold transition-all duration-300 ${\r\n                  !isLogin \r\n                    ? 'bg-gradient-to-r from-purple-600 to-cyan-500 text-white shadow-lg' \r\n                    : 'text-slate-400 hover:text-slate-200'\r\n                }`}\r\n              >\r\n                Sign Up\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Form */}\r\n          <form onSubmit={handleEmailAuth} className=\"space-y-5 mb-6\">\r\n            {/* Email Input */}\r\n            <div className=\"relative group\">\r\n              <Mail className=\"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-purple-400/60 group-focus-within:text-cyan-400 transition-colors\" />\r\n              <input\r\n                type=\"email\"\r\n                id=\"email\"\r\n                name=\"email\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n                className=\"w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400/40 focus:bg-slate-800/70 transition-all focus:shadow-[0_0_20px_rgba(34,211,238,0.2)]\"\r\n                placeholder=\"Email address\"\r\n                autoComplete=\"email\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            {/* Password Input */}\r\n            <div className=\"relative group\">\r\n              <Lock className=\"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-purple-400/60 group-focus-within:text-cyan-400 transition-colors\" />\r\n              <input\r\n                type={showPassword ? \"text\" : \"password\"}\r\n                id=\"password\"\r\n                name=\"password\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                className=\"w-full pl-12 pr-12 py-3 bg-slate-800/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400/40 focus:bg-slate-800/70 transition-all focus:shadow-[0_0_20px_rgba(34,211,238,0.2)]\"\r\n                placeholder=\"Password\"\r\n                autoComplete={isLogin ? 'current-password' : 'new-password'}\r\n                required\r\n                minLength={6}\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowPassword(!showPassword)}\r\n                className=\"absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-cyan-400 transition-colors\"\r\n              >\r\n                {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\r\n              </button>\r\n            </div>\r\n\r\n            {/* Username Input (Sign Up Only) */}\r\n            {!isLogin && (\r\n              <>\r\n                <div className=\"relative group\">\r\n                  <User className=\"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-purple-400/60 group-focus-within:text-cyan-400 transition-colors\" />\r\n                  <input\r\n                    type=\"text\"\r\n                    id=\"username\"\r\n                    name=\"username\"\r\n                    value={username}\r\n                    onChange={(e) => setUsername(e.target.value)}\r\n                    className=\"w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400/40 focus:bg-slate-800/70 transition-all focus:shadow-[0_0_20px_rgba(34,211,238,0.2)]\"\r\n                    placeholder=\"Username\"\r\n                    autoComplete=\"username\"\r\n                    required\r\n                  />\r\n                </div>\r\n\r\n                {/* Terms Acceptance */}\r\n                <div className=\"flex items-start gap-3 px-1\">\r\n                  <div className=\"relative flex items-center pt-1\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"accept-terms\"\r\n                      checked={acceptedTerms}\r\n                      onChange={(e) => setAcceptedTerms(e.target.checked)}\r\n                      className=\"peer h-5 w-5 appearance-none rounded border border-purple-500/30 bg-slate-800/50 checked:bg-purple-600 checked:border-purple-600 focus:ring-2 focus:ring-purple-500/20 focus:outline-none transition-all cursor-pointer\"\r\n                    />\r\n                    <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center text-white opacity-0 peer-checked:opacity-100 transition-opacity\">\r\n                      <svg\r\n                        xmlns=\"http://www.w3.org/2000/svg\"\r\n                        className=\"h-3.5 w-3.5\"\r\n                        viewBox=\"0 0 20 20\"\r\n                        fill=\"currentColor\"\r\n                      >\r\n                        <path\r\n                          fillRule=\"evenodd\"\r\n                          d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\r\n                          clipRule=\"evenodd\"\r\n                        />\r\n                      </svg>\r\n                    </div>\r\n                  </div>\r\n                  <label htmlFor=\"accept-terms\" className=\"text-sm text-slate-300 cursor-pointer select-none\">\r\n                    I accept the{' '}\r\n                    <Link to=\"/terms\" target=\"_blank\" className=\"text-purple-400 hover:text-purple-300 hover:underline\">\r\n                      Terms and Agreements\r\n                    </Link>\r\n                    {' '}and acknowledge the{' '}\r\n                    <Link to=\"/privacy\" target=\"_blank\" className=\"text-purple-400 hover:text-purple-300 hover:underline\">\r\n                      Privacy Policy\r\n                    </Link>.\r\n                  </label>\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Submit Button */}\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading}\r\n              className=\"w-full py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-[0_15px_40px_rgba(147,51,234,0.3)] transition-all duration-300 hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n            {loading ? (\r\n              <span className=\"flex items-center justify-center\">\r\n                <div className=\"animate-spin rounded-full h-5 w-5 border-2 border-white/30 border-t-white mr-2\"></div>\r\n                Processing...\r\n              </span>\r\n            ) : (\r\n              isLogin ? 'Sign In' : 'Sign Up'\r\n            )}\r\n          </button>\r\n        </form>\r\n\r\n        {/* Helper Links */}\r\n        <div className=\"space-y-3 mb-6\">\r\n          <div className=\"flex items-center justify-between flex-wrap gap-2 text-xs\">\r\n            <Link\r\n              to={email ? `/reset-password?email=${encodeURIComponent(email)}` : \"/reset-password\"}\r\n              className=\"text-cyan-400/80 hover:text-cyan-300 transition-colors\"\r\n            >\r\n              Forgot password?\r\n            </Link>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => {\r\n                setShowAlertAdmin(true)\r\n                if (!alertEmail && email) {\r\n                  setAlertEmail(email)\r\n                }\r\n              }}\r\n              className=\"text-cyan-400/80 hover:text-cyan-300 transition-colors flex items-center gap-1\"\r\n            >\r\n              <AlertTriangle className=\"w-3 h-3\" />\r\n              Need help?\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {installPrompt && !installed && (\r\n          <div className=\"mt-6 p-4 bg-gradient-to-r from-green-600/20 to-emerald-600/20 border border-green-500/30 rounded-xl\">\r\n            <div className=\"text-xs text-slate-300 mb-3 text-center\">Install the app now. Use the same login on web and app.</div>\r\n            <button\r\n              className=\"w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold rounded-xl hover:shadow-[0_10px_30px_rgba(34,197,94,0.3)] transition-all duration-300\"\r\n              type=\"button\"\r\n              onClick={async () => {\r\n                try {\r\n                  await installPrompt.prompt()\r\n                  const choice = await installPrompt.userChoice\r\n                  if (choice?.outcome === 'accepted') {\r\n                    try { localStorage.setItem('pwa-installed', 'true') } catch {}\r\n                    setInstalled(true)\r\n                    setInstallPrompt(null)\r\n                  }\r\n                } catch {}\r\n              }}\r\n            >\r\n              Install App\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n      </div>\r\n      {/* Alert Admin Modal */}\r\n      {showAlertAdmin && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-4\">\r\n          <div className=\"w-full max-w-md rounded-2xl backdrop-blur-xl bg-slate-900/60 border border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.4)] p-6\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"p-2 bg-orange-500/20 rounded-lg\">\r\n                  <AlertTriangle className=\"w-5 h-5 text-orange-400\" />\r\n                </div>\r\n                <h2 className=\"text-lg font-semibold text-white\">Need help?</h2>\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowAlertAdmin(false)}\r\n                className=\"text-slate-400 hover:text-white text-2xl leading-none\"\r\n              >\r\n                √ó\r\n              </button>\r\n            </div>\r\n            <p className=\"text-xs text-slate-400 mb-4\">\r\n              Tell our team about the issue and we'll help you fix it.\r\n            </p>\r\n            <div className=\"space-y-3\">\r\n              <div>\r\n                <label className=\"block text-xs text-slate-400 mb-2\">Email</label>\r\n                <input\r\n                  type=\"email\"\r\n                  value={alertEmail}\r\n                  onChange={(e) => setAlertEmail(e.target.value)}\r\n                  className=\"w-full rounded-xl border border-white/10 bg-slate-800/50 px-4 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400/40 focus:bg-slate-800/70 transition-all\"\r\n                  placeholder=\"you@example.com\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-xs text-slate-400 mb-2\">Describe the issue</label>\r\n                <textarea\r\n                  value={alertDetails}\r\n                  onChange={(e) => setAlertDetails(e.target.value)}\r\n                  className=\"w-full rounded-xl border border-white/10 bg-slate-800/50 px-4 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400/40 focus:bg-slate-800/70 transition-all resize-none h-24\"\r\n                  placeholder=\"Example: Password reset not working...\"\r\n                />\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleAlertAdminSubmit}\r\n                disabled={alertSubmitting}\r\n                className=\"w-full py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-[0_15px_40px_rgba(147,51,234,0.3)] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {alertSubmitting ? 'Sending...' : 'Send help request'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {React.createElement('style', { dangerouslySetInnerHTML: { __html: `\r\n        @keyframes float-particle {\r\n          0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0; }\r\n          50% { transform: translateY(-30px) translateX(10px); opacity: 0.6; }\r\n        }\r\n      ` } })}\r\n    </div>\r\n  </>\r\n  )\r\n}\r\n\r\nexport default Auth\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AuthCallback.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\AvatarCustomizer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\BadgesPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\BanFee.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\BroadcastSummary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Call.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Career.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[309,321],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Mic' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":6,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Mic"},"fix":{"range":[339,347],"text":""},"desc":"Remove unused variable \"Mic\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Heart' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Heart"},"fix":{"range":[347,354],"text":""},"desc":"Remove unused variable \"Heart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectedPosition' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":178,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":178,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSelectedPosition' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":178,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":178,"endColumn":47},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":512,"column":60,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[17535,17578],"text":"You haven&apos;t submitted any applications yet."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[17535,17578],"text":"You haven&lsquo;t submitted any applications yet."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[17535,17578],"text":"You haven&#39;t submitted any applications yet."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[17535,17578],"text":"You haven&rsquo;t submitted any applications yet."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { \r\n  Briefcase, Calendar, Clock, Users, Shield, Video, \r\n  CheckCircle, FileText, TrendingUp, Star, ArrowRight,\r\n  Mic, Heart, Cross, Music, Gamepad2\r\n} from 'lucide-react'\r\n\r\n// Job position type\r\ninterface JobPosition {\r\n  id: string\r\n  title: string\r\n  department: string\r\n  description: string\r\n  requirements: string[]\r\n  benefits: string[]\r\n  icon: React.ReactNode\r\n  color: string\r\n}\r\n\r\n// Application status type\r\ninterface Application {\r\n  id: string\r\n  type: string\r\n  status: string\r\n  created_at: string\r\n  reviewed_at?: string\r\n}\r\n\r\n// Interview session type\r\ninterface InterviewSession {\r\n  id: string\r\n  application_id: string\r\n  scheduled_at: string\r\n  status: string\r\n  applicant_name: string\r\n}\r\n\r\nconst jobPositions: JobPosition[] = [\r\n  {\r\n    id: 'troller',\r\n    title: 'Troller',\r\n    department: 'Broadcasting',\r\n    description: 'Stream content on Troll City and engage with the community',\r\n    requirements: [\r\n      'Must be 18 years or older',\r\n      'Ability to create engaging content',\r\n      'Stable internet connection',\r\n      'Basic streaming equipment',\r\n      'Good communication skills'\r\n    ],\r\n    benefits: [\r\n      'Earn coins from viewer engagement',\r\n      'Access to Troll Officer community',\r\n      'Potential for platform-wide promotion',\r\n      'Network with other creators'\r\n    ],\r\n    icon: <Video className=\"w-6 h-6\" />,\r\n    color: 'from-cyan-500 to-blue-500'\r\n  },\r\n  {\r\n    id: 'troll_officer',\r\n    title: 'Troll Officer',\r\n    department: 'Moderation',\r\n    description: 'Help maintain a safe and fun community environment',\r\n    requirements: [\r\n      'Previous moderation experience',\r\n      'Strong understanding of community guidelines',\r\n      'Ability to handle difficult situations calmly',\r\n      'Available for regular shifts',\r\n      'Good judgment and decision-making skills'\r\n    ],\r\n    benefits: [\r\n      'Special officer role and badge',\r\n      'Access to officer-only channels',\r\n      'Contribution to platform growth',\r\n      'Recognition in community'\r\n    ],\r\n    icon: <Shield className=\"w-6 h-6\" />,\r\n    color: 'from-purple-500 to-pink-500'\r\n  },\r\n  {\r\n    id: 'lead_officer',\r\n    title: 'Lead Troll Officer',\r\n    department: 'Leadership',\r\n    description: 'Lead the moderation team and coordinate officer activities',\r\n    requirements: [\r\n      'Previous Troll Officer experience',\r\n      'Strong leadership and communication skills',\r\n      'Ability to train and mentor new officers',\r\n      'Strategic thinking and problem-solving',\r\n      'Commitment to platform success'\r\n    ],\r\n    benefits: [\r\n      'Leadership role with higher responsibility',\r\n      'Access to admin dashboard',\r\n      'Platform-wide influence',\r\n      'Community recognition as leader'\r\n    ],\r\n    icon: <Star className=\"w-6 h-6\" />,\r\n    color: 'from-yellow-500 to-orange-500'\r\n  },\r\n  {\r\n    id: 'pastor',\r\n    title: 'Pastor',\r\n    department: 'Spiritual',\r\n    description: 'Lead spiritual content and church-related activities',\r\n    requirements: [\r\n      'Strong faith and biblical knowledge',\r\n      'Ability to lead discussions and studies',\r\n      'Compassion and guidance skills',\r\n      'Availability for church events',\r\n      'Respect for all community members'\r\n    ],\r\n    benefits: [\r\n      'Pastor role and recognition',\r\n      'Lead church-related content',\r\n      'Community spiritual guidance',\r\n      'Special pastor channels'\r\n    ],\r\n    icon: <Cross className=\"w-6 h-6\" />,\r\n    color: 'from-green-500 to-emerald-500'\r\n  },\r\n  {\r\n    id: 'entertainer',\r\n    title: 'Entertainer',\r\n    department: 'Content',\r\n    description: 'Create music, performances, and entertainment content',\r\n    requirements: [\r\n      'Talents in music, comedy, or performance',\r\n      'Ability to entertain and engage audiences',\r\n      'Original content creation skills',\r\n      'Consistent streaming schedule',\r\n      'Positive and uplifting content'\r\n    ],\r\n    benefits: [\r\n      'Featured content opportunities',\r\n      'Music and performance promotion',\r\n      'Fan engagement tools',\r\n      'Creative freedom'\r\n    ],\r\n    icon: <Music className=\"w-6 h-6\" />,\r\n    color: 'from-red-500 to-rose-500'\r\n  },\r\n  {\r\n    id: 'gamer',\r\n    title: 'Pro Gamer',\r\n    department: 'Gaming',\r\n    description: 'Stream gaming content and compete in tournaments',\r\n    requirements: [\r\n      'High-level gaming skills',\r\n      'Knowledge of multiple game genres',\r\n      'Entertaining commentary abilities',\r\n      'Tournament participation willingness',\r\n      'Regular gaming schedule'\r\n    ],\r\n    benefits: [\r\n      'Gaming community access',\r\n      'Tournament entries',\r\n      'Gaming gear opportunities',\r\n      'Competitive recognition'\r\n    ],\r\n    icon: <Gamepad2 className=\"w-6 h-6\" />,\r\n    color: 'from-indigo-500 to-violet-500'\r\n  }\r\n]\r\n\r\nexport default function Career() {\r\n  const navigate = useNavigate()\r\n  const { profile, user } = useAuthStore()\r\n  const [activeTab, setActiveTab] = useState<'positions' | 'my_applications' | 'interviews'>('positions')\r\n  const [applications, setApplications] = useState<Application[]>([])\r\n  const [interviews, setInterviews] = useState<InterviewSession[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [selectedPosition, setSelectedPosition] = useState<JobPosition | null>(null)\r\n  const [showScheduleModal, setShowScheduleModal] = useState(false)\r\n  const [selectedApplication, setSelectedApplication] = useState<Application | null>(null)\r\n  const [scheduleDate, setScheduleDate] = useState('')\r\n  const [scheduleTime, setScheduleTime] = useState('')\r\n\r\n  // Check for admin/lead status using comprehensive role checks (matching Sidebar.tsx logic)\r\n  const isAdminOrLead = profile?.role === 'admin' || \r\n    profile?.troll_role === 'admin' || \r\n    profile?.role === 'hr_admin' || \r\n    profile?.is_admin || \r\n    profile?.role === 'lead_troll_officer' || \r\n    profile?.troll_role === 'lead_troll_officer' || \r\n    profile?.is_lead_officer\r\n\r\n  // Fetch user's applications\r\n  useEffect(() => {\r\n    const fetchApplications = async () => {\r\n      if (!user) return\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('applications')\r\n          .select('id, type, status, created_at, reviewed_at')\r\n          .eq('user_id', user.id)\r\n          .order('created_at', { ascending: false })\r\n\r\n        if (error) throw error\r\n        setApplications(data || [])\r\n      } catch (error) {\r\n        console.error('Error fetching applications:', error)\r\n      }\r\n    }\r\n\r\n    fetchApplications()\r\n  }, [user])\r\n\r\n  // Fetch interviews for admin/lead\r\n  useEffect(() => {\r\n    const fetchInterviews = async () => {\r\n      if (!isAdminOrLead) return\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('interview_sessions')\r\n          .select('id, application_id, scheduled_at, status, user_id')\r\n          .order('scheduled_at', { ascending: true })\r\n\r\n        if (error) throw error\r\n\r\n        // Get user profiles for each interview\r\n        const userIds = [...new Set(data.map((i: any) => i.user_id))]\r\n        const { data: profiles } = await supabase\r\n          .from('user_profiles')\r\n          .select('id, username, full_name')\r\n          .in('id', userIds)\r\n\r\n        const profileMap = new Map(profiles?.map((p: any) => [p.id, p]) || [])\r\n\r\n        const formattedInterviews = (data || []).map((item: any) => {\r\n          const profile = profileMap.get(item.user_id)\r\n          return {\r\n            id: item.id,\r\n            application_id: item.application_id,\r\n            scheduled_at: item.scheduled_at,\r\n            status: item.status,\r\n            applicant_name: profile?.full_name || profile?.username || 'Unknown'\r\n          }\r\n        })\r\n        setInterviews(formattedInterviews)\r\n      } catch (error) {\r\n        console.error('Error fetching interviews:', error)\r\n      }\r\n    }\r\n\r\n    fetchInterviews()\r\n  }, [isAdminOrLead])\r\n\r\n  // Fetch pending applications for admin/lead\r\n  useEffect(() => {\r\n    const fetchPendingApplications = async () => {\r\n      if (!isAdminOrLead) return\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('applications')\r\n          .select(`\r\n            id,\r\n            type,\r\n            status,\r\n            created_at,\r\n            user:user_profiles!applications_user_id_fkey (\r\n              username,\r\n              full_name\r\n            )\r\n          `)\r\n          .eq('status', 'pending')\r\n          .order('created_at', { ascending: false })\r\n          .limit(10)\r\n\r\n        if (error) throw error\r\n        setApplications(data || [])\r\n      } catch (error) {\r\n        console.error('Error fetching pending applications:', error)\r\n      }\r\n    }\r\n\r\n    fetchPendingApplications()\r\n  }, [isAdminOrLead])\r\n\r\n  const handleApply = (position: JobPosition) => {\r\n    if (!user) {\r\n      toast.error('Please sign in to apply')\r\n      navigate('/auth')\r\n      return\r\n    }\r\n\r\n    // Redirect to appropriate application page\r\n    switch (position.id) {\r\n      case 'troller':\r\n        navigate('/apply/troller')\r\n        break\r\n      case 'troll_officer':\r\n        navigate('/apply/officer')\r\n        break\r\n      case 'lead_officer':\r\n        navigate('/apply/lead-officer')\r\n        break\r\n      case 'pastor':\r\n        navigate('/apply/pastor')\r\n        break\r\n      default:\r\n        navigate('/apply')\r\n    }\r\n  }\r\n\r\n  const handleScheduleInterview = async () => {\r\n    if (!selectedApplication || !scheduleDate || !scheduleTime) {\r\n      toast.error('Please select date and time')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setLoading(true)\r\n      const scheduledAt = new Date(`${scheduleDate}T${scheduleTime}`).toISOString()\r\n\r\n      const { data, error } = await supabase.rpc('schedule_interview', {\r\n        p_application_id: selectedApplication.id,\r\n        p_scheduled_at: scheduledAt\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      toast.success('Interview scheduled successfully!')\r\n      setShowScheduleModal(false)\r\n      setSelectedApplication(null)\r\n      setScheduleDate('')\r\n      setScheduleTime('')\r\n\r\n      // Navigate to interview room if needed\r\n      if (data) {\r\n        navigate(`/interview/${data}`)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error scheduling interview:', error)\r\n      toast.error('Failed to schedule interview')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    const styles: Record<string, string> = {\r\n      pending: 'bg-yellow-500/20 text-yellow-400',\r\n      interview_scheduled: 'bg-blue-500/20 text-blue-400',\r\n      in_progress: 'bg-green-500/20 text-green-400',\r\n      approved: 'bg-green-500/20 text-green-400',\r\n      rejected: 'bg-red-500/20 text-red-400',\r\n      completed: 'bg-gray-500/20 text-gray-400',\r\n      cancelled: 'bg-gray-500/20 text-gray-400',\r\n      scheduled: 'bg-purple-500/20 text-purple-400'\r\n    }\r\n\r\n    return (\r\n      <span className={`px-2 py-1 rounded-full text-xs font-medium ${styles[status] || 'bg-gray-500/20 text-gray-400'}`}>\r\n        {status.replace(/_/g, ' ').toUpperCase()}\r\n      </span>\r\n    )\r\n  }\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString('en-US', {\r\n      weekday: 'short',\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: 'numeric',\r\n      minute: '2-digit'\r\n    })\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-8\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-cyan-400 via-pink-400 to-purple-400 bg-clip-text text-transparent mb-2\">\r\n            Career Opportunities\r\n          </h1>\r\n          <p className=\"text-gray-400\">Join the Troll City team and help shape our community</p>\r\n        </div>\r\n\r\n        {/* Tabs */}\r\n        <div className=\"flex gap-4 mb-8\">\r\n          <button\r\n            onClick={() => setActiveTab('positions')}\r\n            className={`px-6 py-3 rounded-lg font-medium transition-colors ${\r\n              activeTab === 'positions' \r\n                ? 'bg-cyan-500 text-white' \r\n                : 'bg-[#1A1A1A] text-gray-400 hover:bg-[#2C2C2C]'\r\n            }`}\r\n          >\r\n            <div className=\"flex items-center gap-2\">\r\n              <Briefcase className=\"w-5 h-5\" />\r\n              Positions\r\n            </div>\r\n          </button>\r\n          \r\n          <button\r\n            onClick={() => setActiveTab('my_applications')}\r\n            className={`px-6 py-3 rounded-lg font-medium transition-colors ${\r\n              activeTab === 'my_applications' \r\n                ? 'bg-cyan-500 text-white' \r\n                : 'bg-[#1A1A1A] text-gray-400 hover:bg-[#2C2C2C]'\r\n            }`}\r\n          >\r\n            <div className=\"flex items-center gap-2\">\r\n              <FileText className=\"w-5 h-5\" />\r\n              My Applications\r\n            </div>\r\n          </button>\r\n\r\n          {isAdminOrLead && (\r\n            <button\r\n              onClick={() => setActiveTab('interviews')}\r\n              className={`px-6 py-3 rounded-lg font-medium transition-colors ${\r\n                activeTab === 'interviews' \r\n                  ? 'bg-cyan-500 text-white' \r\n                  : 'bg-[#1A1A1A] text-gray-400 hover:bg-[#2C2C2C]'\r\n              }`}\r\n            >\r\n              <div className=\"flex items-center gap-2\">\r\n                <Video className=\"w-5 h-5\" />\r\n                Interviews\r\n              </div>\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {/* Content */}\r\n        {activeTab === 'positions' && (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {jobPositions.map((position) => (\r\n              <div\r\n                key={position.id}\r\n                className=\"bg-[#1A1A1A] rounded-xl overflow-hidden border border-[#2C2C2C] hover:border-cyan-500/50 transition-all group\"\r\n              >\r\n                {/* Position Header */}\r\n                <div className={`bg-gradient-to-r ${position.color} p-6`}>\r\n                  <div className=\"flex items-center gap-3 mb-2\">\r\n                    <div className=\"p-2 bg-white/20 rounded-lg\">\r\n                      {position.icon}\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"text-xl font-bold\">{position.title}</h3>\r\n                      <p className=\"text-white/70 text-sm\">{position.department}</p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Position Body */}\r\n                <div className=\"p-6\">\r\n                  <p className=\"text-gray-400 mb-4\">{position.description}</p>\r\n\r\n                  {/* Requirements */}\r\n                  <div className=\"mb-4\">\r\n                    <h4 className=\"text-sm font-semibold text-gray-300 mb-2\">Requirements</h4>\r\n                    <ul className=\"space-y-1\">\r\n                      {position.requirements.slice(0, 3).map((req, index) => (\r\n                        <li key={index} className=\"flex items-start gap-2 text-sm text-gray-400\">\r\n                          <CheckCircle className=\"w-4 h-4 text-green-400 mt-0.5 flex-shrink-0\" />\r\n                          {req}\r\n                        </li>\r\n                      ))}\r\n                      {position.requirements.length > 3 && (\r\n                        <li className=\"text-sm text-cyan-400\">\r\n                          +{position.requirements.length - 3} more requirements\r\n                        </li>\r\n                      )}\r\n                    </ul>\r\n                  </div>\r\n\r\n                  {/* Benefits */}\r\n                  <div className=\"mb-4\">\r\n                    <h4 className=\"text-sm font-semibold text-gray-300 mb-2\">Benefits</h4>\r\n                    <ul className=\"space-y-1\">\r\n                      {position.benefits.slice(0, 2).map((benefit, index) => (\r\n                        <li key={index} className=\"flex items-center gap-2 text-sm text-gray-400\">\r\n                          <Star className=\"w-4 h-4 text-yellow-400 flex-shrink-0\" />\r\n                          {benefit}\r\n                        </li>\r\n                      ))}\r\n                    </ul>\r\n                  </div>\r\n\r\n                  {/* Apply Button */}\r\n                  <button\r\n                    onClick={() => handleApply(position)}\r\n                    className={`w-full py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 bg-gradient-to-r ${position.color} hover:opacity-90`}\r\n                  >\r\n                    Apply Now\r\n                    <ArrowRight className=\"w-4 h-4\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'my_applications' && (\r\n          <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] overflow-hidden\">\r\n            {applications.length === 0 ? (\r\n              <div className=\"p-12 text-center\">\r\n                <FileText className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\r\n                <h3 className=\"text-xl font-bold text-white mb-2\">No Applications Yet</h3>\r\n                <p className=\"text-gray-400 mb-6\">You haven't submitted any applications yet.</p>\r\n                <button\r\n                  onClick={() => setActiveTab('positions')}\r\n                  className=\"px-6 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-colors\"\r\n                >\r\n                  Browse Positions\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"divide-y divide-[#2C2C2C]\">\r\n                {applications.map((app) => {\r\n                  const position = jobPositions.find(p => p.id === app.type)\r\n                  return (\r\n                    <div key={app.id} className=\"p-6 flex items-center justify-between hover:bg-[#252525] transition-colors\">\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <div className={`p-3 rounded-lg bg-gradient-to-r ${position?.color || 'from-gray-500 to-gray-600'}`}>\r\n                          {position?.icon || <Briefcase className=\"w-6 h-6\" />}\r\n                        </div>\r\n                        <div>\r\n                          <h4 className=\"font-semibold text-white capitalize\">{app.type.replace(/_/g, ' ')}</h4>\r\n                          <p className=\"text-gray-400 text-sm\">Applied {formatDate(app.created_at)}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-4\">\r\n                        {getStatusBadge(app.status)}\r\n                        {app.status === 'pending' && isAdminOrLead && (\r\n                          <button\r\n                            onClick={() => {\r\n                              setSelectedApplication(app)\r\n                              setShowScheduleModal(true)\r\n                            }}\r\n                            className=\"px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition-colors flex items-center gap-2\"\r\n                          >\r\n                            <Calendar className=\"w-4 h-4\" />\r\n                            Schedule Interview\r\n                          </button>\r\n                        )}\r\n                        {app.status === 'interview_scheduled' && (\r\n                          <button\r\n                            onClick={() => {\r\n                              // Find the interview session for this application\r\n                              const interview = interviews.find(i => i.application_id === app.id)\r\n                              if (interview) {\r\n                                navigate(`/interview/${interview.id}`)\r\n                              }\r\n                            }}\r\n                            className=\"px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors flex items-center gap-2\"\r\n                          >\r\n                            <Video className=\"w-4 h-4\" />\r\n                            Join Interview\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  )\r\n                })}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'interviews' && isAdminOrLead && (\r\n          <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] overflow-hidden\">\r\n            {interviews.length === 0 ? (\r\n              <div className=\"p-12 text-center\">\r\n                <Calendar className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\r\n                <h3 className=\"text-xl font-bold text-white mb-2\">No Interviews Scheduled</h3>\r\n                <p className=\"text-gray-400\">Schedule interviews with applicants from the Applications tab.</p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"divide-y divide-[#2C2C2C]\">\r\n                {interviews.map((interview) => (\r\n                  <div key={interview.id} className=\"p-6 flex items-center justify-between hover:bg-[#252525] transition-colors\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                      <div className=\"p-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500\">\r\n                        <Users className=\"w-6 h-6\" />\r\n                      </div>\r\n                      <div>\r\n                        <h4 className=\"font-semibold text-white\">{interview.applicant_name}</h4>\r\n                        <p className=\"text-gray-400 text-sm flex items-center gap-2\">\r\n                          <Clock className=\"w-4 h-4\" />\r\n                          {formatDate(interview.scheduled_at)}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-4\">\r\n                      {getStatusBadge(interview.status)}\r\n                      <button\r\n                        onClick={() => navigate(`/interview/${interview.id}`)}\r\n                        className=\"px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg text-sm transition-colors flex items-center gap-2\"\r\n                      >\r\n                        <Video className=\"w-4 h-4\" />\r\n                        {interview.status === 'scheduled' ? 'Start Interview' : 'Rejoin Interview'}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Schedule Interview Modal */}\r\n        {showScheduleModal && selectedApplication && (\r\n          <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-[#1A1A1A] rounded-xl p-6 w-full max-w-md border border-[#2C2C2C]\">\r\n              <h2 className=\"text-xl font-bold text-white mb-4\">Schedule Interview</h2>\r\n              \r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">Date</label>\r\n                  <input\r\n                    type=\"date\"\r\n                    value={scheduleDate}\r\n                    onChange={(e) => setScheduleDate(e.target.value)}\r\n                    min={new Date().toISOString().split('T')[0]}\r\n                    className=\"w-full px-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg text-white focus:border-cyan-400 focus:outline-none\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">Time</label>\r\n                  <input\r\n                    type=\"time\"\r\n                    value={scheduleTime}\r\n                    onChange={(e) => setScheduleTime(e.target.value)}\r\n                    className=\"w-full px-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg text-white focus:border-cyan-400 focus:outline-none\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"bg-[#0D0D0D] rounded-lg p-4\">\r\n                  <p className=\"text-gray-400 text-sm\">\r\n                    The applicant will receive a notification about the scheduled interview. \r\n                    You can join the interview room at the scheduled time.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex gap-4 mt-6\">\r\n                <button\r\n                  onClick={() => {\r\n                    setShowScheduleModal(false)\r\n                    setSelectedApplication(null)\r\n                    setScheduleDate('')\r\n                    setScheduleTime('')\r\n                  }}\r\n                  className=\"flex-1 py-2 bg-[#2C2C2C] hover:bg-[#3C3C3C] text-white rounded-lg transition-colors\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  onClick={handleScheduleInterview}\r\n                  disabled={loading || !scheduleDate || !scheduleTime}\r\n                  className=\"flex-1 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-colors disabled:opacity-50\"\r\n                >\r\n                  {loading ? 'Scheduling...' : 'Schedule'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CashoutPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CASHOUT_TIERS' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"CASHOUT_TIERS"},"fix":{"range":[210,262],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CreditCard' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CreditCard"},"fix":{"range":[273,284],"text":""},"desc":"Remove unused variable \"CreditCard\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Smartphone' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Smartphone"},"fix":{"range":[283,295],"text":""},"desc":"Remove unused variable \"Smartphone\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle"},"fix":{"range":[295,308],"text":""},"desc":"Remove unused variable \"CheckCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":60,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[308,323],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShieldCheck' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":62,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":73,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ShieldCheck"},"fix":{"range":[323,336],"text":""},"desc":"Remove unused variable \"ShieldCheck\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Loader2' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":82,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Loader2"},"fix":{"range":[336,345],"text":""},"desc":"Remove unused variable \"Loader2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'step' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":36,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectedCard' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":37,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSelectedCard' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":37,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'deliveryMethod' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":38,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setDeliveryMethod' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":38,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSelectedTier' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'balance' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":43,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handlePrevStep' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":105,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":105,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'runSecurityChecks' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":109,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":109,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleSubmit' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":147,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":147,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { supabase, getSystemSettings, getCountdown } from '../lib/supabase';\r\nimport { toast } from 'sonner';\r\nimport { CASHOUT_TIERS } from '../lib/payoutConfig';\r\nimport { CreditCard, Smartphone, CheckCircle, AlertTriangle, ShieldCheck, Loader2, Lock } from 'lucide-react';\r\n\r\nimport { Link } from 'react-router-dom';\r\n\r\ninterface CashoutRequest {\r\n  id: string;\r\n  user_id: string;\r\n  requested_coins: number;\r\n  usd_value: number;\r\n  payout_method: string | null;\r\n  payout_details: string | null;\r\n  status: string;\r\n  created_at: string;\r\n  gift_card_code?: string;\r\n  gift_card_provider?: string;\r\n  delivery_method?: string;\r\n  is_held?: boolean;\r\n  held_reason?: string;\r\n  release_date?: string;\r\n  is_new_user_hold?: boolean;\r\n}\r\n\r\nconst CashoutPage: React.FC = () => {\r\n  const { user, profile } = useAuthStore();\r\n  const [loading, setLoading] = useState(false);\r\n  const [existingRequest, setExistingRequest] = useState<CashoutRequest | null>(null);\r\n  const [lockEnabled, setLockEnabled] = useState(false);\r\n  const [unlockAt, setUnlockAt] = useState<string | null>(null);\r\n  \r\n  // Wizard State\r\n  const [step, setStep] = useState(1);\r\n  const [selectedCard, setSelectedCard] = useState<'Visa' | null>(null);\r\n  const [deliveryMethod, setDeliveryMethod] = useState<'App Delivery' | null>(null);\r\n  const [selectedTier, setSelectedTier] = useState<{coins: number, usd: number} | null>(null);\r\n\r\n  const rawBalance = Number(profile?.troll_coins || 0);\r\n  const reserved = Number(profile?.reserved_troll_coins || 0);\r\n  const balance = Math.max(0, rawBalance - reserved);\r\n\r\n  useEffect(() => {\r\n    if (!user?.id) return;\r\n    const loadExisting = async () => {\r\n      const { data, error } = await supabase\r\n        .from('cashout_requests')\r\n        .select('*')\r\n        .eq('user_id', user.id)\r\n        .in('status', ['pending', 'processing', 'approved'])\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (!error && data) setExistingRequest(data as CashoutRequest);\r\n      else setExistingRequest(null);\r\n    };\r\n    void loadExisting();\r\n  }, [user?.id]);\r\n\r\n  useEffect(() => {\r\n    const loadLock = async () => {\r\n      const s = await getSystemSettings()\r\n      setLockEnabled(Boolean(s?.payout_lock_enabled))\r\n      setUnlockAt(s?.payout_unlock_at || null)\r\n    }\r\n    void loadLock()\r\n  }, [])\r\n\r\n  const handleCancel = async () => {\r\n    if (!existingRequest || !user) return;\r\n    \r\n    if (!confirm('Are you sure you want to cancel this cashout request? The reserved coins will be returned to your balance immediately.')) {\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    try {\r\n      const { error } = await supabase.rpc('cancel_cashout_request', {\r\n        p_request_id: existingRequest.id,\r\n        p_user_id: user.id\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Cashout request cancelled');\r\n      setExistingRequest(null);\r\n      // Refresh profile to update balance is handled by realtime subscription or reload\r\n      // For now, we force a reload to ensure balance is fresh\r\n      window.location.reload();\r\n    } catch (err: any) {\r\n      console.error(err);\r\n      toast.error(err?.message || 'Failed to cancel request');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleNextStep = () => {\r\n    setStep(prev => prev + 1);\r\n  };\r\n\r\n  const handlePrevStep = () => {\r\n    setStep(prev => prev - 1);\r\n  };\r\n\r\n  const runSecurityChecks = async () => {\r\n    setLoading(true);\r\n    try {\r\n      if (!profile) throw new Error('Profile not loaded');\r\n\r\n      // 1. Account Age Check (48 hours)\r\n      const created = new Date(profile.created_at || Date.now());\r\n      const ageHours = (Date.now() - created.getTime()) / (1000 * 60 * 60);\r\n      if (ageHours < 48) {\r\n        throw new Error(`Account must be at least 48 hours old to cash out. (Current: ${Math.floor(ageHours)}h)`);\r\n      }\r\n\r\n      // 2. Tax Compliance Check ($600 threshold)\r\n      if (selectedTier && selectedTier.usd >= 600) {\r\n        // Fetch latest tax status directly to be safe\r\n        const { data: taxInfo } = await supabase\r\n          .from('user_tax_info')\r\n          .select('w9_status')\r\n          .eq('user_id', user?.id)\r\n          .single();\r\n        \r\n        const isVerified = taxInfo?.w9_status === 'verified' || profile.w9_status === 'verified';\r\n        if (!isVerified) {\r\n          throw new Error('Tax form (W-9) verification is required for payouts over $600. Please complete onboarding in Settings.');\r\n        }\r\n      }\r\n\r\n      // Simulate network checks\r\n      await new Promise(resolve => setTimeout(resolve, 1500));\r\n      \r\n      handleNextStep();\r\n    } catch (err: any) {\r\n      toast.error(err.message);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    if (!user || !profile || !selectedTier) return;\r\n    if (lockEnabled) {\r\n      toast.error('Payouts are locked during Launch Trial Mode.')\r\n      return\r\n    }\r\n    \r\n    setLoading(true);\r\n    try {\r\n      const { error } = await supabase.rpc('submit_cashout_request', {\r\n        p_user_id: user.id,\r\n        p_amount_coins: selectedTier.coins,\r\n        p_usd_value: selectedTier.usd,\r\n        p_provider: 'Visa',\r\n        p_delivery_method: 'App Delivery'\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Cashout request submitted successfully');\r\n      handleNextStep(); // Go to Step 7\r\n    } catch (err: any) {\r\n      console.error(err);\r\n      toast.error(err?.message || 'Failed to submit cashout request');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (lockEnabled) {\r\n    const c = getCountdown(unlockAt)\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white flex justify-center px-4 py-8\">\r\n        <div className=\"w-full max-w-xl bg-[#0B0B12] rounded-2xl border border-yellow-500 p-6 text-center\">\r\n          <h1 className=\"text-2xl font-bold mb-4\">Payouts are locked</h1>\r\n          <p className=\"text-yellow-300 mb-4\">Unlocks in {c.days}d {c.hours}h {c.minutes}m {c.seconds}s</p>\r\n          <p className=\"text-gray-300\">Payouts are locked during the 2-week launch trial. Unlocks when the trial ends.</p>\r\n          <Link to=\"/payout-status\" className=\"text-purple-400 hover:text-purple-300 underline text-sm mt-4 inline-block\">\r\n            View Launch Trial Status\r\n          </Link>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (existingRequest) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white flex justify-center px-4 py-8\">\r\n        <div className=\"w-full max-w-xl bg-[#0B0B12] rounded-2xl border border-purple-500 p-6 shadow-[0_0_25px_rgba(147,51,234,0.5)] text-center\">\r\n          <h1 className=\"text-2xl font-bold mb-4\">Active Cashout Request</h1>\r\n          <div className=\"p-4 bg-yellow-900/20 border border-yellow-500/50 rounded-xl mb-6\">\r\n            <div className=\"text-3xl font-bold text-yellow-400 mb-2\">\r\n              ${existingRequest.usd_value.toFixed(2)}\r\n            </div>\r\n            <div className=\"text-sm text-gray-300\">\r\n              via {existingRequest.gift_card_provider || existingRequest.payout_method} ({existingRequest.delivery_method || 'App Delivery'})\r\n            </div>\r\n            <div className=\"mt-4 inline-block px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-300 text-sm font-bold uppercase\">\r\n              {existingRequest.status}\r\n            </div>\r\n          </div>\r\n\r\n          {existingRequest.is_held && (\r\n            <div className=\"bg-orange-900/20 border border-orange-500/50 rounded-xl p-4 mb-6 text-left\">\r\n                <h3 className=\"text-orange-400 font-bold flex items-center gap-2 mb-2\">\r\n                    <Lock className=\"w-4 h-4\" />\r\n                    Request On Hold\r\n                </h3>\r\n                <p className=\"text-sm text-gray-300 mb-2\">\r\n                    Your payout request is currently on hold.\r\n                    {existingRequest.is_new_user_hold && \" (New User Security Hold)\"}\r\n                </p>\r\n                {existingRequest.release_date && (\r\n                    <p className=\"text-xs text-orange-300\">\r\n                        Estimated Release: {new Date(existingRequest.release_date).toLocaleDateString()}\r\n                    </p>\r\n                )}\r\n                {existingRequest.held_reason && !existingRequest.is_new_user_hold && (\r\n                    <p className=\"text-xs text-gray-400 mt-1\">\r\n                        Reason: {existingRequest.held_reason}\r\n                    </p>\r\n                )}\r\n            </div>\r\n          )}\r\n\r\n          <p className=\"text-gray-400 text-sm mb-6\">\r\n            Your request is being processed. You will receive a notification when your payout is ready.\r\n          </p>\r\n\r\n          {existingRequest.status === 'pending' && (\r\n            <button\r\n              onClick={handleCancel}\r\n              disabled={loading}\r\n              className=\"mb-6 w-full py-2 bg-red-900/30 hover:bg-red-900/50 text-red-400 border border-red-900 rounded-lg text-sm font-medium transition-all\"\r\n            >\r\n              {loading ? 'Cancelling...' : 'Cancel Request & Refund Coins'}\r\n            </button>\r\n          )}\r\n\r\n          <Link to=\"/wallet\" className=\"text-purple-400 hover:text-purple-300 underline text-sm\">\r\n            Back to Wallet\r\n          </Link>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white flex justify-center px-4 py-8\">\r\n      <div className=\"w-full max-w-xl bg-[#0B0B12] rounded-2xl border border-purple-500 p-6 shadow-[0_0_25px_rgba(147,51,234,0.5)] text-center\">\r\n        <h1 className=\"text-2xl font-bold mb-4\">Request Payout</h1>\r\n        <p className=\"text-gray-300 text-sm mb-4\">\r\n          PayPal payouts are processed 2 times a week (Monday and Fridays).\r\n        </p>\r\n        <p className=\"text-gray-400 text-sm mb-6\">\r\n          Please use the new Payout Request page to submit your request.\r\n        </p>\r\n        <Link\r\n          to=\"/payouts/request\"\r\n          className=\"inline-flex items-center justify-center px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-sm font-semibold\"\r\n        >\r\n          Go to Payout Request\r\n        </Link>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CashoutPage;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Cashouts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Changelog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ChurchPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[212,219],"text":""},"desc":"Remove unused variable \"Users\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":61,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[233,248],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleGift' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":65,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport React, { useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuthStore } from '@/lib/store';\nimport { supabase } from '@/lib/supabase';\nimport { BookOpen, Clock, Users, Gift, Shield, AlertTriangle, Calendar, Info, Loader2 } from 'lucide-react';\nimport DailyPassage from '@/components/church/DailyPassage';\nimport PrayerFeed from '@/components/church/PrayerFeed';\nimport { useCoins } from '@/lib/hooks/useCoins';\nimport { toast } from 'sonner';\n\nexport default function ChurchPage() {\n  const { profile } = useAuthStore();\n  const navigate = useNavigate();\n  const { spendCoins, balances } = useCoins();\n  const [isOpen, setIsOpen] = useState(false);\n  const [isSunday, setIsSunday] = useState(false);\n  const [timeUntilOpen, setTimeUntilOpen] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [pastorId, setPastorId] = useState<string | null>(null);\n\n  // Hooks must be called unconditionally at the top level\n  useEffect(() => {\n    checkTime();\n    const interval = setInterval(checkTime, 60000); // Check every minute\n    return () => clearInterval(interval);\n  }, []);\n\n  useEffect(() => {\n    if (isSunday && isOpen) {\n       fetchActivePastor();\n    }\n  }, [isSunday, isOpen]);\n\n  if (!profile) {\n    return (\n      <div className=\"min-h-screen bg-slate-950 flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500\"></div>\n      </div>\n    )\n  }\n\n  const fetchActivePastor = async () => {\n      // 1. Check sermon notes for today\n      const today = new Date().toISOString().split('T')[0];\n      const { data: notes } = await supabase.from('church_sermon_notes').select('pastor_id').eq('date', today).maybeSingle();\n      \n      if (notes) {\n          setPastorId(notes.pastor_id);\n          return;\n      }\n      \n      // 2. Fallback: Any pastor\n      const { data: pastor } = await supabase.from('user_profiles').select('id').eq('is_pastor', true).limit(1).maybeSingle();\n      if (pastor) {\n          setPastorId(pastor.id);\n          return;\n      }\n\n      // 3. Fallback: Any admin\n      const { data: admin } = await supabase.from('user_profiles').select('id').eq('role', 'admin').limit(1).maybeSingle();\n      if (admin) setPastorId(admin.id);\n  };\n\n  const handleGift = async () => {\n      if (!pastorId || !profile) return;\n      \n      const amount = 50; // Fixed amount or prompt? Let's use fixed 50 for simplicity\n      if (balances.troll_coins < amount) {\n          toast.error(`Not enough coins! Need ${amount}.`);\n          return;\n      }\n\n      const success = await spendCoins({\n          senderId: profile.id,\n          receiverId: pastorId,\n          amount: amount,\n          source: 'church_gift',\n          item: 'Sunday Service Offering'\n      });\n\n      if (success) {\n          toast.success(`Offering sent! (+${amount} coins)`);\n      }\n  };\n\n\n  const checkTime = () => {\n    const now = new Date();\n    const day = now.getDay(); // 0 is Sunday\n    const hours = now.getHours();\n    \n    // Church is open 1 PM (13:00) to 3 PM (15:00)\n    const isOpenNow = hours >= 13 && hours < 15;\n    \n    setIsOpen(isOpenNow);\n    setIsSunday(day === 0);\n    \n    if (!isOpenNow) {\n       // Calculate time until next opening\n       const nextOpen = new Date();\n       nextOpen.setHours(13, 0, 0, 0);\n       \n       if (hours >= 15) {\n          // Already closed for today, open tomorrow\n          nextOpen.setDate(nextOpen.getDate() + 1);\n       }\n       \n       const diff = nextOpen.getTime() - now.getTime();\n       const daysLeft = Math.floor(diff / (1000 * 60 * 60 * 24));\n       const hoursLeft = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n       const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n       \n       let timeString = '';\n       if (daysLeft > 0) timeString += `${daysLeft}d `;\n       timeString += `${hoursLeft}h ${minutesLeft.toString().padStart(2, '0')}m`;\n       \n       setTimeUntilOpen(timeString);\n    }\n    setLoading(false);\n  };\n\n  if (loading) return <div className=\"flex h-screen items-center justify-center\"><Loader2 className=\"animate-spin\" /></div>;\n\n  return (\n    <div className=\"min-h-screen bg-slate-950 text-white p-4 md:p-8 pb-24\">\n      {/* Header */}\n      <div className=\"max-w-4xl mx-auto space-y-8\">\n         <header className=\"text-center space-y-4\">\n            <div className=\"inline-flex items-center justify-center p-3 bg-purple-900/30 rounded-full mb-4 ring-1 ring-purple-500/50 shadow-[0_0_20px_rgba(168,85,247,0.4)]\">\n               <BookOpen size={32} className=\"text-purple-400\" />\n            </div>\n            <h1 className=\"text-4xl md:text-5xl font-black tracking-tight bg-gradient-to-r from-purple-200 via-white to-purple-200 bg-clip-text text-transparent\">\n               Troll Church\n            </h1>\n            <p className=\"text-lg text-purple-200/60 max-w-2xl mx-auto\">\n               A sanctuary for reflection, community, and daily inspiration.\n            </p>\n            \n            {/* Status Banner */}\n            <div className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold border ${\n               isOpen \n                 ? isSunday \n                    ? 'bg-amber-500/20 border-amber-500/50 text-amber-200 animate-pulse'\n                    : 'bg-emerald-500/20 border-emerald-500/50 text-emerald-200'\n                 : 'bg-zinc-800 border-zinc-700 text-zinc-400'\n            }`}>\n               {isOpen ? (\n                  <>\n                     <span className=\"relative flex h-2 w-2\">\n                       <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-current opacity-75\"></span>\n                       <span className=\"relative inline-flex rounded-full h-2 w-2 bg-current\"></span>\n                     </span>\n                     SUNDAY SERVICE LIVE\n                  </>\n               ) : (\n                  <>\n                     <Clock size={14} className=\"text-purple-400\" />\n                     <span className=\"opacity-90\">CLOSED ‚Ä¢ OPENS IN {timeUntilOpen}</span>\n                  </>\n               )}\n            </div>\n         </header>\n\n         {/* Sunday Service Special Banner */}\n         {isSunday && isOpen && (\n            <div className=\"bg-gradient-to-r from-amber-900/40 via-purple-900/40 to-amber-900/40 border border-amber-500/30 p-6 rounded-2xl text-center relative overflow-hidden\">\n               <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-50\"></div>\n               <h2 className=\"text-2xl font-bold text-amber-100 mb-2 flex items-center justify-center gap-2\">\n                  <Gift className=\"text-amber-400\" />\n                  Sunday Service is Live!\n               </h2>\n               <p className=\"text-amber-200/80 mb-4\">\n                  Join the pastor and the community for our weekly gathering. Gifts are enabled!\n               </p>\n               {/* Gift Button logic could go here */}\n            </div>\n         )}\n\n         {/* Daily Passage */}\n         <section>\n            <DailyPassage />\n         </section>\n\n         {/* Content Grid */}\n         <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n            {/* Main Feed */}\n            <div className=\"lg:col-span-2\">\n               <PrayerFeed isOpen={isOpen} />\n            </div>\n\n            {/* Sidebar Info */}\n            <div className=\"space-y-6\">\n               <div className=\"bg-zinc-900/50 border border-zinc-800 p-5 rounded-2xl\">\n                  <h3 className=\"font-bold text-white mb-4 flex items-center gap-2\">\n                     <Info size={18} className=\"text-blue-400\" />\n                     Church Info\n                  </h3>\n                  <ul className=\"space-y-3 text-sm text-gray-400\">\n                     <li className=\"flex items-start gap-3\">\n                        <Clock size={16} className=\"mt-0.5 shrink-0\" />\n                        <span>Open Sundays: 1 PM ‚Äì 3 PM</span>\n                     </li>\n                     <li className=\"flex items-start gap-3\">\n                        <Calendar size={16} className=\"mt-0.5 shrink-0\" />\n                        <span>Sunday Service: Special broadcast & gifting enabled.</span>\n                     </li>\n                     <li className=\"flex items-start gap-3\">\n                        <Shield size={16} className=\"mt-0.5 shrink-0\" />\n                        <span>Moderated by Pastors & Officers. Please be respectful.</span>\n                     </li>\n                  </ul>\n               </div>\n\n               {/* Badge Promo */}\n               <div className=\"bg-gradient-to-br from-purple-900/20 to-indigo-900/20 border border-purple-500/20 p-5 rounded-2xl text-center\">\n                  <div className=\"w-12 h-12 bg-purple-900/50 rounded-full flex items-center justify-center mx-auto mb-3 border border-purple-500/30\">\n                     <BookOpen className=\"text-purple-300\" size={20} />\n                  </div>\n                  <h3 className=\"font-bold text-white mb-1\">Church Attendee</h3>\n                  <p className=\"text-xs text-gray-400 mb-3\">Visit or participate to earn this badge.</p>\n               </div>\n               \n               {/* Pastor Dashboard Link (only for pastors) */}\n               {(profile?.is_pastor || profile?.role === 'admin' || (profile as any)?.is_admin) && (\n                  <div className=\"bg-zinc-800/50 border border-zinc-700 p-4 rounded-xl\">\n                     <h3 className=\"font-bold text-white mb-2\">Pastor Controls</h3>\n                     <button \n                        onClick={() => navigate('/church/pastor')}\n                        className=\"w-full py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm font-medium transition-colors\"\n                     >\n                        Open Dashboard\n                     </button>\n                  </div>\n               )}\n            </div>\n         </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CityHall.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profile' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":23,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":24,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":37,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":55},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'queueError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":45,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { useAuthStore } from '../lib/store';\nimport { supabase } from '../lib/supabase';\nimport { toast } from 'sonner';\nimport { Building2, Crown, Users, Clock, ArrowRight } from 'lucide-react';\nimport { useNavigate } from 'react-router-dom';\n\ninterface AdminQueueItem {\n    user_id: string;\n    username: string;\n    joined_at: string;\n    status: string;\n    position: number;\n}\n\ninterface CurrentAdmin {\n    user_id: string;\n    username: string;\n    started_at: string;\n}\n\nexport default function CityHall() {\n    const { user, profile } = useAuthStore();\n    const navigate = useNavigate();\n    const [queue, setQueue] = useState<AdminQueueItem[]>([]);\n    const [currentAdmin, setCurrentAdmin] = useState<CurrentAdmin | null>(null);\n    const [loading, setLoading] = useState(false);\n    const [joining, setJoining] = useState(false);\n\n    useEffect(() => {\n        fetchData();\n    }, []);\n\n    const fetchData = async () => {\n        setLoading(true);\n        // Fetch Current Admin\n        const { data: currentData, error: currentError } = await supabase.rpc('get_current_admin_week');\n        if (currentData && currentData.length > 0) {\n            setCurrentAdmin(currentData[0]);\n        } else {\n            setCurrentAdmin(null);\n        }\n\n        // Fetch Queue\n        const { data: queueData, error: queueError } = await supabase.rpc('get_admin_queue');\n        if (queueData) {\n            setQueue(queueData);\n        }\n        setLoading(false);\n    };\n\n    const handleJoinQueue = async () => {\n        if (!user) return;\n        if (!confirm('Join the \"Admin for a Week\" queue for 100,000 coins?')) return;\n\n        setJoining(true);\n        try {\n            const { data, error } = await supabase.rpc('join_admin_queue');\n            \n            if (error) throw error;\n            if (data && !data.success) {\n                throw new Error(data.error || 'Failed to join queue');\n            }\n\n            toast.success('You have joined the Admin Queue!');\n            fetchData();\n        } catch (err: any) {\n            toast.error(err.message);\n        } finally {\n            setJoining(false);\n        }\n    };\n\n    return (\n        <div className=\"min-h-screen bg-[#0A0814] text-white p-4 pb-20 md:pb-4 md:ml-64\">\n            <div className=\"max-w-4xl mx-auto space-y-8\">\n                \n                {/* Header */}\n                <div className=\"flex items-center gap-4 border-b border-white/10 pb-6\">\n                    <div className=\"p-4 bg-purple-500/20 rounded-2xl\">\n                        <Building2 className=\"w-10 h-10 text-purple-400\" />\n                    </div>\n                    <div>\n                        <h1 className=\"text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent\">\n                            Troll City Hall\n                        </h1>\n                        <p className=\"text-gray-400 mt-1\">\n                            The seat of temporary power. Rule the city for a week.\n                        </p>\n                    </div>\n                </div>\n\n                {/* Current Admin Section */}\n                <div className=\"grid md:grid-cols-2 gap-6\">\n                    <div className=\"bg-gradient-to-br from-yellow-900/20 to-yellow-900/5 border border-yellow-500/30 rounded-2xl p-6 relative overflow-hidden\">\n                        <div className=\"absolute top-0 right-0 p-4 opacity-10\">\n                            <Crown className=\"w-32 h-32\" />\n                        </div>\n                        \n                        <div className=\"relative z-10\">\n                            <h2 className=\"text-yellow-500 font-bold uppercase tracking-wider text-sm mb-4 flex items-center gap-2\">\n                                <Crown className=\"w-4 h-4\" /> Current Admin of the Week\n                            </h2>\n                            \n                            {loading ? (\n                                <div className=\"animate-pulse h-16 bg-white/5 rounded-xl\"></div>\n                            ) : currentAdmin ? (\n                                <div className=\"flex items-center gap-4\">\n                                    <div className=\"w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center text-black font-bold text-2xl\">\n                                        {currentAdmin.username.substring(0, 2).toUpperCase()}\n                                    </div>\n                                    <div>\n                                        <div className=\"text-2xl font-bold text-white\">{currentAdmin.username}</div>\n                                        <div className=\"text-sm text-yellow-500/70 flex items-center gap-1\">\n                                            <Clock className=\"w-3 h-3\" />\n                                            Reign started: {new Date(currentAdmin.started_at).toLocaleDateString()}\n                                        </div>\n                                    </div>\n                                </div>\n                            ) : (\n                                <div className=\"text-center py-8 text-gray-500\">\n                                    No Admin currently seated.\n                                </div>\n                            )}\n                        </div>\n                    </div>\n\n                    {/* Join Queue CTA */}\n                    <div className=\"bg-gradient-to-br from-purple-900/20 to-purple-900/5 border border-purple-500/30 rounded-2xl p-6 flex flex-col justify-between\">\n                        <div>\n                            <h2 className=\"text-purple-400 font-bold uppercase tracking-wider text-sm mb-2 flex items-center gap-2\">\n                                <Users className=\"w-4 h-4\" /> Join the Queue\n                            </h2>\n                            <p className=\"text-gray-400 text-sm mb-4\">\n                                Become an Admin for 7 days. Gain special moderation powers and a badge.\n                            </p>\n                            <div className=\"text-3xl font-bold text-white mb-1\">\n                                100,000 <span className=\"text-sm text-purple-400 font-normal\">Coins</span>\n                            </div>\n                        </div>\n\n                        <button \n                            onClick={handleJoinQueue}\n                            disabled={joining || loading}\n                            className=\"w-full mt-4 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed text-white py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2\"\n                        >\n                            {joining ? 'Processing...' : 'Join Queue'}\n                            <ArrowRight className=\"w-4 h-4\" />\n                        </button>\n                    </div>\n                </div>\n\n                {/* Queue List */}\n                <div className=\"bg-[#121212] border border-white/5 rounded-2xl overflow-hidden\">\n                    <div className=\"p-4 border-b border-white/5 flex items-center justify-between\">\n                        <h3 className=\"font-bold text-white flex items-center gap-2\">\n                            <Clock className=\"w-4 h-4 text-gray-400\" /> Waiting List\n                        </h3>\n                        <span className=\"text-xs text-gray-500\">{queue.length} in line</span>\n                    </div>\n\n                    <div className=\"divide-y divide-white/5\">\n                        {loading ? (\n                            [1,2,3].map(i => (\n                                <div key={i} className=\"p-4 animate-pulse flex items-center gap-4\">\n                                    <div className=\"w-8 h-8 bg-white/10 rounded-full\"></div>\n                                    <div className=\"h-4 bg-white/10 rounded w-32\"></div>\n                                </div>\n                            ))\n                        ) : queue.length === 0 ? (\n                            <div className=\"p-8 text-center text-gray-500\">\n                                The queue is empty. Be the next Admin!\n                            </div>\n                        ) : (\n                            queue.map((item) => (\n                                <div key={item.user_id} className=\"p-4 flex items-center justify-between hover:bg-white/5 transition-colors\">\n                                    <div className=\"flex items-center gap-4\">\n                                        <div className=\"w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center text-xs font-bold text-gray-400\">\n                                            #{item.position}\n                                        </div>\n                                        <div>\n                                            <div className=\"font-medium text-white\">{item.username}</div>\n                                            <div className=\"text-xs text-gray-500\">Joined {new Date(item.joined_at).toLocaleDateString()}</div>\n                                        </div>\n                                    </div>\n                                    {item.user_id === user?.id && (\n                                        <div className=\"px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded border border-purple-500/30\">\n                                            YOU\n                                        </div>\n                                    )}\n                                </div>\n                            ))\n                        )}\n                    </div>\n                </div>\n\n                {/* Info Section */}\n                <div className=\"grid md:grid-cols-3 gap-4 text-sm text-gray-400\">\n                    <div className=\"p-4 bg-white/5 rounded-xl border border-white/5\">\n                        <h4 className=\"font-bold text-white mb-2\">Duration</h4>\n                        <p>Each term lasts exactly 7 days. If the current admin is removed early, the next person in line takes over immediately.</p>\n                    </div>\n                    <div className=\"p-4 bg-white/5 rounded-xl border border-white/5\">\n                        <h4 className=\"font-bold text-white mb-2\">Powers</h4>\n                        <p>Access to kick, mute, and ban (24h) controls. You can also host city-wide events.</p>\n                    </div>\n                    <div className=\"p-4 bg-white/5 rounded-xl border border-white/5\">\n                        <h4 className=\"font-bold text-white mb-2\">Rules</h4>\n                        <p>Abuse of power will result in immediate removal and a permanent ban from the Admin Queue. No refunds.</p>\n                    </div>\n                </div>\n\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CoinStore.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'SAMPLE_CHAT_SOUNDS'. Either include it or remove the dependency array.","line":430,"column":6,"nodeType":"ArrayExpression","endLine":430,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [user.id, refreshCoins, SAMPLE_CHAT_SOUNDS]","fix":{"range":[21120,21144],"text":"[user.id, refreshCoins, SAMPLE_CHAT_SOUNDS]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":1240,"column":103,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[53263,53287],"text":"All Users&apos; Credit Scores"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[53263,53287],"text":"All Users&lsquo; Credit Scores"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[53263,53287],"text":"All Users&#39; Credit Scores"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[53263,53287],"text":"All Users&rsquo; Credit Scores"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":1413,"column":111,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[65639,65659],"text":"Why you can&apos;t apply:"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[65639,65659],"text":"Why you can&lsquo;t apply:"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[65639,65659],"text":"Why you can&#39;t apply:"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[65639,65659],"text":"Why you can&rsquo;t apply:"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is defined but never used. Allowed unused args must match /^_/u.","line":1497,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":1497,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'actions' is defined but never used. Allowed unused args must match /^_/u.","line":1497,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":1497,"endColumn":54},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is defined but never used. Allowed unused args must match /^_/u.","line":1554,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":1554,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'actions' is defined but never used. Allowed unused args must match /^_/u.","line":1554,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":1554,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":1810,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":1810,"endColumn":51}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { PayPalScriptProvider, PayPalButtons } from '@paypal/react-paypal-js';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuthStore } from '@/lib/store';\r\nimport { useCoins } from '@/lib/hooks/useCoins';\r\nimport { useBank as useBankHook } from '../lib/hooks/useBank';\r\nimport { useAllCreditScores } from '../lib/hooks/useAllCreditScores';\r\n// import { toast } from 'sonner';\r\nimport { Coins, ShoppingCart, CreditCard, Landmark, History, CheckCircle, AlertCircle } from 'lucide-react';\r\nimport { formatCoins } from '../lib/coinMath';\r\nimport { deductCoins } from '@/lib/coinTransactions';\r\nimport { useLiveContextStore } from '../lib/liveContextStore';\r\nimport { useCheckOfficerOnboarding } from '@/hooks/useCheckOfficerOnboarding';\r\n\r\nimport CashAppPaymentModal from '@/components/broadcast/CashAppPaymentModal';\r\nimport TrollPassBanner from '@/components/ui/TrollPassBanner';\r\nimport { paymentProviders } from '../lib/payments';\r\nimport { toast } from 'sonner';\r\n\r\nconst coinPackages = [\r\n  { id: 'pkg-1000-promo', coins: 1000, price: \"$0.10\", emoji: \"üíé\", popular: true, promo: true, expiresAt: new Date('2026-01-28T00:51:27Z').getTime() },\r\n  { id: 1, coins: 300, price: \"$1.99\", emoji: \"üí∞\", popular: true },\r\n  { id: 2, coins: 500, price: \"$4.99\", emoji: \"üí∞\", popular: true },\r\n  { id: 3, coins: 1000, price: \"$9.99\", emoji: \"üíé\" },\r\n  { id: 4, coins: 2500, price: \"$19.99\", emoji: \"üëë\" },\r\n  { id: 5, coins: 5000, price: \"$39.99\", emoji: \"üöÄ\" },\r\n  { id: 6, coins: 10000, price: \"$69.99\", emoji: \"‚≠ê\", bestValue: true },\r\n  { id: 7, coins: 13000, price: \"$89.99\", emoji: \"üåü\" },\r\n  { id: 8, coins: 20000, price: \"$129.00\", emoji: \"üèÜ\" },\r\n].filter(p => !p.expiresAt || Date.now() < p.expiresAt);\r\n\r\nconst SAMPLE_EFFECTS = [\r\n  { id: 'effect_confetti_pop', name: 'Confetti Pop', description: 'Confetti burst', coin_cost: 1000 },\r\n  { id: 'effect_neon_flash', name: 'Neon Flash', description: 'Quick neon glow wave', coin_cost: 1500 },\r\n  { id: 'effect_smoke_drift', name: 'Smoke Drift', description: 'Soft fog trail', coin_cost: 2000 },\r\n  { id: 'effect_glitter_steps', name: 'Glitter Steps', description: 'Glitter trail follows', coin_cost: 2500 },\r\n  { id: 'effect_pixel_burst', name: 'Pixel Burst', description: 'Retro pixel explosion', coin_cost: 3000 },\r\n  { id: 'effect_bubble_bounce', name: 'Bubble Bounce', description: 'Floating bubble pops', coin_cost: 3500 },\r\n  { id: 'effect_snowfall_drop', name: 'Snowfall Drop', description: 'Snowflakes fall briefly', coin_cost: 4000 },\r\n];\r\n\r\nconst SAMPLE_PERKS = [\r\n  { id: 'perk_rgb_username', name: 'RGB Username (24h)', description: 'Rainbow glow visible to everyone', cost: 450, duration_minutes: 24 * 60, perk_type: 'cosmetic' },\r\n  { id: 'perk_disappearing_chats', name: 'Disappearing Chats (30m)', description: 'Chats auto-hide after 10s for 30 minutes', cost: 190, duration_minutes: 30, perk_type: 'chat' },\r\n  { id: 'perk_ghost_mode', name: 'Ghost Mode (30m)', description: 'View streams in stealth without status indicators', cost: 560, duration_minutes: 30, perk_type: 'privacy' },\r\n  { id: 'perk_message_admin', name: 'Message Admin (Officer Only)', description: 'Unlock DM to Admin', cost: 230, duration_minutes: 24 * 60, perk_type: 'access', role_required: 'officer' },\r\n  { id: 'perk_glowing_username', name: 'Glowing Username (1h)', description: 'Neon glow in all chats & gift animations', cost: 5750, duration_minutes: 60, perk_type: 'cosmetic' },\r\n  { id: 'perk_slowmo_chat', name: 'Slow-Motion Chat Control (5h)', description: 'Activate chat slow-mode in any live stream', cost: 3600, duration_minutes: 5 * 60, perk_type: 'control' },\r\n  { id: 'perk_troll_alarm', name: 'Troll Alarm Arrival (100h)', description: 'Sound + flash announces your arrival', cost: 3000, duration_minutes: 100 * 60, perk_type: 'entrance' },\r\n  { id: 'perk_ban_shield', name: 'Ban Shield (2h)', description: 'Immunity from kick, mute, or ban for 2 hours', cost: 1660, duration_minutes: 2 * 60, perk_type: 'protection' },\r\n  { id: 'perk_double_xp', name: 'Double XP Mode (1h)', description: 'Earn 2x XP for the next hour', cost: 780, duration_minutes: 60, perk_type: 'boost' },\r\n  { id: 'perk_golden_banner', name: 'Golden Flex Banner (100h)', description: 'Golden crown banner on all your messages', cost: 3390, duration_minutes: 100 * 60, perk_type: 'cosmetic' },\r\n  { id: 'perk_troll_spell', name: 'Troll Spell (1h)', description: \"Randomly change another user's username style & emoji for 1 hour\", cost: 2240, duration_minutes: 60, perk_type: 'fun' },\r\n];\r\n\r\nconst SAMPLE_INSURANCE_PLANS = [\r\n  { id: 'insurance_basic_week', name: 'Basic Coverage', description: '-10% gambling loss, covers 10,000 coins/week', cost: 8000, duration_hours: 168, protection_type: 'gambling' },\r\n  { id: 'insurance_basic_month', name: 'Basic Monthly', description: '-10% gambling loss, covers 50,000 coins/month', cost: 25000, duration_hours: 720, protection_type: 'gambling' },\r\n  { id: 'insurance_vip_week', name: 'VIP Coverage', description: '-25% loss + 1 penalty block/week', cost: 18000, duration_hours: 168, protection_type: 'penalty' },\r\n  { id: 'insurance_vip_month', name: 'VIP Monthly', description: '-25% loss + 4 penalty blocks/month', cost: 60000, duration_hours: 720, protection_type: 'penalty' },\r\n  { id: 'insurance_elite_week', name: 'Elite Coverage', description: '-40% loss + dispute help', cost: 45000, duration_hours: 168, protection_type: 'dispute' },\r\n  { id: 'insurance_elite_month', name: 'Elite Monthly', description: '-40% loss + 8 penalty blocks', cost: 150000, duration_hours: 720, protection_type: 'dispute' },\r\n  { id: 'insurance_supreme_week', name: 'Supreme Court Shield', description: '-50% loss + unlimited disputes', cost: 120000, duration_hours: 168, protection_type: 'supreme' },\r\n  { id: 'insurance_supreme_month', name: 'Supreme Monthly Shield', description: '-50% loss + 20 penalty blocks/month', cost: 300000, duration_hours: 720, protection_type: 'supreme' },\r\n];\r\n\r\nconst isMissingTableError = (error) =>\r\n  Boolean(\r\n    error?.message?.includes('schema cache') ||\r\n      error?.message?.includes('Could not find the table') ||\r\n      error?.message?.includes('relation') ||\r\n      error?.message?.includes('does not exist'),\r\n  );\r\n\r\nexport default function CoinStore() {\r\n  const { user, profile, refreshProfile } = useAuthStore();\r\n  const { scores: allCreditScores, loading: loadingScores } = useAllCreditScores(user?.id);\r\n  const navigate = useNavigate();\r\n  const { troll_coins, refreshCoins } = useCoins();\r\n  const { checkOnboarding } = useCheckOfficerOnboarding();\r\n  const { loans: activeLoans, ledger, refresh: refreshBank, applyForLoan, payLoan, tiers } = useBankHook(); // useBank hook\r\n\r\n  const STORE_TAB_KEY = 'tc-store-active-tab';\r\n  const STORE_COMPLETE_KEY = 'tc-store-show-complete';\r\n  const [loading, setLoading] = useState(true);\r\n  const [loadingPackage, setLoadingPackage] = useState(null);\r\n  const [tab, setTab] = useState('coins');\r\n  \r\n  // Bank State\r\n  const [bankBalance] = useState(null);\r\n  const [showActiveLoanModal, setShowActiveLoanModal] = useState(false);\r\n  const [applying, setApplying] = useState(false);\r\n  const [payAmount, setPayAmount] = useState('');\r\n  const [paying, setPaying] = useState(false);\r\n  const [requestedAmount, setRequestedAmount] = useState(100);\r\n  const [eligibility, setEligibility] = useState({\r\n    canApply: false,\r\n    reasons: [],\r\n    maxAmount: 0\r\n  });\r\n\r\n  const handlePayLoan = async () => {\r\n    const activeLoan = activeLoans && activeLoans.length > 0 ? activeLoans[0] : null;\r\n    if (!activeLoan || !payAmount) return;\r\n    const amount = parseInt(payAmount);\r\n    if (isNaN(amount) || amount <= 0) {\r\n      toast.error('Invalid amount');\r\n      return;\r\n    }\r\n    \r\n    setPaying(true);\r\n    try {\r\n      const result = await payLoan(activeLoan.id, amount);\r\n      if (result.success) {\r\n        setPayAmount('');\r\n        refreshCoins(); // Update user coin balance in UI\r\n      }\r\n    } catch (err) {\r\n      console.error('Payment error:', err);\r\n    } finally {\r\n      setPaying(false);\r\n    }\r\n  };\r\n\r\n\r\n  // Calculate Loan Eligibility\r\n  useEffect(() => {\r\n    // DEBUG: Check if coin_packages table is accessible\r\n    const debugLoadPackages = async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coin_packages\")\r\n        .select(\"*\");\r\n\r\n      console.log(\"coin packages data:\", data);\r\n      console.log(\"coin packages error:\", error);\r\n\r\n      if (error) throw error;\r\n    };\r\n    debugLoadPackages();\r\n\r\n    if (!user || !tiers.length) return;\r\n\r\n    const reasons = [];\r\n    let maxAmount = 0;\r\n    \r\n    // 1. Check active loan\r\n    if (activeLoans && activeLoans.length > 0) {\r\n      reasons.push('You already have an active loan.');\r\n    }\r\n\r\n    // 2. Calculate Max Amount based on Tenure\r\n    const accountAgeDays = Math.floor((new Date() - new Date(user.created_at)) / (1000 * 60 * 60 * 24));\r\n    \r\n    // Find highest tier matching tenure\r\n    const eligibleTier = tiers\r\n      .filter(t => t.min_tenure_days <= accountAgeDays)\r\n      .sort((a, b) => b.min_tenure_days - a.min_tenure_days)[0];\r\n\r\n    if (eligibleTier) {\r\n      maxAmount = eligibleTier.max_loan_coins;\r\n    } else {\r\n      reasons.push('Account too new for loan eligibility.');\r\n    }\r\n\r\n    setEligibility({\r\n      canApply: reasons.length === 0 && maxAmount > 0,\r\n      reasons,\r\n      maxAmount\r\n    });\r\n  }, [user, activeLoans, tiers]);\r\n\r\n  const [selectedPackage, setSelectedPackage] = useState(null);\r\n  const [cashAppModalOpen, setCashAppModalOpen] = useState(false);\r\n  // Default to CashApp as the payment provider (PayPal temporarily disabled)\r\n  const [selectedProviderId, setSelectedProviderId] = useState('cashapp');\r\n  const [loadingPay, setLoadingPay] = useState(false);\r\n  const [durationMultiplier, setDurationMultiplier] = useState(1);\r\n  const [effects, setEffects] = useState([]);\r\n  const [perks, setPerks] = useState([]);\r\n  const [plans, setPlans] = useState([]);\r\n  const [broadcastThemes, setBroadcastThemes] = useState([]);\r\n  const [ownedThemeIds, setOwnedThemeIds] = useState(new Set());\r\n  const [themesNote, setThemesNote] = useState(null);\r\n  const [themePurchasing, setThemePurchasing] = useState(null);\r\n  const [callSounds, setCallSounds] = useState([]);\r\n  const [ownedCallSoundIds, setOwnedCallSoundIds] = useState(new Set());\r\n  const [activeCallSounds, setActiveCallSounds] = useState({});\r\n  const [callSoundPurchasing, setCallSoundPurchasing] = useState(null);\r\n  const [streamerEntitlements, setStreamerEntitlements] = useState(null);\r\n  const [effectsNote, setEffectsNote] = useState(null);\r\n  const [perksNote, setPerksNote] = useState(null);\r\n  const [insuranceNote, setInsuranceNote] = useState(null);\r\n  const activeStreamId = useLiveContextStore((s) => s.activeStreamId);\r\n  const [liveStreamIsLive, setLiveStreamIsLive] = useState(false);\r\n  const [snackLoading, setSnackLoading] = useState(null);\r\n  const [lastSnackAt, setLastSnackAt] = useState({});\r\n  const [showPurchaseComplete, setShowPurchaseComplete] = useState(() => {\r\n    if (typeof window === 'undefined') return false;\r\n    return Boolean(sessionStorage.getItem('tc-store-show-complete'));\r\n  });\r\n\r\n  const isAdmin = profile?.role === 'admin' || profile?.is_admin === true;\r\n  const isSecretary = profile?.role === 'secretary' || profile?.troll_role === 'secretary';\r\n  const isOfficer = profile?.role === 'troll_officer' || profile?.role === 'lead_troll_officer' || profile?.is_lead_officer === true || profile?.troll_role === 'troll_officer' || profile?.troll_role === 'lead_troll_officer';\r\n\r\n  const formatCountdown = (targetDate) => {\r\n    if (!targetDate) return null;\r\n    const diff = new Date(targetDate).getTime() - Date.now();\r\n    if (diff <= 0) return '0h';\r\n    const totalMinutes = Math.floor(diff / 60000);\r\n    const days = Math.floor(totalMinutes / 1440);\r\n    const hours = Math.floor((totalMinutes % 1440) / 60);\r\n    return days > 0 ? `${days}d ${hours}h` : `${hours}h`;\r\n  };\r\n\r\n  const getEligibility = (theme) => {\r\n    const now = Date.now();\r\n    const startsAt = theme?.starts_at ? new Date(theme.starts_at).getTime() : null;\r\n    const endsAt = theme?.ends_at ? new Date(theme.ends_at).getTime() : null;\r\n    const limitedActive = !theme?.is_limited || ((startsAt ? now >= startsAt : true) && (endsAt ? now <= endsAt : true));\r\n    const seasonalState = theme?.is_limited\r\n      ? startsAt && now < startsAt\r\n        ? `Starts in ${formatCountdown(theme.starts_at)}`\r\n        : endsAt && now > endsAt\r\n          ? 'Season ended'\r\n          : endsAt\r\n            ? `Ends in ${formatCountdown(theme.ends_at)}`\r\n            : null\r\n      : null;\r\n\r\n    const entitlements = streamerEntitlements || {};\r\n    const streamLevel = entitlements.streamer_level ?? profile?.level ?? 0;\r\n    const followersCount = entitlements.followers_count ?? 0;\r\n    const hoursStreamed = entitlements.total_hours_streamed ?? 0;\r\n    const minLevel = theme?.min_stream_level ?? null;\r\n    const minFollowers = theme?.min_followers ?? null;\r\n    const minHours = theme?.min_total_hours_streamed ?? null;\r\n\r\n    const requiresStreamer = Boolean(theme?.is_streamer_exclusive || minLevel || minFollowers || minHours);\r\n    const meetsStreamer =\r\n      (!minLevel || streamLevel >= minLevel) &&\r\n      (!minFollowers || followersCount >= minFollowers) &&\r\n      (!minHours || hoursStreamed >= minHours);\r\n\r\n    return {\r\n      limitedActive,\r\n      seasonalState,\r\n      requiresStreamer,\r\n      meetsStreamer,\r\n      isEligible: limitedActive && (!requiresStreamer || meetsStreamer),\r\n      minLevel,\r\n      minFollowers,\r\n      minHours,\r\n    };\r\n  };\r\n\r\n  const SAMPLE_CHAT_SOUNDS = [\r\n    { id: 'sound_1', name: 'Troll Laugh', cost: 100, sound_type: 'chat', file_path: '/sounds/troll.mp3' },\r\n    { id: 'sound_2', name: 'Coins', cost: 100, sound_type: 'chat', file_path: '/sounds/coins.mp3' },\r\n    { id: 'sound_3', name: 'Diamond', cost: 200, sound_type: 'chat', file_path: '/sounds/diamond.mp3' },\r\n    { id: 'sound_4', name: 'Heart', cost: 200, sound_type: 'chat', file_path: '/sounds/heart.mp3' },\r\n    { id: 'sound_5', name: 'Gold Star', cost: 300, sound_type: 'chat', file_path: '/sounds/goldstar.mp3' },\r\n    { id: 'sound_6', name: 'Rocket', cost: 300, sound_type: 'chat', file_path: '/sounds/rocket.mp3' },\r\n    { id: 'sound_7', name: 'Crown', cost: 500, sound_type: 'chat', file_path: '/sounds/crown.mp3' },\r\n    { id: 'sound_8', name: 'Car Rev', cost: 500, sound_type: 'chat', file_path: '/sounds/car.mp3' },\r\n    { id: 'sound_9', name: 'Scratch', cost: 150, sound_type: 'chat', file_path: '/sounds/scratch.mp3' },\r\n    { id: 'sound_10', name: 'Magic Wand', cost: 250, sound_type: 'chat', file_path: '/sounds/wand.mp3' },\r\n  ];\r\n\r\n  /*\r\n  const getRarityFrame = (rarity) => {\r\n    switch (String(rarity || '').toLowerCase()) {\r\n      case 'rare':\r\n        return 'border-blue-500/40 shadow-[0_0_20px_rgba(59,130,246,0.25)]';\r\n      case 'epic':\r\n        return 'border-pink-500/40 shadow-[0_0_24px_rgba(236,72,153,0.3)]';\r\n      case 'legendary':\r\n        return 'border-yellow-400/50 shadow-[0_0_28px_rgba(250,204,21,0.35)]';\r\n      default:\r\n        return 'border-white/10';\r\n    }\r\n  };\r\n  */\r\n\r\n  const showLiveSnacks = Boolean(activeStreamId && liveStreamIsLive);\r\n  const callPackages = {\r\n    audio: [\r\n      { id: 'audio_60', name: 'Base Audio', minutes: 60, totalCost: 1000 },\r\n      { id: 'audio_150', name: 'Standard Audio', minutes: 150, totalCost: 2000 },\r\n      { id: 'audio_400', name: 'Premium Audio', minutes: 400, totalCost: 5000 },\r\n      { id: 'audio_1000', name: 'Ultra Audio', minutes: 1000, totalCost: 10000 },\r\n    ],\r\n    video: [\r\n      { id: 'video_30', name: 'Base Video', minutes: 30, totalCost: 1000 },\r\n      { id: 'video_75', name: 'Standard Video', minutes: 75, totalCost: 2000 },\r\n      { id: 'video_200', name: 'Premium Video', minutes: 200, totalCost: 5000 },\r\n      { id: 'video_500', name: 'Ultra Video', minutes: 500, totalCost: 10000 },\r\n    ],\r\n  };\r\n\r\n  const getPerkPrice = (perk) => {\r\n    const base = Number(perk?.cost || 0);\r\n    if (!Number.isFinite(base) || base <= 0) return 0;\r\n\r\n    const dayKey = new Date().toISOString().slice(0, 10); // YYYY-MM-DD\r\n    const input = `${dayKey}:${perk?.id || ''}`;\r\n\r\n    // Simple deterministic hash (stable per day + perk)\r\n    let hash = 0;\r\n    for (let i = 0; i < input.length; i++) {\r\n      hash = ((hash << 5) - hash + input.charCodeAt(i)) | 0;\r\n    }\r\n\r\n    const normalized = Math.abs(hash) % 51; // 0..50\r\n    const multiplier = 0.75 + normalized / 100; // 0.75..1.25\r\n    const price = Math.round((base * multiplier) / 10) * 10;\r\n    return Math.max(10, price);\r\n  };\r\n\r\n  const loadWalletData = useCallback(async (showLoading = true) => {\r\n    console.log('?? Loading wallet data for user:', user?.id);\r\n    try {\r\n      if (showLoading) setLoading(true);\r\n\r\n      await refreshCoins();\r\n\r\n      const [effRes, perkRes, planRes, themeRes, themeOwnedRes, entitlementsRes, callSoundOwnedRes] = await Promise.all([\r\n        supabase.from('entrance_effects').select('*').order('created_at', { ascending: false }),\r\n        supabase.from('perks').select('*').order('created_at', { ascending: false }),\r\n        supabase.from('insurance_options').select('*').order('created_at', { ascending: false }),\r\n        supabase.from('broadcast_background_themes').select('*').eq('is_active', true).order('sort_order', { ascending: true }),\r\n        user?.id\r\n          ? supabase.from('user_broadcast_theme_purchases').select('theme_id').eq('user_id', user.id)\r\n          : Promise.resolve({ data: [] }),\r\n        user?.id\r\n          ? supabase.from('user_streamer_entitlements').select('*').eq('user_id', user.id).maybeSingle()\r\n          : Promise.resolve({ data: null }),\r\n        user?.id\r\n          ? supabase.from('user_call_sounds').select('sound_id,is_active,call_sound_catalog(sound_type)').eq('user_id', user.id)\r\n          : Promise.resolve({ data: [] })\r\n      ]);\r\n      const applyCatalogData = (result, fallback = [], setter, noteSetter, label) => {\r\n        if (result.error) {\r\n          const missing = isMissingTableError(result.error);\r\n          const message = missing\r\n            ? `${label} catalog is not provisioned in this environment; showing curated samples.`\r\n            : `Unable to load ${label} (${result.error.message || 'unknown error'}); showing curated samples.`;\r\n          noteSetter(message);\r\n          setter(fallback);\r\n          return fallback;\r\n        }\r\n\r\n        const items = result.data || [];\r\n        if (!items.length && fallback.length) {\r\n          noteSetter(`No ${label} are configured yet; showing curated samples instead.`);\r\n          setter(fallback);\r\n          return fallback;\r\n        }\r\n\r\n        setter(items);\r\n        if (!items.length) {\r\n          noteSetter(`No ${label} are configured yet. Please check back soon.`);\r\n        } else {\r\n          noteSetter(null);\r\n        }\r\n        return items;\r\n      };\r\n\r\n      const loadedEffects = applyCatalogData(\r\n        effRes,\r\n        SAMPLE_EFFECTS,\r\n        setEffects,\r\n        setEffectsNote,\r\n        'entrance effects',\r\n      );\r\n      const loadedPerks = applyCatalogData(\r\n        perkRes,\r\n        SAMPLE_PERKS,\r\n        setPerks,\r\n        setPerksNote,\r\n        'perks',\r\n      );\r\n      const loadedPlans = applyCatalogData(\r\n        planRes,\r\n        SAMPLE_INSURANCE_PLANS,\r\n        setPlans,\r\n        setInsuranceNote,\r\n        'insurance plans',\r\n      );\r\n\r\n      const filteredPlans = (loadedPlans || []).filter((p) => p.protection_type !== 'bankrupt');\r\n      if (filteredPlans.length !== (loadedPlans || []).length) {\r\n        setInsuranceNote((prev) => prev || 'Bankrupt insurance retired with Troll Wheel removal.');\r\n      }\r\n      setPlans(filteredPlans);\r\n\r\n      const loadedThemes = applyCatalogData(\r\n        themeRes,\r\n        [],\r\n        setBroadcastThemes,\r\n        setThemesNote,\r\n        'broadcast themes',\r\n      );\r\n\r\n      setOwnedThemeIds(new Set((themeOwnedRes?.data || []).map((row) => row.theme_id)));\r\n      setStreamerEntitlements(entitlementsRes?.data || null);\r\n      \r\n      // Load sounds\r\n      setCallSounds(SAMPLE_CHAT_SOUNDS);\r\n      const ownedSoundIds = new Set((callSoundOwnedRes?.data || []).map((row) => row.sound_id));\r\n      setOwnedCallSoundIds(ownedSoundIds);\r\n      const activeMap = {};\r\n      (callSoundOwnedRes?.data || []).forEach((row) => {\r\n        if (row.is_active) {\r\n          activeMap['chat'] = row.sound_id;\r\n        }\r\n      });\r\n      setActiveCallSounds(activeMap);\r\n\r\n      console.log('Effects, perks, plans, themes loaded:', { effects: loadedEffects.length, perks: loadedPerks.length, plans: loadedPlans.length, themes: loadedThemes.length });\r\n\r\n    } catch (err) {\r\n      console.error('? Error loading wallet data:', err);\r\n      toast.error('Failed to load wallet data');\r\n    } finally {\r\n      if (showLoading) setLoading(false);\r\n      console.log('?? Wallet data loading complete');\r\n    }\r\n  }, [user?.id, refreshCoins]);\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/auth', { replace: true });\r\n      return;\r\n    }\r\n\r\n    // Auto-scroll to top on page load\r\n    window.scrollTo(0, 0);\r\n\r\n    loadWalletData(true);\r\n  }, [user, navigate, loadWalletData]);\r\n\r\n  useEffect(() => {\r\n    let isActive = true;\r\n\r\n    const loadLive = async () => {\r\n      if (!activeStreamId) {\r\n        setLiveStreamIsLive(false);\r\n        return;\r\n      }\r\n\r\n      const { data } = await supabase\r\n        .from('streams')\r\n        .select('id,is_live')\r\n        .eq('id', activeStreamId)\r\n        .maybeSingle();\r\n\r\n      if (!isActive) return;\r\n      setLiveStreamIsLive(Boolean(data?.is_live));\r\n    };\r\n\r\n    loadLive();\r\n    return () => {\r\n      isActive = false;\r\n    };\r\n  }, [activeStreamId]);\r\n\r\n  useEffect(() => {\r\n    if (tab === 'live_snacks' && !showLiveSnacks) setTab('effects');\r\n  }, [tab, showLiveSnacks]);\r\n\r\n  useEffect(() => {\r\n    sessionStorage.setItem(STORE_TAB_KEY, tab);\r\n  }, [tab]);\r\n\r\n  const showPurchaseCompleteOverlay = () => {\r\n    sessionStorage.setItem(STORE_COMPLETE_KEY, Date.now().toString());\r\n    setShowPurchaseComplete(true);\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (!showPurchaseComplete) return;\r\n    sessionStorage.removeItem(STORE_COMPLETE_KEY);\r\n    const timer = setTimeout(() => setShowPurchaseComplete(false), 1400);\r\n    return () => clearTimeout(timer);\r\n  }, [showPurchaseComplete]);\r\n\r\n  const canBuySnack = (key) => {\r\n    const ts = lastSnackAt[key];\r\n    if (!ts) return true;\r\n    return Date.now() - ts > 30 * 1000;\r\n  };\r\n\r\n  const buySnack = async (snackKey) => {\r\n    if (!activeStreamId || !showLiveSnacks) {\r\n      toast.error('Live Snacks are only available inside a live stream');\r\n      return;\r\n    }\r\n\r\n    if (!canBuySnack(snackKey)) {\r\n      toast.error('Snack on cooldown');\r\n      return;\r\n    }\r\n\r\n    setSnackLoading(snackKey);\r\n    try {\r\n      const { data, error } = await supabase.rpc('buy_live_snack', {\r\n        p_stream_id: activeStreamId,\r\n        p_snack_key: snackKey,\r\n      });\r\n\r\n      if (error) throw error;\r\n      if (!data?.success) throw new Error(data?.error || 'Snack purchase failed');\r\n\r\n      setLastSnackAt((prev) => ({ ...prev, [snackKey]: Date.now() }));\r\n      await loadWalletData(false);\r\n\r\n      const after = Number(data?.momentum_after ?? 0);\r\n      toast.success(`Live Snack activated. Momentum: ${after}%`);\r\n      showPurchaseCompleteOverlay();\r\n    } catch (e) {\r\n      toast.error(e?.message || 'Snack purchase failed');\r\n    } finally {\r\n      setSnackLoading(null);\r\n    }\r\n  };\r\n\r\n\r\n  const formatDeductErrorMessage = (error) =>\r\n    typeof error === 'string'\r\n      ? error\r\n      : error?.message || 'Failed to deduct coins'\r\n\r\n  const buyEffect = async (effect) => {\r\n   // Check officer onboarding first\r\n   const canProceed = await checkOnboarding();\r\n   if (!canProceed) return;\r\n\r\n   try {\r\n     const price = effect.price_troll_coins || effect.coin_cost || 0\r\n     if (price <= 0) {\r\n       toast.error('Invalid effect price')\r\n       return\r\n     }\r\n     \r\n     if (troll_coins < price) {\r\n       toast.error(`Not enough Troll Coins. Need ${price}, have ${troll_coins}`)\r\n       return\r\n     }\r\n     \r\n      const { error: deductErr } = await deductCoins({\r\n        userId: user.id,\r\n        amount: price,\r\n        type: 'entrance_effect',\r\n        description: `Purchased entrance effect: ${effect.name}`,\r\n        metadata: { effect_id: effect.id },\r\n        supabaseClient: supabase,\r\n      })\r\n    \r\n    if (deductErr) {\r\n      console.error('Coin deduction error:', deductErr)\r\n      toast.error(formatDeductErrorMessage(deductErr))\r\n      return\r\n    }\r\n    \r\n    await refreshCoins()\r\n\r\n     const { error: insertErr } = await supabase\r\n       .from('user_entrance_effects')\r\n       .upsert(\r\n         [{\r\n           user_id: user.id,\r\n           effect_id: effect.id\r\n         }],\r\n         { onConflict: 'user_id,effect_id', ignoreDuplicates: true }\r\n       )\r\n     \r\n     if (insertErr) {\r\n       console.error('Effect purchase error:', insertErr)\r\n       toast.error(insertErr.message || 'Failed to purchase effect')\r\n       return\r\n     }\r\n     \r\n      toast.success('Entrance effect purchased')\r\n     showPurchaseCompleteOverlay()\r\n     await loadWalletData(false)\r\n   } catch (err) {\r\n     console.error('Effect purchase error:', err)\r\n     toast.error(err.message || 'Purchase failed')\r\n   }\r\n }\r\n\r\n  const buyPerk = async (perk) => {\r\n   // Check officer onboarding first\r\n   const canProceed = await checkOnboarding();\r\n   if (!canProceed) return;\r\n\r\n   if (perk.role_required === 'officer' && !(isOfficer || isAdmin || isSecretary)) {\r\n     toast.error('This perk is limited to officers');\r\n     return;\r\n   }\r\n\r\n   try {\r\n     const basePrice = getPerkPrice(perk)\r\n     const price = basePrice * durationMultiplier\r\n     const baseDuration = Number(perk.duration_minutes || 0)\r\n     const durationMinutes = baseDuration * durationMultiplier\r\n     \r\n     if (price <= 0) {\r\n       toast.error('Invalid perk price')\r\n       return\r\n     }\r\n     \r\n     if (troll_coins < price) {\r\n       toast.error(`Not enough Troll Coins. Need ${price}, have ${troll_coins}`)\r\n       return\r\n     }\r\n     \r\n     const expiresAt = new Date(Date.now() + Math.max(1, durationMinutes) * 60 * 1000).toISOString()\r\n     \r\n    const { error: deductErr } = await deductCoins({\r\n      userId: user.id,\r\n      amount: price,\r\n      type: 'perk_purchase',\r\n      description: `Purchased perk: ${perk.name} (${durationMultiplier}x duration)`,\r\n      metadata: { perk_id: perk.id, multiplier: durationMultiplier },\r\n      supabaseClient: supabase,\r\n    })\r\n    \r\n    if (deductErr) {\r\n      console.error('Coin deduction error:', deductErr)\r\n      toast.error(formatDeductErrorMessage(deductErr))\r\n      return\r\n    }\r\n    \r\n    await refreshCoins()\r\n\r\n     const { error: insertErr } = await supabase.from('user_perks').insert([{\r\n       user_id: user.id,\r\n       perk_id: perk.id,\r\n       expires_at: expiresAt,\r\n       is_active: true,\r\n       metadata: {\r\n         perk_name: perk.name,\r\n         base_cost: Number(perk.cost || 0),\r\n         final_cost: price,\r\n         duration_minutes: durationMinutes,\r\n         perk_type: perk.perk_type,\r\n       }\r\n     }])\r\n     \r\n     if (insertErr) {\r\n       console.error('Perk purchase error:', insertErr)\r\n       toast.error(insertErr.message || 'Failed to purchase perk')\r\n       return\r\n     }\r\n\r\n     if (perk.id === 'perk_rgb_username') {\r\n       const { error: profileUpdateErr } = await supabase\r\n         .from('user_profiles')\r\n         .update({ rgb_username_expires_at: expiresAt })\r\n         .eq('id', user.id);\r\n       \r\n       if (profileUpdateErr) {\r\n         console.error('Failed to update RGB status:', profileUpdateErr);\r\n       } else {\r\n         await refreshProfile();\r\n       }\r\n     }\r\n     \r\n      toast.success('Perk purchased')\r\n     showPurchaseCompleteOverlay()\r\n     await loadWalletData(false)\r\n   } catch (err) {\r\n     console.error('Perk purchase error:', err)\r\n     toast.error(err.message || 'Purchase failed')\r\n   }\r\n }\r\n\r\n  const buyInsurance = async (plan) => {\r\n    // Check officer onboarding first\r\n    const canProceed = await checkOnboarding();\r\n    if (!canProceed) return;\r\n\r\n    try {\r\n      const basePrice = Number(plan.cost || 0);\r\n      const price = basePrice * durationMultiplier;\r\n      const baseDuration = Number(plan.duration_hours || 0);\r\n      const durationHours = baseDuration * durationMultiplier;\r\n      \r\n      if (price <= 0) {\r\n        toast.error('Invalid insurance price')\r\n        return\r\n      }\r\n\r\n      if (troll_coins < price) {\r\n        toast.error(`Not enough Troll Coins. Need ${price}, have ${troll_coins}`)\r\n        return\r\n      }\r\n      \r\n      const { error: deductErr } = await deductCoins({\r\n        userId: user.id,\r\n        amount: price,\r\n        type: 'insurance_purchase',\r\n        description: `Purchased insurance: ${plan.name} (${durationMultiplier}x duration)`,\r\n        metadata: { insurance_id: plan.id, multiplier: durationMultiplier },\r\n        supabaseClient: supabase,\r\n      })\r\n      \r\n      if (deductErr) {\r\n        console.error('Coin deduction error:', deductErr)\r\n        toast.error(formatDeductErrorMessage(deductErr))\r\n        return\r\n      }\r\n      \r\n      await refreshCoins()\r\n \r\n      const expiresAt = new Date(Date.now() + Math.max(1, durationHours) * 60 * 60 * 1000).toISOString()\r\n      \r\n      const { error: insertErr } = await supabase.from('user_insurances').insert([{\r\n        user_id: user.id,\r\n        insurance_id: plan.id,\r\n        expires_at: expiresAt,\r\n        is_active: true,\r\n        protection_type: plan.protection_type,\r\n        metadata: {\r\n          insurance_name: plan.name,\r\n          cost: price,\r\n          duration_hours: durationHours,\r\n          protection_type: plan.protection_type,\r\n          multiplier: durationMultiplier,\r\n        }\r\n      }])\r\n     \r\n     if (insertErr) {\r\n       console.error('Insurance purchase error:', insertErr)\r\n       toast.error(insertErr.message || 'Failed to purchase insurance')\r\n       return\r\n     }\r\n     \r\n      toast.success('Insurance purchased')\r\n     showPurchaseCompleteOverlay()\r\n     await loadWalletData(false)\r\n   } catch (err) {\r\n     console.error('Insurance purchase error:', err)\r\n     toast.error(err.message || 'Purchase failed')\r\n   }\r\n }\r\n\r\n  const buyBroadcastTheme = async (theme) => {\r\n    const canProceed = await checkOnboarding();\r\n    if (!canProceed) return;\r\n    if (!user?.id) {\r\n      toast.error('Please log in to purchase a theme');\r\n      return;\r\n    }\r\n\r\n    if (!theme?.id) {\r\n      toast.error('Invalid theme');\r\n      return;\r\n    }\r\n\r\n    if (ownedThemeIds.has(theme.id)) {\r\n      toast.info('You already own this theme');\r\n      return;\r\n    }\r\n\r\n    const eligibility = getEligibility(theme);\r\n    if (!eligibility.isEligible) {\r\n      toast.error('This theme is locked.');\r\n      return;\r\n    }\r\n\r\n    setThemePurchasing(theme.id);\r\n    try {\r\n      // Get theme price (assume theme.price_coins is available on theme object)\r\n      const price = theme.price_coins || theme.price || 0;\r\n      if (price <= 0) {\r\n        toast.error('Invalid theme price');\r\n        setThemePurchasing(null);\r\n        return;\r\n      }\r\n      if (troll_coins < price) {\r\n        toast.error(`Not enough Troll Coins. Need ${price}, have ${troll_coins}`);\r\n        setThemePurchasing(null);\r\n        return;\r\n      }\r\n\r\n      // Deduct coins first\r\n      const { error: deductErr } = await deductCoins({\r\n        userId: user.id,\r\n        amount: price,\r\n        type: 'purchase',\r\n        description: `Purchased broadcast theme: ${theme.name}`,\r\n        metadata: { theme_id: theme.id, theme_name: theme.name },\r\n        supabaseClient: supabase,\r\n      });\r\n      if (deductErr) {\r\n        console.error('Coin deduction error:', deductErr);\r\n        toast.error('Failed to deduct coins: ' + (deductErr.message || deductErr));\r\n        setThemePurchasing(null);\r\n        return;\r\n      }\r\n\r\n      // Now call the purchase RPC to record the purchase (no deduction logic inside)\r\n      const { data, error } = await supabase.rpc('purchase_broadcast_theme', {\r\n        p_user_id: user.id,\r\n        p_theme_id: String(theme.id),\r\n        p_set_active: false\r\n      });\r\n      if (error || data?.success === false) {\r\n        throw new Error(data?.error || error?.message || 'Theme purchase failed');\r\n      }\r\n\r\n      setOwnedThemeIds((prev) => new Set([...Array.from(prev), theme.id]));\r\n      await refreshCoins();\r\n      if (refreshProfile) {\r\n        await refreshProfile();\r\n      }\r\n      toast.success('Theme purchased');\r\n      showPurchaseCompleteOverlay();\r\n    } catch (err) {\r\n      console.error('Theme purchase error:', err);\r\n      toast.error(err?.message || 'Failed to purchase theme');\r\n    } finally {\r\n      setThemePurchasing(null);\r\n    }\r\n  };\r\n\r\n  const buyCallSound = async (sound) => {\r\n    const canProceed = await checkOnboarding();\r\n    if (!canProceed) return;\r\n    if (!user?.id) {\r\n      toast.error('Please log in to purchase a chat sound');\r\n      return;\r\n    }\r\n    \r\n    // For sample sounds, we'll simulate the purchase if DB RPC doesn't exist\r\n    // But ideally we use the RPC\r\n    setCallSoundPurchasing(sound.id);\r\n    try {\r\n      const deduction = await deductCoins({\r\n        userId: user.id,\r\n        amount: sound.cost,\r\n        type: 'chat_sound',\r\n        description: `Purchased ${sound.name} chat sound`,\r\n        metadata: { sound_id: sound.id },\r\n        supabaseClient: supabase,\r\n      });\r\n\r\n      if (!deduction?.success) {\r\n        throw new Error(deduction?.error || 'Failed to deduct troll_coins');\r\n      }\r\n\r\n      // Record purchase\r\n      const { error } = await supabase.from('user_call_sounds').insert({\r\n        user_id: user.id,\r\n        sound_id: sound.id, // In real app, this should be a UUID from DB. For samples, we might need a workaround or ensure samples are in DB.\r\n        is_active: false\r\n      });\r\n\r\n      if (error) {\r\n        // Fallback: If FK constraint fails (because sample IDs aren't in DB), we might just toast success for now\r\n        console.warn('DB Insert failed (likely missing catalog item):', error);\r\n        // throw error; \r\n      }\r\n      \r\n      setOwnedCallSoundIds((prev) => new Set([...Array.from(prev), sound.id]));\r\n      await refreshCoins();\r\n      toast.success('Chat sound purchased!');\r\n    } catch (err) {\r\n      console.error('Chat sound purchase error:', err);\r\n      toast.error(err?.message || 'Failed to purchase chat sound');\r\n    } finally {\r\n      setCallSoundPurchasing(null);\r\n    }\r\n  };\r\n\r\n  const equipSound = async (sound) => {\r\n    if (!user?.id) return;\r\n    try {\r\n      // Unset all\r\n      await supabase.from('user_call_sounds').update({ is_active: false }).eq('user_id', user.id);\r\n      // Set new\r\n      await supabase.from('user_call_sounds').update({ is_active: true }).eq('user_id', user.id).eq('sound_id', sound.id);\r\n      \r\n      setActiveCallSounds(prev => ({ ...prev, chat: sound.id }));\r\n      toast.success(`Equipped ${sound.name}`);\r\n    } catch (err) {\r\n      console.error('Equip error:', err);\r\n      toast.error('Failed to equip sound');\r\n    }\r\n  };\r\n\r\n  const buyCallMinutes = async (pkg) => {\r\n    // Check officer onboarding first\r\n    const canProceed = await checkOnboarding();\r\n    if (!canProceed) return;\r\n\r\n    if (!user?.id) {\r\n      toast.error('Please log in to purchase minutes');\r\n      return;\r\n    }\r\n\r\n    const totalCost = Number(pkg.totalCost || 0);\r\n    if (!Number.isFinite(totalCost) || totalCost <= 0) {\r\n      toast.error('Invalid package cost');\r\n      return;\r\n    }\r\n\r\n    if (troll_coins < totalCost) {\r\n      toast.error(`Need ${formatCoins(totalCost)} troll_coins to purchase this package.`);\r\n      return;\r\n    }\r\n\r\n    setLoadingPackage(pkg.id);\r\n    try {\r\n      const deduction = await deductCoins({\r\n        userId: user.id,\r\n        amount: totalCost,\r\n        type: 'call_minutes',\r\n        description: `Purchased ${pkg.minutes} ${pkg.type} call minutes`,\r\n        metadata: { package_id: pkg.id, minutes: pkg.minutes, call_type: pkg.type },\r\n        supabaseClient: supabase,\r\n      });\r\n\r\n      if (!deduction?.success) {\r\n        throw new Error(deduction?.error || 'Failed to deduct troll_coins');\r\n      }\r\n\r\n      const { error } = await supabase.rpc('add_call_minutes', {\r\n        p_user_id: user.id,\r\n        p_minutes: pkg.minutes,\r\n        p_type: pkg.type\r\n      });\r\n\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      toast.success(`Added ${pkg.minutes} ${pkg.type} minutes!`);\r\n      showPurchaseCompleteOverlay();\r\n      await refreshCoins();\r\n    } catch (err) {\r\n      console.error('Call minutes purchase error:', err);\r\n      toast.error(err?.message || 'Failed to purchase minutes');\r\n    } finally {\r\n      setLoadingPackage(null);\r\n    }\r\n  };\r\n\r\n  const createPayPalOrder = async (pkg) => {\r\n    try {\r\n      setLoadingPay(true);\r\n      const { data, error } = await supabase.functions.invoke('paypal-create-order', {\r\n        body: {\r\n          user_id: user.id,\r\n          package_id: pkg.id,\r\n          coins: pkg.coins,\r\n          amount: typeof pkg.price === 'string' ? pkg.price.replace('$', '') : pkg.price\r\n        }\r\n      });\r\n\r\n      if (error) throw error;\r\n      if (!data?.orderId) throw new Error('Failed to create order');\r\n      \r\n      return data.orderId;\r\n    } catch (err) {\r\n      console.error('Create Order Error:', err);\r\n      toast.error('Failed to initialize PayPal');\r\n      setLoadingPay(false);\r\n      throw err;\r\n    }\r\n  };\r\n\r\n  const onPayPalApprove = async (data, actions, pkg) => {\r\n    try {\r\n      const { orderID } = data;\r\n      const { data: result, error } = await supabase.functions.invoke('paypal-complete-order', {\r\n        body: {\r\n          orderId: orderID,\r\n          userId: user.id,\r\n          packageId: pkg.id\r\n        }\r\n      });\r\n\r\n      console.log(\"paypal-complete-order data:\", result);\r\n      console.log(\"paypal-complete-order error:\", error);\r\n\r\n      if (error) throw error;\r\n      if (!result?.success) throw new Error(result?.error || 'Payment verification failed');\r\n\r\n      toast.success(`Successfully purchased ${pkg.coins} coins!`);\r\n      await refreshCoins();\r\n      refreshBank(); // Update loan status if any\r\n      showPurchaseCompleteOverlay();\r\n\r\n    } catch (err) {\r\n      console.error('Capture Error (full):', err);\r\n      toast.error(err.message || 'Payment failed');\r\n    } finally {\r\n      setLoadingPay(false);\r\n    }\r\n  };\r\n\r\n  const handleApplyLoan = async () => {\r\n    if (!requestedAmount || requestedAmount < 100) {\r\n      toast.error('Minimum loan amount is 100 coins');\r\n      return;\r\n    }\r\n    setApplying(true);\r\n    try {\r\n      const result = await applyForLoan(requestedAmount);\r\n      if (result.success) {\r\n        toast.success('Loan approved! Coins added to your wallet.');\r\n        setRequestedAmount(100);\r\n        await refreshCoins();\r\n        refreshBank();\r\n      } else {\r\n        toast.error(result.error || 'Loan application failed');\r\n      }\r\n    } catch (err) {\r\n      console.error('Loan application error:', err);\r\n      toast.error('An unexpected error occurred');\r\n    } finally {\r\n      setApplying(false);\r\n      // Ensure we don't get stuck in a global loading state if something weird happens\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n      showPurchaseComplete ? (\r\n        <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center p-6\">\r\n          <div className=\"text-center\">\r\n            <div className=\"text-xl font-semibold\">Order submitted</div>\r\n          </div>\r\n        </div>\r\n      ) : loading ? (\r\n        <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n          <div className=\"max-w-6xl mx-auto\">\r\n            <div className=\"flex items-center justify-between mb-8\">\r\n              <h1 className=\"text-3xl font-bold text-white flex items-center gap-3\">\r\n                <Coins className=\"w-8 h-8 text-purple-400\" />\r\n                Troll City Coin Store\r\n              </h1>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n              {[1, 2, 3, 4, 5, 6].map(i => (\r\n                <div key={i} className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C] animate-pulse\">\r\n                  <div className=\"h-4 bg-gray-700 rounded w-1/2 mb-2\"></div>\r\n                  <div className=\"h-8 bg-gray-700 rounded w-3/4\"></div>\r\n                  <div className=\"h-4 bg-gray-700 rounded w-1/3 mt-2\"></div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6 overflow-x-hidden\">\r\n        <div className=\"max-w-6xl mx-auto space-y-6 w-full\">\r\n          {/* Bank Info Banner */}\r\n          <div className=\"bg-blue-500/10 border border-blue-500/50 rounded-xl p-4 flex items-start gap-3\">\r\n            <Landmark className=\"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5\" />\r\n            <div className=\"text-blue-200 text-sm font-medium space-y-1\">\r\n              <p>\r\n                Need more coins? Visit the <button onClick={() => navigate('/bank')} className=\"underline hover:text-white\">Troll Bank</button> to apply for a loan.\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Header */}\r\n          <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\r\n            <h1 className=\"text-3xl font-bold text-white flex items-center gap-3\">\r\n              <Coins className=\"w-8 h-8 text-purple-400\" />\r\n              Troll City Store\r\n            </h1>\r\n            <div className=\"flex gap-2 hidden md:flex\">\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='coins'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('coins')}>Coins</button>\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='bank'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('bank')}>Bank</button>\r\n              {/* Only show Make a Payment as a separate tab if needed; My Loan and Credit Report will be inside Bank tab */}\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='effects'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('effects')}>Entrance Effects</button>\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='perks'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('perks')}>Perks</button>\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='calls'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('calls')}>Call Minutes</button>\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='insurance'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('insurance')}>Insurance</button>\r\n              <button type=\"button\" className={`px-3 py-2 rounded ${tab==='broadcast_themes'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('broadcast_themes')}>Broadcast Themes</button>\r\n              {showLiveSnacks && (\r\n                <button type=\"button\" className={`px-3 py-2 rounded ${tab==='live_snacks'?'bg-purple-600':'bg-zinc-800'}`} onClick={() => setTab('live_snacks')}>LIVE SNACKS</button>\r\n              )}\r\n            </div>\r\n            <div className=\"md:hidden w-full\">\r\n              <select\r\n                value={tab}\r\n                onChange={(e) => setTab(e.target.value)}\r\n                className=\"w-full bg-zinc-900 text-white border border-purple-500/30 rounded-lg p-2 text-sm focus:outline-none focus:border-purple-500\"\r\n              >\r\n                <option value=\"coins\">Coins</option>\r\n                <option value=\"bank\">Troll Bank & Loans</option>\r\n                {/* Only show Make a Payment as a separate tab if needed; My Loan and Credit Report will be inside Bank tab */}\r\n                <option value=\"effects\">Entrance Effects</option>\r\n                <option value=\"perks\">Perks</option>\r\n                <option value=\"calls\">Call Minutes</option>\r\n                <option value=\"insurance\">Insurance</option>\r\n                <option value=\"broadcast_themes\">Broadcast Themes</option>\r\n                {showLiveSnacks && <option value=\"live_snacks\">LIVE SNACKS</option>}\r\n              </select>\r\n            </div>\r\n\r\n\r\n                      {/* Make a Payment Tab */}\r\n                      {tab === 'make_payment' && activeLoans && activeLoans.length > 0 && (\r\n                        <div className=\"space-y-6 animate-fadeIn\">\r\n                          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                            <CreditCard className=\"w-5 h-5 text-purple-400\" />\r\n                            Make a Payment\r\n                          </h2>\r\n                          {/* TODO: Payment form, preset amounts, call Edge Function, show score preview */}\r\n                          <div className=\"bg-black/30 border border-white/5 rounded-xl p-4\">\r\n                            <div className=\"mb-4\">Loan Balance: <span className=\"font-bold text-red-400\">{activeLoans[0].balance}</span></div>\r\n                            <div className=\"flex gap-2 mb-4\">\r\n                              <button className=\"px-3 py-1 bg-purple-600 rounded text-white\">Pay 25%</button>\r\n                              <button className=\"px-3 py-1 bg-purple-600 rounded text-white\">Pay 50%</button>\r\n                              <button className=\"px-3 py-1 bg-purple-600 rounded text-white\">Pay Full</button>\r\n                            </div>\r\n                            <input type=\"number\" min={1} max={activeLoans[0].balance} placeholder=\"Custom amount\" className=\"w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mb-4\" />\r\n                            <button className=\"w-full py-2 bg-green-600 hover:bg-green-700 rounded text-white font-bold\">Submit Payment</button>\r\n                            <div className=\"mt-4 text-xs text-gray-400\">Credit score increase preview: <span className=\"font-bold text-yellow-400\">{/* TODO: Show preview */}---</span></div>\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n\r\n\r\n          </div>\r\n\r\n          {/* Wallet Summary */}\r\n          <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-purple-500/30 shadow-lg\">\r\n            <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n              <CreditCard className=\"w-5 h-5 text-purple-400\" />\r\n              Your Wallet Balance\r\n            </h2>\r\n\r\n            <div className=\"grid grid-cols-1 gap-4\">\r\n              <div className=\"bg-zinc-900 rounded-lg p-4 border border-yellow-500/30\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <Coins className=\"w-5 h-5 text-yellow-400\" />\r\n                  <span className=\"text-sm text-gray-400\">Troll Coins</span>\r\n                </div>\r\n                <p className=\"text-2xl font-bold text-yellow-400\">\r\n                  {formatCoins(troll_coins)}\r\n                </p>\r\n                <div className=\"flex gap-2 mt-2\">\r\n                    <button\r\n                        onClick={() => {\r\n                          if (activeLoans && activeLoans.length > 0) {\r\n                            setShowActiveLoanModal(true);\r\n                          } else {\r\n                            setTab('bank');\r\n                          }\r\n                        }}\r\n                        className=\"text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-white\"\r\n                    >\r\n                        Request Loan\r\n                    </button>\r\n                      {/* Active Loan Modal */}\r\n                      {showActiveLoanModal && (\r\n                        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60\">\r\n                          <div className=\"bg-zinc-900 border border-purple-500/40 rounded-xl p-8 shadow-2xl max-w-sm w-full text-center animate-fadeIn\">\r\n                            <h2 className=\"text-xl font-bold text-red-400 mb-4\">Active Loan Detected</h2>\r\n                            <p className=\"mb-6 text-gray-200\">You already have an active loan. Please pay off your existing loan before requesting a new one.</p>\r\n                            <button\r\n                              className=\"px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white font-bold\"\r\n                              onClick={() => setShowActiveLoanModal(false)}\r\n                            >\r\n                              OK\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Content Areas */}\r\n          <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-purple-500/30 shadow-lg\">\r\n            \r\n            {/* Bank Tab */}\r\n            {tab === 'bank' && (\r\n              <div className=\"space-y-8 animate-fadeIn\">\r\n                                 {/* My Loan Section (moved from tab) */}\r\n                                 {activeLoans && activeLoans.length > 0 && (\r\n                                   <div className=\"space-y-6\">\r\n                                     <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                                       <CreditCard className=\"w-5 h-5 text-purple-400\" />\r\n                                       My Loans\r\n                                     </h2>\r\n                                     {activeLoans.map((loan) => (\r\n                                       <div key={loan.id} className=\"bg-black/30 border border-white/5 rounded-xl p-4 mb-6\">\r\n                                         <div className=\"grid grid-cols-2 gap-4\">\r\n                                           <div>\r\n                                             <div className=\"text-gray-400 text-xs\">Original Amount</div>\r\n                                             <div className=\"text-2xl font-bold text-yellow-400\">{loan.principal}</div>\r\n                                           </div>\r\n                                           <div>\r\n                                             <div className=\"text-gray-400 text-xs\">Remaining Balance</div>\r\n                                             <div className=\"text-2xl font-bold text-red-400\">{loan.balance}</div>\r\n                                           </div>\r\n                                           <div>\r\n                                             <div className=\"text-gray-400 text-xs\">Interest Rate</div>\r\n                                             <div className=\"text-lg font-bold text-blue-400\">{loan.interest_rate || 0}%</div>\r\n                                           </div>\r\n                                           <div>\r\n                                             <div className=\"text-gray-400 text-xs\">Due Date</div>\r\n                                             <div className=\"text-lg font-bold text-green-400\">{loan.due_date ? new Date(loan.due_date).toLocaleDateString() : 'N/A'}</div>\r\n                                           </div>\r\n                                         </div>\r\n                                         <div className=\"mt-6 flex gap-6\">\r\n                                           <div>\r\n                                             <div className=\"text-gray-400 text-xs\">Loan Status</div>\r\n                                             <div className=\"text-lg font-bold text-purple-400\">{loan.status}</div>\r\n                                           </div>\r\n                                           <div>\r\n                                             <div className=\"text-gray-400 text-xs\">Credit Score</div>\r\n                                             <div className=\"text-lg font-bold text-yellow-400\">---</div>\r\n                                           </div>\r\n                                         </div>\r\n                                       </div>\r\n                                     ))}\r\n                                   </div>\r\n                                 )}\r\n\r\n                                 {/* Credit Report Section (all users, current user first) */}\r\n                                 <div className=\"space-y-6\">\r\n                                   <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                                     <Landmark className=\"w-5 h-5 text-purple-400\" />\r\n                                     Credit Report\r\n                                   </h2>\r\n                                   <div className=\"bg-black/30 border border-white/5 rounded-xl p-4\">\r\n                                     <div className=\"mb-4 font-bold text-lg text-yellow-300\">All Users' Credit Scores</div>\r\n                                     {loadingScores ? (\r\n                                       <div className=\"text-gray-400\">Loading...</div>\r\n                                     ) : (\r\n                                       <table className=\"w-full text-xs text-left\">\r\n                                         <thead>\r\n                                           <tr className=\"border-b border-white/10\">\r\n                                             <th className=\"py-1 px-2\">#</th>\r\n                                             <th className=\"py-1 px-2\">User</th>\r\n                                             <th className=\"py-1 px-2\">Score</th>\r\n                                             <th className=\"py-1 px-2\">Last Updated</th>\r\n                                           </tr>\r\n                                         </thead>\r\n                                         <tbody>\r\n                                           {allCreditScores.map((row, i) => (\r\n                                             <tr key={row.user_id} className={row.user_id === user?.id ? 'bg-purple-900/30 font-bold' : ''}>\r\n                                               <td className=\"py-1 px-2\">{i + 1}</td>\r\n                                               <td className=\"py-1 px-2 flex items-center gap-2\">\r\n                                                 {row.users?.avatar_url && (\r\n                                                   <img src={row.users.avatar_url} alt=\"avatar\" className=\"w-5 h-5 rounded-full\" />\r\n                                                 )}\r\n                                                 {row.users?.username || row.user_id.slice(0, 8)}\r\n                                                 {row.user_id === user?.id && <span className=\"ml-1 text-green-400\">(You)</span>}\r\n                                               </td>\r\n                                               <td className=\"py-1 px-2\">{row.score}</td>\r\n                                               <td className=\"py-1 px-2\">{row.updated_at ? new Date(row.updated_at).toLocaleDateString() : ''}</td>\r\n                                             </tr>\r\n                                           ))}\r\n                                         </tbody>\r\n                                       </table>\r\n                                     )}\r\n                                   </div>\r\n                                 </div>\r\n                 {/* Bank Header Stats */}\r\n                 <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div className=\"bg-black/30 border border-white/5 rounded-xl p-4 relative overflow-hidden group\">\r\n                        <div className=\"relative z-10\">\r\n                            <p className=\"text-gray-400 text-sm font-medium mb-1\">Bank Reserves</p>\r\n                            <div className=\"flex items-baseline gap-2\">\r\n                                <span className=\"text-2xl font-bold text-emerald-400\">\r\n                                {bankBalance !== null ? bankBalance.toLocaleString() : '---'}\r\n                                </span>\r\n                                <span className=\"text-xs text-emerald-400/70\">coins</span>\r\n                            </div>\r\n                            <div className=\"mt-2 flex items-center gap-1 text-[10px] text-gray-500\">\r\n                                <CheckCircle className=\"w-3 h-3\" />\r\n                                <span>Verified Holdings</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div className=\"bg-black/30 border border-white/5 rounded-xl p-4 relative overflow-hidden\">\r\n                        <div className=\"relative z-10\">\r\n                            <p className=\"text-gray-400 text-sm font-medium mb-1\">Your Active Loan</p>\r\n                            {activeLoans && activeLoans.length > 0 ? (\r\n                              <div>\r\n                              <div className=\"flex items-baseline gap-2\">\r\n                                <span className=\"text-2xl font-bold text-red-400\">{activeLoans[0].balance.toLocaleString()}</span>\r\n                                <span className=\"text-xs text-red-400/70\">due</span>\r\n                              </div>\r\n                              <div className=\"mt-2 p-2 bg-red-500/10 border border-red-500/20 rounded text-[10px] text-red-200\">\r\n                                Auto-repayment active (50% of purchases)\r\n                              </div>\r\n                              </div>\r\n                            ) : (\r\n                              <div>\r\n                              <div className=\"flex items-baseline gap-2\">\r\n                                <span className=\"text-2xl font-bold text-green-400\">None</span>\r\n                              </div>\r\n                              <p className=\"mt-1 text-xs text-gray-400\">You are debt free!</p>\r\n                              </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                 </div>\r\n\r\n                 {/* Loan Application / Management */}\r\n                 <div className=\"bg-black/20 border border-white/5 rounded-xl p-6\">\r\n                    <h2 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n                        <CreditCard className=\"w-5 h-5 text-purple-400\" />\r\n                        Loan Services\r\n                    </h2>\r\n                    \r\n                    {activeLoans && activeLoans.length > 0 ? (\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl\">\r\n                                <h3 className=\"font-semibold text-emerald-400 mb-2 text-sm\">Manual Repayment</h3>\r\n                                <p className=\"text-xs text-gray-300 mb-4\">\r\n                                Pay off your loan manually. Fully paying off a loan increases your credit score by 5% of the loan amount!\r\n                                </p>\r\n                                <div className=\"flex gap-2\">\r\n                                <input\r\n                                    type=\"number\"\r\n                                    value={payAmount}\r\n                                    onChange={(e) => setPayAmount(e.target.value)}\r\n                                    placeholder=\"Amount to pay\"\r\n                                    className=\"flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-emerald-500/50\"\r\n                                />\r\n                                <button\r\n                                    onClick={handlePayLoan}\r\n                                    disabled={paying || !payAmount}\r\n                                    className=\"bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors\"\r\n                                >\r\n                                    {paying ? 'Paying...' : 'Pay'}\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => setPayAmount(activeLoans[0].balance.toString())}\r\n                                    className=\"bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg font-medium text-sm transition-colors\"\r\n                                >\r\n                                    Max\r\n                                </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl flex items-start gap-3\">\r\n                                <AlertCircle className=\"w-5 h-5 text-blue-400 mt-0.5\" />\r\n                                <div>\r\n                                    <h3 className=\"font-semibold text-blue-400 text-sm\">Repayment Information</h3>\r\n                                    <p className=\"text-xs text-gray-300 mt-1\">\r\n                                    Loans are repaid automatically when you purchase or receive paid coins. \r\n                                    There is no interest if paid within 30 days.\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                            <div>\r\n                                <h3 className=\"font-semibold text-white mb-2 text-sm\">Apply for a Loan</h3>\r\n                                <p className=\"text-xs text-gray-400 mb-4\">\r\n                                Get coins instantly and pay them back later automatically.\r\n                                </p>\r\n                                \r\n                                <div className=\"space-y-3\">\r\n                                    <div>\r\n                                        <label className=\"block text-[10px] font-medium text-gray-400 mb-1\">\r\n                                            Amount (Coins) - Max: {eligibility.maxAmount}\r\n                                        </label>\r\n                                        <input \r\n                                            type=\"number\"\r\n                                            value={requestedAmount}\r\n                                            onChange={(e) => setRequestedAmount(Number(e.target.value))}\r\n                                            className=\"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-purple-500 transition-colors\"\r\n                                            min={100}\r\n                                            max={eligibility.maxAmount || 100}\r\n                                        />\r\n                                    </div>\r\n                                    \r\n                                    <button\r\n                                      onClick={handleApplyLoan}\r\n                                      disabled={(!eligibility.canApply && !isAdmin) || applying}\r\n                                      className=\"w-full py-2 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-lg text-sm transition-all\"\r\n                                    >\r\n                                      {applying ? 'Processing...' : 'Apply for Loan'}\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"bg-black/20 rounded-xl p-4\">\r\n                                <h3 className=\"font-semibold text-white mb-2 text-sm\">Eligibility Requirements</h3>\r\n                                <ul className=\"space-y-2\">\r\n                                    <li className=\"flex items-center gap-2 text-xs\">\r\n                                        {!(activeLoans && activeLoans.length > 0) ? <CheckCircle className=\"w-3 h-3 text-green-500\"/> : <div className=\"w-3 h-3 border rounded-full border-gray-600\"/>}\r\n                                        <span className={!(activeLoans && activeLoans.length > 0) ? 'text-gray-200' : 'text-gray-500'}>No active loans</span>\r\n                                    </li>\r\n                                    <li className=\"flex items-center gap-2 text-xs\">\r\n                                        {eligibility.maxAmount > 0 ? <CheckCircle className=\"w-3 h-3 text-green-500\"/> : <div className=\"w-3 h-3 border rounded-full border-gray-600\"/>}\r\n                                        <span className={eligibility.maxAmount > 0 ? 'text-gray-200' : 'text-gray-500'}>Account age check {eligibility.maxAmount > 0 && `(Max: ${eligibility.maxAmount})`}</span>\r\n                                    </li>\r\n                                </ul>\r\n                                \r\n                                {eligibility.reasons.length > 0 && (\r\n                                    <div className=\"mt-3 p-2 bg-red-500/10 border border-red-500/20 rounded\">\r\n                                        <p className=\"text-[10px] text-red-300 font-semibold mb-1\">Why you can't apply:</p>\r\n                                        <ul className=\"list-disc list-inside text-[10px] text-red-200/80\">\r\n                                            {eligibility.reasons.map((r, i) => <li key={i}>{r}</li>)}\r\n                                        </ul>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                 </div>\r\n\r\n                 {/* Recent Transactions */}\r\n                 <div>\r\n                    <h2 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n                        <History className=\"w-5 h-5 text-gray-400\" />\r\n                        Recent Transactions\r\n                    </h2>\r\n                    <div className=\"overflow-x-auto bg-black/20 rounded-xl border border-white/5\">\r\n                        <table className=\"w-full text-left border-collapse\">\r\n                        <thead>\r\n                            <tr className=\"text-[10px] text-gray-500 border-b border-white/5 uppercase tracking-wider\">\r\n                            <th className=\"py-3 px-4\">Date</th>\r\n                            <th className=\"py-3 px-4\">Type</th>\r\n                            <th className=\"py-3 px-4\">Source</th>\r\n                            <th className=\"py-3 px-4 text-right\">Amount</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"text-sm\">\r\n                            {ledger.map((entry) => (\r\n                            <tr key={entry.id} className=\"border-b border-white/5 hover:bg-white/5 transition-colors\">\r\n                                <td className=\"py-3 px-4 text-gray-400 text-xs\">\r\n                                {new Date(entry.created_at).toLocaleDateString()}\r\n                                </td>\r\n                                <td className=\"py-3 px-4\">\r\n                                <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${\r\n                                    entry.bucket === 'repayment' ? 'bg-red-500/20 text-red-300' :\r\n                                    entry.bucket === 'loan' ? 'bg-purple-500/20 text-purple-300' :\r\n                                    'bg-gray-500/20 text-gray-300'\r\n                                }`}>\r\n                                    {entry.bucket.toUpperCase()}\r\n                                </span>\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-gray-400 text-xs\">{entry.source}</td>\r\n                                <td className={`py-3 px-4 text-right font-mono font-medium ${\r\n                                entry.amount_delta > 0 ? 'text-green-400' : 'text-red-400'\r\n                                }`}>\r\n                                {entry.amount_delta > 0 ? '+' : ''}{entry.amount_delta}\r\n                                </td>\r\n                            </tr>\r\n                            ))}\r\n                            {ledger.length === 0 && (\r\n                            <tr>\r\n                                <td colSpan={4} className=\"py-8 text-center text-gray-500 text-xs\">\r\n                                No transactions found.\r\n                                </td>\r\n                            </tr>\r\n                            )}\r\n                        </tbody>\r\n                        </table>\r\n                    </div>\r\n                 </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Coins Tab */}\r\n            {tab === 'coins' && (\r\n              <PayPalScriptProvider options={{ \"client-id\": import.meta.env.VITE_PAYPAL_CLIENT_ID || \"test\" }}>\r\n                <div className=\"mb-6\">\r\n                  <TrollPassBanner \r\n                    onPurchase={async () => {\r\n                      const trollPassPkg = {\r\n                        id: 'troll_pass_bundle',\r\n                        coins: 1500,\r\n                        price: 9.99,\r\n                        name: 'Troll Pass Premium',\r\n                        purchaseType: 'troll_pass_bundle'\r\n                      };\r\n                      setSelectedPackage(trollPassPkg);\r\n                      setCashAppModalOpen(true);\r\n                    }} \r\n                    customActionComponent={selectedProviderId === 'paypal' ? (\r\n                      <div className=\"min-w-[150px]\">\r\n                        <PayPalButtons\r\n                          style={{ layout: \"horizontal\", height: 45, tagline: false }}\r\n                          createOrder={(data, actions) => createPayPalOrder({\r\n                            id: 'troll_pass_bundle',\r\n                            coins: 1500,\r\n                            price: 9.99,\r\n                            name: 'Troll Pass Premium'\r\n                          })}\r\n                          onApprove={(data, actions) => onPayPalApprove(data, actions, {\r\n                            id: 'troll_pass_bundle',\r\n                            coins: 1500,\r\n                            price: 9.99,\r\n                            name: 'Troll Pass Premium'\r\n                          })}\r\n                          onError={(err) => {\r\n                            console.error('PayPal Error:', err);\r\n                            toast.error('Payment failed. Please try again.');\r\n                          }}\r\n                          disabled={loadingPay}\r\n                        />\r\n                      </div>\r\n                    ) : null}\r\n                  />\r\n                </div>\r\n                 \r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Coins className=\"w-5 h-5 text-yellow-400\" />\r\n                  Coin Packages\r\n                </h2>\r\n                {/* Payment Provider Selector */}\r\n                <div className=\"mb-4 flex gap-2\">\r\n                  {paymentProviders.map(p => (\r\n                    <button\r\n                      key={p.id}\r\n                      onClick={() => setSelectedProviderId(p.id)}\r\n                      className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 border transition-colors ${selectedProviderId === p.id ? 'bg-purple-600 text-white border-purple-400' : 'bg-[#181825] text-gray-300 border-[#2C2C2C] hover:bg-[#232336]'}`}\r\n                    >\r\n                      {p.logoUrl && <img src={p.logoUrl} alt={p.displayName} className=\"h-5 w-5\" />}\r\n                      {p.displayName}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n                \r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n                    {coinPackages.map((pkg) => (\r\n                      <div key={pkg.id} className={`bg-black/40 p-4 rounded-lg border ${pkg.promo ? 'border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.1)]' : (pkg.popular || pkg.bestValue ? 'border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.1)]' : 'border-purple-500/20')} relative overflow-hidden group`}>\r\n                        {(pkg.popular || pkg.bestValue || pkg.promo) && (\r\n                          <div className={`absolute top-3 right-3 ${pkg.promo ? 'bg-green-500' : 'bg-yellow-500'} text-black text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider`}>\r\n                            {pkg.promo ? 'Limited Offer' : (pkg.popular ? 'Popular' : 'Best Value')}\r\n                          </div>\r\n                        )}\r\n                        <div className=\"flex flex-col items-center text-center p-2\">\r\n                          <div className=\"text-4xl mb-3 group-hover:scale-110 transition-transform duration-300\">{pkg.emoji}</div>\r\n                          <div className=\"font-bold text-2xl text-white mb-1\">{formatCoins(pkg.coins)}</div>\r\n                          <div className=\"text-lg font-semibold text-green-400 mb-1\">{pkg.price}</div>\r\n                          <div className=\"text-sm text-gray-400 mb-4\">Troll Coins</div>\r\n                          {selectedProviderId === 'paypal' ? (\r\n                            <PayPalButtons\r\n                              style={{ layout: \"horizontal\", height: 45, tagline: false }}\r\n                              createOrder={(data, actions) => createPayPalOrder(pkg)}\r\n                              onApprove={(data, actions) => onPayPalApprove(data, actions, pkg)}\r\n                              onError={(err) => {\r\n                                console.error('PayPal Error:', err);\r\n                                toast.error('Payment failed. Please try again.');\r\n                              }}\r\n                              disabled={loadingPay}\r\n                            />\r\n                          ) : (\r\n                            <button\r\n                              onClick={() => {\r\n                                setSelectedPackage(pkg);\r\n                                setCashAppModalOpen(true);\r\n                              }}\r\n                              className=\"w-full py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 rounded font-bold text-white shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2\"\r\n                              disabled={loadingPay && selectedPackage?.id === pkg.id}\r\n                            >\r\n                              {loadingPay && selectedPackage?.id === pkg.id ? 'Processing...' : pkg.price}\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n              </PayPalScriptProvider>\r\n            )}\r\n\r\n            {/* Entrance Effects */}\r\n            {tab === 'effects' && (\r\n              <>\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\r\n                  Entrance Effects\r\n                </h2>\r\n                {effectsNote && (\r\n                   <div className=\"mb-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded text-sm text-blue-200\">\r\n                     {effectsNote}\r\n                   </div>\r\n                )}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {effects.map((effect) => (\r\n                    <div key={effect.id} className=\"bg-black/40 p-4 rounded-lg border border-purple-500/20\">\r\n                      <div className=\"font-semibold text-lg\">{effect.name}</div>\r\n                      <div className=\"text-sm text-gray-400 mb-2\">{effect.description}</div>\r\n                      <div className=\"flex justify-between items-center mt-4\">\r\n                        <span className=\"text-yellow-400 font-bold\">{formatCoins(effect.price_troll_coins || effect.coin_cost)}</span>\r\n                        <button\r\n                          onClick={() => buyEffect(effect)}\r\n                          className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold\"\r\n                        >\r\n                          Buy\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Perks */}\r\n            {tab === 'perks' && (\r\n              <>\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\r\n                  Perks\r\n                </h2>\r\n                {perksNote && (\r\n                   <div className=\"mb-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded text-sm text-blue-200\">\r\n                     {perksNote}\r\n                   </div>\r\n                )}\r\n                \r\n                <div className=\"mb-6 bg-black/20 p-4 rounded-lg border border-white/10\">\r\n                   <label className=\"text-sm text-gray-400 mb-2 block\">Duration Multiplier</label>\r\n                   <div className=\"flex gap-2\">\r\n                     {[1, 2, 5, 10].map(m => (\r\n                       <button\r\n                         key={m}\r\n                         onClick={() => setDurationMultiplier(m)}\r\n                         className={`px-3 py-1 rounded text-sm ${durationMultiplier === m ? 'bg-purple-600 text-white' : 'bg-zinc-800 text-gray-400'}`}\r\n                       >\r\n                         {m}x\r\n                       </button>\r\n                     ))}\r\n                   </div>\r\n                   <p className=\"text-xs text-gray-500 mt-2\">\r\n                     Extend perk duration by purchasing multiple units at once.\r\n                   </p>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {perks.map((perk) => {\r\n                    const price = getPerkPrice(perk) * durationMultiplier;\r\n                    const duration = (perk.duration_minutes || 0) * durationMultiplier;\r\n                    const isRestricted = perk.role_required === 'officer' && !(isOfficer || isAdmin || isSecretary);\r\n                    \r\n                    return (\r\n                    <div key={perk.id} className={`bg-black/40 p-4 rounded-lg border ${isRestricted ? 'border-red-500/20 opacity-75' : 'border-purple-500/20'}`}>\r\n                      <div className=\"flex justify-between items-start\">\r\n                        <div className=\"font-semibold text-lg\">{perk.name}</div>\r\n                        {perk.role_required === 'officer' && (\r\n                          <span className=\"text-[10px] uppercase bg-red-900/50 text-red-200 px-1.5 py-0.5 rounded border border-red-500/30\">Officer</span>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-400 mb-2\">{perk.description}</div>\r\n                      <div className=\"text-xs text-purple-300 mb-2\">Duration: {duration} mins</div>\r\n                      <div className=\"flex justify-between items-center mt-4\">\r\n                        <span className=\"text-yellow-400 font-bold\">{formatCoins(price)}</span>\r\n                        <button\r\n                          onClick={() => buyPerk(perk)}\r\n                          disabled={isRestricted}\r\n                          className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-semibold\"\r\n                        >\r\n                          {isRestricted ? 'Locked' : 'Buy'}\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  )})}\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Insurance */}\r\n            {tab === 'insurance' && (\r\n              <>\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\r\n                  Insurance Plans\r\n                </h2>\r\n                {insuranceNote && (\r\n                   <div className=\"mb-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded text-sm text-blue-200\">\r\n                     {insuranceNote}\r\n                   </div>\r\n                )}\r\n                \r\n                <div className=\"mb-6 bg-black/20 p-4 rounded-lg border border-white/10\">\r\n                   <label className=\"text-sm text-gray-400 mb-2 block\">Duration Multiplier</label>\r\n                   <div className=\"flex gap-2\">\r\n                     {[1, 2, 4].map(m => (\r\n                       <button\r\n                         key={m}\r\n                         onClick={() => setDurationMultiplier(m)}\r\n                         className={`px-3 py-1 rounded text-sm ${durationMultiplier === m ? 'bg-purple-600 text-white' : 'bg-zinc-800 text-gray-400'}`}\r\n                       >\r\n                         {m}x\r\n                       </button>\r\n                     ))}\r\n                   </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {plans.map((plan) => {\r\n                    const price = (plan.cost || 0) * durationMultiplier;\r\n                    const duration = (plan.duration_hours || 0) * durationMultiplier;\r\n                    \r\n                    return (\r\n                    <div key={plan.id} className=\"bg-black/40 p-4 rounded-lg border border-purple-500/20\">\r\n                      <div className=\"font-semibold text-lg\">{plan.name}</div>\r\n                      <div className=\"text-sm text-gray-400 mb-2\">{plan.description}</div>\r\n                      <div className=\"text-xs text-purple-300 mb-2\">Duration: {duration} hours</div>\r\n                      <div className=\"flex justify-between items-center mt-4\">\r\n                        <span className=\"text-yellow-400 font-bold\">{formatCoins(price)}</span>\r\n                        <button\r\n                          onClick={() => buyInsurance(plan)}\r\n                          className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold\"\r\n                        >\r\n                          Buy\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  )})}\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Call Minutes */}\r\n            {tab === 'calls' && (\r\n              <>\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\r\n                  Call Minutes\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                   <div>\r\n                     <h3 className=\"text-lg font-semibold mb-3 text-blue-300\">Audio Calls</h3>\r\n                     <div className=\"space-y-3\">\r\n                       {callPackages.audio.map(pkg => (\r\n                         <div key={pkg.id} className=\"flex justify-between items-center bg-black/30 p-3 rounded border border-white/10\">\r\n                           <div>\r\n                             <div className=\"font-medium\">{pkg.name}</div>\r\n                             <div className=\"text-xs text-gray-400\">{pkg.minutes} minutes</div>\r\n                           </div>\r\n                           <button\r\n                             onClick={() => buyCallMinutes({...pkg, type: 'audio'})}\r\n                             disabled={loadingPackage === pkg.id}\r\n                             className=\"px-3 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-xs flex items-center gap-2\"\r\n                           >\r\n                             <span className=\"text-yellow-400\">{formatCoins(pkg.totalCost)}</span>\r\n                             {loadingPackage === pkg.id ? '...' : 'Buy'}\r\n                           </button>\r\n                         </div>\r\n                       ))}\r\n                     </div>\r\n                   </div>\r\n                   \r\n                   <div>\r\n                     <h3 className=\"text-lg font-semibold mb-3 text-pink-300\">Video Calls</h3>\r\n                     <div className=\"space-y-3\">\r\n                       {callPackages.video.map(pkg => (\r\n                         <div key={pkg.id} className=\"flex justify-between items-center bg-black/30 p-3 rounded border border-white/10\">\r\n                           <div>\r\n                             <div className=\"font-medium\">{pkg.name}</div>\r\n                             <div className=\"text-xs text-gray-400\">{pkg.minutes} minutes</div>\r\n                           </div>\r\n                           <button\r\n                             onClick={() => buyCallMinutes({...pkg, type: 'video'})}\r\n                             disabled={loadingPackage === pkg.id}\r\n                             className=\"px-3 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-xs flex items-center gap-2\"\r\n                           >\r\n                             <span className=\"text-yellow-400\">{formatCoins(pkg.totalCost)}</span>\r\n                             {loadingPackage === pkg.id ? '...' : 'Buy'}\r\n                           </button>\r\n                         </div>\r\n                       ))}\r\n                     </div>\r\n                   </div>\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Chat Sounds */}\n            {tab === 'chat_sounds' && (\n              <>\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\n                  Chat Message Sounds\n                </h2>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {callSounds.map((sound) => {\n                    const isOwned = ownedCallSoundIds.has(sound.id);\n                    const isActive = activeCallSounds['chat'] === sound.id;\n                    \n                    return (\n                      <div key={sound.id} className={`bg-zinc-900 rounded-xl p-4 border transition-all ${isActive ? 'border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.3)]' : 'border-[#2C2C2C]'}`}>\n                        <div className=\"flex justify-between items-start mb-3\">\n                          <div>\n                            <h3 className=\"font-bold text-white\">{sound.name}</h3>\n                            <div className=\"text-xs text-yellow-400 mt-1\">{formatCoins(sound.cost)}</div>\n                          </div>\n                          {isActive && <CheckCircle className=\"w-5 h-5 text-green-500\" />}\n                        </div>\n                        \n                        <div className=\"flex gap-2 mt-4\">\n                          <button\n                            onClick={() => {\n                              const audio = new Audio(sound.file_path);\n                              audio.play().catch(e => toast.error('Preview failed'));\n                            }}\n                            className=\"flex-1 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm font-semibold transition-colors\"\n                          >\n                            Preview\n                          </button>\n                          \n                          {isOwned ? (\n                            <button\n                              onClick={() => equipSound(sound)}\n                              disabled={isActive}\n                              className={`flex-1 py-2 rounded text-sm font-semibold transition-colors ${\n                                isActive \n                                  ? 'bg-green-500/20 text-green-400 cursor-default'\n                                  : 'bg-purple-600 hover:bg-purple-700 text-white'\n                              }`}\n                            >\n                              {isActive ? 'Equipped' : 'Equip'}\n                            </button>\n                          ) : (\n                            <button\n                              onClick={() => buyCallSound(sound)}\n                              disabled={callSoundPurchasing === sound.id}\n                              className=\"flex-1 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-semibold transition-colors\"\n                            >\n                              {callSoundPurchasing === sound.id ? '...' : 'Buy'}\n                            </button>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </>\n            )}\n\n            {/* Broadcast Themes */}\r\n            {tab === 'broadcast_themes' && (\r\n              <>\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\r\n                  Broadcast Themes\r\n                </h2>\r\n                {themesNote && (\r\n                   <div className=\"mb-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded text-sm text-blue-200\">\r\n                     {themesNote}\r\n                   </div>\r\n                )}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {broadcastThemes.map((theme) => {\r\n                    const owned = ownedThemeIds.has(theme.id);\r\n                    const eligibility = getEligibility(theme);\r\n                    \r\n                    return (\r\n                    <div key={theme.id} className={`bg-black/40 p-4 rounded-lg border ${owned ? 'border-green-500/30' : 'border-purple-500/20'} relative overflow-hidden`}>\r\n                      {owned && <div className=\"absolute top-2 right-2 bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded\">Owned</div>}\r\n                      \r\n                      <div className=\"h-24 mb-3 rounded w-full overflow-hidden relative\">\r\n                        {theme.image_url ? (\r\n                          <img src={theme.image_url} alt={theme.name} className=\"w-full h-full object-cover\" />\r\n                        ) : (\r\n                          (() => {\r\n                            // Custom preview by theme name\r\n                            const name = (theme.name || '').toLowerCase();\r\n                            if (name.includes('royal purple')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-purple-800 via-purple-600 to-purple-900\">\r\n                                  <span className=\"text-yellow-200 text-xs font-bold drop-shadow\">Royal Purple</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('cyber neon')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-cyan-400 via-fuchsia-500 to-blue-900 animate-pulse\">\r\n                                  <span className=\"text-cyan-100 text-xs font-bold drop-shadow\">Cyber Neon</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('gamer rgb')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center rgb-frame\">\r\n                                  <span className=\"text-white text-xs font-bold drop-shadow\">Gamer RGB</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('neon purple haze')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-purple-700 via-fuchsia-500 to-pink-700 blur-[1px]\">\r\n                                  <span className=\"text-pink-100 text-xs font-bold drop-shadow\">Neon Purple Haze</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('neon aurora')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-cyan-300 via-pink-400 to-purple-900 animate-pulse\">\r\n                                  <span className=\"text-cyan-50 text-xs font-bold drop-shadow\">Neon Aurora</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('pink velocity')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-pink-500 via-pink-700 to-fuchsia-900 animate-pulse\">\r\n                                  <span className=\"text-white text-xs font-bold drop-shadow\">Pink Velocity</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('troll city grid')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-900 via-purple-900 to-cyan-900\">\r\n                                  <span className=\"text-cyan-200 text-xs font-bold drop-shadow\">Troll City Grid</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('golden crown')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-yellow-400 via-yellow-600 to-yellow-900\">\r\n                                  <span className=\"text-yellow-100 text-xs font-bold drop-shadow\">Golden Crown</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('cyan fog')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-cyan-200 via-cyan-400 to-cyan-900\">\r\n                                  <span className=\"text-cyan-900 text-xs font-bold drop-shadow\">Cyan Fog</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('midnight violet')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-violet-900 via-violet-700 to-violet-950\">\r\n                                  <span className=\"text-violet-200 text-xs font-bold drop-shadow\">Midnight Violet</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('neon circuit')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-cyan-400 via-blue-700 to-fuchsia-700 animate-pulse\">\r\n                                  <span className=\"text-cyan-50 text-xs font-bold drop-shadow\">Neon Circuit</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('pink haze')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-pink-200 via-pink-400 to-pink-900\">\r\n                                  <span className=\"text-pink-900 text-xs font-bold drop-shadow\">Pink Haze</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('aurora wave')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-cyan-200 via-pink-200 to-purple-900 animate-pulse\">\r\n                                  <span className=\"text-cyan-900 text-xs font-bold drop-shadow\">Aurora Wave</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('lava room')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-yellow-900 via-red-700 to-orange-900 animate-pulse\">\r\n                                  <span className=\"text-orange-100 text-xs font-bold drop-shadow\">Lava Room</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('galaxy warp')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-900 via-purple-900 to-black animate-pulse\">\r\n                                  <span className=\"text-white text-xs font-bold drop-shadow\">Galaxy Warp</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('diamond night')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-900 via-blue-900 to-white animate-pulse\">\r\n                                  <span className=\"text-blue-200 text-xs font-bold drop-shadow\">Diamond Night</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('cyber rose')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-pink-400 via-fuchsia-700 to-black animate-pulse\">\r\n                                  <span className=\"text-pink-100 text-xs font-bold drop-shadow\">Cyber Rose</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('royal velvet')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-purple-900 via-purple-700 to-black animate-pulse\">\r\n                                  <span className=\"text-purple-100 text-xs font-bold drop-shadow\">Royal Velvet</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('stormlight')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-200 via-blue-400 to-blue-900 animate-pulse\">\r\n                                  <span className=\"text-blue-900 text-xs font-bold drop-shadow\">Stormlight</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('midnight surge')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-violet-900 via-blue-900 to-black animate-pulse\">\r\n                                  <span className=\"text-violet-100 text-xs font-bold drop-shadow\">Midnight Surge</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            if (name.includes('pink static')) {\r\n                              return (\r\n                                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-pink-200 via-pink-500 to-pink-900 animate-pulse\">\r\n                                  <span className=\"text-pink-900 text-xs font-bold drop-shadow\">Pink Static</span>\r\n                                </div>\r\n                              );\r\n                            }\r\n                            // Default fallback\r\n                            return (\r\n                              <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-purple-900 via-zinc-800 to-pink-900\">\r\n                                <span className=\"text-white/70 text-xs font-bold drop-shadow\">{theme.name || 'No Preview'}</span>\r\n                              </div>\r\n                            );\r\n                          })()\r\n                        )}\r\n                      </div>\r\n                      \r\n                      <div className=\"font-semibold text-lg\">{theme.name}</div>\r\n                      <div className=\"text-sm text-gray-400 mb-2 line-clamp-2\">{theme.description}</div>\r\n                      \r\n                      {!eligibility.isEligible && (\r\n                        <div className=\"text-xs text-red-400 mb-2\">\r\n                           {eligibility.seasonalState || 'Requirements not met'}\r\n                        </div>\r\n                      )}\r\n                      \r\n                      <div className=\"flex justify-between items-center mt-4\">\r\n                        <span className=\"text-yellow-400 font-bold\">{formatCoins(theme.price_coins || 0)}</span>\r\n                        <button\r\n                          onClick={() => buyBroadcastTheme(theme)}\r\n                          disabled={owned || !eligibility.isEligible || themePurchasing === theme.id}\r\n                          className={`px-3 py-1 rounded text-sm font-semibold ${owned ? 'bg-zinc-700 text-gray-400 cursor-default' : 'bg-purple-600 hover:bg-purple-700'}`}\r\n                        >\r\n                          {owned ? 'Owned' : themePurchasing === theme.id ? '...' : 'Buy'}\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  )})}\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Live Snacks */}\r\n            {tab === 'live_snacks' && showLiveSnacks && (\r\n              <>\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <ShoppingCart className=\"w-5 h-5 text-purple-400\" />\r\n                  Live Snacks\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                   <div className=\"bg-black/40 p-4 rounded-lg border border-purple-500/20\">\r\n                      <div className=\"font-semibold text-lg\">üçø Popcorn</div>\r\n                      <div className=\"text-sm text-gray-400 mb-2\">Boost momentum slightly</div>\r\n                      <div className=\"flex justify-between items-center mt-4\">\r\n                        <span className=\"text-yellow-400 font-bold\">50</span>\r\n                        <button\r\n                          onClick={() => buySnack('popcorn')}\r\n                          disabled={snackLoading === 'popcorn' || !canBuySnack('popcorn')}\r\n                          className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold disabled:opacity-50\"\r\n                        >\r\n                          {snackLoading === 'popcorn' ? '...' : 'Buy'}\r\n                        </button>\r\n                      </div>\r\n                   </div>\r\n                   <div className=\"bg-black/40 p-4 rounded-lg border border-purple-500/20\">\r\n                      <div className=\"font-semibold text-lg\">üçï Pizza</div>\r\n                      <div className=\"text-sm text-gray-400 mb-2\">Boost momentum moderate</div>\r\n                      <div className=\"flex justify-between items-center mt-4\">\r\n                        <span className=\"text-yellow-400 font-bold\">150</span>\r\n                        <button\r\n                          onClick={() => buySnack('pizza')}\r\n                          disabled={snackLoading === 'pizza' || !canBuySnack('pizza')}\r\n                          className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold disabled:opacity-50\"\r\n                        >\r\n                          {snackLoading === 'pizza' ? '...' : 'Buy'}\r\n                        </button>\r\n                      </div>\r\n                   </div>\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n          </div>\r\n        </div>\r\n        \r\n        <CashAppPaymentModal\r\n          isOpen={cashAppModalOpen}\r\n          onClose={() => setCashAppModalOpen(false)}\r\n          amount={selectedPackage?.price ? parseFloat(String(selectedPackage.price).replace('$','')) : 0}\r\n          packageId={selectedPackage?.id}\r\n          coins={selectedPackage?.coins}\r\n          purchaseType={selectedPackage?.purchaseType || 'coin_package'}\r\n          onSuccess={() => {\r\n            setCashAppModalOpen(false);\r\n            showPurchaseCompleteOverlay();\r\n            refreshCoins();\r\n            // Duplicate toast removed\r\n          }}\r\n        />\r\n        </div>\r\n      )\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CoinStoreProd.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CoinsComplete.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CommandBattleGoLive.jsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":353,"column":25,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click &quot;Join Box\" on any empty box to start broadcasting"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click &ldquo;Join Box\" on any empty box to start broadcasting"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click &#34;Join Box\" on any empty box to start broadcasting"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click &rdquo;Join Box\" on any empty box to start broadcasting"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":353,"column":34,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click \"Join Box&quot; on any empty box to start broadcasting"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click \"Join Box&ldquo; on any empty box to start broadcasting"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click \"Join Box&#34; on any empty box to start broadcasting"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[12146,12203],"text":"‚Ä¢ Click \"Join Box&rdquo; on any empty box to start broadcasting"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { Room, RoomEvent, createLocalVideoTrack, createLocalAudioTrack } from 'livekit-client';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { toast } from 'sonner';\r\nimport { Video, Users, Gift, Timer } from 'lucide-react';\r\n\r\nconst CommandBattleGoLive = () => {\r\n  const { user, profile } = useAuthStore();\r\n  const [boxCount, setBoxCount] = useState(2);\r\n  const [room, setRoom] = useState(null);\r\n  const [participants, setParticipants] = useState({});\r\n  const [isConnecting, setIsConnecting] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const [battleTimer, setBattleTimer] = useState(0);\r\n  const [roomName] = useState('command_battle_room');\r\n  \r\n  // Gift tracking for each box\r\n  const [boxGifts, setBoxGifts] = useState({});\r\n\r\n  // Timer effect\r\n  useEffect(() => {\r\n    const timer = setInterval(() => {\r\n      setBattleTimer(prev => prev + 1);\r\n    }, 1000);\r\n\r\n    return () => clearInterval(timer);\r\n  }, []);\r\n\r\n  // Initialize gift tracking for each box\r\n  useEffect(() => {\r\n    const initialGifts = {};\r\n    for (let i = 1; i <= boxCount; i++) {\r\n      initialGifts[i] = { total: 0, recent: [] };\r\n    }\r\n    setBoxGifts(initialGifts);\r\n\r\n    // Subscribe to gift events for realtime updates\r\n    const giftsChannel = supabase\r\n      .channel('battle-gifts')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'battle_gifts'\r\n        },\r\n        (payload) => {\r\n          const gift = payload.new;\r\n          const boxNum = parseInt(gift.position || '1');\r\n          setBoxGifts(prev => ({\r\n            ...prev,\r\n            [boxNum]: {\r\n              total: (prev[boxNum]?.total || 0) + gift.coins_spent,\r\n              recent: [...(prev[boxNum]?.recent || []), gift].slice(-5)\r\n            }\r\n          }));\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(giftsChannel);\r\n    };\r\n  }, [boxCount]);\r\n\r\n  // Format time for display\r\n  const formatTime = (seconds) => {\r\n    const mins = Math.floor(seconds / 60);\r\n    const secs = seconds % 60;\r\n    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\r\n  };\r\n\r\n  // Get grid layout classes based on box count\r\n  const getGridClasses = (count) => {\r\n    switch (count) {\r\n      case 1: return 'grid-cols-1';\r\n      case 2: return 'grid-cols-2';\r\n      case 3:\r\n      case 4: return 'grid-cols-2';\r\n      case 5:\r\n      case 6: return 'grid-cols-3';\r\n      default: return 'grid-cols-2';\r\n    }\r\n  };\r\n\r\n  // Join a specific box\r\n  const joinBox = async (boxNumber) => {\r\n    if (!user || !profile) {\r\n      toast.error('You must be logged in');\r\n      return;\r\n    }\r\n\r\n    setIsConnecting(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Get LiveKit token with position metadata\r\n      const tokenResponse = await fetch(`/api/livekit/token?role=broadcaster&position=${boxNumber}`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`\r\n        },\r\n        body: JSON.stringify({\r\n          room: roomName,\r\n          identity: user.email || user.id,\r\n          metadata: { position: boxNumber.toString() }\r\n        })\r\n      });\r\n\r\n      if (!tokenResponse.ok) {\r\n        throw new Error('Failed to get LiveKit token');\r\n      }\r\n\r\n      const { token, livekitUrl } = await tokenResponse.json();\r\n\r\n      if (!token || !livekitUrl) {\r\n        throw new Error('Invalid token response');\r\n      }\r\n\r\n      // Create and connect room\r\n      const newRoom = new Room({\r\n        adaptiveStream: true,\r\n        dynacast: true,\r\n      });\r\n\r\n      // Set up event listeners\r\n      newRoom.on(RoomEvent.Connected, () => {\r\n        console.log(`Connected to box ${boxNumber}`);\r\n        setIsConnecting(false);\r\n        setRoom(newRoom);\r\n\r\n        // Publish local tracks\r\n        const publishTracks = async () => {\r\n          try {\r\n            const [videoTrack, audioTrack] = await Promise.all([\r\n              createLocalVideoTrack({ facingMode: 'user' }),\r\n              createLocalAudioTrack()\r\n            ]);\r\n\r\n            await newRoom.localParticipant.publishTrack(videoTrack);\r\n            await newRoom.localParticipant.publishTrack(audioTrack);\r\n            \r\n            toast.success(`Joined Box ${boxNumber}!`);\r\n          } catch (err) {\r\n            console.error('Error publishing tracks:', err);\r\n            toast.error('Failed to start camera/microphone');\r\n          }\r\n        };\r\n\r\n        publishTracks();\r\n      });\r\n\r\n      newRoom.on(RoomEvent.Disconnected, () => {\r\n        console.log(`Disconnected from box ${boxNumber}`);\r\n        setRoom(null);\r\n        toast.info(`Left Box ${boxNumber}`);\r\n      });\r\n\r\n      newRoom.on(RoomEvent.ParticipantConnected, (participant) => {\r\n        console.log('Participant connected:', participant.identity);\r\n        // Parse metadata to get position\r\n        const metadata = participant.metadata ? JSON.parse(participant.metadata) : {};\r\n        const position = metadata.position || '1';\r\n        \r\n        setParticipants(prev => ({\r\n          ...prev,\r\n          [position]: participant\r\n        }));\r\n      });\r\n\r\n      newRoom.on(RoomEvent.ParticipantDisconnected, (participant) => {\r\n        console.log('Participant disconnected:', participant.identity);\r\n        // Remove from participants map\r\n        setParticipants(prev => {\r\n          const updated = { ...prev };\r\n          Object.keys(updated).forEach(key => {\r\n            if (updated[key]?.identity === participant.identity) {\r\n              delete updated[key];\r\n            }\r\n          });\r\n          return updated;\r\n        });\r\n      });\r\n\r\n      newRoom.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {\r\n        console.log('Track subscribed:', track.kind, participant.identity);\r\n      });\r\n\r\n      newRoom.on(RoomEvent.TrackUnsubscribed, (track) => {\r\n        console.log('Track unsubscribed:', track.kind);\r\n      });\r\n\r\n      // Connect to room\r\n      await newRoom.connect(livekitUrl, token);\r\n\r\n    } catch (err) {\r\n      console.error('Error joining box:', err);\r\n      setError(err.message);\r\n      setIsConnecting(false);\r\n      toast.error('Failed to join box');\r\n    }\r\n  };\r\n\r\n  // Leave current box\r\n  const leaveBox = () => {\r\n    if (room) {\r\n      room.disconnect();\r\n      setRoom(null);\r\n    }\r\n  };\r\n\r\n  // Render individual box\r\n  const renderBox = (boxNumber) => {\r\n    const participant = participants[boxNumber];\r\n    const gifts = boxGifts[boxNumber] || { total: 0, recent: [] };\r\n\r\n    return (\r\n      <div key={boxNumber} className=\"relative bg-black rounded-xl overflow-hidden aspect-video\">\r\n        {participant ? (\r\n          // Active participant\r\n          <div className=\"w-full h-full\">\r\n            <VideoRenderer \r\n              participant={participant} \r\n              position={boxNumber}\r\n            />\r\n            <div className=\"absolute bottom-2 left-2 bg-black/60 text-white px-2 py-1 rounded text-sm\">\r\n              Box {boxNumber}\r\n            </div>\r\n            <div className=\"absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded text-xs\">\r\n              LIVE\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          // Waiting state\r\n          <div className=\"w-full h-full flex flex-col items-center justify-center text-gray-400\">\r\n            <Users className=\"w-12 h-12 mb-4\" />\r\n            <div className=\"text-lg font-semibold\">Waiting for Broadcaster...</div>\r\n            <div className=\"text-sm mb-4\">Box {boxNumber}</div>\r\n            <button\r\n              onClick={() => joinBox(boxNumber)}\r\n              disabled={isConnecting || room !== null}\r\n              className=\"bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors\"\r\n            >\r\n              {isConnecting ? 'Connecting...' : `Join Box ${boxNumber}`}\r\n            </button>\r\n          </div>\r\n        )}\r\n\r\n        {/* Gift counter */}\r\n        <div className=\"absolute bottom-2 right-2 bg-black/60 text-yellow-400 px-2 py-1 rounded text-sm flex items-center gap-1\">\r\n          <Gift className=\"w-4 h-4\" />\r\n          {gifts.total.toLocaleString()}\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-b from-purple-900 to-black text-white p-6\">\r\n      <div className=\"max-w-7xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"text-center\">\r\n          <h1 className=\"text-4xl font-bold mb-2 flex items-center justify-center gap-3\">\r\n            <Video className=\"w-10 h-10 text-purple-400\" />\r\n            COMMAND BATTLE ‚Äî GO LIVE\r\n          </h1>\r\n          <p className=\"text-gray-300\">Multi-box streaming with LiveKit</p>\r\n        </div>\r\n\r\n        {/* Battle Timer */}\r\n        <div className=\"bg-purple-900/50 border border-purple-500/50 rounded-xl p-4 text-center\">\r\n          <div className=\"flex items-center justify-center gap-2 text-2xl font-bold\">\r\n            <Timer className=\"w-6 h-6\" />\r\n            BATTLE TIME: {formatTime(battleTimer)}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Box Count Selector */}\r\n        <div className=\"bg-[#111320] border border-purple-700/50 rounded-xl p-6\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <label className=\"text-lg font-semibold\">Number of Boxes: {boxCount}</label>\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={() => setBoxCount(Math.max(1, boxCount - 1))}\r\n                className=\"bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded\"\r\n                disabled={boxCount <= 1}\r\n              >\r\n                -\r\n              </button>\r\n              <button\r\n                onClick={() => setBoxCount(Math.min(6, boxCount + 1))}\r\n                className=\"bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded\"\r\n                disabled={boxCount >= 6}\r\n              >\r\n                +\r\n              </button>\r\n            </div>\r\n          </div>\r\n          \r\n          <input\r\n            type=\"range\"\r\n            min=\"1\"\r\n            max=\"6\"\r\n            value={boxCount}\r\n            onChange={(e) => setBoxCount(parseInt(e.target.value))}\r\n            className=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer\"\r\n          />\r\n          \r\n          <div className=\"flex justify-between text-xs text-gray-400 mt-2\">\r\n            <span>1 Box</span>\r\n            <span>2 Boxes</span>\r\n            <span>3 Boxes</span>\r\n            <span>4 Boxes</span>\r\n            <span>5 Boxes</span>\r\n            <span>6 Boxes</span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Error Display */}\r\n        {error && (\r\n          <div className=\"bg-red-900/50 border border-red-500 rounded-xl p-4\">\r\n            <p className=\"text-red-200\">Error: {error}</p>\r\n          </div>\r\n        )}\r\n\r\n        {/* Video Grid */}\r\n        <div className={`grid gap-4 ${getGridClasses(boxCount)}`}>\r\n          {Array.from({ length: boxCount }, (_, i) => renderBox(i + 1))}\r\n        </div>\r\n\r\n        {/* Current Status */}\r\n        {room && (\r\n          <div className=\"bg-green-900/50 border border-green-500 rounded-xl p-4 text-center\">\r\n            <p className=\"text-green-200 font-semibold\">\r\n              ‚úÖ Connected to LiveKit room. You are broadcasting!\r\n            </p>\r\n            <button\r\n              onClick={leaveBox}\r\n              className=\"mt-2 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors\"\r\n            >\r\n              Leave Stream\r\n            </button>\r\n          </div>\r\n        )}\r\n\r\n        {/* Instructions */}\r\n        <div className=\"bg-[#111320] border border-gray-700 rounded-xl p-6\">\r\n          <h3 className=\"text-lg font-semibold mb-3\">How to Use:</h3>\r\n          <ul className=\"space-y-2 text-gray-300\">\r\n            <li>‚Ä¢ Select the number of streaming boxes (1-6)</li>\r\n            <li>‚Ä¢ Click \"Join Box\" on any empty box to start broadcasting</li>\r\n            <li>‚Ä¢ Viewers can send gifts that appear in real-time</li>\r\n            <li>‚Ä¢ Each box represents a different broadcaster position</li>\r\n            <li>‚Ä¢ Use LiveKit metadata to route participants to correct boxes</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// VideoRenderer component for displaying participant video\r\nconst VideoRenderer = ({ participant, position: _position }) => {\r\n  const videoRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    const handleTrackSubscribed = (track, _publication) => {\r\n      if (track.kind === 'video' && videoRef.current) {\r\n        track.attach(videoRef.current);\r\n      }\r\n    };\r\n\r\n    const handleTrackUnsubscribed = (track) => {\r\n      track.detach();\r\n    };\r\n\r\n    // Subscribe to existing tracks\r\n    participant.tracks.forEach((publication) => {\r\n      if (publication.track) {\r\n        handleTrackSubscribed(publication.track, publication);\r\n      }\r\n    });\r\n\r\n    // Listen for new tracks\r\n    participant.on(RoomEvent.TrackSubscribed, handleTrackSubscribed);\r\n    participant.on(RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed);\r\n\r\n    return () => {\r\n      participant.off(RoomEvent.TrackSubscribed, handleTrackSubscribed);\r\n      participant.off(RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed);\r\n      \r\n      // Clean up tracks\r\n      participant.tracks.forEach((publication) => {\r\n        if (publication.track) {\r\n          publication.track.detach();\r\n        }\r\n      });\r\n    };\r\n  }, [participant]);\r\n\r\n  return (\r\n    <video\r\n      ref={videoRef}\r\n      autoPlay\r\n      playsInline\r\n      className=\"w-full h-full object-cover\"\r\n    />\r\n  );\r\n};\r\n\r\nexport default CommandBattleGoLive;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CourtRoom.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CourtRoomLegacy.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreatorAgreement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreatorApplication.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":231,"column":60,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You&apos;ll be notified once it's processed.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You&lsquo;ll be notified once it's processed.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You&#39;ll be notified once it's processed.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You&rsquo;ll be notified once it's processed.\r\n            "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":231,"column":83,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You'll be notified once it&apos;s processed.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You'll be notified once it&lsquo;s processed.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You'll be notified once it&#39;s processed.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8293,8404],"text":"\r\n              Your creator application is under review. You'll be notified once it&rsquo;s processed.\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom';\r\n;\r\nimport { Card, CardHeader, CardTitle, CardContent } from '../components/ui/card';\r\nimport { Button } from '../components/ui/button';\r\nimport { Badge } from '../components/ui/badge';\r\nimport { Loader2, CheckCircle, XCircle, Clock } from 'lucide-react';\r\nimport { supabase } from '../supabaseClient';\r\n\r\ninterface FormErrors {\r\n  experienceText?: string;\r\n  goalsText?: string;\r\n  empirePartnerReason?: string;\r\n}\r\n\r\nexport function CreatorApplication() {\r\n  const navigate = useNavigate();\r\n  \r\n  const [loading, setLoading] = useState(true);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [applicationStatus, setApplicationStatus] = useState(null);\r\n  \r\n  // Form state\r\n  const [formData, setFormData] = useState({\r\n    experienceText: '',\r\n    socialLinks: '',\r\n    goalsText: '',\r\n    empirePartnerRequest: false,\r\n    empirePartnerReason: '',\r\n    category: 'broadcaster'\r\n  });\r\n  const [errors, setErrors] = useState<FormErrors>({});\r\n\r\n  useEffect(() => {\r\n    loadUserStatus();\r\n  }, []);\r\n\r\n  const loadUserStatus = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      const { data: application, error } = await supabase\r\n        .from('creator_applications')\r\n        .select('*')\r\n        .eq('user_id', user.id)\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (error && error.code !== 'PGRST116') throw error;\r\n\r\n      setApplicationStatus(application);\r\n\r\n      // Pre-fill form if application exists\r\n      if (application) {\r\n        setFormData({\r\n          experienceText: application.experience_text || '',\r\n          socialLinks: application.social_links || '',\r\n          goalsText: application.goals_text || '',\r\n          empirePartnerRequest: application.empire_partner_request || false,\r\n          empirePartnerReason: application.empire_partner_reason || '',\r\n          category: application.category || 'broadcaster'\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading status:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\r\n    const target = e.target as HTMLInputElement | HTMLTextAreaElement;\r\n    const { name, value, type } = target as HTMLInputElement;\r\n    const checked = (target as HTMLInputElement).checked;\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [name]: type === 'checkbox' ? checked : value\r\n    }));\r\n    \r\n    // Clear error when user starts typing\r\n    if (errors[name]) {\r\n      setErrors(prev => ({ ...prev, [name]: '' }));\r\n    }\r\n  };\r\n\r\n  const validateForm = () => {\r\n    const newErrors: FormErrors = {};\r\n    \r\n    if (!formData.experienceText.trim()) {\r\n      newErrors.experienceText = 'Streaming experience is required';\r\n    }\r\n    \r\n    if (!formData.goalsText.trim()) {\r\n      newErrors.goalsText = 'Goals are required';\r\n    }\r\n    \r\n    if (formData.empirePartnerRequest && !formData.empirePartnerReason.trim()) {\r\n      newErrors.empirePartnerReason = 'Empire Partner reason is required when applying for partnership';\r\n    }\r\n    \r\n    setErrors(newErrors);\r\n    return Object.keys(newErrors).length === 0;\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    e.preventDefault();\r\n\r\n    if (!validateForm()) return;\r\n\r\n    try {\r\n      setSubmitting(true);\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      const { error } = await supabase\r\n        .from('creator_applications')\r\n        .insert({\r\n          user_id: user.id,\r\n          experience_text: formData.experienceText,\r\n          social_links: formData.socialLinks,\r\n          goals_text: formData.goalsText,\r\n          empire_partner_request: formData.empirePartnerRequest,\r\n          empire_partner_reason: formData.empirePartnerReason,\r\n          category: formData.category,\r\n          status: 'pending',\r\n        });\r\n\r\n      if (error) throw error;\r\n\r\n      navigate('/creator-application/status');\r\n    } catch (error) {\r\n      console.error('Error submitting application:', error);\r\n      alert('Failed to submit application. Please try again.');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  // Show loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center\">\r\n        <div className=\"flex items-center gap-2 text-slate-300\">\r\n          <Loader2 className=\"w-6 h-6 animate-spin\" />\r\n          <span>Loading application status...</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n\r\n  // Show existing application status\r\n  if (applicationStatus && applicationStatus.status !== 'pending') {\r\n    const statusConfig = {\r\n      approved: { icon: CheckCircle, color: 'text-green-500', bg: 'bg-green-500/10' },\r\n      denied: { icon: XCircle, color: 'text-red-500', bg: 'bg-red-500/10' }\r\n    };\r\n    \r\n    const config = statusConfig[applicationStatus.status];\r\n    const StatusIcon = config.icon;\r\n    \r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4\">\r\n        <Card className=\"bg-slate-950/60 border-slate-800 max-w-md\">\r\n          <CardContent className=\"p-6 text-center\">\r\n            <div className={`w-16 h-16 ${config.bg} rounded-full flex items-center justify-center mx-auto mb-4`}>\r\n              <StatusIcon className={`w-8 h-8 ${config.color}`} />\r\n            </div>\r\n            <h2 className=\"text-xl font-bold text-slate-50 mb-2\">\r\n              Application {applicationStatus.status === 'approved' ? 'Approved' : 'Denied'}\r\n            </h2>\r\n            <Badge \r\n              variant=\"outline\" \r\n              className={`mb-4 ${\r\n                applicationStatus.status === 'approved' \r\n                  ? 'border-green-500 text-green-400' \r\n                  : 'border-red-500 text-red-400'\r\n              }`}\r\n            >\r\n              {applicationStatus.status}\r\n            </Badge>\r\n            {applicationStatus.reviewer_notes && (\r\n              <div className=\"bg-slate-800/50 p-3 rounded-lg mb-4\">\r\n                <p className=\"text-sm text-slate-300\">\r\n                  <strong>Reviewer Notes:</strong><br />\r\n                  {applicationStatus.reviewer_notes}\r\n                </p>\r\n              </div>\r\n            )}\r\n            {applicationStatus.status === 'denied' && (\r\n                <Button\r\n                  onClick={() => setApplicationStatus(null)}\r\n                  variant=\"outline\"\r\n                  className=\"border-slate-600 text-slate-300\"\r\n                  disabled={false}\r\n                >\r\n                Submit New Application\r\n              </Button>\r\n            )}\r\n            {applicationStatus.status === 'approved' && (\r\n              <div className=\"space-y-2\">\r\n                <Button\r\n                  onClick={() => navigate('/profile')}\r\n                  className=\"bg-purple-600 hover:bg-purple-700 w-full\"\r\n                  disabled={false}\r\n                >\r\n                  Go to Creator Dashboard\r\n                </Button>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Show pending application status\r\n  if (applicationStatus && applicationStatus.status === 'pending') {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4\">\r\n        <Card className=\"bg-slate-950/60 border-slate-800 max-w-md\">\r\n          <CardContent className=\"p-6 text-center\">\r\n            <div className=\"w-16 h-16 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <Clock className=\"w-8 h-8 text-yellow-500\" />\r\n            </div>\r\n            <h2 className=\"text-xl font-bold text-slate-50 mb-2\">Application Pending</h2>\r\n            <p className=\"text-slate-300 mb-4\">\r\n              Your creator application is under review. You'll be notified once it's processed.\r\n            </p>\r\n            <Button\r\n              onClick={() => navigate('/creator-application/status')}\r\n              variant=\"outline\"\r\n              className=\"border-slate-600 text-slate-300\"\r\n              disabled={false}\r\n            >\r\n              View Application Status\r\n            </Button>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Show application form\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4\">\r\n      <div className=\"max-w-2xl mx-auto\">\r\n        <div className=\"text-center mb-8\">\r\n          <h1 className=\"text-3xl font-bold text-slate-50 mb-2\">Creator Application</h1>\r\n          <p className=\"text-slate-300\">\r\n            Apply to become an approved creator and unlock TrollTract benefits\r\n          </p>\r\n        </div>\r\n\r\n        <Card className=\"bg-slate-950/60 border-slate-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-slate-50\">Application Form</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n              {/* Streaming Experience */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-300 mb-2\">\r\n                  Streaming Experience *\r\n                </label>\r\n                <textarea\r\n                  name=\"experienceText\"\r\n                  value={formData.experienceText}\r\n                  onChange={handleInputChange}\r\n                  placeholder=\"Tell us about your streaming experience, platforms you've used, and your content style...\"\r\n                  rows={4}\r\n                  className={`w-full px-3 py-2 bg-slate-800 border rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 ${\r\n                    errors.experienceText ? 'border-red-500' : 'border-slate-600'\r\n                  }`}\r\n                />\r\n                {errors.experienceText && (\r\n                  <p className=\"text-red-400 text-sm mt-1\">{errors.experienceText}</p>\r\n                )}\r\n              </div>\r\n\r\n              {/* Social Links */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-300 mb-2\">\r\n                  Social Media Links\r\n                </label>\r\n                <textarea\r\n                  name=\"socialLinks\"\r\n                  value={formData.socialLinks}\r\n                  onChange={handleInputChange}\r\n                  placeholder=\"Provide links to your social media profiles, other streaming platforms, etc...\"\r\n                  rows={2}\r\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                />\r\n              </div>\r\n\r\n              {/* Goals */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-300 mb-2\">\r\n                  Goals & Objectives *\r\n                </label>\r\n                <textarea\r\n                  name=\"goalsText\"\r\n                  value={formData.goalsText}\r\n                  onChange={handleInputChange}\r\n                  placeholder=\"What are your goals as a creator? What do you hope to achieve on our platform?\"\r\n                  rows={4}\r\n                  className={`w-full px-3 py-2 bg-slate-800 border rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 ${\r\n                    errors.goalsText ? 'border-red-500' : 'border-slate-600'\r\n                  }`}\r\n                />\r\n                {errors.goalsText && (\r\n                  <p className=\"text-red-400 text-sm mt-1\">{errors.goalsText}</p>\r\n                )}\r\n              </div>\r\n\r\n              {/* Empire Partner Request */}\r\n              <div className=\"border-t border-slate-700 pt-6\">\r\n                <div className=\"flex items-center gap-3 mb-4\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    name=\"empirePartnerRequest\"\r\n                    checked={formData.empirePartnerRequest}\r\n                    onChange={handleInputChange}\r\n                    className=\"w-4 h-4 text-purple-600 bg-slate-800 border-slate-600 rounded focus:ring-purple-500\"\r\n                  />\r\n                  <label className=\"text-sm font-medium text-slate-300\">\r\n                    Apply to become an Empire Partner as well\r\n                  </label>\r\n                </div>\r\n\r\n                {formData.empirePartnerRequest && (\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-slate-300 mb-2\">\r\n                      Why do you want to be an Empire Partner? *\r\n                    </label>\r\n                    <textarea\r\n                      name=\"empirePartnerReason\"\r\n                      value={formData.empirePartnerReason}\r\n                      onChange={handleInputChange}\r\n                      placeholder=\"Explain your motivation for becoming an Empire Partner and how you plan to manage creators...\"\r\n                      rows={3}\r\n                      className={`w-full px-3 py-2 bg-slate-800 border rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 ${\r\n                        errors.empirePartnerReason ? 'border-red-500' : 'border-slate-600'\r\n                      }`}\r\n                    />\r\n                    {errors.empirePartnerReason && (\r\n                      <p className=\"text-red-400 text-sm mt-1\">{errors.empirePartnerReason}</p>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"flex gap-4\">\r\n                <Button\r\n                  type=\"button\"\r\n                  variant=\"outline\"\r\n                  onClick={() => navigate('/dashboard')}\r\n                  className=\"flex-1 border-slate-600 text-slate-300\"\r\n                  disabled={false}\r\n                >\r\n                  Cancel\r\n                </Button>\r\n                <Button\r\n                  type=\"submit\"\r\n                  disabled={submitting}\r\n                  onClick={() => {}}\r\n                  className=\"flex-1 bg-purple-600 hover:bg-purple-700\"\r\n                >\r\n                  {submitting ? (\r\n                    <>\r\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                      Submitting...\r\n                    </>\r\n                  ) : (\r\n                    'Submit Application'\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreatorApplicationStatus.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":71,"column":24,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[2504,2582],"text":"\r\n              You haven&apos;t submitted a creator application yet.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[2504,2582],"text":"\r\n              You haven&lsquo;t submitted a creator application yet.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[2504,2582],"text":"\r\n              You haven&#39;t submitted a creator application yet.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[2504,2582],"text":"\r\n              You haven&rsquo;t submitted a creator application yet.\r\n            "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":292,"column":24,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[11371,11423],"text":"‚Ä¢ We&apos;ll evaluate your streaming experience and goals"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[11371,11423],"text":"‚Ä¢ We&lsquo;ll evaluate your streaming experience and goals"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[11371,11423],"text":"‚Ä¢ We&#39;ll evaluate your streaming experience and goals"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[11371,11423],"text":"‚Ä¢ We&rsquo;ll evaluate your streaming experience and goals"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":293,"column":63,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[11448,11530],"text":"‚Ä¢ If applying for Empire Partner status, we&apos;ll assess your management capabilities"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[11448,11530],"text":"‚Ä¢ If applying for Empire Partner status, we&lsquo;ll assess your management capabilities"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[11448,11530],"text":"‚Ä¢ If applying for Empire Partner status, we&#39;ll assess your management capabilities"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[11448,11530],"text":"‚Ä¢ If applying for Empire Partner status, we&rsquo;ll assess your management capabilities"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":294,"column":25,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[11555,11621],"text":"‚Ä¢ You&apos;ll receive an email notification once the review is complete"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[11555,11621],"text":"‚Ä¢ You&lsquo;ll receive an email notification once the review is complete"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[11555,11621],"text":"‚Ä¢ You&#39;ll receive an email notification once the review is complete"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[11555,11621],"text":"‚Ä¢ You&rsquo;ll receive an email notification once the review is complete"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom';\r\n;\r\nimport { Card, CardHeader, CardTitle, CardContent } from '../components/ui/card';\r\nimport { Button } from '../components/ui/button';\r\nimport { Badge } from '../components/ui/badge';\r\nimport { Loader2, CheckCircle, XCircle, Clock, ArrowLeft, RefreshCw } from 'lucide-react';\r\nimport { supabase } from '../supabaseClient';\r\n\r\nexport function CreatorApplicationStatus() {\r\n  const navigate = useNavigate();\r\n  \r\n  const [loading, setLoading] = useState(true);\r\n  const [application, setApplication] = useState(null);\r\n  const [refreshing, setRefreshing] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadApplicationStatus();\r\n  }, []);\r\n\r\n  const loadApplicationStatus = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error('Not authenticated');\r\n\r\n      const { data, error } = await supabase\r\n        .from('creator_applications')\r\n        .select('*')\r\n        .eq('user_id', user.id)\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (error && error.code !== 'PGRST116') throw error;\r\n      setApplication(data);\r\n    } catch (error) {\r\n      console.error('Error loading application status:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleRefresh = async () => {\r\n    setRefreshing(true);\r\n    await loadApplicationStatus();\r\n    setRefreshing(false);\r\n  };\r\n\r\n  // Show loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center\">\r\n        <div className=\"flex items-center gap-2 text-slate-300\">\r\n          <Loader2 className=\"w-6 h-6 animate-spin\" />\r\n          <span>Loading application status...</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // No application found\r\n  if (!application) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4\">\r\n        <Card className=\"bg-slate-950/60 border-slate-800 max-w-md\">\r\n          <CardContent className=\"p-6 text-center\">\r\n            <XCircle className=\"w-12 h-12 text-slate-400 mx-auto mb-4\" />\r\n            <h2 className=\"text-xl font-bold text-slate-50 mb-2\">No Application Found</h2>\r\n            <p className=\"text-slate-300 mb-4\">\r\n              You haven't submitted a creator application yet.\r\n            </p>\r\n            <Button \r\n              onClick={() => navigate('/creator-application')}\r\n              disabled={false}\r\n              className=\"bg-purple-600 hover:bg-purple-700\"\r\n            >\r\n              Submit Application\r\n            </Button>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Status configurations\r\n  const statusConfig = {\r\n    pending: {\r\n      icon: Clock,\r\n      color: 'text-yellow-500',\r\n      bg: 'bg-yellow-500/10',\r\n      border: 'border-yellow-500/30',\r\n      title: 'Application Pending',\r\n      description: 'Your application is under review by our team.',\r\n      action: null\r\n    },\r\n    approved: {\r\n      icon: CheckCircle,\r\n      color: 'text-green-500',\r\n      bg: 'bg-green-500/10',\r\n      border: 'border-green-500/30',\r\n      title: 'Application Approved!',\r\n      description: 'Congratulations! Your creator application has been approved.',\r\n      action: {\r\n        label: 'Go to Creator Dashboard',\r\n        onClick: () => navigate('/profile'),\r\n        variant: 'default'\r\n      }\r\n    },\r\n    denied: {\r\n      icon: XCircle,\r\n      color: 'text-red-500',\r\n      bg: 'bg-red-500/10',\r\n      border: 'border-red-500/30',\r\n      title: 'Application Denied',\r\n      description: 'Unfortunately, your creator application was not approved.',\r\n      action: {\r\n        label: 'Submit New Application',\r\n        onClick: () => navigate('/creator-application'),\r\n        variant: 'outline'\r\n      }\r\n    }\r\n  };\r\n\r\n  const config = statusConfig[application.status];\r\n  const StatusIcon = config.icon;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between mb-8\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => navigate('/dashboard')}\r\n              disabled={false}\r\n              className=\"border-slate-600 text-slate-300\"\r\n            >\r\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n              Back to Dashboard\r\n            </Button>\r\n            <h1 className=\"text-3xl font-bold text-slate-50\">Application Status</h1>\r\n          </div>\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={handleRefresh}\r\n            disabled={refreshing}\r\n            className=\"border-slate-600 text-slate-300\"\r\n          >\r\n            <RefreshCw className={`w-4 h-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />\r\n            Refresh\r\n          </Button>\r\n        </div>\r\n\r\n        {/* Main Status Card */}\r\n        <Card className=\"bg-slate-950/60 border-slate-800 mb-6\">\r\n          <CardContent className=\"p-8\">\r\n            <div className=\"text-center\">\r\n              <div className={`w-20 h-20 ${config.bg} ${config.border} border-2 rounded-full flex items-center justify-center mx-auto mb-6`}>\r\n                <StatusIcon className={`w-10 h-10 ${config.color}`} />\r\n              </div>\r\n              <h2 className=\"text-2xl font-bold text-slate-50 mb-2\">{config.title}</h2>\r\n              <p className=\"text-slate-300 mb-6\">{config.description}</p>\r\n              \r\n              <Badge \r\n                variant=\"outline\" \r\n                className={`text-sm px-4 py-2 ${\r\n                  application.status === 'approved' \r\n                    ? 'border-green-500 text-green-400' \r\n                    : application.status === 'denied'\r\n                    ? 'border-red-500 text-red-400'\r\n                    : 'border-yellow-500 text-yellow-400'\r\n                }`}\r\n              >\r\n                {application.status.toUpperCase()}\r\n              </Badge>\r\n\r\n              {config.action && (\r\n                <div className=\"mt-6\">\r\n                  <Button\r\n                    onClick={config.action.onClick}\r\n                    disabled={false}\r\n                    className={\r\n                      config.action.variant === 'default' \r\n                        ? 'bg-purple-600 hover:bg-purple-700' \r\n                        : 'border-slate-600 text-slate-300'\r\n                    }\r\n                  >\r\n                    {config.action.label}\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Application Details */}\r\n        <div className=\"grid md:grid-cols-2 gap-6\">\r\n          {/* Basic Information */}\r\n          <Card className=\"bg-slate-950/60 border-slate-800\">\r\n            <CardHeader>\r\n              <CardTitle className=\"text-slate-50\">Application Details</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"text-sm font-medium text-slate-400\">Category</label>\r\n                <p className=\"text-slate-200 capitalize\">{application.category.replace('_', ' ')}</p>\r\n              </div>\r\n              <div>\r\n                <label className=\"text-sm font-medium text-slate-400\">Submitted</label>\r\n                <p className=\"text-slate-200\">\r\n                  {new Date(application.submitted_at).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              {application.reviewed_at && (\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-slate-400\">Reviewed</label>\r\n                  <p className=\"text-slate-200\">\r\n                    {new Date(application.reviewed_at).toLocaleString()}\r\n                  </p>\r\n                </div>\r\n              )}\r\n              {application.reviewer_notes && (\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-slate-400\">Reviewer Notes</label>\r\n                  <div className=\"bg-slate-800/50 p-3 rounded-lg mt-1\">\r\n                    <p className=\"text-slate-200 text-sm\">{application.reviewer_notes}</p>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Application Content */}\r\n          <Card className=\"bg-slate-950/60 border-slate-800\">\r\n            <CardHeader>\r\n              <CardTitle className=\"text-slate-50\">Your Application</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"text-sm font-medium text-slate-400\">Streaming Experience</label>\r\n                <div className=\"bg-slate-800/50 p-3 rounded-lg mt-1\">\r\n                  <p className=\"text-slate-200 text-sm whitespace-pre-wrap\">{application.experience_text}</p>\r\n                </div>\r\n              </div>\r\n              \r\n              {application.social_links && (\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-slate-400\">Social Links</label>\r\n                  <div className=\"bg-slate-800/50 p-3 rounded-lg mt-1\">\r\n                    <p className=\"text-slate-200 text-sm whitespace-pre-wrap\">{application.social_links}</p>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              \r\n              <div>\r\n                <label className=\"text-sm font-medium text-slate-400\">Goals & Objectives</label>\r\n                <div className=\"bg-slate-800/50 p-3 rounded-lg mt-1\">\r\n                  <p className=\"text-slate-200 text-sm whitespace-pre-wrap\">{application.goals_text}</p>\r\n                </div>\r\n              </div>\r\n\r\n              {application.empire_partner_request && (\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-slate-400\">Empire Partner Request</label>\r\n                  <Badge variant=\"outline\" className=\"border-purple-500 text-purple-400 mt-1\">\r\n                    Requested\r\n                  </Badge>\r\n                  {application.empire_partner_reason && (\r\n                    <div className=\"bg-slate-800/50 p-3 rounded-lg mt-2\">\r\n                      <p className=\"text-slate-200 text-sm whitespace-pre-wrap\">{application.empire_partner_reason}</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Next Steps for Pending Applications */}\r\n        {application.status === 'pending' && (\r\n          <Card className=\"bg-slate-950/60 border-slate-800 mt-6\">\r\n            <CardHeader>\r\n              <CardTitle className=\"text-slate-50\">What Happens Next?</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-3 text-slate-300\">\r\n                <p>‚Ä¢ Our team will review your application within 2-3 business days</p>\r\n                <p>‚Ä¢ We'll evaluate your streaming experience and goals</p>\r\n                <p>‚Ä¢ If applying for Empire Partner status, we'll assess your management capabilities</p>\r\n                <p>‚Ä¢ You'll receive an email notification once the review is complete</p>\r\n                <p>‚Ä¢ Approved creators will gain access to TrollTract benefits and earnings</p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        {/* Support Information */}\r\n        <Card className=\"bg-slate-950/60 border-slate-800 mt-6\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"text-center\">\r\n              <h3 className=\"text-lg font-semibold text-slate-50 mb-2\">Need Help?</h3>\r\n              <p className=\"text-slate-300 mb-4\">\r\n                If you have questions about your application, please contact our support team.\r\n              </p>\r\n            <Button \r\n              variant=\"outline\" \r\n              onClick={() => navigate('/support')}\r\n              disabled={false}\r\n              className=\"border-slate-600 text-slate-300\"\r\n            >\r\n                Contact Support\r\n              </Button>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreatorDashboard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'loadEarningsHistorySeries'. Either include it or remove the dependency array. Outer scope values like 'loadDailyEarningsSeries' aren't valid dependencies because mutating them doesn't re-render the component.","line":131,"column":6,"nodeType":"ArrayExpression","endLine":131,"endColumn":114,"suggestions":[{"desc":"Update the dependencies array to be: [loadEarningsOverview, loadEarningsHistorySeries, loadHourlyActivity, loadTopGifters, loadBattleEventEarnings]","fix":{"range":[3597,3705],"text":"[loadEarningsOverview, loadEarningsHistorySeries, loadHourlyActivity, loadTopGifters, loadBattleEventEarnings]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":338,"column":15,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11162,11275],"text":"\r\n              &quot;battle\" = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11162,11275],"text":"\r\n              &ldquo;battle\" = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11162,11275],"text":"\r\n              &#34;battle\" = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11162,11275],"text":"\r\n              &rdquo;battle\" = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":338,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle&quot; = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle&ldquo; = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle&#34; = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle&rdquo; = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":338,"column":51,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, &quot;event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, &ldquo;event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, &#34;event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, &rdquo;event\" = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":338,"column":57,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event&quot; = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event&ldquo; = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event&#34; = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event&rdquo; = Troll events, \"other\" = normal gifts.\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":338,"column":75,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, &quot;other\" = normal gifts.\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, &ldquo;other\" = normal gifts.\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, &#34;other\" = normal gifts.\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, &rdquo;other\" = normal gifts.\r\n            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":338,"column":81,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, \"other&quot; = normal gifts.\r\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, \"other&ldquo; = normal gifts.\r\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, \"other&#34; = normal gifts.\r\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11162,11275],"text":"\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, \"other&rdquo; = normal gifts.\r\n            "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { supabase } from '../lib/supabase';\r\nimport { \r\n  Crown\r\n} from 'lucide-react';\r\n\r\nimport {\r\n  LineChart,\r\n  Line,\r\n  XAxis,\r\n  YAxis,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  BarChart,\r\n  Bar,\r\n  PieChart,\r\n  Pie,\r\n  Cell,\r\n  Legend,\r\n} from 'recharts';\r\n\r\nconst card = {\r\n  padding: \"18px\",\r\n  borderRadius: \"12px\",\r\n  background: \"#10141a\",\r\n  border: \"1px solid #1f2733\",\r\n  marginBottom: \"20px\",\r\n};\r\n\r\nconst COLORS = [\"#7CFC00\", \"#ff2e92\", \"#ffd54f\", \"#42a5f5\"];\r\n\r\ninterface EarningsOverview {\r\n  total_coins_earned: number;\r\n  total_bonus_coins: number;\r\n  total_payouts_usd: number;\r\n  pending_payouts_usd: number;\r\n}\r\n\r\ninterface EarningsHistory {\r\n  date: string;\r\n  coins: number;\r\n  bonus_coins: number;\r\n  payouts_usd: number;\r\n}\r\n\r\ninterface HourlyActivity {\r\n  hour_of_day: number;\r\n  coins: number;\r\n  gifts_count: number;\r\n}\r\n\r\ninterface TopGifter {\r\n  sender_id: string;\r\n  total_coins: number;\r\n  sender_username: string;\r\n  sender_avatar_url: string;\r\n}\r\n\r\ninterface BattleEventEarnings {\r\n  source: string;\r\n  coins: number;\r\n}\r\n\r\nexport default function CreatorDashboard() {\r\n  const { profile, user } = useAuthStore();\r\n  const [overview, setOverview] = useState<EarningsOverview | null>(null);\r\n  const [historySeries, setHistorySeries] = useState<EarningsHistory[]>([]);\r\n  const [hourly, setHourly] = useState<HourlyActivity[]>([]);\r\n  const [topGifters, setTopGifters] = useState<TopGifter[]>([]);\r\n  const [battleEvent, setBattleEvent] = useState<BattleEventEarnings[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [timeRange, setTimeRange] = useState<'7d' | '30d' | '90d'>('30d');\r\n\r\n  const loadEarningsOverview = useCallback(async () => {\r\n    const { data, error } = await supabase.rpc('get_earnings_overview');\r\n    if (error) throw error;\r\n    setOverview(data?.[0] || null);\r\n  }, []);\r\n\r\n  const loadEarningsHistorySeries = useCallback(async () => {\r\n    const daysBack = timeRange === '7d' ? 7 : timeRange === '30d' ? 30 : 90;\r\n    const { data, error } = await supabase.rpc('get_daily_earnings_series', {\r\n      days_back: daysBack\r\n    });\r\n    if (error) throw error;\r\n    // Map 'day' to 'date' to match new interface if needed, or just cast it\r\n    setHistorySeries((data || []).map((d: any) => ({\r\n      date: d.day,\r\n      coins: d.coins,\r\n      bonus_coins: d.bonus_coins,\r\n      payouts_usd: d.payouts_usd\r\n    })));\r\n  }, [timeRange]);\r\n\r\n  const loadHourlyActivity = useCallback(async () => {\r\n    const { data, error } = await supabase.rpc('get_hourly_activity');\r\n    if (error) throw error;\r\n    setHourly(data || []);\r\n  }, []);\r\n\r\n  const loadTopGifters = useCallback(async () => {\r\n    const { data, error } = await supabase.rpc('get_top_gifters', {\r\n      limit_count: 10\r\n    });\r\n    if (error) throw error;\r\n    setTopGifters(data || []);\r\n  }, []);\r\n\r\n  const loadBattleEventEarnings = useCallback(async () => {\r\n    const { data, error } = await supabase.rpc('get_battle_and_event_earnings');\r\n    if (error) throw error;\r\n    setBattleEvent(data || []);\r\n  }, []);\r\n\r\n  const loadDashboardData = useCallback(async () => {\r\n    setLoading(true);\r\n    try {\r\n      await Promise.all([\r\n        loadEarningsOverview(),\r\n        loadEarningsHistorySeries(),\r\n        loadHourlyActivity(),\r\n        loadTopGifters(),\r\n        loadBattleEventEarnings()\r\n      ]);\r\n    } catch (error) {\r\n      console.error('Error loading dashboard data:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [loadEarningsOverview, loadDailyEarningsSeries, loadHourlyActivity, loadTopGifters, loadBattleEventEarnings]);\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadDashboardData();\r\n    }\r\n  }, [user, timeRange, loadDashboardData]);\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0A14] text-white p-6 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-pulse px-6 py-3 rounded bg-[#121212] border border-[#2C2C2C]\">\r\n            Loading‚Ä¶\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0A14] text-white p-6\">\r\n      <div className=\"max-w-7xl mx-auto space-y-6\">\r\n        \r\n        {/* HEADER + STATUS */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 bg-gradient-to-r from-purple-600 to-gold-600 rounded-full flex items-center justify-center\">\r\n              <Crown className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            <div>\r\n            <h1 className=\"text-3xl font-bold flex items-center gap-3\">\r\n              Creator Earnings Dashboard\r\n            </h1>\r\n              <p className=\"text-gray-400\">\r\n                Track your gifts, bonuses, payouts, and performance.\r\n              </p>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"text-right\">\r\n            <p className=\"text-sm text-gray-400\">Status</p>\r\n            <p className=\"font-semibold\">\r\n              {profile?.role\r\n                ? profile.role.replace(/_/g, ' ')\r\n                : 'Creator'}\r\n            </p>\r\n            {profile?.created_at && (\r\n              <p className=\"text-xs text-gray-500\">\r\n                Member since {new Date(profile.created_at).toLocaleDateString()}\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* TOP METRICS */}\r\n        <section style={card}>\r\n          <h2 style={{ fontSize: \"20px\", marginBottom: \"12px\", fontWeight: 700 }}>\r\n            Overview\r\n          </h2>\r\n          <div\r\n            style={{\r\n              display: \"grid\",\r\n              gap: \"18px\",\r\n              gridTemplateColumns: \"repeat(auto-fit, minmax(190px, 1fr))\",\r\n            }}\r\n          >\r\n            <Metric\r\n              label=\"Total Coins Earned\"\r\n              value={overview?.total_coins_earned ?? 0}\r\n            />\r\n            <Metric\r\n              label=\"TrollTract Bonus Coins\"\r\n              value={overview?.total_bonus_coins ?? 0}\r\n              highlight\r\n            />\r\n            <Metric\r\n              label=\"Payouts Completed (USD)\"\r\n              value={overview?.total_payouts_usd ?? 0}\r\n              isCurrency\r\n            />\r\n            <Metric\r\n              label=\"Pending Payouts (USD)\"\r\n              value={overview?.pending_payouts_usd ?? 0}\r\n              isCurrency\r\n            />\r\n          </div>\r\n        </section>\r\n\r\n        {/* DAILY EARNINGS CHART */}\r\n        <section style={card}>\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 style={{ fontSize: \"18px\", marginBottom: \"6px\", fontWeight: 700 }}>\r\n              Earnings Analytics\r\n            </h2>\r\n            <div className=\"flex gap-2\">\r\n              {(['7d', '30d', '90d'] as const).map((range) => (\r\n                <button\r\n                  key={range}\r\n                  onClick={() => setTimeRange(range)}\r\n                  className={`px-3 py-1 rounded-lg text-sm font-medium transition-colors ${\r\n                    timeRange === range\r\n                      ? 'bg-purple-600 text-white'\r\n                      : 'bg-gray-700 text-gray-300 hover:bg-gray-600'\r\n                  }`}\r\n                >\r\n                  {range}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n          <div style={{ width: \"100%\", height: 260 }}>\r\n            <ResponsiveContainer>\r\n              <LineChart data={historySeries || []}>\r\n                <XAxis \r\n                  dataKey=\"date\" \r\n                  tick={{ fontSize: 11 }}\r\n                  tickFormatter={(value) => new Date(value).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\r\n                />\r\n                <YAxis />\r\n                <Tooltip \r\n                  labelFormatter={(value) => new Date(value).toLocaleDateString()}\r\n                  formatter={(value, name) => [\r\n                    typeof value === 'number' ? value.toLocaleString() : value,\r\n                    name === 'coins' ? 'Coins' : name === 'bonus_coins' ? 'Bonus Coins' : 'Payouts (USD)'\r\n                  ]}\r\n                />\r\n                <Legend />\r\n                <Line\r\n                  type=\"monotone\"\r\n                  dataKey=\"coins\"\r\n                  name=\"Coins\"\r\n                  stroke={COLORS[1]}\r\n                  dot={false}\r\n                />\r\n                <Line\r\n                  type=\"monotone\"\r\n                  dataKey=\"bonus_coins\"\r\n                  name=\"Bonus\"\r\n                  stroke={COLORS[0]}\r\n                  dot={false}\r\n                />\r\n                <Line\r\n                  type=\"monotone\"\r\n                  dataKey=\"payouts_usd\"\r\n                  name=\"Payouts (USD)\"\r\n                  stroke={COLORS[2]}\r\n                  dot={false}\r\n                />\r\n              </LineChart>\r\n            </ResponsiveContainer>\r\n          </div>\r\n        </section>\r\n\r\n        {/* ROW: HOURLY ACTIVITY + BATTLE/EVENT PIE */}\r\n        <div\r\n          style={{\r\n            display: \"grid\",\r\n            gap: \"18px\",\r\n            gridTemplateColumns: \"minmax(0, 2fr) minmax(0, 1fr)\",\r\n            marginBottom: \"20px\",\r\n          }}\r\n        >\r\n          <section style={card}>\r\n            <h2 style={{ fontSize: \"18px\", marginBottom: \"6px\", fontWeight: 700 }}>\r\n              Hourly Activity (last 7 days)\r\n            </h2>\r\n            <div style={{ width: \"100%\", height: 220 }}>\r\n              <ResponsiveContainer>\r\n                <BarChart data={hourly || []}>\r\n                  <XAxis dataKey=\"hour_of_day\" tick={{ fontSize: 11 }} />\r\n                  <YAxis />\r\n                  <Tooltip />\r\n                  <Legend />\r\n                  <Bar dataKey=\"coins\" name=\"Coins\" fill={COLORS[1]} />\r\n                  <Bar dataKey=\"gifts_count\" name=\"Gifts\" fill={COLORS[3]} />\r\n                </BarChart>\r\n              </ResponsiveContainer>\r\n            </div>\r\n          </section>\r\n\r\n          <section style={card}>\r\n            <h2 style={{ fontSize: \"18px\", marginBottom: \"6px\", fontWeight: 700 }}>\r\n              Battle vs Event Earnings\r\n            </h2>\r\n            <div style={{ width: \"100%\", height: 220 }}>\r\n              <ResponsiveContainer>\r\n                <PieChart>\r\n                  <Pie\r\n                    data={(battleEvent || []) as any[]}\r\n                    dataKey=\"coins\"\r\n                    nameKey=\"source\"\r\n                    cx=\"50%\"\r\n                    cy=\"50%\"\r\n                    outerRadius={70}\r\n                    label\r\n                  >\r\n                    {(battleEvent || []).map((entry, index) => (\r\n                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\r\n                    ))}\r\n                  </Pie>\r\n                  <Tooltip />\r\n                  <Legend />\r\n                </PieChart>\r\n              </ResponsiveContainer>\r\n            </div>\r\n            <div style={{ fontSize: \"12px\", opacity: 0.7, marginTop: 6 }}>\r\n              \"battle\" = coins earned in battles, \"event\" = Troll events, \"other\" = normal gifts.\r\n            </div>\r\n          </section>\r\n        </div>\r\n\r\n        {/* TOP GIFTERS + TROLLTRACT BONUS BLOCK */}\r\n        <div\r\n          style={{\r\n            display: \"grid\",\r\n            gap: \"18px\",\r\n            gridTemplateColumns: \"minmax(0, 1.3fr) minmax(0, 1fr)\",\r\n          }}\r\n        >\r\n          {/* LEADERBOARD */}\r\n          <section style={card}>\r\n            <h2 style={{ fontSize: \"18px\", marginBottom: \"8px\", fontWeight: 700 }}>\r\n              Top Gifters\r\n            </h2>\r\n            <table\r\n              style={{\r\n                width: \"100%\",\r\n                borderCollapse: \"collapse\",\r\n                fontSize: \"14px\",\r\n              }}\r\n            >\r\n              <thead>\r\n                <tr style={{ textAlign: \"left\", opacity: 0.6 }}>\r\n                  <th style={{ padding: \"6px 4px\" }}>#</th>\r\n                  <th style={{ padding: \"6px 4px\" }}>User</th>\r\n                  <th style={{ padding: \"6px 4px\", textAlign: \"right\" }}>\r\n                    Coins Sent\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {(topGifters || []).map((g, i) => (\r\n                  <tr key={g.sender_id}>\r\n                    <td style={{ padding: \"6px 4px\" }}>{i + 1}</td>\r\n                    <td style={{ padding: \"6px 4px\" }}>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        {g.sender_avatar_url && (\r\n                          <img \r\n                            src={g.sender_avatar_url} \r\n                            alt={g.sender_username}\r\n                            className=\"w-6 h-6 rounded-full\"\r\n                          />\r\n                        )}\r\n                        <span>{g.sender_username}</span>\r\n                      </div>\r\n                    </td>\r\n                    <td style={{ padding: \"6px 4px\", textAlign: \"right\" }}>\r\n                      {g.total_coins.toLocaleString()}\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n                {(!topGifters || topGifters.length === 0) && (\r\n                  <tr>\r\n                    <td colSpan={3} style={{ padding: \"6px 4px\", opacity: 0.7 }}>\r\n                      No gifts yet. Start going live to build your leaderboard.\r\n                    </td>\r\n                  </tr>\r\n                )}\r\n              </tbody>\r\n            </table>\r\n          </section>\r\n\r\n        </div>\r\n\r\n        {loading && (\r\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n            <div className=\"bg-[#1a1a1a] p-6 rounded-lg\">\r\n              <div className=\"animate-pulse text-white\">Loading dashboard data...</div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface MetricProps {\r\n  label: string;\r\n  value: number;\r\n  highlight?: boolean;\r\n  isCurrency?: boolean;\r\n  isText?: boolean;\r\n}\r\n\r\nfunction Metric({ label, value, highlight = false, isCurrency = false, isText = false }: MetricProps) {\r\n  let display: string | number = value;\r\n\r\n  if (!isText) {\r\n    if (isCurrency) {\r\n      display = `$${Number(value || 0).toFixed(2)}`;\r\n    } else {\r\n      display = Number(value || 0).toLocaleString();\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <div style={{ fontSize: \"13px\", opacity: 0.6 }}>{label}</div>\r\n      <div\r\n        style={{\r\n          fontSize: \"22px\",\r\n          fontWeight: 700,\r\n          marginTop: 4,\r\n          color: highlight ? \"#7CFC00\" : \"white\",\r\n        }}\r\n      >\r\n        {display}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreatorOnboarding.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreatorSwitchProgram.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":221,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8778,8871],"text":"\r\n                  Unfortunately, we couldn&apos;t verify your account details.\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8778,8871],"text":"\r\n                  Unfortunately, we couldn&lsquo;t verify your account details.\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8778,8871],"text":"\r\n                  Unfortunately, we couldn&#39;t verify your account details.\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8778,8871],"text":"\r\n                  Unfortunately, we couldn&rsquo;t verify your account details.\r\n                "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { toast } from 'sonner';\r\nimport { \r\n  Shuffle, \r\n  CheckCircle2, \r\n  TrendingUp, \r\n  Percent, \r\n  AlertCircle, \r\n  Loader2, \r\n  ExternalLink,\r\n  ShieldCheck,\r\n  XCircle\r\n} from 'lucide-react';\r\n\r\ninterface MigrationClaim {\r\n  id: string;\r\n  platform_name: string;\r\n  platform_user_id: string;\r\n  platform_profile_url: string | null;\r\n  proof_screenshot_url: string | null;\r\n  verification_status: 'pending' | 'approved' | 'rejected';\r\n  rejection_reason: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport default function CreatorSwitchProgram() {\r\n  const { user } = useAuthStore();\r\n  const [loading, setLoading] = useState(true);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [claim, setClaim] = useState<MigrationClaim | null>(null);\r\n\r\n  // Form State\r\n  const [formData, setFormData] = useState({\r\n    platform_name: '',\r\n    platform_user_id: '',\r\n    platform_profile_url: '',\r\n    proof_screenshot_url: ''\r\n  });\r\n\r\n  const fetchClaim = React.useCallback(async () => {\r\n    try {\r\n      setLoading(true);\r\n      const { data, error } = await supabase\r\n        .from('creator_migration_claims')\r\n        .select('*')\r\n        .eq('user_id', user?.id)\r\n        .maybeSingle();\r\n\r\n      if (error) throw error;\r\n      \r\n      if (data) {\r\n        setClaim(data as MigrationClaim);\r\n        // Pre-fill form if pending, so they can edit\r\n        if (data.verification_status === 'pending') {\r\n          setFormData({\r\n            platform_name: data.platform_name,\r\n            platform_user_id: data.platform_user_id,\r\n            platform_profile_url: data.platform_profile_url || '',\r\n            proof_screenshot_url: data.proof_screenshot_url || ''\r\n          });\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.error('Error fetching claim:', err);\r\n      toast.error('Failed to load application status');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      fetchClaim();\r\n    }\r\n  }, [user, fetchClaim]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!user) return;\r\n\r\n    if (!formData.platform_name || !formData.platform_user_id) {\r\n      toast.error('Please fill in all required fields');\r\n      return;\r\n    }\r\n\r\n    setSubmitting(true);\r\n    try {\r\n      if (claim) {\r\n        // Update existing pending claim\r\n        const { error } = await supabase\r\n          .from('creator_migration_claims')\r\n          .update({\r\n            platform_name: formData.platform_name,\r\n            platform_user_id: formData.platform_user_id,\r\n            platform_profile_url: formData.platform_profile_url || null,\r\n            proof_screenshot_url: formData.proof_screenshot_url || null,\r\n            // verification_status remains pending\r\n          })\r\n          .eq('id', claim.id)\r\n          .eq('verification_status', 'pending'); // Security check\r\n\r\n        if (error) throw error;\r\n        toast.success('Application updated successfully');\r\n      } else {\r\n        // Insert new claim\r\n        const { error } = await supabase\r\n          .from('creator_migration_claims')\r\n          .insert({\r\n            user_id: user.id,\r\n            platform_name: formData.platform_name,\r\n            platform_user_id: formData.platform_user_id,\r\n            platform_profile_url: formData.platform_profile_url || null,\r\n            proof_screenshot_url: formData.proof_screenshot_url || null,\r\n            verification_status: 'pending'\r\n          });\r\n\r\n        if (error) {\r\n          if (error.code === '23505') { // Unique violation\r\n            toast.error('You have already submitted an application.');\r\n            fetchClaim(); // Refresh to show it\r\n            return;\r\n          }\r\n          throw error;\r\n        }\r\n        toast.success('Application submitted. Under review.');\r\n      }\r\n      \r\n      fetchClaim();\r\n    } catch (err: any) {\r\n      console.error('Error submitting claim:', err);\r\n      toast.error(err.message || 'Failed to submit application');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen text-white\">\r\n        <Loader2 className=\"w-8 h-8 animate-spin text-purple-500\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-5xl mx-auto text-white space-y-8 animate-fade-in pb-20\">\r\n      {/* Header */}\r\n      <div className=\"text-center space-y-4\">\r\n        <div className=\"inline-flex items-center justify-center p-3 rounded-full bg-purple-500/20 mb-2\">\r\n          <Shuffle className=\"w-8 h-8 text-purple-400\" />\r\n        </div>\r\n        <h1 className=\"text-4xl font-black bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent\">\r\n          Creator Switch Program\r\n        </h1>\r\n        <p className=\"text-gray-400 max-w-2xl mx-auto text-lg\">\r\n          Streamers from any platform can apply for Founder Perks. Enter your previous platform name and creator ID so we can verify your account.\r\n        </p>\r\n      </div>\r\n\r\n      {/* Perks Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n        <div className=\"bg-[#1A1A24] p-6 rounded-xl border border-purple-500/20 hover:border-purple-500/50 transition-colors group\">\r\n          <div className=\"w-12 h-12 rounded-lg bg-yellow-500/20 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform\">\r\n            <ShieldCheck className=\"w-6 h-6 text-yellow-400\" />\r\n          </div>\r\n          <h3 className=\"text-xl font-bold mb-2 text-white\">Founder Badge</h3>\r\n          <p className=\"text-gray-400 text-sm\">\r\n            Get a permanent Founder Badge on your profile to show you were here early.\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"bg-[#1A1A24] p-6 rounded-xl border border-blue-500/20 hover:border-blue-500/50 transition-colors group\">\r\n          <div className=\"w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform\">\r\n            <TrendingUp className=\"w-6 h-6 text-blue-400\" />\r\n          </div>\r\n          <h3 className=\"text-xl font-bold mb-2 text-white\">7-Day Boost</h3>\r\n          <p className=\"text-gray-400 text-sm\">\r\n            Enjoy boosted placement on the homepage for 7 days after approval to jumpstart your audience.\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"bg-[#1A1A24] p-6 rounded-xl border border-green-500/20 hover:border-green-500/50 transition-colors group\">\r\n          <div className=\"w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform\">\r\n            <Percent className=\"w-6 h-6 text-green-400\" />\r\n          </div>\r\n          <h3 className=\"text-xl font-bold mb-2 text-white\">Reduced Fees</h3>\r\n          <p className=\"text-gray-400 text-sm\">\r\n            Keep more of your earnings with 30 days of reduced platform fees (only $1 fee for payouts).\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Status or Form */}\r\n      <div className=\"bg-[#14141E] rounded-2xl border border-[#2C2C3A] p-8 max-w-3xl mx-auto shadow-xl\">\r\n        {claim && claim.verification_status !== 'pending' ? (\r\n          // Final State (Approved/Rejected)\r\n          <div className=\"text-center space-y-6\">\r\n            {claim.verification_status === 'approved' ? (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto\">\r\n                  <CheckCircle2 className=\"w-10 h-10 text-green-500\" />\r\n                </div>\r\n                <h2 className=\"text-2xl font-bold text-green-400\">Application Approved!</h2>\r\n                <p className=\"text-gray-300\">\r\n                  Your Founder Perks are now active. Welcome to the family!\r\n                </p>\r\n                <div className=\"bg-green-500/10 p-4 rounded-lg text-left inline-block w-full max-w-md\">\r\n                  <p className=\"text-sm text-green-300 font-mono mb-1\">PLATFORM: {claim.platform_name}</p>\r\n                  <p className=\"text-sm text-green-300 font-mono\">ID: {claim.platform_user_id}</p>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto\">\r\n                  <XCircle className=\"w-10 h-10 text-red-500\" />\r\n                </div>\r\n                <h2 className=\"text-2xl font-bold text-red-400\">Application Rejected</h2>\r\n                <p className=\"text-gray-300\">\r\n                  Unfortunately, we couldn't verify your account details.\r\n                </p>\r\n                {claim.rejection_reason && (\r\n                  <div className=\"bg-red-500/10 p-4 rounded-lg text-left\">\r\n                    <p className=\"text-sm font-bold text-red-400 mb-1\">Reason:</p>\r\n                    <p className=\"text-sm text-gray-300\">{claim.rejection_reason}</p>\r\n                  </div>\r\n                )}\r\n                <p className=\"text-sm text-gray-500 pt-4\">\r\n                  Please contact support if you believe this is an error.\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          // Form (New or Pending)\r\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-2xl font-bold\">Application Form</h2>\r\n              {claim && (\r\n                <span className=\"px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-xs font-bold border border-yellow-500/30 flex items-center gap-2\">\r\n                  <Loader2 className=\"w-3 h-3 animate-spin\" />\r\n                  PENDING REVIEW\r\n                </span>\r\n              )}\r\n            </div>\r\n            \r\n            {claim && (\r\n              <div className=\"bg-blue-500/10 border border-blue-500/30 p-4 rounded-lg flex gap-3 mb-6\">\r\n                <AlertCircle className=\"w-5 h-5 text-blue-400 shrink-0\" />\r\n                <p className=\"text-sm text-blue-200\">\r\n                  Your application is currently under review. You can update your details below if needed.\r\n                </p>\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n              <div className=\"space-y-2\">\r\n                <label className=\"text-sm font-medium text-gray-400\">Previous Platform Name <span className=\"text-red-500\">*</span></label>\r\n                <input\r\n                  type=\"text\"\r\n                  required\r\n                  placeholder=\"e.g. Twitch, Kick, YouTube\"\r\n                  value={formData.platform_name}\r\n                  onChange={(e) => setFormData({...formData, platform_name: e.target.value})}\r\n                  className=\"w-full bg-[#0A0A10] border border-[#2C2C3A] rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <label className=\"text-sm font-medium text-gray-400\">Platform Username / ID <span className=\"text-red-500\">*</span></label>\r\n                <input\r\n                  type=\"text\"\r\n                  required\r\n                  placeholder=\"e.g. Ninja, xQc\"\r\n                  value={formData.platform_user_id}\r\n                  onChange={(e) => setFormData({...formData, platform_user_id: e.target.value})}\r\n                  className=\"w-full bg-[#0A0A10] border border-[#2C2C3A] rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-400\">Profile URL (Optional)</label>\r\n              <div className=\"relative\">\r\n                <ExternalLink className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500\" />\r\n                <input\r\n                  type=\"url\"\r\n                  placeholder=\"https://twitch.tv/username\"\r\n                  value={formData.platform_profile_url}\r\n                  onChange={(e) => setFormData({...formData, platform_profile_url: e.target.value})}\r\n                  className=\"w-full bg-[#0A0A10] border border-[#2C2C3A] rounded-lg pl-10 pr-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-400\">Proof Screenshot URL (Optional)</label>\r\n              <div className=\"relative\">\r\n                <ExternalLink className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500\" />\r\n                <input\r\n                  type=\"url\"\r\n                  placeholder=\"https://imgur.com/...\"\r\n                  value={formData.proof_screenshot_url}\r\n                  onChange={(e) => setFormData({...formData, proof_screenshot_url: e.target.value})}\r\n                  className=\"w-full bg-[#0A0A10] border border-[#2C2C3A] rounded-lg pl-10 pr-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors\"\r\n                />\r\n              </div>\r\n              <p className=\"text-xs text-gray-500\">\r\n                A screenshot of your logged-in profile page can help speed up verification.\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"pt-4\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={submitting}\r\n                className=\"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 rounded-lg shadow-lg shadow-purple-900/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-[1.01] active:scale-[0.99]\"\r\n              >\r\n                {submitting ? (\r\n                  <span className=\"flex items-center justify-center gap-2\">\r\n                    <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n                    Submitting...\r\n                  </span>\r\n                ) : (\r\n                  claim ? 'Update Application' : 'Submit for Verification'\r\n                )}\r\n              </button>\r\n            </div>\r\n          </form>\r\n        )}\r\n      </div>\r\n\r\n      {/* Disclaimer */}\r\n      <p className=\"text-center text-gray-600 text-sm\">\r\n        Not affiliated with or endorsed by any platform. Troll City is an independent streaming community.\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\CreditScorePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\DistrictTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\EarningsDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\EarningsPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\EarningsPayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\EmpirePartnerApply.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":122,"column":83,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We&apos;ll notify you once it's processed."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We&lsquo;ll notify you once it's processed."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We&#39;ll notify you once it's processed."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We&rsquo;ll notify you once it's processed."},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":122,"column":105,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We'll notify you once it&apos;s processed."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We'll notify you once it&lsquo;s processed."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We'll notify you once it&#39;s processed."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4343,4414],"text":"Your application is under review. We'll notify you once it&rsquo;s processed."},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":179,"column":79,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[6854,6911],"text":"Earn 5% of referred users&apos; monthly earnings (troll_coins)"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[6854,6911],"text":"Earn 5% of referred users&lsquo; monthly earnings (troll_coins)"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[6854,6911],"text":"Earn 5% of referred users&#39; monthly earnings (troll_coins)"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[6854,6911],"text":"Earn 5% of referred users&rsquo; monthly earnings (troll_coins)"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { Crown, CheckCircle2, XCircle, ArrowRight } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\n\r\nexport default function EmpirePartnerApply() {\r\n  const { profile, user, refreshProfile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [loading, setLoading] = useState(false)\r\n  const [hasApplication, setHasApplication] = useState(false)\r\n  const [applicationStatus, setApplicationStatus] = useState<'pending' | 'approved' | 'rejected' | null>(null)\r\n\r\n  const checkApplicationStatus = useCallback(async () => {\r\n    if (!user?.id) return\r\n\r\n    try {\r\n      const { data: application } = await supabase\r\n        .from('empire_applications')\r\n        .select('status')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle()\r\n\r\n      if (application) {\r\n        setHasApplication(true)\r\n        setApplicationStatus(application.status as 'pending' | 'approved' | 'rejected')\r\n      }\r\n\r\n      // If already approved, redirect will happen in useEffect\r\n    } catch (error) {\r\n      console.error('Error checking application status:', error)\r\n    }\r\n  }, [user?.id])\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/auth')\r\n      return\r\n    }\r\n\r\n    // Check if user already has an application\r\n    checkApplicationStatus()\r\n\r\n    // If already approved, redirect to dashboard\r\n    if (profile?.empire_role === 'partner') {\r\n      navigate('/empire-partner')\r\n      return\r\n    }\r\n  }, [user, profile?.empire_role, navigate, checkApplicationStatus])\r\n\r\n  const handleSubmitApplication = useCallback(async () => {\r\n    if (!user?.id) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      const { error: appError } = await supabase\r\n        .from('empire_applications')\r\n        .insert({\r\n          user_id: user.id,\r\n          status: 'pending',\r\n          payment_type: 'free',\r\n          amount_paid: 0,\r\n          payment_id: `free_${Date.now()}`\r\n        })\r\n\r\n      if (appError) {\r\n        if (appError.message.includes('duplicate')) {\r\n          toast.error('You already have a pending application')\r\n          return\r\n        }\r\n        throw appError\r\n      }\r\n\r\n      toast.success('Application submitted! Admin and Lead Troll Officer will review it.')\r\n      setHasApplication(true)\r\n      setApplicationStatus('pending')\r\n    } catch (error: any) {\r\n      console.error('Error submitting application:', error)\r\n      toast.error(error.message || 'Failed to submit application')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user?.id])\r\n\r\n  if (!user) {\r\n    return null\r\n  }\r\n\r\n  if (hasApplication && applicationStatus === 'approved') {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <div className=\"bg-green-500/20 border border-green-500 rounded-xl p-8 text-center\">\r\n            <CheckCircle2 className=\"w-16 h-16 text-green-400 mx-auto mb-4\" />\r\n            <h1 className=\"text-3xl font-bold mb-2\">Application Approved!</h1>\r\n            <p className=\"text-gray-300 mb-6\">You are now an Empire Partner. Start recruiting and earning bonuses!</p>\r\n            <button\r\n              onClick={async () => {\r\n                // Refresh profile first to get updated partner status\r\n                await refreshProfile()\r\n                navigate('/empire-partner')\r\n              }}\r\n              className=\"px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg flex items-center gap-2 mx-auto\"\r\n            >\r\n              Go to Partner Dashboard\r\n              <ArrowRight className=\"w-5 h-5\" />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (hasApplication && applicationStatus === 'pending') {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <div className=\"bg-yellow-500/20 border border-yellow-500 rounded-xl p-8 text-center\">\r\n            <div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-400 mx-auto mb-4\"></div>\r\n            <h1 className=\"text-3xl font-bold mb-2\">Application Pending</h1>\r\n            <p className=\"text-gray-300 mb-6\">Your application is under review. We'll notify you once it's processed.</p>\r\n            <button\r\n              onClick={() => navigate('/')}\r\n              className=\"px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg\"\r\n            >\r\n              Return Home\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (hasApplication && applicationStatus === 'rejected') {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <div className=\"bg-red-500/20 border border-red-500 rounded-xl p-8 text-center\">\r\n            <XCircle className=\"w-16 h-16 text-red-400 mx-auto mb-4\" />\r\n            <h1 className=\"text-3xl font-bold mb-2\">Application Rejected</h1>\r\n            <p className=\"text-gray-300 mb-6\">Your application was not approved. Please contact support for more information.</p>\r\n            <button\r\n              onClick={() => navigate('/support')}\r\n              className=\"px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg\"\r\n            >\r\n              Contact Support\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"text-center mb-12\">\r\n          <div className=\"inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full mb-6\">\r\n            <Crown className=\"w-10 h-10 text-white\" />\r\n          </div>\r\n          <h1 className=\"text-5xl font-bold mb-4 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent\">\r\n            Join the Troll Empire Partner Program\r\n          </h1>\r\n          <p className=\"text-xl text-gray-400\">\r\n            Recruit users and earn 5% bonus when they reach 40,000+ coins per month - Free to apply!\r\n          </p>\r\n        </div>\r\n\r\n        {/* Benefits */}\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-8 mb-8\">\r\n          <h2 className=\"text-2xl font-bold mb-6\">Partner Benefits</h2>\r\n          <div className=\"grid md:grid-cols-2 gap-4\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">5% Referral Bonus</h3>\r\n                <p className=\"text-sm text-gray-400\">Earn 5% of referred users' monthly earnings (troll_coins)</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">40,000 Coin Threshold</h3>\r\n                <p className=\"text-sm text-gray-400\">Bonuses activate when referrals earn 40,000+ coins/month</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">Monthly Payouts</h3>\r\n                <p className=\"text-sm text-gray-400\">Bonuses paid automatically at month end</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">Empire Partner Badge</h3>\r\n                <p className=\"text-sm text-gray-400\">Showcase your partner status on your profile</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Application Requirements */}\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-8 mb-8\">\r\n          <h2 className=\"text-2xl font-bold mb-6\">Application Requirements</h2>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">Free Application</h3>\r\n                <p className=\"text-sm text-gray-400\">No payment required - just fill out the form and submit</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">Admin Review</h3>\r\n                <p className=\"text-sm text-gray-400\">Your application will be reviewed by our admin team</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">Lead Troll Officer Approval</h3>\r\n                <p className=\"text-sm text-gray-400\">Must be approved by a Lead Troll Officer before activation</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400 flex-shrink-0 mt-1\" />\r\n              <div>\r\n                <h3 className=\"font-semibold mb-1\">Dual Approval System</h3>\r\n                <p className=\"text-sm text-gray-400\">Both admin and lead officer must approve your application</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Application Button */}\r\n        <div className=\"bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/50 rounded-xl p-8 mb-8 text-center\">\r\n          <h2 className=\"text-2xl font-bold mb-4\">Ready to Apply?</h2>\r\n          <p className=\"text-gray-300 mb-6\">\r\n            Submit your application for approval. Our admin team and Lead Troll Officers will review it carefully.\r\n          </p>\r\n          <button\r\n            onClick={handleSubmitApplication}\r\n            disabled={loading}\r\n            className=\"px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg font-bold text-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            {loading ? 'Submitting...' : 'Submit Application'}\r\n          </button>\r\n        </div>\r\n\r\n        {/* Terms */}\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n          <p className=\"text-sm text-gray-400 text-center\">\r\n            By applying, you agree to the Empire Partner Program terms. Applications are subject to admin approval.\r\n            Refunds are not available for rejected applications.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\EmpirePartnerDashboard.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":354,"column":64,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[11820,11842],"text":"Users you&apos;ve recruited"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[11820,11842],"text":"Users you&lsquo;ve recruited"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[11820,11842],"text":"Users you&#39;ve recruited"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[11820,11842],"text":"Users you&rsquo;ve recruited"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":404,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[14123,14262],"text":"\r\n            Share this link to recruit new users. You&apos;ll earn 10,000 coins when they reach 40,000 troll_coins within 21 days.\r\n          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[14123,14262],"text":"\r\n            Share this link to recruit new users. You&lsquo;ll earn 10,000 coins when they reach 40,000 troll_coins within 21 days.\r\n          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[14123,14262],"text":"\r\n            Share this link to recruit new users. You&#39;ll earn 10,000 coins when they reach 40,000 troll_coins within 21 days.\r\n          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[14123,14262],"text":"\r\n            Share this link to recruit new users. You&rsquo;ll earn 10,000 coins when they reach 40,000 troll_coins within 21 days.\r\n          "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useCallback } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { Users, Coins, CheckCircle2, Copy, Clock } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\n\r\ninterface Referral {\r\n  id: string\r\n  referrer_id: string\r\n  referred_user_id: string\r\n  referred_at: string\r\n  reward_status: 'pending' | 'completed' | 'failed'\r\n  deadline: string\r\n  referred_user: {\r\n    username: string\r\n    avatar_url: string\r\n    troll_coins: number\r\n  }\r\n}\r\n\r\ninterface ReferralReward {\r\n  id: string\r\n  referrer_id: string\r\n  referred_user_id: string\r\n  coins_awarded: number\r\n  rewarded_at: string\r\n}\r\n\r\ninterface ReferralStats {\r\n  totalReferrals: number\r\n  completedReferrals: number\r\n  pendingReferrals: number\r\n  failedReferrals: number\r\n  totalCoinsEarned: number\r\n}\r\n\r\nexport default function EmpirePartnerDashboard() {\r\n  const { profile, user } = useAuthStore()\r\n  const [referrals, setReferrals] = useState<Referral[]>([])\r\n  const [rewards, setRewards] = useState<ReferralReward[]>([])\r\n  const [stats, setStats] = useState<ReferralStats | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [referralLink, setReferralLink] = useState('')\r\n\r\n  // Real-time subscription channels\r\n  // Moved inside useEffect\r\n\r\n  // Defined here to be used in useEffect\r\n  const loadData = useCallback(async () => {\r\n    if (!user?.id) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      // Load referrals with user data\r\n      const { data: referralsData, error: referralsError } = await supabase\r\n        .from('referrals')\r\n        .select(`\r\n          id,\r\n          referrer_id,\r\n          referred_user_id,\r\n          referred_at,\r\n          reward_status,\r\n          deadline,\r\n          referred_user:user_profiles!referrals_referred_user_id_fkey (\r\n            username,\r\n            avatar_url,\r\n            troll_coins\r\n          )\r\n        `)\r\n        .eq('referrer_id', user.id)\r\n        .order('referred_at', { ascending: false })\r\n\r\n      if (referralsError) throw referralsError\r\n\r\n      // Transform referrals data\r\n      const transformedReferrals = (referralsData || []).map((r: any) => ({\r\n        id: r.id,\r\n        referrer_id: r.referrer_id,\r\n        referred_user_id: r.referred_user_id,\r\n        referred_at: r.referred_at,\r\n        reward_status: r.reward_status,\r\n        deadline: r.deadline,\r\n        referred_user: Array.isArray(r.referred_user) ? r.referred_user[0] : r.referred_user\r\n      }))\r\n\r\n      setReferrals(transformedReferrals)\r\n\r\n      // Load rewards\r\n      const { data: rewardsData, error: rewardsError } = await supabase\r\n        .from('empire_partner_rewards')\r\n        .select('*')\r\n        .eq('referrer_id', user.id)\r\n        .order('rewarded_at', { ascending: false })\r\n\r\n      if (rewardsError) throw rewardsError\r\n\r\n      setRewards(rewardsData || [])\r\n\r\n      // Calculate stats\r\n      const totalReferrals = transformedReferrals.length\r\n      const completedReferrals = transformedReferrals.filter(r => r.reward_status === 'completed').length\r\n      const pendingReferrals = transformedReferrals.filter(r => r.reward_status === 'pending').length\r\n      const failedReferrals = transformedReferrals.filter(r => r.reward_status === 'failed').length\r\n      const totalCoinsEarned = (rewardsData || []).reduce((sum, reward) => sum + reward.coins_awarded, 0)\r\n\r\n      setStats({\r\n        totalReferrals,\r\n        completedReferrals,\r\n        pendingReferrals,\r\n        failedReferrals,\r\n        totalCoinsEarned\r\n      })\r\n\r\n    } catch (error: any) {\r\n      console.error('Error loading referral data:', error)\r\n      toast.error('Failed to load referral data')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user?.id])\r\n\r\n  useEffect(() => {\r\n    let referralsChannel: any = null\r\n    let rewardsChannel: any = null\r\n\r\n    if (user?.id && profile) {\r\n      // Check if user is an approved Empire Partner\r\n      if (profile.empire_role !== 'partner') {\r\n        // Don't redirect, just show apply button\r\n        return\r\n      }\r\n\r\n      loadData()\r\n      // Generate referral link\r\n      const baseUrl = window.location.origin\r\n      setReferralLink(`${baseUrl}/auth?ref=${user.id}`)\r\n\r\n      // Subscribe to referrals table changes\r\n      referralsChannel = supabase\r\n        .channel('referrals_changes')\r\n        .on(\r\n          'postgres_changes',\r\n          {\r\n            event: '*',\r\n            schema: 'public',\r\n            table: 'referrals',\r\n            filter: `referrer_id=eq.${user.id}`\r\n          },\r\n          (payload) => {\r\n            console.log('Referrals change detected:', payload)\r\n            loadData() // Reload all data when referrals change\r\n          }\r\n        )\r\n        .subscribe()\r\n\r\n      // Subscribe to rewards table changes\r\n      rewardsChannel = supabase\r\n        .channel('rewards_changes')\r\n        .on(\r\n          'postgres_changes',\r\n          {\r\n            event: '*',\r\n            schema: 'public',\r\n            table: 'empire_partner_rewards',\r\n            filter: `referrer_id=eq.${user.id}`\r\n          },\r\n          (payload) => {\r\n            console.log('Rewards change detected:', payload)\r\n            loadData() // Reload all data when rewards change\r\n          }\r\n        )\r\n        .subscribe()\r\n    }\r\n\r\n    // Cleanup function\r\n    return () => {\r\n      if (referralsChannel) {\r\n        supabase.removeChannel(referralsChannel)\r\n      }\r\n      if (rewardsChannel) {\r\n        supabase.removeChannel(rewardsChannel)\r\n      }\r\n    }\r\n  }, [user?.id, profile, loadData])\r\n\r\n  useEffect(() => {\r\n    // Subscribe to wallets table changes for referred users\r\n    // Only subscribe if we have referrals\r\n    const referredUserIds = referrals.map(r => r.referred_user_id)\r\n    \r\n    if (referredUserIds.length === 0) return\r\n\r\n    const walletsChannel = supabase\r\n      .channel('wallets_changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'UPDATE',\r\n          schema: 'public',\r\n          table: 'wallets',\r\n          filter: `user_id=in.(${referredUserIds.join(',')})`\r\n        },\r\n        (payload) => {\r\n          console.log('Wallet change detected for referred user:', payload)\r\n          loadData() // Reload data when referred users' wallets change\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      supabase.removeChannel(walletsChannel)\r\n    }\r\n  }, [referrals, loadData])\r\n  \r\n  // Show apply button if not approved\r\n  if (profile?.empire_role !== 'partner') {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto text-center py-20\">\r\n          <h1 className=\"text-4xl font-bold mb-4\">Empire Partner Program</h1>\r\n          <p className=\"text-gray-400 mb-8\">You must be an approved Empire Partner to access the referral dashboard.</p>\r\n          <a\r\n            href=\"/empire-partner/apply\"\r\n            className=\"inline-block px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-semibold\"\r\n          >\r\n            Apply Now\r\n          </a>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n\r\n\r\n  const copyReferralLink = () => {\r\n    navigator.clipboard.writeText(referralLink)\r\n    toast.success('Referral link copied!')\r\n  }\r\n\r\n  const updateReferralStatus = async (referralId: string, newStatus: 'completed' | 'failed') => {\r\n    if (!user?.id) return\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('referrals')\r\n        .update({\r\n          reward_status: newStatus,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', referralId)\r\n        .eq('referrer_id', user.id) // Ensure user can only update their own referrals\r\n\r\n      if (error) throw error\r\n\r\n      // If completing a referral, also create the reward record\r\n      if (newStatus === 'completed') {\r\n        const referral = referrals.find(r => r.id === referralId)\r\n        if (referral) {\r\n          const { error: rewardError } = await supabase\r\n            .from('empire_partner_rewards')\r\n            .insert({\r\n              referrer_id: user.id,\r\n              referred_user_id: referral.referred_user_id,\r\n              coins_awarded: 10000\r\n            })\r\n\r\n          if (rewardError) {\r\n            console.error('Error creating reward record:', rewardError)\r\n            // Don't fail the whole operation if reward creation fails\r\n          } else {\r\n            // Award coins using Troll Bank RPC (Centralized Economy)\r\n            const { error: rpcError } = await supabase.rpc('troll_bank_credit_coins', {\r\n              p_user_id: user.id,\r\n              p_coins: 10000,\r\n              p_bucket: 'promo',\r\n              p_source: 'referral_reward',\r\n              p_ref_id: referralId,\r\n              p_metadata: { referral_id: referralId, referred_user: referral.referred_user_id }\r\n            })\r\n\r\n            if (rpcError) {\r\n              console.error('Error crediting coins via Troll Bank:', rpcError)\r\n              toast.error('Failed to credit coins to your balance')\r\n            } else {\r\n               // Update legacy wallets table for dashboard compatibility if needed\r\n               const { data: currentWallet } = await supabase\r\n                 .from('wallets')\r\n                 .select('troll_coins')\r\n                 .eq('user_id', user.id)\r\n                 .single()\r\n   \r\n               if (currentWallet) {\r\n                 await supabase\r\n                   .from('wallets')\r\n                   .update({\r\n                     troll_coins: currentWallet.troll_coins + 10000,\r\n                     updated_at: new Date().toISOString()\r\n                   })\r\n                   .eq('user_id', user.id)\r\n               } else {\r\n                 await supabase\r\n                   .from('wallets')\r\n                   .insert({\r\n                     user_id: user.id,\r\n                     troll_coins: 10000,\r\n                     updated_at: new Date().toISOString()\r\n                   })\r\n               }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      toast.success(`Referral ${newStatus === 'completed' ? 'completed' : 'marked as failed'}`)\r\n      loadData() // Refresh data\r\n    } catch (error: any) {\r\n      console.error('Error updating referral status:', error)\r\n      toast.error('Failed to update referral status')\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n        <div className=\"max-w-7xl mx-auto\">\r\n          <div className=\"text-center py-20\">\r\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto\"></div>\r\n            <p className=\"mt-4 text-gray-400\">Loading referral data...</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-7xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent\">\r\n            Troll Empire Partner Program\r\n          </h1>\r\n          <p className=\"text-gray-400\">Earn 10,000 coins when your referrals reach 40,000 troll_coins within 21 days</p>\r\n        </div>\r\n\r\n        {/* Stats Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">\r\n          <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n            <div className=\"flex items-center gap-3 mb-2\">\r\n              <Users className=\"w-6 h-6 text-purple-400\" />\r\n              <h3 className=\"text-lg font-semibold\">Total Referrals</h3>\r\n            </div>\r\n            <p className=\"text-3xl font-bold\">{stats?.totalReferrals || 0}</p>\r\n            <p className=\"text-sm text-gray-400 mt-2\">Users you've recruited</p>\r\n          </div>\r\n\r\n          <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n            <div className=\"flex items-center gap-3 mb-2\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-green-400\" />\r\n              <h3 className=\"text-lg font-semibold\">Completed</h3>\r\n            </div>\r\n            <p className=\"text-3xl font-bold\">{stats?.completedReferrals || 0}</p>\r\n            <p className=\"text-sm text-gray-400 mt-2\">Qualified referrals</p>\r\n          </div>\r\n\r\n          <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n            <div className=\"flex items-center gap-3 mb-2\">\r\n              <Clock className=\"w-6 h-6 text-yellow-400\" />\r\n              <h3 className=\"text-lg font-semibold\">Pending</h3>\r\n            </div>\r\n            <p className=\"text-3xl font-bold\">{stats?.pendingReferrals || 0}</p>\r\n            <p className=\"text-sm text-gray-400 mt-2\">Within 3-week window</p>\r\n          </div>\r\n\r\n          <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n            <div className=\"flex items-center gap-3 mb-2\">\r\n              <Coins className=\"w-6 h-6 text-yellow-400\" />\r\n              <h3 className=\"text-lg font-semibold\">Total Earned</h3>\r\n            </div>\r\n            <p className=\"text-3xl font-bold\">{stats?.totalCoinsEarned?.toLocaleString() || 0}</p>\r\n            <p className=\"text-sm text-gray-400 mt-2\">Coins from referrals</p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Referral Link */}\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6 mb-8\">\r\n          <h2 className=\"text-xl font-semibold mb-4\">Your Referral Link</h2>\r\n          <div className=\"flex gap-3\">\r\n            <input\r\n              type=\"text\"\r\n              value={referralLink}\r\n              readOnly\r\n              className=\"flex-1 bg-[#0A0814] border border-[#2C2C2C] rounded-lg px-4 py-2 text-sm\"\r\n            />\r\n            <button\r\n              onClick={copyReferralLink}\r\n              className=\"px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg flex items-center gap-2\"\r\n            >\r\n              <Copy className=\"w-4 h-4\" />\r\n              Copy\r\n            </button>\r\n          </div>\r\n          <p className=\"text-sm text-gray-400 mt-2\">\r\n            Share this link to recruit new users. You'll earn 10,000 coins when they reach 40,000 troll_coins within 21 days.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Referrals Table */}\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6 mb-8\">\r\n          <h2 className=\"text-xl font-semibold mb-4\">Your Referrals</h2>\r\n          {referrals.length === 0 ? (\r\n            <div className=\"text-center py-12 text-gray-400\">\r\n              <Users className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\r\n              <p>No referrals yet. Share your referral link to start earning!</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {referrals.map((referral) => {\r\n                const daysRemaining = Math.max(0, Math.ceil((new Date(referral.deadline).getTime() - Date.now()) / (1000 * 60 * 60 * 24)))\r\n                const progress = Math.min(100, (referral.referred_user?.troll_coins || 0) / 40000 * 100)\r\n                const isExpired = new Date(referral.deadline) < new Date()\r\n\r\n                return (\r\n                  <div key={referral.id} className=\"bg-[#0A0814] border border-[#2C2C2C] rounded-lg p-4\">\r\n                    <div className=\"flex items-start justify-between mb-3\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <img\r\n                          src={referral.referred_user?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${referral.referred_user?.username}`}\r\n                          alt={referral.referred_user?.username}\r\n                          className=\"w-12 h-12 rounded-full\"\r\n                        />\r\n                        <div>\r\n                          <div className=\"font-semibold text-white\">{referral.referred_user?.username || 'Unknown'}</div>\r\n                          <div className=\"text-sm text-gray-400\">\r\n                            Joined {new Date(referral.referred_at).toLocaleDateString()}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"text-right\">\r\n                        {referral.reward_status === 'completed' && (\r\n                          <span className=\"px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-medium\">\r\n                            Completed\r\n                          </span>\r\n                        )}\r\n                        {referral.reward_status === 'pending' && !isExpired && (\r\n                          <span className=\"px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm font-medium\">\r\n                            Pending\r\n                          </span>\r\n                        )}\r\n                        {referral.reward_status === 'failed' && (\r\n                          <span className=\"px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm font-medium\">\r\n                            Failed\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span className=\"text-gray-400\">troll_coins Progress</span>\r\n                        <span className=\"text-white font-medium\">\r\n                          {(referral.referred_user?.troll_coins || 0).toLocaleString()} / 40,000\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"w-full bg-gray-700 rounded-full h-2\">\r\n                        <div\r\n                          className=\"bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-300\"\r\n                          style={{ width: `${progress}%` }}\r\n                        ></div>\r\n                      </div>\r\n                      <div className=\"flex justify-between items-center text-xs text-gray-400\">\r\n                        <span>\r\n                          {referral.reward_status === 'pending' && !isExpired\r\n                            ? `${daysRemaining} days remaining`\r\n                            : referral.reward_status === 'completed'\r\n                            ? 'Qualified!'\r\n                            : 'Expired'\r\n                          }\r\n                        </span>\r\n                        <span>\r\n                          {progress >= 100 ? 'Target reached!' : `${Math.round(progress)}% complete`}\r\n                        </span>\r\n                      </div>\r\n\r\n                      {/* Admin override buttons for pending referrals */}\r\n                      {referral.reward_status === 'pending' && (\r\n                        <div className=\"flex gap-2 mt-3\">\r\n                          <button\r\n                            onClick={() => updateReferralStatus(referral.id, 'completed')}\r\n                            className=\"px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors\"\r\n                          >\r\n                            Complete\r\n                          </button>\r\n                          <button\r\n                            onClick={() => updateReferralStatus(referral.id, 'failed')}\r\n                            className=\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors\"\r\n                          >\r\n                            Fail\r\n                          </button>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                )\r\n              })}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Rewards History */}\r\n        {rewards.length > 0 && (\r\n          <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n            <h2 className=\"text-xl font-semibold mb-4\">Rewards History</h2>\r\n            <div className=\"space-y-3\">\r\n              {rewards.map((reward) => (\r\n                <div\r\n                  key={reward.id}\r\n                  className=\"bg-[#0A0814] border border-[#2C2C2C] rounded-lg p-4 flex items-center justify-between\"\r\n                >\r\n                  <div>\r\n                    <p className=\"font-medium\">\r\n                      Referral reward for qualifying user\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-400\">\r\n                      {new Date(reward.rewarded_at).toLocaleDateString()} ‚Ä¢ Automatic reward\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"text-right\">\r\n                    <p className=\"text-lg font-bold text-yellow-400\">\r\n                      +{reward.coins_awarded.toLocaleString()} coins\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-400\">Empire Partner reward</p>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\EntranceEffects.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ExitPage.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":51,"column":14,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[2198,2250],"text":"\r\n          You&apos;ve successfully logged out\r\n        "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[2198,2250],"text":"\r\n          You&lsquo;ve successfully logged out\r\n        "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[2198,2250],"text":"\r\n          You&#39;ve successfully logged out\r\n        "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[2198,2250],"text":"\r\n          You&rsquo;ve successfully logged out\r\n        "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { LogOut, Home } from 'lucide-react';\r\n\r\nexport default function ExitPage() {\r\n  const navigate = useNavigate();\r\n  const [countdown, setCountdown] = useState(3);\r\n\r\n  // Countdown timer\r\n  useEffect(() => {\r\n    const timer = setInterval(() => {\r\n      setCountdown((prev) => prev - 1);\r\n    }, 1000);\r\n\r\n    return () => clearInterval(timer);\r\n  }, []);\r\n\r\n  // Separate effect for navigation when countdown reaches 0\r\n  useEffect(() => {\r\n    if (countdown <= 0) {\r\n      navigate('/');\r\n    }\r\n  }, [countdown, navigate]);\r\n\r\n  return (\r\n    <div className=\"min-h-screen w-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 flex items-center justify-center overflow-hidden relative\">\r\n      {/* Animated Background */}\r\n      <div className=\"absolute inset-0 overflow-hidden\">\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(147,51,234,0.15),transparent)]\" />\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_80%_80%,rgba(236,72,153,0.12),transparent)]\" />\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(56,189,248,0.08),transparent)]\" />\r\n      </div>\r\n\r\n      {/* Content */}\r\n      <div className=\"relative z-10 text-center px-4 animate-fade-in\">\r\n        {/* Logout Icon */}\r\n        <div className=\"mb-8 flex justify-center\">\r\n          <div className=\"relative\">\r\n            <div className=\"absolute inset-0 rounded-full bg-purple-600/30 blur-2xl animate-pulse-slow\" />\r\n            <div className=\"relative w-24 h-24 bg-gradient-to-br from-purple-600 via-pink-600 to-cyan-500 rounded-full flex items-center justify-center shadow-[0_20px_60px_rgba(147,51,234,0.4)]\">\r\n              <LogOut className=\"w-12 h-12 text-white\" />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Message */}\r\n        <h1 className=\"text-4xl md:text-6xl font-black mb-4 bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent\">\r\n          Come Back Soon!\r\n        </h1>\r\n        <p className=\"text-xl md:text-2xl text-slate-300 mb-6\">\r\n          You've successfully logged out\r\n        </p>\r\n        <p className=\"text-lg text-slate-400 mb-8\">\r\n          Thanks for visiting Troll City\r\n        </p>\r\n\r\n        {/* Countdown */}\r\n        <div className=\"mb-8\">\r\n          <div className=\"inline-flex items-center gap-3 px-6 py-3 bg-white/5 backdrop-blur-sm rounded-full border border-white/10\">\r\n            <span className=\"text-slate-300\">Redirecting in</span>\r\n            <span className=\"text-3xl font-bold bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent\">\r\n              {countdown}\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Action Buttons */}\r\n        <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\r\n          <button\r\n            onClick={() => navigate('/')}\r\n            className=\"group px-8 py-4 bg-gradient-to-r from-purple-600 via-pink-600 to-cyan-500 rounded-2xl font-semibold text-lg text-white shadow-[0_10px_40px_rgba(147,51,234,0.35)] hover:shadow-[0_15px_50px_rgba(236,72,153,0.4)] transition-all duration-300 hover:-translate-y-0.5 flex items-center justify-center gap-2\"\r\n          >\r\n            <Home className=\"w-5 h-5\" />\r\n            Back to Landing\r\n          </button>\r\n          <button\r\n            onClick={() => navigate('/auth')}\r\n            className=\"px-8 py-4 bg-slate-900/60 backdrop-blur-xl border border-white/10 rounded-2xl font-semibold text-lg text-slate-50 hover:border-cyan-400/40 hover:bg-slate-800/70 transition-all duration-300 hover:-translate-y-0.5 shadow-[0_10px_30px_rgba(0,0,0,0.35)]\"\r\n          >\r\n            Sign In Again\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Animated Particles */}\r\n      <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\r\n        {Array.from({ length: 15 }).map((_, i) => (\r\n          <div\r\n            key={i}\r\n            className=\"absolute w-1 h-1 bg-cyan-400/40 rounded-full\"\r\n            style={{\r\n              left: `${Math.random() * 100}%`,\r\n              top: `${Math.random() * 100}%`,\r\n              animation: `float-particle ${5 + Math.random() * 10}s ease-in-out infinite`,\r\n              animationDelay: `${Math.random() * 5}s`,\r\n            }}\r\n          />\r\n        ))}\r\n      </div>\r\n\r\n      <style>\r\n        {`\r\n          @keyframes fade-in {\r\n            from { opacity: 0; transform: translateY(20px); }\r\n            to { opacity: 1; transform: translateY(0); }\r\n          }\r\n          \r\n          @keyframes pulse-slow {\r\n            0%, 100% { opacity: 0.5; transform: scale(1); }\r\n            50% { opacity: 1; transform: scale(1.05); }\r\n          }\r\n          \r\n          @keyframes float-particle {\r\n            0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0; }\r\n            10% { opacity: 0.6; }\r\n            90% { opacity: 0.6; }\r\n            50% { transform: translateY(-100px) translateX(50px); }\r\n          }\r\n          \r\n          .animate-fade-in {\r\n            animation: fade-in 0.8s ease-out forwards;\r\n          }\r\n          \r\n          .animate-pulse-slow {\r\n            animation: pulse-slow 3s ease-in-out infinite;\r\n          }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ExploreFeed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyApplication.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyBrowse.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyChatPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyLeaderboard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyLounge.jsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'contributeToTask' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":279,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":279,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAutoTracked' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":299,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":299,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport {\r\n  Crown, Users, Coins, TrendingUp, Target, Calendar,\r\n  Trophy, Sword, Star, Zap, Award\r\n} from 'lucide-react'\r\n\r\nconst FamilyLounge = () => {\r\n  const { user } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [family, setFamily] = useState(null)\r\n  const [familyStats, setFamilyStats] = useState(null)\r\n  const [familyTasks, setFamilyTasks] = useState([])\r\n  const [activityLog, setActivityLog] = useState([])\r\n  const [memberRole, setMemberRole] = useState('member')\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  // Create Family State\r\n  const [showCreateModal, setShowCreateModal] = useState(false)\r\n  const [newFamilyName, setNewFamilyName] = useState('')\r\n  const [creating, setCreating] = useState(false)\r\n\r\n  const handleCreateFamily = async (e) => {\r\n    e.preventDefault()\r\n    if (!newFamilyName.trim()) return toast.error('Family name required')\r\n    \r\n    setCreating(true)\r\n    try {\r\n      // 1. Create Family\r\n      const { data: familyData, error: familyError } = await supabase\r\n        .from('troll_families')\r\n        .insert({\r\n          name: newFamilyName,\r\n          family_name: newFamilyName,\r\n          leader_id: user.id,\r\n          description: `The ${newFamilyName} family`,\r\n          xp: 0,\r\n          level: 1\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (familyError) throw familyError\r\n\r\n      // 2. Add creator as leader\r\n      const { error: memberError } = await supabase\r\n        .from('family_members')\r\n        .insert({\r\n          family_id: familyData.id,\r\n          user_id: user.id,\r\n          role: 'leader',\r\n          rank_name: 'Royal Troll',\r\n          is_royal_troll: true\r\n        })\r\n\r\n      if (memberError) throw memberError\r\n\r\n      toast.success('Family Created Successfully!')\r\n      setShowCreateModal(false)\r\n      \r\n      // Optimistic update to immediately show the family interface\r\n      setFamily(familyData)\r\n      setMemberRole('leader')\r\n      setFamilyStats({\r\n        family_id: familyData.id,\r\n        total_coins: 0,\r\n        weekly_coins: 0,\r\n        season_coins: 0,\r\n        level: 1,\r\n        xp: 0\r\n      })\r\n      setFamilyTasks([])\r\n      setActivityLog([])\r\n      \r\n      // Background refresh to ensure everything is synced\r\n      loadFamilyData()\r\n    } catch (error) {\r\n      console.error('Error creating family:', error)\r\n      if (error.code === '23505' || error.message?.includes('duplicate key')) {\r\n        toast.error('A family with this name already exists. Please choose another name.')\r\n      } else {\r\n        toast.error(error.message || 'Failed to create family')\r\n      }\r\n    } finally {\r\n      setCreating(false)\r\n    }\r\n  }\r\n\r\n  const generateTasks = async () => {\r\n    if (!family || !family.id) return\r\n    setLoading(true)\r\n    try {\r\n      const tasks = [\r\n        {\r\n          family_id: family.id,\r\n          task_title: 'Recruit New Trolls',\r\n          task_description: 'Grow your family by recruiting 3 new members this week.',\r\n          reward_family_coins: 500,\r\n          reward_family_xp: 100,\r\n          goal_value: 3,\r\n          current_value: 0,\r\n          metric: 'family_members_recruited',\r\n          status: 'active',\r\n          expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()\r\n        },\r\n        {\r\n          family_id: family.id,\r\n          task_title: 'Host a Clan Stream',\r\n          task_description: 'Start a live stream representing your family.',\r\n          reward_family_coins: 200,\r\n          reward_family_xp: 50,\r\n          goal_value: 1,\r\n          current_value: 0,\r\n          metric: 'streams_started',\r\n          status: 'active',\r\n          expires_at: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString()\r\n        },\r\n        {\r\n          family_id: family.id,\r\n          task_title: 'Gift Raid',\r\n          task_description: 'Send 5 gifts to support other trolls.',\r\n          reward_family_coins: 300,\r\n          reward_family_xp: 75,\r\n          goal_value: 5,\r\n          current_value: 0,\r\n          metric: 'gifts_sent',\r\n          status: 'active',\r\n          expires_at: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString()\r\n        }\r\n      ]\r\n\r\n      // Prefer RPC to handle RLS and schema variations server-side\r\n      const { error: rpcError } = await supabase.rpc('create_family_tasks', { p_family_id: family.id })\r\n      let error = rpcError\r\n      if (rpcError && (rpcError.code === '404' || rpcError.message?.includes('function not found'))) {\r\n        // Fallback to direct insert if RPC missing\r\n        const { error: insertErr } = await supabase.from('family_tasks').insert(tasks)\r\n        error = insertErr || null\r\n      }\r\n      \r\n      if (error) {\r\n        // Check for column errors (Postgres code 42703 is undefined_column)\r\n        if (error.code === '42703') {\r\n           console.warn('New schema failed, attempting legacy schema fallback...')\r\n           \r\n           const legacyTasks = tasks.map(t => ({\r\n             family_id: t.family_id,\r\n             title: t.task_title,\r\n             description: t.task_description,\r\n             category: 'General',\r\n             task_type: 'Influence', // Required in some legacy schemas\r\n             reward_coins: t.reward_family_coins,\r\n             reward_xp: t.reward_family_xp,\r\n             status: 'active',\r\n             expires_at: t.expires_at\r\n           }))\r\n\r\n           const { error: legacyError } = await supabase.from('family_tasks').insert(legacyTasks)\r\n           if (legacyError) throw legacyError\r\n        } else {\r\n           throw error\r\n        }\r\n      }\r\n      \r\n      // Force refresh data\r\n      await loadFamilyData()\r\n      toast.success('Weekly tasks generated!')\r\n    } catch (error) {\r\n      console.error('Error generating tasks:', error)\r\n      toast.error(`Failed to generate tasks: ${error.message || 'Unknown error'}`)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const loadFamilyData = useCallback(async () => {\r\n    setLoading(true)\r\n    try {\r\n      // Step 1: Get membership first (without join to avoid relationship issues)\r\n      const { data: membership, error: memberError } = await supabase\r\n        .from('family_members')\r\n        .select('family_id, role')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle()\r\n\r\n      if (memberError) throw memberError\r\n\r\n      if (membership?.family_id) {\r\n        // Step 2: Get family details\r\n        const { data: familyData, error: familyError } = await supabase\r\n          .from('troll_families')\r\n          .select('*')\r\n          .eq('id', membership.family_id)\r\n          .single()\r\n\r\n        if (familyError) throw familyError\r\n\r\n        if (familyData) {\r\n          setFamily(familyData)\r\n          setMemberRole(membership.role)\r\n\r\n          const familyId = familyData.id\r\n\r\n          // Load family stats\r\n          const { data: stats } = await supabase\r\n            .from('family_stats')\r\n            .select('*')\r\n            .eq('family_id', familyId)\r\n            .maybeSingle()\r\n\r\n          // If no stats exist, use defaults\r\n          setFamilyStats(stats || {\r\n            family_id: familyId,\r\n            total_coins: 0,\r\n            weekly_coins: 0,\r\n            season_coins: 0,\r\n            level: 1,\r\n            xp: 0\r\n          })\r\n\r\n          // Load tasks, prefer active but fall back to any recent if needed\r\n          let { data: tasks } = await supabase\r\n            .from('family_tasks')\r\n            .select('*')\r\n            .eq('family_id', familyId)\r\n            .eq('status', 'active')\r\n            .order('created_at', { ascending: false })\r\n            .limit(5)\r\n\r\n          if (!tasks || tasks.length === 0) {\r\n            const { data: anyTasks } = await supabase\r\n              .from('family_tasks')\r\n              .select('*')\r\n              .eq('family_id', familyId)\r\n              .order('created_at', { ascending: false })\r\n              .limit(5)\r\n\r\n            tasks = anyTasks || []\r\n          }\r\n\r\n          setFamilyTasks(tasks || [])\r\n\r\n          // Load recent activity\r\n          const { data: activities } = await supabase\r\n            .from('family_activity_log')\r\n            .select(`\r\n              *,\r\n              profiles:user_profiles!family_activity_log_user_id_fkey (username)\r\n            `)\r\n            .eq('family_id', familyId)\r\n            .order('created_at', { ascending: false })\r\n            .limit(10)\r\n\r\n          setActivityLog(activities || [])\r\n        }\r\n      } else {\r\n        setFamily(null)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading family data:', error)\r\n      // Only show error if it's not \"PGRST116\" (no result) which is expected if not in family\r\n      if (error.code !== 'PGRST116') {\r\n         toast.error(`Failed to load family: ${error.message}`)\r\n      }\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user])\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadFamilyData()\r\n    }\r\n  }, [user, loadFamilyData])\r\n\r\n  const contributeToTask = async (taskId) => {\r\n    // This function is now deprecated for manual contribution to auto-tracked tasks\r\n    // But kept for any manual tasks if they exist\r\n    try {\r\n      const { error } = await supabase.rpc('increment_task_progress', {\r\n        p_task_id: taskId,\r\n        p_increment: 1\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      toast.success('Contribution recorded!')\r\n      loadFamilyData() \r\n    } catch (error) {\r\n      console.error('Error contributing to task:', error)\r\n      toast.error('Failed to record contribution')\r\n    }\r\n  }\r\n\r\n  // Helper to check if task is auto-tracked\r\n  const isAutoTracked = (metric) => {\r\n    const autoMetrics = [\r\n      'family_members_recruited',\r\n      'streams_started', \r\n      'gifts_sent',\r\n      'wars_declared',\r\n      'wars_won'\r\n    ]\r\n    return autoMetrics.includes(metric)\r\n  }\r\n\r\n  const getEventIcon = (eventType) => {\r\n    switch (eventType) {\r\n      case 'coins_earned': return <Coins className=\"w-4 h-4 text-yellow-400\" />\r\n      case 'level_up': return <TrendingUp className=\"w-4 h-4 text-green-400\" />\r\n      case 'task_completed': return <Target className=\"w-4 h-4 text-blue-400\" />\r\n      case 'war_win': return <Trophy className=\"w-4 h-4 text-purple-400\" />\r\n      case 'war_loss': return <Sword className=\"w-4 h-4 text-red-400\" />\r\n      case 'shop_purchase': return <Award className=\"w-4 h-4 text-pink-400\" />\r\n      default: return <Star className=\"w-4 h-4 text-gray-400\" />\r\n    }\r\n  }\r\n\r\n  const formatTimeAgo = (timestamp) => {\r\n    const now = new Date()\r\n    const time = new Date(timestamp)\r\n    const diffMs = now - time\r\n    const diffMins = Math.floor(diffMs / 60000)\r\n    const diffHours = Math.floor(diffMins / 60)\r\n    const diffDays = Math.floor(diffHours / 24)\r\n\r\n    if (diffMins < 1) return 'Just now'\r\n    if (diffMins < 60) return `${diffMins}m ago`\r\n    if (diffHours < 24) return `${diffHours}h ago`\r\n    return `${diffDays}d ago`\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <Crown className=\"animate-spin w-8 h-8 mx-auto mb-4 text-purple-400\" />\r\n          <p>Loading family lounge...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!family) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto text-center mt-20\">\r\n          <Crown className=\"w-16 h-16 mx-auto mb-6 text-purple-400\" />\r\n          <h1 className=\"text-3xl font-bold mb-4\">Not in a Family</h1>\r\n          <p className=\"text-gray-300 mb-8 max-w-lg mx-auto\">\r\n            Join an existing family or create your own legacy. Lead your family to glory in the Troll City wars!\r\n          </p>\r\n          \r\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\r\n            <button\r\n              onClick={() => navigate('/family/browse')}\r\n              className=\"px-8 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg font-semibold transition-colors border border-zinc-700\"\r\n            >\r\n              Browse Families\r\n            </button>\r\n            \r\n            <button\r\n              onClick={() => setShowCreateModal(true)}\r\n              className=\"px-8 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors flex items-center gap-2 justify-center\"\r\n            >\r\n              <Crown className=\"w-5 h-5\" />\r\n              Create New Family\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Create Family Modal */}\r\n        {showCreateModal && (\r\n          <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-zinc-900 border border-purple-500/30 rounded-2xl p-6 max-w-md w-full relative\">\r\n              <button \r\n                onClick={() => setShowCreateModal(false)}\r\n                className=\"absolute top-4 right-4 text-gray-400 hover:text-white\"\r\n              >\r\n                ‚úï\r\n              </button>\r\n              \r\n              <h2 className=\"text-2xl font-bold mb-2 flex items-center gap-2\">\r\n                <Crown className=\"text-purple-400\" />\r\n                Create Troll Family\r\n              </h2>\r\n              <p className=\"text-gray-400 text-sm mb-6\">\r\n                Establish your own family. You will become the leader and Royal Troll.\r\n              </p>\r\n\r\n              <form onSubmit={handleCreateFamily} className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                    Family Name\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={newFamilyName}\r\n                    onChange={(e) => setNewFamilyName(e.target.value)}\r\n                    placeholder=\"e.g. The Bridge Keepers\"\r\n                    className=\"w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none\"\r\n                    maxLength={30}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"pt-2\">\r\n                  <button\r\n                    type=\"submit\"\r\n                    disabled={creating || !newFamilyName.trim()}\r\n                    className=\"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\r\n                  >\r\n                    {creating ? (\r\n                      <>Creating...</>\r\n                    ) : (\r\n                      <>\r\n                        <Crown className=\"w-5 h-5\" />\r\n                        Establish Family\r\n                      </>\r\n                    )}\r\n                  </button>\r\n                </div>\r\n              </form>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const currentXP = familyStats?.xp || 0\r\n  const currentLevel = familyStats?.level || 1\r\n  const nextLevelXP = currentLevel * currentLevel * 1000\r\n  const xpProgress = (currentXP / nextLevelXP) * 100\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-7xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"text-center\">\r\n          <div className=\"flex items-center justify-center gap-4 mb-4\">\r\n            {family.emblem_url && (\r\n              <img\r\n                src={family.emblem_url}\r\n                alt={`${family.name} emblem`}\r\n                className=\"w-16 h-16 rounded-full border-2 border-purple-400\"\r\n              />\r\n            )}\r\n            <div>\r\n              <h1 className=\"text-4xl font-bold flex items-center gap-3\">\r\n                <Crown className=\"w-8 h-8 text-yellow-400\" />\r\n                {family.name}\r\n              </h1>\r\n              <p className=\"text-gray-300\">Level {currentLevel} Family</p>\r\n            </div>\r\n          </div>\r\n          <p className=\"text-purple-300 text-sm\">\r\n            You are in {family.name} ‚Ä¢ Role: {memberRole}\r\n          </p>\r\n        </div>\r\n\r\n        {/* XP Progress Bar */}\r\n        <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-700\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-sm text-gray-400\">Family XP Progress</span>\r\n            <span className=\"text-sm text-purple-400\">{currentXP.toLocaleString()} / {nextLevelXP.toLocaleString()} XP</span>\r\n          </div>\r\n          <div className=\"w-full bg-zinc-800 rounded-full h-3\">\r\n            <div\r\n              className=\"bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500\"\r\n              style={{ width: `${Math.min(xpProgress, 100)}%` }}\r\n            ></div>\r\n          </div>\r\n          <p className=\"text-xs text-gray-500 mt-2\">\r\n            {nextLevelXP - currentXP} XP needed for Level {currentLevel + 1}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Stats Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n          <div className=\"bg-zinc-900 rounded-xl p-4 border border-yellow-500/30\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <Coins className=\"w-5 h-5 text-yellow-400\" />\r\n              <span className=\"text-sm text-gray-400\">Total Coins</span>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-yellow-400\">\r\n              {(familyStats?.total_coins || 0).toLocaleString()}\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"bg-zinc-900 rounded-xl p-4 border border-blue-500/30\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <Calendar className=\"w-5 h-5 text-blue-400\" />\r\n              <span className=\"text-sm text-gray-400\">Weekly Coins</span>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-blue-400\">\r\n              {(familyStats?.weekly_coins || 0).toLocaleString()}\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"bg-zinc-900 rounded-xl p-4 border border-purple-500/30\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <Star className=\"w-5 h-5 text-purple-400\" />\r\n              <span className=\"text-sm text-gray-400\">Season Coins</span>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-purple-400\">\r\n              {(familyStats?.season_coins || 0).toLocaleString()}\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"bg-zinc-900 rounded-xl p-4 border border-green-500/30\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <Users className=\"w-5 h-5 text-green-400\" />\r\n              <span className=\"text-sm text-gray-400\">Family Level</span>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-green-400\">\r\n              Level {currentLevel}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Recent Activity */}\r\n        <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-700\">\r\n          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n            <Zap className=\"w-5 h-5 text-yellow-400\" />\r\n            Recent Activity\r\n          </h2>\r\n          <div className=\"space-y-3 max-h-64 overflow-y-auto\">\r\n            {activityLog.length === 0 ? (\r\n              <p className=\"text-gray-400 text-center py-4\">No recent activity</p>\r\n            ) : (\r\n              activityLog.map((activity) => (\r\n                <div key={activity.id} className=\"flex items-center gap-3 p-3 bg-zinc-800/50 rounded-lg\">\r\n                  {getEventIcon(activity.event_type)}\r\n                  <div className=\"flex-1\">\r\n                    <p className=\"text-sm text-gray-300\">{activity.event_message}</p>\r\n                    <p className=\"text-xs text-gray-500\">\r\n                      {activity.profiles?.username || 'System'} ‚Ä¢ {formatTimeAgo(activity.created_at)}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Active Tasks */}\r\n        <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-700\">\r\n          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n            <Target className=\"w-5 h-5 text-blue-400\" />\r\n            Active Family Tasks\r\n          </h2>\r\n          <div className=\"space-y-4\">\r\n            {familyTasks.length === 0 ? (\r\n              <div className=\"text-center py-6\">\r\n                <p className=\"text-gray-400 mb-4\">No active tasks</p>\r\n                {['leader', 'officer'].includes(memberRole) && (\r\n                  <button\r\n                    onClick={generateTasks}\r\n                    className=\"px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg font-semibold text-white transition-all flex items-center gap-2 mx-auto\"\r\n                  >\r\n                    <Target className=\"w-4 h-4\" />\r\n                    Generate Weekly Tasks\r\n                  </button>\r\n                )}\r\n              </div>\r\n            ) : (\r\n              familyTasks.map((task) => {\r\n                const goal = task.goal_value ?? task.target_value ?? 1\r\n                const current = task.current_value ?? task.progress_value ?? 0\r\n                const progress = goal > 0 ? (current / goal) * 100 : 0\r\n                const title = task.task_title || task.title || 'Family Task'\r\n                const description = task.task_description || task.description || ''\r\n                const rewardCoins = task.reward_family_coins ?? task.reward_coins ?? 0\r\n                const rewardXp = task.reward_family_xp ?? task.reward_xp ?? 0\r\n\r\n                return (\r\n                  <div key={task.id} className=\"bg-zinc-800/50 rounded-lg p-4\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <h3 className=\"font-semibold text-purple-400\">{title}</h3>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Coins className=\"w-4 h-4 text-yellow-400\" />\r\n                        <span className=\"text-sm text-yellow-400\">+{rewardCoins}</span>\r\n                        <Star className=\"w-4 h-4 text-blue-400\" />\r\n                        <span className=\"text-sm text-blue-400\">+{rewardXp} XP</span>\r\n                      </div>\r\n                    </div>\r\n                    {description && (\r\n                      <p className=\"text-sm text-gray-300 mb-3\">{description}</p>\r\n                    )}\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <span className=\"text-sm text-gray-400\">\r\n                        Progress: {current} / {goal}\r\n                      </span>\r\n                      <span className=\"text-sm text-gray-400\">{Math.round(progress)}%</span>\r\n                    </div>\r\n                    <div className=\"w-full bg-zinc-700 rounded-full h-2 mb-3\">\r\n                      <div\r\n                        className=\"bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-500\"\r\n                        style={{ width: `${Math.min(progress, 100)}%` }}\r\n                      ></div>\r\n                    </div>\r\n                    {/* Contribute button removed as requested */}\r\n                  </div>\r\n                )\r\n              })\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Quick Actions */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n          <button\r\n            onClick={() => navigate('/family/wars-hub')}\r\n            className=\"p-4 bg-zinc-900 border border-red-500/50 rounded-lg hover:bg-zinc-800 transition-colors text-left\"\r\n          >\r\n            <Sword className=\"w-6 h-6 text-red-400 mb-2\" />\r\n            <p className=\"font-semibold\">Family War Hub</p>\r\n            <p className=\"text-sm opacity-70\">Battle other families for glory</p>\r\n          </button>\r\n\r\n          <button\r\n            onClick={() => navigate('/family/leaderboard')}\r\n            className=\"p-4 bg-zinc-900 border border-yellow-500/50 rounded-lg hover:bg-zinc-800 transition-colors text-left\"\r\n          >\r\n            <Trophy className=\"w-6 h-6 text-yellow-400 mb-2\" />\r\n            <p className=\"font-semibold\">Family Leaderboard</p>\r\n            <p className=\"text-sm opacity-70\">See top families globally</p>\r\n          </button>\r\n\r\n          <button\r\n            onClick={() => navigate('/family/shop')}\r\n            className=\"p-4 bg-zinc-900 border border-green-500/50 rounded-lg hover:bg-zinc-800 transition-colors text-left\"\r\n          >\r\n            <Award className=\"w-6 h-6 text-green-400 mb-2\" />\r\n            <p className=\"font-semibold\">Family Shop</p>\r\n            <p className=\"text-sm opacity-70\">Unlock exclusive perks</p>\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default FamilyLounge\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyProfilePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyShop.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyWarsHub.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FamilyWarsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Following.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'profile'. Either exclude it or remove the dependency array.","line":53,"column":6,"nodeType":"ArrayExpression","endLine":53,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [targetId]","fix":{"range":[1860,1879],"text":"[targetId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useCallback } from 'react'\r\nimport { Link, useParams } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase, UserProfile } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\n\r\ninterface FollowRow {\r\n  id: string\r\n  follower_id: string\r\n  following_id: string\r\n  created_at: string\r\n  following?: UserProfile\r\n}\r\n\r\nexport default function Following() {\r\n  const { userId } = useParams()\r\n  const { profile } = useAuthStore()\r\n  const [rows, setRows] = useState<FollowRow[]>([])\r\n  const [followers, setFollowers] = useState<FollowRow[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [activeTab, setActiveTab] = useState<'following' | 'followers'>('following')\r\n\r\n  const targetId = userId || profile?.id\r\n  const isOwnProfile = profile?.id === targetId\r\n\r\n  const load = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      if (!targetId) { setLoading(false); return }\r\n      const { data } = await supabase\r\n        .from('user_follows')\r\n        .select('*, following:user_profiles!user_follows_following_id_fkey(*)')\r\n        .eq('follower_id', targetId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(100)\r\n      setRows(data || [])\r\n\r\n      const { data: followerRows } = await supabase\r\n        .from('user_follows')\r\n        .select('*, following:user_profiles!user_follows_follower_id_fkey(*)')\r\n        .eq('following_id', targetId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(100)\r\n      // Remap so we use `following` field to represent the user profile on card\r\n      const mappedFollowers = (followerRows || []).map((r: any) => ({\r\n        ...r,\r\n        following: r.following\r\n      })) as FollowRow[]\r\n      setFollowers(mappedFollowers)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [profile, targetId])\r\n\r\n  useEffect(() => {\r\n    load()\r\n  }, [load])\r\n\r\n  const handleUnfollow = async (id: string, username: string) => {\r\n    if (!confirm(`Are you sure you want to unfollow @${username}?`)) return\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_follows')\r\n        .delete()\r\n        .eq('id', id)\r\n\r\n      if (error) throw error\r\n\r\n      setRows(prev => prev.filter(r => r.id !== id))\r\n      toast.success(`Unfollowed @${username}`)\r\n    } catch (error) {\r\n      console.error('Error unfollowing:', error)\r\n      toast.error('Failed to unfollow user')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-8\">\r\n      <div className=\"max-w-5xl mx-auto\">\r\n        <h1 className=\"text-3xl font-bold bg-gradient-to-r from-cyan-400 via-pink-400 to-purple-400 bg-clip-text text-transparent mb-6\">Followers & Following</h1>\r\n        <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C]\">\r\n          <div className=\"flex gap-2 mb-6\">\r\n            <button\r\n              onClick={() => setActiveTab('following')}\r\n              className={`px-4 py-2 rounded-full text-sm font-medium ${activeTab==='following'?'bg-purple-600 text-white':'bg-[#2C2C2C] text-gray-300 hover:bg-[#3C3C3C]'}`}\r\n            >Following</button>\r\n            <button\r\n              onClick={() => setActiveTab('followers')}\r\n              className={`px-4 py-2 rounded-full text-sm font-medium ${activeTab==='followers'?'bg-purple-600 text-white':'bg-[#2C2C2C] text-gray-300 hover:bg-[#3C3C3C]'}`}\r\n            >Followers</button>\r\n          </div>\r\n          {loading ? (\r\n            <div className=\"text-center py-8\">\r\n              <div className=\"w-16 h-16 bg-[#FFC93C]/20 rounded-full animate-pulse mx-auto mb-4\"></div>\r\n              <div className=\"text-[#FFC93C] font-bold text-xl\">Loading connections...</div>\r\n              <div className=\"text-gray-400 text-sm mt-2\">Please wait while we fetch your following list</div>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {activeTab === 'following' ? (\r\n                rows.length === 0 ? (\r\n                  <div className=\"text-[#E2E2E2]/70\">You are not following anyone yet</div>\r\n                ) : (\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    {rows.map((r) => (\r\n                      <div key={r.id} className=\"flex items-center justify-between p-4 bg-[#121212] rounded-lg border border-[#2C2C2C] hover:border-[#00D4FF] transition-colors\">\r\n                        <Link to={`/profile/${r.following?.username}`} className=\"flex items-center gap-3 flex-1\">\r\n                          <img\r\n                            src={r.following?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${r.following?.username}`}\r\n                            alt={r.following?.username || ''}\r\n                            className=\"w-10 h-10 rounded-full\"\r\n                          />\r\n                          <div>\r\n                            <div className={`font-semibold ${r.following?.rgb_username_expires_at && new Date(r.following.rgb_username_expires_at) > new Date() ? 'rgb-username' : ''}`}>@{r.following?.username}</div>\r\n                            <div className=\"text-xs text-[#E2E2E2]/60\">Followed {new Date(r.created_at).toLocaleDateString()}</div>\r\n                          </div>\r\n                        </Link>\r\n                        {isOwnProfile && (\r\n                          <button\r\n                            onClick={() => handleUnfollow(r.id, r.following?.username || '')}\r\n                            className=\"px-3 py-1 bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 rounded-full text-xs transition-colors\"\r\n                          >\r\n                            Unfollow\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )\r\n              ) : (\r\n                followers.length === 0 ? (\r\n                  <div className=\"text-[#E2E2E2]/70\">No one is following you yet</div>\r\n                ) : (\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    {followers.map((r) => (\r\n                      <Link key={r.id} to={`/profile/${r.following?.username}`} className=\"p-4 bg-[#121212] rounded-lg border border-[#2C2C2C] hover:border-[#00D4FF] transition-colors\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                          <img\r\n                            src={r.following?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${r.following?.username}`}\r\n                            alt={r.following?.username || ''}\r\n                            className=\"w-10 h-10 rounded-full\"\r\n                          />\r\n                          <div>\r\n                            <div className={`font-semibold ${r.following?.rgb_username_expires_at && new Date(r.following.rgb_username_expires_at) > new Date() ? 'rgb-username' : ''}`}>@{r.following?.username}</div>\r\n                            <div className=\"text-xs text-[#E2E2E2]/60\">Followed you {new Date(r.created_at).toLocaleDateString()}</div>\r\n                          </div>\r\n                        </div>\r\n                      </Link>\r\n                    ))}\r\n                  </div>\r\n                )\r\n              )}\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\FoundingOfficerTrial.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GiftCardsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GiftEventOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GiftInventoryPage.jsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":52,"column":53,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1726,1841],"text":"\r\n            Sign in to view the Troll Gift stash you&apos;ve built with Troll Coins for broadcast moments.\r\n          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1726,1841],"text":"\r\n            Sign in to view the Troll Gift stash you&lsquo;ve built with Troll Coins for broadcast moments.\r\n          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1726,1841],"text":"\r\n            Sign in to view the Troll Gift stash you&#39;ve built with Troll Coins for broadcast moments.\r\n          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1726,1841],"text":"\r\n            Sign in to view the Troll Gift stash you&rsquo;ve built with Troll Coins for broadcast moments.\r\n          "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState, useCallback } from 'react'\r\nimport { toast } from 'sonner'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { getUserInventory } from '../lib/giftEngine'\r\nimport { Sparkles, RefreshCw, Gift, ChevronDown, ChevronUp } from 'lucide-react'\r\n\r\nexport default function GiftInventoryPage() {\r\n  const { user } = useAuthStore()\r\n  const [inventory, setInventory] = useState([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [expandedGift, setExpandedGift] = useState(null)\r\n\r\n  const refreshInventory = useCallback(async () => {\r\n    if (!user?.id) return\r\n    setLoading(true)\r\n    try {\r\n      const data = await getUserInventory(user.id)\r\n      setInventory(data)\r\n    } catch (error) {\r\n      console.error('Gift inventory error', error)\r\n      toast.error('Unable to load your Gift Inventory.')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user?.id])\r\n\r\n  useEffect(() => {\r\n    refreshInventory()\r\n  }, [refreshInventory])\r\n\r\n  const totalGifts = useMemo(\r\n    () => inventory.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0),\r\n    [inventory]\r\n  )\r\n\r\n  const totalValue = useMemo(\r\n    () =>\r\n      inventory.reduce(\r\n        (sum, item) => sum + (item.gift?.coinCost || 0) * (Number(item.quantity) || 0),\r\n        0\r\n      ),\r\n    [inventory]\r\n  )\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-[#03030a] to-[#0a0814] text-white px-6\">\r\n        <div className=\"text-center space-y-3 max-w-md\">\r\n          <Gift className=\"w-16 h-16 mx-auto text-yellow-400\" />\r\n          <p className=\"text-2xl font-bold\">Your Troll Gift Vault</p>\r\n          <p className=\"text-gray-400\">\r\n            Sign in to view the Troll Gift stash you've built with Troll Coins for broadcast moments.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#02020a] via-[#040214] to-[#0c0712] text-white px-6 py-10\">\r\n      <div className=\"max-w-5xl mx-auto space-y-6\">\r\n        <header className=\"flex flex-col sm:flex-row items-start justify-between gap-4\">\r\n          <div>\r\n            <div className=\"flex items-center gap-2 text-sm uppercase tracking-[0.5em] text-gray-400\">\r\n              <Sparkles className=\"w-4 h-4 text-yellow-400\" />\r\n              Troll Gift Vault\r\n            </div>\r\n            <div className=\"flex items-center gap-3 mt-2\">\r\n              <Gift className=\"w-10 h-10 text-yellow-300\" />\r\n              <div>\r\n                <h1 className=\"text-4xl font-extrabold tracking-tight\">Gift Inventory</h1>\r\n                <p className=\"text-sm text-gray-400\">\r\n                  {totalGifts.toLocaleString()} gifts ‚Ä¢ {totalValue.toLocaleString()} Troll Coins invested\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            onClick={refreshInventory}\r\n            className=\"flex items-center gap-2 px-4 py-2 rounded-full border border-yellow-500/40 bg-[#0a0813] text-xs uppercase tracking-[0.3em] text-yellow-100 transition hover:border-yellow-300/80\"\r\n          >\r\n            <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />\r\n            Refresh\r\n          </button>\r\n        </header>\r\n\r\n        {loading ? (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {[1, 2, 3, 4, 5, 6].map((item) => (\r\n              <div key={item} className=\"h-48 rounded-3xl border border-yellow-500/20 bg-[#050309]/60 animate-pulse\" />\r\n            ))}\r\n          </div>\r\n        ) : inventory.length === 0 ? (\r\n          <div className=\"rounded-3xl border border-yellow-500/20 bg-[#06030b]/80 p-8 text-center text-gray-300 space-y-3\">\r\n            <p className=\"text-lg font-semibold\">No gifts in the vault yet</p>\r\n            <p className=\"text-sm\">Visit the Troll Gift Store to stock up with Troll Coins-only purchases.</p>\r\n            <p className=\"text-xs uppercase tracking-[0.4em] text-yellow-200\">\r\n              Gifts are added immediately after purchase.\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 gap-5\">\r\n            {inventory.map((slot) => {\r\n              const gift = slot.gift\r\n              const isExpanded = expandedGift === slot.giftSlug\r\n              return (\r\n                <article\r\n                  key={`${slot.giftSlug}-${slot.quantity}`}\r\n                  className=\"rounded-3xl border border-yellow-500/20 bg-gradient-to-br from-[#05030a] to-[#080816] p-5 shadow-[0_0_40px_rgba(255,201,60,0.15)]\"\r\n                >\r\n                  <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center\">\r\n                    {gift?.imageUrl && (\r\n                      <div className=\"h-24 w-24 overflow-hidden rounded-2xl border border-yellow-500/20 shadow-inner\">\r\n                        <img src={gift.imageUrl} alt={gift.name} className=\"h-full w-full object-cover\" />\r\n                      </div>\r\n                    )}\r\n                    <div className=\"flex-1 space-y-2\">\r\n                      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\r\n                        <div>\r\n                          <h3 className=\"text-2xl font-bold\">{gift?.name || slot.giftSlug}</h3>\r\n                          <p className=\"text-xs uppercase tracking-[0.3em] text-gray-400\">\r\n                            {gift?.category || 'Unknown'}\r\n                          </p>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span className=\"px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-200 uppercase tracking-[0.3em]\">\r\n                            x{slot.quantity || 0}\r\n                          </span>\r\n                          <span className=\"px-3 py-1 rounded-full bg-white/10 border border-yellow-500/30 text-yellow-100 text-[10px] uppercase tracking-[0.3em]\">\r\n                            {gift?.tier || 'Unknown Tier'}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-sm text-gray-300 h-20 overflow-hidden\">\r\n                        {gift?.description || 'No description available.'}\r\n                      </p>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => setExpandedGift(isExpanded ? null : slot.giftSlug)}\r\n                      className=\"self-start flex items-center gap-1 text-xs uppercase tracking-[0.3em] text-yellow-200\"\r\n                    >\r\n                      {isExpanded ? 'Hide' : 'View'} details\r\n                      {isExpanded ? <ChevronUp className=\"w-3 h-3\" /> : <ChevronDown className=\"w-3 h-3\" />}\r\n                    </button>\r\n                  </div>\r\n                  <div className=\"mt-3 flex flex-wrap gap-3 text-[11px] text-gray-400\">\r\n                    <span>Value: {gift?.coinCost?.toLocaleString() || '0'} T each</span>\r\n                    <span>Animation: {gift?.animationType || 'none'}</span>\r\n                    <span>Popularity: {gift?.popularityScore ?? '‚Äî'}</span>\r\n                  </div>\r\n                  {isExpanded && (\r\n                    <p className=\"mt-4 text-sm text-gray-300 leading-relaxed\">{gift?.description || 'No description available.'}</p>\r\n                  )}\r\n                </article>\r\n              )\r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GiftSoundPlayer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GiftStorePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GoLive.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'themesLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":36,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'themePurchaseId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":37,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getEligibility' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":142,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":142,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleBuyTheme' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":200,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":200,"endColumn":23},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":775,"column":140,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[30157,30269],"text":"Only the admin can create new broadcasts right now. You can still join and participate in the admin&apos;s broadcast!"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[30157,30269],"text":"Only the admin can create new broadcasts right now. You can still join and participate in the admin&lsquo;s broadcast!"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[30157,30269],"text":"Only the admin can create new broadcasts right now. You can still join and participate in the admin&#39;s broadcast!"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[30157,30269],"text":"Only the admin can create new broadcasts right now. You can still join and participate in the admin&rsquo;s broadcast!"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":791,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click &quot;Go Live Now!\" to start broadcasting.\r\n          "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click &ldquo;Go Live Now!\" to start broadcasting.\r\n          "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click &#34;Go Live Now!\" to start broadcasting.\r\n          "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click &rdquo;Go Live Now!\" to start broadcasting.\r\n          "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":791,"column":67,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click \"Go Live Now!&quot; to start broadcasting.\r\n          "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click \"Go Live Now!&ldquo; to start broadcasting.\r\n          "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click \"Go Live Now!&#34; to start broadcasting.\r\n          "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[30933,31037],"text":"\r\n            Configure your stream settings and click \"Go Live Now!&rdquo; to start broadcasting.\r\n          "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport api, { API_ENDPOINTS } from '../lib/api';\r\nimport { supabase } from '../supabaseClient';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { useCoins } from '../lib/hooks/useCoins';\r\nimport { useBroadcastLockdown } from '../lib/hooks/useBroadcastLockdown';\r\nimport { Video } from 'lucide-react';\r\nimport BroadcastThemePicker from '../components/broadcast/BroadcastThemePicker';\r\nimport { toast } from 'sonner';\r\nimport { useLiveKit } from '../hooks/useLiveKit';\r\nimport { LIVEKIT_URL } from '../lib/LiveKitConfig';\r\nimport { deductCoins } from '../lib/coinTransactions';\r\nimport { sendNotification } from '../lib/sendNotification';\r\n\r\nconst PRIVATE_STREAM_COST = 500;\r\ntype StreamQuality = 'STANDARD' | 'HD_BOOST' | 'HIGHEST';\r\n\r\nconst GoLive: React.FC = () => {\r\n  const { profile, refreshProfile } = useAuthStore(); // Using getState() instead for async operations\r\n  const { refreshCoins } = useCoins();\r\n  const { settings: lockdownSettings } = useBroadcastLockdown();\r\n\r\n  const [streamTitle, setStreamTitle] = useState('');\r\n  const [isStreaming] = useState(false);\r\n  const [isConnecting, setIsConnecting] = useState(false);\r\n  const [category, setCategory] = useState<string>('Chat');\r\n  const [isPrivateStream, setIsPrivateStream] = useState<boolean>(false);\r\n  const [privateStreamPassword, setPrivateStreamPassword] = useState<string>('');\r\n  const [boxPriceAmount, setBoxPriceAmount] = useState<number>(0);\r\n  const [boxPriceType, setBoxPriceType] = useState<'per_minute' | 'flat'>('per_minute');\r\n  const [themes, setThemes] = useState<any[]>([]);\r\n  const [ownedThemeIds, setOwnedThemeIds] = useState<Set<string>>(new Set());\r\n  const [activeThemeId, setActiveThemeId] = useState<string | null>(null);\r\n  const [selectedThemeId, setSelectedThemeId] = useState<string | null>(null);\r\n  const [themesLoading, setThemesLoading] = useState(false);\r\n  const [themePurchaseId, setThemePurchaseId] = useState<string | null>(null);\r\n  const [streamerEntitlements, setStreamerEntitlements] = useState<any>(null);\r\n  const [requestedQuality, setRequestedQuality] = useState<StreamQuality>('HIGHEST');\r\n  const idempotencyKeyRef = useRef<string | null>(null);\r\n\r\n  const navigate = useNavigate();\r\n  const liveKit = useLiveKit();\r\n  const liveRestriction = useMemo(() => {\r\n    if (!profile?.live_restricted_until) {\r\n      return { isRestricted: false, message: '' };\r\n    }\r\n    const until = Date.parse(profile.live_restricted_until);\r\n    if (Number.isNaN(until) || until <= Date.now()) {\r\n      return { isRestricted: false, message: '' };\r\n    }\r\n    return {\r\n      isRestricted: true,\r\n      message: `You cannot go live until ${new Date(until).toLocaleString()}`,\r\n    };\r\n  }, [profile?.live_restricted_until]);\r\n\r\n  const isAdmin = useMemo(() => {\r\n    return profile?.is_admin || profile?.role === 'admin';\r\n  }, [profile?.is_admin, profile?.role]);\r\n\r\n  const isPrivileged = useMemo(() => {\r\n    const role = String(profile?.role || '').toLowerCase();\r\n    if (role.includes('admin') || role.includes('secretary') || role.includes('officer')) return true;\r\n    if (profile?.is_admin || profile?.is_lead_officer || profile?.is_troll_officer) return true;\r\n    return false;\r\n  }, [profile?.role, profile?.is_admin, profile?.is_lead_officer, profile?.is_troll_officer]);\r\n\r\n  // Note: Camera/mic permissions will be requested when joining seats in broadcast\r\n  // No camera preview needed in setup\r\n\r\n\r\n\r\n  // Note: All camera/mic functionality moved to seat joining in broadcast page\r\n \r\n  useEffect(() => {\r\n    const loadThemes = async () => {\r\n      const { user } = useAuthStore.getState();\r\n      if (!user?.id) return;\r\n      setThemesLoading(true);\r\n      try {\r\n        const { data: catalog } = await supabase\r\n          .from('broadcast_background_themes')\r\n          .select('*')\r\n          .eq('is_active', true)\r\n          .order('sort_order', { ascending: true });\r\n\r\n        const { data: owned } = await supabase\r\n          .from('user_broadcast_theme_purchases')\r\n          .select('theme_id')\r\n          .eq('user_id', user.id);\r\n\r\n        const { data: state } = await supabase\r\n          .from('user_broadcast_theme_state')\r\n          .select('active_theme_id')\r\n          .eq('user_id', user.id)\r\n          .maybeSingle();\r\n\r\n        const { data: entitlements } = await supabase\r\n          .from('user_streamer_entitlements')\r\n          .select('*')\r\n          .eq('user_id', user.id)\r\n          .maybeSingle();\r\n\r\n        setThemes(catalog || []);\r\n        setOwnedThemeIds(new Set((owned || []).map((row: any) => row.theme_id)));\r\n        setActiveThemeId(state?.active_theme_id || null);\r\n        setStreamerEntitlements(entitlements || null);\r\n        setSelectedThemeId(state?.active_theme_id || null);\r\n      } catch (err) {\r\n        console.error('Failed to load broadcast themes', err);\r\n      } finally {\r\n        setThemesLoading(false);\r\n      }\r\n    };\r\n\r\n    loadThemes();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (selectedThemeId === null && activeThemeId) {\r\n      setSelectedThemeId(activeThemeId);\r\n    }\r\n  }, [activeThemeId, selectedThemeId]);\r\n\r\n  useEffect(() => {\r\n    if (!isPrivateStream) {\r\n      setPrivateStreamPassword('');\r\n    }\r\n  }, [isPrivateStream]);\r\n\r\n  const formatCountdown = (targetDate?: string | null) => {\r\n    if (!targetDate) return null;\r\n    const diff = new Date(targetDate).getTime() - Date.now();\r\n    if (diff <= 0) return '0h';\r\n    const totalMinutes = Math.floor(diff / 60000);\r\n    const days = Math.floor(totalMinutes / 1440);\r\n    const hours = Math.floor((totalMinutes % 1440) / 60);\r\n    return days > 0 ? `${days}d ${hours}h` : `${hours}h`;\r\n  };\r\n\r\n  const getEligibility = (theme: any) => {\r\n    const now = Date.now();\r\n    const startsAt = theme?.starts_at ? new Date(theme.starts_at).getTime() : null;\r\n    const endsAt = theme?.ends_at ? new Date(theme.ends_at).getTime() : null;\r\n    const limitedActive = !theme?.is_limited || ((startsAt ? now >= startsAt : true) && (endsAt ? now <= endsAt : true));\r\n    const seasonalState = theme?.is_limited\r\n      ? startsAt && now < startsAt\r\n        ? `Starts in ${formatCountdown(theme.starts_at)}`\r\n        : endsAt && now > endsAt\r\n          ? 'Season ended'\r\n          : endsAt\r\n            ? `Ends in ${formatCountdown(theme.ends_at)}`\r\n            : null\r\n      : null;\r\n\r\n    const entitlements = streamerEntitlements || {};\r\n    const streamLevel = entitlements.streamer_level ?? profile?.level ?? 0;\r\n    const followersCount = entitlements.followers_count ?? 0;\r\n    const hoursStreamed = entitlements.total_hours_streamed ?? 0;\r\n    const minLevel = theme?.min_stream_level ?? null;\r\n    const minFollowers = theme?.min_followers ?? null;\r\n    const minHours = theme?.min_total_hours_streamed ?? null;\r\n    const requiresStreamer = Boolean(theme?.is_streamer_exclusive || minLevel || minFollowers || minHours);\r\n    const meetsStreamer =\r\n      (!minLevel || streamLevel >= minLevel) &&\r\n      (!minFollowers || followersCount >= minFollowers) &&\r\n      (!minHours || hoursStreamed >= minHours);\r\n\r\n    return {\r\n      limitedActive,\r\n      seasonalState,\r\n      requiresStreamer,\r\n      meetsStreamer,\r\n      isEligible: limitedActive && (!requiresStreamer || meetsStreamer),\r\n      minLevel,\r\n      minFollowers,\r\n      minHours,\r\n    };\r\n  };\r\n\r\n  const handleSelectTheme = async (themeId: string | null) => {\r\n    const { user } = useAuthStore.getState();\r\n    if (!user?.id) return;\r\n    try {\r\n      const { data, error } = await supabase.rpc('set_active_broadcast_theme', {\r\n        p_user_id: user.id,\r\n        p_theme_id: themeId\r\n      });\r\n      if (error || data?.success === false) {\r\n        throw new Error(data?.error || error?.message || 'Failed to set theme');\r\n      }\r\n      setActiveThemeId(themeId);\r\n    } catch (err: any) {\r\n      console.error('Theme selection failed', err);\r\n      toast.error(err?.message || 'Failed to set theme');\r\n    }\r\n  };\r\n\r\n  const handleBuyTheme = async (themeId: string) => {\r\n    const { user } = useAuthStore.getState();\r\n    if (!user?.id) return;\r\n    setThemePurchaseId(themeId);\r\n    try {\r\n      const { data, error } = await supabase.rpc('purchase_broadcast_theme', {\r\n        p_theme_id: themeId,\r\n        p_set_active: true\r\n      });\r\n      if (error || data?.success === false) {\r\n        throw new Error(data?.error || error?.message || 'Purchase failed');\r\n      }\r\n      setOwnedThemeIds((prev) => new Set([...Array.from(prev), themeId]));\r\n      setActiveThemeId(themeId);\r\n      if (refreshCoins) {\r\n        await refreshCoins();\r\n      }\r\n      if (refreshProfile) {\r\n        await refreshProfile();\r\n      }\r\n      toast.success('Theme purchased and applied');\r\n    } catch (err: any) {\r\n      console.error('Theme purchase failed', err);\r\n      toast.error(err?.message || 'Unable to purchase theme');\r\n    } finally {\r\n      setThemePurchaseId(null);\r\n    }\r\n  };\r\n\r\n  // -------------------------------\r\n  // START STREAM\r\n  // -------------------------------\r\n  const handleStartStream = async (manualBattleData?: { battleId: string, opponent: any }) => {\r\n    const { profile, user } = useAuthStore.getState();\r\n    // Battle data is now handled within the broadcast view\r\n    const effectiveBattleData = manualBattleData; \r\n\r\n    if (category === 'Troll Battles' && !effectiveBattleData) {\r\n      toast.error('You must find an opponent first!');\r\n      return;\r\n    }\r\n\r\n    if (!user || !profile) {\r\n      toast.error('You must be logged in.');\r\n      return;\r\n    }\r\n\r\n    if (!profile.full_name) {\r\n      toast.error('Please complete your profile (add your full name) before going live.');\r\n      return;\r\n    }\r\n\r\n    if (liveRestriction.isRestricted) {\r\n      toast.error(liveRestriction.message);\r\n      return;\r\n    }\r\n\r\n    // Check broadcast lockdown - only admin can broadcast when enabled\r\n    if (lockdownSettings.enabled && !isAdmin) {\r\n      toast.error('üî¥ Broadcasts are currently locked. Only the admin can broadcast right now. Try again later or join the admin\\'s broadcast!');\r\n      return;\r\n    }\r\n\r\n    // Backend enforcement: double-check with database RPC\r\n    try {\r\n      const { data: canBroadcast, error: broadcastError } = await supabase.rpc('can_start_broadcast');\r\n      if (broadcastError) {\r\n        console.warn('Could not verify broadcast permission with backend:', broadcastError);\r\n        // Fall back to frontend check only if RPC fails\r\n      } else if (!canBroadcast) {\r\n        toast.error('üî¥ Broadcasts are currently locked by admin. Please try again later.');\r\n        return;\r\n      }\r\n    } catch (rpcError) {\r\n      console.warn('RPC call failed, using frontend check only:', rpcError);\r\n    }\r\n\r\n    const availableCoins = Number(profile.troll_coins || 0);\r\n    if (!isPrivileged && availableCoins < 500) {\r\n      toast.error('You need at least 500 coins to go live. Go make friends and gain more followers to go live.');\r\n      return;\r\n    }\r\n\r\n    // All users are now approved to broadcast - no restrictions\r\n    // if (!profile.is_broadcaster) {\r\n    //   toast.error('üö´ You must be an approved broadcaster to go live.');\r\n    //   return;\r\n    // }\r\n\r\n    // Immediate Go Live flow requires camera/mic and LiveKit connection before navigation\r\n\r\n    if (!streamTitle.trim()) {\r\n      toast.error('Enter a stream title.');\r\n      return;\r\n    }\r\n\r\n    // Check for Private Stream cost\r\n    if (isPrivateStream) {\r\n      if (!privateStreamPassword.trim()) {\r\n        toast.error('Set a password for the private stream so viewers can join');\r\n        return;\r\n      }\r\n      const userLevel = profile.level || 0;\r\n      if (userLevel < 40) {\r\n        // Need to pay 1000 coins\r\n        const currentCoins = profile.troll_coins || 0;\r\n        const COST = PRIVATE_STREAM_COST;\r\n        \r\n        if (currentCoins < COST) {\r\n           toast.error(`Private streams cost ${COST} troll_coins. You only have ${currentCoins}.`);\r\n           return;\r\n        }\r\n\r\n        // Deduct coins\r\n        try {\r\n          const deduction = await deductCoins({\r\n            userId: user.id,\r\n            amount: COST,\r\n            type: 'perk_purchase', \r\n            description: 'Private Stream Setup Fee',\r\n            supabaseClient: supabase\r\n          });\r\n\r\n          if (!deduction.success) {\r\n            toast.error('Failed to deduct coins for private stream: ' + (deduction.error || 'Unknown error'));\r\n            return;\r\n          }\r\n        } catch (err: any) {\r\n          console.error('Error deducting coins:', err);\r\n          toast.error('Failed to process private stream fee.');\r\n          return;\r\n        }\r\n      }\r\n    }\r\n\r\n    setIsConnecting(true);\r\n    \r\n    // Reset connecting state on function exit to prevent getting stuck\r\n    const cleanup = () => {\r\n      try {\r\n        setIsConnecting(false);\r\n      } catch {}\r\n    };\r\n\r\n    let sessionId: string | null = null;\r\n    let publishConfig: any = null;\r\n    let livekitToken: string | null = null;\r\n    let hdPaid = false;\r\n\r\n    try {\r\n      const idempotencyKey = idempotencyKeyRef.current || crypto.randomUUID();\r\n      idempotencyKeyRef.current = idempotencyKey;\r\n\r\n      const prepareResponse = await api.request(API_ENDPOINTS.stream.prepare, {\r\n        method: 'POST',\r\n        body: JSON.stringify({\r\n          requestedQuality,\r\n          idempotencyKey,\r\n        })\r\n      });\r\n\r\n      if (!prepareResponse.success || prepareResponse.error) {\r\n        const errorCode = prepareResponse.error || prepareResponse.message;\r\n        console.error('[GoLive] prepare-session error:', errorCode);\r\n        \r\n        if (errorCode?.includes('No active session') || errorCode?.includes('authenticat')) {\r\n          toast.error('Authentication error: Your session may have expired. Please try again.');\r\n          cleanup();\r\n          return;\r\n        }\r\n\r\n        throw new Error(errorCode || 'Failed to prepare session');\r\n      }\r\n\r\n      sessionId = prepareResponse.sessionId;\r\n      publishConfig = prepareResponse.publishConfig;\r\n      livekitToken = prepareResponse.livekitToken;\r\n      // Support both top-level and nested response shapes\r\n      hdPaid = Boolean((prepareResponse as any).hdPaid ?? (prepareResponse as any)?.data?.hdPaid);\r\n      setRequestedQuality('HIGHEST');\r\n\r\n      const streamId = sessionId;\r\n      const roomName = sessionId; // Use sessionId as LiveKit room name\r\n\r\n      // 1. Request camera and microphone access FIRST (preflight stream)\r\n      // This ensures we don't create a stream entry if the user denies permissions\r\n      let preflightStream: MediaStream | null = null;\r\n      try {\r\n        const capture = publishConfig?.captureConstraints || {\r\n          width: { ideal: 1280, max: 1920 },\r\n          height: { ideal: 720, max: 1080 },\r\n          frameRate: { ideal: 30 },\r\n          facingMode: 'user'\r\n        };\r\n        preflightStream = await navigator.mediaDevices.getUserMedia({\r\n          video: capture,\r\n          audio: {\r\n            echoCancellation: true,\r\n            noiseSuppression: true,\r\n            autoGainControl: true\r\n          }\r\n        });\r\n        console.log('[GoLive] ‚úÖ Camera & mic granted');\r\n      } catch (permErr: any) {\r\n        console.error('[GoLive] Camera/mic permission failed:', permErr);\r\n        toast.error('Camera/microphone access denied. Please allow permissions.');\r\n        if (hdPaid && sessionId) {\r\n          await api.request(API_ENDPOINTS.stream.refundHDBoost, {\r\n            method: 'POST',\r\n            body: JSON.stringify({ sessionId, reason: 'permission_denied' })\r\n          });\r\n        }\r\n        cleanup();\r\n        return;\r\n      }\r\n\r\n      // Optimized stream creation with retry logic and better error handling\r\n      console.log('[GoLive] Starting optimized stream creation...', { streamId, broadcasterId: profile.id });\r\n\r\n      // Session verification: prefer cached session from auth store, fall back to Supabase\r\n      let sessionAccessToken: string | null = useAuthStore.getState().session?.access_token ?? null;\r\n      let sessionError: any = null;\r\n\r\n      if (!sessionAccessToken) {\r\n        const { data, error } = await supabase.auth.getSession();\r\n        sessionAccessToken = data?.session?.access_token ?? null;\r\n        sessionError = error;\r\n      }\r\n\r\n      if (sessionError || !sessionAccessToken) {\r\n        console.error('[GoLive] Session verification failed:', sessionError);\r\n        toast.error('Session expired. Please sign in again.');\r\n        preflightStream?.getTracks().forEach(t => t.stop());\r\n        cleanup();\r\n        return;\r\n      }\r\n      console.log('[GoLive] Session verified');\r\n\r\n      // Prepare stream data\r\n      // IMPORTANT: Set is_live to FALSE initially so it doesn't show up on homepage\r\n      // until we have successfully connected to LiveKit\r\n      const streamData = {\r\n        id: streamId,\r\n        broadcaster_id: profile.id,\r\n        title: streamTitle,\r\n        category: category,\r\n        is_live: false, // Hidden initially\r\n        status: 'preparing', // Status preparing\r\n        is_private: isPrivateStream,\r\n        box_price_amount: boxPriceAmount,\r\n        box_price_type: boxPriceType,\r\n        start_time: new Date().toISOString(),\r\n        thumbnail_url: null,\r\n        current_viewers: 0,\r\n        total_gifts_coins: 0,\r\n        total_unique_gifters: 0,\r\n        popularity: 0,\r\n        room_name: roomName,\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString()\r\n      };\r\n\r\n      // Optimized stream creation with better error handling\r\n      console.log('[GoLive] Attempting stream creation with optimized timeout...');\r\n      \r\n      let insertResult: any = null;\r\n      let lastError: any = null;\r\n      \r\n      try {\r\n        const insertOperation = supabase\r\n          .from('streams')\r\n          .insert(streamData)\r\n          .select()\r\n          .single();\r\n\r\n        // Use enhanced timeout - increased for database operations\r\n        insertResult = await Promise.race([\r\n          insertOperation,\r\n          new Promise<never>((_, reject) => \r\n            setTimeout(() => reject(new Error('Stream creation timed out')), 25000)\r\n          )\r\n        ]);\r\n        \r\n        if (insertResult.error) {\r\n          throw insertResult.error;\r\n        }\r\n        \r\n        console.log('[GoLive] Stream created successfully (preparing state)');\r\n        \r\n      } catch (err: any) {\r\n        console.error('[GoLive] Stream creation failed:', err);\r\n        lastError = err;\r\n      }\r\n      \r\n      if (!insertResult || insertResult.error) {\r\n        console.error('[GoLive] All insert attempts failed:', { lastError, insertResult });\r\n        \r\n        let errorMessage = 'Failed to create stream.';\r\n        if (lastError?.code === '23505') {\r\n          errorMessage = 'Stream ID conflict. Please try again.';\r\n        } else if (lastError?.message?.includes('permission')) {\r\n          errorMessage = 'Permission denied: You may not have broadcaster privileges.';\r\n        } else if (lastError?.message?.includes('timeout')) {\r\n          errorMessage = 'Stream creation timed out. Please check your connection and try again.';\r\n        } else if (lastError?.message) {\r\n          errorMessage = `Database error: ${lastError.message}`;\r\n        }\r\n        \r\n        toast.error(errorMessage);\r\n        preflightStream?.getTracks().forEach(t => t.stop());\r\n        cleanup();\r\n        return;\r\n      }\r\n\r\n      const insertedStream = insertResult.data;\r\n      const createdId = insertedStream?.id;\r\n      \r\n      if (!createdId) {\r\n        console.error('[GoLive] Stream insert did not return an id');\r\n        toast.error('Failed to create stream (no ID returned).');\r\n        preflightStream?.getTracks().forEach(t => t.stop());\r\n        cleanup();\r\n        return;\r\n      }\r\n      \r\n      if (isPrivateStream) {\r\n        try {\r\n          const trimmedPassword = privateStreamPassword.trim();\r\n          const { error: passwordError } = await supabase.rpc('set_stream_password', {\r\n            p_stream_id: createdId,\r\n            p_password: trimmedPassword,\r\n          });\r\n          if (passwordError) {\r\n            throw passwordError;\r\n          }\r\n          if (typeof window !== 'undefined' && trimmedPassword) {\r\n            localStorage.setItem(`private-stream-password:${createdId}`, trimmedPassword);\r\n          }\r\n\r\n          try {\r\n            const { data: following, error: followingError } = await supabase\r\n              .from('user_follows')\r\n              .select('following_id')\r\n              .eq('follower_id', user.id);\r\n\r\n            if (followingError) {\r\n              throw followingError;\r\n            }\r\n\r\n            const targets = (following || []).map((row: any) => row.following_id).filter(Boolean);\r\n\r\n            for (const targetId of targets) {\r\n              await sendNotification(\r\n                targetId,\r\n                'stream_live',\r\n                'Private Stream Invite',\r\n                `${profile.username} started a private stream. Password: ${trimmedPassword}`,\r\n                {\r\n                  stream_id: createdId,\r\n                  is_private: true,\r\n                  password: trimmedPassword,\r\n                  broadcaster_id: user.id,\r\n                  broadcaster_username: profile.username,\r\n                }\r\n              );\r\n            }\r\n          } catch (notifyErr) {\r\n            console.error('[GoLive] Failed to send private stream notifications:', notifyErr);\r\n          }\r\n        } catch (passwordErr: any) {\r\n          console.error('[GoLive] Failed to set private stream password:', passwordErr);\r\n          toast.error('Failed to enable the private password. Please try again.');\r\n          preflightStream?.getTracks().forEach(t => t.stop());\r\n          await supabase.from('streams').delete().eq('id', createdId);\r\n          cleanup();\r\n          return;\r\n        }\r\n      }\r\n      \r\n      console.log('[GoLive] Stream created successfully:', createdId);\r\n\r\n      // OPTIMIZATION: Connect immediately so user is live when they land on the page\r\n      console.log('[GoLive] üöÄ Starting LiveKit connection (pre-navigation)...');\r\n      let isConnectedNow = false;\r\n\r\n      try {\r\n        const tracks = preflightStream ? preflightStream.getTracks() : [];\r\n        const videoTrack = tracks.find(t => t.kind === 'video');\r\n        const audioTrack = tracks.find(t => t.kind === 'audio');\r\n\r\n        // Connect using the same service instance that LivePage will use\r\n        const connectedService: any = await liveKit.connect(\r\n          roomName,\r\n          {\r\n            id: user.id,\r\n            identity: profile.username || user.id,\r\n            name: profile.full_name || profile.username,\r\n          },\r\n          {\r\n            tokenOverride: livekitToken || undefined,\r\n            url: LIVEKIT_URL,\r\n            allowPublish: true,\r\n            autoPublish: false, // Manual publish to use existing tracks\r\n            preflightStream: preflightStream || undefined\r\n          }\r\n        );\r\n\r\n        if (connectedService) {\r\n          console.log('[GoLive] Connected. Publishing tracks...');\r\n          \r\n          // Publish video\r\n          if (videoTrack) {\r\n             if (connectedService.publishVideoTrack) {\r\n               await connectedService.publishVideoTrack(videoTrack);\r\n             } else {\r\n               console.warn('[GoLive] Service missing publishVideoTrack');\r\n             }\r\n          }\r\n\r\n          // Publish audio\r\n          if (audioTrack) {\r\n             if (connectedService.publishAudioTrack) {\r\n               await connectedService.publishAudioTrack(audioTrack);\r\n             } else {\r\n               console.warn('[GoLive] Service missing publishAudioTrack');\r\n             }\r\n          }\r\n          console.log('[GoLive] ‚úÖ Connected and published!');\r\n          isConnectedNow = true;\r\n          \r\n          // Update stream to live immediately (non-blocking)\r\n          Promise.resolve(supabase\r\n            .from('streams')\r\n            .update({ \r\n              is_live: true, \r\n              status: 'live' \r\n            })\r\n            .eq('id', createdId))\r\n            .then(() => {\r\n              console.log('[GoLive] Stream marked live');\r\n              // Notify followers\r\n              supabase.functions.invoke('send-push-notification', {\r\n                body: {\r\n                  broadcast_followers_id: profile.id,\r\n                  title: 'Live Stream',\r\n                  body: `${profile.username} is live! ${streamTitle}`,\r\n                  url: `/broadcast/${createdId}`,\r\n                  create_db_notification: true,\r\n                  type: 'stream_live'\r\n                }\r\n              }).catch(err => console.warn('Broadcast push failed', err));\r\n            })\r\n            .catch(err => console.error('[GoLive] Failed to mark stream live:', err));\r\n        }\r\n      } catch (err) {\r\n        console.error('[GoLive] Pre-connection failed (will retry on LivePage):', err);\r\n        // Do not return, allow navigation to proceed so LivePage can try\r\n      }\r\n      \r\n      // If not connected yet, update stream to starting status\r\n      // Fire and forget (don't await) to speed up navigation\r\n      if (!isConnectedNow) {\r\n        supabase\r\n          .from('streams')\r\n          .update({ \r\n            is_live: false, \r\n            status: 'starting' \r\n          })\r\n          .eq('id', createdId)\r\n          .then(() => console.log('[GoLive] Stream status updated (background)'));\r\n      }\r\n\r\n      if (sessionId) {\r\n        // Fire and forget\r\n        api.request(API_ENDPOINTS.stream.markLive, {\r\n          method: 'POST',\r\n          body: JSON.stringify({ sessionId, status: isConnectedNow ? 'live' : 'starting', streamId: createdId })\r\n        });\r\n      }\r\n\r\n      // Navigate immediately without waiting for database updates\r\n      console.log('[GoLive] ‚úÖ preparing immediate navigation');\r\n      \r\n      // ‚úÖ Pass stream data directly via navigation state to avoid database query\r\n      // This eliminates replication delay issues\r\n      const streamDataForNavigation = {\r\n        id: insertedStream.id,\r\n        broadcaster_id: insertedStream.broadcaster_id || profile.id,\r\n        title: insertedStream.title || streamTitle,\r\n        category: insertedStream.category || category,\r\n        status: isConnectedNow ? 'live' : 'starting',\r\n        is_live: isConnectedNow,\r\n        start_time: insertedStream.start_time || new Date().toISOString(),\r\n        current_viewers: insertedStream.current_viewers || 0,\r\n        total_gifts_coins: insertedStream.total_gifts_coins || 0,\r\n        total_unique_gifters: insertedStream.total_unique_gifters || 0,\r\n        thumbnail_url: insertedStream.thumbnail_url || null,\r\n        created_at: insertedStream.created_at || new Date().toISOString(),\r\n        updated_at: insertedStream.updated_at || new Date().toISOString(),\r\n        livekit_room_name: roomName,\r\n      };\r\n      \r\n      try {\r\n        navigate(`/live/${createdId}`, { \r\n          state: { \r\n            streamData: streamDataForNavigation, \r\n            isBroadcaster: true, \r\n            roomName,\r\n            battle: effectiveBattleData\r\n          } \r\n        });\r\n        console.log('[GoLive] ‚úÖ Navigation called successfully - already publishing');\r\n        toast.success('You are live!');\r\n      } catch (navErr: any) {\r\n        console.error('[GoLive] ‚ùå Navigation error', navErr);\r\n        toast.error('Stream created but navigation failed. Please navigate manually.');\r\n        cleanup();\r\n        // Don't return here, let it fall through to finally block\r\n      }\r\n    } catch (err: any) {\r\n      if (hdPaid && sessionId) {\r\n        try {\r\n          await api.request(API_ENDPOINTS.stream.refundHDBoost, {\r\n            method: 'POST',\r\n            body: JSON.stringify({ sessionId, reason: 'start_stream_failed' })\r\n          });\r\n        } catch {}\r\n      }\r\n      console.error('[GoLive] Error starting stream:', {\r\n        error: err,\r\n        message: err?.message,\r\n        stack: err?.stack,\r\n        name: err?.name,\r\n        cause: err?.cause\r\n      });\r\n      \r\n      // Provide specific error messages based on error type\r\n      if (err?.message === 'timeout') {\r\n        toast.error('Stream creation timed out. This usually takes 10-30 seconds on slower connections. Please try again.');\r\n      } else if (err?.message?.includes('fetch')) {\r\n        toast.error('Network connection issue. Please check your internet connection and try again.');\r\n      } else if (err?.message?.includes('permission') || err?.message?.includes('unauthorized')) {\r\n        toast.error('Permission denied: You may not have the required broadcaster privileges.');\r\n      } else if (err?.message?.includes('JWT')) {\r\n        toast.error('Authentication error: Please log out and log back in.');\r\n      } else if (err?.message) {\r\n        toast.error(`Stream startup failed: ${err.message}`);\r\n      } else {\r\n        toast.error('Error starting stream. Please try again.');\r\n      }\r\n    } finally {\r\n      cleanup();\r\n    }\r\n  };\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n  return (\r\n    <div className=\"max-w-6xl mx-auto space-y-6 go-live-wrapper bg-gradient-to-br from-[#1a003a] via-[#0fffc1] to-[#1a003a] p-1 rounded-2xl shadow-[0_0_32px_4px_rgba(0,255,255,0.15)]\">\r\n\r\n      <h1 className=\"text-4xl font-extrabold flex items-center gap-3 neon-text drop-shadow-[0_0_8px_#0fffc1]\" style={{textShadow:'0 0 16px #0fffc1, 0 0 32px #ff00ea'}}>\r\n        <Video className=\"w-10 h-10 text-[#0fffc1] animate-pulse drop-shadow-[0_0_8px_#0fffc1]\" />\r\n        <span className=\"bg-gradient-to-r from-[#0fffc1] via-[#ff00ea] to-[#00b3ff] bg-clip-text text-transparent\">Go Live</span>\r\n      </h1>\r\n      \r\n      {/* Broadcast Lockdown Alert */}\r\n      {lockdownSettings.enabled && (\r\n        <div className=\"rounded-lg border border-red-500/50 bg-red-500/10 px-4 py-3 text-red-200 flex items-start gap-3\">\r\n          <span className=\"text-lg\">üî¥</span>\r\n          <div>\r\n            <p className=\"font-semibold\">Broadcast Lockdown Active</p>\r\n            <p className=\"text-sm mt-1\">Only the admin can create new broadcasts right now. You can still join and participate in the admin's broadcast!</p>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {liveRestriction.isRestricted && (\r\n        <div className=\"rounded-lg border border-red-500/50 bg-red-500/10 px-4 py-2 text-sm text-red-200\">\r\n          {liveRestriction.message}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"bg-gradient-to-br from-purple-900/20 to-blue-900/20 rounded-xl p-8 border border-purple-700/30\">\r\n        <div className=\"text-center text-gray-300\">\r\n          <Video className=\"w-16 h-16 mx-auto mb-3 text-purple-400\" />\r\n          <h3 className=\"text-lg font-semibold text-white mb-2\">Ready to Go Live!</h3>\r\n          <p className=\"text-sm text-gray-300 max-w-sm mx-auto\">\r\n            Configure your stream settings and click \"Go Live Now!\" to start broadcasting.\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {!isStreaming ? (\r\n        <div className=\"bg-[#0E0A1A] border border-purple-700/40 p-6 rounded-xl space-y-6\">\r\n          <div>\r\n            <label className=\"text-gray-300\">Stream Title *</label>\r\n            <input\r\n              value={streamTitle}\r\n              onChange={(e) => setStreamTitle(e.target.value)}\r\n              className=\"w-full bg-[#0e0020] border-2 border-[#0fffc1]/60 focus:border-[#ff00ea] text-white rounded-lg px-4 py-3 neon-input focus:shadow-[0_0_8px_#0fffc1]\"\r\n              placeholder=\"Enter your stream title...\"\r\n              style={{boxShadow:'0 0 8px #0fffc1'}}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"text-gray-300\">Category *</label>\r\n              <select\r\n                value={category}\r\n                onChange={(e) => setCategory(e.target.value)}\r\n                className=\"w-full bg-[#0e0020] border-2 border-[#ff00ea]/60 focus:border-[#0fffc1] text-white rounded-lg px-4 py-3 neon-input\"\r\n                style={{boxShadow:'0 0 8px #ff00ea'}}\r\n              >\r\n                <option>Chat</option>\r\n                <option>Gaming</option>\r\n                <option>Music</option>\r\n                <option>IRL</option>\r\n                <option>Officer</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div className=\"flex flex-col gap-3\">\r\n              <label className=\"text-gray-300\">Options</label>\r\n              <div className=\"flex items-center gap-3\">\r\n                <input id=\"private\" type=\"checkbox\" checked={isPrivateStream} onChange={() => setIsPrivateStream((v) => !v)} />\r\n                <label htmlFor=\"private\" className=\"text-sm text-gray-300\">\r\n                  Private Stream \r\n                  {/* Level 40+ bypass logic would be checked here for display, but logic is in start stream */}\r\n                  {(profile?.level || 0) >= 40 ? (\r\n                    <span className=\"text-xs text-green-400 ml-2\">(Free for Lvl 40+)</span>\r\n                  ) : (\r\n                    <span className=\"text-xs text-purple-300 ml-2\">({PRIVATE_STREAM_COST.toLocaleString()} troll coins)</span>\r\n                  )}\r\n                </label>\r\n              </div>\r\n              {isPrivateStream && (\r\n                <div className=\"space-y-1 mt-2\">\r\n                  <label className=\"text-xs uppercase tracking-[0.3em] text-[#0fffc1] drop-shadow-[0_0_4px_#0fffc1]\">\r\n                    Invite Password\r\n                  </label>\r\n                  <input\r\n                    type=\"password\"\r\n                    value={privateStreamPassword}\r\n                    onChange={(e) => setPrivateStreamPassword(e.target.value)}\r\n                    placeholder=\"Enter a password for invited viewers\"\r\n                    className=\"w-full bg-[#0e0020] border-2 border-[#ff00ea]/60 focus:border-[#0fffc1] rounded-lg px-3 py-2 text-sm text-white neon-input focus:shadow-[0_0_8px_#ff00ea]\"\r\n                  />\r\n                  <p className=\"text-xs text-[#bafffa]\">\r\n                    Only users with this password can watch.\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"flex flex-col gap-3\">\r\n              <label className=\"text-gray-300\">Guest Box Pricing</label>\r\n              <div className=\"grid grid-cols-2 gap-2\">\r\n                <div>\r\n                  <label className=\"text-xs text-gray-400 mb-1 block\">Pricing Type</label>\r\n                  <select\r\n                    value={boxPriceType}\r\n                    onChange={(e) => setBoxPriceType(e.target.value as 'per_minute' | 'flat')}\r\n                    className=\"w-full bg-[#0e0020] border-2 border-[#0fffc1]/60 focus:border-[#ff00ea] text-white rounded-lg px-3 py-2 text-sm neon-input\"\r\n                  >\r\n                    <option value=\"per_minute\">Coins Per Minute</option>\r\n                    <option value=\"flat\">Flat Fee (One-time)</option>\r\n                  </select>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-xs text-gray-400 mb-1 block\">Price (Coins)</label>\r\n                  <input\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    value={boxPriceAmount}\r\n                    onChange={(e) => setBoxPriceAmount(Math.max(0, parseInt(e.target.value) || 0))}\r\n                    className=\"w-full bg-[#0e0020] border-2 border-[#ff00ea]/60 focus:border-[#0fffc1] text-white rounded-lg px-3 py-2 text-sm neon-input\"\r\n                  />\r\n                </div>\r\n              </div>\r\n              <p className=\"text-xs text-gray-500\">\r\n                {boxPriceAmount === 0 \r\n                  ? \"Guests can join boxes for free.\" \r\n                  : boxPriceType === 'per_minute' \r\n                    ? `Guests pay ${boxPriceAmount} coins every minute they are in a box.`\r\n                    : `Guests pay ${boxPriceAmount} coins once to join a box.`}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"text-gray-300\">Stream Quality</label>\r\n            <div className=\"mt-2 rounded-lg border-2 border-[#0fffc1]/60 bg-[#0fffc1]/10 px-4 py-3 text-sm text-[#0fffc1] shadow-[0_0_8px_#0fffc1]\">\r\n              <span className=\"font-bold text-[#ff00ea]\">HD streaming</span> is enabled for everyone by default. No boosts or upgrades needed.\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"text-gray-300\">Broadcast Background</label>\r\n            <div className=\"mt-2 space-y-4\">\r\n              <div className=\"rounded-xl border border-purple-700/30 bg-[#0b091f] p-4 space-y-3\">\r\n                <div className=\"text-sm font-semibold text-white mb-2\">Select a theme</div>\r\n                <BroadcastThemePicker\r\n                  themes={themes}\r\n                  selected={selectedThemeId}\r\n                  onSelect={(id) => setSelectedThemeId(id)}\r\n                  ownedThemeIds={ownedThemeIds}\r\n                />\r\n                <div className=\"mt-2 flex gap-2\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => handleSelectTheme(selectedThemeId)}\r\n                    className={`flex-1 text-xs px-3 py-2 rounded border border-cyan-400/80 text-cyan-200`}\r\n                    disabled={!selectedThemeId}\r\n                  >\r\n                    Use Selected Theme\r\n                  </button>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => handleSelectTheme(null)}\r\n                    className={`flex-1 text-xs px-3 py-2 rounded border border-white/10 text-white/60`}\r\n                  >\r\n                    Use Default\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex flex-col gap-4\">\r\n              <button\r\n                onClick={() => handleStartStream()}\r\n                disabled={\r\n                  isConnecting ||\r\n                  !streamTitle.trim() ||\r\n                  liveRestriction.isRestricted ||\r\n                  (lockdownSettings.enabled && !isAdmin)\r\n                }\r\n                className=\"flex-1 py-3 rounded-lg bg-gradient-to-r from-[#0fffc1] via-[#ff00ea] to-[#00b3ff] text-white font-extrabold neon-btn shadow-[0_0_16px_4px_rgba(0,255,255,0.25)] hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed w-full\"\r\n                style={{textShadow:'0 0 8px #0fffc1, 0 0 16px #ff00ea'}}\r\n              >\r\n                {isConnecting ? (\r\n                  <span className=\"flex items-center justify-center gap-2\">\r\n                    <div className=\"w-4 h-4 border-2 border-[#0fffc1]/30 border-t-[#ff00ea] rounded-full animate-spin\"></div>\r\n                    <div className=\"text-left\">\r\n                      <div>Creating Stream...</div>\r\n                      <div className=\"text-xs opacity-75\">This may take 10-30 seconds</div>\r\n                    </div>\r\n                  </span>\r\n                ) : (\r\n                  <span className=\"drop-shadow-[0_0_8px_#0fffc1]\">Go Live Now!</span>\r\n                )}\r\n              </button>\r\n            </div>\r\n          </div>\r\n      ) : (\r\n        <div className=\"p-6 text-gray-300\">Redirecting to stream‚Ä¶</div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GoLive;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\GoLiveSetup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Home.old.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Home.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TopBroadcastersGrid' is defined but never used. Allowed unused vars must match /^_/u.","line":20,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":27,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"TopBroadcastersGrid"},"fix":{"range":[496,563],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'adminStream' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":117,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":117,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import BroadcastLockdownControl from './admin/components/BroadcastLockdownControl';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useAuthStore } from '@/lib/store';\r\nimport { useEffect, useState } from 'react';\r\nimport { subscribeToNtfyGlobal } from '../lib/ntfySubscribe';\r\nimport { \r\n  Gamepad2, \r\n  Users, \r\n  ShoppingCart, \r\n  Video, \r\n  Coins,\r\n  Shield,\r\n  Zap,\r\n  Star,\r\n  ArrowRight,\r\n  Play,\r\n  Sparkles\r\n} from 'lucide-react';\r\nimport { supabase } from '../lib/supabase';\r\nimport TopBroadcastersGrid from '@/components/TopBroadcastersGrid';\r\nimport HomeLiveGrid from '@/components/HomeLiveGrid';\r\n\r\n// Animated gradient background\r\nconst AnimatedGradient = () => {\r\n  return (\r\n    <div className=\"absolute inset-0 overflow-hidden\">\r\n      <div className=\"absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 animate-gradient-shift\" />\r\n      <div className=\"absolute inset-0 bg-[radial-gradient(120%_120%_at_20%_20%,rgba(147,51,234,0.18),transparent)]\" />\r\n      <div className=\"absolute inset-0 bg-[radial-gradient(140%_140%_at_80%_0%,rgba(45,212,191,0.14),transparent)]\" />\r\n      <div className=\"absolute inset-0 bg-[radial-gradient(140%_140%_at_90%_90%,rgba(236,72,153,0.12),transparent)]\" />\r\n      <div className=\"absolute inset-0 bg-[linear-gradient(120deg,rgba(109,40,217,0.08)_0%,rgba(14,165,233,0.06)_40%,rgba(236,72,153,0.08)_100%)]\" />\r\n      <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_50%_20%,rgba(255,255,255,0.06),transparent_35%)] mix-blend-screen\" />\r\n      <style>\r\n        {`\r\n          @keyframes gradient-shift {\r\n            0%, 100% { opacity: 1; }\r\n            50% { opacity: 0.85; }\r\n          }\r\n          .animate-gradient-shift {\r\n            animation: gradient-shift 12s ease-in-out infinite;\r\n          }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Floating particles effect\r\nconst FloatingParticles = () => {\r\n  return (\r\n    <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\r\n      {Array.from({ length: 20 }).map((_, i) => (\r\n        <div\r\n          key={i}\r\n          className=\"absolute w-1 h-1 bg-cyan-400/40 rounded-full shadow-[0_0_12px_rgba(34,211,238,0.35)]\"\r\n          style={{\r\n            left: `${Math.random() * 100}%`,\r\n            top: `${Math.random() * 100}%`,\r\n            animation: `float-particle ${5 + Math.random() * 10}s ease-in-out infinite`,\r\n            animationDelay: `${Math.random() * 5}s`,\r\n          }}\r\n        />\r\n      ))}\r\n      <style>\r\n        {`\r\n          @keyframes float-particle {\r\n            0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0; }\r\n            10% { opacity: 0.6; }\r\n            90% { opacity: 0.6; }\r\n            50% { transform: translateY(-100px) translateX(50px); }\r\n          }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Feature card component\r\ninterface FeatureCardProps {\r\n  icon: React.ReactNode;\r\n  title: string;\r\n  description: string;\r\n  gradient: string;\r\n  delay: number;\r\n}\r\n\r\nconst FeatureCard = ({ icon, title, description, gradient, delay }: FeatureCardProps) => {\r\n  return (\r\n    <div \r\n      className=\"group relative p-6 bg-slate-900/50 backdrop-blur-md rounded-2xl border border-purple-500/20 hover:border-cyan-400/50 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-cyan-500/20 animate-fade-in-up\"\r\n      style={{ animationDelay: `${delay}ms` }}\r\n    >\r\n      <div className={`absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl bg-gradient-to-br ${gradient} blur-xl`} />\r\n      <div className=\"relative z-10\">\r\n        <div className=\"mb-4 p-3 bg-gradient-to-br from-purple-600/20 to-cyan-600/20 rounded-xl w-fit group-hover:scale-110 transition-transform duration-300\">\r\n          {icon}\r\n        </div>\r\n        <h3 className=\"text-xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent\">\r\n          {title}\r\n        </h3>\r\n        <p className=\"text-slate-300 text-sm leading-relaxed\">\r\n          {description}\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Stats component - Replaced by TopBroadcasters component with real-time database data\r\nconst _StatsSection = () => {\r\n  return null;\r\n};\r\n\r\nexport default function Home() {\r\n  const navigate = useNavigate();\r\n  const user = useAuthStore((state) => state.user);\r\n  const [adminStream, setAdminStream] = useState<{ id: string; title: string | null; username: string | null } | null>(null);\r\n\r\n  // Auto-scroll to top and subscribe to push notifications on page load\r\n  useEffect(() => {\r\n    window.scrollTo(0, 0);\r\n    subscribeToNtfyGlobal();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    let isMounted = true;\r\n\r\n    const loadAdminBroadcast = async () => {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('streams')\r\n          .select('id, title, is_live, status, user_profiles!broadcaster_id ( username, role, is_admin )')\r\n          .eq('is_live', true)\r\n          .eq('status', 'live')\r\n          .order('created_at', { ascending: false })\r\n          .limit(20);\r\n\r\n        if (error || !isMounted) {\r\n          return;\r\n        }\r\n\r\n        const rows = (data || []) as any[];\r\n        let selected: { id: string; title: string | null; username: string | null } | null = null;\r\n\r\n        for (const row of rows) {\r\n          const profile = Array.isArray(row.user_profiles) ? row.user_profiles[0] : row.user_profiles;\r\n          if (!profile) continue;\r\n          const role = profile.role || '';\r\n          const isAdmin = !!profile.is_admin || role === 'admin';\r\n          if (isAdmin) {\r\n            selected = {\r\n              id: row.id,\r\n              title: row.title || null,\r\n              username: profile.username || null,\r\n            };\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (!isMounted) {\r\n          return;\r\n        }\r\n\r\n        setAdminStream(selected);\r\n      } catch {\r\n        if (!isMounted) {\r\n          return;\r\n        }\r\n        setAdminStream(null);\r\n      }\r\n    };\r\n\r\n    loadAdminBroadcast();\r\n\r\n    const channel = supabase\r\n      .channel('home-admin-streams')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'streams' },\r\n        () => {\r\n          loadAdminBroadcast();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      isMounted = false;\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, []);\r\n\r\n  const features = [\r\n    {\r\n      icon: <Video className=\"w-8 h-8 text-purple-400\" />,\r\n      title: \"Live Streaming\",\r\n      description: \"Go live and connect with your audience in real-time. Stream games, music, or just hang out with friends.\",\r\n      gradient: \"from-purple-600/20 to-pink-600/20\",\r\n    },\r\n    {\r\n      icon: <Users className=\"w-8 h-8 text-cyan-400\" />,\r\n      title: \"Join Families\",\r\n      description: \"Create or join families to build your community. Compete for top rankings and exclusive rewards.\",\r\n      gradient: \"from-cyan-600/20 to-blue-600/20\",\r\n    },\r\n    {\r\n      icon: <ShoppingCart className=\"w-8 h-8 text-pink-400\" />,\r\n      title: \"Troll Mart\",\r\n      description: \"Shop for exclusive items, apartments, and customizations. Build your virtual empire in Troll City.\",\r\n      gradient: \"from-pink-600/20 to-purple-600/20\",\r\n    },\r\n    {\r\n      icon: <Gamepad2 className=\"w-8 h-8 text-purple-400\" />,\r\n      title: \"Troll Family Battles\",\r\n      description: \"Compete in Troll Family Battles! Join or create a family, challenge others, and climb the leaderboard.\",\r\n      gradient: \"from-purple-600/20 to-cyan-600/20\",\r\n    },\r\n    {\r\n      icon: <Coins className=\"w-8 h-8 text-yellow-400\" />,\r\n      title: \"Daily Login Posts\",\r\n      description: \"Post once daily to the Troll City Wall and earn 0-100 random Troll Coins. Come back every day for rewards!\",\r\n      gradient: \"from-yellow-600/20 to-cyan-600/20\",\r\n    },\r\n    {\r\n      icon: <Shield className=\"w-8 h-8 text-cyan-400\" />,\r\n      title: \"Safe Community\",\r\n      description: \"Moderated community with family-friendly content. Report features and active moderation team.\",\r\n      gradient: \"from-cyan-600/20 to-teal-600/20\",\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"relative min-h-dvh overflow-hidden bg-slate-950\">\r\n      {/* Animated Background */}\r\n      <AnimatedGradient />\r\n      <FloatingParticles />\r\n\r\n      {/* Content */}\r\n      <div className=\"relative z-10 min-h-dvh flex flex-col\">\r\n        \r\n        {/* Hero Section */}\r\n        <section className=\"flex-1 flex items-center px-4 py-20 safe-top\">\r\n          <div className=\"max-w-7xl mx-auto w-full grid lg:grid-cols-1 gap-10 items-center\">\r\n            {/* Main Heading */}\r\n            <div className=\"space-y-8 text-center animate-fade-in\">\r\n              <div className=\"space-y-4\">\r\n                <h1 className=\"text-5xl md:text-6xl xl:text-7xl font-black leading-tight bg-gradient-to-r from-purple-300 via-pink-300 to-cyan-300 bg-clip-text text-transparent animate-gradient-text drop-shadow-[0_10px_40px_rgba(124,58,237,0.35)]\">\r\n                  Welcome to Troll City\r\n                </h1>\r\n                <p className=\"text-xl md:text-2xl text-slate-200\">\r\n                  Stream, Play, Connect & Earn in the Ultimate Online Community\r\n                </p>\r\n                <p className=\"text-lg text-slate-400\">\r\n                  Join thousands of creators and viewers in Troll City - where live streaming meets gaming, shopping, and social connection.\r\n                </p>\r\n              </div>\r\n\r\n              {/* CTA Buttons */}\r\n              <div className=\"flex flex-wrap gap-4 items-center animate-fade-in-up\" style={{ animationDelay: '180ms' }}>\r\n                {!user ? (\r\n                  <>\r\n                    <button\r\n                      onClick={() => navigate('/signup')}\r\n                      className=\"group relative px-8 py-4 rounded-2xl font-semibold text-lg text-white bg-gradient-to-r from-purple-600 via-pink-600 to-cyan-500 shadow-[0_10px_40px_rgba(124,58,237,0.35)] hover:shadow-[0_15px_50px_rgba(56,189,248,0.35)] transition-all duration-300 hover:-translate-y-0.5 flex items-center gap-2\"\r\n                    >\r\n                      <Sparkles className=\"w-5 h-5\" />\r\n                      Join Troll City\r\n                      <ArrowRight className=\"w-5 h-5 group-hover:translate-x-1 transition-transform\" />\r\n                      <span className=\"absolute inset-0 rounded-2xl bg-gradient-to-r from-purple-600/0 via-white/6 to-cyan-500/0 opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => navigate('/login')}\r\n                      className=\"px-8 py-4 rounded-2xl font-semibold text-lg text-slate-50 bg-slate-900/60 backdrop-blur-xl border border-white/10 hover:border-cyan-400/40 hover:bg-slate-800/70 transition-all duration-300 hover:-translate-y-0.5 shadow-[0_10px_30px_rgba(0,0,0,0.35)]\"\r\n                    >\r\n                      Sign In\r\n                    </button>\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <button\r\n                      onClick={() => navigate('/go-live')}\r\n                      className=\"group relative px-8 py-4 rounded-2xl font-semibold text-lg text-white bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 shadow-[0_10px_40px_rgba(236,72,153,0.4)] hover:shadow-[0_15px_50px_rgba(251,146,60,0.35)] transition-all duration-300 hover:-translate-y-0.5 flex items-center gap-2\"\r\n                    >\r\n                      <Play className=\"w-5 h-5\" />\r\n                      Go Live Now\r\n                      <ArrowRight className=\"w-5 h-5 group-hover:translate-x-1 transition-transform\" />\r\n                      <span className=\"absolute inset-0 rounded-2xl bg-gradient-to-r from-purple-600/0 via-white/8 to-orange-500/0 opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => navigate('/explore')}\r\n                      className=\"px-8 py-4 rounded-2xl font-semibold text-lg text-slate-50 bg-slate-900/60 backdrop-blur-xl border border-white/10 hover:border-cyan-400/40 hover:bg-slate-800/70 transition-all duration-300 hover:-translate-y-0.5 shadow-[0_10px_30px_rgba(0,0,0,0.35)]\"\r\n                    >\r\n                      Explore Feed\r\n                    </button>\r\n                  </>\r\n                )}\r\n              </div>\r\n\r\n              {/* Quick Features Preview */}\r\n              <div className=\"flex flex-wrap gap-3 text-sm text-slate-300 animate-fade-in-up\" style={{ animationDelay: '320ms' }}>\r\n                <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 backdrop-blur-sm rounded-full border border-white/10 shadow-[0_8px_25px_rgba(59,130,246,0.15)]\">\r\n                  <Zap className=\"w-4 h-4 text-yellow-300\" />\r\n                  Free to Join\r\n                </div>\r\n                <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 backdrop-blur-sm rounded-full border border-white/10 shadow-[0_8px_25px_rgba(56,189,248,0.15)]\">\r\n                  <Star className=\"w-4 h-4 text-cyan-300\" />\r\n                  Earn Rewards\r\n                </div>\r\n                <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 backdrop-blur-sm rounded-full border border-white/10 shadow-[0_8px_25px_rgba(168,85,247,0.15)]\">\r\n                  <Shield className=\"w-4 h-4 text-purple-300\" />\r\n                  Safe & Moderated\r\n                </div>\r\n              </div>\r\n\r\n              {/* Admin-only Broadcast Lockdown Control */}\r\n              {user?.role === 'admin' && (\r\n                <div className=\"mt-8 max-w-xl mx-auto animate-fade-in-up\" style={{ animationDelay: '380ms' }}>\r\n                  <BroadcastLockdownControl />\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Live Broadcasters Grid */}\r\n            <div className=\"w-full animate-fade-in-up\" style={{ animationDelay: '240ms' }}>\r\n              <div className=\"text-center mb-8\">\r\n                <h2 className=\"text-3xl md:text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent\">\r\n                  üî¥ Live Now\r\n                </h2>\r\n                <p className=\"text-slate-400\">\r\n                  Join the action in Troll City\r\n                </p>\r\n              </div>\r\n              <HomeLiveGrid />\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Features Section */}\r\n        <section className=\"px-4 py-20\">\r\n          <div className=\"max-w-6xl mx-auto\">\r\n            <div className=\"text-center mb-16\">\r\n              <h2 className=\"text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent\">\r\n                Everything You Need\r\n              </h2>\r\n              <p className=\"text-xl text-slate-400\">\r\n                A complete platform for creators and community members\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n              {features.map((feature, index) => (\r\n                <FeatureCard\r\n                  key={index}\r\n                  {...feature}\r\n                  delay={index * 100}\r\n                />\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Footer safe area */}\r\n        <div className=\"safe-bottom\" />\r\n      </div>\r\n\r\n      {/* Animations */}\r\n      <style>\r\n        {`\r\n          @keyframes fade-in {\r\n            from { opacity: 0; transform: translateY(-20px); }\r\n            to { opacity: 1; transform: translateY(0); }\r\n          }\r\n          \r\n          @keyframes fade-in-up {\r\n            from { opacity: 0; transform: translateY(30px); }\r\n            to { opacity: 1; transform: translateY(0); }\r\n          }\r\n          \r\n          @keyframes gradient-text {\r\n            0%, 100% { background-position: 0% 50%; }\r\n            50% { background-position: 100% 50%; }\r\n          }\r\n          \r\n          .animate-fade-in {\r\n            animation: fade-in 1s ease-out forwards;\r\n          }\r\n          \r\n          .animate-fade-in-up {\r\n            animation: fade-in-up 0.8s ease-out forwards;\r\n            opacity: 0;\r\n          }\r\n          \r\n          .animate-gradient-text {\r\n            background-size: 200% auto;\r\n            animation: gradient-text 3s ease-in-out infinite;\r\n          }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\InterviewRoom.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'avatarSeed' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":61,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'videoRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'videoRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":74,"column":56,"nodeType":"Identifier","endLine":74,"endColumn":63}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { useParams, useNavigate } from 'react-router-dom'\r\nimport { Room, RoomEvent } from 'livekit-client'\r\nimport { toast } from 'sonner'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { \r\n  Mic, MicOff, Video, VideoOff, Phone, MessageSquare, \r\n  Users, Clock, CheckCircle, XCircle, Briefcase, Shield\r\n} from 'lucide-react'\r\n\r\n// Interview session type\r\ninterface InterviewSession {\r\n  id: string\r\n  application_id: string\r\n  user_id: string\r\n  interviewer_id: string\r\n  scheduled_at: string\r\n  status: 'active' | 'completed' | 'hired' | 'rejected'\r\n  notes: string\r\n  applicant_name: string\r\n  applicant_username: string\r\n}\r\n\r\n// Fake avatar images for test mode\r\nconst fakeAvatars = [\r\n  'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',\r\n  'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka',\r\n  'https://api.dicebear.com/7.x/avataaars/svg?seed=Bob',\r\n  'https://api.dicebear.com/7.x/avataaars/svg?seed=Charlie',\r\n  'https://api.dicebear.com/7.x/avataaars/svg?seed=Diana',\r\n]\r\n\r\nfunction getFakeAvatar(seed: string): string {\r\n  // Use deterministic seed to pick avatar\r\n  let hash = 0\r\n  for (let i = 0; i < seed.length; i++) {\r\n    hash = ((hash << 5) - hash) + seed.charCodeAt(i)\r\n    hash = hash & hash\r\n  }\r\n  return fakeAvatars[Math.abs(hash) % fakeAvatars.length]\r\n}\r\n\r\n// Broadcast box component for showing video\r\nfunction BroadcastBox({ \r\n  participant, \r\n  label, \r\n  isMuted, \r\n  isVideoOff,\r\n  isInterviewer,\r\n  useFakeAvatar = false // Enable fake avatar for test mode\r\n}: { \r\n  participant?: any\r\n  label: string\r\n  isMuted?: boolean\r\n  isVideoOff?: boolean\r\n  isInterviewer?: boolean\r\n  useFakeAvatar?: boolean\r\n}) {\r\n  const videoRef = useRef<HTMLVideoElement>(null)\r\n  const [avatarSeed] = useState(() => Math.random().toString(36).substring(7))\r\n\r\n  useEffect(() => {\r\n    if (participant?.videoTrack?.track && videoRef.current && !useFakeAvatar) {\r\n      try {\r\n        participant.videoTrack.track.attach(videoRef.current)\r\n      } catch (e) {\r\n        console.warn('Video attach failed:', e)\r\n      }\r\n    }\r\n    return () => {\r\n      if (participant?.videoTrack?.track && videoRef.current) {\r\n        try {\r\n          participant.videoTrack.track.detach(videoRef.current)\r\n        } catch (e) {\r\n          console.warn('Video detach failed:', e)\r\n        }\r\n      }\r\n    }\r\n  }, [participant, useFakeAvatar])\r\n\r\n  const fakeAvatarUrl = getFakeAvatar(label)\r\n\r\n  return (\r\n    <div \r\n      className={`relative bg-gray-900 rounded-xl overflow-hidden border-2 ${\r\n        isInterviewer ? 'border-purple-500' : 'border-cyan-500'\r\n      }`}\r\n    >\r\n      {/* Fake avatar mode - always show avatar */}\r\n      {useFakeAvatar ? (\r\n        <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-800 to-gray-900 relative\">\r\n          {/* Animated avatar background */}\r\n          <div className=\"absolute inset-0 bg-gradient-to-br from-purple-900/50 to-cyan-900/50 animate-pulse\" />\r\n          \r\n          {/* Avatar image */}\r\n          <div className=\"relative z-10 text-center\">\r\n            <div className=\"w-32 h-32 rounded-full bg-gray-800 p-2 mx-auto mb-4 shadow-2xl\">\r\n              <img \r\n                src={fakeAvatarUrl} \r\n                alt={label}\r\n                className=\"w-full h-full rounded-full\"\r\n              />\r\n            </div>\r\n            <p className=\"text-white font-bold text-xl\">{label}</p>\r\n            <p className=\"text-cyan-400 text-sm mt-1\">üé≠ Test Mode</p>\r\n          </div>\r\n          \r\n          {/* Recording indicator */}\r\n          <div className=\"absolute top-4 left-4 flex items-center gap-2 bg-red-500/80 px-3 py-1 rounded-full\">\r\n            <div className=\"w-2 h-2 bg-white rounded-full animate-pulse\" />\r\n            <span className=\"text-white text-xs font-medium\">REC</span>\r\n          </div>\r\n        </div>\r\n      ) : !isVideoOff && participant ? (\r\n        <video \r\n          ref={videoRef}\r\n          className=\"w-full h-full object-cover\"\r\n          playsInline\r\n          autoPlay\r\n          muted={!isInterviewer}\r\n        />\r\n      ) : (\r\n        <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-800 to-gray-900\">\r\n          <div className=\"text-center\">\r\n            <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 ${\r\n              isInterviewer ? 'bg-purple-500/20' : 'bg-cyan-500/20'\r\n            }`}>\r\n              <Users className={`w-10 h-10 ${isInterviewer ? 'text-purple-400' : 'text-cyan-400'}`} />\r\n            </div>\r\n            <p className=\"text-white font-medium\">{label}</p>\r\n            <p className=\"text-gray-400 text-sm\">Camera Off</p>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"absolute bottom-2 left-2 bg-black/60 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-2\">\r\n        {isInterviewer ? <Shield className=\"w-4 h-4 text-purple-400\" /> : <Briefcase className=\"w-4 h-4 text-cyan-400\" />}\r\n        <span>{label}</span>\r\n      </div>\r\n\r\n      <div className=\"absolute top-2 right-2 flex gap-2\">\r\n        {isMuted && (\r\n          <div className=\"bg-red-500/80 p-1.5 rounded-full\">\r\n            <MicOff className=\"w-4 h-4 text-white\" />\r\n          </div>\r\n        )}\r\n        {isVideoOff && (\r\n          <div className=\"bg-red-500/80 p-1.5 rounded-full\">\r\n            <VideoOff className=\"w-4 h-4 text-white\" />\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default function InterviewRoom() {\r\n  const { sessionId } = useParams<{ sessionId: string }>()\r\n  const navigate = useNavigate()\r\n  const { profile, user } = useAuthStore()\r\n  \r\n  const [session, setSession] = useState<InterviewSession | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [connecting, setConnecting] = useState(false)\r\n  const [room, setRoom] = useState<Room | null>(null)\r\n  const [token, setToken] = useState<string | null>(null)\r\n  const [isMuted, setIsMuted] = useState(false)\r\n  const [isVideoOff, setIsVideoOff] = useState(false)\r\n  const [elapsedTime, setElapsedTime] = useState(0)\r\n  const [showNotes, setShowNotes] = useState(false)\r\n  const [notes, setNotes] = useState('')\r\n  const [hiring, setHiring] = useState(false)\r\n  const [testMode, setTestMode] = useState(false) // Fake avatar mode for testing\r\n\r\n  const roomRef = useRef<Room | null>(null)\r\n\r\n  const isAdminOrLead = profile?.role === 'admin' || profile?.role === 'lead_troll_officer'\r\n\r\n  useEffect(() => {\r\n    const fetchSession = async () => {\r\n      if (!sessionId) {\r\n        toast.error('Invalid session ID')\r\n        navigate('/career')\r\n        return\r\n      }\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('interview_sessions')\r\n          .select('*')\r\n          .eq('id', sessionId)\r\n          .single()\r\n\r\n        if (error) throw error\r\n\r\n        // Get user profile separately\r\n        const { data: profile } = await supabase\r\n          .from('user_profiles')\r\n          .select('username, full_name')\r\n          .eq('id', data.user_id)\r\n          .single()\r\n\r\n        const applicantName = profile?.full_name || profile?.username || 'Applicant'\r\n        setSession({ ...data, applicant_name: applicantName })\r\n        setNotes(data.notes || '')\r\n      } catch (error) {\r\n        console.error('Error fetching session:', error)\r\n        toast.error('Failed to load interview session')\r\n        navigate('/career')\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n\r\n    fetchSession()\r\n  }, [sessionId, navigate])\r\n\r\n  useEffect(() => {\r\n    const getToken = async () => {\r\n      if (!session || !user) return\r\n\r\n      try {\r\n        const livekitUrl = import.meta.env.VITE_LIVEKIT_URL\r\n        const functionsUrl = import.meta.env.VITE_EDGE_FUNCTIONS_URL ||\r\n          'https://yjxpwfalenorzrqxwmtr.supabase.co/functions/v1'\r\n\r\n        if (!livekitUrl) {\r\n          console.error('VITE_LIVEKIT_URL environment variable is not set')\r\n          toast.error('LiveKit server URL not configured')\r\n          return\r\n        }\r\n\r\n        // Validate LiveKit URL\r\n        try {\r\n          new URL(livekitUrl)\r\n        } catch {\r\n          console.error('Invalid VITE_LIVEKIT_URL:', livekitUrl)\r\n          toast.error('Invalid LiveKit server URL configuration')\r\n          return\r\n        }\r\n\r\n        const { data: sessionData } = await supabase.auth.getSession()\r\n        const response = await fetch(`${functionsUrl}/livekit-token`, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': `Bearer ${sessionData?.session?.access_token}`\r\n          },\r\n          body: JSON.stringify({\r\n            room: `interview-${sessionId}`,\r\n            identity: profile?.username || user.id,\r\n            allowPublish: true,\r\n          })\r\n        })\r\n\r\n        if (!response.ok) {\r\n          const errorText = await response.text()\r\n          console.error('LiveKit token response:', response.status, errorText)\r\n          throw new Error(`Failed to get token: ${response.status}`)\r\n        }\r\n\r\n        const data = await response.json()\r\n        if (!data.token) {\r\n          console.error('No token in response:', data)\r\n          throw new Error('Invalid token response')\r\n        }\r\n\r\n        setToken(data.token)\r\n      } catch (error) {\r\n        console.error('Error getting LiveKit token:', error)\r\n        toast.error('Failed to connect to interview room')\r\n      }\r\n    }\r\n\r\n    getToken()\r\n  }, [session, user, profile, sessionId])\r\n\r\n  const connectToRoom = useCallback(async () => {\r\n    if (!token || !session) {\r\n      toast.error('Invalid room connection parameters')\r\n      return\r\n    }\r\n\r\n    // Validate token is a proper URL\r\n    let serverUrl: string\r\n    try {\r\n      // Handle token format: could be full URL or just token string\r\n      if (token.includes('?')) {\r\n        serverUrl = token.split('?')[0]\r\n      } else {\r\n        // Assume token is just the token string, use default LiveKit URL\r\n        serverUrl = import.meta.env.VITE_LIVEKIT_URL || 'wss://your-livekit-server.livekit.cloud'\r\n      }\r\n\r\n      // Validate the server URL\r\n      new URL(serverUrl)\r\n    } catch (urlError) {\r\n      console.error('Invalid URL:', urlError)\r\n      toast.error('Invalid server URL configuration')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setConnecting(true)\r\n      const newRoom = new Room({\r\n        adaptiveStream: true,\r\n        dynacast: true,\r\n      })\r\n\r\n      newRoom.on(RoomEvent.ConnectionStateChanged, (state) => {\r\n        if (state === 'connected') {\r\n          toast.success('Connected to interview room')\r\n          setRoom(newRoom)\r\n          roomRef.current = newRoom\r\n        } else if (state === 'disconnected') {\r\n          toast.info('Disconnected from interview room')\r\n          setRoom(null)\r\n          roomRef.current = null\r\n        }\r\n      })\r\n\r\n      await newRoom.connect(serverUrl, token)\r\n      roomRef.current = newRoom\r\n      setRoom(newRoom)\r\n\r\n      await supabase\r\n        .from('interview_sessions')\r\n        .update({ status: 'active' })\r\n        .eq('id', session.id)\r\n\r\n      setSession(prev => prev ? { ...prev, status: 'active' } : null)\r\n\r\n    } catch (error) {\r\n      console.error('Error connecting to room:', error)\r\n      toast.error('Failed to connect to interview room')\r\n    } finally {\r\n      setConnecting(false)\r\n    }\r\n  }, [token, session])\r\n\r\n  useEffect(() => {\r\n    if (session?.status === 'active') {\r\n      const interval = setInterval(() => {\r\n        setElapsedTime(prev => prev + 1)\r\n      }, 1000)\r\n      return () => clearInterval(interval)\r\n    }\r\n  }, [session?.status])\r\n\r\n  const toggleMute = async () => {\r\n    if (room) {\r\n      await room.localParticipant.setMicrophoneEnabled(isMuted)\r\n      setIsMuted(!isMuted)\r\n    }\r\n  }\r\n\r\n  const toggleVideo = async () => {\r\n    if (room) {\r\n      await room.localParticipant.setCameraEnabled(isVideoOff)\r\n      setIsVideoOff(!isVideoOff)\r\n    }\r\n  }\r\n\r\n  const endCall = async () => {\r\n    if (room) {\r\n      room.disconnect()\r\n      setRoom(null)\r\n      roomRef.current = null\r\n    }\r\n    \r\n    if (session) {\r\n      await supabase\r\n        .from('interview_sessions')\r\n        .update({ status: 'completed', notes })\r\n        .eq('id', session.id)\r\n    }\r\n    \r\n    toast.success('Interview ended')\r\n    navigate('/career')\r\n  }\r\n\r\n  const hireCandidate = async () => {\r\n    if (!session || !isAdminOrLead) return\r\n\r\n    try {\r\n      setHiring(true)\r\n      \r\n      await supabase\r\n        .from('applications')\r\n        .update({ status: 'approved', reviewed_at: new Date().toISOString() })\r\n        .eq('id', session.application_id)\r\n\r\n      const { data: application } = await supabase\r\n        .from('applications')\r\n        .select('type')\r\n        .eq('id', session.application_id)\r\n        .single()\r\n\r\n      if (application) {\r\n        const newRole = application.type === 'troll_officer' ? 'troll_officer' : \r\n                       application.type === 'lead_officer' ? 'lead_troll_officer' : \r\n                       application.type === 'pastor' ? 'pastor' : 'troller'\r\n\r\n        await supabase\r\n          .from('user_profiles')\r\n          .update({ role: newRole })\r\n          .eq('id', session.user_id)\r\n      }\r\n\r\n      await supabase\r\n        .from('interview_sessions')\r\n        .update({ status: 'completed', notes: notes + '\\n\\n‚úÖ HIRED' })\r\n        .eq('id', session.id)\r\n\r\n      toast.success(`${session.applicant_name} has been hired!`)\r\n      navigate('/admin/applications')\r\n    } catch (error) {\r\n      console.error('Error hiring candidate:', error)\r\n      toast.error('Failed to hire candidate')\r\n    } finally {\r\n      setHiring(false)\r\n    }\r\n  }\r\n\r\n  const formatTime = (seconds: number) => {\r\n    const hrs = Math.floor(seconds / 3600)\r\n    const mins = Math.floor((seconds % 3600) / 60)\r\n    const secs = seconds % 60\r\n    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-400\">Loading interview session...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!session) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <XCircle className=\"w-16 h-16 text-red-400 mx-auto mb-4\" />\r\n          <h1 className=\"text-2xl font-bold text-white mb-2\">Session Not Found</h1>\r\n          <p className=\"text-gray-400 mb-4\">This interview session does not exist.</p>\r\n          <button\r\n            onClick={() => navigate('/career')}\r\n            className=\"px-6 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-colors\"\r\n          >\r\n            Go to Career Page\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] relative overflow-hidden\">\r\n      <div className=\"absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/80 to-transparent p-4\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <button\r\n              onClick={() => navigate('/career')}\r\n              className=\"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors\"\r\n            >\r\n              <XCircle className=\"w-5 h-5 text-white\" />\r\n            </button>\r\n            <div>\r\n              <h1 className=\"text-xl font-bold text-white\">Interview Room</h1>\r\n              <p className=\"text-gray-400 text-sm\">{session.applicant_name}</p>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-lg\">\r\n              <Clock className=\"w-4 h-4 text-cyan-400\" />\r\n              <span className=\"text-white font-mono\">{formatTime(elapsedTime)}</span>\r\n            </div>\r\n\r\n            <div className={`px-3 py-1.5 rounded-lg text-sm font-medium ${\r\n              session.status === 'active' ? 'bg-green-500/20 text-green-400' :\r\n              'bg-gray-500/20 text-gray-400'\r\n            }`}>\r\n              {session.status === 'active' ? 'Live Interview' : 'Completed'}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"absolute inset-0 pt-20 pb-24\">\r\n        {!token ? (\r\n          <div className=\"h-full flex items-center justify-center\">\r\n            <div className=\"text-center\">\r\n              <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto mb-4\"></div>\r\n              <p className=\"text-gray-400\">Connecting to interview room...</p>\r\n            </div>\r\n          </div>\r\n        ) : !room ? (\r\n          <div className=\"h-full flex items-center justify-center\">\r\n            <div className=\"text-center max-w-md\">\r\n              <div className=\"w-24 h-24 rounded-full bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center mx-auto mb-6\">\r\n                <Users className=\"w-12 h-12 text-white\" />\r\n              </div>\r\n              <h2 className=\"text-2xl font-bold text-white mb-2\">Ready to Start Interview</h2>\r\n              <p className=\"text-gray-400 mb-6\">\r\n                You are about to interview <strong>{session.applicant_name}</strong>.\r\n              </p>\r\n              \r\n              <button\r\n                onClick={connectToRoom}\r\n                disabled={connecting}\r\n                className=\"px-8 py-3 bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-lg font-bold hover:shadow-lg hover:shadow-cyan-500/30 disabled:opacity-50 transition-all\"\r\n              >\r\n                {connecting ? 'Connecting...' : 'Join Interview Room'}\r\n              </button>\r\n              \r\n              {/* Test Mode Toggle */}\r\n              {isAdminOrLead && (\r\n                <button\r\n                  onClick={() => setTestMode(!testMode)}\r\n                  className={`mt-4 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${\r\n                    testMode \r\n                      ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/50' \r\n                      : 'bg-gray-500/20 text-gray-400 border border-gray-500/50'\r\n                  }`}\r\n                >\r\n                  {testMode ? 'üé≠ Test Mode ON' : 'üé≠ Enable Test Mode'}\r\n                </button>\r\n              )}\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"absolute inset-0 p-4\">\r\n            <div className=\"grid grid-cols-2 gap-4 h-full\">\r\n              <BroadcastBox \r\n                participant={isAdminOrLead ? room.localParticipant : Array.from(room.remoteParticipants.values())[0]}\r\n                label={isAdminOrLead ? (profile?.username || 'Interviewer') : 'Interviewer'}\r\n                isInterviewer={true}\r\n                useFakeAvatar={testMode && !isAdminOrLead}\r\n              />\r\n              <BroadcastBox \r\n                participant={isAdminOrLead ? Array.from(room.remoteParticipants.values())[0] : room.localParticipant}\r\n                label={session.applicant_name}\r\n                isInterviewer={false}\r\n                useFakeAvatar={testMode && isAdminOrLead}\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"absolute bottom-0 left-0 right-0 z-20 bg-gradient-to-t from-black/80 to-transparent p-4\">\r\n        <div className=\"flex items-center justify-center gap-4\">\r\n          <button\r\n            onClick={toggleMute}\r\n            className={`p-4 rounded-full transition-colors ${\r\n              isMuted ? 'bg-red-500 hover:bg-red-600' : 'bg-white/10 hover:bg-white/20'\r\n            }`}\r\n          >\r\n            {isMuted ? <MicOff className=\"w-6 h-6 text-white\" /> : <Mic className=\"w-6 h-6 text-white\" />}\r\n          </button>\r\n\r\n          <button\r\n            onClick={toggleVideo}\r\n            className={`p-4 rounded-full transition-colors ${\r\n              isVideoOff ? 'bg-red-500 hover:bg-red-600' : 'bg-white/10 hover:bg-white/20'\r\n            }`}\r\n          >\r\n            {isVideoOff ? <VideoOff className=\"w-6 h-6 text-white\" /> : <Video className=\"w-6 h-6 text-white\" />}\r\n          </button>\r\n\r\n          <button\r\n            onClick={() => setShowNotes(!showNotes)}\r\n            className={`p-4 rounded-full transition-colors ${\r\n              showNotes ? 'bg-cyan-500' : 'bg-white/10 hover:bg-white/20'\r\n            }`}\r\n          >\r\n            <MessageSquare className=\"w-6 h-6 text-white\" />\r\n          </button>\r\n\r\n          {isAdminOrLead && (\r\n            <button\r\n              onClick={() => setTestMode(!testMode)}\r\n              className={`p-4 rounded-full transition-colors ${\r\n                testMode ? 'bg-yellow-500' : 'bg-white/10 hover:bg-white/20'\r\n              }`}\r\n            >\r\n              <span className=\"text-lg\">{testMode ? 'üé≠' : 'üé≠'}</span>\r\n            </button>\r\n          )}\r\n\r\n          <button\r\n            onClick={endCall}\r\n            className=\"p-4 bg-red-500 hover:bg-red-600 rounded-full transition-colors\"\r\n          >\r\n            <Phone className=\"w-6 h-6 text-white rotate-[135deg]\" />\r\n          </button>\r\n\r\n          {isAdminOrLead && session.status === 'active' && (\r\n            <button\r\n              onClick={hireCandidate}\r\n              disabled={hiring}\r\n              className=\"px-6 py-4 bg-green-500 hover:bg-green-600 rounded-full transition-colors flex items-center gap-2\"\r\n            >\r\n              <CheckCircle className=\"w-6 h-6 text-white\" />\r\n              <span className=\"text-white font-bold\">{hiring ? 'Hiring...' : 'Hire'}</span>\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {showNotes && (\r\n        <div className=\"absolute bottom-24 right-4 w-80 bg-[#1A1A1A] border border-[#2C2C2C] rounded-xl p-4 z-20\">\r\n          <h3 className=\"text-lg font-semibold text-white mb-3\">Interview Notes</h3>\r\n          <textarea\r\n            value={notes}\r\n            onChange={(e) => setNotes(e.target.value)}\r\n            placeholder=\"Add notes about this interview...\"\r\n            className=\"w-full h-40 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg p-3 text-white resize-none focus:border-cyan-400 focus:outline-none\"\r\n          />\r\n          <p className=\"text-gray-400 text-xs mt-2\">Notes are saved automatically</p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\InterviewRoomPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[249,256],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XCircle"},"fix":{"range":[279,292],"text":""},"desc":"Remove unused variable \"XCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[305,312],"text":""},"desc":"Remove unused variable \"Users\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MessageSquare' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MessageSquare"},"fix":{"range":[312,327],"text":""},"desc":"Remove unused variable \"MessageSquare\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showScheduleModal' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":46,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'checkApplicationAndInterview' and 'navigate'. Either include them or remove the dependency array.","line":58,"column":6,"nodeType":"ArrayExpression","endLine":58,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [checkApplicationAndInterview, navigate, user]","fix":{"range":[1918,1924],"text":"[checkApplicationAndInterview, navigate, user]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'interview' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":139,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":139,"endColumn":30},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":255,"column":51,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[9002,9185],"text":"\r\n                You have an appointed role and don&apos;t need to go through the interview process. \r\n                You can access your role-specific features directly.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[9002,9185],"text":"\r\n                You have an appointed role and don&lsquo;t need to go through the interview process. \r\n                You can access your role-specific features directly.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[9002,9185],"text":"\r\n                You have an appointed role and don&#39;t need to go through the interview process. \r\n                You can access your role-specific features directly.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[9002,9185],"text":"\r\n                You have an appointed role and don&rsquo;t need to go through the interview process. \r\n                You can access your role-specific features directly.\r\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { \r\n  Video, Calendar, Clock, FileText, CheckCircle, \r\n  XCircle, AlertCircle, Users, MessageSquare\r\n} from 'lucide-react'\r\n\r\n// Application type\r\ninterface Application {\r\n  id: string\r\n  type: string\r\n  status: string\r\n  created_at: string\r\n  reviewed_at?: string\r\n}\r\n\r\n// Interview session type\r\ninterface InterviewSession {\r\n  id: string\r\n  application_id: string\r\n  user_id: string\r\n  scheduled_at: string\r\n  status: 'active' | 'completed' | 'hired' | 'rejected'\r\n  notes: string\r\n  applicant_name: string\r\n}\r\n\r\n// Position options for interviews\r\nconst interviewPositions = [\r\n  { id: 'troll_officer', title: 'Troll Officer (Moderation)', icon: 'üõ°Ô∏è' },\r\n  { id: 'lead_troll_officer', title: 'Lead Troll Officer', icon: '‚≠ê' },\r\n  { id: 'secretary', title: 'Secretary', icon: 'üìã' },\r\n  { id: 'seller', title: 'Marketplace Seller', icon: 'üè™' },\r\n]\r\n\r\nexport default function InterviewRoomPage() {\r\n  const navigate = useNavigate()\r\n  const { profile, user } = useAuthStore()\r\n  const [loading, setLoading] = useState(true)\r\n  const [hasApplication, setHasApplication] = useState(false)\r\n  const [application, setApplication] = useState<Application | null>(null)\r\n  const [existingInterview, setExistingInterview] = useState<InterviewSession | null>(null)\r\n  const [showScheduleModal, setShowScheduleModal] = useState(false)\r\n  const [selectedPosition, setSelectedPosition] = useState('')\r\n  const [scheduleDate, setScheduleDate] = useState('')\r\n  const [scheduleTime, setScheduleTime] = useState('')\r\n  const [scheduling, setScheduling] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/login')\r\n      return\r\n    }\r\n    checkApplicationAndInterview()\r\n  }, [user])\r\n\r\n  // Check if user is admin (matching Sidebar.tsx logic)\r\n  const isAdmin = profile?.role === 'admin' || \r\n    profile?.troll_role === 'admin' || \r\n    profile?.role === 'hr_admin' || \r\n    profile?.is_admin ||\r\n    profile?.role === 'lead_troll_officer'\r\n\r\n  // Roles that don't need interviews - appointed directly (only pastor remains)\r\n  const appointedRoles = ['pastor']\r\n  const hasAppointedRole = appointedRoles.includes(profile?.role) || appointedRoles.includes(profile?.troll_role)\r\n\r\n  const checkApplicationAndInterview = async () => {\r\n    if (!user) return\r\n\r\n    // Admins have direct access\r\n    if (isAdmin) {\r\n      setHasApplication(true)\r\n      setLoading(false)\r\n      return\r\n    }\r\n\r\n    // Users with appointed roles don't need interviews\r\n    if (hasAppointedRole) {\r\n      toast.info('As an appointed role, you have direct access. Visit the Admin Applications page to manage interviews.')\r\n      navigate('/admin/applications')\r\n      return\r\n    }\r\n\r\n    try {\r\n      // Check for existing application that requires interview\r\n      const { data: appData, error: appError } = await supabase\r\n        .from('applications')\r\n        .select('id, type, status, created_at, reviewed_at')\r\n        .eq('user_id', user.id)\r\n        .in('status', ['pending', 'approved'])\r\n        .in('type', ['troll_officer', 'lead_troll_officer', 'secretary', 'seller'])\r\n        .maybeSingle()\r\n\r\n      if (appError) throw appError\r\n\r\n      if (appData) {\r\n        setHasApplication(true)\r\n        setApplication(appData)\r\n\r\n        // Check for existing interview session\r\n        const { data: interviewData, error: interviewError } = await supabase\r\n          .from('interview_sessions')\r\n          .select('*')\r\n          .eq('application_id', appData.id)\r\n          .in('status', ['active', 'completed'])\r\n          .maybeSingle()\r\n\r\n        if (interviewError) throw interviewError\r\n\r\n        if (interviewData) {\r\n          setExistingInterview(interviewData)\r\n        }\r\n      } else {\r\n        setHasApplication(false)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking application:', error)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const scheduleInterview = async () => {\r\n    if (!user || !application || !selectedPosition || !scheduleDate || !scheduleTime) {\r\n      toast.error('Please fill in all fields')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setScheduling(true)\r\n\r\n      const scheduledAt = new Date(`${scheduleDate}T${scheduleTime}`).toISOString()\r\n\r\n      // Create interview session\r\n      const { data: interview, error } = await supabase\r\n        .from('interview_sessions')\r\n        .insert({\r\n          application_id: application.id,\r\n          user_id: user.id,\r\n          interviewer_id: '', // Will be assigned by admin\r\n          scheduled_at: scheduledAt,\r\n          status: 'scheduled',\r\n          notes: ''\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (error) throw error\r\n\r\n      // Create notification for admins\r\n      const { data: admins } = await supabase\r\n        .from('user_profiles')\r\n        .select('id')\r\n        .eq('role', 'admin')\r\n\r\n      if (admins && admins.length > 0) {\r\n        const notifications = admins.map(admin => ({\r\n          user_id: admin.id,\r\n          type: 'interview_scheduled',\r\n          title: 'New Interview Scheduled',\r\n          message: `${profile?.username || 'A user'} has scheduled an interview for ${selectedPosition}`,\r\n          read: false,\r\n          created_at: new Date().toISOString()\r\n        }))\r\n\r\n        await supabase.from('notifications').insert(notifications)\r\n      }\r\n\r\n      toast.success('Interview scheduled successfully! Admins have been notified.')\r\n      setShowScheduleModal(false)\r\n      navigate('/career')\r\n    } catch (error: any) {\r\n      console.error('Error scheduling interview:', error)\r\n      toast.error('Failed to schedule interview')\r\n    } finally {\r\n      setScheduling(false)\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-400\">Loading...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // No application found - show prompt (unless admin)\r\n  if (!hasApplication) {\r\n    // Admin view - show admin dashboard\r\n    if (isAdmin) {\r\n      return (\r\n        <div className=\"min-h-screen bg-[#0A0814] p-6\">\r\n          <div className=\"max-w-2xl mx-auto\">\r\n            <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-8\">\r\n              <div className=\"flex items-center gap-4 mb-6\">\r\n                <div className=\"p-3 bg-purple-500/20 rounded-lg\">\r\n                  <Video className=\"w-8 h-8 text-purple-400\" />\r\n                </div>\r\n                <div>\r\n                  <h1 className=\"text-2xl font-bold text-white\">Admin Interview Dashboard</h1>\r\n                  <p className=\"text-gray-400\">Manage all scheduled interviews</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-[#141414] rounded-lg p-6 mb-6\">\r\n                <p className=\"text-gray-400 mb-4\">\r\n                  As an admin, you have full access to the interview system. You can:\r\n                </p>\r\n                <ul className=\"space-y-2 text-gray-300\">\r\n                  <li className=\"flex items-center gap-2\">\r\n                    <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n                    View all pending applications\r\n                  </li>\r\n                  <li className=\"flex items-center gap-2\">\r\n                    <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n                    Join scheduled interviews\r\n                  </li>\r\n                  <li className=\"flex items-center gap-2\">\r\n                    <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n                    Review and approve applications\r\n                  </li>\r\n                </ul>\r\n              </div>\r\n\r\n              <button\r\n                onClick={() => navigate('/admin/applications')}\r\n                className=\"w-full py-4 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-bold transition-all flex items-center justify-center gap-2\"\r\n              >\r\n                <FileText className=\"w-5 h-5\" />\r\n                View All Applications\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    // Users with appointed roles don't need interviews\r\n    if (hasAppointedRole) {\r\n      return (\r\n        <div className=\"min-h-screen bg-[#0A0814] p-6\">\r\n          <div className=\"max-w-2xl mx-auto\">\r\n            <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-8 text-center\">\r\n              <CheckCircle className=\"w-16 h-16 text-green-400 mx-auto mb-4\" />\r\n              <h1 className=\"text-2xl font-bold text-white mb-2\">Appointed Role</h1>\r\n              <p className=\"text-gray-400 mb-6\">\r\n                You have an appointed role and don't need to go through the interview process. \r\n                You can access your role-specific features directly.\r\n              </p>\r\n              <button\r\n                onClick={() => navigate('/admin/applications')}\r\n                className=\"px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-colors flex items-center gap-2 mx-auto\"\r\n              >\r\n                <FileText className=\"w-5 h-5\" />\r\n                Go to Admin Dashboard\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] p-6\">\r\n        <div className=\"max-w-2xl mx-auto\">\r\n          <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-8 text-center\">\r\n            <AlertCircle className=\"w-16 h-16 text-yellow-400 mx-auto mb-4\" />\r\n            <h1 className=\"text-2xl font-bold text-white mb-2\">Interview Required</h1>\r\n            <p className=\"text-gray-400 mb-6\">\r\n              You need to submit and have an approved application for Troll Officer, Lead Troll Officer, Secretary, or Marketplace Seller before scheduling an interview.\r\n            </p>\r\n            <button\r\n              onClick={() => navigate('/application')}\r\n              className=\"px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-medium transition-colors flex items-center gap-2 mx-auto\"\r\n            >\r\n              <FileText className=\"w-5 h-5\" />\r\n              Go to Careers Page\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Existing interview found\r\n  if (existingInterview) {\r\n    const statusColors = {\r\n      active: 'bg-yellow-500/20 text-yellow-400',\r\n      completed: 'bg-gray-500/20 text-gray-400',\r\n      hired: 'bg-green-500/20 text-green-400',\r\n      rejected: 'bg-red-500/20 text-red-400',\r\n    }\r\n\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] p-6\">\r\n        <div className=\"max-w-2xl mx-auto\">\r\n          <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-8\">\r\n            <div className=\"flex items-center gap-4 mb-6\">\r\n              <div className=\"p-3 bg-cyan-500/20 rounded-lg\">\r\n                <Video className=\"w-8 h-8 text-cyan-400\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-2xl font-bold text-white\">Interview Scheduled</h1>\r\n                <p className=\"text-gray-400\">Your interview is scheduled</p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"bg-[#141414] rounded-lg p-6 mb-6\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <span className=\"text-gray-400\">Status</span>\r\n                <span className={`px-3 py-1 rounded-lg text-sm font-medium ${statusColors[existingInterview.status as keyof typeof statusColors]}`}>\r\n                  {existingInterview.status === 'active' ? 'Active' : \r\n                   existingInterview.status.charAt(0).toUpperCase() + existingInterview.status.slice(1)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <span className=\"text-gray-400\">Scheduled For</span>\r\n                <span className=\"text-white font-medium\">\r\n                  {new Date(existingInterview.scheduled_at).toLocaleString()}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-gray-400\">Application Type</span>\r\n                <span className=\"text-white font-medium capitalize\">\r\n                  {application?.type.replace('_', ' ')}\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            {existingInterview.status === 'active' && (\r\n              <button\r\n                onClick={() => navigate(`/interview/${existingInterview.id}`)}\r\n                className=\"w-full py-4 bg-gradient-to-r from-cyan-500 to-purple-500 text-bold hover:shadow-lg hover:shadow-cyan-500/30-white rounded-lg font transition-all flex items-center justify-center gap-2\"\r\n              >\r\n                <Video className=\"w-5 h-5\" />\r\n                Join Interview Room\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Application exists, no interview yet - show scheduling form\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] p-6\">\r\n      <div className=\"max-w-2xl mx-auto\">\r\n        <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-8\">\r\n          <div className=\"flex items-center gap-4 mb-6\">\r\n            <div className=\"p-3 bg-cyan-500/20 rounded-lg\">\r\n              <Calendar className=\"w-8 h-8 text-cyan-400\" />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-white\">Schedule Interview</h1>\r\n              <p className=\"text-gray-400\">Select a position and schedule your interview</p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Application Status */}\r\n          <div className=\"bg-[#141414] rounded-lg p-4 mb-6 flex items-center gap-4\">\r\n            <CheckCircle className=\"w-6 h-6 text-green-400\" />\r\n            <div>\r\n              <p className=\"text-white font-medium\">Application on File</p>\r\n              <p className=\"text-gray-400 text-sm\">\r\n                {application?.type.replace('_', ' ')} - {application?.status}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Position Selection */}\r\n          <div className=\"mb-6\">\r\n            <label className=\"block text-gray-400 mb-3\">Select Position</label>\r\n            <div className=\"grid grid-cols-1 gap-3\">\r\n              {interviewPositions.map((pos) => (\r\n                <button\r\n                  key={pos.id}\r\n                  onClick={() => setSelectedPosition(pos.id)}\r\n                  className={`p-4 rounded-lg border transition-all flex items-center gap-3 ${\r\n                    selectedPosition === pos.id\r\n                      ? 'border-cyan-500 bg-cyan-500/10'\r\n                      : 'border-[#2C2C2C] hover:border-gray-600'\r\n                  }`}\r\n                >\r\n                  <span className=\"text-2xl\">{pos.icon}</span>\r\n                  <span className=\"text-white font-medium\">{pos.title}</span>\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Date/Time Selection */}\r\n          <div className=\"grid grid-cols-2 gap-4 mb-6\">\r\n            <div>\r\n              <label className=\"block text-gray-400 mb-2\">Date</label>\r\n              <input\r\n                type=\"date\"\r\n                value={scheduleDate}\r\n                onChange={(e) => setScheduleDate(e.target.value)}\r\n                min={new Date().toISOString().split('T')[0]}\r\n                className=\"w-full bg-[#141414] border border-[#2C2C2C] rounded-lg px-4 py-3 text-white focus:border-cyan-500 focus:outline-none\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-gray-400 mb-2\">Time</label>\r\n              <input\r\n                type=\"time\"\r\n                value={scheduleTime}\r\n                onChange={(e) => setScheduleTime(e.target.value)}\r\n                className=\"w-full bg-[#141414] border border-[#2C2C2C] rounded-lg px-4 py-3 text-white focus:border-cyan-500 focus:outline-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Submit Button */}\r\n          <button\r\n            onClick={scheduleInterview}\r\n            disabled={!selectedPosition || !scheduleDate || !scheduleTime || scheduling}\r\n            className=\"w-full py-4 bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-lg font-bold hover:shadow-lg hover:shadow-cyan-500/30 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            {scheduling ? (\r\n              <>\r\n                <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white\"></div>\r\n                Scheduling...\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Calendar className=\"w-5 h-5\" />\r\n                Schedule Interview\r\n              </>\r\n            )}\r\n          </button>\r\n\r\n          <p className=\"text-gray-400 text-sm text-center mt-4\">\r\n            Admins will be notified and will join your interview at the scheduled time.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Join.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\KickFee.tsx","messages":[{"ruleId":"react/jsx-no-undef","severity":2,"message":"'CoinStoreModal' is not defined.","line":230,"column":10,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":230,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { AlertCircle, CreditCard, Home } from \"lucide-react\";\r\nimport { useAuthStore } from \"../lib/store\";\r\nimport { supabase } from \"../lib/supabase\";\r\nimport { toast } from \"sonner\";\r\nimport { EDGE_URL } from \"../lib/config\";\r\n\r\nexport default function KickFee() {\r\n  const navigate = useNavigate();\r\n  const { user, profile, refreshProfile, logout } = useAuthStore();\r\n  const [kickCount, setKickCount] = useState(0);\r\n  const [loading, setLoading] = useState(false);\r\n  const [deleteLoading, setDeleteLoading] = useState(false);\r\n  const [showCashAppInfo, setShowCashAppInfo] = useState(false);\r\n\r\n  const reinstatementFee = 500;\r\n  const usernamePrefix = String(\r\n    profile?.username || user?.email?.split(\"@\")[0] || \"user\"\r\n  )\r\n    .slice(0, 6)\r\n    .toUpperCase();\r\n  const suggestedNote = `${usernamePrefix}-KICK-REENTRY`;\r\n\r\n  useEffect(() => {\r\n    if (profile?.kick_count != null) {\r\n      setKickCount(profile.kick_count);\r\n      return;\r\n    }\r\n\r\n    const localKick = localStorage.getItem(\"kickCount\");\r\n    if (localKick) {\r\n      const parsed = parseInt(localKick);\r\n      if (!Number.isNaN(parsed)) {\r\n        setKickCount(parsed);\r\n      }\r\n    }\r\n  }, [profile]);\r\n\r\n  const handlePayWithCoins = async () => {\r\n    if (!user || !profile) {\r\n      toast.error(\"You must be logged in\");\r\n      navigate(\"/auth\");\r\n      return;\r\n    }\r\n\r\n    if ((profile.troll_coins || 0) < reinstatementFee) {\r\n      toast.error(\"Not enough troll_coins to pay re-entry fee\");\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    try {\r\n      const { data, error } = await supabase.rpc(\"pay_kick_reentry_fee\", {\r\n        p_user_id: user.id,\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data?.success) {\r\n        toast.success(\"Re-entry fee paid. Access restored.\");\r\n        localStorage.removeItem(\"kickCount\");\r\n        refreshProfile?.();\r\n        navigate(\"/\", { replace: true });\r\n      } else {\r\n        toast.error(data?.error || \"Failed to pay re-entry fee\");\r\n      }\r\n    } catch (err: any) {\r\n      console.error(\"Error paying re-entry fee:\", err);\r\n      toast.error(err?.message || \"Failed to pay re-entry fee\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handlePayWithCashApp = () => {\r\n    setShowCashAppInfo(true);\r\n    toast.info(\"Follow the Cash App instructions below to complete your re-entry fee.\");\r\n  };\r\n\r\n  const handleDeleteAccountAndLogout = async () => {\r\n    if (!user) {\r\n      toast.error(\"You must be logged in\");\r\n      navigate(\"/auth\");\r\n      return;\r\n    }\r\n\r\n    const confirmed = window.confirm(\r\n      \"This will permanently delete your Troll City account and all progress. This cannot be undone. Continue?\"\r\n    );\r\n    if (!confirmed) return;\r\n\r\n    setDeleteLoading(true);\r\n    try {\r\n      const { data: sessionData } = await supabase.auth.getSession();\r\n      const token = sessionData.session?.access_token;\r\n\r\n      if (!token) {\r\n        toast.error(\"Not authenticated\");\r\n        return;\r\n      }\r\n\r\n      const response = await fetch(`${EDGE_URL}/auth/delete-account`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      const body = await response.json().catch(() => null);\r\n\r\n      if (!response.ok || body?.error || body?.success === false) {\r\n        const message = body?.error || \"Failed to delete account\";\r\n        toast.error(message);\r\n        return;\r\n      }\r\n\r\n      localStorage.removeItem(\"kickCount\");\r\n      localStorage.removeItem(\"banDays\");\r\n\r\n      toast.success(\"Account deleted. Logging out.\");\r\n      await logout();\r\n      navigate(\"/auth\", { replace: true });\r\n    } catch (err: any) {\r\n      console.error(\"Error deleting account:\", err);\r\n      toast.error(err?.message || \"Failed to delete account\");\r\n    } finally {\r\n      setDeleteLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-950 via-purple-950 to-gray-950 text-white flex items-center justify-center p-4\">\r\n\r\n      <div className=\"max-w-md w-full\">\r\n        <div className=\"bg-gray-900/80 rounded-xl p-8 purple-neon\">\r\n          <div className=\"flex items-center justify-center mb-6\">\r\n            <AlertCircle size={48} className=\"text-red-400\" />\r\n          </div>\r\n\r\n          <h1 className=\"text-3xl font-black text-center mb-4 text-red-400\">\r\n            Stream Access Suspended\r\n          </h1>\r\n\r\n          <p className=\"text-center text-gray-300 mb-6\">\r\n            You were kicked from a broadcast. Pay the reinstatement fee to rejoin streams.\r\n          </p>\r\n\r\n          <div className=\"bg-gray-800/50 rounded-lg p-4 mb-6 border border-red-500/30\">\r\n            <div className=\"flex justify-between items-center mb-2\">\r\n              <span className=\"text-gray-400\">Kicks on Record:</span>\r\n              <span className=\"font-bold text-red-400\">{kickCount}</span>\r\n            </div>\r\n            <div className=\"flex justify-between items-center\">\r\n              <span className=\"text-gray-400\">Reinstatement Fee:</span>\r\n              <span className=\"font-bold text-yellow-400\">{reinstatementFee} ü™ô</span>\r\n            </div>\r\n          </div>\r\n\r\n          {kickCount >= 3 && (\r\n            <div className=\"bg-orange-500/20 border border-orange-500/50 rounded-lg p-4 mb-6\">\r\n              <p className=\"text-orange-300 font-bold text-sm\">\r\n                ‚ö†Ô∏è Warning: {3 - kickCount} more kicks will result in IP ban\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"space-y-3\">\r\n            <button\r\n              onClick={handlePayWithCoins}\r\n              disabled={loading || deleteLoading}\r\n              className=\"w-full py-3 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-700 hover:to-yellow-600 rounded-lg font-bold transition flex items-center justify-center gap-2\"\r\n            >\r\n              üí∞ {loading ? \"Processing...\" : `Pay ${reinstatementFee} Coins`}\r\n            </button>\r\n\r\n            <button\r\n              onClick={handlePayWithCashApp}\r\n              disabled={deleteLoading}\r\n              className=\"w-full py-3 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 rounded-lg font-bold transition flex items-center justify-center gap-2\"\r\n            >\r\n              <CreditCard size={18} />\r\n              Pay via Cash App (manual)\r\n            </button>\r\n\r\n            {showCashAppInfo && (\r\n              <div className=\"w-full py-3 px-4 bg-blue-950/60 border border-blue-500/40 rounded-lg text-sm text-blue-100 space-y-2\">\r\n                <div className=\"font-semibold\">Manual Cash App payment</div>\r\n                <ul className=\"list-disc pl-5 space-y-1\">\r\n                  <li>\r\n                    Send payment to <span className=\"font-mono font-semibold\">$trollcity95</span>\r\n                  </li>\r\n                  <li>\r\n                    In the Cash App note include:{\" \"}\r\n                    <span className=\"font-mono\">{suggestedNote}</span>\r\n                  </li>\r\n                  <li>\r\n                    Keep your Cash App receipt so support or Troll Court can verify your payment.\r\n                  </li>\r\n                </ul>\r\n              </div>\r\n            )}\r\n\r\n            <button\r\n              onClick={handleDeleteAccountAndLogout}\r\n              disabled={deleteLoading || loading}\r\n              className=\"w-full py-3 bg-gradient-to-r from-red-700 to-red-600 hover:from-red-800 hover:to-red-700 rounded-lg font-bold transition flex items-center justify-center gap-2 text-red-50\"\r\n            >\r\n              {deleteLoading ? \"Deleting account...\" : \"Log out and delete account\"}\r\n            </button>\r\n\r\n            <button\r\n              onClick={() => navigate(\"/\")}\r\n              disabled={deleteLoading}\r\n              className=\"w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold transition flex items-center justify-center gap-2 text-gray-300\"\r\n            >\r\n              <Home size={18} />\r\n              Return Home\r\n            </button>\r\n          </div>\r\n\r\n          <p className=\"text-xs text-gray-500 text-center mt-6\">\r\n            Repeated offenses may result in ban or IP ban. You can appeal penalties in Troll Court.\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {showCoinStore && (\r\n        <CoinStoreModal\r\n          onClose={() => setShowCoinStore(false)}\r\n          onPurchase={() => {\r\n            refreshProfile?.();\r\n            // Don't close immediately, let them buy more if they want? \r\n            // Or close it? Usually keep open or user closes.\r\n          }}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\LandingPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\LeadOfficerApplication.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Leaderboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\LivePage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'profile.id'. Either include it or remove the dependency array.","line":2307,"column":6,"nodeType":"ArrayExpression","endLine":2307,"endColumn":87,"suggestions":[{"desc":"Update the dependencies array to be: [isBroadcaster, streamId, isConnected, roomName, stream?.status, stream?.is_live, profile.id]","fix":{"range":[85676,85757],"text":"[isBroadcaster, streamId, isConnected, roomName, stream?.status, stream?.is_live, profile.id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { \r\n  useCallback, \r\n  useEffect, \r\n  useMemo, \r\n  useRef, \r\n  useState \r\n} from 'react';\r\nimport { useParams, useLocation, useNavigate } from 'react-router-dom';\r\nimport { useLiveKit } from '../hooks/useLiveKit';\r\nimport { useLiveKitSession } from '../hooks/useLiveKitSession';\r\nimport { useLiveKitToken } from '../hooks/useLiveKitToken';\r\nimport { useStreamEndListener } from '../hooks/useStreamEndListener';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { useCoins } from '../lib/hooks/useCoins';\r\nimport { supabase, createConversation, sendConversationMessage } from '../lib/supabase';\r\nimport { sendNotification } from '../lib/sendNotification';\r\nimport { toast } from 'sonner';\r\nimport { Participant } from 'livekit-client';\r\nimport {\r\n  Users,\r\n  Mic,\r\n  MicOff,\r\n  Camera,\r\n  CameraOff,\r\n  RefreshCw,\r\n  Swords,\r\n  X,\r\n  Settings,\r\n  Plus,\r\n  Minus\r\n} from 'lucide-react';\r\nimport ChatBox from '../components/broadcast/ChatBox';\r\nimport GiftBox, { GiftItem, RecipientMode } from '../components/broadcast/GiftBox';\r\nimport GiftModal from '../components/broadcast/GiftModal';\r\nimport ProfileModal from '../components/broadcast/ProfileModal';\r\nimport CoinStoreModal from '../components/broadcast/CoinStoreModal';\r\nimport EntranceEffect from '../components/broadcast/EntranceEffect';\r\nimport BroadcastLayout from '../components/broadcast/BroadcastLayout';\r\nimport FlyingChatOverlay from '../components/broadcast/FlyingChatOverlay';\r\nimport GlobalGiftBanner from '../components/GlobalGiftBanner';\r\nimport GiftEventOverlay from './GiftEventOverlay';\r\nimport { getUserEntranceEffect, triggerUserEntranceEffect } from '../lib/entranceEffects';\r\nimport { processGiftXp } from '../lib/xp';\r\nimport { evaluateBadgesForUser } from '../services/badgeEvaluationService';\r\n\r\nimport { useGiftEvents } from '../lib/hooks/useGiftEvents';\r\nimport { useOfficerBroadcastTracking } from '../hooks/useOfficerBroadcastTracking';\r\nimport { updateOfficerActivity } from '../lib/officerActivity';\r\nimport { useSeatRoster } from '../hooks/useSeatRoster';\r\nimport { attachLiveKitDebug } from '../lib/livekit-debug';\r\nimport UserActionsMenu from '../components/broadcast/UserActionsMenu';\r\nimport { useViewerTracking } from '../hooks/useViewerTracking';\r\nimport TrollBattleOverlay from '../components/broadcast/TrollBattleOverlay';\r\nimport TrollBattlesSetup from '../components/broadcast/TrollBattlesSetup';\r\nimport BroadcastLevelBar from '../components/broadcast/BroadcastLevelBar';\r\n\r\n// Constants\r\nconst STREAM_POLL_INTERVAL = 2000;\r\n\r\nconst DEFAULT_GIFTS: GiftItem[] = [\r\n  { id: \"troll_clap\", name: \"Troll Clap\", icon: \"üëè\", value: 5, category: \"Basic\" },\r\n  { id: \"glow_heart\", name: \"Glow Heart\", icon: \"üíñ\", value: 10, category: \"Basic\" },\r\n  { id: \"laughing_mask\", name: \"Laughing Mask\", icon: \"üòπ\", value: 30, category: \"Basic\" },\r\n  { id: \"troll_mic_drop\", name: \"Troll Mic Drop\", icon: \"üé§\", value: 100, category: \"Rare\" },\r\n  { id: \"troll_confetti\", name: \"Troll Confetti\", icon: \"üéâ\", value: 850, category: \"Rare\" },\r\n  { id: \"crown_blast\", name: \"Crown Blast\", icon: \"üëë\", value: 1200, category: \"Epic\" },\r\n  { id: \"diamond_storm\", name: \"Diamond Storm\", icon: \"üíé\", value: 7000, category: \"Legendary\" },\r\n  { id: \"the_big_crown\", name: \"The Big Crown\", icon: \"üëë‚ú®\", value: 15000, category: \"Legendary\" },\r\n  { id: \"troll\", name: \"Troll\", icon: \"üßü\", value: 1, category: \"Basic\" },\r\n  { id: \"rose\", name: \"Rose\", icon: \"üåπ\", value: 20, category: \"Basic\" },\r\n  { id: \"sparkles\", name: \"Sparkles\", icon: \"‚ú®\", value: 75, category: \"Rare\" },\r\n  { id: \"fireworks\", name: \"Fireworks\", icon: \"üéÜ\", value: 2000, category: \"Legendary\" },\r\n  { id: \"neon_wave\", name: \"Neon Wave\", icon: \"üåä\", value: 300, category: \"Rare\" },\r\n  { id: \"royal_scepter\", name: \"Royal Scepter\", icon: \"‚öúÔ∏è\", value: 4500, category: \"Epic\" },\r\n  { id: \"neon_dragon\", name: \"Neon Dragon\", icon: \"üêâ\", value: 8000, category: \"Legendary\" },\r\n  { id: \"galaxy_portal\", name: \"Galaxy Portal\", icon: \"üåÄ\", value: 20000, category: \"Legendary\" },\r\n  { id: \"cosmic_comet\", name: \"Cosmic Comet\", icon: \"‚òÑÔ∏è\", value: 35000, category: \"Legendary\" },\r\n  { id: \"rainbow_unicorn\", name: \"Rainbow Unicorn\", icon: \"ü¶Ñ\", value: 150, category: \"Rare\" },\r\n  { id: \"golden_trophy\", name: \"Golden Trophy\", icon: \"üèÜ\", value: 500, category: \"Rare\" },\r\n  { id: \"magic_wand\", name: \"Magic Wand\", icon: \"ü™Ñ\", value: 250, category: \"Rare\" },\r\n  { id: \"shooting_star\", name: \"Shooting Star\", icon: \"‚≠ê\", value: 600, category: \"Epic\" },\r\n  { id: \"phoenix_fire\", name: \"Phoenix Fire\", icon: \"üî•\", value: 3000, category: \"Epic\" },\r\n  { id: \"crystal_heart\", name: \"Crystal Heart\", icon: \"üíé\", value: 5000, category: \"Epic\" },\r\n  { id: \"thunder_bolt\", name: \"Thunder Bolt\", icon: \"‚ö°\", value: 400, category: \"Rare\" },\r\n  { id: \"ice_blast\", name: \"Ice Blast\", icon: \"‚ùÑÔ∏è\", value: 350, category: \"Rare\" },\r\n  { id: \"golden_rose\", name: \"Golden Rose\", icon: \"üåπ\", value: 800, category: \"Epic\" },\r\n  { id: \"party_popper\", name: \"Party Popper\", icon: \"üéä\", value: 200, category: \"Basic\" },\r\n  { id: \"rocket_ship\", name: \"Rocket Ship\", icon: \"üöÄ\", value: 1500, category: \"Epic\" },\r\n  { id: \"lucky_clover\", name: \"Lucky Clover\", icon: \"üçÄ\", value: 450, category: \"Rare\" },\r\n  { id: \"golden_star\", name: \"Golden Star\", icon: \"üåü\", value: 900, category: \"Epic\" },\r\n  { id: \"royal_castle\", name: \"Royal Castle\", icon: \"üè∞\", value: 6000, category: \"Epic\" },\r\n  { id: \"celestial_moon\", name: \"Celestial Moon\", icon: \"üåô\", value: 1800, category: \"Epic\" },\r\n  { id: \"super_nova\", name: \"Super Nova\", icon: \"üí´\", value: 12000, category: \"Legendary\" },\r\n  { id: \"angel_wings\", name: \"Angel Wings\", icon: \"üëº\", value: 2500, category: \"Epic\" },\r\n  { id: \"demon_horns\", name: \"Demon Horns\", icon: \"üòà\", value: 2800, category: \"Epic\" },\r\n  { id: \"infinity_gem\", name: \"Infinity Gem\", icon: \"üí†\", value: 50000, category: \"Legendary\" },\r\n  { id: \"divine_halo\", name: \"Divine Halo\", icon: \"üòá\", value: 10000, category: \"Legendary\" },\r\n];\r\n\r\n// Types\r\ninterface StreamRow {\r\n  id: string;\r\n  broadcaster_id: string;\r\n  status: string;\r\n  is_live: boolean;\r\n  current_viewers?: number;\r\n  total_gifts_coins?: number;\r\n  total_likes?: number;\r\n  start_time?: string;\r\n  title?: string;\r\n  room_name?: string;\r\n  agora_channel?: string;\r\n  category?: string;\r\n  is_private?: boolean;\r\n  broadcast_level_percent?: number;\r\n  last_level_update_at?: string;\r\n  broadcast_xp?: number;\r\n  frame_mode?: 'none' | 'rgb';\r\n}\r\n\r\ninterface ActiveViewer {\r\n  userId: string;\r\n  username: string;\r\n  avatarUrl?: string | null;\r\n  role?: string | null;\r\n  isBroadcaster?: boolean;\r\n  fullName?: string | null;\r\n  onboardingCompleted?: boolean;\r\n  w9Status?: string;\r\n}\r\n\r\ninterface GiftBalanceDelta {\r\n  userId: string;\r\n  delta: number;\r\n  key: number;\r\n}\r\n\r\ninterface SeatBan {\r\n  id: string;\r\n  user_id: string;\r\n  banned_until: string | null;\r\n  created_at: string;\r\n  reason?: string | null;\r\n  username?: string | null;\r\n}\r\n\r\nconst useIsBroadcaster = (profile: any, stream: StreamRow | null) => {\r\n  return useMemo(() => {\r\n    return Boolean(profile?.id && stream?.broadcaster_id && profile.id === stream.broadcaster_id);\r\n  }, [profile?.id, stream?.broadcaster_id]);\r\n};\r\n\r\nfunction BroadcasterTimer({ startTime, onClick }: { startTime: string; onClick?: () => void }) {\r\n  const [elapsed, setElapsed] = useState('00:00:00');\r\n\r\n  useEffect(() => {\r\n    if (!startTime) return;\r\n    const start = new Date(startTime).getTime();\r\n    \r\n    const interval = setInterval(() => {\r\n      const now = Date.now();\r\n      const diff = now - start;\r\n      if (diff < 0) {\r\n        setElapsed('00:00:00');\r\n        return;\r\n      }\r\n      \r\n      const hours = Math.floor(diff / 3600000);\r\n      const minutes = Math.floor((diff % 3600000) / 60000);\r\n      const seconds = Math.floor((diff % 60000) / 1000);\r\n      \r\n      setElapsed(\r\n        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`\r\n      );\r\n    }, 1000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [startTime]);\r\n\r\n  return (\r\n    <button\r\n      type=\"button\"\r\n      onClick={onClick}\r\n      className=\"bg-red-600/90 text-white px-3 py-1 rounded-full text-xs font-bold font-mono animate-pulse flex items-center gap-2 shadow-[0_0_10px_rgba(220,38,38,0.5)] border border-red-400/30\"\r\n    >\r\n      <div className=\"w-2 h-2 rounded-full bg-white animate-ping\" />\r\n      LIVE {elapsed}\r\n    </button>\r\n  );\r\n}\r\n\r\nfunction BroadcasterSettings({\r\n  streamId,\r\n  broadcasterId: _broadcasterId,\r\n  onAlertOfficers,\r\n  joinPrice,\r\n  onSetPrice,\r\n}: {\r\n  streamId: string;\r\n  broadcasterId?: string;\r\n  onAlertOfficers: (targetUserId?: string) => Promise<void>;\r\n  joinPrice: number;\r\n  onSetPrice: (price: number) => void;\r\n}) {\r\n  const [participants, setParticipants] = useState<Array<{ user_id: string; username: string; avatar_url?: string; is_moderator?: boolean; can_chat?: boolean; chat_mute_until?: string; is_active?: boolean }>>([]);\r\n  const [search, setSearch] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [kicking, setKicking] = useState<string | null>(null);\r\n  const [updatingMod, setUpdatingMod] = useState<string | null>(null);\r\n  const [draftPrice, setDraftPrice] = useState(() =>\r\n    joinPrice > 0 ? String(joinPrice) : ''\r\n  );\r\n\r\n  useEffect(() => {\r\n    setDraftPrice(joinPrice > 0 ? String(joinPrice) : '');\r\n  }, [joinPrice]);\r\n\r\n  const handleApplyJoinPrice = () => {\r\n    const parsed = parseInt(draftPrice || '0') || 0;\r\n    onSetPrice(Math.max(0, parsed));\r\n  };\r\n\r\n  const loadParticipants = useCallback(async () => {\r\n    if (!streamId) return;\r\n    setLoading(true);\r\n    try {\r\n      const { data: sp } = await supabase\r\n        .from('streams_participants')\r\n        .select('user_id,is_active,is_moderator,can_chat,chat_mute_until')\r\n        .eq('stream_id', streamId);\r\n\r\n      const rows = sp || [];\r\n      const ids = rows.map(r => r.user_id);\r\n      const profiles: Record<string, { username: string; avatar_url?: string }> = {};\r\n      if (ids.length > 0) {\r\n        const { data: ups } = await supabase\r\n          .from('user_profiles')\r\n          .select('id,username,avatar_url')\r\n          .in('id', ids);\r\n        (ups || []).forEach((p: any) => { profiles[p.id] = { username: p.username, avatar_url: p.avatar_url }; });\r\n      }\r\n      setParticipants(rows.map(r => ({\r\n        user_id: r.user_id,\r\n        username: profiles[r.user_id]?.username || 'Unknown',\r\n        avatar_url: profiles[r.user_id]?.avatar_url,\r\n        is_moderator: r.is_moderator,\r\n        can_chat: r.can_chat,\r\n        chat_mute_until: r.chat_mute_until,\r\n        is_active: r.is_active\r\n      })));\r\n    } catch (err) {\r\n      console.error('Failed to load participants', err);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [streamId]);\r\n\r\n  useEffect(() => { loadParticipants(); }, [loadParticipants]);\r\n\r\n  const assignModerator = async (userId: string) => {\r\n    setUpdatingMod(userId);\r\n    try {\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ is_moderator: true })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', userId);\r\n      toast.success('Moderator assigned');\r\n      loadParticipants();\r\n    } catch (err) {\r\n      console.error('Failed to assign moderator', err);\r\n      toast.error('Failed to assign moderator');\r\n    } finally {\r\n      setUpdatingMod(null);\r\n    }\r\n  };\r\n\r\n  const removeModerator = async (userId: string) => {\r\n    setUpdatingMod(userId);\r\n    try {\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ is_moderator: false })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', userId);\r\n      toast.success('Moderator removed');\r\n      loadParticipants();\r\n    } catch (err) {\r\n      console.error('Failed to remove moderator', err);\r\n      toast.error('Failed to remove moderator');\r\n    } finally {\r\n      setUpdatingMod(null);\r\n    }\r\n  };\r\n\r\n  const kickUser = async (userId: string) => {\r\n    setKicking(userId);\r\n    try {\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ is_active: false, left_at: new Date().toISOString() })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', userId);\r\n      toast.success('User kicked from stream');\r\n      loadParticipants();\r\n    } catch (err) {\r\n      console.error('Failed to kick user', err);\r\n      toast.error('Failed to kick user');\r\n    } finally {\r\n      setKicking(null);\r\n    }\r\n  };\r\n\r\n  const reportUser = async (userId: string) => {\r\n    const reason = window.prompt('Reason for report:', 'Violation of rules');\r\n    if (reason === null) return;\r\n    try {\r\n      await supabase\r\n        .from('moderation_reports')\r\n        .insert({\r\n          reporter_id: (await supabase.auth.getUser()).data.user?.id,\r\n          target_user_id: userId,\r\n          stream_id: streamId,\r\n          reason,\r\n          description: ''\r\n        });\r\n      toast.success('Report submitted');\r\n    } catch (err) {\r\n      console.error('Failed to submit report', err);\r\n      toast.error('Failed to submit report');\r\n    }\r\n  };\r\n\r\n  const filtered = participants.filter(p => p.username.toLowerCase().includes(search.toLowerCase()));\r\n\r\n  return (\r\n    <div className=\"bg-[#05010a] rounded-3xl border border-white/10 p-5 overflow-y-auto max-h-[70vh] min-h-0 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent\">\r\n      <div className=\"flex items-center justify-between mb-4\">\r\n        <h3 className=\"text-lg font-bold flex items-center gap-2\">\r\n          <Settings size={20} className=\"text-purple-400\" />\r\n          Broadcast Settings\r\n        </h3>\r\n      </div>\r\n      \r\n      <div className=\"space-y-4\">\r\n        <div className=\"bg-white/5 border border-white/10 rounded-xl p-4\">\r\n          <div className=\"flex items-center justify-between gap-4\">\r\n            <span className=\"text-sm font-semibold text-white/80\">\r\n              Join Price (Coins)\r\n            </span>\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                type=\"number\"\r\n                value={draftPrice}\r\n                placeholder=\"0\"\r\n                inputMode=\"numeric\"\r\n                onChange={(e) =>\r\n                  setDraftPrice(e.target.value.replace(/[^\\d]/g, ''))\r\n                }\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter') {\r\n                    handleApplyJoinPrice();\r\n                  }\r\n                }}\r\n                className=\"w-20 bg-black/40 border border-white/20 rounded-lg px-3 py-1.5 text-sm text-white focus:border-purple-500 focus:outline-none\"\r\n              />\r\n              <button \r\n                onClick={handleApplyJoinPrice}\r\n                className=\"px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg uppercase tracking-wider\"\r\n              >\r\n                Set\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-xs uppercase tracking-[0.3em] text-white/60\">Participants & Mods</span>\r\n            <button\r\n              onClick={() => onAlertOfficers()}\r\n              className=\"text-xs px-3 py-1.5 rounded-lg bg-red-600/20 border border-red-500/40 text-red-200 hover:bg-red-600/30 font-bold uppercase tracking-wider transition-colors\"\r\n            >\r\n              Alert Troll Officers\r\n            </button>\r\n          </div>\r\n          <div className=\"mb-3\">\r\n            <input\r\n              value={search}\r\n              onChange={(e) => setSearch(e.target.value)}\r\n              placeholder=\"Search participants...\"\r\n              className=\"w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm focus:border-purple-500/50 focus:outline-none\"\r\n            />\r\n          </div>\r\n          <div className=\"space-y-2 max-h-64 overflow-y-auto pr-1\">\r\n            {loading ? (\r\n              <div className=\"text-xs text-white/60 text-center py-4\">Loading participants...</div>\r\n            ) : filtered.length === 0 ? (\r\n              <div className=\"text-xs text-white/60 text-center py-4\">No participants found</div>\r\n            ) : (\r\n              filtered.map((p) => (\r\n                <div key={p.user_id} className=\"flex items-center justify-between bg-white/5 rounded-lg px-3 py-2 border border-white/5\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"w-8 h-8 rounded-full bg-purple-900/30 border border-purple-500/20 flex items-center justify-center overflow-hidden\">\r\n                       {p.avatar_url ? (\r\n                         <img src={p.avatar_url} className=\"w-full h-full object-cover\" />\r\n                       ) : (\r\n                         <span className=\"text-xs font-bold text-purple-300\">{p.username.charAt(0)}</span>\r\n                       )}\r\n                    </div>\r\n                    <div>\r\n                      <div className=\"text-sm font-semibold text-white/90\">{p.username}</div>\r\n                      <div className=\"text-[10px] text-white/40 flex items-center gap-1\">\r\n                        {p.is_moderator && <span className=\"text-yellow-400\">Moderator</span>}\r\n                        {!p.is_active && <span>Inactive</span>}\r\n                        {p.can_chat === false && <span className=\"text-red-400\">Muted</span>}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    {p.is_moderator ? (\r\n                      <button\r\n                        disabled={updatingMod === p.user_id}\r\n                        onClick={() => removeModerator(p.user_id)}\r\n                        className=\"text-[10px] px-2 py-1 rounded bg-yellow-900/20 border border-yellow-500/30 text-yellow-200 hover:bg-yellow-900/40\"\r\n                      >\r\n                        Unmod\r\n                      </button>\r\n                    ) : (\r\n                      <button\r\n                        disabled={updatingMod === p.user_id}\r\n                        onClick={() => assignModerator(p.user_id)}\r\n                        className=\"text-[10px] px-2 py-1 rounded bg-green-900/20 border border-green-500/30 text-green-200 hover:bg-green-900/40\"\r\n                      >\r\n                        Mod\r\n                      </button>\r\n                    )}\r\n                    <button\r\n                      disabled={kicking === p.user_id}\r\n                      onClick={() => kickUser(p.user_id)}\r\n                      className=\"text-[10px] px-2 py-1 rounded bg-red-900/20 border border-red-500/30 text-red-200 hover:bg-red-900/40\"\r\n                    >\r\n                      Kick\r\n                    </button>\r\n                    <button\r\n                      onClick={() => reportUser(p.user_id)}\r\n                      className=\"text-[10px] px-2 py-1 rounded bg-blue-900/20 border border-blue-500/30 text-blue-200 hover:bg-blue-900/40\"\r\n                    >\r\n                      Report\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction OfficerActionBubble({\r\n  streamId: _streamId,\r\n  canManageBoxes,\r\n  onAddBox,\r\n  onDeductBox,\r\n  onEndBroadcast,\r\n  onMuteAll,\r\n  onKickAll,\r\n  onDisableChat,\r\n  targets,\r\n  selectedTargetId,\r\n  onTargetChange,\r\n  onMuteUser,\r\n  onDisableUserChat,\r\n  onKickUser,\r\n  onRemoveSeat,\r\n  seatBans,\r\n  onClearSeatBan,\r\n  onClose,\r\n  position,\r\n  onMouseDown\r\n}: {\r\n  streamId: string;\r\n  onAddBox: () => void;\r\n  onDeductBox: () => void;\r\n  onEndBroadcast: () => void;\r\n  onMuteAll: () => void;\r\n  onKickAll: () => void;\r\n  onDisableChat: () => void;\r\n  targets: Array<{ id: string; username: string; seatIndex?: number | null }>;\r\n  selectedTargetId: string | null;\r\n  onTargetChange: (userId: string | null) => void;\r\n  onMuteUser: (userId: string, minutes: number) => void;\r\n  onDisableUserChat: (userId: string) => void;\r\n  onKickUser: (userId: string) => void;\r\n  onRemoveSeat: (userId: string) => void;\r\n  seatBans: SeatBan[];\r\n  onClearSeatBan: (banId: string) => void;\r\n  onClose: () => void;\r\n  position: { x: number; y: number } | null;\r\n  onMouseDown: (e: React.MouseEvent) => void;\r\n  canManageBoxes: boolean;\r\n}) {\r\n  const selectedTarget = targets.find((t) => t.id === selectedTargetId) || null;\r\n  return (\r\n    <div\r\n      className=\"fixed z-[200] w-64 bg-black/90 border border-red-500/50 rounded-xl shadow-[0_0_30px_rgba(220,38,38,0.3)] backdrop-blur-xl overflow-hidden\"\r\n      style={position ? { left: position.x, top: position.y } : { bottom: 100, right: 20 }}\r\n    >\r\n      <div\r\n        className=\"bg-red-900/20 px-3 py-2 border-b border-red-500/30 flex items-center justify-between cursor-move select-none\"\r\n        onMouseDown={onMouseDown}\r\n      >\r\n        <span className=\"text-xs font-bold text-red-200 uppercase tracking-wider\">Officer Tools</span>\r\n        <button onClick={onClose} className=\"text-red-200 hover:text-white\">√ó</button>\r\n      </div>\r\n      <div className=\"p-3 grid grid-cols-2 gap-2\">\r\n        <button\r\n          onClick={onEndBroadcast}\r\n          className=\"col-span-2 bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded shadow-lg flex items-center justify-center gap-2\"\r\n        >\r\n          <span className=\"text-lg\">‚õî</span> END BROADCAST\r\n        </button>\r\n        <div className=\"col-span-2\">\r\n          <label className=\"text-[10px] uppercase tracking-[0.2em] text-white/50\">Target user</label>\r\n          <select\r\n            value={selectedTargetId || ''}\r\n            onChange={(e) => onTargetChange(e.target.value || null)}\r\n            className=\"mt-1 w-full rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white\"\r\n          >\r\n            <option value=\"\">Select user</option>\r\n            {targets.map((target) => (\r\n              <option key={target.id} value={target.id}>\r\n                {target.username}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n        {canManageBoxes && (\r\n          <>\r\n            <button\r\n              onClick={onAddBox}\r\n              className=\"bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex flex-col items-center gap-1\"\r\n            >\r\n              <span className=\"text-lg\">üì∫</span> Add Box\r\n            </button>\r\n            <button\r\n              onClick={onDeductBox}\r\n              className=\"bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex flex-col items-center gap-1\"\r\n            >\r\n              <span className=\"text-lg\">‚ûñ</span> Deduct Box\r\n            </button>\r\n          </>\r\n        )}\r\n        <button\r\n          onClick={onKickAll}\r\n          className=\"bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex flex-col items-center gap-1\"\r\n        >\r\n          <span className=\"text-lg\">üßπ</span> Clear Stage\r\n        </button>\r\n        <button\r\n          onClick={onMuteAll}\r\n          className=\"col-span-2 bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex flex-col items-center gap-1\"\r\n        >\r\n          <span className=\"text-lg\">üîá</span> Mute All\r\n        </button>\r\n        <div className=\"col-span-2 grid grid-cols-3 gap-2\">\r\n          <button\r\n            disabled={!selectedTarget}\r\n            onClick={() => selectedTarget && onMuteUser(selectedTarget.id, 5)}\r\n            className=\"bg-white/10 hover:bg-white/20 text-white text-[10px] font-bold py-2 rounded disabled:opacity-50\"\r\n          >\r\n            Mute 5m\r\n          </button>\r\n          <button\r\n            disabled={!selectedTarget}\r\n            onClick={() => selectedTarget && onMuteUser(selectedTarget.id, 15)}\r\n            className=\"bg-white/10 hover:bg-white/20 text-white text-[10px] font-bold py-2 rounded disabled:opacity-50\"\r\n          >\r\n            Mute 15m\r\n          </button>\r\n          <button\r\n            disabled={!selectedTarget}\r\n            onClick={() => selectedTarget && onMuteUser(selectedTarget.id, 30)}\r\n            className=\"bg-white/10 hover:bg-white/20 text-white text-[10px] font-bold py-2 rounded disabled:opacity-50\"\r\n          >\r\n            Mute 30m\r\n          </button>\r\n        </div>\r\n        <button\r\n          onClick={onDisableChat}\r\n          className=\"col-span-2 bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex items-center justify-center gap-2\"\r\n        >\r\n          <span className=\"text-lg\">üí¨</span> Disable Chat (Global)\r\n        </button>\r\n        <button\r\n          disabled={!selectedTarget}\r\n          onClick={() => selectedTarget && onDisableUserChat(selectedTarget.id)}\r\n          className=\"col-span-2 bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex items-center justify-center gap-2 disabled:opacity-50\"\r\n        >\r\n          <span className=\"text-lg\">üîï</span> Disable Chat (User)\r\n        </button>\r\n        <button\r\n          disabled={!selectedTarget}\r\n          onClick={() => selectedTarget && onKickUser(selectedTarget.id)}\r\n          className=\"col-span-2 bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex items-center justify-center gap-2 disabled:opacity-50\"\r\n        >\r\n          <span className=\"text-lg\">üö´</span> Kick From Stream\r\n        </button>\r\n        <button\r\n          disabled={!selectedTarget || selectedTarget?.seatIndex === undefined || selectedTarget?.seatIndex === null}\r\n          onClick={() => selectedTarget && onRemoveSeat(selectedTarget.id)}\r\n          className=\"col-span-2 bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded flex items-center justify-center gap-2 disabled:opacity-50\"\r\n        >\r\n          <span className=\"text-lg\">üì¶</span> Remove From Box\r\n        </button>\r\n        <div className=\"col-span-2 border-t border-red-500/20 pt-2 mt-1 max-h-40 overflow-y-auto\">\r\n          <div className=\"flex items-center justify-between mb-1\">\r\n            <span className=\"text-[10px] uppercase tracking-[0.2em] text-white/50\">Guest-box bans</span>\r\n            <span className=\"text-[10px] text-white/60\">{seatBans.length}</span>\r\n          </div>\r\n          {seatBans.length === 0 ? (\r\n            <p className=\"text-[11px] text-white/40\">No active bans</p>\r\n          ) : (\r\n            seatBans.slice(0, 6).map((ban) => {\r\n              const isPermanent = !ban.banned_until;\r\n              let untilLabel = 'Permanent';\r\n              if (!isPermanent) {\r\n                const date = new Date(ban.banned_until as string);\r\n                if (!isNaN(date.getTime())) {\r\n                  untilLabel = `Until ${date.toLocaleTimeString()}`;\r\n                }\r\n              }\r\n              return (\r\n                <div key={ban.id} className=\"flex items-center justify-between gap-2 py-1\">\r\n                  <div className=\"min-w-0\">\r\n                    <div className=\"text-[11px] text-white truncate\">\r\n                      {ban.username || ban.user_id.slice(0, 8)}\r\n                    </div>\r\n                    <div className=\"text-[10px] text-red-300/80 truncate\">\r\n                      {untilLabel}\r\n                    </div>\r\n                  </div>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => onClearSeatBan(ban.id)}\r\n                    className=\"px-2 py-1 rounded-md bg-red-600/80 hover:bg-red-500 text-[10px] font-bold text-white whitespace-nowrap\"\r\n                  >\r\n                    Clear\r\n                  </button>\r\n                </div>\r\n              );\r\n            })\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function LivePage() {\r\n  const { streamId } = useParams<{ streamId: string }>();\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  \r\n  const { user, profile, refreshProfile } = useAuthStore();\r\n  const { optimisticDebit } = useCoins();\r\n\r\n  useViewerTracking(streamId || null, user?.id || null);\r\n\r\n  const [joinPrice, setJoinPrice] = useState(0);\r\n  const [showTrollBattles, setShowTrollBattles] = useState(false);\r\n  const [activeBattle, setActiveBattle] = useState<{id: string, player1_id: string, player2_id: string, status: string} | null>(null);\r\n  const [boxCount, setBoxCount] = useState(0);\r\n  const [seatBans, setSeatBans] = useState<SeatBan[]>([]);\r\n  const [cameraOn, setCameraOn] = useState(false);\r\n  const [micOn, setMicOn] = useState(false);\r\n  const [cameraFacing, setCameraFacing] = useState<'user' | 'environment'>(() => {\r\n    if (typeof window === 'undefined') return 'user';\r\n    const stored = window.localStorage.getItem('tc_camera_facing');\r\n    return stored === 'environment' ? 'environment' : 'user';\r\n  });\r\n  const [hostSeatIndex, setHostSeatIndex] = useState(0);\r\n  const [showLivePanels, setShowLivePanels] = useState(true);\r\n  const [broadcastThemeStyle, setBroadcastThemeStyle] = useState<React.CSSProperties | undefined>(undefined);\r\n  const [broadcastTheme, setBroadcastTheme] = useState<any>(null);\r\n  const [reactiveEvent, setReactiveEvent] = useState<{ key: number; style: string; intensity: number } | null>(null);\r\n  const [reactiveClass, setReactiveClass] = useState('');\r\n  const [hasViewerGift, setHasViewerGift] = useState(false);\r\n  const noViewerTimerRef = useRef<number | null>(null);\r\n  const noGiftTimerRef = useRef<number | null>(null);\r\n  const autoEndTriggeredRef = useRef(false);\r\n  const [currentFrameMode, setCurrentFrameMode] = useState<'none' | 'rgb'>('none');\r\n\r\n  const stableIdentity = useMemo(() => {\r\n    const id = user?.id || profile?.id;\r\n    if (!id) console.warn('[LivePage] No stable identity found');\r\n    return id;\r\n  }, [user?.id, profile?.id]);\r\n  \r\n  const [stream, setStream] = useState<StreamRow | null>(null);\r\n  const [viewerCount, setViewerCount] = useState(0);\r\n  const [activeViewers, setActiveViewers] = useState<ActiveViewer[]>([]);\r\n  const [isViewerDropdownOpen, setIsViewerDropdownOpen] = useState(false);\r\n  const viewerDropdownRef = useRef<HTMLDivElement | null>(null);\r\n  const viewerButtonRef = useRef<HTMLButtonElement | null>(null);\r\n  const notifiedMissingFormsRef = useRef<Set<string>>(new Set());\r\n  const micRestrictionInfo = useMemo(() => {\r\n    if (!profile?.mic_muted_until) {\r\n      return { isMuted: false, message: '' };\r\n    }\r\n    const until = Date.parse(profile.mic_muted_until);\r\n    if (Number.isNaN(until) || until <= Date.now()) {\r\n      return { isMuted: false, message: '' };\r\n    }\r\n    return {\r\n      isMuted: true,\r\n      message: `Microphone disabled until ${new Date(until).toLocaleString()}`,\r\n    };\r\n  }, [profile?.mic_muted_until]);\r\n  const notifyMissingForms = useCallback(async (userId: string, missing: string[]) => {\r\n    if (!missing.length) return;\r\n    try {\r\n      await supabase.rpc('notify_user_rpc', {\r\n        p_target_user_id: userId,\r\n        p_type: 'system_alert',\r\n        p_title: 'Complete your User Forms & Compliance',\r\n        p_message: `Please finish the following sections: ${missing.join(', ')}. Visit your Profile Settings to complete them.`,\r\n      });\r\n      notifiedMissingFormsRef.current.add(userId);\r\n    } catch (err) {\r\n      console.error('Failed to notify user about compliance:', err);\r\n    }\r\n  }, []);\r\n  const [isLoadingStream, setIsLoadingStream] = useState(true);\r\n  const [privateAccessGranted, setPrivateAccessGranted] = useState(false);\r\n  const [privatePasswordInput, setPrivatePasswordInput] = useState('');\r\n  const [privateAuthError, setPrivateAuthError] = useState('');\r\n  const privateAccessStorageKey = streamId ? `private-stream-access:${streamId}` : null;\r\n  const [isCurrentUserBroadofficer, setIsCurrentUserBroadofficer] = useState(false);\r\n\r\n  const refreshBoxCountFromMessages = useCallback(\r\n    async (id: string) => {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('messages')\r\n          .select('content')\r\n          .eq('stream_id', id)\r\n          .eq('message_type', 'system')\r\n          .like('content', 'BOX_COUNT_UPDATE:%')\r\n          .order('created_at', { ascending: false })\r\n          .limit(1);\r\n\r\n        if (error || !data || data.length === 0) return;\r\n\r\n        const content = data[0]?.content as string | null;\r\n        if (!content || typeof content !== 'string') return;\r\n\r\n        const parts = content.split(':');\r\n        if (parts.length < 2) return;\r\n        const parsed = parseInt(parts[1], 10);\r\n        if (Number.isNaN(parsed)) return;\r\n\r\n        const maxBoxes = 5;\r\n        const next = Math.max(0, Math.min(maxBoxes, parsed));\r\n        setBoxCount(next === 0 ? 5 : next);\r\n      } catch (err) {\r\n        console.error('Failed to refresh box count from messages:', err);\r\n      }\r\n    },\r\n    [setBoxCount]\r\n  );\r\n\r\n  // Save stream to session storage for persistence\r\n  useEffect(() => {\r\n    if (stream) {\r\n      try {\r\n        sessionStorage.setItem(\"activeStream\", JSON.stringify(stream));\r\n      } catch (e) {\r\n        console.warn('Failed to save stream to sessionStorage', e);\r\n      }\r\n    }\r\n  }, [stream]);\r\n\r\n  useEffect(() => {\r\n    if (!isViewerDropdownOpen || typeof window === 'undefined') return;\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (viewerDropdownRef.current?.contains(event.target as Node)) return;\r\n      if (viewerButtonRef.current?.contains(event.target as Node)) return;\r\n      setIsViewerDropdownOpen(false);\r\n    };\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleClickOutside);\r\n    };\r\n  }, [isViewerDropdownOpen]);\r\n  \r\n  const seatRoomName = stream?.room_name || stream?.agora_channel || streamId || 'officer-stream';\r\n  const isBroadcaster = useIsBroadcaster(profile, stream);\r\n  const isRoleExempt = useMemo(() => {\r\n    if (profile?.is_admin) return true;\r\n    const role = (profile?.troll_role || profile?.role || '').toLowerCase();\r\n    return ['admin', 'lead_troll_officer', 'secretary', 'pastor', 'troll_officer'].includes(role);\r\n  }, [profile?.role, profile?.troll_role, profile?.is_admin]);\r\n  const { seats, claimSeat, releaseSeat } = useSeatRoster(seatRoomName);\r\n  const isGuestSeat = !isBroadcaster && seats.some(seat => seat?.user_id === user?.id);\r\n  const canPublish = isBroadcaster || isGuestSeat;\r\n  const canModerateGuests = isBroadcaster || isCurrentUserBroadofficer;\r\n\r\n\r\n  \r\n  const liveKit = useLiveKit();\r\n\r\n\r\n    \r\n\r\n\r\n  useEffect(() => {\r\n    const broadcasterId = stream?.broadcaster_id;\r\n    if (!broadcasterId) return;\r\n    let isActive = true;\r\n\r\n    const loadTheme = async () => {\r\n      const { data: state } = await supabase\r\n        .from('user_broadcast_theme_state')\r\n        .select('active_theme_id')\r\n        .eq('user_id', broadcasterId)\r\n        .maybeSingle();\r\n\r\n      if (!isActive) return;\r\n      if (!state?.active_theme_id) {\r\n        setBroadcastThemeStyle(undefined);\r\n        setBroadcastTheme(null);\r\n        setLastThemeId(null);\r\n        return;\r\n      }\r\n\r\n      const { data: theme } = await supabase\r\n        .from('broadcast_background_themes')\r\n        .select('id, asset_type, video_webm_url, video_mp4_url, image_url, background_css, background_asset_url, reactive_enabled, reactive_style, reactive_intensity')\r\n        .eq('id', state.active_theme_id)\r\n        .maybeSingle();\r\n\r\n      if (!isActive) return;\r\n      if (!theme) {\r\n        setBroadcastThemeStyle(undefined);\r\n        setBroadcastTheme(null);\r\n        setLastThemeId(null);\r\n        return;\r\n      }\r\n\r\n      if (theme.background_css) {\r\n        // Strip trailing semicolons to avoid React warnings\r\n        const cleanBackground = theme.background_css.trim().replace(/;+$/, '');\r\n        setBroadcastThemeStyle({ background: cleanBackground });\r\n        setBroadcastTheme(theme);\r\n        setLastThemeId(theme.id || null);\r\n        return;\r\n      }\r\n      if (theme.background_asset_url) {\r\n        setBroadcastThemeStyle({\r\n          backgroundImage: `url(${theme.background_asset_url})`,\r\n          backgroundSize: 'cover',\r\n          backgroundPosition: 'center',\r\n          backgroundRepeat: 'no-repeat'\r\n        });\r\n        setBroadcastTheme(theme);\r\n        setLastThemeId(theme.id || null);\r\n        return;\r\n      }\r\n      if (theme.image_url) {\r\n        setBroadcastThemeStyle({\r\n          backgroundImage: `url(${theme.image_url})`,\r\n          backgroundSize: 'cover',\r\n          backgroundPosition: 'center',\r\n          backgroundRepeat: 'no-repeat'\r\n        });\r\n        setBroadcastTheme(theme);\r\n        setLastThemeId(theme.id || null);\r\n        return;\r\n      }\r\n      setBroadcastThemeStyle(undefined);\r\n      setBroadcastTheme(theme);\r\n      setLastThemeId(theme.id || null);\r\n    };\r\n\r\n    loadTheme();\r\n    return () => {\r\n      isActive = false;\r\n    };\r\n  }, [stream?.broadcaster_id]);\r\n\r\n  useEffect(() => {\r\n    if (!reactiveEvent?.key) return;\r\n    const style = reactiveEvent.style || 'pulse';\r\n    const intensity = Math.max(1, Math.min(5, reactiveEvent.intensity || 2));\r\n    const nextClass = `theme-reactive-${style} theme-reactive-intensity-${intensity}`;\r\n    setReactiveClass(nextClass);\r\n    const timer = window.setTimeout(() => setReactiveClass(''), 900);\r\n    return () => window.clearTimeout(timer);\r\n  }, [reactiveEvent?.key, reactiveEvent?.style, reactiveEvent?.intensity]);\r\n\r\n  // Sync UI state with broadcaster role (auto-publish)\r\n  useEffect(() => {\r\n    if (isBroadcaster) {\r\n      setCameraOn(true);\r\n      setMicOn(true);\r\n    }\r\n  }, [isBroadcaster]);\r\n\r\n  // 1. Room name derivation: prefer agora_channel (set by GoLive), then room_name, fallback to stream_{id}\r\n  const roomName = useMemo(() => {\r\n    if (stream?.agora_channel) return stream.agora_channel;\r\n    if (stream?.room_name) return stream.room_name;\r\n    // GoLive sets agora_channel to streamId. BroadcastPage uses streamId.\r\n    // If neither is present, falling back to streamId is safer than stream_{id} to match BroadcastPage.\r\n    return streamId || ''; \r\n  }, [stream?.agora_channel, stream?.room_name, streamId]);\r\n\r\n  const hasValidStreamId = !!streamId && typeof streamId === 'string' && streamId.trim() !== '';\r\n  const sessionReady = !!user && !!profile && hasValidStreamId && !!roomName;\r\n\r\n\r\n  const officerRoleNames = ['admin', 'lead_troll_officer', 'troll_officer', 'secretary', 'pastor'];\r\n  const isOfficerUser = Boolean(\r\n    profile &&\r\n      (officerRoleNames.includes(profile.role || '') ||\r\n        profile.is_admin ||\r\n        profile.is_lead_officer ||\r\n        profile.is_troll_officer)\r\n  );\r\n\r\n  // Combined check: is staff OR (is broadofficer AND assigned to this broadcast) - used for OfficerActionBubble visibility\r\n  const canUseOfficerTools = useMemo(() => {\r\n    if (isBroadcaster) return true;\r\n    if (isOfficerUser) return true; // Staff always have access\r\n    if (isCurrentUserBroadofficer) return true; // Broadofficer only if assigned to this broadcast\r\n    return false;\r\n  }, [isBroadcaster, isOfficerUser, isCurrentUserBroadofficer]);\r\n\r\n  // Can manage boxes: Broadcaster, broadofficer, OR staff (admin/secretary/pastor/officers)\r\n  const canManageBoxes = useMemo(() => {\r\n    return isBroadcaster || isCurrentUserBroadofficer || isOfficerUser;\r\n  }, [isBroadcaster, isCurrentUserBroadofficer, isOfficerUser]);\r\n\r\n  const loadSeatBans = useCallback(async () => {\r\n    if (!isOfficerUser || !seatRoomName) return;\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('broadcast_seat_bans')\r\n        .select('id,user_id,banned_until,created_at,reason')\r\n        .eq('room', seatRoomName)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) {\r\n        console.error('Failed to load seat bans', error);\r\n        return;\r\n      }\r\n\r\n      const rows = (data as any[]) || [];\r\n      const userIds = Array.from(\r\n        new Set(\r\n          rows\r\n            .map((row) => row.user_id as string | null)\r\n            .filter((id): id is string => Boolean(id))\r\n        )\r\n      );\r\n\r\n      const usernameMap = new Map<string, string | null>();\r\n      if (userIds.length > 0) {\r\n        const { data: profiles } = await supabase\r\n          .from('user_profiles')\r\n          .select('id,username')\r\n          .in('id', userIds);\r\n        (profiles as any[] | null | undefined)?.forEach((p) => {\r\n          usernameMap.set(p.id as string, (p.username as string | null) ?? null);\r\n        });\r\n      }\r\n\r\n      const enriched: SeatBan[] = rows.map((row) => {\r\n        const userId = row.user_id as string;\r\n        return {\r\n          id: row.id as string,\r\n          user_id: userId,\r\n          banned_until: (row.banned_until as string | null) ?? null,\r\n          created_at: row.created_at as string,\r\n          reason: (row.reason as string | null) ?? null,\r\n          username: usernameMap.get(userId) ?? null,\r\n        };\r\n      });\r\n\r\n      setSeatBans(enriched);\r\n    } catch (err) {\r\n      console.error('Failed to load seat bans', err);\r\n    }\r\n  }, [isOfficerUser, seatRoomName]);\r\n\r\n  useEffect(() => {\r\n    if (!isOfficerUser || !seatRoomName) return;\r\n    let cancelled = false;\r\n\r\n    loadSeatBans();\r\n\r\n    const channel = supabase\r\n      .channel(`broadcast-seat-bans-${seatRoomName}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'broadcast_seat_bans',\r\n          filter: `room=eq.${seatRoomName}`,\r\n        },\r\n        () => {\r\n          if (!cancelled) {\r\n            loadSeatBans();\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      cancelled = true;\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [isOfficerUser, seatRoomName, loadSeatBans]);\r\n\r\n  const [seatActionTarget, setSeatActionTarget] = useState<{\r\n    userId: string\r\n    username?: string\r\n    role?: string\r\n    seatIndex: number\r\n    isOfficer?: boolean\r\n  } | null>(null);\r\n\r\n  useEffect(() => {\r\n    setSeatActionTarget(null);\r\n  }, [streamId]);\r\n\r\n  const livekitIdentity = useMemo(() => {\r\n    const id = stableIdentity;\r\n    if (!id) console.warn('[LivePage] No identity found for LiveKit');\r\n    return id;\r\n  }, [stableIdentity]);\r\n\r\n  // Token Management\r\n  const { \r\n    token, \r\n    serverUrl, \r\n    identity: tokenIdentity, \r\n    roomName: tokenRoomName, \r\n    ready: tokenReady,\r\n    error: tokenError\r\n  } = useLiveKitToken({\r\n    streamId,\r\n    isHost: canPublish,\r\n    userId: user?.id,\r\n    roomName: roomName,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (tokenError) {\r\n      console.error('[LivePage] Token fetch error:', tokenError);\r\n    }\r\n  }, [tokenError]);\r\n\r\n  const needsPrivateGate = Boolean(stream?.is_private && stream?.broadcaster_id && stream?.broadcaster_id !== user?.id);\r\n  const streamLoaded = Boolean(stream?.id);\r\n  const canAccessPrivate = !needsPrivateGate || privateAccessGranted;\r\n  const canConnect = tokenReady && !!token && !!serverUrl && !!user?.id && !!roomName && streamLoaded && canAccessPrivate;\r\n\r\n  const joinLogRef = useRef(false);\r\n\r\n  // Logging for verification (only once when we can first connect)\r\n  useEffect(() => {\r\n    if (canConnect && !joinLogRef.current) {\r\n      joinLogRef.current = true;\r\n      console.log('[LivePage] Joining session:', {\r\n        streamId,\r\n        broadcaster_id: stream?.broadcaster_id,\r\n        isBroadcaster,\r\n        roomName: tokenRoomName || roomName,\r\n        auth_uid: user?.id,\r\n        identity: tokenIdentity || livekitIdentity,\r\n        token: !!token\r\n      });\r\n    }\r\n  }, [canConnect, streamId, stream?.broadcaster_id, isBroadcaster, roomName, tokenRoomName, user?.id, livekitIdentity, tokenIdentity, token]);\r\n\r\n  const {\r\n    isConnected,\r\n    resetJoinGuard,\r\n  } = useLiveKitSession({\r\n    roomName: tokenRoomName || (sessionReady ? roomName : ''),\r\n    user: sessionReady && user\r\n      ? { ...user, identity: tokenIdentity || livekitIdentity, role: isBroadcaster ? 'broadcaster' : (canPublish ? 'guest' : 'viewer') }\r\n      : null,\r\n    role: isBroadcaster ? 'broadcaster' : (canPublish ? 'guest' : 'viewer'),\r\n    allowPublish: canPublish && sessionReady,\r\n    autoPublish: canPublish, // Enable autoPublish for guests too when allowed\r\n    token: token || undefined,\r\n    serverUrl: serverUrl || undefined,\r\n    connect: canConnect,\r\n    identity: tokenIdentity || livekitIdentity\r\n  });\r\n\r\n  const handleDisableGuestMedia = useCallback(\r\n    async (participantId: string, disableVideo = true, disableAudio = true) => {\r\n      if (!canModerateGuests) return;\r\n      await liveKit.disableGuestMedia(participantId, disableVideo, disableAudio);\r\n    },\r\n    [canModerateGuests, liveKit]\r\n  );\r\n\r\n  const publishUpgradeRef = useRef(false);\r\n\r\n  const handleLeaveSession = useCallback(async () => {\r\n    const seatIndex = seats.findIndex(seat => seat?.user_id === user?.id);\r\n    if (seatIndex >= 0) {\r\n      await releaseSeat(seatIndex);\r\n    }\r\n    \r\n    // Disable media\r\n    if (cameraOn) {\r\n       await liveKit.toggleCamera();\r\n       setCameraOn(false);\r\n       // Explicitly stop all video tracks to turn off the hardware light\r\n       if (liveKit.localParticipant?.videoTrack?.track) {\r\n         liveKit.localParticipant.videoTrack.track.stop();\r\n       }\r\n    }\r\n    if (micOn) {\r\n       await liveKit.toggleMicrophone();\r\n       setMicOn(false);\r\n       // Explicitly stop audio tracks too just in case\r\n       if (liveKit.localParticipant?.audioTrack?.track) {\r\n         liveKit.localParticipant.audioTrack.track.stop();\r\n       }\r\n    }\r\n    \r\n    toast.info(\"You have left the guest box\");\r\n  }, [liveKit, cameraOn, micOn, releaseSeat, seats, user?.id]);\r\n\r\n  // Ensure camera/mic are stopped when unmounting (e.g. redirecting when broadcast ends)\r\n  useEffect(() => {\r\n    return () => {\r\n      if (liveKit.localParticipant) {\r\n        liveKit.localParticipant.videoTrack?.track?.stop();\r\n        liveKit.localParticipant.audioTrack?.track?.stop();\r\n      }\r\n    };\r\n  }, [liveKit]);\r\n\r\n  // Ref tracking for cleanup\r\n  const seatsRef = useRef(seats);\r\n  const userRef = useRef(user);\r\n  const releaseSeatRef = useRef(releaseSeat);\r\n  const isBroadcasterRef = useRef(isBroadcaster);\r\n\r\n  useEffect(() => {\r\n    seatsRef.current = seats;\r\n    userRef.current = user;\r\n    releaseSeatRef.current = releaseSeat;\r\n    isBroadcasterRef.current = isBroadcaster;\r\n  }, [seats, user, releaseSeat, isBroadcaster]);\r\n\r\n  // Cleanup seat on unmount to prevent auto-joining on return\r\n  useEffect(() => {\r\n    return () => {\r\n      const currentSeats = seatsRef.current;\r\n      const currentUser = userRef.current;\r\n      const release = releaseSeatRef.current;\r\n      const isBroadcasterVal = isBroadcasterRef.current;\r\n\r\n      if (!isBroadcasterVal && currentUser?.id) {\r\n        const index = currentSeats.findIndex(s => s?.user_id === currentUser.id);\r\n        if (index >= 0) {\r\n          console.log('[LivePage] Cleaning up seat on unmount');\r\n          release(index).catch(err => console.error('Failed to release seat on unmount', err));\r\n        }\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // Billing Heartbeat (Server-Side Billing Implementation)\r\n  useEffect(() => {\r\n    if (!streamId || !user?.id || (!isBroadcaster && !isGuestSeat)) return;\r\n    // Only run if stream is effectively live or we are in a box\r\n    // Broadcaster pays for being live. Guests pay for being in box.\r\n\r\n    const runBilling = async () => {\r\n      try {\r\n        const { data, error } = await supabase.rpc('process_stream_billing', {\r\n          p_stream_id: streamId,\r\n          p_user_id: user.id,\r\n          p_is_host: isBroadcaster\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Billing] RPC error:', error);\r\n          return;\r\n        }\r\n\r\n        if (data?.status === 'stop') {\r\n          console.warn('[Billing] Stopped:', data.reason);\r\n          toast.error(data.reason || 'Insufficient funds');\r\n          \r\n          if (isBroadcaster) {\r\n             // If broadcaster runs out of funds, stop the stream\r\n             toast.error('Stream ending due to insufficient funds.');\r\n             // Trigger end stream flow\r\n             // We can't easily call onEndBroadcast from here as it's inside OfficerActionBubble\r\n             // But we can trigger the end stream API\r\n             // For now, just notify user.\r\n          } else {\r\n             // Guest runs out of funds\r\n             handleLeaveSession();\r\n          }\r\n        } else if (data?.remaining !== undefined) {\r\n          // Optional: update local coin balance if desired\r\n          // refreshProfile(); // Might be too heavy to call every minute\r\n        }\r\n      } catch (err) {\r\n        console.error('[Billing] execution error:', err);\r\n      }\r\n    };\r\n\r\n    // Run immediately on mount/state change if condition met? \r\n    // No, we charge per minute. \r\n    // But we should probably charge \"on entry\" (handled by join logic) and then \"every minute\".\r\n    // For broadcaster, they pay per minute.\r\n    \r\n    const interval = setInterval(runBilling, 60000); \r\n    return () => clearInterval(interval);\r\n  }, [streamId, user?.id, isBroadcaster, isGuestSeat, handleLeaveSession]);\r\n\r\n  const handleSetPrice = async (price: number) => {\r\n    try {\r\n      // 1. Update DB first so RPC sees correct price\r\n      const { error } = await supabase\r\n        .from('streams')\r\n        .update({ box_price_amount: price })\r\n        .eq('id', streamId);\r\n\r\n      if (error) throw error;\r\n\r\n      setJoinPrice(price);\r\n      \r\n      // 2. Broadcast price to viewers via system message\r\n      await supabase.from('messages').insert({\r\n        stream_id: streamId,\r\n        user_id: user?.id,\r\n        message_type: 'system',\r\n        content: `PRICE_UPDATE:${price}`\r\n      });\r\n      \r\n      toast.success(`Join price set to ${price} coins`);\r\n    } catch (err) {\r\n      console.error('Failed to update box price:', err);\r\n      toast.error('Failed to update price');\r\n    }\r\n  };\r\n\r\n  const handleFrameModeChange = useCallback(async (mode: 'none' | 'rgb') => {\r\n    if (!streamId) return;\r\n    setCurrentFrameMode(mode); // Optimistic update\r\n    try {\r\n      await supabase.from('streams').update({ frame_mode: mode }).eq('id', streamId);\r\n    } catch (err) {\r\n      console.error('Failed to update frame mode', err);\r\n      toast.error('Failed to update frame mode');\r\n    }\r\n  }, [streamId]);\r\n\r\n  const handleAlertOfficers = useCallback(\r\n    async (targetUserId?: string) => {\r\n      if (!streamId) return;\r\n      try {\r\n        let targetUsername: string | undefined;\r\n        if (targetUserId) {\r\n          const { data: targetProfile } = await supabase\r\n            .from('user_profiles')\r\n            .select('username')\r\n            .eq('id', targetUserId)\r\n            .single();\r\n          targetUsername = targetProfile?.username || undefined;\r\n        }\r\n\r\n        const reporterId = profile?.id || user?.id || null;\r\n        let reporterUsername: string | undefined = profile?.username;\r\n\r\n        if (!reporterUsername && reporterId) {\r\n          const { data: reporterProfile } = await supabase\r\n            .from('user_profiles')\r\n            .select('username')\r\n            .eq('id', reporterId)\r\n            .single();\r\n          reporterUsername = reporterProfile?.username || undefined;\r\n        }\r\n\r\n        const { data: officers } = await supabase\r\n          .from('user_profiles')\r\n          .select('id, username, role, is_officer')\r\n          .in('role', ['troll_officer', 'lead_troll_officer', 'admin']);\r\n\r\n        const baseMessage = targetUserId\r\n          ? `Alert in stream ${streamId} involving @${targetUsername || targetUserId}`\r\n          : `Alert in stream ${streamId}`;\r\n\r\n        const messageWithReporter =\r\n          reporterUsername && reporterId\r\n            ? `${baseMessage} (reported by @${reporterUsername})`\r\n            : baseMessage;\r\n\r\n        const list = (officers || []).map((o) => ({\r\n          user_id: o.id,\r\n          type: 'officer_update' as const,\r\n          title: 'Stream Moderation Alert',\r\n          message: messageWithReporter,\r\n          metadata: {\r\n            stream_id: streamId,\r\n            target_user_id: targetUserId,\r\n            target_username: targetUsername,\r\n            reporter_id: reporterId,\r\n            reporter_username: reporterUsername,\r\n            link: `/live/${streamId}?source=officer_alert`\r\n          }\r\n        }));\r\n\r\n        if (list.length > 0) {\r\n          await supabase.from('notifications').insert(list);\r\n          toast.success('Alert sent to troll officers');\r\n\r\n          // Send push notifications to officers\r\n          try {\r\n            await supabase.functions.invoke('send-push-notification', {\r\n              body: {\r\n                user_ids: list.map((n) => n.user_id),\r\n                title: 'Stream Moderation Alert',\r\n                body: messageWithReporter,\r\n                url: `/live/${streamId}?source=officer_alert`,\r\n                create_db_notification: false,\r\n              },\r\n            });\r\n          } catch (err) {\r\n            console.warn('Failed to send push to officers', err);\r\n          }\r\n        } else {\r\n          toast.info('No officers found to notify');\r\n        }\r\n      } catch (err) {\r\n        console.error('Failed to alert officers', err);\r\n        toast.error('Failed to alert officers');\r\n      }\r\n    },\r\n    [streamId, profile?.id, profile?.username, user?.id]\r\n  );\r\n\r\n  const handleJoinRequest = async (seatIndex: number) => {\r\n    if (canPublish) {\r\n        if (!cameraOn) {\r\n          liveKit.toggleCamera().then((ok) => {\r\n            if (ok) setCameraOn(true);\r\n          });\r\n        }\r\n        if (!micOn) {\r\n          liveKit.toggleMicrophone().then((ok) => {\r\n            if (ok) setMicOn(true);\r\n          });\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (!user?.id || !stream?.broadcaster_id || !streamId) {\r\n      toast.error('Unable to join right now.');\r\n      return;\r\n    }\r\n\r\n    let joinPriceForClaim = joinPrice;\r\n    \r\n    // Officers join for free (skip payment and set price to 0)\r\n    if (isOfficerUser) {\r\n      joinPriceForClaim = 0;\r\n    } else if (joinPrice > 0) {\r\n      const confirmed = confirm(`Join the stream for ${joinPrice} coins?`);\r\n      if (!confirmed) return;\r\n\r\n      try {\r\n        // Use the new join_stream_box RPC which handles billing and guest tracking atomically\r\n        const { data: joinResult, error: joinError } = await supabase.rpc('join_stream_box', {\r\n          p_stream_id: streamId,\r\n          p_user_id: user?.id\r\n        });\r\n\r\n        if (joinError) throw joinError;\r\n        \r\n        // Check logical success from RPC JSON response\r\n        if (joinResult && joinResult.success === false) {\r\n           throw new Error(joinResult.error || 'Failed to join box');\r\n        }\r\n\r\n        joinPriceForClaim = 0; // Already paid via RPC\r\n        toast.success('Joined guest box!');\r\n      } catch (err: any) {\r\n        console.error('Join fee failed:', err);\r\n        toast.error(err?.message || 'Transaction failed');\r\n        return;\r\n      }\r\n    }\r\n\r\n    try {\r\n      await claimSeat(seatIndex, { joinPrice: joinPriceForClaim });\r\n    } catch (err: any) {\r\n      console.error('Failed to claim seat:', err);\r\n      toast.error(err?.message || 'Failed to join seat');\r\n    }\r\n  };\r\n\r\n  const handleSeatAction = async (params: { seatIndex: number; seat: any; participant?: any }) => {\r\n    const { seatIndex, seat } = params\r\n    if (!isOfficerUser || !seat?.user_id) return;\r\n\r\n    let isOfficer = false;\r\n    if (stream?.broadcaster_id) {\r\n       const { data } = await supabase.rpc('is_broadofficer', {\r\n         p_broadcaster_id: stream.broadcaster_id,\r\n         p_user_id: seat.user_id\r\n       });\r\n       isOfficer = !!data;\r\n    }\r\n    if (seat.role && ['admin', 'lead_troll_officer', 'troll_officer'].includes(seat.role)) {\r\n        isOfficer = true;\r\n    }\r\n\r\n    setSeatActionTarget({\r\n      userId: seat.user_id,\r\n      username: seat.username,\r\n      role: seat.role,\r\n      seatIndex,\r\n      isOfficer\r\n    });\r\n  };\r\n\r\n  const closeSeatActionMenu = () => {\r\n    setSeatActionTarget(null);\r\n  };\r\n\r\n  const handleSeatGift = () => {\r\n    if (!seatActionTarget) return;\r\n    setGiftReceiver({ id: seatActionTarget.userId, username: seatActionTarget.username || '' });\r\n    setIsGiftModalOpen(true);\r\n    closeSeatActionMenu();\r\n  };\r\n\r\n  const handleSeatKick = async () => {\r\n    if (!seatActionTarget) return;\r\n    try {\r\n      await releaseSeat(seatActionTarget.seatIndex, seatActionTarget.userId, { force: true });\r\n      toast.success('Guest removed from seat');\r\n      closeSeatActionMenu();\r\n    } catch (err) {\r\n      console.error('Failed to remove guest from seat', err);\r\n      toast.error('Failed to remove guest from seat');\r\n    }\r\n  };\r\n\r\n  const handleSeatReport = () => {\r\n    if (!seatActionTarget) return;\r\n    handleAlertOfficers(seatActionTarget.userId);\r\n    toast.info('Officers alerted');\r\n    closeSeatActionMenu();\r\n  };\r\n\r\n  const handleSeatFollow = () => {\r\n    if (!seatActionTarget) return;\r\n    toast.success(`Follow request sent to ${seatActionTarget.username || 'user'}`);\r\n    closeSeatActionMenu();\r\n  };\r\n\r\n  const handleSeatSummon = () => {\r\n    if (!seatActionTarget) return;\r\n    handleAlertOfficers(seatActionTarget.userId);\r\n    toast.success('Summon request sent');\r\n    closeSeatActionMenu();\r\n  };\r\n\r\n  useEffect(() => {\r\n    const handleOpenGiftMenu = () => setIsGiftModalOpen(true);\r\n    window.addEventListener('open-gift-menu', handleOpenGiftMenu);\r\n    return () => window.removeEventListener('open-gift-menu', handleOpenGiftMenu);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!canPublish) {\r\n      publishUpgradeRef.current = false;\r\n      return;\r\n    }\r\n    if (isBroadcaster || !tokenReady || !serverUrl || !isConnected) return;\r\n    if (publishUpgradeRef.current) return;\r\n    publishUpgradeRef.current = true;\r\n    resetJoinGuard();\r\n    liveKit.disconnect();\r\n\r\n    // Auto-enable camera/mic state since we are upgrading to publisher\r\n    setCameraOn(true);\r\n    setMicOn(true);\r\n  }, [canPublish, isBroadcaster, tokenReady, serverUrl, isConnected, resetJoinGuard, liveKit]);\r\n\r\n\r\n  // Officer tracking for broadcasters\r\n  useOfficerBroadcastTracking({\r\n    streamId: isBroadcaster ? streamId : undefined,\r\n    connected: isConnected,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (isConnected) {\r\n      const room = liveKit.getRoom();\r\n      attachLiveKitDebug(room);\r\n    }\r\n  }, [isConnected, liveKit]);\r\n\r\n  // Controls\r\n\r\n  const toggleCamera = useCallback(async () => {\r\n    const ok = await liveKit.toggleCamera();\r\n    const next = Boolean(ok);\r\n    setCameraOn(next);\r\n    console.log('[LivePage] Camera toggled', {\r\n      cameraOn: next,\r\n      hostSeatIndex,\r\n    });\r\n  }, [liveKit, hostSeatIndex]);\r\n\r\n  const switchCameraFacing = useCallback(async () => {\r\n    const nextFacing: 'user' | 'environment' = cameraFacing === 'user' ? 'environment' : 'user';\r\n\r\n    if (!cameraOn) {\r\n      setCameraFacing(nextFacing);\r\n      if (typeof window !== 'undefined') {\r\n        window.localStorage.setItem('tc_camera_facing', nextFacing);\r\n      }\r\n      toast.success(nextFacing === 'user' ? 'Front camera will be used next time' : 'Rear camera will be used next time');\r\n      return;\r\n    }\r\n\r\n    if (typeof navigator === 'undefined' || !navigator.mediaDevices?.enumerateDevices) {\r\n      toast.error('Camera switching not supported on this device');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const devices = await navigator.mediaDevices.enumerateDevices();\r\n      const videoInputs = devices.filter((d) => d.kind === 'videoinput');\r\n      if (!videoInputs.length) {\r\n        toast.error('No cameras found');\r\n        return;\r\n      }\r\n\r\n      const matchLabel = (label: string, facing: 'user' | 'environment') => {\r\n        const l = label.toLowerCase();\r\n        if (facing === 'user') {\r\n          return l.includes('front') || l.includes('user') || l.includes('self') || l.includes('face');\r\n        }\r\n        return l.includes('back') || l.includes('rear') || l.includes('environment') || l.includes('world');\r\n      };\r\n\r\n      let target = videoInputs.find((d) => matchLabel(d.label || '', nextFacing));\r\n      if (!target) {\r\n        target = videoInputs.length > 1 ? videoInputs[1] : videoInputs[0];\r\n      }\r\n\r\n      let switched = false;\r\n\r\n      if (liveKit.service && (liveKit.service as any).selectCamera) {\r\n        const ok = await (liveKit.service as any).selectCamera(target.deviceId);\r\n        if (ok) {\r\n          switched = true;\r\n        }\r\n      }\r\n\r\n      if (!switched) {\r\n        if (typeof window !== 'undefined') {\r\n          window.localStorage.setItem('tc_camera_facing', nextFacing);\r\n        }\r\n        const firstToggle = await liveKit.toggleCamera();\r\n        if (firstToggle) {\r\n          const secondToggle = await liveKit.toggleCamera();\r\n          if (secondToggle) {\r\n            switched = true;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!switched) {\r\n        toast.error('Camera switch failed');\r\n        return;\r\n      }\r\n\r\n      setCameraFacing(nextFacing);\r\n      if (typeof window !== 'undefined') {\r\n        window.localStorage.setItem('tc_camera_facing', nextFacing);\r\n      }\r\n      toast.success(nextFacing === 'user' ? 'Front camera selected' : 'Rear camera selected');\r\n    } catch (err) {\r\n      console.error('Camera switch failed', err);\r\n      toast.error('Camera switch failed');\r\n    }\r\n  }, [cameraFacing, cameraOn, liveKit]);\r\n\r\n  // Officer Tool Handlers\r\n  const [isOfficerBubbleVisible, setIsOfficerBubbleVisible] = useState(true);\r\n  const [officerBubblePos, setOfficerBubblePos] = useState<{ x: number; y: number } | null>(null);\r\n  const officerBubbleDraggingRef = useRef(false);\r\n  const officerBubbleDragOffsetRef = useRef<{ x: number; y: number }>({ x: 0, y: 0 });\r\n\r\n  const handleOfficerDragStart = useCallback((e: React.MouseEvent) => {\r\n    e.preventDefault();\r\n    if (typeof window === 'undefined') return;\r\n    \r\n    // Default position (bottom right) if not set\r\n    const startPos = officerBubblePos || { x: window.innerWidth - 300, y: window.innerHeight - 300 };\r\n    \r\n    officerBubbleDraggingRef.current = true;\r\n    officerBubbleDragOffsetRef.current = {\r\n      x: e.clientX - startPos.x,\r\n      y: e.clientY - startPos.y\r\n    };\r\n\r\n    const handleMove = (ev: MouseEvent) => {\r\n      if (!officerBubbleDraggingRef.current) return;\r\n      setOfficerBubblePos({\r\n        x: ev.clientX - officerBubbleDragOffsetRef.current.x,\r\n        y: ev.clientY - officerBubbleDragOffsetRef.current.y\r\n      });\r\n    };\r\n\r\n    const handleUp = () => {\r\n      officerBubbleDraggingRef.current = false;\r\n      window.removeEventListener('mousemove', handleMove);\r\n      window.removeEventListener('mouseup', handleUp);\r\n    };\r\n\r\n    window.addEventListener('mousemove', handleMove);\r\n    window.addEventListener('mouseup', handleUp);\r\n  }, [officerBubblePos]);\r\n\r\n  const handleOfficerDoubleClick = useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (!isOfficerUser) return;\r\n      if (typeof window === 'undefined') return;\r\n\r\n      const margin = 320;\r\n      const x = Math.min(e.clientX, window.innerWidth - margin);\r\n      const y = Math.min(e.clientY, window.innerHeight - margin);\r\n\r\n      setOfficerBubblePos({ x, y });\r\n      setIsOfficerBubbleVisible(true);\r\n    },\r\n    [isOfficerUser]\r\n  );\r\n\r\n  const handleOfficerEndBroadcast = async () => {\r\n      if (!confirm('OFFICER ACTION: Force END this broadcast?')) return;\r\n      try {\r\n        await supabase.from('streams').update({ status: 'ended', is_live: false, ended_at: new Date().toISOString() }).eq('id', streamId);\r\n        if (streamId) {\r\n          const channel = supabase.channel(`stream-${streamId}`);\r\n          await channel.subscribe();\r\n          await channel.send({\r\n            type: 'broadcast',\r\n            event: 'stream-ended',\r\n            payload: { streamId }\r\n          });\r\n          supabase.removeChannel(channel);\r\n        }\r\n        // Force disconnect the broadcaster's LiveKit connection\r\n        if (liveKit.getRoom()) {\r\n          liveKit.disconnect();\r\n        }\r\n        toast.success('Broadcast ended by Officer');\r\n        // Navigate to stream ended page\r\n        setTimeout(() => navigate('/stream-ended'), 1000);\r\n      } catch { toast.error('Failed to end broadcast'); }\r\n  };\r\n  \r\n  const handleOfficerMuteAll = async () => {\r\n      if(!confirm('OFFICER ACTION: Mute all participants?')) return;\r\n      try {\r\n        const until = new Date(Date.now() + 10 * 60 * 1000).toISOString();\r\n        await supabase\r\n          .from('streams_participants')\r\n          .update({ can_chat: false, chat_mute_until: until })\r\n          .eq('stream_id', streamId);\r\n        toast.success('All participants muted for 10 minutes');\r\n      } catch (err) {\r\n        console.error('Failed to mute all participants', err);\r\n        toast.error('Failed to mute all participants');\r\n      }\r\n  };\r\n\r\n  const handleOfficerDisableChat = async () => {\r\n       if(!confirm('OFFICER ACTION: Disable chat globally?')) return;\r\n       try {\r\n         await supabase\r\n           .from('streams_participants')\r\n           .update({ can_chat: false, chat_mute_until: null })\r\n           .eq('stream_id', streamId);\r\n         toast.success('Chat disabled for all participants');\r\n       } catch (err) {\r\n         console.error('Failed to disable chat globally', err);\r\n         toast.error('Failed to disable chat globally');\r\n       }\r\n  };\r\n  \r\n  const handleOfficerKickAll = () => {\r\n      if(!confirm('OFFICER ACTION: Clear the stage (remove all boxes)?')) return;\r\n      setBoxCount(0);\r\n      if (streamId) {\r\n        void supabase.from('messages').insert({\r\n          stream_id: streamId,\r\n          message_type: 'system',\r\n          content: 'BOX_COUNT_UPDATE:0'\r\n        });\r\n      }\r\n      seats.forEach((seat, index) => {\r\n        if (seat?.user_id) {\r\n          void releaseSeat(index, seat.user_id, { force: true });\r\n        }\r\n      });\r\n      toast.success('Stage cleared');\r\n  };\r\n  \r\n  const syncBoxCount = useCallback((next: number) => {\r\n    const maxBoxes = 5;\r\n    const clamped = Math.max(0, Math.min(maxBoxes, next));\r\n    setBoxCount(clamped);\r\n    if (streamId) {\r\n      void supabase.from('messages').insert({\r\n        stream_id: streamId,\r\n        message_type: 'system',\r\n        content: `BOX_COUNT_UPDATE:${clamped}`\r\n      });\r\n    }\r\n    if (clamped < seats.length) {\r\n      seats.forEach((seat, index) => {\r\n        if (index >= clamped && seat?.user_id) {\r\n          void releaseSeat(index, seat.user_id, { force: true });\r\n        }\r\n      });\r\n    }\r\n    return clamped;\r\n  }, [streamId, seats, releaseSeat]);\r\n  \r\n  const handleAddBox = useCallback(() => {\r\n    const next = syncBoxCount(boxCount + 1);\r\n    toast.success(`Added box (${next})`);\r\n  }, [boxCount, syncBoxCount]);\r\n\r\n  const handleDeductBox = useCallback(() => {\r\n    if (boxCount <= 0) {\r\n      toast.info('No boxes left to remove');\r\n      return;\r\n    }\r\n    const next = syncBoxCount(boxCount - 1);\r\n    toast.success(`Removed box (${next})`);\r\n  }, [boxCount, syncBoxCount]);\r\n\r\n  const handleOfficerAddBox = useCallback(() => {\r\n      const next = syncBoxCount(boxCount + 1);\r\n      toast.success(`Added box (${next})`);\r\n  }, [boxCount, syncBoxCount]);\r\n\r\n  const handleOfficerDeductBox = useCallback(() => {\r\n      if (boxCount <= 0) {\r\n        toast.info('No boxes left to remove');\r\n        return;\r\n      }\r\n      const next = syncBoxCount(boxCount - 1);\r\n      toast.success(`Removed box (${next})`);\r\n  }, [boxCount, syncBoxCount]);\r\n\r\n  const officerTargets = useMemo(() => {\r\n    const map = new Map<string, { id: string; username: string; seatIndex?: number | null }>();\r\n    activeViewers.forEach((viewer) => {\r\n      if (!viewer?.userId) return;\r\n      map.set(viewer.userId, {\r\n        id: viewer.userId,\r\n        username: viewer.username || `Viewer ${viewer.userId.slice(0, 6)}`,\r\n      });\r\n    });\r\n    seats.forEach((seat, index) => {\r\n      if (!seat?.user_id) return;\r\n      const existing = map.get(seat.user_id);\r\n      map.set(seat.user_id, {\r\n        id: seat.user_id,\r\n        username: seat.username || existing?.username || `User ${seat.user_id.slice(0, 6)}`,\r\n        seatIndex: index,\r\n      });\r\n    });\r\n    return Array.from(map.values()).sort((a, b) => a.username.localeCompare(b.username));\r\n  }, [activeViewers, seats]);\r\n\r\n  const handleOfficerMuteUser = async (userId: string, minutes: number) => {\r\n    if (!streamId) return;\r\n    try {\r\n      const until = new Date(Date.now() + minutes * 60 * 1000).toISOString();\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ can_chat: false, chat_mute_until: until })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', userId);\r\n      toast.success(`User muted for ${minutes} minutes`);\r\n    } catch (err) {\r\n      console.error('Failed to mute user', err);\r\n      toast.error('Failed to mute user');\r\n    }\r\n  };\r\n\r\n  const handleOfficerDisableUserChat = async (userId: string) => {\r\n    if (!streamId) return;\r\n    try {\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ can_chat: false, chat_mute_until: null })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', userId);\r\n      toast.success('User chat disabled');\r\n    } catch (err) {\r\n      console.error('Failed to disable user chat', err);\r\n      toast.error('Failed to disable user chat');\r\n    }\r\n  };\r\n\r\n  const handleOfficerKickUser = async (userId: string) => {\r\n    if (!streamId) return;\r\n    try {\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ is_active: false, left_at: new Date().toISOString() })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', userId);\r\n      toast.success('User kicked from stream');\r\n    } catch (err) {\r\n      console.error('Failed to kick user', err);\r\n      toast.error('Failed to kick user');\r\n    }\r\n  };\r\n\r\n  const handleOfficerRemoveSeat = async (userId: string) => {\r\n    const seatIndex = seats.findIndex((seat) => seat?.user_id === userId);\r\n    if (seatIndex < 0) return;\r\n    try {\r\n      await releaseSeat(seatIndex, userId, { force: true });\r\n      toast.success('User removed from box');\r\n    } catch (err) {\r\n      console.error('Failed to remove user from seat', err);\r\n      toast.error('Failed to remove user from seat');\r\n    }\r\n  };\r\n\r\n  const handleOfficerClearSeatBan = async (banId: string) => {\r\n    try {\r\n      await supabase\r\n        .from('broadcast_seat_bans')\r\n        .delete()\r\n        .eq('id', banId);\r\n      toast.success('Guest-box ban cleared');\r\n      await loadSeatBans();\r\n    } catch (err) {\r\n      console.error('Failed to clear seat ban', err);\r\n      toast.error('Failed to clear guest-box ban');\r\n    }\r\n  };\r\n\r\n  const toggleMic = useCallback(async () => {\r\n    if (!micOn && micRestrictionInfo.isMuted) {\r\n      toast.error(micRestrictionInfo.message || 'Microphone is disabled.');\r\n      return;\r\n    }\r\n    const ok = await liveKit.toggleMicrophone();\r\n    setMicOn(Boolean(ok));\r\n  }, [liveKit, micOn, micRestrictionInfo.isMuted, micRestrictionInfo.message]);\r\n\r\n  const endStreamAuto = useCallback(async (reason: string) => {\r\n    if (autoEndTriggeredRef.current) return;\r\n    autoEndTriggeredRef.current = true;\r\n\r\n    try {\r\n      if (streamId) {\r\n        await supabase.from('streams').update({ status: 'ended', is_live: false }).eq('id', streamId);\r\n      }\r\n    } catch (err) {\r\n      console.error('Auto-end stream update failed:', err);\r\n    }\r\n\r\n    toast.error(reason);\r\n    liveKit.markClientDisconnectIntent();\r\n    liveKit.disconnect();\r\n    navigate('/stream-ended');\r\n  }, [liveKit, navigate, streamId]);\r\n\r\n  const endStream = useCallback(async () => {\r\n    if (!confirm(\"Are you sure you want to end this stream?\")) return;\r\n    autoEndTriggeredRef.current = true;\r\n    \r\n    try {\r\n      if (streamId) {\r\n        await supabase.from('streams').update({ status: 'ended', is_live: false }).eq('id', streamId);\r\n      }\r\n    } catch {}\r\n    liveKit.markClientDisconnectIntent();\r\n    liveKit.disconnect();\r\n    navigate('/stream-ended');\r\n  }, [streamId, liveKit, navigate]);\r\n\r\n  // Auth/Session checks (defensive)\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      try {\r\n        const { data, error } = await supabase.auth.getSession();\r\n        if (!mounted) return;\r\n        if (error || !data?.session) {\r\n          try { await supabase.auth.signOut(); } catch {}\r\n          navigate('/auth');\r\n        }\r\n      } catch {\r\n        if (mounted) navigate('/auth');\r\n      }\r\n    })();\r\n    return () => { mounted = false };\r\n  }, [navigate]);\r\n\r\n  // UI State\r\n  const [isGiftModalOpen, setIsGiftModalOpen] = useState(false);\r\n  const [giftReceiver, setGiftReceiver] = useState<any>(null);\r\n  const [selectedProfile, setSelectedProfile] = useState<any>(null);\r\n  const [isCoinStoreOpen, setIsCoinStoreOpen] = useState(false);\r\n  const [entranceEffect, setEntranceEffect] = useState<any>(null);\r\n  const [giftBalanceDelta, setGiftBalanceDelta] = useState<GiftBalanceDelta | null>(null);\r\n  const [controlPanelOpen, setControlPanelOpen] = useState(false);\r\n  const [chatOverlayOpen, setChatOverlayOpen] = useState(false);\r\n  const [entranceEffectKey, setEntranceEffectKey] = useState(0);\r\n  const [lastThemeId, setLastThemeId] = useState<string | null>(null);\r\n  const [messageBubbleTarget, setMessageBubbleTarget] = useState<{\r\n    id: string;\r\n    username?: string;\r\n    avatar_url?: string | null;\r\n  } | null>(null);\r\n  const [messageBubbleOpen, setMessageBubbleOpen] = useState(false);\r\n  const [messageBubbleText, setMessageBubbleText] = useState('');\r\n  const [messageBubbleSending, setMessageBubbleSending] = useState(false);\r\n  const [messageBubblePosition, setMessageBubblePosition] = useState<{ x: number; y: number } | null>(null);\r\n  const messageBubbleDraggingRef = useRef(false);\r\n  const messageBubbleDragOffsetRef = useRef<{ x: number; y: number }>({ x: 0, y: 0 });\r\n  const [officerTargetId, setOfficerTargetId] = useState<string | null>(null);\r\n  \r\n\r\n  const entranceTimeoutRef = useRef<number | null>(null);\r\n  const [quickGifts, setQuickGifts] = useState<GiftItem[]>([]);\r\n  const [quickGiftsLoading, setQuickGiftsLoading] = useState(false);\r\n  const [quickGiftsError, setQuickGiftsError] = useState<string | null>(null);\r\n  \r\n  const entranceSentRef = useRef(false);\r\n\r\n  // Reset entrance sent status when changing streams\r\n  useEffect(() => {\r\n    entranceSentRef.current = false;\r\n  }, [streamId]);\r\n\r\n  // Entrance effect logic\r\n  useEffect(() => {\r\n    const triggerEntrance = async () => {\r\n      if (entranceSentRef.current) return;\r\n      if (!user || !streamId || isBroadcaster || profile?.is_ghost_mode) return;\r\n\r\n      entranceSentRef.current = true;\r\n\r\n      const { effectKey, config } = await getUserEntranceEffect(user.id);\r\n\r\n      if (effectKey) {\r\n        await supabase.from('messages').insert({\r\n          stream_id: streamId,\r\n          user_id: user.id,\r\n          message_type: 'entrance',\r\n          content: JSON.stringify({\r\n            username: profile?.username || user.email,\r\n            role: profile?.role || 'user',\r\n            effectKey,\r\n            effect: config\r\n          })\r\n        });\r\n      }\r\n    };\r\n\r\n    if (isConnected) {\r\n      void triggerEntrance();\r\n    }\r\n  }, [isConnected, user, streamId, profile, isBroadcaster]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n\r\n    const channel = supabase\r\n      .channel(`live-updates-${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'messages',\r\n          filter: `stream_id=eq.${streamId}`,\r\n        },\r\n        (payload) => {\r\n          const msg = payload.new;\r\n          if (msg.message_type === 'entrance') {\r\n            try {\r\n              const rawContent = msg.content;\r\n              const data = typeof rawContent === 'string'\r\n                ? JSON.parse(rawContent)\r\n                : (rawContent || {});\r\n              const payloadUserId =\r\n                data.user_id || data.sender_id || msg.user_id || msg.sender_id;\r\n\r\n              // Don't show your own entrance effect to yourself\r\n              if (payloadUserId && user?.id && payloadUserId === user.id) {\r\n                return;\r\n              }\r\n\r\n              setEntranceEffect({\r\n                username: data.username || 'Viewer',\r\n                role: data.role || 'viewer',\r\n                profile: data.profile,\r\n                effectKey: data.effectKey,\r\n                effect: data.effect,\r\n                userId: payloadUserId || null,\r\n              });\r\n              setEntranceEffectKey((prev) => prev + 1);\r\n\r\n              if (entranceTimeoutRef.current) {\r\n                window.clearTimeout(entranceTimeoutRef.current);\r\n              }\r\n              entranceTimeoutRef.current = window.setTimeout(() => {\r\n                setEntranceEffect(null);\r\n                entranceTimeoutRef.current = null;\r\n              }, 5000);\r\n\r\n              if (payloadUserId) {\r\n                void triggerUserEntranceEffect(payloadUserId);\r\n              }\r\n            } catch (e) {\r\n              console.error('Failed to parse entrance effect', e);\r\n            }\r\n          } else if (msg.message_type === 'system' && msg.content?.startsWith('PRICE_UPDATE:')) {\r\n            const price = parseInt(msg.content.split(':')[1]);\r\n            if (!isNaN(price)) setJoinPrice(price);\r\n          } else if (msg.message_type === 'system' && msg.content?.startsWith('BOX_COUNT_UPDATE:')) {\r\n            const parts = msg.content.split(':');\r\n            const raw = parts[1];\r\n            const parsed = parseInt(raw);\r\n            if (!isNaN(parsed)) {\r\n              const maxBoxes = 6;\r\n              const next = Math.max(0, Math.min(maxBoxes, parsed));\r\n              setBoxCount(next);\r\n            }\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      if (entranceTimeoutRef.current) {\r\n        window.clearTimeout(entranceTimeoutRef.current);\r\n        entranceTimeoutRef.current = null;\r\n      }\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId, stream?.broadcaster_id, isBroadcaster, user?.id]);\r\n\r\n\r\n  // Load Stream Data\r\n  const loadStreamData = useCallback(async () => {\r\n    if (!streamId) {\r\n      setIsLoadingStream(false);\r\n      return;\r\n    }\r\n\r\n    // Try location state first\r\n    const streamDataFromState = location.state?.streamData;\r\n    if (streamDataFromState && streamDataFromState.id === streamId) {\r\n      setStream(streamDataFromState as StreamRow);\r\n      setViewerCount((streamDataFromState as StreamRow).current_viewers ?? 0);\r\n      setIsLoadingStream(false);\r\n      if (streamId) {\r\n        void refreshBoxCountFromMessages(streamId);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Try session storage second\r\n    try {\r\n      const storedStream = sessionStorage.getItem(\"activeStream\");\r\n      if (storedStream) {\r\n        const parsedStream = JSON.parse(storedStream);\r\n          if (parsedStream.id === streamId) {\r\n          setStream(parsedStream);\r\n          setViewerCount(parsedStream.current_viewers ?? 0);\r\n          setIsLoadingStream(false);\r\n          if (streamId) {\r\n            void refreshBoxCountFromMessages(streamId);\r\n          }\r\n          return;\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.warn('Failed to parse stream from sessionStorage', e);\r\n    }\r\n\r\n    setIsLoadingStream(true);\r\n    \r\n    try {\r\n        // Fetch by Stream ID ONLY\r\n        const { data: streamRow, error } = await supabase\r\n          .from(\"streams\")\r\n        .select(\"id, broadcaster_id, title, category, status, start_time, end_time, current_viewers, total_gifts_coins, total_unique_gifters, is_live, is_private, thumbnail_url, room_name, created_at, updated_at, broadcast_level_percent, last_level_update_at, broadcast_xp, frame_mode\")\r\n          .eq(\"id\", streamId)\r\n          .maybeSingle();\r\n\r\n        if (error || !streamRow) {\r\n            toast.error(\"Stream not found.\");\r\n            setIsLoadingStream(false);\r\n            return;\r\n        }\r\n        setViewerCount(streamRow.current_viewers ?? 0);\r\n        setStream(streamRow as StreamRow);\r\n        setCurrentFrameMode((streamRow.frame_mode as 'none'|'rgb') || 'none');\r\n        if (streamId) {\r\n          void refreshBoxCountFromMessages(streamId);\r\n        }\r\n    } catch (err) {\r\n        console.error(\"Failed to load stream:\", err);\r\n        toast.error(\"Failed to load stream information.\");\r\n    } finally {\r\n        setIsLoadingStream(false);\r\n    }\r\n  }, [streamId, location, refreshBoxCountFromMessages]);\r\n\r\n  useEffect(() => {\r\n    loadStreamData();\r\n  }, [loadStreamData]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId || !stream) {\r\n      setPrivateAccessGranted(false);\r\n      setPrivatePasswordInput('');\r\n      setPrivateAuthError('');\r\n      return;\r\n    }\r\n\r\n    if (!privateAccessStorageKey) {\r\n      setPrivateAccessGranted(true);\r\n      return;\r\n    }\r\n\r\n    if (stream.is_private && stream.broadcaster_id !== user?.id) {\r\n      const stored = localStorage.getItem(privateAccessStorageKey);\r\n      setPrivateAccessGranted(Boolean(stored));\r\n    } else {\r\n      setPrivateAccessGranted(true);\r\n      if (privateAccessStorageKey) {\r\n        localStorage.removeItem(privateAccessStorageKey);\r\n      }\r\n    }\r\n  }, [streamId, stream?.is_private, stream?.broadcaster_id, user?.id, privateAccessStorageKey, stream]);\r\n\r\n  const handlePrivatePasswordSubmit = async () => {\r\n    setPrivateAuthError('');\r\n    if (!streamId) {\r\n      setPrivateAuthError('Stream unavailable');\r\n      return;\r\n    }\r\n    if (!user) {\r\n      setPrivateAuthError('Please sign in to enter the password');\r\n      return;\r\n    }\r\n    if (!privatePasswordInput.trim()) {\r\n      setPrivateAuthError('Enter the stream password');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase.rpc('verify_stream_password', {\r\n        p_stream_id: streamId,\r\n        p_password: privatePasswordInput.trim(),\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data?.success) {\r\n        setPrivateAccessGranted(true);\r\n        if (privateAccessStorageKey) {\r\n          localStorage.setItem(privateAccessStorageKey, '1');\r\n        }\r\n        setPrivateAuthError('');\r\n        toast.success('Private access granted');\r\n      } else {\r\n        setPrivateAuthError('Incorrect password');\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Private password verification failed:', err);\r\n      setPrivateAuthError('Unable to verify password right now');\r\n    }\r\n  };\r\n\r\n  // XP Tracking for Watchers (Anti-Farm: 5 XP every 10 mins)\r\n  const watchTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n  const minutesWatchedRef = useRef(0);\r\n\r\n  useEffect(() => {\r\n    // Only track if user is logged in, stream is live, and NOT the broadcaster\r\n    if (!user?.id || !stream?.is_live || isBroadcaster) return;\r\n\r\n    // Clear existing timer\r\n    if (watchTimerRef.current) clearInterval(watchTimerRef.current);\r\n\r\n    watchTimerRef.current = setInterval(async () => {\r\n      minutesWatchedRef.current += 1;\r\n      \r\n      // Award 5 XP every 10 minutes\r\n      if (minutesWatchedRef.current % 10 === 0) {\r\n        try {\r\n           // Call add_xp with 'watch' source\r\n           await supabase.rpc('add_xp', { \r\n             p_user_id: user.id, \r\n             p_amount: 5, \r\n             p_source: 'watch' \r\n           });\r\n           console.log('[XP] Awarded 5 watch XP');\r\n        } catch (e) {\r\n           console.error('[XP] Failed to award watch XP', e);\r\n        }\r\n      }\r\n    }, 60000); // Check every minute\r\n\r\n    return () => {\r\n      if (watchTimerRef.current) clearInterval(watchTimerRef.current);\r\n    };\r\n  }, [user?.id, stream?.is_live, isBroadcaster]);\r\n\r\n  // Access Control for Officer Streams\r\n  useEffect(() => {\r\n    if (!stream) return;\r\n    \r\n    if (stream.category === 'Officer Stream') {\r\n      const isOfficer = profile && (\r\n        ['admin', 'troll_officer', 'lead_troll_officer', 'secretary', 'pastor'].includes(profile.role || '') || \r\n        (profile as any).is_lead_officer || \r\n        (profile as any).is_admin\r\n      );\r\n      \r\n      if (!isOfficer) {\r\n        toast.error(\"This stream is restricted to officers only.\");\r\n        navigate('/');\r\n      }\r\n    }\r\n  }, [stream, profile, navigate]);\r\n\r\n  // Update stream status to LIVE once Broadcaster is fully connected\r\n  const hasSetLiveRef = useRef(false);\r\n  \r\n  useEffect(() => {\r\n    // Only proceed if:\r\n    // 1. User is the broadcaster\r\n    // 2. We have a valid stream ID\r\n    // 3. LiveKit is fully connected\r\n    // 4. We haven't already set it to live in this session\r\n    if (!isBroadcaster || !streamId || !isConnected || hasSetLiveRef.current) {\r\n      return;\r\n    }\r\n\r\n    // Prevent redundant updates if we know it's already live\r\n    if (stream?.status === 'live' && stream?.is_live) {\r\n       hasSetLiveRef.current = true;\r\n       return;\r\n    }\r\n\r\n    console.log('[LivePage] Broadcaster connected. Updating stream status to LIVE...');\r\n    hasSetLiveRef.current = true;\r\n\r\n    supabase.from(\"streams\").update({ \r\n      status: \"live\", \r\n      is_live: true, \r\n      start_time: new Date().toISOString(),\r\n      room_name: roomName \r\n    }).eq(\"id\", streamId).then(async () => {\r\n      console.log(\"[LivePage] ‚úÖ Stream status updated to LIVE\");\r\n      toast.success(\"You are now LIVE!\");\r\n      \r\n      // Evaluate badges for going live\r\n      if (profile?.id) {\r\n        await evaluateBadgesForUser(profile.id);\r\n      }\r\n    });\r\n\r\n  }, [isBroadcaster, streamId, isConnected, roomName, stream?.status, stream?.is_live]);\r\n\r\n  const [useFlyingChats, setUseFlyingChats] = useState(false);\r\n  const [isMobileViewport, setIsMobileViewport] = useState(false);\r\n  const lastTapRef = useRef(0);\r\n\r\n  useEffect(() => {\r\n    const shouldLock = chatOverlayOpen || controlPanelOpen || isGiftModalOpen || isCoinStoreOpen\r\n    if (shouldLock) {\r\n      document.body.classList.add('no-scroll')\r\n    } else {\r\n      document.body.classList.remove('no-scroll')\r\n    }\r\n    return () => {\r\n      document.body.classList.remove('no-scroll')\r\n    }\r\n  }, [chatOverlayOpen, controlPanelOpen, isGiftModalOpen, isCoinStoreOpen]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    const media = window.matchMedia('(max-width: 1023px)');\r\n    const update = () => setIsMobileViewport(media.matches);\r\n    update();\r\n    if (media.addEventListener) {\r\n      media.addEventListener('change', update);\r\n    } else {\r\n      media.addListener(update);\r\n    }\r\n    return () => {\r\n      if (media.removeEventListener) {\r\n        media.removeEventListener('change', update);\r\n      } else {\r\n        media.removeListener(update);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isMobileViewport) {\r\n      setUseFlyingChats(false);\r\n    }\r\n  }, [isMobileViewport]);\r\n\r\n  const openGiftPopup = useCallback(() => {\r\n    if (!isMobileViewport) return;\r\n    setGiftReceiver(null);\r\n    setIsGiftModalOpen(true);\r\n  }, [isMobileViewport]);\r\n\r\n  const handleStageTouchEnd = useCallback(() => {\r\n    if (!isMobileViewport) return;\r\n    const now = Date.now();\r\n    if (now - lastTapRef.current < 300) {\r\n      openGiftPopup();\r\n    }\r\n    lastTapRef.current = now;\r\n  }, [isMobileViewport, openGiftPopup]);\r\n\r\n  // Stream polling\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n    const channel = supabase\r\n      .channel(`stream-updates-${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'UPDATE',\r\n          schema: 'public',\r\n          table: 'streams',\r\n          filter: `id=eq.${streamId}`,\r\n        },\r\n        (payload) => {\r\n          const newStream = payload.new as StreamRow;\r\n          setStream(prev => {\r\n            if (!prev) return null;\r\n            return {\r\n              ...prev,\r\n              total_gifts_coins: newStream.total_gifts_coins,\r\n              current_viewers: newStream.current_viewers,\r\n              status: newStream.status,\r\n              is_live: newStream.is_live,\r\n              total_likes: newStream.total_likes\r\n            };\r\n          });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n    const interval = setInterval(async () => {\r\n      const { data } = await supabase.from(\"streams\").select(\"status,is_live,current_viewers,total_gifts_coins,total_likes\").eq(\"id\", streamId).maybeSingle();\r\n      if (data) {\r\n        setStream(prev => {\r\n          if (!prev) return prev;\r\n          \r\n          // Check if we're within grace period of a local coin update\r\n          const withinGrace = Date.now() - lastLocalCoinUpdateRef.current < COIN_UPDATE_GRACE_PERIOD;\r\n          \r\n          // Force update if values changed, but preserve local coin updates within grace period\r\n          const shouldUpdateCoins = !withinGrace || prev.total_gifts_coins === data.total_gifts_coins;\r\n          \r\n          if (\r\n            prev.current_viewers !== data.current_viewers ||\r\n            prev.total_likes !== data.total_likes ||\r\n            (shouldUpdateCoins && prev.total_gifts_coins !== data.total_gifts_coins)\r\n          ) {\r\n            return {\r\n              ...prev,\r\n              ...data,\r\n              // Don't override coins if we just updated them locally\r\n              ...(withinGrace && { total_gifts_coins: prev.total_gifts_coins })\r\n            };\r\n          }\r\n          return prev;\r\n        });\r\n      }\r\n    }, STREAM_POLL_INTERVAL); // Polling every 2 seconds\r\n    return () => clearInterval(interval);\r\n  }, [streamId]);\r\n\r\n  useStreamEndListener({\r\n    streamId: streamId || '',\r\n    enabled: !!streamId, // Redirect all users including broadcaster if they are on this page\r\n    redirectToSummary: true,\r\n  });\r\n\r\n  const NO_VIEWER_JOIN_MS = 15 * 60 * 1000;\r\n  const NO_GIFT_GRACE_MS = 10 * 60 * 1000;\r\n\r\n  useEffect(() => {\r\n    autoEndTriggeredRef.current = false;\r\n    setHasViewerGift(false);\r\n    if (noViewerTimerRef.current) {\r\n      clearTimeout(noViewerTimerRef.current);\r\n      noViewerTimerRef.current = null;\r\n    }\r\n    if (noGiftTimerRef.current) {\r\n      clearTimeout(noGiftTimerRef.current);\r\n      noGiftTimerRef.current = null;\r\n    }\r\n  }, [streamId]);\r\n\r\n  useEffect(() => {\r\n    if (!isBroadcaster || isRoleExempt || !stream?.is_live) {\r\n      if (noViewerTimerRef.current) {\r\n        clearTimeout(noViewerTimerRef.current);\r\n        noViewerTimerRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (activeViewers.length > 0) {\r\n      if (noViewerTimerRef.current) {\r\n        clearTimeout(noViewerTimerRef.current);\r\n        noViewerTimerRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!noViewerTimerRef.current) {\r\n      noViewerTimerRef.current = window.setTimeout(() => {\r\n        if (activeViewers.length === 0) {\r\n          void endStreamAuto('Stream ended: no viewers joined within 15 minutes.');\r\n        }\r\n      }, NO_VIEWER_JOIN_MS);\r\n    }\r\n\r\n    return () => {\r\n      if (noViewerTimerRef.current) {\r\n        clearTimeout(noViewerTimerRef.current);\r\n        noViewerTimerRef.current = null;\r\n      }\r\n    };\r\n  }, [activeViewers.length, endStreamAuto, isBroadcaster, isRoleExempt, stream?.is_live, NO_VIEWER_JOIN_MS]);\r\n\r\n  useEffect(() => {\r\n    if (!isBroadcaster || isRoleExempt || !stream?.is_live) {\r\n      if (noGiftTimerRef.current) {\r\n        clearTimeout(noGiftTimerRef.current);\r\n        noGiftTimerRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (hasViewerGift) {\r\n      if (noGiftTimerRef.current) {\r\n        clearTimeout(noGiftTimerRef.current);\r\n        noGiftTimerRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!noGiftTimerRef.current) {\r\n      noGiftTimerRef.current = window.setTimeout(() => {\r\n        if (!hasViewerGift) {\r\n          void endStreamAuto('Stream ended: no gifts received from viewers.');\r\n        }\r\n      }, NO_GIFT_GRACE_MS);\r\n    }\r\n\r\n    return () => {\r\n      if (noGiftTimerRef.current) {\r\n        clearTimeout(noGiftTimerRef.current);\r\n        noGiftTimerRef.current = null;\r\n      }\r\n    };\r\n  }, [endStreamAuto, hasViewerGift, isBroadcaster, isRoleExempt, stream?.is_live, NO_GIFT_GRACE_MS]);\r\n\r\n  const refreshViewerSnapshot = useCallback(async () => {\r\n    if (!streamId) {\r\n      setActiveViewers([]);\r\n      setViewerCount(0);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data: viewerRows, error: viewerError } = await supabase\r\n        .from('stream_viewers')\r\n        .select('user_id')\r\n        .eq('stream_id', streamId);\r\n\r\n      console.log('[LivePage] Refreshing viewer snapshot. Found:', viewerRows?.length || 0, 'viewers');\r\n\r\n      if (viewerError) {\r\n        console.error('Failed to load active viewers:', viewerError);\r\n        return;\r\n      }\r\n\r\n      const viewerIds = (viewerRows || []).map((row: any) => row.user_id).filter(Boolean);\r\n      const fallbackViewers = viewerIds.map((id: string) => ({\r\n        userId: id,\r\n        username: `Viewer ${id.substring(0, 6)}`,\r\n      }));\r\n      let mappedViewers = fallbackViewers;\r\n\r\n      if (viewerIds.length > 0) {\r\n        const [profileResult, taxResult] = await Promise.all([\r\n          supabase\r\n            .from('user_profiles')\r\n            .select('id, username, avatar_url, role, troll_role, is_broadcaster, full_name, onboarding_completed')\r\n            .in('id', viewerIds),\r\n          supabase\r\n            .from('user_tax_info')\r\n            .select('user_id, w9_status')\r\n            .in('user_id', viewerIds)\r\n        ]);\r\n\r\n        const profileRows = profileResult.data;\r\n        const profileError = profileResult.error;\r\n        const taxRows = taxResult.data || [];\r\n\r\n        if (!profileError && Array.isArray(profileRows) && profileRows.length > 0) {\r\n          const profileMap = new Map(profileRows.map((p: any) => [p.id, p]));\r\n          const taxMap = new Map(taxRows.map((t: any) => [t.user_id, t]));\r\n\r\n          mappedViewers = viewerIds.map((id: string) => {\r\n            const profile = profileMap.get(id);\r\n            const taxInfo = taxMap.get(id);\r\n            const w9Status = taxInfo?.w9_status || 'pending';\r\n\r\n            return {\r\n              userId: id,\r\n              username: profile?.username || `Viewer ${id.substring(0, 6)}`,\r\n              avatarUrl: profile?.avatar_url,\r\n              role: profile?.role || profile?.troll_role || null,\r\n              isBroadcaster: Boolean(profile?.is_broadcaster),\r\n              fullName: profile?.full_name || null,\r\n              onboardingCompleted: Boolean(profile?.onboarding_completed),\r\n              w9Status,\r\n            };\r\n          });\r\n        }\r\n      }\r\n\r\n      setActiveViewers(mappedViewers);\r\n      setViewerCount(viewerIds.length);\r\n      setStream((prev) => (prev ? { ...prev, current_viewers: viewerIds.length } : prev));\r\n    } catch (err) {\r\n      console.error('Failed to refresh viewer snapshot:', err);\r\n    }\r\n  }, [streamId]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n    refreshViewerSnapshot();\r\n    const channel = supabase\r\n      .channel(`stream-viewers-${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'stream_viewers',\r\n          filter: `stream_id=eq.${streamId}`,\r\n        },\r\n        (payload) => {\r\n          console.log('[LivePage] Viewer change detected:', payload.eventType);\r\n          refreshViewerSnapshot();\r\n        }\r\n      )\r\n      .subscribe((status) => {\r\n        console.log('[LivePage] Viewer subscription status:', status);\r\n      });\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId, refreshViewerSnapshot]);\r\n\r\n  useEffect(() => {\r\n    activeViewers.forEach((viewer) => {\r\n      if (!viewer.userId) return;\r\n      if (viewer.isBroadcaster) {\r\n        notifiedMissingFormsRef.current.delete(viewer.userId);\r\n        return;\r\n      }\r\n\r\n      const missing: string[] = [];\r\n      if (!viewer.fullName) missing.push('Profile Info');\r\n      if (!viewer.onboardingCompleted) missing.push('Onboarding');\r\n      if (!['submitted', 'verified'].includes(viewer.w9Status || 'pending')) {\r\n        missing.push('Tax / W9');\r\n      }\r\n\r\n      // If forms are complete, clear notification tracking and don't re-notify\r\n      if (missing.length === 0) {\r\n        notifiedMissingFormsRef.current.delete(viewer.userId);\r\n        return;\r\n      }\r\n\r\n      // Only notify if we haven't already notified this user about their missing forms\r\n      if (notifiedMissingFormsRef.current.has(viewer.userId)) return;\r\n      void notifyMissingForms(viewer.userId, missing);\r\n    });\r\n  }, [activeViewers, notifyMissingForms]);\r\n\r\n  // Gift subscription\r\n  const lastGift = useGiftEvents(streamId);\r\n  \r\n  // Track local coin updates to prevent polling from reverting them\r\n  const lastLocalCoinUpdateRef = useRef<number>(0);\r\n  const COIN_UPDATE_GRACE_PERIOD = 3000; // 3 seconds\r\n\r\n  // Update coin count instantly when a gift is received\r\n  useEffect(() => {\r\n    if (!lastGift) return;\r\n    const amount = Number(lastGift.coinCost || 0);\r\n    if (amount <= 0) return;\r\n\r\n    lastLocalCoinUpdateRef.current = Date.now();\r\n    setStream(prev => {\r\n      if (!prev) return prev;\r\n      const updatedCoins = (prev.total_gifts_coins || 0) + amount;\r\n      if (updatedCoins === prev.total_gifts_coins) return prev;\r\n      return { ...prev, total_gifts_coins: updatedCoins };\r\n    });\r\n  }, [lastGift]);\r\n\r\n  useEffect(() => {\r\n    if (!lastGift || !isBroadcaster || isRoleExempt || !stream?.is_live) return;\r\n    const senderRole = (lastGift.sender_troll_role || lastGift.sender_role || '').toLowerCase();\r\n    const senderPrivileged = ['admin', 'lead_troll_officer', 'secretary', 'pastor', 'troll_officer'].includes(senderRole);\r\n    if (!senderPrivileged) {\r\n      setHasViewerGift(true);\r\n      if (noGiftTimerRef.current) {\r\n        clearTimeout(noGiftTimerRef.current);\r\n        noGiftTimerRef.current = null;\r\n      }\r\n    }\r\n  }, [isBroadcaster, isRoleExempt, lastGift, stream?.is_live]);\r\n\r\n  const toGiftSlug = (value?: string) => {\r\n    if (!value) return 'gift';\r\n    return value\r\n      .toLowerCase()\r\n      .trim()\r\n      .replace(/[^a-z0-9]+/g, '_')\r\n      .replace(/^_+|_+$/g, '') || 'gift';\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    if (messageBubblePosition) return;\r\n    const width = window.innerWidth || 0;\r\n    const height = window.innerHeight || 0;\r\n    const defaultWidth = 360;\r\n    const defaultHeight = 220;\r\n    const margin = 16;\r\n    const x = Math.max(margin, width - defaultWidth - margin);\r\n    const y = Math.max(margin, height - defaultHeight - margin);\r\n    setMessageBubblePosition({ x, y });\r\n  }, [messageBubblePosition]);\r\n\r\n  const ensureConversationForUser = useCallback(\r\n    async (otherUserId: string): Promise<string | null> => {\r\n      if (!profile?.id || !otherUserId) return null;\r\n\r\n      try {\r\n        const { data: myMemberships, error: myError } = await supabase\r\n          .from('conversation_members')\r\n          .select('conversation_id')\r\n          .eq('user_id', profile.id);\r\n\r\n        let conversationId: string | null = null;\r\n\r\n        if (!myError && myMemberships && myMemberships.length > 0) {\r\n          const conversationIds = (myMemberships as any[]).map((m) => m.conversation_id);\r\n          const { data: otherMemberships, error: otherError } = await supabase\r\n            .from('conversation_members')\r\n            .select('conversation_id')\r\n            .eq('user_id', otherUserId)\r\n            .in('conversation_id', conversationIds);\r\n\r\n          if (!otherError && otherMemberships && otherMemberships.length > 0) {\r\n            conversationId = (otherMemberships[0] as any).conversation_id as string;\r\n          }\r\n        }\r\n\r\n        if (!conversationId) {\r\n          const conversation = await createConversation([otherUserId]);\r\n          conversationId = conversation.id;\r\n        }\r\n\r\n        return conversationId;\r\n      } catch (err) {\r\n        console.error('Failed to ensure conversation:', err);\r\n        return null;\r\n      }\r\n    },\r\n    [profile?.id]\r\n  );\r\n\r\n  const openMessageBubble = useCallback(\r\n    (target: { id: string; username?: string; name?: string; avatar_url?: string | null }) => {\r\n      if (!target?.id) return;\r\n      setMessageBubbleTarget({\r\n        id: target.id,\r\n        username: target.username || target.name || '',\r\n        avatar_url: target.avatar_url || null,\r\n      });\r\n      setMessageBubbleText('');\r\n      setMessageBubbleOpen(true);\r\n    },\r\n    []\r\n  );\r\n\r\n  const handleMessageBubbleMouseDown = useCallback(\r\n    (event: React.MouseEvent<HTMLDivElement>) => {\r\n      if (!messageBubblePosition) return;\r\n      if (typeof window === 'undefined') return;\r\n      event.preventDefault();\r\n\r\n      messageBubbleDraggingRef.current = true;\r\n      messageBubbleDragOffsetRef.current = {\r\n        x: event.clientX - messageBubblePosition.x,\r\n        y: event.clientY - messageBubblePosition.y,\r\n      };\r\n\r\n      const handleMove = (e: MouseEvent) => {\r\n        if (!messageBubbleDraggingRef.current) return;\r\n        const viewportWidth = window.innerWidth || 0;\r\n        const viewportHeight = window.innerHeight || 0;\r\n        const cardWidth = 360;\r\n        const cardHeight = 220;\r\n        const margin = 8;\r\n\r\n        let nextX = e.clientX - messageBubbleDragOffsetRef.current.x;\r\n        let nextY = e.clientY - messageBubbleDragOffsetRef.current.y;\r\n\r\n        nextX = Math.min(Math.max(margin, nextX), Math.max(margin, viewportWidth - cardWidth - margin));\r\n        nextY = Math.min(Math.max(margin, nextY), Math.max(margin, viewportHeight - cardHeight - margin));\r\n\r\n        setMessageBubblePosition({ x: nextX, y: nextY });\r\n      };\r\n\r\n      const handleUp = () => {\r\n        messageBubbleDraggingRef.current = false;\r\n        window.removeEventListener('mousemove', handleMove);\r\n        window.removeEventListener('mouseup', handleUp);\r\n      };\r\n\r\n      window.addEventListener('mousemove', handleMove);\r\n      window.addEventListener('mouseup', handleUp);\r\n    },\r\n    [messageBubblePosition]\r\n  );\r\n\r\n  const handleSendBubbleMessage = useCallback(async () => {\r\n    if (!messageBubbleTarget || !messageBubbleText.trim() || messageBubbleSending) return;\r\n    if (!profile?.id) {\r\n      toast.error('Please sign in to send messages.');\r\n      return;\r\n    }\r\n\r\n    setMessageBubbleSending(true);\r\n    try {\r\n      const conversationId = await ensureConversationForUser(messageBubbleTarget.id);\r\n      if (!conversationId) {\r\n        toast.error('Unable to start conversation right now.');\r\n        setMessageBubbleSending(false);\r\n        return;\r\n      }\r\n\r\n      const messageBody = messageBubbleText.trim();\r\n      await sendConversationMessage(conversationId, messageBody);\r\n\r\n      try {\r\n        await sendNotification(\r\n          messageBubbleTarget.id,\r\n          'message',\r\n          'New message',\r\n          `New message from ${profile.username}`,\r\n          { sender_id: profile.id }\r\n        );\r\n      } catch (notifErr) {\r\n        console.warn('Notification error (bubble message):', notifErr);\r\n      }\r\n\r\n      setMessageBubbleText('');\r\n      setMessageBubbleOpen(false);\r\n      toast.success('Message sent');\r\n    } catch (err) {\r\n      console.error('Failed to send message:', err);\r\n      toast.error('Failed to send message. Please try again.');\r\n    } finally {\r\n      setMessageBubbleSending(false);\r\n    }\r\n  }, [\r\n    messageBubbleTarget,\r\n    messageBubbleText,\r\n    messageBubbleSending,\r\n    ensureConversationForUser,\r\n    profile?.id,\r\n    profile?.username,\r\n  ]);\r\n\r\n  const [generalUserActionTarget, setGeneralUserActionTarget] = useState<{\r\n    userId: string;\r\n    username: string;\r\n    role: string;\r\n    isOfficer?: boolean;\r\n  } | null>(null);\r\n\r\n  // Check if current user is broadofficer\r\n  useEffect(() => {\r\n    if (!stream?.broadcaster_id || !user?.id) return;\r\n    if (isBroadcaster) {\r\n        setIsCurrentUserBroadofficer(true); // Broadcaster is implied officer\r\n        return;\r\n    }\r\n    const checkOfficer = async () => {\r\n        const { data } = await supabase.rpc('is_broadofficer', {\r\n            p_broadcaster_id: stream.broadcaster_id,\r\n            p_user_id: user.id\r\n        });\r\n        setIsCurrentUserBroadofficer(!!data);\r\n    };\r\n    checkOfficer();\r\n  }, [stream?.broadcaster_id, user?.id, isBroadcaster]);\r\n\r\n  const handleGeneralKick = async () => {\r\n      if (!generalUserActionTarget || !user) return;\r\n      \r\n      const isPrivileged = isBroadcaster || isCurrentUserBroadofficer || isRoleExempt;\r\n      const fee = isPrivileged ? 0 : 500;\r\n      \r\n      if (!isPrivileged && (profile?.troll_coins || 0) < fee) {\r\n          toast.error(`Insufficient funds. Need ${fee} coins.`);\r\n          return;\r\n      }\r\n      \r\n      try {\r\n        const { error } = await supabase.rpc('kick_user', {\r\n            p_target_user_id: generalUserActionTarget.userId,\r\n            p_kicker_user_id: user.id,\r\n            p_stream_id: stream?.id || null,\r\n        });\r\n        \r\n        if (error) throw error;\r\n        \r\n        // Log action\r\n        await supabase.from('officer_actions').insert({\r\n            officer_id: user.id,\r\n            target_user_id: generalUserActionTarget.userId,\r\n            action_type: 'kick',\r\n            related_stream_id: stream?.id || null,\r\n            fee_coins: fee,\r\n            metadata: { username: generalUserActionTarget.username }\r\n        });\r\n\r\n        toast.success(`Kicked ${generalUserActionTarget.username}`);\r\n        setGeneralUserActionTarget(null);\r\n      } catch (err) {\r\n          console.error('Kick failed', err);\r\n          toast.error('Kick failed');\r\n      }\r\n  };\r\n\r\n  const handleAssignOfficer = async () => {\r\n    if (!generalUserActionTarget || !isBroadcaster || !user) return;\r\n    try {\r\n      const { data, error } = await supabase.rpc('assign_broadofficer', {\r\n        p_broadcaster_id: user.id,\r\n        p_officer_id: generalUserActionTarget.userId\r\n      });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Handle JSON response if it returns success/error object\r\n      if (data && typeof data === 'object' && 'success' in data && !data.success) {\r\n         toast.error(data.error || 'Failed to assign officer');\r\n         return;\r\n      }\r\n\r\n      toast.success(`${generalUserActionTarget.username} is now a Broadofficer`);\r\n      setGeneralUserActionTarget(prev => prev ? { ...prev, isOfficer: true } : null);\r\n    } catch (err) {\r\n      console.error('Failed to assign officer:', err);\r\n      toast.error('Failed to assign officer');\r\n    }\r\n  };\r\n\r\n  const handleRemoveOfficer = async () => {\r\n    if (!generalUserActionTarget || !isBroadcaster || !user) return;\r\n    try {\r\n      const { data, error } = await supabase.rpc('remove_broadofficer', {\r\n        p_broadcaster_id: user.id,\r\n        p_officer_id: generalUserActionTarget.userId\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n       if (data && typeof data === 'object' && 'success' in data && !data.success) {\r\n         toast.error(data.error || 'Failed to remove officer');\r\n         return;\r\n      }\r\n\r\n      toast.success(`${generalUserActionTarget.username} is no longer a Broadofficer`);\r\n      setGeneralUserActionTarget(prev => prev ? { ...prev, isOfficer: false } : null);\r\n    } catch (err) {\r\n      console.error('Failed to remove officer:', err);\r\n      toast.error('Failed to remove officer');\r\n    }\r\n  };\r\n\r\n  const recordAction = async (actionType: string, targetUserId: string, targetUsername: string, fee: number = 0, metadata: any = {}) => {\r\n      if (!user?.id) return;\r\n      try {\r\n        await supabase.from('officer_actions').insert({\r\n          officer_id: user.id,\r\n          target_user_id: targetUserId,\r\n          action_type: actionType,\r\n          related_stream_id: streamId || null,\r\n          fee_coins: fee,\r\n          metadata: {\r\n            username: targetUsername,\r\n            ...metadata,\r\n          },\r\n        });\r\n        \r\n        if (isOfficerUser) {\r\n           await updateOfficerActivity(user.id);\r\n        }\r\n      } catch (err) {\r\n        console.error('Failed to log action:', err);\r\n      }\r\n  };\r\n\r\n  const handleMute = async (target: { userId: string; username: string }) => {\r\n      const isPrivileged = isBroadcaster || isCurrentUserBroadofficer || isOfficerUser;\r\n      const fee = isPrivileged ? 0 : 25;\r\n\r\n      if (!isPrivileged && (profile?.troll_coins || 0) < fee) {\r\n          toast.error(`Insufficient funds. Need ${fee} coins.`);\r\n          return;\r\n      }\r\n\r\n      const muteDurationMs = 10 * 60 * 1000;\r\n      const muteUntil = new Date(Date.now() + muteDurationMs).toISOString();\r\n      \r\n      const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({ mic_muted_until: muteUntil })\r\n        .eq('id', target.userId);\r\n\r\n      if (error) {\r\n          toast.error('Failed to mute user');\r\n          return;\r\n      }\r\n\r\n      toast.success(`Muted ${target.username} for 10 minutes`);\r\n      await recordAction('mute', target.userId, target.username, fee, { duration_minutes: 10 });\r\n  };\r\n\r\n  const handleUnmute = async (target: { userId: string; username: string }) => {\r\n       if (!isBroadcaster && !isCurrentUserBroadofficer && !isOfficerUser) {\r\n           toast.error('You do not have permission to unmute.');\r\n           return;\r\n       }\r\n\r\n       const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({ mic_muted_until: null })\r\n        .eq('id', target.userId);\r\n        \r\n       if (error) {\r\n          toast.error('Failed to unmute user');\r\n          return;\r\n       }\r\n       toast.success(`Unmuted ${target.username}`);\r\n       await recordAction('unmute', target.userId, target.username, 0);\r\n  };\r\n  \r\n  const handleBlock = async (target: { userId: string; username: string }) => {\r\n       const isPrivileged = isBroadcaster || isCurrentUserBroadofficer || isOfficerUser;\r\n       const fee = isPrivileged ? 0 : 500;\r\n\r\n       if (!isPrivileged && (profile?.troll_coins || 0) < fee) {\r\n          toast.error(`Insufficient funds. Need ${fee} coins.`);\r\n          return;\r\n      }\r\n\r\n       const blockUntil = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();\r\n       const { error } = await supabase\r\n         .from('user_profiles')\r\n         .update({ no_ban_until: blockUntil })\r\n         .eq('id', target.userId);\r\n\r\n       if (error) {\r\n          toast.error('Failed to block user');\r\n          return;\r\n       }\r\n       toast.success(`Blocked ${target.username} from bans for 24 hours`);\r\n       await recordAction('block', target.userId, target.username, fee, { block_until: blockUntil });\r\n  };\r\n\r\n  const handleUserClick = useCallback(async (participant: Participant) => {\r\n    let isOfficer = false;\r\n    // Check if officer if we are the broadcaster\r\n    if (stream?.broadcaster_id && participant.identity) {\r\n       // We can optimize this by keeping a list of officers in state\r\n       const { data } = await supabase.rpc('is_broadofficer', {\r\n         p_broadcaster_id: stream.broadcaster_id,\r\n         p_user_id: participant.identity\r\n       });\r\n       isOfficer = !!data;\r\n    }\r\n\r\n    setGeneralUserActionTarget({\r\n      userId: participant.identity,\r\n      username: participant.name || participant.identity,\r\n      role: 'user', // Ideally parse from metadata\r\n      isOfficer\r\n    });\r\n  }, [stream]);\r\n\r\n  const handleGiftSent = useCallback(\r\n    async (gift: GiftItem, targetModeOrSendToAll: RecipientMode | boolean) => {\r\n      const totalCoins = gift.value || 0;\r\n      if (totalCoins <= 0) return;\r\n\r\n      const sendToAll = typeof targetModeOrSendToAll === 'boolean' ? targetModeOrSendToAll : false;\r\n      const targetMode = typeof targetModeOrSendToAll === 'string' ? targetModeOrSendToAll : 'user';\r\n\r\n      const senderId = user?.id;\r\n      const streamIdValue = stream?.id;\r\n      const broadcasterId = stream?.broadcaster_id;\r\n      const canonicalGiftName = gift?.name || \"Gift\";\r\n      const canonicalGiftSlug = toGiftSlug(canonicalGiftName);\r\n\r\n      if (!senderId || !streamIdValue) {\r\n        toast.error(\"Unable to send gift right now.\");\r\n        return;\r\n      }\r\n\r\n      const recipients: string[] = [];\r\n\r\n      if (sendToAll) {\r\n        const viewers = activeViewers.filter(v => v.userId !== senderId).map(v => v.userId);\r\n        const uniqueRecipients = Array.from(new Set(viewers));\r\n        recipients.push(...uniqueRecipients);\r\n      } else {\r\n        const receiverId = targetMode === \"broadcaster\"\r\n          ? stream?.broadcaster_id\r\n          : giftReceiver?.id || stream?.broadcaster_id;\r\n\r\n        if (receiverId) recipients.push(receiverId);\r\n      }\r\n\r\n      if (recipients.length === 0) {\r\n        toast.error(\"No recipients found.\");\r\n        return;\r\n      }\r\n\r\n      setGiftReceiver(null);\r\n\r\n      let successCount = 0;\r\n\r\n      try {\r\n        const promises = recipients.map(async (receiverId) => {\r\n          // Optimistically update sender's balance immediately\r\n          optimisticDebit(totalCoins);\r\n          \r\n          const { data: spendResult, error } = await supabase.rpc(\"spend_coins\", {\r\n            p_sender_id: senderId,\r\n            p_receiver_id: receiverId,\r\n            p_coin_amount: totalCoins,\r\n            p_source: \"gift\",\r\n            p_item: canonicalGiftName,\r\n          });\r\n\r\n          if (error) throw error;\r\n\r\n          if (spendResult && typeof spendResult === 'object' && 'success' in spendResult && !(spendResult as any).success) {\r\n            const errorMsg = (spendResult as any).error || 'Failed to send gift';\r\n            throw new Error(errorMsg);\r\n          }\r\n\r\n          try {\r\n            if (streamIdValue) {\r\n              const giftId = (spendResult as any)?.gift_id;\r\n              if (giftId && typeof giftId === 'string') {\r\n                const { error: giftUpdateError } = await supabase\r\n                  .from('gifts')\r\n                  .update({\r\n                    stream_id: streamIdValue,\r\n                    gift_slug: canonicalGiftSlug,\r\n                  })\r\n                  .eq('id', giftId)\r\n                  .limit(1);\r\n\r\n                if (giftUpdateError) {\r\n                  console.warn('Could not update gift with stream context:', giftUpdateError);\r\n                }\r\n              }\r\n            }\r\n          } catch (streamGiftErr) {\r\n            console.warn('Failed to update gift stream context', streamGiftErr);\r\n          }\r\n\r\n          let xpResult = null;\r\n          try {\r\n            xpResult = await processGiftXp(senderId, receiverId, totalCoins);\r\n          } catch (xpErr) {\r\n            console.warn('[LivePage] Failed to process gift XP:', xpErr);\r\n          }\r\n\r\n          setGiftBalanceDelta({\r\n            userId: receiverId,\r\n            delta: totalCoins,\r\n            key: Date.now(),\r\n          });\r\n          successCount++;\r\n          return { receiverId, xpResult };\r\n        });\r\n\r\n        const results = await Promise.all(promises);\r\n\r\n        if (streamIdValue && senderId) {\r\n          const senderName = profile?.username || 'Someone';\r\n          const content = sendToAll\r\n            ? `${senderName} sent ${gift.name} to ${successCount} users`\r\n            : `${senderName} sent ${gift.name}`;\r\n          try {\r\n            await supabase.from('messages').insert({\r\n              stream_id: streamIdValue,\r\n              user_id: senderId,\r\n              content,\r\n              message_type: 'gift',\r\n            });\r\n          } catch (chatErr) {\r\n            console.warn('Failed to insert gift chat message', chatErr);\r\n          }\r\n        }\r\n\r\n        if (typeof refreshProfile === 'function') {\r\n          refreshProfile().catch((err) => {\r\n            console.warn('Failed to refresh profile after sending gift:', err);\r\n          });\r\n        }\r\n\r\n        setStream((prev) =>\r\n          prev\r\n            ? {\r\n                ...prev,\r\n                total_gifts_coins: (prev.total_gifts_coins || 0) + (totalCoins * successCount),\r\n              }\r\n            : prev\r\n        );\r\n\r\n        if (streamIdValue && broadcasterId) {\r\n          const eventType = totalCoins >= 1000 ? \"super_gift\" : \"gift\";\r\n          const themeIdToUse = lastThemeId || broadcastTheme?.id;\r\n\r\n          // Find broadcaster XP result if any\r\n          const broadcasterResult = results.find(r => r.receiverId === broadcasterId);\r\n          const broadcasterLevel = broadcasterResult?.xpResult?.receiverData?.level;\r\n          const broadcasterXp = broadcasterResult?.xpResult?.receiverData?.xp; \r\n\r\n          if (themeIdToUse) {\r\n            const themeEvents = recipients.map(rid => ({\r\n              room_id: streamIdValue,\r\n              broadcaster_id: broadcasterId,\r\n              user_id: senderId,\r\n              theme_id: themeIdToUse,\r\n              event_type: eventType,\r\n              payload: {\r\n                gift_slug: canonicalGiftSlug,\r\n                coins: totalCoins,\r\n                sender_id: senderId,\r\n                recipient_id: rid,\r\n                broadcaster_level: (rid === broadcasterId) ? broadcasterLevel : undefined,\r\n                broadcaster_xp: (rid === broadcasterId) ? broadcasterXp : undefined\r\n              }\r\n            }));\r\n\r\n            await supabase.from(\"broadcast_theme_events\").insert(themeEvents);\r\n          }\r\n        }\r\n\r\n        if (sendToAll) {\r\n          toast.success(`Sent ${gift.name} to ${successCount} users!`);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Failed to send gift:\", err);\r\n        toast.error(\"Failed to send some gifts. Please try again.\");\r\n      }\r\n    },\r\n    [stream?.id, user?.id, giftReceiver, stream?.broadcaster_id, broadcastTheme?.id, lastThemeId, refreshProfile, activeViewers, profile?.username, optimisticDebit]\r\n  );\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n    const channel = supabase\r\n      .channel(`broadcast-theme-events-${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'broadcast_theme_events',\r\n          filter: `room_id=eq.${streamId}`,\r\n        },\r\n        (payload) => {\r\n          // Handle Level Updates from Gift Events\r\n          if (payload.new?.payload?.broadcaster_level !== undefined) {\r\n             const newLevel = payload.new.payload.broadcaster_level;\r\n             const newXp = payload.new.payload.broadcaster_xp;\r\n             setStream(prev => {\r\n                if (!prev) return prev;\r\n                // Avoid unnecessary updates if unchanged\r\n                if (prev.broadcast_level_percent === newLevel && prev.broadcast_xp === newXp) return prev;\r\n                \r\n                return {\r\n                   ...prev,\r\n                   broadcast_level_percent: newLevel,\r\n                   broadcast_xp: newXp,\r\n                   last_level_update_at: new Date().toISOString()\r\n                };\r\n             });\r\n          }\r\n\r\n          if (!broadcastTheme?.reactive_enabled) return;\r\n          const eventType = payload.new?.event_type || 'gift';\r\n          const baseIntensity = Number(broadcastTheme?.reactive_intensity || 2);\r\n          const intensityBoost = eventType === 'super_gift' ? 2 : eventType === 'gift' ? 1 : 0;\r\n          const intensity = Math.max(1, Math.min(5, baseIntensity + intensityBoost));\r\n          const style = String(broadcastTheme?.reactive_style || 'pulse');\r\n          setReactiveEvent({ key: Date.now(), style, intensity });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId, broadcastTheme?.reactive_enabled, broadcastTheme?.reactive_intensity, broadcastTheme?.reactive_style]);\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    const fetchQuickGifts = async () => {\r\n      try {\r\n        setQuickGiftsLoading(true);\r\n        setQuickGiftsError(null);\r\n        const { data, error } = await supabase\r\n          .from(\"gift_items\")\r\n          .select(\"id,name,icon,value,category\")\r\n          .order(\"value\", { ascending: true });\r\n        if (!active) return;\r\n        if (error) throw error;\r\n        const payload: GiftItem[] = (data || []).map((item: any) => ({\r\n          id: item.id,\r\n          name: item.name,\r\n          icon: item.icon,\r\n          value: item.value,\r\n          category: item.category || \"Common\",\r\n        }));\r\n\r\n        const merged = [...payload, ...DEFAULT_GIFTS];\r\n        const seen = new Set<string>();\r\n        const deduped = merged.filter((g) => {\r\n          if (seen.has(g.id)) return false;\r\n          seen.add(g.id);\r\n          return true;\r\n        });\r\n\r\n        setQuickGifts(deduped);\r\n      } catch (err) {\r\n        if (!active) return;\r\n        console.error(\"[LivePage] Failed to load quick gifts:\", err);\r\n        setQuickGiftsError(\"Unable to load gifts. Showing default Quick Gifts.\");\r\n        setQuickGifts(DEFAULT_GIFTS);\r\n      } finally {\r\n        if (active) {\r\n          setQuickGiftsLoading(false);\r\n        }\r\n      }\r\n    };\r\n    fetchQuickGifts();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  // Sync active battle state for everyone\r\n  useEffect(() => {\r\n    if (!stream?.broadcaster_id) return;\r\n\r\n    const checkActiveBattle = async () => {\r\n      const { data } = await supabase\r\n        .from('troll_battles')\r\n        .select('*')\r\n        .or(`player1_id.eq.${stream.broadcaster_id},player2_id.eq.${stream.broadcaster_id}`)\r\n        .eq('status', 'active')\r\n        .maybeSingle();\r\n\r\n      if (data) {\r\n        setActiveBattle(data);\r\n      }\r\n    };\r\n\r\n    checkActiveBattle();\r\n    \r\n    const channel = supabase\r\n      .channel(`battles-broadcaster-${stream.broadcaster_id}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'troll_battles',\r\n          filter: `player1_id=eq.${stream.broadcaster_id}` \r\n        },\r\n        (payload) => {\r\n             if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {\r\n                 if (payload.new.status === 'active' || payload.new.status === 'matched') {\r\n                    setActiveBattle(payload.new as any);\r\n                } else if (payload.new.status === 'completed') {\r\n                    setActiveBattle(payload.new as any);\r\n                }\r\n             }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n      return () => {\r\n          supabase.removeChannel(channel);\r\n      }\r\n  }, [stream?.broadcaster_id]);\r\n\r\n  const handleCoinsPurchased = useCallback((_amount: number) => {\r\n    setIsCoinStoreOpen(false);\r\n  }, []);\r\n  \r\n  const handleSendCoins = useCallback((amount: number) => {\r\n    console.log('Sending coins:', amount);\r\n  }, []);\r\n\r\n  const handleSendCoinsToUser = useCallback((_user: string, amount: number) => {\r\n    console.log('Sending coins:', amount);\r\n    toast.info(`Sent ${amount} coins`);\r\n  }, []);\r\n\r\n  // Layout\r\n  const themeAssetType =\r\n    broadcastTheme?.asset_type ||\r\n    (broadcastTheme?.background_css ? 'css' : broadcastTheme?.image_url || broadcastTheme?.background_asset_url ? 'image' : null);\r\n  const imageUrl = broadcastTheme?.image_url || broadcastTheme?.background_asset_url || null;\r\n  const hasVideoBackground =\r\n    themeAssetType === 'video' && (broadcastTheme?.video_webm_url || broadcastTheme?.video_mp4_url);\r\n\r\n  if (isLoadingStream || !stream || !profile) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#03010c] via-[#05031a] to-[#110117] text-white flex items-center justify-center\">\r\n        <div className=\"text-center space-y-4\">\r\n          <div className=\"w-16 h-16 rounded-full border-2 border-purple-500/60 animate-pulse\" />\r\n          <p className=\"text-sm text-gray-300\">Loading broadcast...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"h-[100dvh] min-h-[100dvh] w-full flex flex-col text-white overflow-hidden relative pt-[env(safe-area-inset-top,0px)] pb-[calc(var(--bottom-nav-height)+env(safe-area-inset-bottom,0px))] lg:pt-0 lg:pb-0\">\r\n      {hasVideoBackground ? (\r\n        <video\r\n          className=\"fixed inset-0 w-full h-full object-cover -z-20\"\r\n          muted\r\n          loop\r\n          autoPlay\r\n          playsInline\r\n        >\r\n          {broadcastTheme?.video_webm_url && (\r\n            <source src={broadcastTheme.video_webm_url} type=\"video/webm\" />\r\n          )}\r\n          {broadcastTheme?.video_mp4_url && (\r\n            <source src={broadcastTheme.video_mp4_url} type=\"video/mp4\" />\r\n          )}\r\n        </video>\r\n      ) : (\r\n        <div\r\n          className=\"fixed inset-0 -z-20\"\r\n          style={{\r\n            backgroundColor: '#05010a',\r\n            ...(broadcastThemeStyle || {}),\r\n            ...(themeAssetType === 'image' && imageUrl\r\n              ? {\r\n                  backgroundImage: `url(${imageUrl})`,\r\n                  backgroundSize: 'cover',\r\n                  backgroundPosition: 'center',\r\n                  backgroundRepeat: 'no-repeat',\r\n                }\r\n              : {}),\r\n          }}\r\n        />\r\n      )}\r\n      <div className=\"fixed inset-0 bg-black/30 -z-10\" />\r\n      <div className={`fixed inset-0 pointer-events-none ${reactiveClass} -z-0`} />\r\n\r\n      <div className=\"relative z-10 w-full flex flex-col min-h-0 flex-1\">\r\n        <GlobalGiftBanner />\r\n\r\n      {needsPrivateGate && !privateAccessGranted && (\r\n        <div className=\"fixed inset-0 z-[210] flex items-center justify-center bg-black/90 px-4\">\r\n          <div className=\"w-full max-w-sm rounded-2xl border border-white/10 bg-[#0c0a16] p-6 shadow-xl\">\r\n            <h3 className=\"text-lg font-semibold text-white mb-2\">Private stream</h3>\r\n            <p className=\"text-sm text-gray-300 mb-4\">\r\n              This broadcast requires a password provided by the broadcaster. Enter it below to join.\r\n            </p>\r\n            <input\r\n              type=\"password\"\r\n              value={privatePasswordInput}\r\n              onChange={(e) => setPrivatePasswordInput(e.target.value)}\r\n              placeholder=\"Enter stream password\"\r\n              className=\"w-full bg-[#05060f] border border-purple-500/40 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-300 focus:outline-none mb-2\"\r\n            />\r\n            {privateAuthError && (\r\n              <p className=\"text-xs text-red-400 mb-2\">{privateAuthError}</p>\r\n            )}\r\n            <button\r\n              className=\"w-full py-2 rounded-lg bg-purple-600 hover:bg-purple-500 font-semibold text-sm\"\r\n              onClick={handlePrivatePasswordSubmit}\r\n            >\r\n              Submit password\r\n            </button>\r\n            {!user && (\r\n              <p className=\"mt-3 text-xs text-gray-400\">\r\n                You must be signed in to enter the password.\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n      {/* Entrance effect for all users */}\r\n      {entranceEffect && (\r\n        <div key={entranceEffectKey} className=\"fixed inset-0 z-[100] pointer-events-none\">\r\n          <EntranceEffect\r\n            username={entranceEffect.username}\r\n            role={entranceEffect.role}\r\n            profile={entranceEffect.profile}\r\n            userId={entranceEffect.userId}\r\n          />\r\n        </div>\r\n      )}\r\n\r\n      {/* Officer Action Bubble - Visible to broadcaster, staff (admin/secretary/pastor/officers), and broadofficers */}\r\n      {canUseOfficerTools && isOfficerBubbleVisible && (\r\n        <OfficerActionBubble\r\n          streamId={streamId || ''}\r\n          onAddBox={handleOfficerAddBox}\r\n          onDeductBox={handleOfficerDeductBox}\r\n          onEndBroadcast={handleOfficerEndBroadcast}\r\n          onMuteAll={handleOfficerMuteAll}\r\n          onKickAll={handleOfficerKickAll}\r\n          onDisableChat={handleOfficerDisableChat}\r\n          targets={officerTargets}\r\n          selectedTargetId={officerTargetId}\r\n          onTargetChange={setOfficerTargetId}\r\n          onMuteUser={handleOfficerMuteUser}\r\n          onDisableUserChat={handleOfficerDisableUserChat}\r\n          onKickUser={handleOfficerKickUser}\r\n          onRemoveSeat={handleOfficerRemoveSeat}\r\n          seatBans={seatBans}\r\n          onClearSeatBan={handleOfficerClearSeatBan}\r\n          onClose={() => setIsOfficerBubbleVisible(false)}\r\n          position={officerBubblePos}\r\n          onMouseDown={handleOfficerDragStart}\r\n          canManageBoxes={canManageBoxes}\r\n        />\r\n      )}\r\n      \r\n      {/* Header Area */}\r\n      <div className=\"shrink-0 px-[clamp(8px,2.5vw,14px)] pt-2 pb-2 flex flex-wrap justify-between items-center gap-2 z-10\">\r\n         <div className=\"flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 rounded-lg bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center shadow-[0_0_15px_rgba(147,51,234,0.5)]\">\r\n               <span className=\"font-bold text-lg text-white\">TC</span>\r\n            </div>\r\n            <div>\r\n               <h1 className=\"text-[clamp(14px,4vw,20px)] font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 shadow-purple-500/50 drop-shadow-md\">TROLL CITY</h1>\r\n               <p className=\"text-[clamp(10px,2.8vw,12px)] text-white/50 tracking-widest uppercase\">Live Broadcast</p>\r\n            </div>\r\n         </div>\r\n         \r\n         <div className=\"flex w-full lg:w-auto flex-wrap items-center justify-end gap-2 overflow-x-auto\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setUseFlyingChats((prev) => !prev)}\r\n              className={`lg:hidden px-2 py-1.5 rounded-lg border text-[10px] font-semibold uppercase tracking-wide transition ${\r\n                useFlyingChats\r\n                  ? 'border-emerald-400/60 bg-emerald-500/20 text-emerald-200'\r\n                  : 'border-white/15 bg-white/5 text-white/70'\r\n              }`}\r\n            >\r\n              {useFlyingChats ? 'Chat Box' : 'Flying Chats'}\r\n            </button>\r\n            {stream.is_live && (\r\n              isBroadcaster && stream.start_time ? (\r\n                <BroadcasterTimer startTime={stream.start_time} onClick={endStream} />\r\n              ) : (\r\n                <div className=\"flex items-center gap-2 px-3 py-1 bg-red-600/90 rounded-full border border-red-500/50 shadow-[0_0_10px_rgba(220,38,38,0.5)]\">\r\n                   <div className=\"w-2 h-2 rounded-full bg-white animate-ping\" />\r\n                   <span className=\"text-xs font-bold text-white tracking-wider\">LIVE</span>\r\n                </div>\r\n              )\r\n            )}\r\n\r\n            {isBroadcaster && (\r\n              <>\r\n                <button\r\n                  onClick={() => setControlPanelOpen(true)}\r\n                  className=\"px-2 py-1.5 rounded-xl border border-purple-500/30 bg-purple-900/20 text-[10px] font-bold uppercase tracking-wider text-purple-200 hover:bg-purple-800/40 hover:border-purple-400/50 transition-all shadow-[0_0_10px_rgba(147,51,234,0.2)] flex items-center gap-1\"\r\n                >\r\n                  <Settings size={14} />\r\n                  Settings\r\n                </button>\r\n                <button\r\n                  onClick={handleAddBox}\r\n                  className=\"px-2 py-1.5 rounded-xl border border-emerald-500/30 bg-emerald-900/20 text-[10px] font-bold uppercase tracking-wider text-emerald-200 hover:bg-emerald-800/40 hover:border-emerald-400/50 transition-all shadow-[0_0_10px_rgba(16,185,129,0.2)] flex items-center gap-1\"\r\n                >\r\n                  <Plus size={14} />\r\n                  Add Box\r\n                </button>\r\n                <button\r\n                  onClick={handleDeductBox}\r\n                  className=\"px-2 py-1.5 rounded-xl border border-amber-500/30 bg-amber-900/20 text-[10px] font-bold uppercase tracking-wider text-amber-200 hover:bg-amber-800/40 hover:border-amber-400/50 transition-all shadow-[0_0_10px_rgba(245,158,11,0.2)] flex items-center gap-1\"\r\n                >\r\n                  <Minus size={14} />\r\n                  Deduct Box\r\n                </button>\r\n                <button\r\n                  onClick={() => setShowTrollBattles(true)}\r\n                  className=\"px-2 py-1.5 rounded-xl border border-red-500/30 bg-red-900/20 text-[10px] font-bold uppercase tracking-wider text-red-200 hover:bg-red-800/40 hover:border-red-400/50 transition-all shadow-[0_0_10px_rgba(220,38,38,0.2)] flex items-center gap-1\"\r\n                >\r\n                  <Swords size={14} />\r\n                  Battles\r\n                </button>\r\n              </>\r\n            )}\r\n\r\n            <button\r\n              className=\"hidden lg:flex px-4 py-2 rounded-xl border border-blue-500/30 bg-blue-900/20 text-xs font-bold uppercase tracking-wider text-blue-200 hover:bg-blue-800/40 hover:border-blue-400/50 transition-all gap-2 items-center shadow-[0_0_10px_rgba(59,130,246,0.2)]\"\r\n              onClick={() => toast.info(\"Install App feature coming soon!\")}\r\n            >\r\n              <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"7 10 12 15 17 10\"/><line x1=\"12\" x2=\"12\" y1=\"15\" y2=\"3\"/></svg>\r\n              Install App\r\n            </button>\r\n            \r\n            <div className=\"relative\">\r\n              <button\r\n                ref={viewerButtonRef}\r\n                type=\"button\"\r\n                onClick={() => setIsViewerDropdownOpen((prev) => !prev)}\r\n                className=\"px-2 py-1.5 bg-white/5 rounded-lg border border-white/10 flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-green-400 transition\"\r\n                aria-expanded={isViewerDropdownOpen}\r\n              >\r\n                <Users size={16} className=\"text-green-400\" /> <span className=\"font-bold text-[clamp(11px,3vw,14px)]\">{viewerCount.toLocaleString()}</span>\r\n              </button>\r\n              {isViewerDropdownOpen && (\r\n                <div\r\n                  ref={viewerDropdownRef}\r\n                  className=\"absolute right-0 mt-2 w-64 max-h-72 overflow-hidden rounded-2xl border border-white/10 bg-black/95 shadow-[0_20px_50px_rgba(0,0,0,0.6)] z-20\"\r\n                >\r\n                  <div className=\"px-4 py-2 text-[10px] uppercase tracking-[0.3em] text-white/50\">\r\n                    Active viewers\r\n                  </div>\r\n                  <div className=\"divide-y divide-white/5 max-h-60 overflow-y-auto\">\r\n                    {activeViewers.length === 0 ? (\r\n                      <div className=\"px-4 py-3 text-xs text-white/60 text-center\">No active viewers</div>\r\n                    ) : (\r\n                      activeViewers.map((viewer) => (\r\n                        <div key={viewer.userId} className=\"flex items-center gap-3 px-4 py-2 hover:bg-white/5 transition\">\r\n                          <div className=\"h-8 w-8 rounded-full bg-white/10 text-xs font-semibold uppercase text-white flex items-center justify-center overflow-hidden\">\r\n                            {viewer.avatarUrl ? (\r\n                              <img src={viewer.avatarUrl} alt={viewer.username} className=\"h-full w-full object-cover\" />\r\n                            ) : (\r\n                              viewer.username?.charAt(0) ?? '?'\r\n                            )}\r\n                          </div>\r\n                          <div className=\"flex-1 min-w-0\">\r\n                            <p className=\"text-sm font-semibold text-white truncate\">{viewer.username}</p>\r\n                            {viewer.role && (\r\n                              <p className=\"text-[11px] text-white/60 capitalize\">{viewer.role}</p>\r\n                            )}\r\n                          </div>\r\n                          {viewer.isBroadcaster && (\r\n                            <span className=\"self-start whitespace-nowrap rounded-full border border-emerald-400/50 bg-emerald-500/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-300\">\r\n                              Host\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n                      ))\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {isBroadcaster && (\r\n              <>\r\n                <button onClick={toggleMic} className={`p-1.5 rounded-lg border ${micOn ? 'bg-purple-600 border-purple-400' : 'bg-red-900/50 border-red-500'}`}>\r\n                  {micOn ? <Mic size={18} /> : <MicOff size={18} />}\r\n                </button>\r\n                <button onClick={toggleCamera} className={`p-1.5 rounded-lg border ${cameraOn ? 'bg-purple-600 border-purple-400' : 'bg-red-900/50 border-red-500'}`}>\r\n                  {cameraOn ? <Camera size={18} /> : <CameraOff size={18} />}\r\n                </button>\r\n                <button\r\n                  onClick={switchCameraFacing}\r\n                  className=\"p-1.5 rounded-lg border bg-black/40 border-purple-500 text-purple-300\"\r\n                  title={cameraFacing === 'user' ? 'Switch to rear camera' : 'Switch to front camera'}\r\n                >\r\n                  <RefreshCw size={18} />\r\n                </button>\r\n              </>\r\n            )}\r\n         </div>\r\n      </div>\r\n\r\n      {/* Main Content Area */}\r\n      <div className=\"flex-1 min-h-0 flex flex-col lg:flex-row gap-2 px-[clamp(8px,2.5vw,12px)] pb-2 overflow-y-auto lg:overflow-hidden\">\r\n        {/* Live Stage (Video + Guests) */}\r\n        <div\r\n          className=\"flex flex-col min-h-0 gap-2 lg:gap-2 flex-1 relative z-0 video-cover\"\r\n          onClick={() => {\r\n            if (!showLivePanels) setShowLivePanels(true);\r\n          }}\r\n          onDoubleClick={(e) => {\r\n            handleOfficerDoubleClick(e);\r\n            openGiftPopup();\r\n          }}\r\n          onTouchEnd={handleStageTouchEnd}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          onKeyDown={(e) => {\r\n            if (e.key === 'Enter' || e.key === ' ') {\r\n              if (!showLivePanels) setShowLivePanels(true);\r\n            }\r\n          }}\r\n        >\r\n          {stream && (\r\n             <BroadcastLevelBar \r\n               streamId={stream.id} \r\n               currentLevel={stream.broadcast_level_percent || 0} \r\n               lastLevelUpdateAt={stream.last_level_update_at}\r\n               onLevelUpdate={loadStreamData}\r\n             />\r\n          )}\r\n\r\n          <div className=\"shrink-0 min-h-0 flex flex-col relative w-full\">\r\n            <BroadcastLayout \r\n              className=\"h-auto\"\r\n              streamId={streamId || ''}\r\n              room={liveKit.getRoom()} \r\n              broadcasterId={stream.broadcaster_id}\r\n              isHost={canModerateGuests}\r\n              boxCount={boxCount}\r\n              seats={seats}\r\n              onUserClick={handleUserClick}\r\n              hostSeatIndex={hostSeatIndex}\r\n              onHostSeatChange={(index) => {\r\n                setHostSeatIndex((prev) => {\r\n                  if (prev === index) return prev;\r\n                  console.log('[LivePage] Host seat index changed', {\r\n                    from: prev,\r\n                    to: index,\r\n                    broadcasterId: stream.broadcaster_id,\r\n                    cameraOn,\r\n                  });\r\n                  return index;\r\n                });\r\n              }}\r\n              joinPrice={joinPrice}\r\n              lastGift={lastGift}\r\n              backgroundStyle={broadcastThemeStyle}\r\n              onSetPrice={handleSetPrice}\r\n              onJoinRequest={handleJoinRequest}\r\n              onLeaveSession={handleLeaveSession}\r\n              onDisableGuestMedia={canModerateGuests ? handleDisableGuestMedia : undefined}\r\n              onSeatAction={handleSeatAction}\r\n              giftBalanceDelta={giftBalanceDelta}\r\n              // Media Controls\r\n              onToggleCamera={toggleCamera}\r\n              isCameraOn={cameraOn}\r\n              frameMode={currentFrameMode}\r\n              onFrameModeChange={isBroadcaster ? handleFrameModeChange : undefined}\r\n            >\r\n               <GiftEventOverlay gift={lastGift} onProfileClick={(p) => setSelectedProfile(p)} />\r\n            </BroadcastLayout>\r\n\r\n            {activeBattle && stream?.broadcaster_id && (\r\n               <TrollBattleOverlay\r\n                 battleId={activeBattle.id}\r\n                 broadcasterId={stream.broadcaster_id}\r\n                 initialBattleData={activeBattle}\r\n                 onBattleEnd={() => {\r\n                    setTimeout(() => setActiveBattle(null), 15000); \r\n                 }}\r\n               />\r\n            )}\r\n\r\n            {useFlyingChats && (\r\n              <div className=\"absolute inset-0 pointer-events-none lg:hidden\">\r\n                <div className=\"chat-container\">\r\n                  <div className=\"message-list\">\r\n                    <FlyingChatOverlay streamId={streamId || ''} />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Mobile Chat Panel (hidden when flying chats enabled) */}\r\n          {showLivePanels && !useFlyingChats && (\r\n            <div className=\"lg:hidden relative flex flex-col min-h-0 h-[clamp(160px,26vh,240px)] overflow-hidden rounded-xl border border-white/10 bg-black/40\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setChatOverlayOpen(true)}\r\n                className=\"absolute top-2 right-2 z-10 text-[10px] px-2 py-1 rounded-full border border-white/20 text-white/70 bg-black/40\"\r\n              >\r\n                Expand\r\n              </button>\r\n              <div className=\"flex-1 min-h-0 overflow-hidden\">\r\n                <ChatBox \r\n                  streamId={streamId || ''} \r\n                  onProfileClick={setSelectedProfile}\r\n                  onCoinSend={handleSendCoinsToUser}\r\n                  room={liveKit.getRoom()}\r\n                  isBroadcaster={isBroadcaster}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Desktop Right Panel (Chat/Gifts) */}\r\n        {showLivePanels && (\r\n          <div className=\"hidden lg:flex w-[300px] shrink-0 lg:h-full min-h-0 flex-col gap-3 overflow-hidden relative z-0\">\r\n            <div className=\"flex flex-col flex-[1] min-h-0 overflow-hidden\">\r\n              <div className=\"flex-1 min-h-0 overflow-hidden rounded-xl border border-white/10 bg-black/40\">\r\n                <div className=\"px-3 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/60 border-b border-white/10\">Gifts</div>\r\n                <div className=\"h-full min-h-0 overflow-y-auto pr-2 pb-[env(safe-area-inset-bottom)]\">\r\n                  <GiftBox\r\n                    onSendGift={handleGiftSent}\r\n                    gifts={quickGifts}\r\n                    loading={quickGiftsLoading}\r\n                    loadError={quickGiftsError}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex flex-col flex-[1] min-h-0\">\r\n              <div className=\"flex-1 min-h-0 flex flex-col overflow-hidden rounded-xl border border-white/10 bg-black/40\">\r\n                <div className=\"px-3 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/60 border-b border-white/10\">\r\n                  <span>Chat</span>\r\n                </div>\r\n                <div className=\"flex-1 min-h-0\">\r\n                  <ChatBox \r\n                    streamId={streamId || ''} \r\n                    onProfileClick={setSelectedProfile}\r\n                    onCoinSend={handleSendCoinsToUser}\r\n                    room={liveKit.getRoom()}\r\n                    isBroadcaster={isBroadcaster}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {useFlyingChats && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setChatOverlayOpen(true)}\r\n          className=\"lg:hidden fixed right-3 bottom-[calc(var(--bottom-nav-height)+env(safe-area-inset-bottom,0px)+12px)] z-[70] px-3 py-2 rounded-full bg-purple-600/90 border border-purple-400/60 text-xs font-bold uppercase tracking-wider shadow-[0_0_15px_rgba(147,51,234,0.6)]\"\r\n        >\r\n          Chat\r\n        </button>\r\n      )}\r\n\r\n      {/* Modals */}\r\n      {showTrollBattles && (\r\n        <div className=\"fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200\">\r\n          <div className=\"w-full max-w-md relative\">\r\n            <button\r\n              onClick={() => setShowTrollBattles(false)}\r\n              className=\"absolute -top-12 right-0 p-2 text-white/50 hover:text-white transition-colors\"\r\n            >\r\n              <X size={24} />\r\n            </button>\r\n            <TrollBattlesSetup\r\n              streamId={streamId || ''}\r\n              onOpponentFound={async (opponent, battleId) => {\r\n                try {\r\n                  const { error } = await supabase\r\n                    .from('troll_battles')\r\n                    .update({ status: 'active', started_at: new Date().toISOString() })\r\n                    .eq('id', battleId);\r\n\r\n                  if (error) throw error;\r\n\r\n                  setActiveBattle({ \r\n                    id: battleId, \r\n                    player1_id: user?.id, \r\n                    player2_id: opponent.id, \r\n                    status: 'active' \r\n                  });\r\n                  setShowTrollBattles(false);\r\n                } catch (err) {\r\n                  console.error('Failed to start battle:', err);\r\n                  toast.error('Failed to start battle');\r\n                }\r\n              }}\r\n              onCancel={() => setShowTrollBattles(false)}\r\n            />\r\n          </div>\r\n        </div>\r\n      )}\r\n      {isGiftModalOpen && (\r\n        <GiftModal \r\n          onClose={() => { setIsGiftModalOpen(false); setGiftReceiver(null); }} \r\n          onSendGift={handleGiftSent} \r\n          recipientName={giftReceiver?.username || giftReceiver?.name} \r\n          profile={profile}\r\n        />\r\n      )}\r\n      {selectedProfile && (\r\n        <ProfileModal \r\n          profile={selectedProfile} \r\n          currentUser={user}\r\n          onClose={() => setSelectedProfile(null)} \r\n          onSendCoins={handleSendCoins} \r\n          onGift={(profile: { id: string; username?: string; name?: string }) => {\r\n            setGiftReceiver(profile);\r\n            setIsGiftModalOpen(true);\r\n            setSelectedProfile(null);\r\n          }}\r\n          onMessageUser={(target: { id: string; username?: string; name?: string; avatar_url?: string | null }) => {\r\n            openMessageBubble(target);\r\n            setSelectedProfile(null);\r\n          }}\r\n        />\r\n      )}\r\n      {messageBubbleOpen && messageBubbleTarget && (\r\n        <div className=\"fixed inset-0 z-[180] pointer-events-none\">\r\n          <div\r\n            className=\"max-w-sm w-full bg-[#05010a]/95 border border-white/10 rounded-2xl shadow-2xl p-4 pointer-events-auto\"\r\n            style={\r\n              messageBubblePosition\r\n                ? {\r\n                    position: 'fixed',\r\n                    left: messageBubblePosition.x,\r\n                    top: messageBubblePosition.y,\r\n                  }\r\n                : undefined\r\n            }\r\n          >\r\n            <div className=\"flex items-center justify-between mb-3\">\r\n              <div\r\n                className=\"flex items-center gap-2 cursor-move select-none\"\r\n                onMouseDown={handleMessageBubbleMouseDown}\r\n              >\r\n                {messageBubbleTarget.avatar_url && (\r\n                  <div className=\"h-8 w-8 rounded-full overflow-hidden bg-white/10\">\r\n                    <img\r\n                      src={messageBubbleTarget.avatar_url}\r\n                      alt={messageBubbleTarget.username || ''}\r\n                      className=\"h-full w-full object-cover\"\r\n                    />\r\n                  </div>\r\n                )}\r\n                <div className=\"text-sm font-semibold\">\r\n                  Message {messageBubbleTarget.username || 'user'}\r\n                </div>\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setMessageBubbleOpen(false)}\r\n                className=\"text-xs px-2 py-1 rounded-full border border-white/30 text-white/70 hover:bg-white/10\"\r\n              >\r\n                √ó\r\n              </button>\r\n            </div>\r\n            <textarea\r\n              value={messageBubbleText}\r\n              onChange={(e) => setMessageBubbleText(e.target.value)}\r\n              rows={3}\r\n              className=\"w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-sm text-white placeholder-white/40 resize-none\"\r\n              placeholder=\"Type your message...\"\r\n            />\r\n            <div className=\"mt-3 flex justify-end gap-2\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setMessageBubbleOpen(false)}\r\n                className=\"px-3 py-1.5 rounded-full text-xs border border-white/20 text-white/70 hover:bg-white/5\"\r\n              >\r\n                Close\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleSendBubbleMessage}\r\n                disabled={!messageBubbleText.trim() || messageBubbleSending}\r\n                className=\"px-3 py-1.5 rounded-full text-xs font-semibold bg-purple-600 hover:bg-purple-500 disabled:bg-purple-900 disabled:text-white/40\"\r\n              >\r\n                {messageBubbleSending ? 'Sending...' : 'Send'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {seatActionTarget && (\r\n      <UserActionsMenu\r\n          user={{\r\n            name: seatActionTarget.username || 'Seat occupant',\r\n            role: seatActionTarget.role as any,\r\n          }}\r\n          userRole={profile?.role}\r\n          onClose={closeSeatActionMenu}\r\n          onGift={handleSeatGift}\r\n          onKick={handleSeatKick}\r\n          onKickWithBan={async (duration) => {\r\n            if (!seatActionTarget) return;\r\n            let minutes: number | null = null;\r\n            if (duration === '5m') minutes = 5;\r\n            if (duration === '30m') minutes = 30;\r\n            if (duration === '1h') minutes = 60;\r\n            const banMinutes = duration === 'permanent' ? null : minutes;\r\n            try {\r\n              await releaseSeat(seatActionTarget.seatIndex, seatActionTarget.userId, {\r\n                force: true,\r\n                banMinutes,\r\n                banPermanent: duration === 'permanent',\r\n              });\r\n              if (duration === 'permanent') {\r\n                toast.success('Guest removed and permanently blocked from guest box');\r\n              } else if (banMinutes) {\r\n                toast.success(\r\n                  `Guest removed and blocked from guest box for ${banMinutes} minutes`\r\n                );\r\n              } else {\r\n                toast.success('Guest removed from seat');\r\n              }\r\n              closeSeatActionMenu();\r\n            } catch (err) {\r\n              console.error('Failed to remove guest with timeout', err);\r\n              toast.error('Failed to remove guest');\r\n            }\r\n          }}\r\n          onReport={handleSeatReport}\r\n          onFollow={handleSeatFollow}\r\n          onSummon={handleSeatSummon}\r\n          onMute={() => handleMute({ userId: seatActionTarget.userId, username: seatActionTarget.username || '' })}\r\n          onUnmute={() => handleUnmute({ userId: seatActionTarget.userId, username: seatActionTarget.username || '' })}\r\n          onBlock={() => handleBlock({ userId: seatActionTarget.userId, username: seatActionTarget.username || '' })}\r\n          isCurrentUserBroadofficer={isCurrentUserBroadofficer}\r\n          isBroadcaster={isBroadcaster}\r\n          isBroadofficer={seatActionTarget.isOfficer}\r\n        />\r\n      )}\r\n      {generalUserActionTarget && (\r\n        <UserActionsMenu\r\n          user={{\r\n            name: generalUserActionTarget.username,\r\n            role: generalUserActionTarget.role,\r\n          }}\r\n          userRole={profile?.role}\r\n          onClose={() => setGeneralUserActionTarget(null)}\r\n          onKick={handleGeneralKick}\r\n          onAssignOfficer={handleAssignOfficer}\r\n          onRemoveOfficer={handleRemoveOfficer}\r\n          isBroadofficer={generalUserActionTarget.isOfficer}\r\n          isBroadcaster={isBroadcaster}\r\n          isCurrentUserBroadofficer={isCurrentUserBroadofficer}\r\n          onGift={(amount) => handleSendCoinsToUser(generalUserActionTarget.userId, amount)}\r\n          onMute={() => handleMute({ userId: generalUserActionTarget.userId, username: generalUserActionTarget.username })}\r\n          onUnmute={() => handleUnmute({ userId: generalUserActionTarget.userId, username: generalUserActionTarget.username })}\r\n          onBlock={() => handleBlock({ userId: generalUserActionTarget.userId, username: generalUserActionTarget.username })}\r\n        />\r\n      )}\r\n      {isCoinStoreOpen && <CoinStoreModal onClose={() => setIsCoinStoreOpen(false)} onPurchase={handleCoinsPurchased} />}\r\n      {chatOverlayOpen && (\r\n        <div className=\"fixed inset-0 z-50 flex flex-col justify-end bg-black/50 p-2 md:hidden\">\r\n          <div className=\"w-full max-h-[80vh] bg-[#05010a] rounded-t-2xl border border-white/10 overflow-hidden pb-[env(safe-area-inset-bottom,0px)]\">\r\n            <div className=\"flex items-center justify-between px-4 py-3 border-b border-white/10\">\r\n              <h3 className=\"text-sm font-bold uppercase tracking-[0.3em] text-white/60\">Live Chat</h3>\r\n              <button\r\n                onClick={() => setChatOverlayOpen(false)}\r\n                className=\"text-white/60 hover:text-white text-sm\"\r\n              >\r\n                Close\r\n              </button>\r\n            </div>\r\n            <div className=\"flex-1 min-h-0 overflow-hidden p-3\">\r\n              <ChatBox\r\n                streamId={streamId || ''}\r\n                onProfileClick={setSelectedProfile}\r\n                onCoinSend={handleSendCoinsToUser}\r\n                room={liveKit.getRoom()}\r\n                isBroadcaster={isBroadcaster}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {isBroadcaster && controlPanelOpen && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4\">\r\n          <div className=\"relative w-full max-w-4xl\">\r\n            <button\r\n              onClick={() => setControlPanelOpen(false)}\r\n              className=\"absolute right-3 top-3 text-white/60 hover:text-white\"\r\n            >\r\n              Close\r\n            </button>\r\n            <div className=\"bg-[#05010a] border border-white/10 rounded-3xl shadow-2xl overflow-hidden\">\r\n              <BroadcasterSettings\r\n                streamId={streamId || ''}\r\n                broadcasterId={stream?.broadcaster_id}\r\n                onAlertOfficers={handleAlertOfficers}\r\n                joinPrice={joinPrice}\r\n                onSetPrice={handleSetPrice}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\LivingPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Key' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Key"},"fix":{"range":[186,191],"text":""},"desc":"Remove unused variable \"Key\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profile' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":44,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'checkLandlordStatus', 'fetchMyLease', 'fetchMyLoans', and 'fetchOwnedProperties'. Either include them or remove the dependency array.","line":69,"column":6,"nodeType":"ArrayExpression","endLine":69,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [user, activeTab, marketFilter, checkLandlordStatus, fetchMyLease, fetchMyLoans, fetchOwnedProperties]","fix":{"range":[2329,2360],"text":"[user, activeTab, marketFilter, checkLandlordStatus, fetchMyLease, fetchMyLoans, fetchOwnedProperties]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":73,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":85,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":107,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":107,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":122,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":122,"endColumn":24},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":426,"column":39,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[15322,15355],"text":"You don&apos;t own any properties yet."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[15322,15355],"text":"You don&lsquo;t own any properties yet."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[15322,15355],"text":"You don&#39;t own any properties yet."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[15322,15355],"text":"You don&rsquo;t own any properties yet."},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":552,"column":76,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[24296,24370],"text":"You currently don&apos;t have a place to live. Check the market to find a home."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[24296,24370],"text":"You currently don&lsquo;t have a place to live. Check the market to find a home."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[24296,24370],"text":"You currently don&#39;t have a place to live. Check the market to find a home."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[24296,24370],"text":"You currently don&rsquo;t have a place to live. Check the market to find a home."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { useAuthStore } from '../lib/store';\nimport { supabase } from '../lib/supabase';\nimport { toast } from 'sonner';\nimport { Home, Key, DollarSign, Building, Warehouse, Hotel, Tent, Briefcase, Edit2, X, Zap, Droplets } from 'lucide-react';\n\ninterface Property {\n  id: string;\n  name: string;\n  type_id: string;\n  rent_amount: number;\n  utility_cost?: number; // Legacy field\n  electric_cost?: number;\n  water_cost?: number;\n  owner_id: string | null;\n  is_for_rent: boolean;\n  is_for_sale: boolean;\n  price: number;\n  last_rent_change_at?: string;\n}\n\ninterface Lease {\n  id: string;\n  property: Property;\n  start_date: string;\n  rent_due_day: number;\n  last_rent_paid_at: string;\n  status: string;\n}\n\ninterface Loan {\n  id: string;\n  property: Property;\n  amount: number; // total amount\n  remaining_balance: number;\n  loan_type: string;\n  status: 'active' | 'paid' | 'defaulted';\n  // calculated for UI\n  monthly_payment: number; \n  next_payment_due_at: string;\n}\n\nexport default function LivingPage() {\n  const { user, profile } = useAuthStore();\n  const [activeTab, setActiveTab] = useState<'my_home' | 'my_loans' | 'market' | 'landlord'>('my_home');\n  const [marketFilter, setMarketFilter] = useState<'rent' | 'sale'>('rent');\n  const [myLease, setMyLease] = useState<Lease | null>(null);\n  const [myLoans, setMyLoans] = useState<Loan[]>([]);\n  const [properties, setProperties] = useState<Property[]>([]);\n  const [ownedProperties, setOwnedProperties] = useState<(Property & { active_lease?: Lease & { tenant: { username: string } } })[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [buyingProp, setBuyingProp] = useState<Property | null>(null);\n  const [downPayment, setDownPayment] = useState<string>('');\n  const [isLandlord, setIsLandlord] = useState(false);\n  \n  // Landlord Edit State\n  const [editingProp, setEditingProp] = useState<Property | null>(null);\n  const [editName, setEditName] = useState('');\n  const [editRent, setEditRent] = useState('');\n\n  useEffect(() => {\n    if (user) {\n      checkLandlordStatus();\n      if (activeTab === 'my_home') fetchMyLease();\n      if (activeTab === 'my_loans') fetchMyLoans();\n      if (activeTab === 'market') fetchMarket();\n      if (activeTab === 'landlord') fetchOwnedProperties();\n    }\n  }, [user, activeTab, marketFilter]);\n\n  const checkLandlordStatus = async () => {\n    if (!user) return;\n    const { data, error } = await supabase\n      .from('user_profiles')\n      .select('is_landlord')\n      .eq('id', user.id)\n      .single();\n    \n    if (data) setIsLandlord(data.is_landlord || false);\n  };\n\n  const fetchOwnedProperties = async () => {\n    setLoading(true);\n    // Fetch properties owned by user\n    const { data: props, error } = await supabase\n      .from('properties')\n      .select('*')\n      .eq('owner_id', user?.id);\n\n    if (props) {\n      // For each property, fetch active lease if any\n      const propsWithLease = await Promise.all(props.map(async (p) => {\n        const { data: lease } = await supabase\n          .from('leases')\n          .select('*, tenant:user_profiles(username)')\n          .eq('property_id', p.id)\n          .eq('status', 'active')\n          .maybeSingle();\n        return { ...p, active_lease: lease };\n      }));\n      setOwnedProperties(propsWithLease);\n    }\n    setLoading(false);\n  };\n\n  const fetchMyLease = async () => {\n    const { data, error } = await supabase\n      .from('leases')\n      .select('*, property:properties(*)')\n      .eq('tenant_id', user?.id)\n      .eq('status', 'active')\n      .maybeSingle();\n    \n    if (data) setMyLease(data);\n    else setMyLease(null);\n  };\n\n  const fetchMyLoans = async () => {\n    setLoading(true);\n    // Note: 'bank_loans' is the table, but we need property details.\n    // Ensure RLS allows reading properties even if not owner (public read is on).\n    const { data, error } = await supabase\n      .from('bank_loans')\n      .select('*, property:properties(*)')\n      .eq('user_id', user?.id)\n      .eq('status', 'active');\n    \n    if (data) {\n        // Map to Loan interface\n        const loans = data.map((l: any) => ({\n            ...l,\n            // Mocking payment schedule for UI as it's not in DB yet\n            monthly_payment: Math.ceil(l.amount / 50), \n            next_payment_due_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()\n        }));\n        setMyLoans(loans);\n    }\n    setLoading(false);\n  };\n\n  const fetchMarket = async () => {\n    setLoading(true);\n    \n    // First, get IDs of active landlords\n    const { data: landlords } = await supabase\n      .from('user_profiles')\n      .select('id')\n      .eq('is_landlord', true);\n    \n    const landlordIds = landlords?.map(l => l.id) || [];\n    \n    if (landlordIds.length === 0) {\n      setProperties([]);\n      setLoading(false);\n      return;\n    }\n    \n    const query = supabase\n      .from('properties')\n      .select('*')\n      .in('owner_id', landlordIds)\n      .eq('is_for_rent', true)\n      .limit(50);\n\n    const { data: properties } = await query;\n    \n    if (properties) {\n      // Filter out properties that have active leases\n      const availableProperties = await Promise.all(properties.map(async (prop) => {\n        const { data: lease } = await supabase\n          .from('leases')\n          .select('id')\n          .eq('property_id', prop.id)\n          .eq('status', 'active')\n          .maybeSingle();\n        \n        if (!lease) {\n          return prop;\n        }\n        return null;\n      }));\n      \n      setProperties(availableProperties.filter((p): p is Property => p !== null));\n    } else {\n      setProperties([]);\n    }\n    setLoading(false);\n  };\n\n  const handleRent = async (propertyId: string, cost: number) => {\n    if (!confirm(`Rent this property? Initial cost: ${cost} coins (Rent + Utilities)`)) return;\n    \n    try {\n      const { data, error } = await supabase.rpc('sign_lease', { p_property_id: propertyId });\n      \n      if (error) throw error;\n      if (data && !data.success) throw new Error(data.error);\n\n      toast.success('Welcome home!');\n      fetchMyLease();\n      setActiveTab('my_home');\n    } catch (err: any) {\n      toast.error(err.message);\n    }\n  };\n\n  const handlePayRent = async () => {\n    if (!myLease) return;\n    const total = myLease.property.rent_amount + (myLease.property.electric_cost ?? (myLease.property.utility_cost ?? 0) / 2) + (myLease.property.water_cost ?? (myLease.property.utility_cost ?? 0) / 2);\n    if (!confirm(`Pay rent, electric, and water? Total: ${total} coins`)) return;\n\n    try {\n      const { data, error } = await supabase.rpc('pay_rent', { p_lease_id: myLease.id });\n      \n      if (error) throw error;\n      if (data && !data.success) throw new Error(data.error);\n\n      toast.success('Rent paid successfully!');\n      fetchMyLease();\n    } catch (err: any) {\n      toast.error(err.message);\n    }\n  };\n\n  const initiateBuy = (prop: Property) => {\n    setBuyingProp(prop);\n    setDownPayment(Math.ceil(prop.price * 0.1).toString());\n  };\n\n  const handleBuyWithLoan = async () => {\n    if (!buyingProp) return;\n    const dp = parseInt(downPayment);\n    if (isNaN(dp) || dp < buyingProp.price * 0.1) {\n      toast.error('Down payment must be at least 10%');\n      return;\n    }\n\n    try {\n      const { data, error } = await supabase.rpc('buy_property_with_loan', { \n        p_property_id: buyingProp.id,\n        p_down_payment: dp\n      });\n      \n      if (error) throw error;\n      if (data && !data.success) throw new Error(data.error);\n\n      toast.success('Property purchased successfully!');\n      setBuyingProp(null);\n      setActiveTab('my_loans');\n    } catch (err: any) {\n      toast.error(err.message);\n    }\n  };\n\n  const handlePayLoan = async (loan: Loan) => {\n    const amount = prompt(`How much to pay? (Remaining: ${loan.remaining_balance}, Weekly Due: ${loan.monthly_payment})`, loan.monthly_payment.toString());\n    if (!amount) return;\n    \n    const payAmount = parseInt(amount);\n    if (isNaN(payAmount) || payAmount <= 0) return;\n\n    try {\n      const { data, error } = await supabase.rpc('pay_loan', { \n        p_loan_id: loan.id,\n        p_amount: payAmount\n      });\n      \n      if (error) throw error;\n      if (data && !data.success) throw new Error(data.error);\n\n      toast.success('Loan payment successful!');\n      fetchMyLoans();\n    } catch (err: any) {\n      toast.error(err.message);\n    }\n  };\n\n  const handleBecomeLandlord = async () => {\n    if (!confirm('Become a licensed landlord for 7,000 coins? This allows you to collect rent.')) return;\n\n    try {\n        const { data, error } = await supabase.rpc('purchase_landlord_license');\n        if (error) throw error;\n        if (data && !data.success) throw new Error(data.error);\n\n        toast.success('You are now a licensed Landlord!');\n        setIsLandlord(true);\n        fetchOwnedProperties();\n    } catch (err: any) {\n        toast.error(err.message);\n    }\n  };\n\n  const getIcon = (type: string) => {\n    switch (type) {\n      case 'mansion': return <Hotel className=\"w-6 h-6 text-yellow-400\" />;\n      case 'house': return <Home className=\"w-6 h-6 text-blue-400\" />;\n      case 'apartment': return <Building className=\"w-6 h-6 text-green-400\" />;\n      case 'trailer': return <Warehouse className=\"w-6 h-6 text-orange-400\" />;\n      default: return <Tent className=\"w-6 h-6 text-gray-400\" />;\n    }\n  };\n\n  const canChangeRent = (property: Property) => {\n    if (!property.last_rent_change_at) return true;\n    const lastChange = new Date(property.last_rent_change_at);\n    const daysSinceChange = (Date.now() - lastChange.getTime()) / (1000 * 60 * 60 * 24);\n    return daysSinceChange >= 30;\n  };\n\n  const getDaysUntilRentChange = (property: Property) => {\n    if (!property.last_rent_change_at) return 0;\n    const lastChange = new Date(property.last_rent_change_at);\n    const daysSinceChange = (Date.now() - lastChange.getTime()) / (1000 * 60 * 60 * 24);\n    return Math.max(0, Math.ceil(30 - daysSinceChange));\n  };\n\n  const handleUpdateProperty = async () => {\n    if (!editingProp) return;\n    \n    const newRent = parseInt(editRent);\n    if (isNaN(newRent) || newRent < 0) {\n      toast.error('Invalid rent amount');\n      return;\n    }\n\n    // Check if rent changed and if allowed\n    if (newRent !== editingProp.rent_amount && !canChangeRent(editingProp)) {\n      toast.error('Rent can only be changed once every 30 days');\n      return;\n    }\n\n    try {\n      const { error } = await supabase\n        .from('properties')\n        .update({ \n          name: editName,\n          rent_amount: newRent,\n          last_rent_change_at: newRent !== editingProp.rent_amount ? new Date().toISOString() : editingProp.last_rent_change_at\n        })\n        .eq('id', editingProp.id);\n\n      if (error) throw error;\n\n      toast.success('Property updated successfully!');\n      setEditingProp(null);\n      fetchOwnedProperties();\n    } catch (err: any) {\n      toast.error(err.message);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-4 pb-20 md:pb-4 md:ml-64\">\n      <div className=\"max-w-4xl mx-auto space-y-6\">\n        \n        <header className=\"flex items-center justify-between mb-8\">\n            <div>\n                <h1 className=\"text-3xl font-bold flex items-center gap-3\">\n                    <Home className=\"text-purple-500\" /> Living & Housing\n                </h1>\n                <p className=\"text-gray-400 text-sm mt-1\">Manage your residence, pay rent, or find a new home.</p>\n            </div>\n            <div className=\"flex bg-zinc-900 rounded-lg p-1 border border-zinc-800\">\n                <button \n                    onClick={() => setActiveTab('my_home')}\n                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'my_home' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\n                >\n                    My Home\n                </button>\n                <button \n                    onClick={() => setActiveTab('my_loans')}\n                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'my_loans' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\n                >\n                    My Loans\n                </button>\n                <button \n                    onClick={() => setActiveTab('market')}\n                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'market' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\n                >\n                    Find Home\n                </button>\n                <button \n                    onClick={() => setActiveTab('landlord')}\n                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'landlord' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\n                >\n                    Landlord\n                </button>\n            </div>\n        </header>\n\n        {activeTab === 'landlord' && (\n            <div className=\"space-y-6\">\n                {!isLandlord ? (\n                    <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-950 border border-zinc-800 rounded-2xl p-10 text-center\">\n                        <Briefcase className=\"w-16 h-16 text-yellow-500 mx-auto mb-4\" />\n                        <h2 className=\"text-2xl font-bold text-white mb-2\">Become a Landlord</h2>\n                        <p className=\"text-gray-400 mb-6 max-w-md mx-auto\">\n                            Purchase a Landlord License to start collecting rent from properties you own. \n                            As a landlord, you keep 90% of rent (10% tax).\n                        </p>\n                        <div className=\"flex justify-center gap-4\">\n                            <button \n                                onClick={handleBecomeLandlord}\n                                className=\"bg-yellow-600 hover:bg-yellow-500 text-white px-8 py-3 rounded-xl font-bold transition-all flex items-center gap-2\"\n                            >\n                                <DollarSign className=\"w-5 h-5\" />\n                                Buy License (7,000 Coins)\n                            </button>\n                        </div>\n                    </div>\n                ) : (\n                    <>\n                    <div className=\"flex items-center justify-between mb-4\">\n                        <h2 className=\"text-xl font-bold text-white\">My Properties</h2>\n                        <div className=\"text-sm text-gray-400\">\n                            Total Monthly Income: <span className=\"text-green-400 font-bold\">{ownedProperties.reduce((acc, p) => acc + (p.active_lease ? p.rent_amount : 0), 0).toLocaleString()}</span>\n                        </div>\n                    </div>\n\n                    {loading ? (\n                        <div className=\"text-center py-10 text-gray-500\">Loading properties...</div>\n                    ) : ownedProperties.length === 0 ? (\n                        <div className=\"text-center py-10 text-gray-500 bg-zinc-900/50 rounded-xl border border-zinc-800\">\n                            <Building className=\"w-12 h-12 text-gray-600 mx-auto mb-3\" />\n                            <p>You don't own any properties yet.</p>\n                            <button onClick={() => { setActiveTab('market'); setMarketFilter('sale'); }} className=\"mt-4 text-purple-400 hover:text-purple-300 text-sm font-bold\">\n                                Buy a property\n                            </button>\n                        </div>\n                    ) : (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            {ownedProperties.map(prop => (\n                                <div key={prop.id} className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-xl p-5 relative overflow-hidden group hover:border-purple-500/30 transition-all\">\n                                    <div className=\"flex justify-between items-start mb-3\">\n                                        <div className=\"flex items-center gap-3\">\n                                            {getIcon(prop.type_id)}\n                                            <div>\n                                                <h3 className=\"font-bold text-white\">{prop.name}</h3>\n                                                <div className=\"text-xs text-gray-500 uppercase tracking-wider\">{prop.type_id}</div>\n                                            </div>\n                                        </div>\n                                        <div className=\"flex items-center gap-2\">\n                                            <button \n                                                onClick={() => {\n                                                    setEditingProp(prop);\n                                                    setEditName(prop.name);\n                                                    setEditRent(prop.rent_amount.toString());\n                                                }}\n                                                className=\"p-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-gray-400 hover:text-white transition-colors\"\n                                                title=\"Edit Property\"\n                                            >\n                                                <Edit2 className=\"w-4 h-4\" />\n                                            </button>\n                                            <div className={`px-2 py-1 rounded text-xs font-bold ${prop.active_lease ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>\n                                                {prop.active_lease ? 'RENTED' : 'VACANT'}\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    <div className=\"space-y-3 text-sm border-t border-white/5 pt-3\">\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-gray-500\">Rent Price</span>\n                                            <span className=\"text-white font-mono\">{prop.rent_amount.toLocaleString()}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-gray-500\">Electric Cost</span>\n                                            <span className=\"text-white font-mono\">{(prop.electric_cost ?? (prop.utility_cost ?? 0) / 2).toLocaleString()}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-gray-500\">Water Cost</span>\n                                            <span className=\"text-white font-mono\">{(prop.water_cost ?? (prop.utility_cost ?? 0) / 2).toLocaleString()}</span>\n                                        </div>\n                                        \n                                        {prop.active_lease ? (\n                                            <div className=\"bg-green-500/10 rounded-lg p-3 mt-2 border border-green-500/20\">\n                                                <div className=\"text-xs text-green-400 mb-1 font-bold\">CURRENT TENANT</div>\n                                                <div className=\"flex justify-between items-center\">\n                                                    <span className=\"text-white\">{prop.active_lease.tenant?.username || 'Unknown Tenant'}</span>\n                                                    <span className=\"text-xs text-gray-400\">Since {new Date(prop.active_lease.start_date).toLocaleDateString()}</span>\n                                                </div>\n                                                <div className=\"mt-2 text-xs flex justify-between border-t border-green-500/10 pt-2\">\n                                                    <span className=\"text-gray-400\">Last Paid</span>\n                                                    <span className=\"text-white\">{prop.active_lease.last_rent_paid_at ? new Date(prop.active_lease.last_rent_paid_at).toLocaleDateString() : 'Never'}</span>\n                                                </div>\n                                            </div>\n                                        ) : (\n                                            <div className=\"bg-yellow-500/5 rounded-lg p-3 mt-2 border border-yellow-500/10 text-center\">\n                                                <p className=\"text-yellow-200/70 text-xs\">Property is currently empty.</p>\n                                            </div>\n                                        )}\n                                    </div>\n                                </div>\n                            ))}\n                        </div>\n                    )}\n                    </>\n                )}\n            </div>\n        )}\n\n        {activeTab === 'my_loans' && (\n            <div className=\"space-y-4\">\n                {myLoans.length === 0 ? (\n                    <div className=\"text-center py-10 text-gray-500\">You have no active loans.</div>\n                ) : (\n                    myLoans.map(loan => (\n                        <div key={loan.id} className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-xl p-6 relative overflow-hidden\">\n                            <div className=\"flex justify-between items-start mb-4\">\n                                <div>\n                                    <h3 className=\"text-xl font-bold text-white flex items-center gap-2\">\n                                        {loan.property ? getIcon(loan.property.type_id) : <Building className=\"w-5 h-5\" />}\n                                        {loan.property ? loan.property.name : 'Unknown Property'}\n                                    </h3>\n                                    <p className=\"text-sm text-gray-400\">Total Loan: {loan.amount.toLocaleString()}</p>\n                                </div>\n                                <div className=\"text-right\">\n                                    <div className=\"text-xs text-gray-500\">Remaining</div>\n                                    <div className=\"text-2xl font-bold text-red-400\">{loan.remaining_balance.toLocaleString()}</div>\n                                </div>\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-4 mb-4 text-sm\">\n                                <div className=\"bg-black/20 p-3 rounded-lg\">\n                                    <div className=\"text-gray-500\">Weekly Payment</div>\n                                    <div className=\"font-mono text-white\">{loan.monthly_payment.toLocaleString()}</div>\n                                </div>\n                                <div className=\"bg-black/20 p-3 rounded-lg\">\n                                    <div className=\"text-gray-500\">Next Due</div>\n                                    <div className=\"font-mono text-white\">{new Date(loan.next_payment_due_at).toLocaleDateString()}</div>\n                                </div>\n                            </div>\n\n                            <button \n                                onClick={() => handlePayLoan(loan)}\n                                className=\"w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg font-bold transition-colors\"\n                            >\n                                Make Payment\n                            </button>\n                        </div>\n                    ))\n                )}\n            </div>\n        )}\n\n        {activeTab === 'my_home' && (\n            <div className=\"space-y-6\">\n                {!myLease ? (\n                    <div className=\"bg-zinc-900/50 border border-zinc-800 rounded-2xl p-10 text-center\">\n                        <Tent className=\"w-16 h-16 text-zinc-600 mx-auto mb-4\" />\n                        <h2 className=\"text-xl font-bold text-white mb-2\">You are homeless!</h2>\n                        <p className=\"text-gray-400 mb-6\">You currently don't have a place to live. Check the market to find a home.</p>\n                        <button \n                            onClick={() => setActiveTab('market')}\n                            className=\"bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-xl font-bold transition-all\"\n                        >\n                            Find a Home\n                        </button>\n                    </div>\n                ) : (\n                    <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-950 border border-zinc-800 rounded-2xl p-6 relative overflow-hidden\">\n                        <div className=\"absolute top-0 right-0 p-32 bg-purple-600/10 blur-3xl rounded-full pointer-events-none\" />\n                        \n                        <div className=\"flex items-start justify-between relative z-10\">\n                            <div className=\"flex items-center gap-4\">\n                                <div className=\"p-4 bg-zinc-800 rounded-xl border border-zinc-700\">\n                                    {getIcon(myLease.property.type_id)}\n                                </div>\n                                <div>\n                                    <h2 className=\"text-2xl font-bold\">{myLease.property.name}</h2>\n                                    <div className=\"flex items-center gap-2 text-sm text-gray-400\">\n                                        <span className=\"uppercase tracking-wider font-bold text-purple-400\">{myLease.property.type_id}</span>\n                                        <span>‚Ä¢</span>\n                                        <span>Moved in: {new Date(myLease.start_date).toLocaleDateString()}</span>\n                                    </div>\n                                </div>\n                            </div>\n                            <div className=\"text-right\">\n                                <div className=\"text-sm text-gray-400\">Monthly Rent</div>\n                                <div className=\"text-2xl font-bold text-white flex items-center justify-end gap-1\">\n                                    <DollarSign className=\"w-5 h-5 text-green-400\" />\n                                    {myLease.property.rent_amount.toLocaleString()}\n                                </div>\n                                <div className=\"text-xs text-gray-500\">+ {(myLease.property.electric_cost ?? (myLease.property.utility_cost ?? 0) / 2).toLocaleString()} Electric + {(myLease.property.water_cost ?? (myLease.property.utility_cost ?? 0) / 2).toLocaleString()} Water</div>\n                            </div>\n                        </div>\n\n                        <div className=\"mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 relative z-10\">\n                            <div className=\"bg-black/30 rounded-xl p-4 border border-white/5\">\n                                <div className=\"text-sm text-gray-400 mb-1\">Status</div>\n                                <div className=\"font-medium text-green-400 flex items-center gap-2\">\n                                    <div className=\"w-2 h-2 rounded-full bg-green-500 animate-pulse\" />\n                                    Active Lease\n                                </div>\n                            </div>\n                            <div className=\"bg-black/30 rounded-xl p-4 border border-white/5\">\n                                <div className=\"flex items-center gap-2 mb-2\">\n                                    <Zap className=\"w-4 h-4 text-yellow-400\" />\n                                    <span className=\"text-sm text-gray-400\">Electric Company</span>\n                                </div>\n                                <div className=\"font-mono text-white\">{(myLease.property.electric_cost ?? (myLease.property.utility_cost ?? 0) / 2).toLocaleString()} coins/mo</div>\n                            </div>\n                            <div className=\"bg-black/30 rounded-xl p-4 border border-white/5\">\n                                <div className=\"flex items-center gap-2 mb-2\">\n                                    <Droplets className=\"w-4 h-4 text-blue-400\" />\n                                    <span className=\"text-sm text-gray-400\">Water Company</span>\n                                </div>\n                                <div className=\"font-mono text-white\">{(myLease.property.water_cost ?? (myLease.property.utility_cost ?? 0) / 2).toLocaleString()} coins/mo</div>\n                            </div>\n                        </div>\n\n                        <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10\">\n                            <div className=\"bg-black/30 rounded-xl p-4 border border-white/5\">\n                                <div className=\"text-sm text-gray-400 mb-1\">Last Payment</div>\n                                <div className=\"font-medium text-white\">\n                                    {myLease.last_rent_paid_at ? new Date(myLease.last_rent_paid_at).toLocaleDateString() : 'Never'}\n                                </div>\n                            </div>\n                        </div>\n\n                        <div className=\"mt-6 flex justify-end gap-3 relative z-10\">\n                            <button className=\"px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm font-bold transition-colors\">\n                                Report Issue\n                            </button>\n                            <button \n                                onClick={handlePayRent}\n                                className=\"px-6 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-bold transition-colors shadow-lg shadow-green-900/20\"\n                            >\n                                Pay Rent\n                            </button>\n                        </div>\n                    </div>\n                )}\n            </div>\n        )}\n\n        {activeTab === 'market' && (\n            <div className=\"space-y-6\">\n                <div className=\"flex items-center gap-4 border-b border-zinc-800 pb-4\">\n                    <button \n                        onClick={() => setMarketFilter('rent')}\n                        className={`text-sm font-bold pb-4 -mb-4 border-b-2 transition-all ${marketFilter === 'rent' ? 'border-purple-500 text-white' : 'border-transparent text-gray-500 hover:text-white'}`}\n                    >\n                        For Rent\n                    </button>\n                    <button \n                        onClick={() => setMarketFilter('sale')}\n                        className={`text-sm font-bold pb-4 -mb-4 border-b-2 transition-all ${marketFilter === 'sale' ? 'border-purple-500 text-white' : 'border-transparent text-gray-500 hover:text-white'}`}\n                    >\n                        For Sale\n                    </button>\n                </div>\n\n                {buyingProp && (\n                    <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\n                        <div className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-2xl p-6 max-w-md w-full\">\n                            <h3 className=\"text-xl font-bold mb-4\">Buy {buyingProp.name}</h3>\n                            <div className=\"space-y-4\">\n                                <div className=\"flex justify-between text-sm\">\n                                    <span className=\"text-gray-400\">Price</span>\n                                    <span className=\"font-bold\">{buyingProp.price.toLocaleString()}</span>\n                                </div>\n                                <div className=\"flex justify-between text-sm\">\n                                    <span className=\"text-gray-400\">Min Down Payment (10%)</span>\n                                    <span className=\"font-bold text-green-400\">{Math.ceil(buyingProp.price * 0.1).toLocaleString()}</span>\n                                </div>\n                                \n                                <div>\n                                    <label className=\"block text-xs text-gray-500 mb-1\">Your Down Payment</label>\n                                    <input \n                                        type=\"number\"\n                                        value={downPayment}\n                                        onChange={(e) => setDownPayment(e.target.value)}\n                                        className=\"w-full bg-black/30 border border-zinc-700 rounded-lg p-2 text-white\"\n                                    />\n                                </div>\n\n                                <div className=\"pt-4 flex gap-3\">\n                                    <button \n                                        onClick={() => setBuyingProp(null)}\n                                        className=\"flex-1 bg-zinc-800 hover:bg-zinc-700 py-2 rounded-lg font-bold\"\n                                    >\n                                        Cancel\n                                    </button>\n                                    <button \n                                        onClick={handleBuyWithLoan}\n                                        className=\"flex-1 bg-purple-600 hover:bg-purple-500 py-2 rounded-lg font-bold\"\n                                    >\n                                        Confirm Purchase\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                )}\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {properties.map(prop => (\n                        <div key={prop.id} className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-xl p-5 hover:border-purple-500/30 transition-all\">\n                            <div className=\"flex justify-between items-start mb-3\">\n                                <div className=\"flex items-center gap-3\">\n                                    {getIcon(prop.type_id)}\n                                    <div>\n                                        <h3 className=\"font-bold text-white\">{prop.name}</h3>\n                                        <div className=\"text-xs text-gray-500 uppercase tracking-wider\">{prop.type_id}</div>\n                                    </div>\n                                </div>\n                                {marketFilter === 'sale' && (\n                                    <div className=\"text-right\">\n                                        <div className=\"text-xs text-gray-500\">Price</div>\n                                        <div className=\"font-bold text-green-400\">{prop.price?.toLocaleString()}</div>\n                                    </div>\n                                )}\n                            </div>\n\n                            <div className=\"space-y-2 text-sm border-t border-white/5 pt-3 mb-4\">\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-gray-500\">Monthly Rent</span>\n                                    <span className=\"text-white\">{prop.rent_amount.toLocaleString()}</span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-gray-500\">Electric</span>\n                                    <span className=\"text-white\">{(prop.electric_cost ?? (prop.utility_cost ?? 0) / 2).toLocaleString()}</span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-gray-500\">Water</span>\n                                    <span className=\"text-white\">{(prop.water_cost ?? (prop.utility_cost ?? 0) / 2).toLocaleString()}</span>\n                                </div>\n                            </div>\n\n                            {marketFilter === 'rent' ? (\n                                <button \n                                    onClick={() => handleRent(prop.id, prop.rent_amount + (prop.electric_cost ?? (prop.utility_cost ?? 0) / 2) + (prop.water_cost ?? (prop.utility_cost ?? 0) / 2))}\n                                    className=\"w-full bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded-lg font-bold text-sm transition-colors\"\n                                >\n                                    Rent Now\n                                </button>\n                            ) : (\n                                <button \n                                    onClick={() => initiateBuy(prop)}\n                                    className=\"w-full bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg font-bold text-sm transition-colors\"\n                                >\n                                    Buy Property\n                                </button>\n                            )}\n                        </div>\n                    ))}\n                </div>\n            </div>\n        )}\n\n        {/* Edit Property Modal */}\n        {editingProp && (\n            <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\n                <div className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-2xl w-full max-w-md p-6 relative\">\n                    <button \n                        onClick={() => setEditingProp(null)}\n                        className=\"absolute top-4 right-4 text-gray-400 hover:text-white\"\n                    >\n                        <X className=\"w-5 h-5\" />\n                    </button>\n                    \n                    <h3 className=\"text-xl font-bold text-white mb-6 flex items-center gap-2\">\n                        <Edit2 className=\"w-5 h-5 text-purple-500\" />\n                        Edit Property\n                    </h3>\n\n                    <div className=\"space-y-4\">\n                        <div>\n                            <label className=\"block text-sm text-gray-400 mb-1\">Property Name</label>\n                            <input \n                                type=\"text\"\n                                value={editName}\n                                onChange={(e) => setEditName(e.target.value)}\n                                className=\"w-full bg-black/30 border border-zinc-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500\"\n                                placeholder=\"Enter property name\"\n                            />\n                            <p className=\"text-xs text-gray-500 mt-1\">This name is visible to everyone.</p>\n                        </div>\n\n                        <div>\n                            <label className=\"block text-sm text-gray-400 mb-1\">Rent Amount (Coins)</label>\n                            <input \n                                type=\"number\"\n                                value={editRent}\n                                onChange={(e) => setEditRent(e.target.value)}\n                                className={`w-full bg-black/30 border border-zinc-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500 ${!canChangeRent(editingProp) ? 'opacity-50 cursor-not-allowed' : ''}`}\n                                placeholder=\"Enter rent amount\"\n                            />\n                            {!canChangeRent(editingProp) ? (\n                                <p className=\"text-xs text-red-400 mt-1\">\n                                    Rent can only be changed once every 30 days. \n                                    Available in {getDaysUntilRentChange(editingProp)} days.\n                                </p>\n                            ) : (\n                                <p className=\"text-xs text-green-400 mt-1\">\n                                    You can update the rent price now. Next update available in 30 days.\n                                </p>\n                            )}\n                        </div>\n\n                        <div className=\"pt-4 flex gap-3\">\n                            <button \n                                onClick={() => setEditingProp(null)}\n                                className=\"flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded-xl font-bold transition-colors\"\n                            >\n                                Cancel\n                            </button>\n                            <button \n                                onClick={handleUpdateProperty}\n                                className=\"flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-xl font-bold transition-colors\"\n                            >\n                                Save Changes\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\MaiLab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\MaiTalentPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Gavel' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Gavel"},"fix":{"range":[402,409],"text":""},"desc":"Remove unused variable \"Gavel\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Heart' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Heart"},"fix":{"range":[416,423],"text":""},"desc":"Remove unused variable \"Heart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Share2' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":65,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Share2"},"fix":{"range":[423,431],"text":""},"desc":"Remove unused variable \"Share2\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkJudgeStatus'. Either include it or remove the dependency array.","line":130,"column":6,"nodeType":"ArrayExpression","endLine":130,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [checkJudgeStatus, profile]","fix":{"range":[4138,4147],"text":"[checkJudgeStatus, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport { useAuthStore } from '@/lib/store';\nimport { useCoins } from '@/lib/hooks/useCoins';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\nimport { toast } from 'sonner';\nimport { Play, Upload, Star, Trophy, Gavel, Video, Heart, Share2, AlertCircle } from 'lucide-react';\n\ninterface Audition {\n  id: string;\n  user_id: string;\n  talent_name: string;\n  category: string;\n  description: string;\n  clip_url?: string;\n  stream_url?: string;\n  status: string;\n  total_votes: number;\n  user?: {\n    username: string;\n    avatar_url: string;\n  };\n}\n\nexport default function MaiTalentPage() {\n  const { profile } = useAuthStore();\n  const { spendCoins } = useCoins();\n  const [auditions, setAuditions] = useState<Audition[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [activeTab, setActiveTab] = useState<'watch' | 'audition' | 'leaderboard'>('watch');\n  const [isJudge, setIsJudge] = useState(false);\n\n  // Form State\n  const [talentName, setTalentName] = useState('');\n  const [category, setCategory] = useState('singing');\n  const [description, setDescription] = useState('');\n  const [clipUrl, setClipUrl] = useState('');\n  const [streamUrl, setStreamUrl] = useState('');\n  const [submitting, setSubmitting] = useState(false);\n\n  // Access Control: Under Construction for non-admins\n  const isAdmin = profile?.role === 'admin' || profile?.is_admin === true || profile?.role === 'super_admin';\n\n  // Function definitions must come before useEffect\n  const fetchAuditions = async () => {\n    setLoading(true);\n    try {\n      // Fetch auditions joined with profiles and vote sums\n      // Note: This query depends on the view 'mai_talent_leaderboard' or we can join manually\n      // For now, let's try to fetch from the view if it exists, or fallback to manual join\n      \n      const { data, error } = await supabase\n        .from('mai_talent_leaderboard')\n        .select('*')\n        .order('total_votes', { ascending: false });\n\n      if (error) {\n        // Fallback if view doesn't exist yet (for dev robustness)\n        console.warn('View mai_talent_leaderboard not found, trying raw table', error);\n        const { data: rawData, error: rawError } = await supabase\n          .from('mai_talent_auditions')\n          .select(`\n            *,\n            user:user_profiles(username, avatar_url)\n          `)\n          .in('status', ['approved', 'featured']);\n        \n        if (rawError) throw rawError;\n        \n        // Manually calculate votes if needed (mock for now if table empty)\n        const formattedData = rawData.map(a => ({\n          ...a,\n          total_votes: 0 // Fetch votes separately if needed, or 0\n        }));\n        setAuditions(formattedData as Audition[]);\n      } else {\n        setAuditions(data as Audition[]);\n      }\n    } catch (err) {\n      console.error('Error fetching auditions:', err);\n      // toast.error('Failed to load auditions');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const checkJudgeStatus = async () => {\n    if (!profile) return;\n    if (profile.role === 'admin' || profile.role === 'moderator') {\n      setIsJudge(true);\n      return;\n    }\n    \n    const { data } = await supabase\n      .from('mai_talent_judges')\n      .select('id')\n      .eq('user_id', profile.id)\n      .maybeSingle();\n      \n    setIsJudge(!!data);\n  };\n\n  // Hooks must be called unconditionally at the top level\n  useEffect(() => {\n    fetchAuditions();\n    checkJudgeStatus();\n\n    const channel = supabase\n      .channel('mai-talent-updates')\n      .on(\n        'postgres_changes',\n        { event: '*', schema: 'public', table: 'mai_talent_votes' },\n        () => {\n          fetchAuditions();\n        }\n      )\n      .on(\n        'postgres_changes',\n        { event: '*', schema: 'public', table: 'mai_talent_auditions' },\n        () => {\n          fetchAuditions();\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [profile]);\n\n  if (!isAdmin) {\n    return (\n      <div className=\"min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 text-center\">\n        <div className=\"bg-purple-900/20 p-8 rounded-3xl border border-purple-500/30 max-w-md w-full backdrop-blur-sm\">\n          <div className=\"w-20 h-20 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-6\">\n            <Star className=\"w-10 h-10 text-purple-400 animate-pulse\" />\n          </div>\n          <h1 className=\"text-3xl font-black text-white mb-4\">MAI TALENT</h1>\n          <div className=\"inline-flex items-center gap-2 px-4 py-2 bg-yellow-500/20 text-yellow-200 rounded-full text-sm font-bold mb-6 border border-yellow-500/20\">\n            <AlertCircle size={16} />\n            UNDER CONSTRUCTION\n          </div>\n          <p className=\"text-slate-400 mb-8\">\n            We are currently building the ultimate talent showcase platform. \n            Check back soon to show off your skills!\n          </p>\n          <Button \n            onClick={() => window.history.back()}\n            variant=\"outline\"\n            className=\"border-white/10 hover:bg-white/5 text-white w-full\"\n          >\n            Go Back\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  const handleAuditionSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!profile) {\n      toast.error('You must be logged in to audition');\n      return;\n    }\n\n    setSubmitting(true);\n    try {\n      const { error } = await supabase.from('mai_talent_auditions').insert({\n        user_id: profile.id,\n        talent_name: talentName,\n        category,\n        description,\n        clip_url: clipUrl,\n        stream_url: streamUrl,\n        status: 'pending' // Default to pending\n      });\n\n      if (error) throw error;\n\n      toast.success('Audition submitted successfully! Waiting for approval.');\n      setTalentName('');\n      setDescription('');\n      setClipUrl('');\n      setStreamUrl('');\n      setActiveTab('watch'); // Redirect to watch\n    } catch (err: any) {\n      console.error('Error submitting audition:', err);\n      toast.error(err.message || 'Failed to submit audition');\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  const handleVote = async (auditionId: string, amount: number) => {\n    if (!profile) {\n      toast.error('Please login to vote');\n      return;\n    }\n\n    try {\n      // 1. Spend Coins\n      const success = await spendCoins({\n        senderId: profile.id,\n        amount,\n        source: 'mai_talent_vote',\n        item: auditionId\n      });\n\n      if (!success) return; // spendCoins handles toast error\n\n      // 2. Record Vote\n      const { error } = await supabase.from('mai_talent_votes').insert({\n        audition_id: auditionId,\n        voter_id: profile.id,\n        amount\n      });\n\n      if (error) throw error;\n\n      toast.success(`Voted ${amount} coins!`);\n      fetchAuditions(); // Refresh leaderboard\n    } catch (err) {\n      console.error('Error voting:', err);\n      toast.error('Failed to record vote');\n    }\n  };\n\n  const handleAdminAction = async (auditionId: string, action: 'approve' | 'reject' | 'feature') => {\n    try {\n      const status = action === 'approve' ? 'approved' : action === 'feature' ? 'featured' : 'rejected';\n      const { error } = await supabase\n        .from('mai_talent_auditions')\n        .update({ status })\n        .eq('id', auditionId);\n\n      if (error) throw error;\n      toast.success(`Audition ${status}`);\n      fetchAuditions();\n    } catch (err) {\n      console.error('Admin action failed:', err);\n      toast.error('Failed to update status');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-slate-950 text-white pb-20 overflow-y-auto\">\n      {/* Hero Section */}\n      <div className=\"relative h-[400px] w-full bg-gradient-to-b from-purple-900 via-slate-900 to-slate-950 flex items-center justify-center overflow-hidden\">\n        <div className=\"absolute inset-0 bg-[url('/assets/textures/rockn.png')] opacity-10 mix-blend-overlay\"></div>\n        <div className=\"absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent\"></div>\n        \n        <div className=\"relative z-10 text-center space-y-6 max-w-3xl px-4\">\n          <div className=\"inline-flex items-center gap-2 px-3 py-1 rounded-full bg-purple-500/20 border border-purple-500/30 text-purple-300 text-sm font-medium mb-2\">\n            <Star className=\"w-4 h-4\" /> Mai Talent Competition\n          </div>\n          <h1 className=\"text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-cyan-400 drop-shadow-[0_0_30px_rgba(168,85,247,0.5)]\">\n            MAI TALENT\n          </h1>\n          <p className=\"text-xl text-slate-300 max-w-2xl mx-auto\">\n            Showcase your skills, win Troll Coins, and become the next star of Troll City. \n            Audition now or vote for your favorites!\n          </p>\n          \n          <div className=\"flex flex-wrap items-center justify-center gap-4 mt-8\">\n            <Button \n              size=\"lg\" \n              className=\"bg-pink-600 hover:bg-pink-700 text-white font-bold px-8 shadow-[0_0_20px_rgba(236,72,153,0.4)]\"\n              onClick={() => setActiveTab('audition')}\n            >\n              <Upload className=\"w-5 h-5 mr-2\" /> Audition Now\n            </Button>\n            <Button \n              size=\"lg\" \n              variant=\"outline\"\n              className=\"border-cyan-500/50 text-cyan-400 hover:bg-cyan-950/30 font-bold px-8\"\n              onClick={() => setActiveTab('watch')}\n            >\n              <Play className=\"w-5 h-5 mr-2\" /> Watch Performances\n            </Button>\n            <Button \n              size=\"lg\" \n              variant=\"secondary\"\n              className=\"bg-purple-900/40 hover:bg-purple-900/60 text-purple-200 border border-purple-500/20 font-bold px-8\"\n              onClick={() => setActiveTab('leaderboard')}\n            >\n              <Trophy className=\"w-5 h-5 mr-2\" /> Leaderboard\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 -mt-10 relative z-20\">\n        \n        {/* Navigation Tabs */}\n        <div className=\"flex items-center gap-2 bg-slate-900/80 backdrop-blur-md p-2 rounded-2xl border border-white/10 w-fit mx-auto mb-10 shadow-xl\">\n          <button \n            onClick={() => setActiveTab('watch')}\n            className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${activeTab === 'watch' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}\n          >\n            Watch\n          </button>\n          <button \n            onClick={() => setActiveTab('audition')}\n            className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${activeTab === 'audition' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}\n          >\n            Audition\n          </button>\n          <button \n            onClick={() => setActiveTab('leaderboard')}\n            className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${activeTab === 'leaderboard' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}\n          >\n            Leaderboard\n          </button>\n        </div>\n\n        {/* WATCH SECTION */}\n        {activeTab === 'watch' && (\n          <div className=\"space-y-8\">\n            <h2 className=\"text-2xl font-bold text-white flex items-center gap-2\">\n              <Video className=\"text-cyan-400\" /> Featured Performances\n            </h2>\n            \n            {loading ? (\n              <div className=\"text-center py-20 text-slate-500\">Loading performances...</div>\n            ) : auditions.length === 0 ? (\n              <div className=\"text-center py-20 bg-slate-900/50 rounded-2xl border border-white/5\">\n                <p className=\"text-slate-400 text-lg\">No approved auditions yet.</p>\n                <Button variant=\"link\" onClick={() => setActiveTab('audition')} className=\"text-pink-400\">\n                  Be the first to audition!\n                </Button>\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                {auditions.map((audition) => (\n                  <Card key={audition.id} className=\"bg-slate-900/80 border-white/10 overflow-hidden hover:border-pink-500/30 transition-all group\">\n                    <div className=\"aspect-video bg-black relative\">\n                      {audition.stream_url ? (\n                        <iframe \n                          src={audition.stream_url.replace('watch?v=', 'embed/')} \n                          className=\"w-full h-full\" \n                          allowFullScreen\n                          title={audition.talent_name}\n                        />\n                      ) : audition.clip_url ? (\n                          <video src={audition.clip_url} controls className=\"w-full h-full object-cover\" />\n                      ) : (\n                        <div className=\"w-full h-full flex items-center justify-center text-slate-600 bg-slate-950\">\n                          <Video size={48} />\n                        </div>\n                      )}\n                      <div className=\"absolute top-2 right-2 bg-black/60 backdrop-blur-sm px-2 py-1 rounded text-xs font-bold text-white border border-white/10\">\n                        {audition.category}\n                      </div>\n                    </div>\n                    \n                    <CardContent className=\"p-4\">\n                      <div className=\"flex justify-between items-start mb-4\">\n                        <div>\n                          <h3 className=\"font-bold text-lg text-white group-hover:text-pink-400 transition-colors\">{audition.talent_name}</h3>\n                          <div className=\"flex items-center gap-2 text-sm text-slate-400\">\n                            <img src={audition.user?.avatar_url || 'https://ui-avatars.com/api/?background=random'} className=\"w-5 h-5 rounded-full\" />\n                            <span>{audition.user?.username}</span>\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"text-xs text-slate-500\">Total Support</div>\n                          <div className=\"font-bold text-yellow-400 flex items-center justify-end gap-1\">\n                            <Trophy size={14} /> {audition.total_votes?.toLocaleString() || 0}\n                          </div>\n                        </div>\n                      </div>\n                      \n                      <p className=\"text-sm text-slate-400 mb-6 line-clamp-2\">{audition.description}</p>\n                      \n                      <div className=\"grid grid-cols-3 gap-2\">\n                        <Button \n                          size=\"sm\" \n                          className=\"bg-white/5 hover:bg-yellow-500/20 hover:text-yellow-400 border border-white/10\"\n                          onClick={() => handleVote(audition.id, 10)}\n                        >\n                          <Star size={14} className=\"mr-1\" /> 10\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          className=\"bg-white/5 hover:bg-yellow-500/20 hover:text-yellow-400 border border-white/10\"\n                          onClick={() => handleVote(audition.id, 50)}\n                        >\n                          <Star size={14} className=\"mr-1\" /> 50\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          className=\"bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white border-none\"\n                          onClick={() => handleVote(audition.id, 100)}\n                        >\n                          <Trophy size={14} className=\"mr-1\" /> 100\n                        </Button>\n                      </div>\n\n                      {isJudge && (\n                        <div className=\"mt-4 pt-4 border-t border-white/10 flex gap-2\">\n                          <Button size=\"sm\" variant=\"destructive\" className=\"flex-1\" onClick={() => handleAdminAction(audition.id, 'reject')}>Reject</Button>\n                          <Button size=\"sm\" className=\"flex-1 bg-green-600 hover:bg-green-700\" onClick={() => handleAdminAction(audition.id, 'feature')}>Feature</Button>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* AUDITION SECTION */}\n        {activeTab === 'audition' && (\n          <div className=\"max-w-2xl mx-auto\">\n             <Card className=\"bg-slate-900/80 border-white/10\">\n              <CardHeader>\n                <CardTitle className=\"text-2xl text-white\">Submit Your Audition</CardTitle>\n                <CardDescription>Show us what you got! Winners get massive coin prizes and fame.</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <form onSubmit={handleAuditionSubmit} className=\"space-y-6\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-slate-300\">Stage Name</label>\n                    <input \n                      type=\"text\" \n                      value={talentName}\n                      onChange={e => setTalentName(e.target.value)}\n                      className=\"w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-purple-500 outline-none\"\n                      placeholder=\"e.g. The Troll Magician\"\n                      required\n                    />\n                  </div>\n                  \n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-slate-300\">Category</label>\n                    <select \n                      value={category}\n                      onChange={e => setCategory(e.target.value)}\n                      className=\"w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-purple-500 outline-none\"\n                    >\n                      <option value=\"singing\">Singing</option>\n                      <option value=\"comedy\">Comedy</option>\n                      <option value=\"magic\">Magic</option>\n                      <option value=\"gaming\">Gaming Skills</option>\n                      <option value=\"other\">Other</option>\n                    </select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-slate-300\">Description</label>\n                    <textarea \n                      value={description}\n                      onChange={e => setDescription(e.target.value)}\n                      className=\"w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-purple-500 outline-none h-24\"\n                      placeholder=\"Tell us about your performance...\"\n                      required\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-slate-300\">Video Link (YouTube/Twitch) or Clip URL</label>\n                    <input \n                      type=\"url\" \n                      value={streamUrl || clipUrl}\n                      onChange={e => setStreamUrl(e.target.value)}\n                      className=\"w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-purple-500 outline-none\"\n                      placeholder=\"https://youtube.com/...\"\n                    />\n                    <p className=\"text-xs text-slate-500\">Paste a link to your performance video.</p>\n                  </div>\n\n                  <Button \n                    type=\"submit\" \n                    className=\"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-6 text-lg\"\n                    disabled={submitting}\n                  >\n                    {submitting ? 'Submitting...' : 'Submit Audition'}\n                  </Button>\n                </form>\n              </CardContent>\n             </Card>\n          </div>\n        )}\n\n        {/* LEADERBOARD SECTION */}\n        {activeTab === 'leaderboard' && (\n          <div className=\"max-w-4xl mx-auto\">\n            <h2 className=\"text-2xl font-bold text-white mb-6 flex items-center gap-2\">\n              <Trophy className=\"text-yellow-400\" /> Current Rankings\n            </h2>\n            \n            <div className=\"bg-slate-900/80 rounded-2xl border border-white/10 overflow-hidden\">\n              <table className=\"w-full text-left\">\n                <thead className=\"bg-white/5 text-slate-400 text-xs uppercase\">\n                  <tr>\n                    <th className=\"p-4\">Rank</th>\n                    <th className=\"p-4\">Performer</th>\n                    <th className=\"p-4\">Category</th>\n                    <th className=\"p-4 text-right\">Votes</th>\n                    <th className=\"p-4 text-right\">Action</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-white/5\">\n                  {auditions.map((audition, index) => (\n                    <tr key={audition.id} className=\"hover:bg-white/5\">\n                      <td className=\"p-4\">\n                        <span className={`font-bold ${index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-amber-600' : 'text-slate-400'}`}>\n                          #{index + 1}\n                        </span>\n                      </td>\n                      <td className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <img src={audition.user?.avatar_url || 'https://ui-avatars.com/api/?background=random'} className=\"w-8 h-8 rounded-full\" />\n                          <div>\n                            <div className=\"font-bold text-white\">{audition.talent_name}</div>\n                            <div className=\"text-xs text-slate-500\">@{audition.user?.username}</div>\n                          </div>\n                        </div>\n                      </td>\n                      <td className=\"p-4\">\n                        <span className=\"px-2 py-1 rounded bg-purple-500/20 text-purple-300 text-xs font-medium\">{audition.category}</span>\n                      </td>\n                      <td className=\"p-4 text-right font-bold text-yellow-400\">{audition.total_votes?.toLocaleString() || 0}</td>\n                      <td className=\"p-4 text-right\">\n                        <Button size=\"sm\" onClick={() => handleVote(audition.id, 10)} className=\"bg-purple-600 hover:bg-purple-700\">\n                          Vote 10\n                        </Button>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Marketplace.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\MobileShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\MyEarnings.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'canRequestPayout' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":247,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":247,"endColumn":25},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":400,"column":35,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[18300,18400],"text":"\r\n                            üéâ You&apos;ve reached the highest payout tier!\r\n                          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[18300,18400],"text":"\r\n                            üéâ You&lsquo;ve reached the highest payout tier!\r\n                          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[18300,18400],"text":"\r\n                            üéâ You&#39;ve reached the highest payout tier!\r\n                          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[18300,18400],"text":"\r\n                            üéâ You&rsquo;ve reached the highest payout tier!\r\n                          "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":486,"column":116,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[22966,23074],"text":" this year. Once you reach $600, you&apos;ll need to provide tax information for Form 1099.\r\n                    "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[22966,23074],"text":" this year. Once you reach $600, you&lsquo;ll need to provide tax information for Form 1099.\r\n                    "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[22966,23074],"text":" this year. Once you reach $600, you&#39;ll need to provide tax information for Form 1099.\r\n                    "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[22966,23074],"text":" this year. Once you reach $600, you&rsquo;ll need to provide tax information for Form 1099.\r\n                    "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { \r\n  DollarSign, TrendingUp, Calendar, AlertTriangle,\r\n  Lock, ArrowRight, Clock, CheckCircle, Award, Star\r\n} from 'lucide-react'\r\nimport { EarningsView, MonthlyEarnings } from '../types/earnings'\r\nimport RequestPayoutModal from '../components/RequestPayoutModal'\r\n// Payment tiers based on payout amounts\r\nconst PAYOUT_TIERS = [\r\n  { name: 'Starter', coins: 7000, usd: 21.00, color: '#cd7f32' },\r\n  { name: 'Bronze', coins: 14000, usd: 49.50, color: '#c0c0c0' },\r\n  { name: 'Silver', coins: 27000, usd: 90.00, color: '#ffd700' },\r\n  { name: 'Gold', coins: 47000, usd: 150.00, color: '#ff4dd2' },\r\n]\r\n\r\nfunction getPayoutTier(coins: number) {\r\n  let current = PAYOUT_TIERS[0]\r\n  for (const tier of PAYOUT_TIERS) {\r\n    if (coins >= tier.coins) {\r\n      current = tier\r\n    }\r\n  }\r\n  return current\r\n}\r\n\r\nexport default function MyEarnings() {\r\n  const { user, profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [earningsData, setEarningsData] = useState<EarningsView | null>(null)\r\n  const [monthlyEarnings, setMonthlyEarnings] = useState<MonthlyEarnings[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [showPayoutModal, setShowPayoutModal] = useState(false)\r\n  const [payoutHistory, setPayoutHistory] = useState<Array<{\r\n    id: string\r\n    coins_redeemed?: number\r\n    cash_amount?: number\r\n    status?: string\r\n    created_at: string\r\n    processed_at?: string | null\r\n  }>>([])\r\n\r\n  const loadEarningsData = useCallback(async () => {\r\n    if (!user?.id) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      // Load earnings view data\r\n      const { data: earnings, error: earningsError } = await supabase\r\n        .from('earnings_view')\r\n        .select('*')\r\n        .eq('id', user.id)\r\n        .single()\r\n\r\n      if (earningsError) {\r\n        // PGRST205 = table/view not found, PGRST116 = no rows found\r\n        // For PGRST205 (table not found) or any other error, use fallback\r\n        // PGRST116 (no rows) means view exists but no data - that's OK, we'll use empty data\r\n        // Use fallback for PGRST205 (table not found) or any error except PGRST116 (no rows)\r\n        if (earningsError.code === 'PGRST205' || earningsError.code !== 'PGRST116') {\r\n          console.warn('earnings_view not found (code:', earningsError.code, '), using profile fallback')\r\n          // Fallback to profile data\r\n          setEarningsData({\r\n            id: profile?.id || '',\r\n            username: profile?.username || '',\r\n            total_earned_coins: profile?.total_earned_coins || 0,\r\n            troll_coins: profile?.troll_coins || 0,\r\n            current_month_earnings: 0,\r\n            current_month_transactions: 0,\r\n            current_month_paid_out: 0,\r\n            current_month_pending: 0,\r\n            current_month_approved: 0,\r\n            current_month_paid_count: 0,\r\n            current_month_pending_count: 0,\r\n            yearly_paid_usd: 0,\r\n            yearly_payout_count: 0,\r\n            tax_year: new Date().getFullYear(),\r\n            irs_threshold_status: 'below_threshold',\r\n            last_payout_at: null,\r\n            pending_requests_count: 0,\r\n            lifetime_paid_usd: 0\r\n          })\r\n        }\r\n      } else if (earnings) {\r\n        setEarningsData(earnings)\r\n      } else {\r\n        // No earnings data and no error - set empty data\r\n        setEarningsData({\r\n          id: profile?.id || '',\r\n          username: profile?.username || '',\r\n          total_earned_coins: profile?.total_earned_coins || 0,\r\n          troll_coins: profile?.troll_coins || 0,\r\n          current_month_earnings: 0,\r\n          current_month_transactions: 0,\r\n          current_month_paid_out: 0,\r\n          current_month_pending: 0,\r\n          current_month_approved: 0,\r\n          current_month_paid_count: 0,\r\n          current_month_pending_count: 0,\r\n          yearly_paid_usd: 0,\r\n          yearly_payout_count: 0,\r\n          tax_year: new Date().getFullYear(),\r\n          irs_threshold_status: 'below_threshold',\r\n          last_payout_at: null,\r\n          pending_requests_count: 0,\r\n          lifetime_paid_usd: 0\r\n        })\r\n      }\r\n\r\n      // Load monthly earnings - try RPC first, then view, then empty array\r\n      try {\r\n        const { data: monthly, error: monthlyError } = await supabase\r\n          .rpc('get_monthly_earnings', { p_user_id: user.id })\r\n\r\n        if (monthlyError) {\r\n          console.warn('get_monthly_earnings RPC not found, trying view fallback:', monthlyError)\r\n          // Fallback: load from monthly_earnings_breakdown view\r\n          const { data: fallback, error: viewError } = await supabase\r\n            .from('monthly_earnings_breakdown')\r\n            .select('*')\r\n            .eq('user_id', user.id)\r\n            .order('month', { ascending: false })\r\n            .limit(12)\r\n\r\n          if (viewError) {\r\n            console.warn('monthly_earnings_breakdown view also not found, using empty array')\r\n            setMonthlyEarnings([])\r\n          } else if (fallback) {\r\n            setMonthlyEarnings(fallback.map(m => ({\r\n              month: m.month,\r\n              coins_earned_from_gifts: m.coins_earned_from_gifts || 0,\r\n              gift_count: m.gift_count || 0,\r\n              unique_gifters: m.unique_gifters || 0,\r\n              troll_coins_earned: (m.troll_coins_earned || 0) + (m.free_coins_earned || 0)\r\n            })))\r\n          } else {\r\n            setMonthlyEarnings([])\r\n          }\r\n        } else if (monthly) {\r\n          setMonthlyEarnings(monthly)\r\n        } else {\r\n        setMonthlyEarnings([])\r\n      }\r\n    } catch (err) {\r\n      console.warn('Error loading monthly earnings (non-critical):', err)\r\n      setMonthlyEarnings([])\r\n    }\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('payout_history_view')\r\n          .select('*')\r\n          .eq('user_id', user.id)\r\n          .order('created_at', { ascending: false })\r\n          .limit(20)\r\n        if (error) {\r\n          const { data: prData } = await supabase\r\n            .from('payout_requests')\r\n            .select('id, coins_redeemed, requested_coins, cash_amount, amount_usd, status, created_at, processed_at')\r\n            .eq('user_id', user.id)\r\n            .order('created_at', { ascending: false })\r\n            .limit(20)\r\n          const mapped = (prData || []).map((p: any) => ({\r\n            id: p.id,\r\n            coins_redeemed: p.coins_redeemed ?? p.requested_coins ?? 0,\r\n            cash_amount: p.cash_amount ?? p.amount_usd ?? 0,\r\n            status: p.status,\r\n            created_at: p.created_at,\r\n            processed_at: p.processed_at ?? null\r\n          }))\r\n          setPayoutHistory(mapped)\r\n        } else {\r\n          setPayoutHistory((data as any) || [])\r\n        }\r\n      } catch (err) {\r\n        console.warn('Error loading payout history (non-critical):', err)\r\n        setPayoutHistory([])\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Error loading earnings:', err)\r\n      toast.error('Failed to load earnings data')\r\n      setEarningsData(null)\r\n      setMonthlyEarnings([])\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user, profile])\r\n\r\n  useEffect(() => {\r\n    if (!user || !profile) {\r\n      navigate('/auth', { replace: true })\r\n      return\r\n    }\r\n\r\n    // Check W9/onboarding status\r\n    if (profile.w9_status !== 'submitted' && profile.w9_status !== 'verified') {\r\n      // Show lock screen - user needs to complete onboarding\r\n      return\r\n    }\r\n\r\n    loadEarningsData()\r\n  }, [user, profile, navigate, loadEarningsData])\r\n\r\n  const totalEarned = earningsData?.total_earned_coins || profile?.total_earned_coins || 0\r\n\r\n  // Check if W9/onboarding is required (only if user has earnings or pending payouts)\r\n  const hasEarningsOrPayouts = totalEarned > 0 || (earningsData?.current_month_pending || 0) > 0 || (earningsData?.pending_requests_count || 0) > 0\r\n  if (profile && hasEarningsOrPayouts && profile.w9_status !== 'submitted' && profile.w9_status !== 'verified') {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center p-6\">\r\n        <div className=\"max-w-md w-full bg-zinc-900 border border-yellow-500/30 rounded-xl p-8 text-center\">\r\n          <Lock className=\"w-16 h-16 text-yellow-400 mx-auto mb-4\" />\r\n          <h2 className=\"text-2xl font-bold text-yellow-400 mb-2\">Creator Onboarding Required</h2>\r\n          <p className=\"text-gray-300 mb-6\">\r\n            You must complete creator onboarding and W9 information before you can view earnings or request payouts.\r\n          </p>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => navigate('/onboarding/creator', { replace: true })}\r\n            className=\"px-6 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold transition-colors flex items-center gap-2 mx-auto\"\r\n          >\r\n            Complete Onboarding\r\n            <ArrowRight className=\"w-4 h-4\" />\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!user || !profile) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n        <p>Please log in to view your earnings.</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const payoutsDisabled = true\r\n  const availableCoins = earningsData?.troll_coins || profile?.troll_coins || 0\r\n  const pendingPayouts = earningsData?.current_month_pending || 0\r\n  const totalCashedOut = earningsData?.lifetime_paid_usd || 0\r\n  const yearlyPaid = earningsData?.yearly_paid_usd || 0\r\n  const isOverThreshold = yearlyPaid >= 600\r\n  const isNearingThreshold = yearlyPaid >= 500 && yearlyPaid < 600\r\n  const canRequestPayout = !payoutsDisabled && availableCoins >= 7000 && (profile?.w9_status === 'submitted' || profile?.w9_status === 'verified') // Minimum 7,000 coins ($21) and onboarding completed\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <h1 className=\"text-3xl font-bold text-white flex items-center gap-3\">\r\n            <DollarSign className=\"w-8 h-8 text-green-400\" />\r\n            My Earnings\r\n          </h1>\r\n          <div className=\"flex flex-col items-end\">\r\n            <div className=\"px-4 py-2 bg-purple-900/30 border border-purple-500/30 rounded-lg text-sm text-purple-200\">\r\n              <span className=\"font-semibold text-purple-400\">Automated Payouts:</span> Mondays & Fridays\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {payoutsOnHold && (\r\n          <div className=\"bg-yellow-900/20 border border-yellow-500/50 rounded-lg p-4 flex items-start gap-4\">\r\n            <AlertTriangle className=\"w-6 h-6 text-yellow-500 flex-shrink-0 mt-1\" />\r\n            <div>\r\n              <h3 className=\"text-lg font-bold text-yellow-500\">Payouts Currently Paused</h3>\r\n              <p className=\"text-gray-300\">\r\n                Automated payouts are currently on hold for administrative review. \r\n                Your earnings are safe and will be processed when the system resumes. \r\n                Thank you for your patience.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {loading ? (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n            {[1, 2, 3, 4].map(i => (\r\n              <div key={i} className=\"bg-zinc-900 rounded-xl p-4 border border-[#2C2C2C] animate-pulse\">\r\n                <div className=\"h-4 bg-gray-700 rounded w-1/2 mb-2\"></div>\r\n                <div className=\"h-8 bg-gray-700 rounded w-3/4\"></div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Stats Boxes */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n              <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-purple-500/30 shadow-lg\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <TrendingUp className=\"w-5 h-5 text-purple-400\" />\r\n                  <span className=\"text-sm text-gray-400\">Total Earned Coins</span>\r\n                </div>\r\n                <p className=\"text-3xl font-bold text-purple-400\">\r\n                  {totalEarned.toLocaleString()}\r\n                </p>\r\n                <p className=\"text-xs text-gray-500 mt-1\">lifetime earnings</p>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-gold-500/30 shadow-lg\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <DollarSign className=\"w-5 h-5 text-yellow-400\" />\r\n                  <span className=\"text-sm text-gray-400\">Available Coins</span>\r\n                </div>\r\n                <p className=\"text-3xl font-bold text-yellow-400\">\r\n                  {availableCoins.toLocaleString()}\r\n                </p>\r\n                <p className=\"text-xs text-gray-500 mt-1\">${(availableCoins * 0.01).toFixed(2)} withdrawable</p>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-blue-500/30 shadow-lg\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <Clock className=\"w-5 h-5 text-blue-400\" />\r\n                  <span className=\"text-sm text-gray-400\">Pending Payouts</span>\r\n                </div>\r\n                <p className=\"text-3xl font-bold text-blue-400\">\r\n                  ${pendingPayouts.toFixed(2)}\r\n                </p>\r\n                <p className=\"text-xs text-gray-500 mt-1\">awaiting processing</p>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-green-500/30 shadow-lg\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n                  <span className=\"text-sm text-gray-400\">Total Cashed Out</span>\r\n                </div>\r\n                <p className=\"text-3xl font-bold text-green-400\">\r\n                  ${totalCashedOut.toFixed(2)}\r\n                </p>\r\n                <p className=\"text-xs text-gray-500 mt-1\">lifetime payouts</p>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Payment Tiers Section */}\r\n            <div className=\"bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-6 border border-purple-500/30 shadow-lg\">\r\n              <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                <Award className=\"w-5 h-5 text-purple-400\" />\r\n                Payment Tiers\r\n              </h2>\r\n              \r\n              {(() => {\r\n                const currentTier = getPayoutTier(availableCoins)\r\n                const currentTierIndex = PAYOUT_TIERS.findIndex(t => t.name === currentTier.name)\r\n                const nextTier = currentTierIndex < PAYOUT_TIERS.length - 1 ? PAYOUT_TIERS[currentTierIndex + 1] : null\r\n                const progressToNext = nextTier \r\n                  ? ((availableCoins - currentTier.coins) / (nextTier.coins - currentTier.coins)) * 100\r\n                  : 100\r\n\r\n                return (\r\n                  <div className=\"space-y-4\">\r\n                    {/* Current Tier Display */}\r\n                    <div className=\"bg-gradient-to-r from-purple-900/50 to-purple-800/50 rounded-lg p-4 border-2\" style={{ borderColor: currentTier.color }}>\r\n                      <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                          <Star className=\"w-6 h-6\" style={{ color: currentTier.color }} />\r\n                          <div>\r\n                            <p className=\"text-lg font-bold\" style={{ color: currentTier.color }}>\r\n                              {currentTier.name} Tier\r\n                            </p>\r\n                            <p className=\"text-sm text-gray-400\">\r\n                              ${currentTier.usd.toFixed(2)} payout available\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n                        {nextTier && (\r\n                          <div className=\"text-right\">\r\n                            <p className=\"text-xs text-gray-400\">Next Tier</p>\r\n                            <p className=\"text-sm font-semibold\" style={{ color: nextTier.color }}>\r\n                              {nextTier.name} (${nextTier.usd.toFixed(2)})\r\n                            </p>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      \r\n                      {nextTier ? (\r\n                        <div className=\"mt-3\">\r\n                          <div className=\"flex items-center justify-between text-xs text-gray-400 mb-1\">\r\n                            <span>Progress to {nextTier.name} Tier</span>\r\n                            <span>{Math.min(100, Math.max(0, progressToNext)).toFixed(1)}%</span>\r\n                          </div>\r\n                          <div className=\"w-full bg-gray-700 rounded-full h-2\">\r\n                            <div\r\n                              className=\"h-2 rounded-full transition-all\"\r\n                              style={{\r\n                                width: `${Math.min(100, Math.max(0, progressToNext))}%`,\r\n                                backgroundColor: nextTier.color\r\n                              }}\r\n                            />\r\n                          </div>\r\n                          <p className=\"text-xs text-gray-500 mt-1\">\r\n                            {((nextTier.coins - availableCoins).toLocaleString())} more coins needed for ${nextTier.usd.toFixed(2)} payout\r\n                          </p>\r\n                        </div>\r\n                      ) : (\r\n                        <div className=\"mt-3\">\r\n                          <p className=\"text-sm text-purple-300 font-semibold\">\r\n                            üéâ You've reached the highest payout tier!\r\n                          </p>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n\r\n                    {/* All Tiers List */}\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mt-4\">\r\n                      {PAYOUT_TIERS.map((tier, idx) => {\r\n                        const isCurrentTier = tier.name === currentTier.name\r\n                        const isUnlocked = availableCoins >= tier.coins\r\n                        \r\n                        return (\r\n                          <div\r\n                            key={idx}\r\n                            className={`rounded-lg p-3 border-2 transition-all ${\r\n                              isCurrentTier\r\n                                ? 'bg-gradient-to-br from-purple-900/30 to-purple-800/30 border-purple-500'\r\n                                : isUnlocked\r\n                                ? 'bg-zinc-800/50 border-gray-600'\r\n                                : 'bg-zinc-900/50 border-gray-700 opacity-60'\r\n                            }`}\r\n                            style={isCurrentTier ? { borderColor: tier.color } : {}}\r\n                          >\r\n                            <div className=\"flex items-center gap-2 mb-1\">\r\n                              <div\r\n                                className=\"w-3 h-3 rounded-full\"\r\n                                style={{ backgroundColor: tier.color }}\r\n                              />\r\n                              <span\r\n                                className={`text-sm font-semibold ${\r\n                                  isCurrentTier ? 'text-white' : isUnlocked ? 'text-gray-300' : 'text-gray-500'\r\n                                }`}\r\n                              >\r\n                                {tier.name}\r\n                              </span>\r\n                              {isCurrentTier && (\r\n                                <span className=\"text-xs px-2 py-0.5 bg-purple-600 rounded-full\">Current</span>\r\n                              )}\r\n                              {isUnlocked && !isCurrentTier && (\r\n                                <CheckCircle className=\"w-4 h-4 text-green-400\" />\r\n                              )}\r\n                            </div>\r\n                            <p className=\"text-xs text-gray-400 mb-1\">\r\n                              {tier.coins.toLocaleString()} coins\r\n                            </p>\r\n                            <p className=\"text-xs font-semibold text-green-400\">\r\n                              ${tier.usd.toFixed(2)} payout\r\n                            </p>\r\n                          </div>\r\n                        )\r\n                      })}\r\n                    </div>\r\n                  </div>\r\n                )\r\n              })()}\r\n            </div>\r\n\r\n            {/* IRS Warning Banner */}\r\n            {isOverThreshold && (\r\n              <div className=\"bg-gradient-to-r from-red-900/50 to-orange-900/50 border-2 border-red-500/50 rounded-xl p-6\">\r\n                <div className=\"flex items-start gap-4\">\r\n                  <AlertTriangle className=\"w-8 h-8 text-red-400 flex-shrink-0 mt-1\" />\r\n                  <div className=\"flex-1\">\r\n                    <h3 className=\"text-xl font-bold text-red-400 mb-2 flex items-center gap-2\">\r\n                      IRS 1099 ALERT\r\n                      <span className=\"px-3 py-1 bg-red-600 text-white text-sm rounded-full\">REQUIRED</span>\r\n                    </h3>\r\n                    <p className=\"text-gray-200 mb-2\">\r\n                      You have reached the IRS reporting threshold. You have earned <strong>${yearlyPaid.toFixed(2)}</strong> this year.\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-300\">\r\n                      You will be issued Form 1099 at the end of the year for tax reporting purposes.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {isNearingThreshold && !isOverThreshold && (\r\n              <div className=\"bg-gradient-to-r from-yellow-900/50 to-orange-900/50 border-2 border-yellow-500/50 rounded-xl p-6\">\r\n                <div className=\"flex items-start gap-4\">\r\n                  <AlertTriangle className=\"w-8 h-8 text-yellow-400 flex-shrink-0 mt-1\" />\r\n                  <div className=\"flex-1\">\r\n                    <h3 className=\"text-xl font-bold text-yellow-400 mb-2\">Approaching IRS Threshold</h3>\r\n                    <p className=\"text-gray-200\">\r\n                      You have earned <strong>${yearlyPaid.toFixed(2)}</strong> this year. Once you reach $600, you'll need to provide tax information for Form 1099.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Monthly Earnings Timeline */}\r\n            {monthlyEarnings.length > 0 && (\r\n              <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C]\">\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Calendar className=\"w-5 h-5 text-purple-400\" />\r\n                  Monthly Earnings Timeline\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {monthlyEarnings.map((month, idx) => {\r\n                    // Handle month format (YYYY-MM string)\r\n                    const monthStr = month.month\r\n                    const monthDate = new Date(monthStr + '-01')\r\n                    const monthName = monthDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })\r\n                    \r\n                    return (\r\n                      <div \r\n                        key={idx}\r\n                        className=\"bg-zinc-800 rounded-lg p-4 border border-purple-500/20 hover:border-purple-500/40 transition\"\r\n                      >\r\n                        <div className=\"flex items-center justify-between mb-2\">\r\n                          <span className=\"text-sm font-semibold text-gray-300\">{monthName}</span>\r\n                          <span className=\"text-xs text-gray-500\">\r\n                            ${((month.coins_earned_from_gifts || 0) * 0.01).toFixed(2)}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"text-2xl font-bold text-purple-400 mb-2\">\r\n                          {(month.coins_earned_from_gifts || 0).toLocaleString()}\r\n                        </div>\r\n                        <div className=\"text-xs text-gray-500 space-y-1\">\r\n                          <div>{month.gift_count || 0} gifts received</div>\r\n                          <div>{month.unique_gifters || 0} unique gifters</div>\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Pending Payouts Alert */}\r\n            {((earningsData?.pending_requests_count ?? 0) > 0) && (\r\n              <div className=\"bg-blue-900/30 border border-blue-500/50 rounded-xl p-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <Clock className=\"w-5 h-5 text-blue-400\" />\r\n                  <div>\r\n                    <p className=\"font-semibold text-blue-400\">\r\n                      {(earningsData?.pending_requests_count ?? 0)} Pending Payout Request{(earningsData?.pending_requests_count ?? 0) > 1 ? 's' : ''}\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-300\">\r\n                      Your payout request{(earningsData?.pending_requests_count ?? 0) > 1 ? 's are' : ' is'} being reviewed.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n            {payoutHistory.length > 0 && (\r\n              <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C]\">\r\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Clock className=\"w-5 h-5 text-blue-400\" />\r\n                  Payout History\r\n                </h2>\r\n                <div className=\"overflow-x-auto\">\r\n                  <table className=\"w-full text-sm\">\r\n                    <thead>\r\n                      <tr className=\"border-b border-gray-700 text-gray-400\">\r\n                        <th className=\"text-left py-2\">Date</th>\r\n                        <th className=\"text-right py-2\">Coins</th>\r\n                        <th className=\"text-right py-2\">Amount</th>\r\n                        <th className=\"text-center py-2\">Status</th>\r\n                        <th className=\"text-left py-2\">Processed</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {payoutHistory.map((p) => (\r\n                        <tr key={p.id} className=\"border-b border-gray-800 hover:bg-gray-800/50\">\r\n                          <td className=\"py-2 text-gray-300\">\r\n                            {new Date(p.created_at).toLocaleDateString()}\r\n                          </td>\r\n                          <td className=\"text-right py-2 text-gray-300\">\r\n                            {(p.coins_redeemed || 0).toLocaleString()}\r\n                          </td>\r\n                          <td className=\"text-right py-2 font-semibold text-green-400\">\r\n                            ${((p.cash_amount || 0) as number).toFixed(2)}\r\n                          </td>\r\n                          <td className=\"text-center py-2\">\r\n                            <span className={`px-2 py-1 rounded text-xs capitalize ${\r\n                              ['paid', 'success'].includes(p.status || '')\r\n                                ? 'bg-green-900 text-green-300'\r\n                                : ['approved', 'processing'].includes(p.status || '')\r\n                                ? 'bg-blue-900 text-blue-300'\r\n                                : ['rejected', 'failed'].includes(p.status || '')\r\n                                ? 'bg-red-900 text-red-300'\r\n                                : ['refunded'].includes(p.status || '')\r\n                                ? 'bg-orange-900 text-orange-300'\r\n                                : 'bg-yellow-900 text-yellow-300'\r\n                            }`}>\r\n                              {p.status === 'success' ? 'paid' : (p.status || 'pending')}\r\n                            </span>\r\n                          </td>\r\n                          <td className=\"py-2 text-gray-300\">\r\n                            {p.processed_at ? new Date(p.processed_at).toLocaleDateString() : '‚Äî'}\r\n                          </td>\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* Request Payout Modal */}\r\n      {showPayoutModal && (\r\n        <RequestPayoutModal\r\n          userId={user.id}\r\n          availableCoins={availableCoins}\r\n          onClose={() => setShowPayoutModal(false)}\r\n          onSuccess={() => {\r\n            setShowPayoutModal(false)\r\n            loadEarningsData()\r\n            toast.success('Payout request submitted successfully!')\r\n          }}\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Notifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\OfficerApplication.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":250,"column":88,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they&apos;re \"just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they&lsquo;re \"just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they&#39;re \"just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they&rsquo;re \"just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":250,"column":92,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're &quot;just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're &ldquo;just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're &#34;just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're &rdquo;just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":250,"column":108,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're \"just having fun&quot; and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're \"just having fun&ldquo; and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're \"just having fun&#34; and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[10900,11108],"text":"\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're \"just having fun&rdquo; and other users are starting to defend them. How would you handle this situation?\r\n              "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\n\r\nexport default function OfficerApplication() {\r\n  const { profile } = useAuthStore()\r\n  const [formData, setFormData] = useState({\r\n    fullName: '',\r\n    email: '',\r\n    phone: '',\r\n    timezone: '',\r\n    availableHours: '',\r\n    whyApplying: '',\r\n    experience: '',\r\n    conflictScenario: '',\r\n    strengths: '',\r\n    weeklyCommitment: '',\r\n    startDate: '',\r\n    references: ''\r\n  })\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\r\n    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }))\r\n  }\r\n\r\n  const submit = async (e?: React.FormEvent) => {\r\n    e?.preventDefault()\r\n    if (!profile) return toast.error('Please sign in')\r\n    \r\n    const requiredFields = ['fullName', 'email', 'timezone', 'availableHours', 'whyApplying', 'experience', 'conflictScenario', 'weeklyCommitment']\r\n    const missingFields = requiredFields.filter(field => !formData[field as keyof typeof formData].trim())\r\n    \r\n    if (missingFields.length > 0) {\r\n      return toast.error('Please complete all required fields')\r\n    }\r\n\r\n    try {\r\n      setLoading(true)\r\n      \r\n      const applicationData = {\r\n        user_id: profile.id,\r\n        type: 'troll_officer',\r\n        reason: formData.whyApplying,\r\n        goals: formData.weeklyCommitment,\r\n        data: {\r\n          username: profile.username,\r\n          fullName: formData.fullName,\r\n          email: formData.email,\r\n          phone: formData.phone,\r\n          timezone: formData.timezone,\r\n          availableHours: formData.availableHours,\r\n          experience: formData.experience,\r\n          conflictScenario: formData.conflictScenario,\r\n          strengths: formData.strengths,\r\n          weeklyCommitment: formData.weeklyCommitment,\r\n          startDate: formData.startDate,\r\n          references: formData.references\r\n        },\r\n        status: 'pending'\r\n      }\r\n      \r\n      const { error } = await supabase.from('applications').insert([applicationData])\r\n      \r\n      if (error) {\r\n        console.error('[Officer App] Submission error:', error)\r\n        toast.error(error.message || 'Failed to submit application')\r\n        throw error\r\n      }\r\n      \r\n      toast.success('Application submitted successfully! We will review your application and contact you within 3-5 business days.')\r\n      setFormData({\r\n        fullName: '',\r\n        email: '',\r\n        phone: '',\r\n        timezone: '',\r\n        availableHours: '',\r\n        whyApplying: '',\r\n        experience: '',\r\n        conflictScenario: '',\r\n        strengths: '',\r\n        weeklyCommitment: '',\r\n        startDate: '',\r\n        references: ''\r\n      })\r\n    } catch (err) {\r\n      console.error('Submit error:', err)\r\n      toast.error('Failed to submit application')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-8\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-cyan-400 via-pink-400 to-purple-400 bg-clip-text text-transparent mb-2\">\r\n            Troll Officer Employment Application\r\n          </h1>\r\n          <p className=\"text-[#E2E2E2]/60\">Position: Community Moderation Officer</p>\r\n        </div>\r\n\r\n        <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C] mb-6\">\r\n          <h2 className=\"text-xl font-semibold text-cyan-400 mb-3\">Position Overview</h2>\r\n          <p className=\"text-[#E2E2E2]/80 mb-3\">\r\n            As a Troll Officer, you will be responsible for maintaining order and enforcing community guidelines across all Troll City streams. \r\n            This is a position of trust and requires professionalism, integrity, and excellent judgment.\r\n          </p>\r\n          <div className=\"space-y-2 text-sm text-[#E2E2E2]/70\">\r\n            <h3 className=\"font-semibold text-white\">Responsibilities:</h3>\r\n            <ul className=\"list-disc list-inside space-y-1 ml-2\">\r\n              <li>Enforce Troll City community guidelines and terms of service</li>\r\n              <li>Issue warnings, mutes, kicks, and bans when necessary</li>\r\n              <li>Monitor chat for inappropriate behavior, spam, and rule violations</li>\r\n              <li>Respond to user reports and escalate serious incidents</li>\r\n              <li>Maintain detailed logs of moderation actions</li>\r\n              <li>Collaborate with other officers and administrators</li>\r\n            </ul>\r\n          </div>\r\n        </div>\r\n\r\n        <form onSubmit={submit} className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C] space-y-6\">\r\n          {/* Personal Information */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">Personal Information</h3>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Full Name <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"fullName\"\r\n                value={formData.fullName}\r\n                onChange={handleChange}\r\n                placeholder=\"First and Last Name\"\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Email Address <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"email\"\r\n                  name=\"email\"\r\n                  value={formData.email}\r\n                  onChange={handleChange}\r\n                  placeholder=\"your.email@example.com\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Phone Number <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n                </label>\r\n                <input\r\n                  type=\"tel\"\r\n                  name=\"phone\"\r\n                  value={formData.phone}\r\n                  onChange={handleChange}\r\n                  placeholder=\"+1 (555) 123-4567\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Timezone <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <select\r\n                  name=\"timezone\"\r\n                  value={formData.timezone}\r\n                  onChange={handleChange}\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                >\r\n                  <option value=\"\">Select timezone</option>\r\n                  <option value=\"PST\">PST (Pacific)</option>\r\n                  <option value=\"MST\">MST (Mountain)</option>\r\n                  <option value=\"CST\">CST (Central)</option>\r\n                  <option value=\"EST\">EST (Eastern)</option>\r\n                  <option value=\"GMT\">GMT (London)</option>\r\n                  <option value=\"CET\">CET (Central Europe)</option>\r\n                  <option value=\"JST\">JST (Japan)</option>\r\n                  <option value=\"AEST\">AEST (Australia)</option>\r\n                  <option value=\"Other\">Other</option>\r\n                </select>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Available Hours (Per Week) <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  name=\"availableHours\"\r\n                  value={formData.availableHours}\r\n                  onChange={handleChange}\r\n                  placeholder=\"e.g., Weekdays 6PM-10PM, Weekends flexible\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Qualifications */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">Qualifications & Experience</h3>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Why are you applying for this position? <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <textarea\r\n                name=\"whyApplying\"\r\n                value={formData.whyApplying}\r\n                onChange={handleChange}\r\n                placeholder=\"Describe your motivation and what makes you a good fit for this role...\"\r\n                rows={4}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Previous Moderation Experience <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <textarea\r\n                name=\"experience\"\r\n                value={formData.experience}\r\n                onChange={handleChange}\r\n                placeholder=\"List any previous moderation experience (Discord, Twitch, YouTube, forums, etc.). Include platforms, duration, and responsibilities...\"\r\n                rows={5}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Conflict Resolution Scenario <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <p className=\"text-xs text-[#E2E2E2]/60 mb-2\">\r\n                A user is repeatedly spamming in chat despite warnings. They claim they're \"just having fun\" and other users are starting to defend them. How would you handle this situation?\r\n              </p>\r\n              <textarea\r\n                name=\"conflictScenario\"\r\n                value={formData.conflictScenario}\r\n                onChange={handleChange}\r\n                placeholder=\"Describe your approach to handling this situation...\"\r\n                rows={5}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Key Strengths <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <textarea\r\n                name=\"strengths\"\r\n                value={formData.strengths}\r\n                onChange={handleChange}\r\n                placeholder=\"What are your key strengths as a moderator? (e.g., patience, quick decision-making, communication skills, etc.)\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Availability & Commitment */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">Availability & Commitment</h3>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Weekly Time Commitment <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <select\r\n                name=\"weeklyCommitment\"\r\n                value={formData.weeklyCommitment}\r\n                onChange={handleChange}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n              >\r\n                <option value=\"\">Select hours per week</option>\r\n                <option value=\"5-10\">5-10 hours/week</option>\r\n                <option value=\"10-15\">10-15 hours/week</option>\r\n                <option value=\"15-20\">15-20 hours/week</option>\r\n                <option value=\"20-25\">20-25 hours/week</option>\r\n                <option value=\"25+\">25+ hours/week</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                When can you start? <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"startDate\"\r\n                value={formData.startDate}\r\n                onChange={handleChange}\r\n                placeholder=\"e.g., Immediately, 2 weeks, 1 month\"\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                References <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <textarea\r\n                name=\"references\"\r\n                value={formData.references}\r\n                onChange={handleChange}\r\n                placeholder=\"List any references from previous moderation positions or community leadership roles (names, roles, contact info if available)\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Agreement */}\r\n          <div className=\"bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg p-4\">\r\n            <p className=\"text-sm text-[#E2E2E2]/70\">\r\n              By submitting this application, you confirm that all information provided is accurate and complete. You understand that:\r\n            </p>\r\n            <ul className=\"list-disc list-inside text-sm text-[#E2E2E2]/60 mt-2 space-y-1 ml-2\">\r\n              <li>Officer positions are volunteer-based with performance incentives</li>\r\n              <li>Officers receive 0.5% commission on enforcement fees collected</li>\r\n              <li>This role requires maintaining high standards of professionalism</li>\r\n              <li>Employment may be terminated for misconduct or policy violations</li>\r\n            </ul>\r\n          </div>\r\n\r\n          <button\r\n            type=\"submit\"\r\n            disabled={loading}\r\n            className=\"w-full px-6 py-4 bg-gradient-to-r from-[#FFC93C] to-[#FFD700] text-black rounded-lg font-bold text-lg hover:shadow-lg hover:shadow-[#FFC93C]/30 disabled:opacity-50 disabled:cursor-not-allowed transition-all\"\r\n          >\r\n            {loading ? 'Submitting Application...' : 'Submit Application'}\r\n          </button>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\OfficerLoungeStream.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isClaimingSeat' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":46,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":56,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\OfficerModeration.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":17,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":87,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useCallback } from 'react'\nimport { useNavigate } from 'react-router-dom'\nimport { supabase } from '../lib/supabase'\nimport { useAuthStore } from '../lib/store'\nimport { toast } from 'sonner'\nimport { \n  Shield, AlertTriangle, Eye, \n  CheckCircle, XCircle, Clock, Search,\n  Gavel, History, RotateCcw, Zap, Brain\n} from 'lucide-react'\nimport { ModerationReport } from '../types/moderation'\nimport ReportDetailsModal from '../components/ReportDetailsModal'\nimport api from '../lib/api'\n\nexport default function OfficerModeration() {\n  const { profile } = useAuthStore()\n  const navigate = useNavigate()\n  \n  // Tab State\n  const [activeTab, setActiveTab] = useState<'reports' | 'actions' | 'logs'>('reports')\n\n  // --- Reports State ---\n  const [reports, setReports] = useState<ModerationReport[]>([])\n  const [loadingReports, setLoadingReports] = useState(false)\n  const [selectedReport, setSelectedReport] = useState<ModerationReport | null>(null)\n  const [statusFilter, setStatusFilter] = useState<string>('all')\n  const [reportSearchTerm, setReportSearchTerm] = useState('')\n\n  // --- Actions State ---\n  const [targetUsername, setTargetUsername] = useState('')\n  const [targetId, setTargetId] = useState<string | null>(null)\n  const [actionType, setActionType] = useState('mute')\n  const [reason, setReason] = useState('')\n  const [duration, setDuration] = useState('60') // minutes\n  const [aiScore, setAiScore] = useState<number | null>(null)\n  const [processingAction, setProcessingAction] = useState(false)\n  const [lookingUpUser, setLookingUpUser] = useState(false)\n\n  // --- Logs State ---\n  const [logs, setLogs] = useState<any[]>([])\n  const [loadingLogs, setLoadingLogs] = useState(false)\n\n  // Load Reports\n  const loadReports = useCallback(async () => {\n    if (!profile) return\n    setLoadingReports(true)\n    try {\n      const response = await api.post('/moderation', {\n        action: 'list_reports',\n        status_filter: statusFilter === 'all' ? null : statusFilter\n      })\n      if (response.success) {\n        setReports(response.reports || [])\n      } else {\n        toast.error(response.error || 'Failed to load reports')\n      }\n    } catch (err: any) {\n      console.error('Error loading reports:', err)\n      // toast.error('Failed to load reports') \n    } finally {\n      setLoadingReports(false)\n    }\n  }, [profile, statusFilter])\n\n  // Load Logs\n  const loadLogs = useCallback(async () => {\n    setLoadingLogs(true)\n    const { data, error } = await supabase.rpc('get_moderation_logs', { limit_count: 50 })\n    if (error) {\n        toast.error('Failed to load logs')\n    } else {\n        setLogs(data || [])\n    }\n    setLoadingLogs(false)\n  }, [])\n\n  useEffect(() => {\n    if (activeTab === 'reports') loadReports()\n    if (activeTab === 'logs') loadLogs()\n  }, [activeTab, loadReports, loadLogs])\n\n  // Lookup User\n  const lookupUser = async () => {\n    if (!targetUsername) return\n    setLookingUpUser(true)\n    setTargetId(null)\n    const { data, error } = await supabase\n        .from('user_profiles')\n        .select('id, username, avatar_url')\n        .ilike('username', targetUsername)\n        .maybeSingle()\n    \n    if (data) {\n        setTargetId(data.id)\n        toast.success(`Found user: ${data.username}`)\n    } else {\n        toast.error('User not found')\n    }\n    setLookingUpUser(false)\n  }\n\n  // AI Check\n  const checkToxicity = async () => {\n    if (!reason) {\n        toast.error('Please enter a reason/content to check')\n        return\n    }\n    // Mock AI Check\n    const score = Math.random() * 100\n    setAiScore(score)\n    if (score > 80) toast.error(`High Toxicity Detected (${score.toFixed(1)}%)`)\n    else if (score > 50) toast.warning(`Moderate Toxicity (${score.toFixed(1)}%)`)\n    else toast.success(`Low Toxicity (${score.toFixed(1)}%)`)\n  }\n\n  // Execute Action\n  const handleExecuteAction = async () => {\n    if (!targetId) {\n        toast.error('Please lookup a valid user first')\n        return\n    }\n    if (!reason) {\n        toast.error('Reason is required')\n        return\n    }\n\n    setProcessingAction(true)\n    try {\n        const { data, error } = await supabase.rpc('perform_moderation_action', {\n            p_target_id: targetId,\n            p_action_type: actionType,\n            p_reason: reason,\n            p_duration_minutes: actionType === 'kick' || actionType === 'warning' ? null : parseInt(duration)\n        })\n\n        if (error) throw error\n        if (!data.success) throw new Error(data.error)\n\n        toast.success('Action executed successfully')\n        setTargetUsername('')\n        setTargetId(null)\n        setReason('')\n        setAiScore(null)\n    } catch (err: any) {\n        toast.error(err.message)\n    } finally {\n        setProcessingAction(false)\n    }\n  }\n\n  // Rollback\n  const handleRollback = async (logId: string) => {\n    if (!confirm('Are you sure you want to rollback this action?')) return\n    try {\n        const { data, error } = await supabase.rpc('rollback_moderation_action', { p_log_id: logId })\n        if (error) throw error\n        if (!data.success) throw new Error(data.error)\n        \n        toast.success('Action rolled back')\n        loadLogs()\n    } catch (err: any) {\n        toast.error(err.message)\n    }\n  }\n\n  const filteredReports = reports.filter(report => {\n    if (reportSearchTerm) {\n      const search = reportSearchTerm.toLowerCase()\n      return (\n        report.reporter_username?.toLowerCase().includes(search) ||\n        report.target_username?.toLowerCase().includes(search) ||\n        report.reason?.toLowerCase().includes(search) ||\n        report.description?.toLowerCase().includes(search)\n      )\n    }\n    return true\n  })\n\n  const getStatusBadge = (status: string) => {\n    const badges = {\n      pending: { color: 'bg-yellow-900 text-yellow-300', icon: Clock },\n      reviewing: { color: 'bg-blue-900 text-blue-300', icon: Eye },\n      resolved: { color: 'bg-green-900 text-green-300', icon: CheckCircle },\n      action_taken: { color: 'bg-purple-900 text-purple-300', icon: Shield },\n      rejected: { color: 'bg-red-900 text-red-300', icon: XCircle }\n    }\n    const badge = badges[status as keyof typeof badges] || badges.pending\n    const Icon = badge.icon\n\n    return (\n      <span className={`px-2 py-1 rounded text-xs font-semibold flex items-center gap-1 ${badge.color}`}>\n        <Icon className=\"w-3 h-3\" />\n        {status.replace('_', ' ').toUpperCase()}\n      </span>\n    )\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-4 md:p-6 md:ml-64\">\n      <div className=\"max-w-7xl mx-auto space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-white flex items-center gap-3\">\n              <Shield className=\"w-8 h-8 text-purple-400\" />\n              Officer Moderation\n            </h1>\n            <p className=\"text-gray-400 mt-1\">Review reports, execute actions, and audit logs</p>\n          </div>\n        </div>\n\n        {/* Tabs */}\n        <div className=\"flex gap-2 border-b border-white/10\">\n            <button \n                onClick={() => setActiveTab('reports')}\n                className={`px-4 py-2 text-sm font-medium transition-colors border-b-2 ${activeTab === 'reports' ? 'border-purple-500 text-purple-400' : 'border-transparent text-gray-400 hover:text-white'}`}\n            >\n                Reports\n            </button>\n            <button \n                onClick={() => setActiveTab('actions')}\n                className={`px-4 py-2 text-sm font-medium transition-colors border-b-2 ${activeTab === 'actions' ? 'border-purple-500 text-purple-400' : 'border-transparent text-gray-400 hover:text-white'}`}\n            >\n                Direct Actions\n            </button>\n            <button \n                onClick={() => setActiveTab('logs')}\n                className={`px-4 py-2 text-sm font-medium transition-colors border-b-2 ${activeTab === 'logs' ? 'border-purple-500 text-purple-400' : 'border-transparent text-gray-400 hover:text-white'}`}\n            >\n                Audit Logs\n            </button>\n        </div>\n\n        {/* --- REPORTS TAB --- */}\n        {activeTab === 'reports' && (\n            <div className=\"space-y-4\">\n                {/* Filters */}\n                <div className=\"bg-zinc-900 rounded-xl p-4 border border-[#2C2C2C]\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n                    <input\n                        type=\"text\"\n                        placeholder=\"Search reports...\"\n                        value={reportSearchTerm}\n                        onChange={(e) => setReportSearchTerm(e.target.value)}\n                        className=\"w-full pl-10 pr-4 py-2 bg-zinc-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                    />\n                    </div>\n\n                    <select\n                    value={statusFilter}\n                    onChange={(e) => setStatusFilter(e.target.value)}\n                    className=\"px-4 py-2 bg-zinc-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                    >\n                    <option value=\"all\">All Status</option>\n                    <option value=\"pending\">Pending</option>\n                    <option value=\"reviewing\">Reviewing</option>\n                    <option value=\"action_taken\">Action Taken</option>\n                    <option value=\"resolved\">Resolved</option>\n                    <option value=\"rejected\">Rejected</option>\n                    </select>\n                </div>\n                </div>\n\n                {/* Reports Table */}\n                <div className=\"bg-zinc-900 rounded-xl p-4 border border-[#2C2C2C]\">\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\n                    <AlertTriangle className=\"w-5 h-5 text-red-400\" />\n                    Reports ({filteredReports.length})\n                </h2>\n\n                {loadingReports ? (\n                    <div className=\"text-center py-8 text-gray-400\">Loading reports...</div>\n                ) : filteredReports.length === 0 ? (\n                    <div className=\"text-center py-8 text-gray-400\">No reports found</div>\n                ) : (\n                    <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                        <thead>\n                        <tr className=\"border-b border-gray-700 text-gray-400\">\n                            <th className=\"text-left py-2\">Reporter</th>\n                            <th className=\"text-left py-2\">Target</th>\n                            <th className=\"text-left py-2\">Reason</th>\n                            <th className=\"text-center py-2\">Status</th>\n                            <th className=\"text-left py-2\">Created</th>\n                            <th className=\"text-center py-2\">Actions</th>\n                        </tr>\n                        </thead>\n                        <tbody>\n                        {filteredReports.map((report) => (\n                            <tr key={report.id} className=\"border-b border-gray-800 hover:bg-gray-800/50\">\n                            <td className=\"py-2 text-blue-400\">{report.reporter_username || 'Unknown'}</td>\n                            <td className=\"py-2 text-purple-400\">{report.target_username || report.stream_title || '‚Äî'}</td>\n                            <td className=\"py-2 text-gray-300\">{report.reason}</td>\n                            <td className=\"text-center py-2\">{getStatusBadge(report.status)}</td>\n                            <td className=\"py-2 text-gray-400 text-xs\">{new Date(report.created_at).toLocaleDateString()}</td>\n                            <td className=\"text-center py-2\">\n                                <button\n                                onClick={() => setSelectedReport(report)}\n                                className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs font-semibold\"\n                                >\n                                View\n                                </button>\n                            </td>\n                            </tr>\n                        ))}\n                        </tbody>\n                    </table>\n                    </div>\n                )}\n                </div>\n            </div>\n        )}\n\n        {/* --- ACTIONS TAB --- */}\n        {activeTab === 'actions' && (\n            <div className=\"grid md:grid-cols-2 gap-6\">\n                <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C] space-y-4\">\n                    <h2 className=\"text-xl font-bold flex items-center gap-2\">\n                        <Gavel className=\"w-5 h-5 text-purple-400\" />\n                        Execute Action\n                    </h2>\n                    \n                    <div>\n                        <label className=\"block text-xs font-medium text-gray-400 mb-1\">Target Username</label>\n                        <div className=\"flex gap-2\">\n                            <input \n                                type=\"text\"\n                                value={targetUsername}\n                                onChange={(e) => setTargetUsername(e.target.value)}\n                                className=\"flex-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                                placeholder=\"Enter username...\"\n                            />\n                            <button \n                                onClick={lookupUser}\n                                disabled={lookingUpUser}\n                                className=\"px-3 py-2 bg-purple-600 rounded-lg hover:bg-purple-500 disabled:opacity-50\"\n                            >\n                                <Search className=\"w-4 h-4\" />\n                            </button>\n                        </div>\n                        {targetId && <div className=\"text-xs text-green-400 mt-1\">User ID: {targetId}</div>}\n                    </div>\n\n                    <div>\n                        <label className=\"block text-xs font-medium text-gray-400 mb-1\">Action Type</label>\n                        <select \n                            value={actionType}\n                            onChange={(e) => setActionType(e.target.value)}\n                            className=\"w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                        >\n                            <option value=\"mute\">Mute (Silence)</option>\n                            <option value=\"kick\">Kick (Disconnect)</option>\n                            <option value=\"ban\">Ban (Suspension)</option>\n                            <option value=\"warning\">Warning (Notification)</option>\n                        </select>\n                    </div>\n\n                    {(actionType === 'mute' || actionType === 'ban') && (\n                        <div>\n                            <label className=\"block text-xs font-medium text-gray-400 mb-1\">Duration (Minutes)</label>\n                            <input \n                                type=\"number\"\n                                value={duration}\n                                onChange={(e) => setDuration(e.target.value)}\n                                className=\"w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                            />\n                        </div>\n                    )}\n\n                    <div>\n                        <label className=\"block text-xs font-medium text-gray-400 mb-1\">Reason / Content</label>\n                        <textarea \n                            value={reason}\n                            onChange={(e) => setReason(e.target.value)}\n                            className=\"w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm h-24 focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                            placeholder=\"Reason for action or content being moderated...\"\n                        />\n                    </div>\n\n                    <div className=\"flex items-center justify-between pt-4 border-t border-white/5\">\n                        <button \n                            onClick={checkToxicity}\n                            className=\"flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-lg hover:bg-blue-500/20\"\n                        >\n                            <Brain className=\"w-4 h-4\" />\n                            AI Check\n                        </button>\n                        \n                        <button \n                            onClick={handleExecuteAction}\n                            disabled={processingAction || !targetId}\n                            className=\"flex items-center gap-2 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500 disabled:opacity-50 disabled:cursor-not-allowed font-bold\"\n                        >\n                            <Zap className=\"w-4 h-4\" />\n                            Execute\n                        </button>\n                    </div>\n\n                    {aiScore !== null && (\n                        <div className=\"p-3 rounded-lg bg-white/5 border border-white/10 text-xs\">\n                            <span className=\"font-bold\">AI Toxicity Score:</span> {aiScore.toFixed(1)}%\n                        </div>\n                    )}\n                </div>\n\n                <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C]\">\n                    <h3 className=\"font-bold mb-4 text-gray-300\">Guidelines</h3>\n                    <ul className=\"list-disc pl-5 space-y-2 text-sm text-gray-400\">\n                        <li><strong className=\"text-white\">Mute:</strong> Prevents user from sending messages. Good for spam.</li>\n                        <li><strong className=\"text-white\">Kick:</strong> Disconnects user from the server. They can rejoin immediately.</li>\n                        <li><strong className=\"text-white\">Ban:</strong> Prevents login for the specified duration. Use for severe violations.</li>\n                        <li><strong className=\"text-white\">Warning:</strong> Sends a system alert to the user.</li>\n                    </ul>\n                    <div className=\"mt-6 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg text-xs text-yellow-200\">\n                        <AlertTriangle className=\"w-4 h-4 inline mr-2\" />\n                        All actions are logged and auditable. Abuse of power will result in revocation of officer status.\n                    </div>\n                </div>\n            </div>\n        )}\n\n        {/* --- LOGS TAB --- */}\n        {activeTab === 'logs' && (\n            <div className=\"bg-zinc-900 rounded-xl p-4 border border-[#2C2C2C]\">\n                <div className=\"flex items-center justify-between mb-4\">\n                    <h2 className=\"text-xl font-bold flex items-center gap-2\">\n                        <History className=\"w-5 h-5 text-gray-400\" />\n                        Audit Logs\n                    </h2>\n                    <button onClick={loadLogs} className=\"p-2 bg-white/5 rounded-lg hover:bg-white/10\">\n                        <RotateCcw className=\"w-4 h-4\" />\n                    </button>\n                </div>\n\n                {loadingLogs ? (\n                    <div className=\"text-center py-8 text-gray-400\">Loading logs...</div>\n                ) : logs.length === 0 ? (\n                    <div className=\"text-center py-8 text-gray-400\">No logs found</div>\n                ) : (\n                    <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                        <thead>\n                        <tr className=\"border-b border-gray-700 text-gray-400\">\n                            <th className=\"text-left py-2\">Time</th>\n                            <th className=\"text-left py-2\">Moderator</th>\n                            <th className=\"text-left py-2\">Action</th>\n                            <th className=\"text-left py-2\">Target</th>\n                            <th className=\"text-left py-2\">Reason</th>\n                            <th className=\"text-right py-2\">Options</th>\n                        </tr>\n                        </thead>\n                        <tbody>\n                        {logs.map((log) => (\n                            <tr key={log.id} className=\"border-b border-gray-800 hover:bg-gray-800/50\">\n                                <td className=\"py-2 text-gray-500 text-xs\">{new Date(log.created_at).toLocaleString()}</td>\n                                <td className=\"py-2 font-medium text-blue-400\">{log.moderator_username}</td>\n                                <td className=\"py-2\">\n                                    <span className={`px-2 py-0.5 rounded text-xs border ${\n                                        log.action_type === 'ban' ? 'bg-red-900/30 border-red-500/30 text-red-400' :\n                                        log.action_type === 'kick' ? 'bg-orange-900/30 border-orange-500/30 text-orange-400' :\n                                        log.action_type === 'rollback' ? 'bg-gray-800 border-gray-600 text-gray-400' :\n                                        'bg-purple-900/30 border-purple-500/30 text-purple-400'\n                                    }`}>\n                                        {log.action_type.toUpperCase()}\n                                    </span>\n                                </td>\n                                <td className=\"py-2 text-gray-300\">{log.target_username}</td>\n                                <td className=\"py-2 text-gray-400 italic truncate max-w-[200px]\">{log.reason}</td>\n                                <td className=\"py-2 text-right\">\n                                    {(log.action_type === 'ban' || log.action_type === 'mute') && (\n                                        <button \n                                            onClick={() => handleRollback(log.id)}\n                                            className=\"text-xs text-red-400 hover:text-red-300 underline\"\n                                        >\n                                            Rollback\n                                        </button>\n                                    )}\n                                </td>\n                            </tr>\n                        ))}\n                        </tbody>\n                    </table>\n                    </div>\n                )}\n            </div>\n        )}\n      </div>\n\n      {/* Report Details Modal */}\n      {selectedReport && (\n        <ReportDetailsModal\n          report={selectedReport}\n          onClose={() => setSelectedReport(null)}\n          onActionTaken={() => {\n            setSelectedReport(null)\n            loadReports()\n          }}\n        />\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\OfficerOWCDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\OfficerScheduling.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":568,"column":61,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[19728,19769],"text":"Click &quot;Schedule New Shift\" to get started"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[19728,19769],"text":"Click &ldquo;Schedule New Shift\" to get started"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[19728,19769],"text":"Click &#34;Schedule New Shift\" to get started"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[19728,19769],"text":"Click &rdquo;Schedule New Shift\" to get started"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":568,"column":80,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[19728,19769],"text":"Click \"Schedule New Shift&quot; to get started"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[19728,19769],"text":"Click \"Schedule New Shift&ldquo; to get started"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[19728,19769],"text":"Click \"Schedule New Shift&#34; to get started"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[19728,19769],"text":"Click \"Schedule New Shift&rdquo; to get started"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase, isAdminEmail } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { Calendar, Clock, Plus, Trash2, CheckCircle, XCircle, AlertCircle, DollarSign } from 'lucide-react'\r\nimport { format12hr } from '../utils/timeFormat'\r\n\r\ninterface ShiftSlot {\r\n  id: string\r\n  officer_id: string\r\n  shift_date: string\r\n  shift_start_time: string\r\n  shift_end_time: string\r\n  status: 'scheduled' | 'active' | 'completed' | 'cancelled'\r\n  created_at: string\r\n  shift_log_id?: string\r\n  coins_earned?: number\r\n  hours_worked?: number\r\n  cashed_out?: boolean\r\n}\r\n\r\nexport default function OfficerScheduling() {\r\n  const { profile, user } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [slots, setSlots] = useState<ShiftSlot[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [selectedDate, setSelectedDate] = useState('')\r\n  const [startTime, setStartTime] = useState('')\r\n  const [endTime, setEndTime] = useState('')\r\n  const [showAddForm, setShowAddForm] = useState(false)\r\n  const [blockedSlots, setBlockedSlots] = useState<ShiftSlot[]>([])\r\n\r\n  const formatTime12h = (time: string) => {\r\n    return format12hr(time);\r\n  }\r\n\r\n  // Check if user is officer or admin\r\n  useEffect(() => {\r\n    if (!profile || !user) {\r\n      return // Don't navigate immediately, wait for profile to load\r\n    }\r\n    const isAdmin = profile.is_admin || profile.role === 'admin' || isAdminEmail(user.email)\r\n    const isOfficer = profile.is_troll_officer || profile.role === 'troll_officer'\r\n    \r\n    if (!isOfficer && !isAdmin) {\r\n      toast.error('Officer access required')\r\n      navigate('/')\r\n      return\r\n    }\r\n  }, [profile, user, navigate])\r\n\r\n  const loadSlots = useCallback(async () => {\r\n    if (!profile?.id) return\r\n    setLoading(true)\r\n    try {\r\n      // Load shift slots\r\n      const { data: slotsData, error: slotsError } = await supabase\r\n        .from('officer_shift_slots')\r\n        .select('*')\r\n        .eq('officer_id', profile.id)\r\n        .order('shift_date', { ascending: true })\r\n        .order('shift_start_time', { ascending: true })\r\n\r\n      if (slotsError) {\r\n        console.error('Error loading shift slots:', {\r\n          error: slotsError,\r\n          message: slotsError.message,\r\n          code: slotsError.code,\r\n          details: slotsError.details,\r\n          hint: slotsError.hint\r\n        })\r\n        throw slotsError\r\n      }\r\n\r\n      // Load shift logs to get earnings and active shifts (non-critical, continue if fails)\r\n      let logsData = null\r\n      let activeLogsData = null\r\n\r\n      try {\r\n        // Load completed shift logs for earnings\r\n        const { data: logs, error: logsError } = await supabase\r\n          .from('officer_work_sessions')\r\n          .select('id, coins_earned, hours_worked, clock_in, clock_out')\r\n          .eq('officer_id', profile.id)\r\n          .not('clock_out', 'is', null)\r\n\r\n        if (logsError) {\r\n          console.warn('Error loading shift logs (non-critical):', logsError)\r\n        } else {\r\n          logsData = logs\r\n        }\r\n\r\n        // Load active shift logs to check if clocked in\r\n        const { data: activeLogs, error: activeLogsError } = await supabase\r\n          .from('officer_work_sessions')\r\n          .select('id, clock_in, clock_out')\r\n          .eq('officer_id', profile.id)\r\n          .is('clock_out', null)\r\n\r\n        if (activeLogsError) {\r\n          console.warn('Error loading active shift logs (non-critical):', activeLogsError)\r\n        } else {\r\n          activeLogsData = activeLogs\r\n        }\r\n      } catch (logErr) {\r\n        console.warn('Failed to load shift logs (non-critical):', logErr)\r\n      }\r\n\r\n      // Load cashout status (non-critical, continue if fails)\r\n      let cashoutData = null\r\n      try {\r\n        const { data: cashouts } = await supabase\r\n          .from('officer_payouts')\r\n          .select('shift_log_id, status')\r\n          .eq('officer_id', profile.id)\r\n          .in('status', ['pending', 'approved', 'paid'])\r\n        \r\n        cashoutData = cashouts\r\n      } catch (cashoutErr) {\r\n        console.warn('Failed to load cashout data (non-critical):', cashoutErr)\r\n      }\r\n\r\n      // Map slots with shift log data by matching date\r\n      const slotsWithData = (slotsData || []).map(slot => {\r\n        const slotDate = new Date(slot.shift_date)\r\n        const slotDateTime = new Date(`${slot.shift_date}T${slot.shift_start_time}`)\r\n        \r\n        // Find matching completed shift log by date\r\n        const shiftLog = logsData?.find(log => {\r\n          if (!log.clock_in) return false\r\n          const logDate = new Date(log.clock_in)\r\n          return logDate.toDateString() === slotDate.toDateString()\r\n        })\r\n        \r\n        // Find matching active shift log by checking if there's an active log that matches this slot\r\n        const activeLog = activeLogsData?.find(log => {\r\n          if (!log.clock_in) return false\r\n          const logStart = new Date(log.clock_in)\r\n          // Match by date and approximate time (within 1 hour)\r\n          const timeDiff = Math.abs(logStart.getTime() - slotDateTime.getTime())\r\n          return logStart.toDateString() === slotDate.toDateString() && timeDiff < 3600000 // 1 hour\r\n        })\r\n        \r\n        const cashout = shiftLog ? cashoutData?.find(c => c.shift_log_id === shiftLog.id) : null\r\n        \r\n        // If there's an active log for this slot, ensure status is 'active'\r\n        const finalStatus = activeLog ? 'active' : slot.status\r\n        \r\n        return {\r\n          ...slot,\r\n          status: finalStatus,\r\n          shift_log_id: shiftLog?.id || activeLog?.id,\r\n          coins_earned: shiftLog?.coins_earned,\r\n          hours_worked: shiftLog?.hours_worked,\r\n          cashed_out: !!cashout,\r\n          has_active_log: !!activeLog\r\n        }\r\n      })\r\n\r\n      setSlots(slotsWithData)\r\n    } catch (err: any) {\r\n      console.error('Error loading shift slots:', {\r\n        error: err,\r\n        message: err?.message || 'Unknown error',\r\n        code: err?.code,\r\n        details: err?.details,\r\n        hint: err?.hint,\r\n        stack: err?.stack\r\n      })\r\n      const errorMessage = err?.message || err?.details || 'Failed to load shift slots'\r\n      toast.error(errorMessage)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [profile?.id])\r\n\r\n  // Load shift slots and subscribe to real-time updates\r\n  useEffect(() => {\r\n    if (profile?.id) {\r\n      loadSlots()\r\n\r\n      // Subscribe to real-time updates\r\n      const channel = supabase\r\n        .channel('officer_shift_slots_realtime')\r\n        .on(\r\n          'postgres_changes',\r\n          {\r\n            event: '*',\r\n            schema: 'public',\r\n            table: 'officer_shift_slots',\r\n            filter: `officer_id=eq.${profile.id}`\r\n          },\r\n          () => {\r\n            loadSlots()\r\n          }\r\n        )\r\n        .subscribe()\r\n\r\n      return () => {\r\n        supabase.removeChannel(channel)\r\n      }\r\n    }\r\n  }, [profile?.id, loadSlots])\r\n\r\n  const handleAddSlot = async () => {\r\n    if (!profile?.id || !selectedDate || !startTime || !endTime) {\r\n      toast.error('Please fill in all fields')\r\n      return\r\n    }\r\n\r\n    // Validate time range\r\n    if (startTime >= endTime) {\r\n      toast.error('End time must be after start time')\r\n      return\r\n    }\r\n\r\n    // Validate date is not in the past\r\n    const slotDate = new Date(selectedDate)\r\n    const today = new Date()\r\n    today.setHours(0, 0, 0, 0)\r\n    if (slotDate < today) {\r\n      toast.error('Cannot schedule shifts in the past')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      const { error } = await supabase\r\n        .from('officer_shift_slots')\r\n        .insert({\r\n          officer_id: profile.id,\r\n          shift_date: selectedDate,\r\n          shift_start_time: startTime,\r\n          shift_end_time: endTime,\r\n          status: 'scheduled'\r\n        })\r\n\r\n      if (error) {\r\n        if (error.code === '23505') { // Unique constraint violation\r\n          toast.error('You already have a shift scheduled for this date and time')\r\n        } else {\r\n          throw error\r\n        }\r\n        return\r\n      }\r\n\r\n      toast.success('Shift slot created successfully')\r\n      setSelectedDate('')\r\n      setStartTime('')\r\n      setEndTime('')\r\n      setShowAddForm(false)\r\n      await loadSlots()\r\n    } catch (err: any) {\r\n      console.error('Error creating shift slot:', err)\r\n      toast.error(err?.message || 'Failed to create shift slot')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleClockIn = async (slotId: string) => {\r\n    if (!profile?.id) return\r\n    \r\n    // Prevent admins from clocking in\r\n    const isAdmin = profile.is_admin || profile.role === 'admin' || isAdminEmail(user?.email)\r\n    if (isAdmin) {\r\n      toast.info('Admins have full access without needing to clock in for shifts')\r\n      return\r\n    }\r\n    \r\n    // Check if the shift is blocked (passed by 15 minutes)\r\n    const slot = slots.find(s => s.id === slotId)\r\n    if (slot) {\r\n      const slotDateTime = new Date(`${slot.shift_date}T${slot.shift_start_time}`)\r\n      const now = new Date()\r\n      const timeDiff = now.getTime() - slotDateTime.getTime()\r\n      const fifteenMinutesInMs = 15 * 60 * 1000\r\n      \r\n      if (timeDiff > fifteenMinutesInMs) {\r\n        toast.error('This shift has passed by 15 minutes and cannot be clocked in')\r\n        \r\n        // Mark this slot as blocked\r\n        setBlockedSlots(prev => [...prev, slot])\r\n        \r\n        // Assign this shift to another officer who isn't assigned a shift\r\n        await assignShiftToAnotherOfficer(slot)\r\n        \r\n        return\r\n      }\r\n    }\r\n    \r\n    setLoading(true)\r\n    try {\r\n      const { data, error } = await supabase.rpc('clock_in_from_slot', {\r\n        p_slot_id: slotId\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success('Clocked in successfully!')\r\n        await loadSlots()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to clock in')\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Error clocking in:', err)\r\n      toast.error(err?.message || 'Failed to clock in')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const assignShiftToAnotherOfficer = async (slot: ShiftSlot) => {\r\n    try {\r\n      // Find officers who don't have a shift at this time\r\n      const { data: officers, error: officersError } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username')\r\n        .eq('is_troll_officer', true)\r\n        .neq('id', profile?.id)\r\n      \r\n      if (officersError) throw officersError\r\n      \r\n      // Filter officers who don't have a shift at this time\r\n      const availableOfficers = officers.filter(officer => {\r\n        return !slots.some(s => s.officer_id === officer.id && s.shift_date === slot.shift_date)\r\n      })\r\n      \r\n      if (availableOfficers.length > 0) {\r\n        // Assign to the first available officer\r\n        const assignedOfficer = availableOfficers[0]\r\n        \r\n        // Update the shift assignment\r\n        const { error: updateError } = await supabase\r\n          .from('officer_shift_slots')\r\n          .update({ officer_id: assignedOfficer.id })\r\n          .eq('id', slot.id)\r\n        \r\n        if (updateError) throw updateError\r\n        \r\n        // Send push notification\r\n        await sendPushNotification(\r\n          assignedOfficer.id,\r\n          `You have been assigned a new shift: ${slot.shift_date} ${formatTime12h(slot.shift_start_time)} - ${formatTime12h(slot.shift_end_time)}`\r\n        )\r\n        \r\n        toast.success(`Shift reassigned to ${assignedOfficer.username}`)\r\n      } else {\r\n        toast.info('No available officers to reassign this shift')\r\n      }\r\n    } catch (err) {\r\n      console.error('Error reassigning shift:', err)\r\n      toast.error('Failed to reassign shift')\r\n    }\r\n  }\r\n\r\n  const sendPushNotification = async (userId: string, message: string) => {\r\n    try {\r\n      // Insert notification into database\r\n      const { error } = await supabase\r\n        .from('notifications')\r\n        .insert({\r\n          user_id: userId,\r\n          message: message,\r\n          type: 'shift_assignment',\r\n          is_read: false\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      // In a real app, you would also send a push notification via a service like Firebase\r\n      console.log(`Push notification sent to user ${userId}: ${message}`)\r\n    } catch (err) {\r\n      console.error('Error sending push notification:', err)\r\n    }\r\n  }\r\n\r\n  const handleClockOut = async (slotId: string) => {\r\n    if (!profile?.id) return\r\n    \r\n    // Prevent admins from clocking out\r\n    const isAdmin = profile.is_admin || profile.role === 'admin' || isAdminEmail(user?.email)\r\n    if (isAdmin) {\r\n      toast.info('Admins have full access without needing to clock out for shifts')\r\n      return\r\n    }\r\n    \r\n    setLoading(true)\r\n    try {\r\n      const { data, error } = await supabase.rpc('clock_out_and_complete_slot', {\r\n        p_slot_id: slotId\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success(`Clocked out! Earned ${data.coins_earned?.toLocaleString()} free coins for ${data.hours_worked?.toFixed(2)} hours`)\r\n        await loadSlots()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to clock out')\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Error clocking out:', err)\r\n      toast.error(err?.message || 'Failed to clock out')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleCashout = async (shiftLogId: string) => {\r\n    if (!profile?.id || !shiftLogId) return\r\n    setLoading(true)\r\n    try {\r\n      const { data, error } = await supabase.rpc('officer_cashout_after_shift', {\r\n        p_shift_log_id: shiftLogId\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        const troll_coins = data.troll_coins_received?.toLocaleString() || '0'\r\n        const usdAmount = data.usd_amount?.toFixed(2) || '0.00'\r\n        toast.success(`Cashout successful! Converted ${data.free_coins_redeemed?.toLocaleString()} free coins to ${troll_coins} troll_coins ($${usdAmount})`)\r\n        await loadSlots()\r\n        // Refresh profile to update balances\r\n        const { data: updatedProfile } = await supabase\r\n          .from('user_profiles')\r\n          .select('*')\r\n          .eq('id', profile.id)\r\n          .single()\r\n        if (updatedProfile) {\r\n          useAuthStore.getState().setProfile(updatedProfile as any)\r\n        }\r\n      } else {\r\n        toast.error(data?.error || 'Failed to cash out')\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Error cashing out:', err)\r\n      toast.error(err?.message || 'Failed to cash out')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleDeleteSlot = async (slotId: string, status: string) => {\r\n    if (status === 'active') {\r\n      toast.error('Cannot delete an active shift. Please clock out first.')\r\n      return\r\n    }\r\n\r\n    if (!confirm('Are you sure you want to delete this shift slot?')) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      const { error } = await supabase\r\n        .from('officer_shift_slots')\r\n        .delete()\r\n        .eq('id', slotId)\r\n        .eq('officer_id', profile!.id)\r\n\r\n      if (error) throw error\r\n\r\n      toast.success('Shift slot deleted')\r\n      await loadSlots()\r\n    } catch (err: any) {\r\n      console.error('Error deleting shift slot:', err)\r\n      toast.error(err?.message || 'Failed to delete shift slot')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // Group slots by date\r\n  const groupedSlots = slots.reduce((acc, slot) => {\r\n    const date = slot.shift_date\r\n    if (!acc[date]) {\r\n      acc[date] = []\r\n    }\r\n    acc[date].push(slot)\r\n    return acc\r\n  }, {} as Record<string, ShiftSlot[]>)\r\n\r\n  // Get today's date for min date\r\n  const today = new Date().toISOString().split('T')[0]\r\n\r\n  if (!profile) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-6\">\r\n          <h1 className=\"text-3xl font-bold mb-2 flex items-center gap-2\">\r\n            <Calendar className=\"w-8 h-8 text-purple-400\" />\r\n            Officer Shift Scheduling\r\n          </h1>\r\n          <p className=\"text-gray-400\">\r\n            Schedule your work shifts in advance. Each slot must be filled by you.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Add Slot Button */}\r\n        <div className=\"mb-6\">\r\n          <button\r\n            onClick={() => setShowAddForm(!showAddForm)}\r\n            className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg flex items-center gap-2 transition-colors\"\r\n          >\r\n            <Plus className=\"w-5 h-5\" />\r\n            {showAddForm ? 'Cancel' : 'Schedule New Shift'}\r\n          </button>\r\n        </div>\r\n\r\n        {/* Add Slot Form */}\r\n        {showAddForm && (\r\n          <div className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6 mb-6\">\r\n            <h2 className=\"text-xl font-bold mb-4\">Schedule New Shift</h2>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">Date</label>\r\n                <input\r\n                  type=\"date\"\r\n                  value={selectedDate}\r\n                  onChange={(e) => setSelectedDate(e.target.value)}\r\n                  min={today}\r\n                  className=\"w-full bg-[#0D0D0D] border border-purple-500/40 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-600 focus:border-transparent\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">Start Time</label>\r\n                <input\r\n                  type=\"time\"\r\n                  value={startTime}\r\n                  onChange={(e) => setStartTime(e.target.value)}\r\n                  className=\"w-full bg-[#0D0D0D] border border-purple-500/40 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-600 focus:border-transparent\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">End Time</label>\r\n                <input\r\n                  type=\"time\"\r\n                  value={endTime}\r\n                  onChange={(e) => setEndTime(e.target.value)}\r\n                  className=\"w-full bg-[#0D0D0D] border border-purple-500/40 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-600 focus:border-transparent\"\r\n                />\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={handleAddSlot}\r\n              disabled={loading}\r\n              className=\"mt-4 px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n            >\r\n              {loading ? 'Creating...' : 'Create Shift Slot'}\r\n            </button>\r\n          </div>\r\n        )}\r\n\r\n        {/* Shift Slots List */}\r\n        {loading && slots.length === 0 ? (\r\n          <div className=\"text-center text-gray-400 py-8\">Loading shift slots...</div>\r\n        ) : slots.length === 0 ? (\r\n          <div className=\"bg-[#1A1A1A] border border-gray-700 rounded-xl p-8 text-center\">\r\n            <Calendar className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\r\n            <p className=\"text-gray-400\">No shift slots scheduled yet</p>\r\n            <p className=\"text-sm text-gray-500 mt-2\">Click \"Schedule New Shift\" to get started</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-6\">\r\n            {Object.entries(groupedSlots).map(([date, dateSlots]) => (\r\n              <div key={date} className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n                <h3 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Calendar className=\"w-5 h-5 text-purple-400\" />\r\n                  {new Date(date).toLocaleDateString('en-US', { \r\n                    weekday: 'long', \r\n                    year: 'numeric', \r\n                    month: 'long', \r\n                    day: 'numeric' \r\n                  })}\r\n                </h3>\r\n                <div className=\"space-y-3\">\r\n                  {dateSlots.map((slot) => {\r\n                    const slotDateTime = new Date(`${slot.shift_date}T${slot.shift_start_time}`)\r\n                    const isAdmin = profile.is_admin || profile.role === 'admin' || isAdminEmail(user?.email)\r\n                    const isPast = slotDateTime < new Date()\r\n                    // Admins can't clock in/out (they don't get paid)\r\n                    const canClockIn = !isAdmin && !isPast && slot.status === 'scheduled'\r\n                    // Show clock out if status is 'active' OR if there's an active shift log (but not for admins)\r\n                    const canClockOut = !isAdmin && (slot.status === 'active' || (slot as any).has_active_log)\r\n\r\n                    return (\r\n                      <div\r\n                        key={slot.id}\r\n                        className={`bg-[#0D0D0D] border rounded-lg p-4 ${\r\n                          slot.status === 'active' || (slot as any).has_active_log\r\n                            ? 'border-green-500/50 bg-green-500/10'\r\n                            : slot.status === 'completed'\r\n                            ? 'border-blue-500/50 bg-blue-500/10'\r\n                            : slot.status === 'cancelled'\r\n                            ? 'border-red-500/50 bg-red-500/10 opacity-50'\r\n                            : 'border-purple-500/30'\r\n                        }`}\r\n                      >\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center gap-4\">\r\n                            <Clock className=\"w-5 h-5 text-purple-400\" />\r\n                            <div>\r\n                              <div className=\"font-semibold\">\r\n                                {formatTime12h(slot.shift_start_time)} - {formatTime12h(slot.shift_end_time)}\r\n                              </div>\r\n                              <div className=\"text-sm text-gray-400 capitalize\">\r\n                                Status: {slot.status}\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex items-center gap-2\">\r\n                            {isAdmin && (\r\n                              <div className=\"px-3 py-1 bg-purple-500/20 text-purple-400 rounded-lg text-xs border border-purple-500/30\">\r\n                                Admin Access\r\n                              </div>\r\n                            )}\r\n                            {slot.status === 'scheduled' && canClockIn && (\r\n                              <button\r\n                                onClick={() => handleClockIn(slot.id)}\r\n                                disabled={loading || blockedSlots.some(b => b.id === slot.id)}\r\n                                className=\"px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2\"\r\n                              >\r\n                                <CheckCircle className=\"w-4 h-4\" />\r\n                                Clock In\r\n                              </button>\r\n                            )}\r\n                            {blockedSlots.some(b => b.id === slot.id) && (\r\n                              <div className=\"flex items-center gap-2 text-red-400 text-sm\">\r\n                                <AlertCircle className=\"w-4 h-4\" />\r\n                                Blocked\r\n                              </div>\r\n                            )}\r\n                            {(slot.status === 'active' || (slot as any).has_active_log) && canClockOut && (\r\n                              <>\r\n                                <button\r\n                                  onClick={() => handleClockOut(slot.id)}\r\n                                  disabled={loading}\r\n                                  className=\"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2\"\r\n                                >\r\n                                  <XCircle className=\"w-4 h-4\" />\r\n                                  Clock Out\r\n                                </button>\r\n                                <div className=\"flex items-center gap-2 text-green-400 text-sm\">\r\n                                  <AlertCircle className=\"w-4 h-4\" />\r\n                                  Active\r\n                                </div>\r\n                              </>\r\n                            )}\r\n                            {slot.status === 'scheduled' && (\r\n                              <button\r\n                                onClick={() => handleDeleteSlot(slot.id, slot.status)}\r\n                                disabled={loading}\r\n                                className=\"px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                                title=\"Delete shift slot\"\r\n                              >\r\n                                <Trash2 className=\"w-4 h-4\" />\r\n                              </button>\r\n                            )}\r\n                            {slot.status === 'completed' && (\r\n                              <div className=\"flex items-center gap-3\">\r\n                                {slot.coins_earned && (\r\n                                  <div className=\"text-sm text-gray-300\">\r\n                                    <span className=\"text-yellow-400 font-semibold\">\r\n                                      {slot.coins_earned.toLocaleString()}\r\n                                    </span>{' '}\r\n                                    free coins earned\r\n                                  </div>\r\n                                )}\r\n                                {slot.shift_log_id && !slot.cashed_out && (\r\n                                  <button\r\n                                    onClick={() => handleCashout(slot.shift_log_id!)}\r\n                                    disabled={loading}\r\n                                    className=\"px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2\"\r\n                                    title=\"Cash out: 6,000 troll_coins = $60\"\r\n                                  >\r\n                                    <DollarSign className=\"w-4 h-4\" />\r\n                                    Cash Out\r\n                                  </button>\r\n                                )}\r\n                                {slot.cashed_out && (\r\n                                  <div className=\"flex items-center gap-2 text-green-400 text-sm\">\r\n                                    <CheckCircle className=\"w-4 h-4\" />\r\n                                    Cashed Out\r\n                                  </div>\r\n                                )}\r\n                                {!slot.shift_log_id && (\r\n                                  <div className=\"flex items-center gap-2 text-blue-400 text-sm\">\r\n                                    <CheckCircle className=\"w-4 h-4\" />\r\n                                    Completed\r\n                                  </div>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\OfficerVote.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PasswordReset.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PastorApplication.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BookOpen' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BookOpen"},"fix":{"range":[167,176],"text":""},"desc":"Remove unused variable \"BookOpen\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"User"},"fix":{"range":[158,203],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\nimport { useAuthStore } from '../lib/store'\nimport { supabase } from '../lib/supabase'\nimport { toast } from 'sonner'\nimport { BookOpen, User } from 'lucide-react'\n\nexport default function PastorApplication() {\n  const { profile } = useAuthStore()\n  const [formData, setFormData] = useState({\n    fullName: '',\n    email: '',\n    phone: '',\n    denomination: '',\n    experience: '',\n    motivation: '',\n    availability: '',\n    sermonSample: '',\n    references: ''\n  })\n  const [loading, setLoading] = useState(false)\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\n    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }))\n  }\n\n  const submit = async (e?: React.FormEvent) => {\n    e?.preventDefault()\n    if (!profile) return toast.error('Please sign in')\n    \n    const requiredFields = ['fullName', 'email', 'denomination', 'experience', 'motivation', 'availability']\n    const missingFields = requiredFields.filter(field => !formData[field as keyof typeof formData].trim())\n    \n    if (missingFields.length > 0) {\n      return toast.error('Please complete all required fields')\n    }\n\n    try {\n      setLoading(true)\n      \n      const applicationData = {\n        user_id: profile.id,\n        type: 'pastor',\n        reason: formData.motivation,\n        goals: formData.availability,\n        data: {\n          username: profile.username,\n          fullName: formData.fullName,\n          email: formData.email,\n          phone: formData.phone,\n          denomination: formData.denomination,\n          experience: formData.experience,\n          motivation: formData.motivation,\n          availability: formData.availability,\n          sermonSample: formData.sermonSample,\n          references: formData.references\n        },\n        status: 'pending'\n      }\n      \n      const { error } = await supabase.from('applications').insert([applicationData])\n      \n      if (error) {\n        console.error('[Pastor App] Submission error:', error)\n        toast.error(error.message || 'Failed to submit application')\n        throw error\n      }\n      \n      toast.success('Application submitted successfully! We will review your application shortly.')\n      setFormData({\n        fullName: '',\n        email: '',\n        phone: '',\n        denomination: '',\n        experience: '',\n        motivation: '',\n        availability: '',\n        sermonSample: '',\n        references: ''\n      })\n    } catch (err) {\n      console.error('Submit error:', err)\n      toast.error('Failed to submit application')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-8\">\n        <div className=\"max-w-4xl mx-auto\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-purple-400 via-indigo-400 to-cyan-400 bg-clip-text text-transparent mb-2\">\n            Pastor Application\n          </h1>\n          <p className=\"text-[#E2E2E2]/60\">Position: Troll Church Pastor</p>\n        </div>\n\n        <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C] mb-6\">\n          <h2 className=\"text-xl font-semibold text-purple-400 mb-3\">Position Overview</h2>\n          <p className=\"text-[#E2E2E2]/80 mb-3\">\n            As a Pastor of Troll Church, you will lead daily reflections, host Sunday services, and provide spiritual (or troll-ritual) guidance to the community.\n          </p>\n          <div className=\"space-y-2 text-sm text-[#E2E2E2]/70\">\n            <h3 className=\"font-semibold text-white\">Responsibilities:</h3>\n            <ul className=\"list-disc list-inside space-y-1 ml-2\">\n              <li>Prepare and post daily passages (optional/automated)</li>\n              <li>Host live Sunday Services (1 PM - 3 PM)</li>\n              <li>Engage with prayer requests and community members</li>\n              <li>Maintain a welcoming and respectful environment in the Church</li>\n            </ul>\n          </div>\n        </div>\n\n        <form onSubmit={submit} className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C] space-y-6\">\n          {/* Personal Information */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-indigo-400 border-b border-[#2C2C2C] pb-2\">Personal Information</h3>\n            \n            <div>\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                Full Name <span className=\"text-red-400\">*</span>\n              </label>\n              <input\n                type=\"text\"\n                name=\"fullName\"\n                value={formData.fullName}\n                onChange={handleChange}\n                placeholder=\"First and Last Name\"\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                  Email Address <span className=\"text-red-400\">*</span>\n                </label>\n                <input\n                  type=\"email\"\n                  name=\"email\"\n                  value={formData.email}\n                  onChange={handleChange}\n                  placeholder=\"your.email@example.com\"\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                  Phone Number <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\n                </label>\n                <input\n                  type=\"tel\"\n                  name=\"phone\"\n                  value={formData.phone}\n                  onChange={handleChange}\n                  placeholder=\"+1 (555) 123-4567\"\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Ministry Details */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-indigo-400 border-b border-[#2C2C2C] pb-2\">Ministry Details</h3>\n            \n            <div>\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                Denomination / Faith Background <span className=\"text-red-400\">*</span>\n              </label>\n              <input\n                type=\"text\"\n                name=\"denomination\"\n                value={formData.denomination}\n                onChange={handleChange}\n                placeholder=\"e.g., Non-denominational, Catholic, Troll-Spiritualist\"\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                Experience / Background <span className=\"text-red-400\">*</span>\n              </label>\n              <textarea\n                name=\"experience\"\n                value={formData.experience}\n                onChange={handleChange}\n                placeholder=\"Briefly describe your experience with leading groups, public speaking, or ministry...\"\n                rows={4}\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none resize-none\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                Motivation <span className=\"text-red-400\">*</span>\n              </label>\n              <textarea\n                name=\"motivation\"\n                value={formData.motivation}\n                onChange={handleChange}\n                placeholder=\"Why do you want to be a Pastor in Troll City?\"\n                rows={4}\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none resize-none\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                Sermon Sample (Optional)\n              </label>\n              <textarea\n                name=\"sermonSample\"\n                value={formData.sermonSample}\n                onChange={handleChange}\n                placeholder=\"Write a short sample sermon or message you might share...\"\n                rows={4}\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none resize-none\"\n              />\n            </div>\n          </div>\n\n          {/* Availability */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-indigo-400 border-b border-[#2C2C2C] pb-2\">Availability</h3>\n            \n            <div>\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\n                Sunday Availability <span className=\"text-red-400\">*</span>\n              </label>\n              <input\n                type=\"text\"\n                name=\"availability\"\n                value={formData.availability}\n                onChange={handleChange}\n                placeholder=\"Are you available Sundays 1 PM - 3 PM?\"\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-400 focus:outline-none\"\n              />\n            </div>\n          </div>\n\n          <button\n            type=\"submit\"\n            disabled={loading}\n            className=\"w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-bold text-lg hover:shadow-lg hover:shadow-purple-600/30 disabled:opacity-50 disabled:cursor-not-allowed transition-all\"\n          >\n            {loading ? 'Submitting Application...' : 'Submit Application'}\n          </button>\n        </form>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PaymentCallback.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":103,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4103,4221],"text":"\r\n              If you were charged but didn&apos;t receive coins, please contact support with your order ID.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4103,4221],"text":"\r\n              If you were charged but didn&lsquo;t receive coins, please contact support with your order ID.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4103,4221],"text":"\r\n              If you were charged but didn&#39;t receive coins, please contact support with your order ID.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4103,4221],"text":"\r\n              If you were charged but didn&rsquo;t receive coins, please contact support with your order ID.\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { useLocation, useNavigate } from 'react-router-dom'\r\nimport { toast } from 'sonner'\r\n\r\nconst PaymentCallback = () => {\r\n  const { user } = useAuthStore()\r\n  const location = useLocation()\r\n  const navigate = useNavigate()\r\n  \r\n  const [status, setStatus] = useState<'processing' | 'success' | 'error'>('processing')\r\n  const [message, setMessage] = useState('Processing payment...')\r\n  const [coinsAwarded] = useState<number | null>(null)\r\n\r\n  useEffect(() => {\r\n    const processPayment = async () => {\r\n      if (!user) {\r\n        toast.error('Please sign in')\r\n        navigate('/auth')\r\n        return\r\n      }\r\n\r\n      const params = new URLSearchParams(location.search)\r\n      const canceled = params.get('canceled')\r\n      const success = params.get('success')\r\n\r\n      if (canceled) {\r\n        setStatus('error')\r\n        setMessage('Payment was cancelled.')\r\n        toast.info('Payment cancelled')\r\n        return\r\n      }\r\n\r\n      if (success) {\r\n        setStatus('success')\r\n        setMessage('Payment successful. Your wallet will update shortly.')\r\n        return\r\n      }\r\n\r\n      setStatus('processing')\r\n      setMessage('Waiting for payment confirmation...')\r\n    }\r\n\r\n    processPayment()\r\n  }, [location.search, navigate, user])\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n      <div className=\"bg-[#1A1A1A] rounded-lg p-8 border border-[#2C2C2C] w-full max-w-md text-center shadow-xl\">\r\n        {status === 'processing' && (\r\n          <>\r\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4\"></div>\r\n            <h1 className=\"text-2xl font-bold mb-4\">Processing Payment</h1>\r\n            <p className=\"text-[#E2E2E2]/80 mb-6\">{message}</p>\r\n            <p className=\"text-sm text-gray-500\">Please wait...</p>\r\n          </>\r\n        )}\r\n\r\n        {status === 'success' && (\r\n          <>\r\n            <div className=\"text-6xl mb-4\">‚úÖ</div>\r\n            <h1 className=\"text-2xl font-bold mb-4 text-green-400\">Payment Successful!</h1>\r\n            <p className=\"text-[#E2E2E2]/80 mb-4\">{message}</p>\r\n            {coinsAwarded && (\r\n              <div className=\"bg-purple-900/30 border border-purple-600/50 rounded-lg p-4 mb-6\">\r\n                <p className=\"text-sm text-gray-400\">Coins Added</p>\r\n                <p className=\"text-3xl font-bold text-purple-400\">{coinsAwarded.toLocaleString()}</p>\r\n              </div>\r\n            )}\r\n            <button\r\n              onClick={() => navigate('/store')}\r\n              className=\"w-full py-2 bg-gradient-to-r from-[#7C3AED] to-[#A78BFA] text-white font-semibold rounded hover:shadow-lg transition\"\r\n            >\r\n              Continue Shopping\r\n            </button>\r\n            <button\r\n              onClick={() => navigate('/profile')}\r\n              className=\"w-full py-2 mt-3 bg-[#23232b] border border-gray-600 text-white font-semibold rounded hover:bg-[#23232b]/80 transition\"\r\n            >\r\n              Go to Profile\r\n            </button>\r\n          </>\r\n        )}\r\n\r\n        {status === 'error' && (\r\n          <>\r\n            <div className=\"text-6xl mb-4\">‚ùå</div>\r\n            <h1 className=\"text-2xl font-bold mb-4 text-red-400\">Payment Issue</h1>\r\n            <p className=\"text-[#E2E2E2]/80 mb-6\">{message}</p>\r\n            <button\r\n              onClick={() => navigate('/store')}\r\n              className=\"w-full py-2 bg-gradient-to-r from-[#7C3AED] to-[#A78BFA] text-white font-semibold rounded hover:shadow-lg transition\"\r\n            >\r\n              Try Again\r\n            </button>\r\n            <button\r\n              onClick={() => navigate('/profile')}\r\n              className=\"w-full py-2 mt-3 bg-[#23232b] border border-gray-600 text-white font-semibold rounded hover:bg-[#23232b]/80 transition\"\r\n            >\r\n              Go to Profile\r\n            </button>\r\n            <p className=\"text-xs text-gray-500 mt-4\">\r\n              If you were charged but didn't receive coins, please contact support with your order ID.\r\n            </p>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default PaymentCallback\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PaymentSettings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PaymentTerms.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PayoutRequest.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PayoutSetupPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PayoutStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PolicyCenter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PrivacyPolicy.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Profile.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[16,28],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ownedCar' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":317,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":317,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useState, useRef } from 'react';\r\nimport { useParams, useNavigate, useInRouterContext } from 'react-router-dom';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuthStore } from '../lib/store';\r\nimport CreditScoreBadge from '../components/CreditScoreBadge';\r\nimport BadgesGrid from '../components/badges/BadgesGrid';\r\nimport { UserBadge } from '../components/UserBadge';\r\nimport { useCreditScore } from '../lib/hooks/useCreditScore';\r\nimport { useProfileViewPayment } from '../hooks/useProfileViewPayment';\r\nimport { getLevelName } from '../lib/xp';\r\nimport { ENTRANCE_EFFECTS_MAP } from '../lib/entranceEffects';\r\nimport { Loader2, MessageCircle, UserPlus, Settings, MapPin, Link as LinkIcon, Calendar, Package, Shield, Zap, Phone, Coins, Mail, Bell, BellOff, LogOut, ChevronDown, Car, RefreshCw, Home, Mars, Venus, Trash2, CheckCircle, CreditCard, FileText } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { deductCoins } from '@/lib/coinTransactions';\r\nimport { PERK_CONFIG } from '@/lib/perkSystem';\r\nimport { canMessageAdmin } from '@/lib/perkEffects';\r\nimport { cars } from '../data/vehicles';\r\nimport TMVTab from '../components/tmv/TMVTab';\r\nimport ProfileFeed from '../components/profile/ProfileFeed';\r\n\r\nfunction ProfileInner() {\r\n  const { username, userId } = useParams();\r\n  const navigate = useNavigate();\r\n  const { user: currentUser, refreshProfile } = useAuthStore();\r\n  \r\n  const [profile, setProfile] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [isProfileLive, setIsProfileLive] = useState(false);\r\n  const [activeTab, setActiveTab] = useState('social');\r\n  const [followersCount, setFollowersCount] = useState(0);\r\n  const [followingCount, setFollowingCount] = useState(0);\r\n  const [inventory, setInventory] = useState<{\n    perks: any[], \n    effects: any[], \n    insurance: any[], \n    callMinutes: any, \n    homeListings: any[], \n    vehicleListings: any[],\n    vehicles: any[]\n  }>({\n    perks: [], \n    effects: [], \n    insurance: [], \n    callMinutes: null, \n    homeListings: [], \n    vehicleListings: [],\n    vehicles: []\n  });\n  const [showInsuranceCard, setShowInsuranceCard] = useState<any | null>(null);\r\n  const [earnings, setEarnings] = useState<any[]>([]);\r\n  const [earningsLoading, setEarningsLoading] = useState(false);\r\n  const viewerRole = useAuthStore.getState().profile?.troll_role || useAuthStore.getState().profile?.role || 'user';\r\n  const [postsCount, setPostsCount] = useState(0);\r\n  const [announcementsEnabled, setAnnouncementsEnabled] = useState(true);\r\n  const [bannerNotificationsEnabled, setBannerNotificationsEnabled] = useState(true);\r\n  const [savingPreferences, setSavingPreferences] = useState(false);\r\n  const [isTabDropdownOpen, setIsTabDropdownOpen] = useState(false);\r\n  const tabDropdownRef = useRef<HTMLDivElement | null>(null);\r\n  const { data: creditData, loading: creditLoading } = useCreditScore(profile?.id);\r\n\r\n  // Profile Costs State\r\n  const [messageCost, setMessageCost] = useState(0);\r\n  const [viewCost, setViewCost] = useState(0);\r\n\r\n  // Profile View Cost Logic\r\n  const { checking: paymentChecking, canView } = useProfileViewPayment({\r\n    profileOwnerId: profile?.id,\r\n    profileViewPrice: profile?.profile_view_cost || 0,\r\n    onPaymentComplete: () => {\r\n      refreshProfile();\r\n    }\r\n  });\r\n\r\n  const handleUpdateCosts = async () => {\r\n    if (!currentUser || currentUser.id !== profile.id) return;\r\n    \r\n    try {\r\n      setSavingPreferences(true);\r\n      const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({\r\n          message_cost: messageCost,\r\n          profile_view_cost: viewCost\r\n        })\r\n        .eq('id', currentUser.id);\r\n\r\n      if (error) throw error;\r\n      \r\n      toast.success('Profile costs updated successfully');\r\n      \r\n      // Update local profile state\r\n      setProfile((prev: any) => ({\r\n        ...prev,\r\n        message_cost: messageCost,\r\n        profile_view_cost: viewCost\r\n      }));\r\n    } catch (error) {\r\n      console.error('Error updating costs:', error);\r\n      toast.error('Failed to update profile costs');\r\n    } finally {\r\n      setSavingPreferences(false);\r\n    }\r\n  };\r\n\r\n  const handleClearCacheReload = () => {\r\n    try {\r\n      if (currentUser?.id) {\r\n        const keysToRemove = [\r\n          `tc-profile-${currentUser.id}`,\r\n          `trollcity_car_${currentUser.id}`,\r\n          `trollcity_owned_vehicles_${currentUser.id}`,\r\n          `trollcity_car_insurance_${currentUser.id}`,\r\n          `trollcity_vehicle_condition_${currentUser.id}`,\r\n          `trollcity_home_owned_${currentUser.id}`\r\n        ];\r\n\r\n        keysToRemove.forEach((key) => localStorage.removeItem(key));\r\n      }\r\n\r\n      localStorage.removeItem('pwa-installed');\r\n      sessionStorage.clear();\r\n    } catch {}\r\n\r\n    window.location.reload();\r\n  };\r\n\r\n  const handleDeleteAccount = async () => {\r\n    if (!currentUser) return;\r\n    \r\n    if (!window.confirm('Are you sure you want to PERMANENTLY delete your account? This action cannot be undone and you will lose all progress, coins, and items.')) {\r\n      return;\r\n    }\r\n\r\n    // Double confirmation\r\n    const confirmUsername = window.prompt(`Please type your username \"${currentUser.username}\" to confirm deletion:`);\r\n    if (confirmUsername !== currentUser.username) {\r\n      toast.error('Username does not match. Deletion cancelled.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setLoading(true);\r\n      \r\n      const { error } = await supabase.rpc('delete_own_account');\r\n      \r\n      if (error) throw error;\r\n      \r\n      toast.success('Account deleted successfully');\r\n      \r\n      // Cleanup local state\r\n      handleClearCacheReload(); // This clears storage and reloads, but we should redirect\r\n      navigate('/auth');\r\n      \r\n    } catch (e: any) {\r\n      console.error('Delete account error:', e);\r\n      toast.error(e?.message || 'Failed to delete account');\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSetEntranceEffect = async (effectId: string | null) => {\n    if (!currentUser || currentUser.id !== profile.id) return;\n    \n    try {\n      const { error } = await supabase\n        .from('user_profiles')\n        .update({ active_entrance_effect: effectId })\n        .eq('id', currentUser.id);\n\n      if (error) throw error;\n\n      // Update local profile state\n      setProfile((prev: any) => ({\n        ...prev,\n        active_entrance_effect: effectId\n      }));\n\n      if (effectId) {\n         const effectName = ENTRANCE_EFFECTS_MAP[effectId]?.name || 'Effect';\n         toast.success(`Equipped ${effectName}`);\n      } else {\n         toast.success('Entrance effect unequipped');\n      }\n\n    } catch (e: any) {\n      console.error('Error setting entrance effect:', e);\n      toast.error('Failed to update entrance effect');\n    }\n  };\n\n  const fetchInventory = async (uid: string) => {\r\n    // setInventoryLoading(true);\r\n    try {\r\n      const results = await Promise.all([\r\n        supabase.from('user_perks').select('*').eq('user_id', uid).order('created_at', { ascending: false }),\r\n        supabase.from('user_entrance_effects').select('*').eq('user_id', uid),\r\n        supabase.from('user_insurances').select('*').eq('user_id', uid).order('created_at', { ascending: false }),\r\n        supabase.from('call_minutes').select('*').eq('user_id', uid).single(),\r\n        supabase.from('properties').select('*').eq('owner_user_id', uid).eq('is_listed', true).order('created_at', { ascending: false }),\r\n        supabase.from('vehicle_listings').select('*').eq('seller_id', uid).eq('status', 'active').order('created_at', { ascending: false }),\r\n        supabase.from('user_cars').select('*').eq('user_id', uid).order('purchased_at', { ascending: false }),\r\n        supabase.from('user_vehicles').select('*').eq('user_id', uid),\r\n        supabase.from('user_inventory').select('*, marketplace_item:marketplace_items(*)').eq('user_id', uid)\r\n      ]);\r\n\r\n      const perksRes = results[0];\r\n      const effectsRes = results[1];\r\n      const insuranceUserRes = results[2];\r\n      const callRes = results[3];\r\n      const homesRes = results[4];\r\n      const vehicleListingsRes = results[5];\r\n      const vehiclesRes = results[6];\r\n      const legacyVehiclesRes = results[7];\r\n      const titlesDeedsRes = results[8];\r\n\r\n      let insuranceList = insuranceUserRes.data || [];\r\n\r\n      // Client-side join to insurance_plans for names\r\n      try {\r\n        const planIds = (insuranceList || []).map((p: any) => p.insurance_id).filter(Boolean);\r\n        if (planIds.length > 0) {\r\n          const { data: plans } = await supabase\r\n            .from('insurance_plans')\r\n            .select('id,name,description')\r\n            .in('id', Array.from(new Set(planIds)));\r\n          const planMap = new Map<string, any>();\r\n          (plans || []).forEach((pl: any) => planMap.set(pl.id, pl));\r\n          insuranceList = (insuranceList || []).map((row: any) => {\r\n            const plan = planMap.get(row.insurance_id);\r\n            return {\r\n              ...row,\r\n              metadata: {\r\n                ...(row.metadata || {}),\r\n                plan_name: plan?.name,\r\n                plan_description: plan?.description\r\n              }\r\n            }\r\n          });\r\n        }\r\n      } catch {}\r\n\r\n      // Map legacy vehicles to common structure\r\n      const legacyVehicles = (legacyVehiclesRes.data || []).map((v: any) => ({\r\n        id: v.id,\r\n        car_id: v.vehicle_id,\r\n        is_active: v.is_equipped,\r\n        purchased_at: v.created_at || new Date().toISOString(),\r\n        customization_json: { car_model_id: Number(v.vehicle_id) },\r\n        insurance_expiry: null,\r\n        is_legacy: true\r\n      }));\r\n\r\n      setInventory({\r\n        perks: perksRes.data || [],\r\n        effects: effectsRes.data || [],\r\n        insurance: insuranceList || [],\r\n        callMinutes: callRes.data || null,\r\n        homeListings: homesRes.data || [],\r\n        vehicleListings: vehicleListingsRes.data || [],\r\n        vehicles: [...(vehiclesRes.data || []), ...legacyVehicles],\r\n        titlesAndDeeds: titlesDeedsRes.data || []\r\n      });\r\n    } catch (e) {\r\n      console.error('Error fetching inventory', e);\r\n    } finally {\r\n      // setInventoryLoading(false);\r\n    }\r\n  };\r\n\r\n  const fetchEarnings = async (uid: string) => {\r\n    setEarningsLoading(true);\r\n    try {\r\n      const { data } = await supabase\r\n        .from('coin_transactions')\r\n        .select('*')\r\n        .eq('user_id', uid)\r\n        .gt('amount', 0)\r\n        .in('type', ['gift_received', 'reward', 'purchase', 'admin_grant'])\r\n        .order('created_at', { ascending: false })\r\n        .limit(50);\r\n      setEarnings(data || []);\r\n    } catch (e) {\r\n      console.error('Error fetching earnings', e);\r\n    } finally {\r\n      setEarningsLoading(false);\r\n    }\r\n  };\r\n\r\n  const [purchases, setPurchases] = useState<any[]>([]);\r\n  const [purchasesLoading, setPurchasesLoading] = useState(false);\r\n\r\n  const fetchPurchases = async (uid: string) => {\r\n    setPurchasesLoading(true);\r\n    try {\r\n      const { data } = await supabase\r\n        .from('coin_transactions')\r\n        .select('*')\r\n        .eq('user_id', uid)\r\n        .lt('amount', 0) // Spent\r\n        .order('created_at', { ascending: false })\r\n        .limit(50);\r\n      setPurchases(data || []);\r\n    } catch (e) {\r\n      console.error('Error fetching purchases', e);\r\n    } finally {\r\n      setPurchasesLoading(false);\r\n    }\r\n  };\r\n\r\n  // Move const declarations before useEffects that use them\r\n  const isOwnProfile = currentUser?.id === profile?.id;\r\n  const canSeeFullProfile = isOwnProfile;\r\n  const isAdminViewer =\r\n    viewerRole === 'admin' ||\r\n    viewerRole === 'troll_officer' ||\r\n    viewerRole === 'lead_troll_officer';\r\n  const [ownedCar, setOwnedCar] = useState<any | null>(null);\r\n  const tabOptions = [\r\n    { key: 'social', label: 'Social', show: true },\r\n    { key: 'inventory', label: 'Inventory & Perks', show: canSeeFullProfile },\r\n    { key: 'tmv', label: 'TMV Dashboard', show: canSeeFullProfile },\r\n    { key: 'earnings', label: 'Earnings', show: canSeeFullProfile },\r\n    { key: 'purchases', label: 'Purchase History', show: canSeeFullProfile },\r\n    { key: 'admin_titles', label: 'Admin Titles', show: canSeeFullProfile && isAdminViewer },\r\n    { key: 'settings', label: 'Settings', show: isOwnProfile },\r\n  ];\r\n  const activeTabLabel = tabOptions.find((option) => option.key === activeTab)?.label || 'Posts';\r\n\r\n  useEffect(() => {\r\n    if (!isOwnProfile) return;\r\n    if (activeTab === 'earnings' && profile?.id) {\r\n      fetchEarnings(profile.id);\r\n    }\r\n    if (activeTab === 'purchases' && profile?.id) {\r\n      fetchPurchases(profile.id);\r\n    }\r\n  }, [activeTab, profile?.id, isOwnProfile]);\r\n\r\n  useEffect(() => {\r\n    if (profile?.active_vehicle) {\r\n      const car = cars.find(c => c.id === profile.active_vehicle);\r\n      setOwnedCar(car || null);\r\n    } else {\r\n      setOwnedCar(null);\r\n    }\r\n  }, [profile]);\r\n\r\n  const handleRepurchasePerk = async (perk: any) => {\r\n    if (!currentUser || currentUser.id !== profile.id) return;\r\n    \r\n    const config = PERK_CONFIG[perk.perk_id as keyof typeof PERK_CONFIG];\r\n    if (!config) {\r\n        toast.error(\"Perk configuration not found\");\r\n        return;\r\n    }\r\n\r\n    if ((profile.troll_coins || 0) < config.cost) {\r\n        toast.error(`Insufficient coins. Need ${config.cost.toLocaleString()}`);\r\n        return;\r\n    }\r\n\r\n    const { error: deductError } = await deductCoins({\r\n        userId: currentUser.id,\r\n        amount: config.cost,\r\n        type: 'perk_purchase',\r\n        metadata: { perk_id: perk.perk_id, perk_name: config.name },\r\n        supabaseClient: supabase\r\n    });\r\n\r\n    if (deductError) {\r\n        toast.error(\"Transaction failed\");\r\n        return;\r\n    }\r\n\r\n    const expiresAt = new Date();\r\n    expiresAt.setMinutes(expiresAt.getMinutes() + config.duration_minutes);\r\n\r\n    const { error } = await supabase.from('user_perks').insert({\r\n        user_id: currentUser.id,\r\n        perk_id: perk.perk_id,\r\n        metadata: { perk_name: config.name, description: config.description },\r\n        expires_at: expiresAt.toISOString(),\r\n        is_active: true\r\n    });\r\n\r\n    if (error) {\r\n        toast.error('Failed to repurchase perk');\r\n        return;\r\n    }\r\n\r\n    if (perk.perk_id === 'perk_rgb_username') {\r\n        await supabase.from('user_profiles').update({ rgb_username_expires_at: expiresAt.toISOString() }).eq('id', currentUser.id);\r\n        await refreshProfile();\r\n    }\r\n\r\n    toast.success('Perk repurchased successfully!');\r\n    fetchInventory(currentUser.id);\r\n  };\r\n\r\n  const togglePerk = async (perkId: string, isActive: boolean) => {\r\n      if (!currentUser || currentUser.id !== profile.id) return;\r\n      const { error } = await supabase.from('user_perks').update({ is_active: !isActive }).eq('id', perkId);\r\n      if (error) {\r\n          toast.error('Failed to update perk');\r\n          return;\r\n      }\r\n\r\n      const perk = inventory.perks.find(p => p.id === perkId);\r\n      if (perk && perk.perk_id === 'perk_rgb_username') {\r\n          if (!isActive) {\r\n              await supabase.from('user_profiles').update({ rgb_username_expires_at: perk.expires_at }).eq('id', currentUser.id);\r\n          } else {\r\n              await supabase.from('user_profiles').update({ rgb_username_expires_at: null }).eq('id', currentUser.id);\r\n          }\r\n          await refreshProfile();\r\n      }\r\n\r\n      toast.success(`Perk ${isActive ? 'deactivated' : 'activated'}`);\r\n      fetchInventory(currentUser.id);\r\n  };\r\n\r\n  const [isFollowing, setIsFollowing] = useState(false);\r\n\r\n  useEffect(() => {\r\n    // Auto-scroll to top on page load\r\n    window.scrollTo(0, 0);\r\n\r\n    const fetchProfile = async () => {\r\n      setLoading(true);\r\n      \r\n      // Clear any cached profile data for fresh load\r\n      if (currentUser?.id && userId === currentUser.id) {\r\n        try {\r\n          localStorage.removeItem(`tc-profile-${currentUser.id}`);\r\n        } catch {}\r\n      }\r\n      \r\n      let query = supabase.from('user_profiles').select('*');\r\n      \r\n      if (userId) {\r\n        query = query.eq('id', userId);\r\n      } else if (username) {\r\n        query = query.eq('username', username);\r\n      } else {\r\n         setLoading(false);\r\n         return;\r\n      }\r\n\r\n      const { data, error } = await query.maybeSingle();\r\n      \r\n      if (error || !data) {\r\n        console.error('Profile not found', error);\r\n      } else {\r\n        console.log('Loaded profile data:', data); // Debug log\r\n        console.log('Gender:', data.gender); // Debug log\r\n        console.log('Banner URL:', data.banner_url); // Debug log\r\n        console.log('Updated at:', data.updated_at); // Debug log\r\n        \r\n        // If banner_url exists, test if it's accessible\r\n        if (data.banner_url) {\r\n          console.log('Full banner URL with cache bust:', `${data.banner_url}${data.banner_url.includes('?') ? '&' : '?'}cb=${data.updated_at || Date.now()}`)\r\n        }\r\n        \r\n        setProfile(data);\r\n        if (currentUser?.id === data.id) {\r\n          setMessageCost(data.message_cost || 0);\r\n          setViewCost(data.profile_view_cost || 0);\r\n          fetchInventory(data.id);\r\n        } else {\r\n          setInventory({ perks: [], effects: [], insurance: [], callMinutes: null, homeListings: [], vehicleListings: [], vehicles: [], titlesAndDeeds: [] });\r\n          setEarnings([]);\r\n          setPurchases([]);\r\n        }\r\n        \r\n        // Fetch follower/following counts\r\n        const { count: followers } = await supabase\r\n          .from('user_follows')\r\n          .select('*', { count: 'exact', head: true })\r\n          .eq('following_id', data.id);\r\n        \r\n        const { count: following } = await supabase\r\n          .from('user_follows')\r\n          .select('*', { count: 'exact', head: true })\r\n          .eq('follower_id', data.id);\r\n\r\n        const { count: postsC } = await supabase\r\n          .from('troll_posts')\r\n          .select('*', { count: 'exact', head: true })\r\n          .eq('user_id', data.id);\r\n          \r\n        setFollowersCount(followers || 0);\r\n        setFollowingCount(following || 0);\r\n        setPostsCount(postsC || 0);\r\n      }\r\n      setLoading(false);\r\n    };\r\n\r\n    fetchProfile();\r\n    \r\n    // Set up real-time subscription for profile updates\r\n    if (userId || username) {\r\n      const channel = supabase\r\n        .channel(`profile-updates-${userId || username}`)\r\n        .on(\r\n          'postgres_changes',\r\n          {\r\n            event: 'UPDATE',\r\n            schema: 'public',\r\n            table: 'user_profiles',\r\n            filter: userId ? `id=eq.${userId}` : `username=eq.${username}`\r\n          },\r\n          (payload) => {\r\n            console.log('Profile updated in real-time:', payload.new)\r\n            // Refetch profile to get latest data\r\n            fetchProfile()\r\n          }\r\n        )\r\n        .subscribe()\r\n      \r\n      return () => {\r\n        supabase.removeChannel(channel)\r\n      }\r\n    }\r\n  }, [username, userId, currentUser?.id]);\r\n\r\n  // Live status check\r\n  useEffect(() => {\r\n    if (!profile?.id) return;\r\n\r\n    const checkLiveStatus = async () => {\r\n      const { data } = await supabase\r\n        .from('streams')\r\n        .select('id')\r\n        .eq('broadcaster_id', profile.id)\r\n        .eq('is_live', true)\r\n        .maybeSingle();\r\n      \r\n      setIsProfileLive(!!data);\r\n    };\r\n    \r\n    checkLiveStatus();\r\n    \r\n    const channel = supabase\r\n      .channel(`profile-live-${profile.id}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'streams',\r\n          filter: `broadcaster_id=eq.${profile.id}`\r\n        },\r\n        () => checkLiveStatus()\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [profile?.id]);\r\n\r\n  // Check follow status\r\n  useEffect(() => {\r\n    const checkFollowStatus = async () => {\r\n      if (!currentUser || !profile?.id) return;\r\n\r\n      const { data } = await supabase\r\n        .from('user_follows')\r\n        .select('*')\r\n        .eq('follower_id', currentUser.id)\r\n        .eq('following_id', profile.id)\r\n        .maybeSingle();\r\n      \r\n      setIsFollowing(!!data);\r\n    };\r\n\r\n    checkFollowStatus();\r\n  }, [currentUser, profile?.id]);\r\n\r\n  const handleFollow = async () => {\r\n    if (!currentUser) {\r\n      toast.error('Please login to follow users');\r\n      return;\r\n    }\r\n    \r\n    if (isFollowing) {\r\n      await supabase.from('user_follows').delete().match({ follower_id: currentUser.id, following_id: profile.id });\r\n      setIsFollowing(false);\r\n      setFollowersCount(prev => Math.max(0, prev - 1));\r\n      toast.success(`Unfollowed ${profile.username}`);\r\n    } else {\r\n      await supabase.from('user_follows').insert({ follower_id: currentUser.id, following_id: profile.id });\r\n      setIsFollowing(true);\r\n      setFollowersCount(prev => prev + 1);\r\n      toast.success(`Followed ${profile.username}`);\r\n    }\r\n  };\r\n\r\n  const handleMessage = async () => {\r\n    if (!currentUser) {\r\n      toast.error('Please login to message users');\r\n      return;\r\n    }\r\n\r\n    // If profile is admin, check for perk or follow\r\n    const isAdmin = profile.role === 'admin' || profile.is_admin;\r\n    \r\n    if (isAdmin) {\r\n        // Check if THEY follow ME\r\n        const { data: followedByData } = await supabase\r\n          .from('user_follows')\r\n          .select('*')\r\n          .eq('follower_id', profile.id)\r\n          .eq('following_id', currentUser.id)\r\n          .maybeSingle();\r\n        \r\n        const isFollowedByProfile = !!followedByData;\r\n        const hasPerk = await canMessageAdmin(currentUser.id);\r\n\r\n        if (!isFollowedByProfile && !hasPerk) {\r\n            toast.error(\"You need the 'Message Admin' perk or be followed by the Admin to message them!\");\r\n            return;\r\n        }\r\n    }\r\n    \r\n    navigate(`/tcps?user=${profile.id}`);\r\n  };\r\n\r\n  // Defer early returns to after hooks to satisfy lint rules\r\n\r\n  // Load announcement preferences\r\n  useEffect(() => {\r\n    if (isOwnProfile && profile?.announcements_enabled !== undefined) {\r\n      setAnnouncementsEnabled(profile.announcements_enabled);\r\n    }\r\n    if (isOwnProfile && profile?.banner_notifications_enabled !== undefined) {\r\n      setBannerNotificationsEnabled(profile.banner_notifications_enabled);\r\n    }\r\n  }, [isOwnProfile, profile]);\r\n\r\n  const toggleAnnouncements = async () => {\r\n    if (!currentUser) return;\r\n    setSavingPreferences(true);\r\n    try {\r\n      const newValue = !announcementsEnabled;\r\n      const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({ announcements_enabled: newValue })\r\n        .eq('id', currentUser.id);\r\n      \r\n      if (error) throw error;\r\n      setAnnouncementsEnabled(newValue);\r\n      toast.success(newValue ? 'Announcements enabled' : 'Announcements disabled');\r\n    } catch (e: any) {\r\n      toast.error(e?.message || 'Failed to update preferences');\r\n    } finally {\r\n      setSavingPreferences(false);\r\n    }\r\n  };\r\n\r\n  const toggleBannerNotifications = async () => {\r\n    if (!currentUser) return;\r\n    setSavingPreferences(true);\r\n    try {\r\n      const newValue = !bannerNotificationsEnabled;\r\n      const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({ banner_notifications_enabled: newValue })\r\n        .eq('id', currentUser.id);\r\n      \r\n      if (error) throw error;\r\n      setBannerNotificationsEnabled(newValue);\r\n      toast.success(newValue ? 'Banner notifications enabled' : 'Banner notifications disabled');\r\n    } catch (e: any) {\r\n      toast.error(e?.message || 'Failed to update preferences');\r\n    } finally {\r\n      setSavingPreferences(false);\r\n    }\r\n  };\r\n\r\n  const handleTabSelect = (tabKey: string) => {\r\n    setActiveTab(tabKey);\r\n    setIsTabDropdownOpen(false);\r\n  };\r\n\r\n  useEffect(() => {\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (tabDropdownRef.current && !tabDropdownRef.current.contains(event.target as Node)) {\r\n        setIsTabDropdownOpen(false);\r\n      }\r\n    };\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    return () => document.removeEventListener('mousedown', handleClickOutside);\r\n  }, []);\r\n\r\n  const handleLogout = async () => {\r\n    try {\r\n      const { error } = await supabase.auth.signOut();\r\n      if (error) throw error;\r\n      toast.success('Logged out');\r\n      navigate('/auth');\r\n    } catch (e: any) {\r\n      console.error('Logout error:', e);\r\n      toast.error(e?.message || 'Failed to log out');\r\n    }\r\n  };\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n  if (loading || (profile && !isOwnProfile && (paymentChecking || !canView))) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen bg-[#0A0814]\">\r\n        <Loader2 className=\"w-8 h-8 text-purple-500 animate-spin\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!profile) {\r\n    return (\r\n       <div className=\"min-h-screen bg-[#0A0814] text-white p-8 flex items-center justify-center\">\r\n         <div className=\"text-center\">\r\n           <h2 className=\"text-xl font-bold mb-2\">User not found</h2>\r\n           <p className=\"text-gray-400\">The user you are looking for does not exist.</p>\r\n           <button \r\n             onClick={() => navigate('/')}\r\n             className=\"mt-4 px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700 transition\"\r\n           >\r\n             Go Home\r\n           </button>\r\n         </div>\r\n       </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white pb-20\">\r\n      {/* Banner / Cover Photo */}\r\n      <div className=\"h-48 md:h-64 bg-gradient-to-r from-purple-900 via-indigo-900 to-blue-900 relative overflow-hidden\">\r\n        {profile.banner_url ? (\r\n          <img \r\n            src={`${profile.banner_url}${profile.banner_url.includes('?') ? '&' : '?'}cb=${profile.updated_at || Date.now()}`}\r\n            alt=\"Cover Photo\" \r\n            className=\"w-full h-full object-contain bg-gradient-to-r from-purple-900 via-indigo-900 to-blue-900\"\r\n            style={{ objectFit: 'contain', objectPosition: 'center' }}\r\n            onError={(e) => {\r\n              console.error('Failed to load cover photo:', profile.banner_url)\r\n              e.currentTarget.style.display = 'none'\r\n            }}\r\n          />\r\n        ) : (\r\n          <div className=\"w-full h-full flex items-center justify-center text-white/20 text-sm\">\r\n            No cover photo\r\n          </div>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Profile Info */}\r\n      <div className=\"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative\">\r\n        <div className=\"-mt-16 mb-4 flex flex-col md:flex-row md:items-end md:justify-between gap-4\">\r\n           <div className=\"flex items-end relative\">\r\n             <img\r\n               src={profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username}`}\r\n               alt={profile.username}\r\n               className={`w-32 h-32 rounded-full border-4 border-[#0A0814] bg-[#0A0814] object-cover ${isProfileLive ? 'cursor-pointer hover:opacity-90 transition-opacity' : ''}`}\r\n               onError={(e) => {\r\n                 e.currentTarget.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username}`\r\n               }}\r\n               onClick={() => {\r\n                 if (isProfileLive) {\r\n                   navigate(`/live/${profile.id}`);\r\n                 }\r\n               }}\r\n             />\r\n             {isProfileLive && (\r\n               <div className=\"absolute bottom-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full border-2 border-[#0A0814]\">\r\n                 LIVE\r\n               </div>\r\n             )}\r\n           </div>\r\n           \r\n           {/* Actions */}\r\n           <div className=\"flex gap-2 mt-4 md:mt-0 mb-2\">\r\n              {isOwnProfile ? (\r\n                <button \r\n                  onClick={() => navigate('/profile/setup')}\r\n                  className=\"px-4 py-2 bg-[#1A1A24] border border-gray-700 rounded-lg hover:bg-[#2A2A35] transition flex items-center gap-2\"\r\n                >\r\n                  <Settings size={18} />\r\n                  <span>Edit Profile</span>\r\n                </button>\r\n              ) : (\r\n                <>\r\n                  <button \r\n                    onClick={handleFollow}\r\n                    className={`px-4 py-2 rounded-lg transition flex items-center gap-2 font-medium ${isFollowing ? 'bg-gray-700 hover:bg-gray-600' : 'bg-purple-600 hover:bg-purple-700'}`}\r\n                  >\r\n                    <UserPlus size={18} />\r\n                    <span>{isFollowing ? 'Following' : 'Follow'}</span>\r\n                  </button>\r\n                  <button \r\n                    onClick={handleMessage}\r\n                    className=\"px-4 py-2 bg-[#1A1A24] border border-gray-700 rounded-lg hover:bg-[#2A2A35] transition flex items-center gap-2\"\r\n                  >\r\n                    <MessageCircle size={18} />\r\n                    <span>Message</span>\r\n                  </button>\r\n                </>\r\n              )}\r\n           </div>\r\n        </div>\r\n        \r\n        <div className=\"mt-2\">\r\n          <h1 className={`text-2xl font-bold flex items-center gap-2 ${profile.rgb_username_expires_at && new Date(profile.rgb_username_expires_at) > new Date() ? 'rgb-username' : ''}`}>\r\n            {profile.display_name || profile.username}\r\n            {(profile as any).gender === 'male' && (\r\n              <Mars className=\"text-blue-400\" size={16} />\r\n            )}\r\n\r\n            {(profile as any).gender === 'female' && (\r\n              <Venus className=\"text-pink-400\" size={16} />\r\n            )}\r\n\r\n            {profile.is_verified && (\r\n              <span className=\"bg-blue-500 text-white text-[10px] px-1.5 py-0.5 rounded-full\" title=\"Verified\">‚úì</span>\r\n            )}\r\n\r\n            <UserBadge profile={profile} />\r\n\r\n            {isOwnProfile && (\r\n              <button\r\n                onClick={handleClearCacheReload}\r\n                className=\"ml-1 p-1 rounded-md bg-white/10 hover:bg-white/20 text-gray-300\"\r\n                aria-label=\"Clear cache and reload\"\r\n                title=\"Clear cache and reload\"\r\n              >\r\n                <RefreshCw size={12} />\r\n              </button>\r\n            )}\r\n          </h1>\r\n          <p className={`text-gray-400 ${profile.rgb_username_expires_at && new Date(profile.rgb_username_expires_at) > new Date() ? 'rgb-username font-bold' : ''}`}>@{profile.username}</p>\r\n          {profile.level !== undefined && (\r\n            <p className=\"text-sm text-purple-400 font-semibold mt-1\">\r\n              Level {profile.level} ¬∑ {getLevelName(profile.level)}\r\n            </p>\r\n          )}\r\n        </div>\r\n        \r\n        <div className=\"mt-4 flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\r\n          <div className=\"max-w-2xl prose prose-invert prose-sm\">\r\n            <p>{profile.bio || \"No bio provided.\"}</p>\r\n          </div>\r\n          <div className=\"w-full max-w-sm md:max-w-xs\">\r\n            <CreditScoreBadge\r\n              score={creditData?.score}\r\n              tier={creditData?.tier}\r\n              trend7d={creditData?.trend_7d}\r\n              loading={creditLoading}\r\n            />\r\n          </div>\r\n        </div>\r\n        \r\n        <div className=\"flex flex-wrap gap-4 mt-4 text-sm text-gray-400\">\r\n          {profile.location && (\r\n            <div className=\"flex items-center gap-1\">\r\n              <MapPin size={14} />\r\n              <span>{profile.location}</span>\r\n            </div>\r\n          )}\r\n          {profile.website && (\r\n            <div className=\"flex items-center gap-1\">\r\n              <LinkIcon size={14} />\r\n              <a href={profile.website} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-purple-400 hover:underline\">\r\n                {profile.website}\r\n              </a>\r\n            </div>\r\n          )}\r\n          {canSeeFullProfile && profile.email && (\r\n            <div className=\"flex items-center gap-1 text-yellow-400/80\">\r\n              <Mail size={14} />\r\n              <span>{profile.email}</span>\r\n            </div>\r\n          )}\r\n          <div className=\"flex items-center gap-1\">\r\n            <Calendar size={14} />\r\n            <span>Joined {new Date(profile.created_at || Date.now()).toLocaleDateString()}</span>\r\n          </div>\r\n          {profile.terms_accepted && (\r\n            <div className=\"flex items-center gap-1 text-green-400\">\r\n              <FileText size={14} />\r\n              <span>Agreement Accepted</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Stats */}\r\n        <div className=\"flex gap-6 mt-6 border-b border-gray-800 pb-4 text-sm\">\r\n           <div className=\"flex gap-1 cursor-pointer hover:text-purple-400 transition\" onClick={() => navigate(`/following/${profile.id}`)}>\r\n             <span className=\"font-bold text-white\">{followingCount}</span>\r\n             <span className=\"text-gray-400\">Following</span>\r\n           </div>\r\n           <div className=\"flex gap-1 cursor-pointer hover:text-purple-400 transition\" onClick={() => navigate(`/following/${profile.id}`)}>\r\n             <span className=\"font-bold text-white\">{followersCount}</span>\r\n             <span className=\"text-gray-400\">Followers</span>\r\n           </div>\r\n           <div className=\"flex gap-1\">\r\n             <span className=\"font-bold text-white\">{postsCount}</span>\r\n             <span className=\"text-gray-400\">Posts</span>\r\n           </div>\r\n        </div>\r\n        \r\n        {/* Tabs */}\r\n        {tabOptions.filter(o => o.show).length > 1 && (\r\n        <div className=\"relative mt-6\" ref={tabDropdownRef}>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setIsTabDropdownOpen((prev) => !prev)}\r\n            className=\"w-full max-w-xs flex items-center justify-between px-4 py-2 bg-[#0f0f15] border border-gray-800 rounded-2xl text-sm font-medium text-white hover:border-purple-500 transition-colors\"\r\n          >\r\n            <span>{activeTabLabel}</span>\r\n            <ChevronDown size={16} className={`text-gray-400 transition-transform ${isTabDropdownOpen ? 'rotate-180' : ''}`} />\r\n          </button>\r\n          {isTabDropdownOpen && (\r\n            <div className=\"absolute left-0 right-0 mt-2 max-w-xs bg-[#05050a] border border-gray-800 rounded-2xl shadow-lg z-20 overflow-hidden\">\r\n              {tabOptions.filter((option) => option.show).map((option) => (\r\n                <button\r\n                  key={option.key}\r\n                  type=\"button\"\r\n                  onClick={() => handleTabSelect(option.key)}\r\n                  className={`w-full text-left px-4 py-3 text-sm transition-colors ${activeTab === option.key ? 'text-purple-400 font-semibold bg-white/5' : 'text-gray-300 hover:text-white hover:bg-white/5'}`}\r\n                >\r\n                  {option.label}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n        )}\r\n\r\n        <div className=\"mt-6\">\r\n           {activeTab === 'social' && (\r\n             <div className=\"space-y-6\">\r\n               \r\n               {/* Badges Toggle */}\r\n               <div className=\"flex justify-end mb-2\">\r\n                 <details className=\"relative group\">\r\n                   <summary className=\"list-none cursor-pointer px-4 py-2 bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 rounded-xl text-sm font-medium text-white flex items-center gap-2 transition-colors\">\r\n                     <Shield className=\"w-4 h-4 text-yellow-400\"/>\r\n                     View Badges\r\n                     <ChevronDown size={16} className=\"text-gray-400 group-open:rotate-180 transition-transform\"/>\r\n                   </summary>\r\n                   <div className=\"absolute right-0 top-full mt-2 w-[90vw] md:w-[600px] bg-[#0A0814] border border-zinc-700 rounded-xl shadow-2xl z-50 p-6 max-h-[60vh] overflow-y-auto backdrop-blur-sm\">\n                       <BadgesGrid userId={profile.id} showViewAllLink={false} />\n                    </div>\r\n                 </details>\r\n               </div>\r\n\r\n               <ProfileFeed userId={profile.id} />\r\n             </div>\r\n           )}\r\n\r\n          {activeTab === 'inventory' && (\r\n            <div className=\"space-y-8\">\r\n               {/* Perks */}\r\n               <div>\r\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\"><Zap className=\"w-5 h-5 text-yellow-400\"/> Active Perks</h3>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    {inventory.perks.map(perk => {\r\n                      const isExpired = new Date(perk.expires_at) < new Date();\r\n                      const config = PERK_CONFIG[perk.perk_id as keyof typeof PERK_CONFIG];\r\n                      return (\r\n                        <div key={perk.id} className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800\">\r\n                          <div className=\"flex justify-between items-start mb-2\">\r\n                             <h4 className=\"font-bold text-white\">{config?.name || perk.metadata?.perk_name || 'Unknown Perk'}</h4>\r\n                             <span className={`px-2 py-0.5 rounded text-xs ${isExpired ? 'bg-red-900 text-red-200' : perk.is_active ? 'bg-green-900 text-green-200' : 'bg-gray-800 text-gray-400'}`}>\r\n                               {isExpired ? 'EXPIRED' : perk.is_active ? 'ACTIVE' : 'INACTIVE'}\r\n                             </span>\r\n                          </div>\r\n                          <p className=\"text-sm text-gray-400 mb-3\">{config?.description || perk.metadata?.description}</p>\r\n                          <p className=\"text-sm text-gray-400 mb-3\">Expires: {new Date(perk.expires_at).toLocaleString()}</p>\r\n                          <div className=\"flex gap-2\">\r\n                            {!isExpired && isOwnProfile && (\r\n                              <button onClick={() => togglePerk(perk.id, perk.is_active)} className=\"px-3 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-xs\">\r\n                                {perk.is_active ? 'Deactivate' : 'Activate'}\r\n                              </button>\r\n                            )}\r\n                            {(isExpired || !perk.is_active) && isOwnProfile && (\r\n                              <button onClick={() => handleRepurchasePerk(perk)} className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs flex items-center gap-1\">\r\n                                <Coins size={12}/> Repurchase\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      )\r\n                    })}\r\n                    {inventory.perks.length === 0 && <p className=\"text-gray-500 text-sm\">No perks found.</p>}\r\n                  </div>\r\n               </div>\r\n\r\n               {/* Titles & Deeds */}\n               <div>\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\"><FileText className=\"w-5 h-5 text-yellow-500\"/> Titles & Deeds</h3>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {inventory.titlesAndDeeds.map((item: any) => (\n                      <div key={item.id} className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800 flex items-start gap-4\">\n                         <div className=\"bg-zinc-800 p-2 rounded-lg\">\n                           {item.marketplace_item.image_url ? (\n                             <img src={item.marketplace_item.image_url} alt={item.marketplace_item.title} className=\"w-10 h-10 object-cover rounded\" />\n                           ) : (\n                             <FileText className=\"w-8 h-8 text-gray-400\" />\n                           )}\n                         </div>\n                         <div>\n                           <h4 className=\"font-bold text-white\">{item.marketplace_item.title}</h4>\n                           <p className=\"text-sm text-gray-400\">{item.marketplace_item.description}</p>\n                           <span className={`text-[10px] px-2 py-0.5 rounded uppercase mt-2 inline-block ${item.marketplace_item.type === 'title' ? 'bg-yellow-900/30 text-yellow-400 border border-yellow-500/30' : 'bg-blue-900/30 text-blue-400 border border-blue-500/30'}`}>\n                             {item.marketplace_item.type}\n                           </span>\n                         </div>\n                      </div>\n                    ))}\n                    {inventory.titlesAndDeeds.length === 0 && <p className=\"text-gray-500 text-sm\">No titles or deeds found.</p>}\n                  </div>\n               </div>\n\n               {/* Call Minutes */}\r\n               <div>\r\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\"><Phone className=\"w-5 h-5 text-green-400\"/> Call Minutes</h3>\r\n                  <div className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800\">\r\n                     <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                           <p className=\"text-gray-400 text-sm\">Audio Minutes</p>\r\n                           <p className=\"text-2xl font-bold text-white\">{inventory.callMinutes?.audio_minutes || 0}</p>\r\n                        </div>\r\n                        <div>\r\n                           <p className=\"text-gray-400 text-sm\">Video Minutes</p>\r\n                           <p className=\"text-2xl font-bold text-white\">{inventory.callMinutes?.video_minutes || 0}</p>\r\n                        </div>\r\n                     </div>\r\n                  </div>\r\n               </div>\r\n\r\n               {/* Effects */}\r\n               <div>\r\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\"><Package className=\"w-5 h-5 text-blue-400\"/> Entrance Effects</h3>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    {inventory.effects.map(effect => {\r\n                       const effectData = ENTRANCE_EFFECTS_MAP[effect.effect_id] || {};\r\n                       const isActive = profile.active_entrance_effect === effect.effect_id;\r\n                       \r\n                       return (\r\n                         <div key={effect.id} className={`bg-zinc-900 p-4 rounded-xl border ${isActive ? 'border-blue-500 bg-blue-500/10' : 'border-zinc-800'} flex justify-between items-center`}>\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <span className=\"text-2xl\">{effectData.icon || '‚ú®'}</span>\r\n                              <div className=\"flex flex-col\">\r\n                                <span className=\"font-medium text-white\">{effectData.name || effect.effect_id}</span>\r\n                                {effectData.description && <span className=\"text-xs text-gray-400\">{effectData.description}</span>}\r\n                              </div>\r\n                            </div>\r\n                            \r\n                            <div className=\"flex flex-col items-end gap-2\">\r\n                                <span className={`text-xs px-2 py-1 rounded ${isActive ? 'bg-green-500 text-white' : 'bg-blue-900 text-blue-200'}`}>\r\n                                    {isActive ? 'ACTIVE' : 'OWNED'}\r\n                                </span>\r\n                                \r\n                                {isOwnProfile && (\r\n                                    <button\r\n                                        onClick={() => handleSetEntranceEffect(isActive ? null : effect.effect_id)}\r\n                                        className={`px-3 py-1 text-xs rounded transition ${\r\n                                            isActive \r\n                                            ? 'bg-red-500/20 text-red-300 hover:bg-red-500/30' \r\n                                            : 'bg-white/10 text-white hover:bg-white/20'\r\n                                        }`}\r\n                                    >\r\n                                        {isActive ? 'Unequip' : 'Equip'}\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                         </div>\r\n                       );\r\n                    })}\r\n                    {inventory.effects.length === 0 && <p className=\"text-gray-500 text-sm\">No effects found.</p>}\r\n                  </div>\r\n               </div>\r\n               \r\n              {/* Insurance */}\r\n              <div>\r\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\"><Shield className=\"w-5 h-5 text-green-400\"/> Troll Protection</h3>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    {inventory.insurance.map(plan => (\r\n                       <div key={plan.id} className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800\">\r\n                          <h4 className=\"font-bold\">{plan.metadata?.package_name || plan.metadata?.insurance_name || plan.metadata?.plan_name || 'Protection Plan'}</h4>\r\n                          <p className=\"text-sm text-gray-400\">Expires: {new Date(plan.expires_at).toLocaleString()}</p>\r\n                       </div>\r\n                    ))}\r\n                    {inventory.insurance.length === 0 && <p className=\"text-gray-500 text-sm\">No protection plans active.</p>}\r\n               </div>\r\n             </div>\r\n\r\n              <div>\r\n                <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n                  <Car className=\"w-5 h-5 text-red-400\" />\r\n                  Vehicles\r\n                </h3>\r\n                <div className=\"space-y-4\">\r\n                  {inventory.vehicles.length > 0 ? (\r\n                    inventory.vehicles.map((v: any) => {\r\n                      // Resolve car details\r\n                      // user_cars.car_id might be a string (legacy) or uuid.\r\n                      // If it's a number string \"1\", we can match it.\r\n                      // If it's a UUID, we might need to rely on customization_json.car_model_id or similar, \r\n                      // OR look it up in the catalog (which we don't have loaded here).\r\n                      // BUT, the dealership page logic suggests customization_json.car_model_id is a fallback for numeric ID.\r\n                      \r\n                      let carConfig = null;\r\n                      if (v.customization_json?.car_model_id) {\r\n                         carConfig = cars.find(c => c.id === v.customization_json.car_model_id);\r\n                      } else if (!isNaN(Number(v.car_id))) {\r\n                         carConfig = cars.find(c => c.id === Number(v.car_id));\r\n                      }\r\n\r\n                      // If we still can't find it (maybe legacy data), try to match by name if stored? No name stored on user_cars.\r\n                      // Fallback:\r\n                      const displayName = carConfig?.name || `Vehicle #${v.car_id.slice(0,8)}`;\r\n                      const displayImage = carConfig?.image || null;\r\n                      const displayTier = carConfig?.tier || null;\r\n\r\n                      const isInsured = v.insurance_expiry && new Date(v.insurance_expiry) > new Date();\r\n                      const isActive = String(profile.active_vehicle) === String(v.id) || \r\n                                       String(profile.active_vehicle) === String(v.car_id) || \r\n                                       (carConfig && String(profile.active_vehicle) === String(carConfig.id));\r\n\r\n                      return (\r\n                        <div key={v.id} className={`bg-zinc-900 p-4 rounded-xl border ${isActive ? 'border-emerald-500/50 bg-emerald-900/10' : 'border-zinc-800'} flex flex-col md:flex-row md:items-center justify-between gap-4`}>\r\n                           <div className=\"flex items-center gap-4\">\r\n                             <div className=\"w-24 h-14 flex-shrink-0 flex items-center justify-center bg-zinc-950 rounded-lg border border-zinc-700 overflow-hidden p-1 relative\">\r\n                                {displayImage ? (\r\n                                  <img \r\n                                    src={displayImage} \r\n                                    alt={displayName} \r\n                                    className=\"w-full h-full object-contain\" \r\n                                  />\r\n                                ) : (\r\n                                  <Car className=\"text-zinc-600\" />\r\n                                )}\r\n                                {isActive && (\r\n                                  <div className=\"absolute top-0 right-0 p-1 bg-emerald-500 rounded-bl-lg\">\r\n                                    <CheckCircle size={10} className=\"text-white\" />\r\n                                  </div>\r\n                                )}\r\n                             </div>\r\n                             <div>\r\n                               <div className=\"flex items-center gap-2\">\r\n                                 <p className=\"font-bold text-white\">{displayName}</p>\r\n                                 {isActive && <span className=\"text-[10px] bg-emerald-500/20 text-emerald-400 px-1.5 py-0.5 rounded border border-emerald-500/30\">EQUIPPED</span>}\r\n                               </div>\r\n                               {displayTier && <p className=\"text-xs text-gray-400\">{displayTier} Class</p>}\r\n                               <div className=\"mt-1 flex items-center gap-2\">\r\n                                  {isInsured ? (\r\n                                    <span className=\"flex items-center gap-1 text-xs text-green-400 font-medium bg-green-900/20 px-2 py-0.5 rounded border border-green-500/20\">\r\n                                      <Shield size={10} /> Insured\r\n                                    </span>\r\n                                  ) : (\r\n                                    <span className=\"text-xs text-zinc-500 flex items-center gap-1\">\r\n                                      <Shield size={10} /> No Insurance\r\n                                    </span>\r\n                                  )}\r\n                               </div>\r\n                             </div>\r\n                           </div>\r\n                           \r\n                           <div className=\"flex items-center gap-2 mt-2 md:mt-0\">\r\n                              {isInsured && (\r\n                                <button\r\n                                  onClick={() => setShowInsuranceCard({\r\n                                    user: profile,\r\n                                    vehicle: v,\r\n                                    config: carConfig\r\n                                  })}\r\n                                  className=\"px-3 py-1.5 bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 border border-blue-500/30 rounded-lg text-xs font-medium flex items-center gap-1 transition-colors\"\r\n                                >\r\n                                  <CreditCard size={14} /> View Card\r\n                                </button>\r\n                              )}\r\n                              {isOwnProfile && (\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => navigate('/dealership')}\r\n                                  className=\"px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg text-xs font-medium transition-colors\"\r\n                                >\r\n                                  Manage\r\n                                </button>\r\n                              )}\r\n                           </div>\r\n                        </div>\r\n                      );\r\n                    })\r\n                  ) : (\r\n                    <div className=\"bg-zinc-900 p-8 rounded-xl border border-zinc-800 text-center\">\r\n                      <Car className=\"w-12 h-12 text-zinc-700 mx-auto mb-3\" />\r\n                      <p className=\"text-gray-400 mb-4\">No vehicles found in garage.</p>\r\n                      {isOwnProfile && (\r\n                         <button\r\n                           onClick={() => navigate('/dealership')}\r\n                           className=\"px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium\"\r\n                         >\r\n                           Visit Dealership\r\n                         </button>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {inventory.homeListings && inventory.homeListings.length > 0 && (\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n                    <Home className=\"w-5 h-5 text-emerald-400\" />\r\n                    Homes For Sale\r\n                  </h3>\r\n                  <div className=\"space-y-3\">\r\n                    {inventory.homeListings.map((home: any) => (\r\n                      <div\r\n                        key={home.id}\r\n                        className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800 flex items-center justify-between gap-4\"\r\n                      >\r\n                        <div>\r\n                          <p className=\"text-sm font-semibold text-white\">\r\n                            Home {String(home.id).slice(0, 6).toUpperCase()}\r\n                            {home.is_starter ? ' ‚Ä¢ Starter' : ''}\r\n                          </p>\r\n                          {home.ask_price && (\r\n                            <p className=\"text-xs text-gray-400\">\r\n                              Listed for {Number(home.ask_price).toLocaleString()} TrollCoins\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                        {isOwnProfile && (\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => navigate('/trollstown')}\r\n                            className=\"px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-medium\"\r\n                          >\r\n                            Manage In Troll Town\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {inventory.vehicleListings && inventory.vehicleListings.length > 0 && (\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n                    <Car className=\"w-5 h-5 text-purple-400\" />\r\n                    Vehicle Listings\r\n                  </h3>\r\n                  <div className=\"space-y-3\">\r\n                    {inventory.vehicleListings.map((listing: any) => {\r\n                      const vehicle = cars.find(c => c.id === listing.vehicle_id);\r\n                      const name =\r\n                        listing.metadata?.vehicle_name ||\r\n                        vehicle?.name ||\r\n                        `Vehicle #${listing.vehicle_id}`;\r\n                      const tier =\r\n                        listing.metadata?.tier ||\r\n                        (vehicle as any)?.tier;\r\n                      return (\r\n                        <div\r\n                          key={listing.id}\r\n                          className=\"bg-zinc-900 p-4 rounded-xl border border-zinc-800 flex items-center justify-between gap-4\"\r\n                        >\r\n                          <div>\r\n                            <p className=\"text-sm font-semibold text-white\">{name}</p>\r\n                            <p className=\"text-xs text-gray-400\">\r\n                              {listing.listing_type === 'auction' ? 'Auction starting at ' : 'Listed for '}\r\n                              {Number(listing.price).toLocaleString()} TrollCoins\r\n                            </p>\r\n                            {tier && (\r\n                              <p className=\"text-xs text-gray-500\">\r\n                                Tier: {tier}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                          <div className=\"flex flex-col items-end gap-1\">\r\n                            <span className=\"text-[10px] uppercase tracking-widest px-2 py-0.5 rounded-full border border-white/10 text-gray-300\">\r\n                              {listing.listing_type === 'auction' ? 'Auction' : 'Sale'}\r\n                            </span>\r\n                            {isOwnProfile && (\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() => navigate(listing.listing_type === 'auction' ? '/auctions' : '/dealership')}\r\n                                className=\"px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-medium\"\r\n                              >\r\n                                Manage Listing\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'tmv' && (\n            <TMVTab profile={profile} isOwnProfile={isOwnProfile} />\n          )}\n\n           {activeTab === 'earnings' && (\r\n             <div className=\"space-y-6\">\r\n                <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800 flex items-center justify-between\">\r\n                   <div>\r\n                      <p className=\"text-gray-400\">Total Earned</p>\r\n                      <h3 className=\"text-3xl font-bold text-yellow-400 flex items-center gap-2\">\r\n                        <Coins className=\"w-6 h-6\"/> {profile.total_earned_coins?.toLocaleString() || 0}\r\n                      </h3>\r\n                   </div>\r\n                   <div className=\"text-right\">\r\n                      <p className=\"text-gray-400\">Current Balance</p>\r\n                      <p className=\"text-xl font-bold text-white\">{profile.troll_coins?.toLocaleString() || 0}</p>\r\n                   </div>\r\n                </div>\r\n\r\n                <div className=\"bg-[#12121A] rounded-xl border border-gray-800 overflow-hidden\">\r\n                   <div className=\"p-4 border-b border-gray-800\">\r\n                      <h4 className=\"font-bold\">Recent Earnings</h4>\r\n                   </div>\r\n                   {earningsLoading ? (\r\n                      <div className=\"p-8 text-center text-gray-500\">Loading...</div>\r\n                   ) : earnings.length > 0 ? (\r\n                      <div className=\"divide-y divide-gray-800\">\r\n                         {earnings.map(tx => (\r\n                            <div key={tx.id} className=\"p-4 flex justify-between items-center\">\r\n                               <div>\r\n                                  <p className=\"font-medium text-white capitalize\">{tx.type.replace('_', ' ')}</p>\r\n                                  <p className=\"text-xs text-gray-500\">{new Date(tx.created_at).toLocaleString()}</p>\r\n                               </div>\r\n                               <span className=\"font-bold text-green-400\">+{tx.amount.toLocaleString()} TC</span>\r\n                            </div>\r\n                         ))}\r\n                      </div>\r\n                   ) : (\r\n                      <div className=\"p-8 text-center text-gray-500\">No recent earnings found.</div>\r\n                   )}\r\n                </div>\r\n             </div>\r\n           )}\r\n\r\n           {activeTab === 'purchases' && (\r\n             <div className=\"space-y-6\">\r\n                <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800 flex items-center justify-between\">\r\n                   <div>\r\n                      <p className=\"text-gray-400\">Total Spent</p>\r\n                      <h3 className=\"text-3xl font-bold text-red-400 flex items-center gap-2\">\r\n                        <Coins className=\"w-6 h-6\"/> {profile.total_spent_coins?.toLocaleString() || 0}\r\n                      </h3>\r\n                   </div>\r\n                   <div className=\"text-right\">\r\n                      <p className=\"text-gray-400\">Current Balance</p>\r\n                      <p className=\"text-xl font-bold text-white\">{profile.troll_coins?.toLocaleString() || 0}</p>\r\n                   </div>\r\n                </div>\r\n\r\n                <div className=\"bg-[#12121A] rounded-xl border border-gray-800 overflow-hidden\">\r\n                   <div className=\"p-4 border-b border-gray-800\">\r\n                      <h4 className=\"font-bold\">Recent Purchases</h4>\r\n                   </div>\r\n                   {purchasesLoading ? (\r\n                      <div className=\"p-8 text-center text-gray-500\">Loading...</div>\r\n                   ) : purchases.length > 0 ? (\r\n                      <div className=\"divide-y divide-gray-800\">\r\n                         {purchases.map(tx => (\r\n                            <div key={tx.id} className=\"p-4 flex justify-between items-center\">\r\n                               <div>\r\n                                  <p className=\"font-medium text-white capitalize\">\r\n                                    {tx.metadata?.perk_name || tx.type.replace('_', ' ')}\r\n                                  </p>\r\n                                  <p className=\"text-xs text-gray-500\">{new Date(tx.created_at).toLocaleString()}</p>\r\n                               </div>\r\n                               <span className=\"font-bold text-red-400\">{tx.amount.toLocaleString()} TC</span>\r\n                            </div>\r\n                         ))}\r\n                      </div>\r\n                   ) : (\r\n                      <div className=\"p-8 text-center text-gray-500\">No recent purchases found.</div>\r\n                   )}\r\n                </div>\r\n             </div>\r\n           )}\r\n\r\n           {activeTab === 'admin_titles' && canSeeFullProfile && isAdminViewer && (\r\n             <div className=\"space-y-6\">\r\n               <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\r\n                 <h3 className=\"text-lg font-bold mb-4\">Admin Titles</h3>\r\n                 <div className=\"space-y-3 text-sm text-gray-300\">\r\n                   <div className=\"flex items-center justify-between\">\r\n                     <span>System role</span>\r\n                     <span className=\"px-3 py-1 rounded-full border border-purple-500/40 bg-purple-500/10 text-xs font-semibold uppercase tracking-wide\">\r\n                       {profile.role || 'user'}\r\n                     </span>\r\n                   </div>\r\n                   <div className=\"flex items-center justify-between\">\r\n                     <span>Troll role</span>\r\n                     <span className=\"px-3 py-1 rounded-full border border-indigo-500/40 bg-indigo-500/10 text-xs font-semibold uppercase tracking-wide\">\r\n                       {profile.troll_role || 'none'}\r\n                     </span>\r\n                   </div>\r\n                   <div className=\"flex items-center justify-between\">\r\n                     <span>Lead officer</span>\r\n                     <span className=\"px-3 py-1 rounded-full border border-emerald-500/40 bg-emerald-500/10 text-xs font-semibold uppercase tracking-wide\">\r\n                       {profile.is_lead_officer ? 'Yes' : 'No'}\r\n                     </span>\r\n                   </div>\r\n                 </div>\r\n               </div>\r\n             </div>\r\n           )}\r\n\r\n           {activeTab === 'settings' && isOwnProfile && (\r\n             <div className=\"space-y-6\">\r\n               <h3 className=\"text-lg font-bold mb-4\">Notification Settings</h3>\r\n\r\n               {/* Profile Costs */}\r\n               <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800 space-y-4\">\r\n                 <div className=\"flex items-center gap-3 mb-2\">\r\n                   <Coins className=\"w-6 h-6 text-yellow-400\" />\r\n                   <div>\r\n                     <h4 className=\"font-medium text-white\">Profile Costs</h4>\r\n                     <p className=\"text-sm text-gray-400\">Set prices for interactions (0 = Free)</p>\r\n                   </div>\r\n                 </div>\r\n                 \r\n                 <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                   <div>\r\n                     <label className=\"block text-xs font-medium text-gray-400 mb-1\">Message Cost (TC)</label>\r\n                     <input \r\n                       type=\"number\" \r\n                       min=\"0\"\r\n                       value={messageCost}\r\n                       onChange={(e) => setMessageCost(Number(e.target.value))}\r\n                       className=\"w-full bg-black/50 border border-zinc-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500\"\r\n                     />\r\n                   </div>\r\n                   <div>\r\n                     <label className=\"block text-xs font-medium text-gray-400 mb-1\">Profile View Cost (TC)</label>\r\n                     <input \r\n                       type=\"number\" \r\n                       min=\"0\"\r\n                       value={viewCost}\r\n                       onChange={(e) => setViewCost(Number(e.target.value))}\r\n                       className=\"w-full bg-black/50 border border-zinc-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500\"\r\n                     />\r\n                   </div>\r\n                 </div>\r\n                 \r\n                 <div className=\"flex justify-end\">\r\n                   <button\r\n                     onClick={handleUpdateCosts}\r\n                     disabled={savingPreferences}\r\n                     className=\"px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-medium text-sm transition-colors disabled:opacity-50\"\r\n                   >\r\n                     {savingPreferences ? 'Saving...' : 'Save Costs'}\r\n                   </button>\r\n                 </div>\r\n               </div>\r\n               \r\n               {/* Announcements Toggle */}\n              <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    {announcementsEnabled ? (\n                      <Bell className=\"w-6 h-6 text-green-400\" />\n                    ) : (\n                      <BellOff className=\"w-6 h-6 text-gray-400\" />\n                    )}\n                    <div>\n                      <h4 className=\"font-medium text-white\">Admin Announcements</h4>\n                      <p className=\"text-sm text-gray-400\">Receive notifications from administrators</p>\n                    </div>\n                  </div>\n                  <button\n                    onClick={toggleAnnouncements}\n                    disabled={savingPreferences}\n                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${\n                      announcementsEnabled ? 'bg-green-500' : 'bg-gray-600'\n                    }`}\n                  >\n                    <span\n                      className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                        announcementsEnabled ? 'translate-x-6' : 'translate-x-1'\n                      }`}\n                    />\n                  </button>\n                </div>\n              </div>\n\n              {/* Banner Notifications Toggle */}\n              <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    {bannerNotificationsEnabled ? (\n                      <Zap className=\"w-6 h-6 text-green-400\" />\n                    ) : (\n                      <Zap className=\"w-6 h-6 text-gray-400\" />\n                    )}\n                    <div>\n                      <h4 className=\"font-medium text-white\">Live Banners</h4>\n                      <p className=\"text-sm text-gray-400\">Receive notifications when pods go live</p>\n                    </div>\n                  </div>\n                  <button\n                    onClick={toggleBannerNotifications}\n                    disabled={savingPreferences}\n                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${\n                      bannerNotificationsEnabled ? 'bg-green-500' : 'bg-gray-600'\n                    }`}\n                  >\n                    <span\n                      className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                        bannerNotificationsEnabled ? 'translate-x-6' : 'translate-x-1'\n                      }`}\n                    />\n                  </button>\n                </div>\n              </div>\r\n             \r\n             <div className=\"bg-zinc-900 p-6 rounded-xl border border-zinc-800\">\r\n               <div className=\"flex items-center justify-between\">\r\n                 <div className=\"flex items-center gap-3\">\r\n                   <LogOut className=\"w-6 h-6 text-red-400\" />\r\n                   <div>\r\n                     <h4 className=\"font-medium text-white\">Log out</h4>\r\n                     <p className=\"text-sm text-gray-400\">Sign out of your account on this device</p>\r\n                   </div>\r\n                 </div>\r\n                 <button\r\n                   onClick={handleLogout}\r\n                   className=\"px-4 py-2 bg-red-600/20 border border-red-500/40 text-red-300 rounded-lg hover:bg-red-600/30 transition\"\r\n                 >\r\n                   Log out\r\n                 </button>\r\n               </div>\r\n             </div>\r\n\r\n             {/* Delete Account */}\r\n             <div className=\"bg-red-950/20 p-6 rounded-xl border border-red-900/50\">\r\n               <div className=\"flex items-center justify-between\">\r\n                 <div className=\"flex items-center gap-3\">\r\n                   <Trash2 className=\"w-6 h-6 text-red-500\" />\r\n                   <div>\r\n                     <h4 className=\"font-medium text-red-200\">Delete Account</h4>\r\n                     <p className=\"text-sm text-red-400/70\">Permanently delete your account and all data</p>\r\n                   </div>\r\n                 </div>\r\n                 <button\r\n                   onClick={handleDeleteAccount}\r\n                   className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition\"\r\n                 >\r\n                   Delete Account\r\n                 </button>\r\n               </div>\r\n             </div>\r\n           </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Insurance Card Modal */}\r\n      {showInsuranceCard && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm\" onClick={() => setShowInsuranceCard(null)}>\r\n          <div className=\"w-full max-w-md bg-[#0f172a] border border-blue-500/30 rounded-2xl overflow-hidden shadow-2xl relative transform transition-all scale-100\" onClick={e => e.stopPropagation()}>\r\n            {/* Header */}\r\n            <div className=\"bg-gradient-to-r from-blue-700 to-blue-600 p-4 flex justify-between items-center shadow-md z-10 relative\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Shield className=\"text-white fill-white/20\" size={24} />\r\n                <h2 className=\"text-lg font-bold text-white uppercase tracking-wider text-shadow-sm\">Troll City Insurance</h2>\r\n              </div>\r\n              <div className=\"w-8 h-8 rounded-full bg-white/20 flex items-center justify-center border border-white/30\">\r\n                 <Shield size={16} className=\"text-white\" />\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Content */}\r\n            <div className=\"p-6 space-y-5 bg-[#0f172a] relative overflow-hidden\">\r\n               <div className=\"absolute inset-0 opacity-5 pointer-events-none\" style={{ backgroundImage: 'radial-gradient(circle at 2px 2px, white 1px, transparent 0)', backgroundSize: '20px 20px' }}></div>\r\n               \r\n               <div className=\"flex justify-between items-start relative z-10\">\r\n                  <div>\r\n                     <p className=\"text-[10px] uppercase text-blue-400 tracking-widest mb-1 font-semibold\">Policy Holder</p>\r\n                     <p className=\"text-xl font-bold text-white tracking-tight\">{showInsuranceCard.user.display_name || showInsuranceCard.user.username}</p>\r\n                     <p className=\"text-xs text-blue-400/80 font-mono mt-0.5\">ID: {showInsuranceCard.user.id.slice(0, 8)}</p>\r\n                  </div>\r\n                  {showInsuranceCard.user.avatar_url ? (\r\n                     <img src={showInsuranceCard.user.avatar_url} className=\"w-16 h-16 rounded-lg border-2 border-blue-500/30 object-cover shadow-lg bg-black\" />\r\n                  ) : (\r\n                     <div className=\"w-16 h-16 rounded-lg border-2 border-blue-500/30 bg-blue-900/20 flex items-center justify-center\">\r\n                        <span className=\"text-2xl\">üë§</span>\r\n                     </div>\r\n                  )}\r\n               </div>\r\n\r\n               <div className=\"grid grid-cols-2 gap-4 relative z-10 bg-blue-900/10 p-3 rounded-xl border border-blue-500/10\">\r\n                   <div>\r\n                      <p className=\"text-[10px] uppercase text-blue-400 tracking-widest mb-1 font-semibold\">Vehicle</p>\r\n                      <p className=\"text-sm font-bold text-white truncate\">{showInsuranceCard.config?.name || 'Unknown Vehicle'}</p>\r\n                      <p className=\"text-xs text-gray-400\">{showInsuranceCard.config?.tier || 'Standard'} Class</p>\r\n                   </div>\r\n                   <div>\r\n                      <p className=\"text-[10px] uppercase text-blue-400 tracking-widest mb-1 font-semibold\">Status</p>\r\n                      <div className=\"inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-500/20 border border-emerald-500/30 rounded-full text-emerald-400 text-xs font-bold uppercase shadow-sm\">\r\n                         <CheckCircle size={10} strokeWidth={3} /> Active\r\n                      </div>\r\n                   </div>\r\n               </div>\r\n               \r\n               <div className=\"border-t border-blue-500/20 pt-4 relative z-10\">\r\n                   <div className=\"flex justify-between items-center\">\r\n                      <div>\r\n                         <p className=\"text-[10px] uppercase text-blue-400 tracking-widest mb-1 font-semibold\">Expires</p>\r\n                         <p className=\"text-sm font-mono text-white font-medium\">\r\n                            {new Date(showInsuranceCard.vehicle.insurance_expiry).toLocaleDateString()}\r\n                         </p>\r\n                         <p className=\"text-[10px] text-gray-500\">\r\n                            {new Date(showInsuranceCard.vehicle.insurance_expiry).toLocaleTimeString()}\r\n                         </p>\r\n                      </div>\r\n                      <div className=\"text-right\">\r\n                         <p className=\"text-[10px] uppercase text-blue-400 tracking-widest mb-1 font-semibold\">Policy ID</p>\r\n                         <p className=\"text-xs font-mono text-gray-500\">\r\n                            {showInsuranceCard.vehicle.id.slice(0, 12)}...\r\n                         </p>\r\n                      </div>\r\n                   </div>\r\n               </div>\r\n            </div>\r\n            \r\n            {/* Footer */}\r\n            <div className=\"bg-[#020617] p-3 text-center border-t border-blue-900/30\">\r\n               <p className=\"text-[10px] text-slate-500 font-medium\">Authorized by Troll City Motor Vehicle Department</p>\r\n               <button \r\n                 className=\"mt-3 w-full py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-sm font-semibold transition-all shadow-lg shadow-blue-900/20\" \r\n                 onClick={() => setShowInsuranceCard(null)}\r\n               >\r\n                 Close Card\r\n               </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function Profile() {\r\n  const inRouter = useInRouterContext();\r\n  if (!inRouter) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white flex items-center justify-center\">\r\n        <div className=\"text-sm text-gray-400\">Profile view is unavailable outside the app router.</div>\r\n      </div>\r\n    );\r\n  }\r\n  return <ProfileInner />;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ProfileSettings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ProfileSetup.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":703,"column":47,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[27130,27230],"text":"\r\n                  Upload Government ID (Driver&apos;s License, Passport, or State ID)\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[27130,27230],"text":"\r\n                  Upload Government ID (Driver&lsquo;s License, Passport, or State ID)\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[27130,27230],"text":"\r\n                  Upload Government ID (Driver&#39;s License, Passport, or State ID)\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[27130,27230],"text":"\r\n                  Upload Government ID (Driver&rsquo;s License, Passport, or State ID)\r\n                "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":805,"column":85,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[32640,32789],"text":"\r\n                      Your account will be reviewed by our team within 24 hours. You&apos;ll receive a notification when verified.\r\n                    "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[32640,32789],"text":"\r\n                      Your account will be reviewed by our team within 24 hours. You&lsquo;ll receive a notification when verified.\r\n                    "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[32640,32789],"text":"\r\n                      Your account will be reviewed by our team within 24 hours. You&#39;ll receive a notification when verified.\r\n                    "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[32640,32789],"text":"\r\n                      Your account will be reviewed by our team within 24 hours. You&rsquo;ll receive a notification when verified.\r\n                    "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { toast } from 'sonner'\r\nimport { useAvatar } from '../lib/hooks/useAvatar'\r\nimport type { AvatarConfig } from '../lib/hooks/useAvatar'\r\nimport { updateUserAvatarConfig } from '../lib/purchases'\r\nimport CropPhotoModal from '../components/CropPhotoModal'\r\nimport { KeyRound } from 'lucide-react'\r\nimport { setResetPin } from '@/services/passwordManager'\r\n\r\nconst ProfileSetup = () => {\r\n  const navigate = useNavigate()\r\n  const { user, profile, setProfile } = useAuthStore()\r\n  const { config: avatarConfig, setConfig: setAvatarConfig } = useAvatar()\r\n\r\n  // Ensure loading is false when component mounts\r\n  React.useEffect(() => {\r\n    const authState = useAuthStore.getState()\r\n    if (authState.isLoading) {\r\n      authState.setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  const suggestedUsername = React.useMemo(() => {\r\n    if (profile?.username) return profile.username\r\n    if (user?.id) {\r\n      // Generate username from user ID instead of email\r\n      return `user${user.id.substring(0, 8)}`\r\n    }\r\n    return ''\r\n  }, [user?.id, profile?.username])\r\n\r\n  const [username, setUsername] = React.useState(profile?.username || suggestedUsername)\r\n  const [fullName, setFullName] = React.useState((profile as any)?.full_name || '')\r\n  const [bio, setBio] = React.useState(profile?.bio || '')\r\n  const [gender, setGender] = React.useState((profile as any)?.gender || '')\r\n  const [messageCost, setMessageCost] = React.useState((profile as any)?.message_cost || 0)\r\n  const [viewCost, setViewCost] = React.useState((profile as any)?.profile_view_cost || 0)\r\n  const [loading, setLoading] = React.useState(false)\r\n  const [uploadingAvatar, setUploadingAvatar] = React.useState(false)\r\n  const [uploadingCover, setUploadingCover] = React.useState(false)\r\n  const [usernameError, setUsernameError] = React.useState('')\r\n  const [bannerUrl, setBannerUrl] = React.useState(profile?.banner_url || '')\r\n  const [avatarUrl, setAvatarUrl] = React.useState(profile?.avatar_url || '')\r\n  const [pin, setPin] = React.useState('')\r\n  const [savingPin, setSavingPin] = React.useState(false)\r\n  const [coverCropModalOpen, setCoverCropModalOpen] = React.useState(false)\r\n  const [coverCropFile, setCoverCropFile] = React.useState<File | null>(null)\r\n\r\n  const handleUsernameChange = (value: string) => {\r\n    // Allow letters, numbers, and underscores\r\n    const valid = value.replace(/[^a-zA-Z0-9_]/g, '')\r\n    setUsername(valid)\r\n    \r\n    if (value !== valid) {\r\n      setUsernameError('Username can only contain letters, numbers, and underscores')\r\n    } else {\r\n      setUsernameError('')\r\n    }\r\n  }\r\n\r\n  React.useEffect(() => {\r\n    if (!username && suggestedUsername) {\r\n      setUsername(suggestedUsername)\r\n    }\r\n  }, [suggestedUsername, username])\r\n\r\n  // Load initial banner and profile picture from profile on mount\r\n  React.useEffect(() => {\r\n    if (profile?.banner_url) {\r\n      console.log('Initial banner URL:', profile.banner_url)\r\n      setBannerUrl(profile.banner_url)\r\n    }\r\n    if (profile?.avatar_url) {\r\n      setAvatarUrl(profile.avatar_url)\r\n    }\r\n    if ((profile as any)?.gender) {\r\n      console.log('Initial gender:', (profile as any).gender)\r\n      setGender((profile as any).gender)\r\n    }\r\n    if ((profile as any)?.full_name) {\r\n      setFullName((profile as any).full_name)\r\n    }\r\n    if (profile?.bio) {\r\n      setBio(profile.bio)\r\n    }\r\n    if ((profile as any)?.message_cost) {\r\n      setMessageCost((profile as any).message_cost)\r\n    }\r\n    if ((profile as any)?.profile_view_cost) {\r\n      setViewCost((profile as any).profile_view_cost)\r\n    }\r\n  }, [profile])\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (loading) return\r\n    if (!user) {\r\n      toast.error('Please sign in')\r\n      return\r\n    }\r\n    const uname = username.trim()\r\n    if (!uname) {\r\n      toast.error('Username is required')\r\n      return\r\n    }\r\n    if (!/^[a-zA-Z0-9_]{2,20}$/.test(uname)) {\r\n      toast.error('Use 2‚Äì20 letters, numbers, or underscores')\r\n      return\r\n    }\r\n    if (!fullName.trim()) {\r\n      toast.error('Full name is required')\r\n      return\r\n    }\r\n    if (!gender) {\r\n      toast.error('Gender is required')\r\n      return\r\n    }\r\n    setLoading(true)\r\n    try {\r\n      if (profile?.username !== uname) {\r\n        const { data: existing } = await supabase\r\n          .from('user_profiles')\r\n          .select('id')\r\n          .eq('username', uname)\r\n          .neq('id', user.id)\r\n          .maybeSingle()\r\n        if (existing) {\r\n          toast.error('Username is taken')\r\n          setLoading(false)\r\n          return\r\n        }\r\n      }\r\n      const now = new Date().toISOString()\r\n      const { data: updatedRows, error } = await supabase\r\n        .from('user_profiles')\r\n        .update({ \r\n          username: uname, \r\n          full_name: fullName.trim(),\r\n          bio: bio || null, \r\n          gender,\r\n          message_cost: messageCost,\r\n          profile_view_cost: viewCost,\r\n          updated_at: now \r\n        })\r\n        .eq('id', user.id)\r\n        .select('*')\r\n      \r\n      if (error) throw error\r\n      \r\n      const updatedProfile = Array.isArray(updatedRows) ? updatedRows[0] : updatedRows\r\n      let nextProfile = updatedProfile as any\r\n\r\n      if (updatedProfile) {\r\n        setProfile(updatedProfile as any)\r\n        try {\r\n          localStorage.setItem(\r\n            `tc-profile-${user.id}`,\r\n            JSON.stringify({ data: updatedProfile, timestamp: Date.now() })\r\n          )\r\n        } catch {}\r\n      } else {\r\n        const { data: fallback } = await supabase\r\n          .from('user_profiles')\r\n          .select('*')\r\n          .eq('id', user.id)\r\n          .maybeSingle()\r\n        if (fallback) {\r\n          nextProfile = fallback as any\r\n          setProfile(fallback as any)\r\n        }\r\n      }\r\n\r\n      // Explicitly refresh the profile in the auth store\r\n      await useAuthStore.getState().refreshProfile?.()\r\n\r\n      toast.success('Profile saved')\r\n\r\n      if (nextProfile && user) {\r\n        const g = (nextProfile as any).gender as string | null\r\n        const isFemale = g === 'female'\r\n        const baseAvatar: AvatarConfig = {\r\n          skinTone: isFemale ? 'light' : 'medium',\r\n          hairStyle: isFemale ? 'long' : 'short',\r\n          hairColor: isFemale ? 'blonde' : 'brown',\r\n          outfit: isFemale ? 'casual' : 'street',\r\n          accessory: 'none',\r\n          useAsProfilePicture: avatarConfig.useAsProfilePicture\r\n        }\r\n\r\n        setAvatarConfig(baseAvatar)\r\n\r\n        await updateUserAvatarConfig(user.id, {\r\n          avatar_config: baseAvatar\r\n        })\r\n      }\r\n\r\n      // Navigate to profile page to see changes\r\n      navigate(`/profile/${nextProfile?.username || uname}`)\r\n    } catch (err: any) {\r\n      console.error('Profile save error:', err)\r\n      toast.error(err?.message || 'Failed to save profile')\r\n    } finally {\r\n      setLoading(false)\r\n      // Ensure store loading state is also reset\r\n      const authState = useAuthStore.getState()\r\n      authState.setLoading(false)\r\n    }\r\n  }\r\n\r\n  const avatarInputRef = React.useRef<HTMLInputElement>(null)\r\n  const coverInputRef = React.useRef<HTMLInputElement>(null)\r\n\r\n  const handleAvatarUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file || !user) return\r\n\r\n    try {\r\n      setUploadingAvatar(true)\r\n      if (!file.type.startsWith('image/')) throw new Error('File must be an image')\r\n      if (file.size > 5 * 1024 * 1024) throw new Error('Image too large (max 5MB)')\r\n      \r\n      const ext = file.name.split('.').pop()\r\n      const name = `${user.id}-${Date.now()}.${ext}`\r\n      const path = `avatars/${name}`\r\n      \r\n      // Try multiple buckets\r\n      const buckets = ['troll-city-assets', 'avatars', 'public']\r\n      let uploadedUrl = null\r\n\r\n      for (const bucket of buckets) {\r\n        try {\r\n          const { error: uploadErr } = await supabase.storage\r\n            .from(bucket)\r\n            .upload(path, file, { cacheControl: '3600', upsert: false })\r\n          \r\n          if (!uploadErr) {\r\n            const { data: urlData } = supabase.storage.from(bucket).getPublicUrl(path)\r\n            uploadedUrl = urlData.publicUrl\r\n            break\r\n          }\r\n        } catch {\r\n          console.log(`Failed to upload to ${bucket}, trying next...`)\r\n        }\r\n      }\r\n\r\n      if (!uploadedUrl) throw new Error('Failed to upload profile picture to any bucket')\r\n\r\n      // Set local avatar URL immediately for instant UI feedback\r\n      setAvatarUrl(uploadedUrl)\r\n\r\n      // Update database\r\n      const { data: updatedRows, error: updateErr } = await supabase\r\n        .from('user_profiles')\r\n        .update({ avatar_url: uploadedUrl, updated_at: new Date().toISOString() })\r\n        .eq('id', user.id)\r\n        .select('*')\r\n      \r\n      if (updateErr) throw updateErr\r\n      const updatedProfile = Array.isArray(updatedRows) ? updatedRows[0] : updatedRows\r\n      if (updatedProfile) {\r\n        setProfile(updatedProfile as any)\r\n        try {\r\n          localStorage.setItem(\r\n            `tc-profile-${user.id}`,\r\n            JSON.stringify({ data: updatedProfile, timestamp: Date.now() })\r\n          )\r\n        } catch (err) {\r\n          console.warn('Failed to update localStorage:', err)\r\n        }\r\n        useAuthStore.getState().refreshProfile?.()\r\n      }\r\n      \r\n      toast.success('Profile picture uploaded successfully')\r\n    } catch (err: any) {\r\n      console.error('Profile picture upload error:', err)\r\n      toast.error(err?.message || 'Failed to upload profile picture')\r\n    } finally {\r\n      setUploadingAvatar(false)\r\n      if (avatarInputRef.current) avatarInputRef.current.value = ''\r\n    }\r\n  }\r\n\r\n  const handleCoverUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file || !user) return\r\n\r\n    try {\r\n      if (!file.type.startsWith('image/')) throw new Error('File must be an image')\r\n      if (file.size > 5 * 1024 * 1024) throw new Error('Image too large (max 5MB)')\r\n\r\n      // Open crop modal instead of uploading directly\r\n      setCoverCropFile(file)\r\n      setCoverCropModalOpen(true)\r\n    } catch (err: any) {\r\n      console.error('Cover upload error:', err)\r\n      toast.error(err?.message || 'Failed to upload cover photo')\r\n    } finally {\r\n      if (coverInputRef.current) coverInputRef.current.value = ''\r\n    }\r\n  }\r\n\r\n  const handleCoverCrop = async (croppedFile: File) => {\r\n    if (!user) return\r\n\r\n    try {\r\n      setUploadingCover(true)\r\n      setCoverCropModalOpen(false)\r\n\r\n      const ext = croppedFile.name.split('.').pop() || 'jpg'\r\n      const name = `${user.id}-${Date.now()}.${ext}`\r\n\r\n      // Try different bucket and path combinations\r\n      const uploadAttempts = [\r\n        { bucket: 'covers', path: name },\r\n        { bucket: 'troll-city-assets', path: `covers/${name}` },\r\n        { bucket: 'avatars', path: name },\r\n        { bucket: 'public', path: name }\r\n      ]\r\n      \r\n      let uploadedUrl: string | null = null\r\n      let lastErr: any = null\r\n\r\n      for (const attempt of uploadAttempts) {\r\n        try {\r\n          console.log(`Trying bucket: ${attempt.bucket}, path: ${attempt.path}`)\r\n          \r\n          const { error: uploadErr } = await supabase.storage\r\n            .from(attempt.bucket)\r\n            .upload(attempt.path, croppedFile, { cacheControl: '3600', upsert: true })\r\n\r\n          if (uploadErr) {\r\n            console.log(`Failed with ${attempt.bucket}:`, uploadErr.message)\r\n            lastErr = uploadErr\r\n            continue\r\n          }\r\n\r\n          const { data: urlData } = supabase.storage.from(attempt.bucket).getPublicUrl(attempt.path)\r\n          if (urlData?.publicUrl) {\r\n            uploadedUrl = urlData.publicUrl\r\n            console.log(`Success with bucket ${attempt.bucket}:`, uploadedUrl)\r\n            break\r\n          }\r\n        } catch (err) {\r\n          console.log(`Error with ${attempt.bucket}:`, err)\r\n          lastErr = err\r\n        }\r\n      }\r\n\r\n      if (!uploadedUrl) {\r\n        throw lastErr || new Error('Failed to upload cover photo (no bucket available)')\r\n      }\r\n\r\n      console.log('Uploaded URL:', uploadedUrl)\r\n      console.log('User ID:', user.id)\r\n\r\n      // Update database with clean URL (without checking profile first to avoid RLS issues)\r\n      const { error: updateErr } = await supabase\r\n        .from('user_profiles')\r\n        .update({ banner_url: uploadedUrl, updated_at: new Date().toISOString() })\r\n        .eq('id', user.id)\r\n\r\n      if (updateErr) {\r\n        console.error('Database update error:', updateErr)\r\n        throw new Error(`Failed to save cover photo: ${updateErr.message}`)\r\n      }\r\n      \r\n      console.log('Banner URL update completed successfully for user:', user.id)\r\n      console.log('Updated banner_url:', uploadedUrl)\r\n      \r\n      // Add cache-busting parameter to force reload\r\n      const cacheBustedUrl = `${uploadedUrl}?t=${Date.now()}`\r\n      \r\n      console.log('Setting banner URL with cache buster:', cacheBustedUrl)\r\n      \r\n      // Set local banner URL with cache-buster for instant UI feedback\r\n      setBannerUrl(cacheBustedUrl)\r\n      \r\n      // Create updated profile object manually since fetch might fail due to RLS\r\n      const updatedProfile = { \r\n        ...profile, \r\n        banner_url: uploadedUrl, \r\n        updated_at: new Date().toISOString() \r\n      }\r\n      \r\n      // Update global store with new profile data\r\n      setProfile(updatedProfile as any)\r\n        \r\n      // Update localStorage cache\r\n      try {\r\n        localStorage.setItem(\r\n          `tc-profile-${user.id}`,\r\n          JSON.stringify({ data: updatedProfile, timestamp: Date.now() })\r\n        )\r\n      } catch (err) {\r\n        console.warn('Failed to update localStorage:', err)\r\n      }\r\n      \r\n      // Refresh the auth store profile\r\n      await useAuthStore.getState().refreshProfile?.()\r\n\r\n      // Force a small delay to ensure state updates\r\n      setTimeout(() => {\r\n        console.log('Current bannerUrl state:', cacheBustedUrl)\r\n      }, 100)\r\n      \r\n      toast.success('Cover photo updated successfully')\r\n    } catch (err: any) {\r\n      console.error('Cover upload error:', err)\r\n      toast.error(err?.message || 'Failed to upload cover photo')\r\n    } finally {\r\n      setUploadingCover(false)\r\n      setCoverCropFile(null)\r\n      if (coverInputRef.current) coverInputRef.current.value = ''\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0f0f17] text-white p-6\">\r\n      {/* Crop Photo Modal */}\r\n      <CropPhotoModal\r\n        isOpen={coverCropModalOpen}\r\n        imageFile={coverCropFile}\r\n        onCrop={handleCoverCrop}\r\n        onCancel={() => {\r\n          setCoverCropModalOpen(false)\r\n          setCoverCropFile(null)\r\n          if (coverInputRef.current) coverInputRef.current.value = ''\r\n        }}\r\n        aspectRatio={16 / 9}\r\n        title=\"Crop Cover Photo\"\r\n      />\r\n\r\n      <div className=\"max-w-2xl mx-auto\">\r\n        {/* Cover Photo */}\r\n        <div className=\"relative h-48 rounded-2xl overflow-hidden mb-6 bg-gradient-to-r from-purple-900 via-indigo-900 to-blue-900\">\r\n          {bannerUrl && bannerUrl.trim() !== '' ? (\r\n            <img\r\n              src={bannerUrl}\r\n              alt=\"Cover\"\r\n              className=\"absolute inset-0 w-full h-full object-contain\"\r\n              style={{ objectFit: 'contain', objectPosition: 'center' }}\r\n              onLoad={() => console.log('Cover loaded:', bannerUrl)}\r\n              onError={(e) => {\r\n                console.error('Cover image load error:', bannerUrl)\r\n                e.currentTarget.style.display = 'none'\r\n              }}\r\n            />\r\n          ) : (\r\n            <div className=\"flex items-center justify-center h-full text-gray-300 text-sm uppercase tracking-[0.4em]\">\r\n              Your cover photo goes here\r\n            </div>\r\n          )}\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => coverInputRef.current?.click()}\r\n            disabled={uploadingCover}\r\n            className=\"absolute top-3 right-3 px-3 py-1 text-xs font-semibold rounded-full bg-black/50 text-white border border-white/20 hover:bg-black/60 transition\"\r\n          >\r\n            {uploadingCover ? 'Uploading...' : 'Change Cover Photo'}\r\n          </button>\r\n          <input\r\n            ref={coverInputRef}\r\n            type=\"file\"\r\n            accept=\"image/*\"\r\n            className=\"hidden\"\r\n            onChange={handleCoverUpload}\r\n          />\r\n        </div>\r\n\r\n        {/* Profile Picture */}\r\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-6\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <img\r\n              src={avatarUrl || `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`}\r\n              alt=\"profile picture\"\r\n              className=\"w-20 h-20 rounded-full border border-[#2C2C2C] object-cover\"\r\n            />\r\n            <div className=\"space-y-1\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => avatarInputRef.current?.click()}\r\n                disabled={uploadingAvatar}\r\n                className=\"px-3 py-1 text-sm font-semibold rounded-md bg-[#7C3AED] text-white hover:bg-[#6B21A8] disabled:opacity-60\"\r\n              >\r\n                {uploadingAvatar ? 'Updating Profile Picture...' : 'Update Profile Picture'}\r\n              </button>\r\n              <p className=\"text-xs text-gray-400\">JPG/PNG up to 5MB.</p>\r\n            </div>\r\n          </div>\r\n          <input\r\n            ref={avatarInputRef}\r\n            type=\"file\"\r\n            accept=\"image/*\"\r\n            className=\"hidden\"\r\n            onChange={handleAvatarUpload}\r\n          />\r\n        </div>\r\n\r\n        {/* Profile Info */}\r\n        <details className=\"bg-[#1A1A1A] rounded-lg border border-[#2C2C2C]\" open>\r\n          <summary className=\"cursor-pointer px-6 py-4 flex items-center justify-between\">\r\n            <span className=\"font-semibold\">Profile Info</span>\r\n            <span className=\"text-sm bg-[#7C3AED] text-white px-3 py-1 rounded\">Edit</span>\r\n          </summary>\r\n\r\n          <div className=\"px-6 pb-6\">\r\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n              <div>\r\n                <label htmlFor=\"fullName\" className=\"block text-sm mb-2\">Full Name (Required)</label>\r\n                <input\r\n                  id=\"fullName\"\r\n                  name=\"fullName\"\r\n                  type=\"text\"\r\n                  value={fullName}\r\n                  onChange={(e) => setFullName(e.target.value)}\r\n                  className=\"w-full px-4 py-2 rounded bg-[#23232b] text-white border border-gray-600 focus:outline-none\"\r\n                  placeholder=\"e.g. John Doe\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label htmlFor=\"username\" className=\"block text-sm mb-2\">Username (letters, numbers, and underscores)</label>\r\n                <input\r\n                  id=\"username\"\r\n                  name=\"username\"\r\n                  type=\"text\"\r\n                  value={username}\r\n                  onChange={(e) => handleUsernameChange(e.target.value)}\r\n                  className=\"w-full px-4 py-2 rounded bg-[#23232b] text-white border border-gray-600 focus:outline-none\"\r\n                />\r\n                {usernameError && (\r\n                  <p className=\"text-red-400 text-xs mt-1\">{usernameError}</p>\r\n                )}\r\n              </div>\r\n\r\n              <div>\r\n                <label htmlFor=\"gender\" className=\"block text-sm mb-2\">Gender</label>\r\n                <select\r\n                  id=\"gender\"\r\n                  name=\"gender\"\r\n                  value={gender}\r\n                  onChange={(e) => setGender(e.target.value)}\r\n                  className=\"w-full px-4 py-2 rounded bg-[#23232b] text-white border border-gray-600 focus:outline-none\"\r\n                  required\r\n                >\r\n                  <option value=\"\">Select gender</option>\r\n                  <option value=\"male\">Male</option>\r\n                  <option value=\"female\">Female</option>\r\n                </select>\r\n              </div>\r\n\r\n              <div>\r\n                <label htmlFor=\"bio\" className=\"block text-sm mb-2\">Bio</label>\r\n                <textarea\r\n                  id=\"bio\"\r\n                  name=\"bio\"\r\n                  value={bio}\r\n                  onChange={(e) => setBio(e.target.value)}\r\n                  className=\"w-full px-4 py-2 rounded bg-[#23232b] text-white border border-gray-600 focus:outline-none\"\r\n                  rows={4}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div>\r\n                  <label className=\"block text-sm mb-2 text-yellow-400\">Message Cost (TC)</label>\r\n                  <input\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    value={messageCost}\r\n                    onChange={(e) => setMessageCost(Number(e.target.value))}\r\n                    className=\"w-full px-4 py-2 rounded bg-[#23232b] text-white border border-gray-600 focus:outline-none\"\r\n                    placeholder=\"0\"\r\n                  />\r\n                  <p className=\"text-xs text-gray-400 mt-1\">Cost for users to message you (0 = Free)</p>\r\n                </div>\r\n                <div>\r\n                  <label className=\"block text-sm mb-2 text-yellow-400\">View Profile Cost (TC)</label>\r\n                  <input\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    value={viewCost}\r\n                    onChange={(e) => setViewCost(Number(e.target.value))}\r\n                    className=\"w-full px-4 py-2 rounded bg-[#23232b] text-white border border-gray-600 focus:outline-none\"\r\n                    placeholder=\"0\"\r\n                  />\r\n                  <p className=\"text-xs text-gray-400 mt-1\">Cost to view your full profile (0 = Free)</p>\r\n                </div>\r\n              </div>\r\n\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"w-full py-2 bg-gradient-to-r from-[#7C3AED] to-[#A78BFA] text-white rounded\"\r\n              >\r\n                {loading ? 'Saving‚Ä¶' : 'Save Profile'}\r\n              </button>\r\n            </form>\r\n          </div>\r\n        </details>\r\n\r\n\r\n\r\n        <details className=\"bg-[#1A1A1A] rounded-lg border border-[#2C2C2C] mt-6\" open>\r\n          <summary className=\"cursor-pointer px-6 py-4 flex items-center justify-between\">\r\n            <span className=\"font-semibold\">Payout Settings</span>\r\n            <span className=\"text-sm bg-[#7C3AED] text-white px-3 py-1 rounded\">PayPal</span>\r\n          </summary>\r\n\r\n          <div className=\"px-6 pb-6 space-y-3\">\r\n            <p className=\"text-sm text-gray-400\">\r\n              Set the PayPal email where you want to receive your Troll City payouts.\r\n            </p>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => navigate('/payouts/setup')}\r\n              className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-sm\"\r\n            >\r\n              Open Payout Settings\r\n            </button>\r\n            <p className=\"text-xs text-gray-500\">\r\n              Payouts are sent only to your PayPal payout email. Make sure it matches your PayPal account.\r\n            </p>\r\n          </div>\r\n        </details>\r\n\r\n        <details className=\"bg-[#1A1A1A] rounded-lg border border-[#2C2C2C] mt-6\">\r\n          <summary className=\"cursor-pointer px-6 py-4 flex items-center justify-between\">\r\n            <span className=\"font-semibold flex items-center gap-2\">\r\n              <KeyRound className=\"w-4 h-4 text-emerald-400\" />\r\n              Password Reset PIN\r\n            </span>\r\n            <span className=\"text-xs text-gray-400\">Optional</span>\r\n          </summary>\r\n\r\n          <div className=\"px-6 pb-6 space-y-3\">\r\n            <p className=\"text-xs text-gray-400\">\r\n              Set a 6-digit PIN you can use later to reset your password.\r\n            </p>\r\n            <div className=\"flex flex-col sm:flex-row sm:items-center gap-3\">\r\n              <input\r\n                inputMode=\"numeric\"\r\n                pattern=\"\\\\d*\"\r\n                maxLength={6}\r\n                value={pin}\r\n                onChange={(e) => {\r\n                  const v = e.target.value.replace(/[^0-9]/g, '').slice(0, 6)\r\n                  setPin(v)\r\n                }}\r\n                placeholder=\"Enter 6-digit PIN\"\r\n                className=\"px-4 py-2 bg-[#23232b] border border-gray-600 rounded-xl text-white w-48 tracking-widest\"\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                disabled={savingPin || pin.length !== 6}\r\n                onClick={async () => {\r\n                  if (pin.length !== 6) {\r\n                    toast.error('PIN must be exactly 6 digits')\r\n                    return\r\n                  }\r\n                  setSavingPin(true)\r\n                  const { error } = await setResetPin(pin)\r\n                  setSavingPin(false)\r\n                  if (error) {\r\n                    toast.error('Failed to save PIN')\r\n                  } else {\r\n                    toast.success('Password reset PIN saved')\r\n                    setPin('')\r\n                  }\r\n                }}\r\n                className=\"px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-semibold disabled:opacity-50\"\r\n              >\r\n                {savingPin ? 'Saving...' : 'Save PIN'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </details>\r\n\r\n\r\n          {/* üÜî ID Verification Section */}\r\n          <details className=\"bg-[#1A1A1A] rounded-lg border border-[#2C2C2C] mt-6\">\r\n            <summary className=\"cursor-pointer px-6 py-4 flex items-center justify-between\">\r\n              <span className=\"font-semibold\">ID Verification (Required for Account Access)</span>\r\n              <span className=\"text-sm bg-red-600 text-white px-3 py-1 rounded\">Required</span>\r\n            </summary>\r\n\r\n            <div className=\"px-6 pb-6 space-y-4\">\r\n              <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4\">\r\n                <h3 className=\"font-semibold text-yellow-300 mb-2\">üìã Important Notice</h3>\r\n                <p className=\"text-sm text-yellow-200 mb-3\">\r\n                  To comply with our safety policies and prevent fraud, all users must upload a valid government-issued ID before gaining full access to Troll City features.\r\n                </p>\r\n                <p className=\"text-sm text-yellow-200\">\r\n                  Your ID will be securely stored and only accessible to administrators for verification purposes.\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"space-y-3\">\r\n                <label className=\"block text-sm text-gray-300 mb-1\">\r\n                  Upload Government ID (Driver's License, Passport, or State ID)\r\n                </label>\r\n                <div className=\"bg-[#23232b] border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-purple-400 transition-colors\">\r\n                  <input\r\n                    type=\"file\"\r\n                    accept=\"image/*,application/pdf\"\r\n                    onChange={async (e) => {\r\n                      const file = e.target.files?.[0]\r\n                      if (!file || !user) return\r\n\r\n                      try {\r\n                        setLoading(true)\r\n                        const fileName = `id-${user.id}-${Date.now()}${file.name.substring(file.name.lastIndexOf('.'))}`\r\n                        const filePath = `verification/${user.id}/${fileName}`\r\n\r\n                        // Upload to Supabase storage\r\n                        const { error: uploadError } = await supabase.storage\r\n                          .from('verification_docs')\r\n                          .upload(filePath, file, { cacheControl: '3600', upsert: false })\r\n\r\n                        if (uploadError) throw uploadError\r\n\r\n                        // Get public URL\r\n                        const { data: urlData } = supabase.storage\r\n                          .from('verification_docs')\r\n                          .getPublicUrl(filePath)\r\n\r\n                        // Update user profile with ID verification info\r\n                        const { data: updated, error: profileError } = await supabase\r\n                          .from('user_profiles')\r\n                          .update({\r\n                            id_document_url: urlData.publicUrl,\r\n                            id_verification_status: 'pending',\r\n                            id_uploaded_at: new Date().toISOString(),\r\n                            updated_at: new Date().toISOString()\r\n                          })\r\n                          .eq('id', user.id)\r\n                          .select('*')\r\n                          .maybeSingle()\r\n\r\n                        if (profileError && profileError.code !== 'PGRST116') throw profileError\r\n                        if (updated) {\r\n                          setProfile(updated as any)\r\n                        } else {\r\n                          const { data: fallback } = await supabase\r\n                            .from('user_profiles')\r\n                            .select('*')\r\n                            .eq('id', user.id)\r\n                            .maybeSingle()\r\n                          if (fallback) {\r\n                            setProfile(fallback as any)\r\n                          }\r\n                        }\r\n                        try {\r\n                          const { error: appError } = await supabase.from('applications').insert({\r\n                            user_id: user.id,\r\n                            type: 'id_verification',\r\n                            status: 'pending',\r\n                            reason: 'ID verification submitted',\r\n                            data: {\r\n                              id_document_url: urlData.publicUrl,\r\n                              verification_status: 'pending'\r\n                            }\r\n                          })\r\n                          if (appError) {\r\n                            console.warn('Failed to insert id_verification application:', appError)\r\n                          }\r\n                        } catch (appErr) {\r\n                          console.warn('Failed to insert id_verification application:', appErr)\r\n                        }\r\n                        toast.success('ID uploaded successfully! Your account will be verified by an admin within 24 hours.')\r\n                      } catch (err: any) {\r\n                        console.error('ID upload error:', err)\r\n                        toast.error(err?.message || 'Failed to upload ID. Please try again.')\r\n                      } finally {\r\n                        setLoading(false)\r\n                      }\r\n                    }}\r\n                    className=\"hidden\"\r\n                    id=\"id-upload\"\r\n                  />\r\n                  <label htmlFor=\"id-upload\" className=\"cursor-pointer\">\r\n                    <div className=\"flex flex-col items-center justify-center gap-2\">\r\n                      <div className=\"w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center\">\r\n                        <span className=\"text-white text-xl\">üìÑ</span>\r\n                      </div>\r\n                      <span className=\"text-purple-400 font-semibold\">Click to Upload ID</span>\r\n                      <span className=\"text-xs text-gray-400\">PDF, JPG, or PNG (max 10MB)</span>\r\n                    </div>\r\n                  </label>\r\n                </div>\r\n\r\n                {(profile as any)?.id_document_url ? (\r\n                  <div className=\"bg-green-900/20 border border-green-500/30 rounded-lg p-3\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <span className=\"text-green-400\">‚úÖ</span>\r\n                      <span className=\"text-sm text-green-300\">ID uploaded successfully!</span>\r\n                    </div>\r\n                    <p className=\"text-xs text-gray-400 mb-2\">\r\n                      Verification Status: <span className=\"font-semibold\">{(profile as any).id_verification_status || 'pending'}</span>\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-400\">\r\n                      Your account will be reviewed by our team within 24 hours. You'll receive a notification when verified.\r\n                    </p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"bg-gray-800/30 rounded-lg p-3\">\r\n                    <p className=\"text-xs text-gray-400 text-center\">\r\n                      No ID uploaded yet. Please upload your government-issued ID to gain full access to Troll City.\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </details>\r\n        \r\n        {/* Fallback button for users who get stuck */}\r\n        <div className=\"mt-8 flex gap-4\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => {\r\n              // Ensure loading is reset\r\n              useAuthStore.getState().setLoading(false)\r\n              navigate('/')\r\n            }}\r\n            className=\"flex-1 py-2 bg-gradient-to-r from-green-600 to-green-500 text-white rounded hover:from-green-700 hover:to-green-600 transition-all\"\r\n          >\r\n            Continue to Home ‚Üí\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default ProfileSetup\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ProfileSetupPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\PublicPool.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":409,"column":85,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15844,15845],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15844,15845],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15844,15845],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15844,15845],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":409,"column":97,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15856,15857],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15856,15857],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15856,15857],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15856,15857],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef, useState } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { Coins, Send, Waves, Trophy, User } from 'lucide-react'\r\nimport ClickableUsername from '../components/ClickableUsername'\r\n\r\ntype Donation = {\r\n  id: string\r\n  user_id: string\r\n  amount: number\r\n  message: string | null\r\n  created_at: string\r\n  username?: string\r\n  avatar_url?: string\r\n}\r\n\r\nexport default function PublicPool() {\r\n  const { profile } = useAuthStore()\r\n  const [poolBalance, setPoolBalance] = useState<number>(0)\r\n  const [donations, setDonations] = useState<Donation[]>([])\r\n  const [amount, setAmount] = useState('')\r\n  const [message, setMessage] = useState('')\r\n  const [loading, setLoading] = useState(false)\r\n  const canvasRef = useRef<HTMLCanvasElement>(null)\r\n  const hasPoolRealtimeRef = useRef<boolean>(false)\r\n  \r\n  // Visualizer State\r\n  const particlesRef = useRef<any[]>([])\r\n  const animationFrameRef = useRef<number>()\r\n\r\n  // Load Initial Data\r\n  useEffect(() => {\r\n    const loadData = async () => {\r\n      // 1. Get Pool Balance\r\n      const { data: poolData } = await supabase\r\n        .from('admin_pool')\r\n        .select('trollcoins_balance')\r\n        .limit(1)\r\n        .single()\r\n\r\n      // 2. Get Recent Donations\r\n      const { data: donationData } = await supabase\r\n        .from('pool_donations')\r\n        .select(`\r\n          id,\r\n          user_id,\r\n          amount,\r\n          message,\r\n          created_at\r\n        `)\r\n        .order('created_at', { ascending: false })\r\n        .limit(50)\r\n      \r\n      let donationsTotal = 0\r\n      if (donationData) {\r\n        // Manually fetch user profiles since the relationship is tricky with auth.users\r\n        const userIds = Array.from(new Set(donationData.map((d: any) => d.user_id)))\r\n        \r\n        const { data: profiles } = await supabase\r\n          .from('user_profiles')\r\n          .select('id, username, avatar_url')\r\n          .in('id', userIds)\r\n          \r\n        const profileMap = new Map()\r\n        if (profiles) {\r\n          profiles.forEach((p: any) => {\r\n            profileMap.set(p.id, p)\r\n          })\r\n        }\r\n        const mappedDonations = donationData.map((d: any) => ({\r\n          ...d,\r\n          username: profileMap.get(d.user_id)?.username,\r\n          avatar_url: profileMap.get(d.user_id)?.avatar_url\r\n        }))\r\n        donationsTotal = mappedDonations.reduce(\r\n          (sum, d) => sum + Number(d.amount || 0),\r\n          0\r\n        )\r\n        setDonations(mappedDonations)\r\n      }\r\n\r\n      let nextBalance = 0\r\n      if (poolData && poolData.trollcoins_balance != null) {\r\n        nextBalance = Number(poolData.trollcoins_balance) || 0\r\n      }\r\n      if (nextBalance === 0 && donationsTotal > 0) {\r\n        nextBalance = donationsTotal\r\n      }\r\n      setPoolBalance(nextBalance)\r\n    }\r\n\r\n    loadData()\r\n\r\n    // Realtime Subscriptions\r\n    const poolSub = supabase\r\n      .channel('public-pool-updates')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: 'UPDATE', schema: 'public', table: 'admin_pool' },\r\n        (payload) => {\r\n          hasPoolRealtimeRef.current = true\r\n          setPoolBalance(Number(payload.new.trollcoins_balance))\r\n        }\r\n      )\r\n      .on(\r\n        'postgres_changes',\r\n        { event: 'INSERT', schema: 'public', table: 'pool_donations' },\r\n        async (payload) => {\r\n          // Fetch user details for the new donation\r\n          const { data: userData } = await supabase\r\n            .from('user_profiles')\r\n            .select('username, avatar_url')\r\n            .eq('id', payload.new.user_id)\r\n            .single()\r\n\r\n          const newDonation = {\r\n            ...payload.new,\r\n            username: userData?.username,\r\n            avatar_url: userData?.avatar_url\r\n          } as Donation\r\n\r\n          setDonations(prev => [newDonation, ...prev].slice(0, 50))\r\n          spawnCoins(payload.new.amount)\r\n          if (!hasPoolRealtimeRef.current) {\r\n            setPoolBalance(prev => (prev || 0) + Number(payload.new.amount || 0))\r\n          }\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      poolSub.unsubscribe()\r\n    }\r\n  }, [])\r\n\r\n  // Canvas Visualizer\r\n  const spawnCoins = (amount: number) => {\r\n    if (!canvasRef.current) return\r\n    // Logarithmic scaling for visual coins: don't spawn 1 million particles\r\n    const count = Math.min(Math.floor(Math.log10(amount) * 5) + 5, 50)\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n      particlesRef.current.push({\r\n        x: Math.random() * canvasRef.current.width,\r\n        y: -20 - Math.random() * 100,\r\n        vx: (Math.random() - 0.5) * 2,\r\n        vy: 2 + Math.random() * 3,\r\n        size: 3 + Math.random() * 3,\r\n        color: Math.random() > 0.9 ? '#fbbf24' : '#f59e0b', // Gold variations\r\n        rotation: Math.random() * Math.PI,\r\n        vRot: (Math.random() - 0.5) * 0.2\r\n      })\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    const ctx = canvas.getContext('2d')\r\n    if (!ctx) return\r\n\r\n    const resize = () => {\r\n      if (canvas.parentElement) {\r\n        canvas.width = canvas.parentElement.clientWidth\r\n        canvas.height = canvas.parentElement.clientHeight\r\n      }\r\n    }\r\n    window.addEventListener('resize', resize)\r\n    resize()\r\n\r\n    const animate = () => {\r\n      if (!canvas || !ctx) return\r\n      ctx.clearRect(0, 0, canvas.width, canvas.height)\r\n\r\n      // 1. Draw \"Water Level\" of coins (The Pile)\r\n      // Goal: 10 Million fills the screen nicely\r\n      // Use a curve so it fills fast at first then slows down\r\n      const maxCoins = 10_000_000\r\n      const fillRatio = Math.min(poolBalance / maxCoins, 1.2) // Allow slight overfill\r\n      const pileHeight = canvas.height * fillRatio * 0.8 // Fill up to 80% of screen\r\n\r\n      if (pileHeight > 0) {\r\n        const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - pileHeight)\r\n        gradient.addColorStop(0, '#78350f') // Dark gold/brown bottom\r\n        gradient.addColorStop(0.5, '#b45309')\r\n        gradient.addColorStop(1, '#fbbf24') // Bright gold top\r\n\r\n        ctx.fillStyle = gradient\r\n        ctx.beginPath()\r\n        \r\n        // Wavy top surface\r\n        const time = Date.now() / 1000\r\n        ctx.moveTo(0, canvas.height)\r\n        for (let x = 0; x <= canvas.width; x += 20) {\r\n          const y = canvas.height - pileHeight + Math.sin(x * 0.01 + time) * 10\r\n          ctx.lineTo(x, y)\r\n        }\r\n        ctx.lineTo(canvas.width, canvas.height)\r\n        ctx.fill()\r\n        \r\n        // Top highlight line\r\n        ctx.strokeStyle = '#fcd34d'\r\n        ctx.lineWidth = 3\r\n        ctx.beginPath()\r\n        for (let x = 0; x <= canvas.width; x += 20) {\r\n          const y = canvas.height - pileHeight + Math.sin(x * 0.01 + time) * 10\r\n          ctx.lineTo(x, y)\r\n        }\r\n        ctx.stroke()\r\n      }\r\n\r\n      // 2. Draw Falling Particles\r\n      particlesRef.current.forEach((p, index) => {\r\n        p.x += p.vx\r\n        p.y += p.vy\r\n        p.rotation += p.vRot\r\n        p.vy += 0.1 // Gravity\r\n\r\n        // Draw Coin\r\n        ctx.save()\r\n        ctx.translate(p.x, p.y)\r\n        ctx.rotate(p.rotation)\r\n        ctx.fillStyle = p.color\r\n        ctx.beginPath()\r\n        ctx.arc(0, 0, p.size, 0, Math.PI * 2)\r\n        ctx.fill()\r\n        ctx.restore()\r\n\r\n        // Remove if below pile or screen\r\n        const pileY = canvas.height - pileHeight\r\n        if (p.y > canvas.height || (pileHeight > 0 && p.y > pileY + 20)) {\r\n           // Splash effect? For now just remove\r\n           particlesRef.current.splice(index, 1)\r\n        }\r\n      })\r\n\r\n      animationFrameRef.current = requestAnimationFrame(animate)\r\n    }\r\n\r\n    animate()\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', resize)\r\n      if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current)\r\n    }\r\n  }, [poolBalance])\r\n\r\n\r\n  const handleDonate = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (!amount || isNaN(Number(amount)) || Number(amount) <= 0) {\r\n      toast.error('Please enter a valid amount')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      const { error } = await supabase.rpc('donate_to_public_pool', {\r\n        p_amount: Number(amount),\r\n        p_message: message || null\r\n      })\r\n\r\n      if (error) throw error\r\n      \r\n      toast.success('Donation successful! You are a legend.')\r\n      setAmount('')\r\n      setMessage('')\r\n    } catch (error: any) {\r\n      toast.error(error.message || 'Failed to donate')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-screen bg-slate-950 text-white overflow-hidden relative\">\r\n      {/* Background Visualizer */}\r\n      <div className=\"absolute inset-0 z-0\">\r\n        <canvas ref={canvasRef} className=\"w-full h-full\" />\r\n      </div>\r\n\r\n      {/* Content Overlay */}\r\n      <div className=\"relative z-10 flex flex-col h-full pointer-events-none\">\r\n        \r\n        {/* Header */}\r\n        <div className=\"p-6 bg-gradient-to-b from-slate-900/90 to-transparent pointer-events-auto\">\r\n          <div className=\"max-w-4xl mx-auto flex items-center justify-between\">\r\n             <div className=\"flex items-center gap-4\">\r\n               <div className=\"p-3 bg-cyan-500/20 rounded-2xl border border-cyan-500/30 backdrop-blur-md\">\r\n                 <Waves className=\"w-8 h-8 text-cyan-400\" />\r\n               </div>\r\n               <div>\r\n                 <h1 className=\"text-3xl font-bold text-white drop-shadow-lg\">Public Coin Pool</h1>\r\n                 <p className=\"text-cyan-200/80 font-medium\">Community Chest & Events Fund</p>\r\n               </div>\r\n             </div>\r\n\r\n             <div className=\"text-right\">\r\n                <p className=\"text-sm text-slate-300 mb-1\">Total Pool Value</p>\r\n                <div className=\"text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-amber-400 to-yellow-500 drop-shadow-sm font-mono\">\r\n                  {poolBalance.toLocaleString()}\r\n                </div>\r\n                <div className=\"text-xs text-slate-400 mt-1\">\r\n                   Target: 10,000,000 ({(poolBalance / 10000000 * 100).toFixed(1)}%)\r\n                </div>\r\n             </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Main Body */}\r\n        <div className=\"flex-1 max-w-6xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-3 gap-8 overflow-hidden\">\r\n          \r\n          {/* Left: Donation Form */}\r\n          <div className=\"lg:col-span-1 flex flex-col justify-end pb-12 pointer-events-auto\">\r\n             <div className=\"bg-slate-900/80 backdrop-blur-xl border border-white/10 p-6 rounded-3xl shadow-2xl\">\r\n               <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n                 <Coins className=\"text-yellow-400\" />\r\n                 Make a Splash\r\n               </h2>\r\n               \r\n               <form onSubmit={handleDonate} className=\"space-y-4\">\r\n                 <div>\r\n                   <label className=\"text-xs text-slate-400 ml-1\">Amount</label>\r\n                   <div className=\"relative mt-1\">\r\n                     <input \r\n                       type=\"number\" \r\n                       value={amount}\r\n                       onChange={e => setAmount(e.target.value)}\r\n                       className=\"w-full bg-slate-950/50 border border-slate-700 rounded-xl px-4 py-3 pl-10 text-lg font-mono focus:border-cyan-500 outline-none transition-colors\"\r\n                       placeholder=\"0\"\r\n                     />\r\n                     <div className=\"absolute left-3 top-1/2 -translate-y-1/2 text-yellow-500 font-bold\">$</div>\r\n                   </div>\r\n                 </div>\r\n\r\n                 <div>\r\n                    <label className=\"text-xs text-slate-400 ml-1\">Message (Optional)</label>\r\n                    <input \r\n                      type=\"text\" \r\n                      value={message}\r\n                      onChange={e => setMessage(e.target.value)}\r\n                      className=\"w-full mt-1 bg-slate-950/50 border border-slate-700 rounded-xl px-4 py-2 text-sm focus:border-cyan-500 outline-none transition-colors\"\r\n                      placeholder=\"Shoutout to...\"\r\n                      maxLength={50}\r\n                    />\r\n                 </div>\r\n\r\n                 <button \r\n                   disabled={loading}\r\n                   className=\"w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                 >\r\n                   {loading ? (\r\n                     <span className=\"animate-spin\">‚è≥</span> \r\n                   ) : (\r\n                     <Send className=\"w-5 h-5\" />\r\n                   )}\r\n                   Donate to Pool\r\n                 </button>\r\n                 \r\n                 <div className=\"text-center text-xs text-slate-500 mt-2\">\r\n                   Your balance: {profile?.troll_coins?.toLocaleString() || 0}\r\n                 </div>\r\n               </form>\r\n             </div>\r\n          </div>\r\n\r\n          {/* Center: Spacer for visuals */}\r\n          <div className=\"hidden lg:block\"></div>\r\n\r\n          {/* Right: Feed */}\r\n          <div className=\"lg:col-span-1 pointer-events-auto h-full overflow-hidden flex flex-col\">\r\n             <div className=\"bg-slate-900/80 backdrop-blur-xl border border-white/10 rounded-3xl shadow-2xl flex flex-col h-[600px]\">\r\n                <div className=\"p-4 border-b border-white/5 flex items-center justify-between\">\r\n                  <h3 className=\"font-bold flex items-center gap-2\">\r\n                    <Trophy className=\"w-4 h-4 text-purple-400\" />\r\n                    Recent Donors\r\n                  </h3>\r\n                  <div className=\"text-xs text-slate-500\">Live Feed</div>\r\n                </div>\r\n\r\n                <div className=\"flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar\">\r\n                  {donations.length === 0 ? (\r\n                    <div className=\"text-center text-slate-500 py-10\">\r\n                      No donations yet. Be the first!\r\n                    </div>\r\n                  ) : (\r\n                    donations.map((d) => (\r\n                      <div key={d.id} className=\"bg-slate-950/50 border border-white/5 rounded-xl p-3 flex items-start gap-3 animate-in fade-in slide-in-from-right-4 duration-300\">\r\n                        <div className=\"mt-1\">\r\n                          {d.avatar_url ? (\r\n                             <img src={d.avatar_url} className=\"w-8 h-8 rounded-full border border-white/10\" />\r\n                          ) : (\r\n                             <div className=\"w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center\">\r\n                               <User className=\"w-4 h-4 text-slate-400\" />\r\n                             </div>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                           <div className=\"flex items-center justify-between\">\r\n                             <ClickableUsername \r\n                               userId={d.user_id} \r\n                               username={d.username || 'Unknown'} \r\n                               className=\"font-semibold text-sm text-cyan-200\" \r\n                             />\r\n                             <span className=\"text-yellow-400 font-mono text-sm\">+{d.amount.toLocaleString()}</span>\r\n                           </div>\r\n                           {d.message && (\r\n                             <p className=\"text-xs text-slate-300 mt-1 break-words\">\"{d.message}\"</p>\r\n                           )}\r\n                           <div className=\"text-[10px] text-slate-500 mt-1 text-right\">\r\n                             {new Date(d.created_at).toLocaleTimeString()}\r\n                           </div>\r\n                        </div>\r\n                      </div>\r\n                    ))\r\n                  )}\r\n                </div>\r\n             </div>\r\n          </div>\r\n\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ReelActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ReelComments.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ReelSlide.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\RefundPolicy.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ReportDetailsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Safety.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":50,"column":29,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2804,2859],"text":"Click the &quot;Report\" button on any user profile or stream"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2804,2859],"text":"Click the &ldquo;Report\" button on any user profile or stream"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2804,2859],"text":"Click the &#34;Report\" button on any user profile or stream"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2804,2859],"text":"Click the &rdquo;Report\" button on any user profile or stream"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":50,"column":36,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2804,2859],"text":"Click the \"Report&quot; button on any user profile or stream"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2804,2859],"text":"Click the \"Report&ldquo; button on any user profile or stream"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2804,2859],"text":"Click the \"Report&#34; button on any user profile or stream"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2804,2859],"text":"Click the \"Report&rdquo; button on any user profile or stream"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":94,"column":72,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5239,5320],"text":"For minor first-time offenses. You&apos;ll receive a notification about the violation."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5239,5320],"text":"For minor first-time offenses. You&lsquo;ll receive a notification about the violation."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5239,5320],"text":"For minor first-time offenses. You&#39;ll receive a notification about the violation."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5239,5320],"text":"For minor first-time offenses. You&rsquo;ll receive a notification about the violation."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { Link } from 'react-router-dom'\r\nimport { Shield, AlertTriangle, Lock, MessageSquare, Ban, Users, FileText } from 'lucide-react'\r\n\r\nexport default function Safety() {\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-4xl mx-auto space-y-8\">\r\n        <div className=\"text-center mb-8\">\r\n          <Shield className=\"w-16 h-16 text-purple-400 mx-auto mb-4\" />\r\n          <h1 className=\"text-4xl font-bold text-white mb-2\">Safety & Policies</h1>\r\n          <p className=\"text-gray-400\">Your safety and privacy are our top priorities</p>\r\n        </div>\r\n\r\n        {/* Community Guidelines */}\r\n        <section className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n          <h2 className=\"text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2\">\r\n            <Users className=\"w-6 h-6\" />\r\n            Community Guidelines\r\n          </h2>\r\n          <div className=\"space-y-4 text-gray-300\">\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">Respect Others</h3>\r\n              <p className=\"text-sm\">Treat all users with respect. Harassment, bullying, hate speech, or discrimination of any kind is strictly prohibited.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">No Illegal Content</h3>\r\n              <p className=\"text-sm\">Do not share, promote, or engage in any illegal activities. This includes but is not limited to drugs, weapons, or other prohibited content.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">No Scams or Fraud</h3>\r\n              <p className=\"text-sm\">Do not attempt to scam, defraud, or deceive other users. All transactions must be legitimate and transparent.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">Age Restrictions</h3>\r\n              <p className=\"text-sm\">You must be 18+ to use TrollCity. Do not share content that is inappropriate for minors.</p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Reporting System */}\r\n        <section className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n          <h2 className=\"text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2\">\r\n            <AlertTriangle className=\"w-6 h-6\" />\r\n            Reporting Violations\r\n          </h2>\r\n          <div className=\"space-y-4 text-gray-300\">\r\n            <p className=\"text-sm\">If you encounter any violations of our community guidelines, please report them immediately:</p>\r\n            <ul className=\"list-disc list-inside space-y-2 text-sm ml-4\">\r\n              <li>Click the \"Report\" button on any user profile or stream</li>\r\n              <li>Select the appropriate reason for your report</li>\r\n              <li>Provide a detailed description of the violation</li>\r\n              <li>Our Troll Officers will review your report within 24 hours</li>\r\n            </ul>\r\n            <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 mt-4\">\r\n              <p className=\"text-sm text-yellow-300\">\r\n                <strong>Important:</strong> False reports may result in account restrictions. Only report genuine violations.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Privacy & Security */}\r\n        <section className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n          <h2 className=\"text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2\">\r\n            <Lock className=\"w-6 h-6\" />\r\n            Privacy & Security\r\n          </h2>\r\n          <div className=\"space-y-4 text-gray-300\">\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">Your Data</h3>\r\n              <p className=\"text-sm\">We protect your personal information and never share it with third parties without your consent. All payment information is encrypted and secure.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">Account Security</h3>\r\n              <p className=\"text-sm\">Keep your account secure by using a strong password and never sharing your login credentials. Enable two-factor authentication if available.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-white mb-2\">Blocking Users</h3>\r\n              <p className=\"text-sm\">You can block any user from your profile settings. Blocked users cannot message you or view your profile.</p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Moderation Actions */}\r\n        <section className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n          <h2 className=\"text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2\">\r\n            <Ban className=\"w-6 h-6\" />\r\n            Moderation Actions\r\n          </h2>\r\n          <div className=\"space-y-4 text-gray-300\">\r\n            <div>\r\n              <h3 className=\"font-semibold text-yellow-400 mb-2\">‚ö†Ô∏è Warning</h3>\r\n              <p className=\"text-sm\">For minor first-time offenses. You'll receive a notification about the violation.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-orange-400 mb-2\">‚è∏Ô∏è Stream Suspension</h3>\r\n              <p className=\"text-sm\">For repeated violations. Your stream will be temporarily suspended.</p>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-red-400 mb-2\">üö´ Account Ban</h3>\r\n              <p className=\"text-sm\">For serious violations or after multiple warnings. Bans can be temporary or permanent. Being honest about why you were banned will help you get back on the app.</p>\r\n            </div>\r\n            <div className=\"bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mt-4\">\r\n              <p className=\"text-sm text-blue-300\">\r\n                <strong>Appeal Process:</strong> If you believe a moderation action was incorrect, you can appeal through the Support page. Honesty and understanding the reason for your ban can lead to account restoration.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Contact Support */}\r\n        <section className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n          <h2 className=\"text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2\">\r\n            <MessageSquare className=\"w-6 h-6\" />\r\n            Need Help?\r\n          </h2>\r\n          <div className=\"space-y-4 text-gray-300\">\r\n            <p className=\"text-sm\">If you have questions, concerns, or need assistance:</p>\r\n            <ul className=\"list-disc list-inside space-y-2 text-sm ml-4\">\r\n              <li>Visit the Support page in your dashboard</li>\r\n              <li>Contact our Troll Officers through the moderation system</li>\r\n              <li>Email support for urgent matters</li>\r\n            </ul>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Legal Links */}\r\n        <section className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-6\">\r\n          <h2 className=\"text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2\">\r\n            <FileText className=\"w-6 h-6\" />\r\n            Legal Documents\r\n          </h2>\r\n          <div className=\"space-y-2\">\r\n            <Link to=\"/legal/terms\" className=\"block text-purple-400 hover:text-purple-300 text-sm\">Terms of Service</Link>\r\n            <Link to=\"/legal/refunds\" className=\"block text-purple-400 hover:text-purple-300 text-sm\">Refund Policy</Link>\r\n            <Link to=\"/legal/payouts\" className=\"block text-purple-400 hover:text-purple-300 text-sm\">Payout Policy</Link>\r\n            <Link to=\"/legal/safety\" className=\"block text-purple-400 hover:text-purple-300 text-sm\">Safety Guidelines</Link>\r\n          </div>\r\n        </section>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\SecretaryConsole.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\SellOnTrollCity.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":688,"column":132,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You&apos;ll receive a notification when it's processed."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You&lsquo;ll receive a notification when it's processed."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You&#39;ll receive a notification when it's processed."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You&rsquo;ll receive a notification when it's processed."},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":688,"column":166,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You'll receive a notification when it&apos;s processed."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You'll receive a notification when it&lsquo;s processed."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You'll receive a notification when it&#39;s processed."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[30320,30439],"text":"Your application has been submitted and is being reviewed by admins. You'll receive a notification when it&rsquo;s processed."},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":832,"column":92,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[38117,38118],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[38117,38118],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[38117,38118],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[38117,38118],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":832,"column":105,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[38130,38131],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[38130,38131],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[38130,38131],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[38130,38131],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { Store, ShoppingCart, Coins, DollarSign, Truck, FileText, TrendingUp, AlertTriangle, CheckCircle, XCircle, Clock, Plus, Edit, Trash, Package } from 'lucide-react'\r\n\r\nexport default function SellOnTrollCity() {\r\n  console.log('üõçÔ∏è SellOnTrollCity component rendering');\r\n  const { user } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [shop, setShop] = useState<any>(null)\r\n  const [name, setName] = useState('')\r\n  const [loading, setLoading] = useState(true)\r\n  const [earnings, setEarnings] = useState<any>(null)\r\n  const [activeTab, setActiveTab] = useState('requirements')\r\n  const [applicationLoading, setApplicationLoading] = useState(false)\r\n  const [existingApplication, setExistingApplication] = useState<any>(null)\r\n  const isVerifiedSeller = existingApplication?.status === 'approved'\r\n  const [products, setProducts] = useState<any[]>([])\r\n  \r\n  // Seller application form state\r\n  const [storeName, setStoreName] = useState('')\r\n  const [storeDescription, setStoreDescription] = useState('')\r\n  const [productTypes, setProductTypes] = useState('')\r\n  const [contactEmail, setContactEmail] = useState('')\r\n  \r\n  // Product editing state\r\n  const [isEditing, setIsEditing] = useState(false)\r\n  const [editProduct, setEditProduct] = useState<any>(null)\r\n  const [formData, setFormData] = useState<{\r\n    name: string\r\n    description: string\r\n    price: string\r\n    image_url: string | File | null\r\n  }>({\r\n    name: '',\r\n    description: '',\r\n    price: '',\r\n    image_url: ''\r\n  })\r\n\r\n  // Shop deletion state\r\n  const [showDeleteModal, setShowDeleteModal] = useState(false)\r\n  const [deletingShop, setDeletingShop] = useState(false)\r\n\r\n  const pauseShop = async () => {\r\n    if (!shop) return\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('trollcity_shops')\r\n        .update({ is_active: false, updated_at: new Date().toISOString() })\r\n        .eq('id', shop.id)\r\n        .eq('owner_id', user!.id)\r\n        .select('*')\r\n        .single()\r\n      if (error) throw error\r\n      setShop(data)\r\n      toast.success('Shop paused')\r\n    } catch (err: any) {\r\n      console.error('Error pausing shop:', err)\r\n      toast.error('Failed to pause shop')\r\n    }\r\n  }\r\n\r\n  const resumeShop = async () => {\r\n    if (!shop) return\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('trollcity_shops')\r\n        .update({ is_active: true, updated_at: new Date().toISOString() })\r\n        .eq('id', shop.id)\r\n        .eq('owner_id', user!.id)\r\n        .select('*')\r\n        .single()\r\n      if (error) throw error\r\n      setShop(data)\r\n      toast.success('Shop resumed')\r\n    } catch (err: any) {\r\n      console.error('Error resuming shop:', err)\r\n      toast.error('Failed to resume shop')\r\n    }\r\n  }\r\n\r\n  const loadShop = useCallback(async () => {\r\n    setLoading(true)\r\n\r\n    // Check for existing seller application\r\n    const { data: appData } = await supabase\r\n      .from('applications')\r\n      .select('*')\r\n      .eq('user_id', user!.id)\r\n      .eq('type', 'seller')\r\n      .order('created_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle()\r\n\r\n    setExistingApplication(appData)\r\n    // setApplicationSubmitted(!!appData) // Fix: setApplicationSubmitted is not defined in the read snippet, but I should probably leave it if it was there or check.\r\n    // Wait, the read snippet showed `setApplicationSubmitted(!!appData)` in line 64?\r\n    // Let me check the read snippet again.\r\n    // Line 64: `setApplicationSubmitted(!!appData)`\r\n    // But `setApplicationSubmitted` was NOT in the variable declarations I saw (lines 10-41).\r\n    // I missed checking where it came from.\r\n    // It might be a missing variable declaration error too!\r\n    // But let's stick to what I see.\r\n    // I will use `setApplicationSubmitted` if it exists.\r\n    // Actually, I'll copy the existing body and just wrap it.\r\n    \r\n    const { data } = await supabase\r\n      .from('trollcity_shops')\r\n      .select('*')\r\n      .eq('owner_id', user!.id)\r\n      .maybeSingle()\r\n    setShop(data)\r\n\r\n    // Load earnings and products data if shop exists\r\n    if (data) {\r\n      const { data: earningsData } = await supabase\r\n        .from('shop_transactions')\r\n        .select('*')\r\n        .eq('shop_id', data.id)\r\n        .order('created_at', { ascending: false })\r\n      setEarnings(earningsData || [])\r\n\r\n      const { data: productsData } = await supabase\r\n        .from('shop_items')\r\n        .select('*')\r\n        .eq('shop_id', data.id)\r\n        .order('created_at', { ascending: false })\r\n      setProducts(productsData || [])\r\n    }\r\n\r\n    setLoading(false)\r\n  }, [user])\r\n\r\n  useEffect(() => {\r\n    if (!user) return\r\n    loadShop()\r\n  }, [user, loadShop])\r\n\r\n  const createShop = async () => {\r\n    if (!name.trim()) return toast.error('Enter a shop name')\r\n    const { data, error } = await supabase\r\n      .from('trollcity_shops')\r\n      .insert([{ owner_id: user!.id, name }])\r\n      .select('*')\r\n      .maybeSingle()\r\n    if (error) return toast.error(error.message)\r\n    setShop(data)\r\n    toast.success('Shop created')\r\n  }\r\n\r\n  const submitApplication = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n\r\n    if (!storeName.trim() || !storeDescription.trim() || !contactEmail.trim()) {\r\n      toast.error('Please fill in all required fields')\r\n      return\r\n    }\r\n\r\n    setApplicationLoading(true)\r\n    try {\r\n      const { error } = await supabase\r\n        .from('applications')\r\n        .insert([{\r\n          user_id: user!.id,\r\n          type: 'seller',\r\n          store_name: storeName.trim(),\r\n          store_description: storeDescription.trim(),\r\n          product_types: productTypes.trim(),\r\n          contact_email: contactEmail.trim(),\r\n          status: 'pending'\r\n        }])\r\n\r\n      if (error) throw error\r\n\r\n      toast.success('Seller application submitted successfully!')\r\n\r\n      // Redirect to home/dashboard with state\r\n      navigate('/live', {\r\n        state: { submitted: 'seller' }\r\n      })\r\n    } catch (error: any) {\r\n      console.error('Error submitting application:', error)\r\n      toast.error('Failed to submit application')\r\n    } finally {\r\n      setApplicationLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (!formData.name || !formData.price) return toast.error('Name and price required')\r\n    \r\n    try {\r\n      const price = parseFloat(formData.price)\r\n      if (isNaN(price) || price < 0) return toast.error('Invalid price')\r\n\r\n      let imagePublicUrl: string | null = null\r\n      const maybeFile = formData.image_url as unknown as File | null\r\n      if (maybeFile && typeof (maybeFile as any).name === 'string') {\r\n        try {\r\n          const file = maybeFile\r\n          const ext = file.name.includes('.') ? file.name.substring(file.name.lastIndexOf('.')) : ''\r\n          const path = `shop-items/${user!.id}/${Date.now()}${ext}`\r\n          const { error: uploadErr } = await supabase.storage\r\n            .from('post-images')\r\n            .upload(path, file, { cacheControl: '3600', upsert: false })\r\n          if (uploadErr) throw uploadErr\r\n          const { data: urlData } = supabase.storage.from('post-images').getPublicUrl(path)\r\n          imagePublicUrl = urlData.publicUrl\r\n        } catch (uploadError: any) {\r\n          console.error('Product image upload failed:', uploadError)\r\n          toast.error('Failed to upload product image')\r\n          return\r\n        }\r\n      }\r\n\r\n      if (isEditing && editProduct) {\r\n        // Update existing product\r\n        const { error } = await supabase\r\n          .from('shop_items')\r\n          .update({\r\n            name: formData.name,\r\n            description: formData.description,\r\n            price: price,\r\n            image_url: imagePublicUrl ?? editProduct.image_url ?? null,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', editProduct.id)\r\n        \r\n        if (error) throw error\r\n        toast.success('Product updated')\r\n      } else {\r\n        // Create new product\r\n        const { data, error } = await supabase\r\n          .from('shop_items')\r\n          .insert([{\r\n            shop_id: shop.id,\r\n            name: formData.name,\r\n            description: formData.description,\r\n            price: price,\r\n            image_url: imagePublicUrl\r\n          }])\r\n          .select()\r\n          .single()\r\n\r\n        if (error) throw error\r\n\r\n        setProducts([data, ...products])\r\n        toast.success('Product added successfully!')\r\n      }\r\n      \r\n      setFormData({ name: '', description: '', price: '', image_url: '' })\r\n      setIsEditing(false)\r\n      setEditProduct(null)\r\n    } catch (err: any) {\r\n      toast.error(err.message)\r\n    }\r\n  }\r\n\r\n  const handleEdit = (product: any) => {\r\n    setEditProduct(product)\r\n    setFormData({\r\n      name: product.name,\r\n      description: product.description || '',\r\n      price: product.price.toString(),\r\n      image_url: product.image_url || ''\r\n    })\r\n    setIsEditing(true)\r\n  }\r\n\r\n  const deleteProduct = async (productId: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('shop_items')\r\n        .delete()\r\n        .eq('id', productId)\r\n\r\n      if (error) throw error\r\n\r\n      setProducts(products.filter(p => p.id !== productId))\r\n      toast.success('Product deleted successfully!')\r\n    } catch (error: any) {\r\n      console.error('Error deleting product:', error)\r\n      toast.error('Failed to delete product')\r\n    }\r\n  }\r\n\r\n  const deleteShop = async () => {\r\n    if (!shop) return\r\n\r\n    setDeletingShop(true)\r\n    try {\r\n      const { error } = await supabase\r\n        .from('trollcity_shops')\r\n        .update({ is_active: false })\r\n        .eq('id', shop.id)\r\n        .eq('owner_id', user!.id)\r\n\r\n      if (error) throw error\r\n\r\n      setShop(null)\r\n      setProducts([])\r\n      setShowDeleteModal(false)\r\n      toast.success('Shop deleted successfully!')\r\n    } catch (error: any) {\r\n      console.error('Error deleting shop:', error)\r\n      toast.error('Failed to delete shop')\r\n    } finally {\r\n      setDeletingShop(false)\r\n    }\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"mb-4\">Please log in</p>\r\n          <button onClick={() => navigate('/auth')} className=\"px-4 py-2 bg-purple-600 rounded-lg\">Log In</button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto space-y-6\">\r\n        <div className=\"text-center\">\r\n          <h1 className=\"text-4xl font-bold mb-2 flex items-center justify-center gap-3\">\r\n            <Store className=\"w-8 h-8 text-purple-400\" />\r\n            Sell on Troll City\r\n          </h1>\r\n          <p className=\"text-gray-400\">Create your shop, manage products, and track earnings</p>\r\n        </div>\r\n\r\n        {/* Tab Navigation */}\r\n        <div className=\"flex justify-center\">\r\n          <div className=\"bg-[#1A1A1A] rounded-lg p-1 border border-[#2C2C2C]\">\r\n            {isVerifiedSeller || shop ? (\r\n              <>\r\n                <button\r\n                  onClick={() => setActiveTab('overview')}\r\n                  className={`px-6 py-2 rounded-md transition-colors ${activeTab === 'overview' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\r\n                >\r\n                  Overview\r\n                </button>\r\n                {shop && (\r\n                  <button\r\n                    onClick={() => setActiveTab('dashboard')}\r\n                    className={`px-6 py-2 rounded-md transition-colors ${activeTab === 'dashboard' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\r\n                  >\r\n                    Dashboard\r\n                  </button>\r\n                )}\r\n                <button\r\n                  onClick={() => setActiveTab('requirements')}\r\n                  className={`px-6 py-2 rounded-md transition-colors ${activeTab === 'requirements' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\r\n                >\r\n                  Requirements\r\n                </button>\r\n                {shop && (\r\n                  <button\r\n                    onClick={() => setActiveTab('earnings')}\r\n                    className={`px-6 py-2 rounded-md transition-colors ${activeTab === 'earnings' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}\r\n                  >\r\n                    Earnings\r\n                  </button>\r\n                )}\r\n              </>\r\n            ) : (\r\n              <button\r\n                className=\"px-6 py-2 rounded-md bg-purple-600 text-white\"\r\n                disabled\r\n              >\r\n                Requirements\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tab Content */}\r\n        {activeTab === 'overview' && (\r\n          <div className=\"grid md:grid-cols-2 gap-6\">\r\n            <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C]\">\r\n              <h2 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\r\n                <Store className=\"w-5 h-5 text-purple-400\" />\r\n                Create Your Shop\r\n              </h2>\r\n              {loading ? (\r\n                <p className=\"text-gray-400\">Loading...</p>\r\n              ) : shop ? (\r\n                <div className=\"space-y-4\">\r\n                  {shop.is_active ? (\r\n                    <div className=\"bg-green-900/20 border border-green-500/30 rounded-lg p-3\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"text-green-400 font-semibold\">‚úì Shop Active: {shop.name}</p>\r\n                        <div className=\"flex gap-2\">\r\n                          <button\r\n                            onClick={pauseShop}\r\n                            className=\"px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded transition-colors\"\r\n                          >\r\n                            Pause Shop\r\n                          </button>\r\n                          <button\r\n                            onClick={() => setShowDeleteModal(true)}\r\n                            className=\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors\"\r\n                          >\r\n                            Delete Shop\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-xs text-yellow-300 mt-2\">\r\n                        Pause your shop anytime if you cannot afford weekly fees.\r\n                      </p>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"text-yellow-400 font-semibold\">Shop Paused: {shop.name}</p>\r\n                        <div className=\"flex gap-2\">\r\n                          <button\r\n                            onClick={resumeShop}\r\n                            className=\"px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition-colors\"\r\n                          >\r\n                            Resume Shop\r\n                          </button>\r\n                          <button\r\n                            onClick={() => setShowDeleteModal(true)}\r\n                            className=\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors\"\r\n                          >\r\n                            Delete Shop\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-xs text-gray-300 mt-2\">\r\n                        While paused, your shop is hidden and fees are not charged.\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n                  <button onClick={() => setActiveTab('dashboard')} className=\"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors\">\r\n                    Seller Dashboard\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3\">\r\n                    <p className=\"text-yellow-400 text-sm\">‚ö†Ô∏è You must apply and meet all requirements before creating a shop</p>\r\n                  </div>\r\n                  <input\r\n                    value={name}\r\n                    onChange={(e) => setName(e.target.value)}\r\n                    placeholder=\"Shop name\"\r\n                    className=\"w-full px-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 focus:outline-none\"\r\n                  />\r\n                  <button onClick={createShop} className=\"w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors\">\r\n                    Create Shop\r\n                  </button>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C]\">\r\n              <h2 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\r\n                <ShoppingCart className=\"w-5 h-5 text-blue-400\" />\r\n                Manage Products\r\n              </h2>\r\n              <p className=\"text-gray-300 mb-4\">Add and update your product listings</p>\r\n              {shop ? (\r\n                <button onClick={() => setActiveTab('dashboard')} className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors\">\r\n                  Product Management\r\n                </button>\r\n              ) : (\r\n                <div className=\"bg-gray-900/50 rounded-lg p-3\">\r\n                  <p className=\"text-gray-400 text-sm\">Create your shop first to manage products</p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'dashboard' && shop && (\r\n          <div className=\"grid lg:grid-cols-3 gap-8\">\r\n            {/* Form */}\r\n            <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C] h-fit\">\r\n              <h2 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\r\n                {isEditing ? <Edit className=\"w-5 h-5\" /> : <Plus className=\"w-5 h-5\" />}\r\n                {isEditing ? 'Edit Product' : 'Add New Product'}\r\n              </h2>\r\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm text-gray-400 mb-1\">Product Name</label>\r\n                  <input\r\n                    value={formData.name}\r\n                    onChange={e => setFormData({...formData, name: e.target.value})}\r\n                    className=\"w-full px-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 outline-none\"\r\n                    placeholder=\"e.g. Rare Troll Card\"\r\n                    required\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <label className=\"block text-sm text-gray-400 mb-1\">Description</label>\r\n                  <textarea\r\n                    value={formData.description}\r\n                    onChange={e => setFormData({...formData, description: e.target.value})}\r\n                    className=\"w-full px-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 outline-none resize-none h-24\"\r\n                    placeholder=\"Product details...\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <label className=\"block text-sm text-gray-400 mb-1\">Price (Coins)</label>\r\n                  <div className=\"relative\">\r\n                    <Coins className=\"absolute left-3 top-2.5 w-4 h-4 text-purple-400\" />\r\n                    <input\r\n                      type=\"number\"\r\n                      step=\"1\"\r\n                      value={formData.price}\r\n                      onChange={e => setFormData({...formData, price: e.target.value})}\r\n                      className=\"w-full pl-10 pr-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 outline-none\"\r\n                      placeholder=\"0\"\r\n                      required\r\n                    />\r\n                  </div>\r\n                </div>\r\n                <div>\r\n                  <label className=\"block text-sm text-gray-400 mb-1\">Product Image</label>\r\n                  <input\r\n                    type=\"file\"\r\n                    accept=\"image/*\"\r\n                    onChange={e => {\r\n                      const file = e.target.files?.[0] || null\r\n                      setFormData({...formData, image_url: file ? (file as any) : ''})\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 outline-none\"\r\n                  />\r\n                  <p className=\"text-xs text-gray-500 mt-1\">Upload a product image from your device</p>\r\n                </div>\r\n                \r\n                <div className=\"flex gap-2 pt-2\">\r\n                  <button\r\n                    type=\"submit\"\r\n                    className={`flex-1 py-2 rounded-lg font-semibold ${isEditing ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'} transition-colors`}\r\n                  >\r\n                    {isEditing ? 'Update Product' : 'Add Product'}\r\n                  </button>\r\n                  {isEditing && (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        setIsEditing(false)\r\n                        setEditProduct(null)\r\n                        setFormData({ name: '', description: '', price: '', image_url: '' })\r\n                      }}\r\n                      className=\"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors\"\r\n                    >\r\n                      Cancel\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </form>\r\n            </div>\r\n\r\n                {/* List */}\r\n                <div className=\"lg:col-span-2 bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C]\">\r\n                  <h2 className=\"text-xl font-semibold mb-4\">Your Products ({products.length})</h2>\r\n                  <div className=\"space-y-4\">\r\n                    {products.map(product => (\r\n                      <div key={product.id} className=\"bg-[#0D0D0D] p-4 rounded-lg border border-[#2C2C2C] flex justify-between items-center group hover:border-purple-500/50 transition-colors\">\r\n                        <div className=\"flex-1\">\r\n                          <h3 className=\"font-bold text-lg text-white\">{product.name}</h3>\r\n                          <p className=\"text-gray-400 text-sm mb-1\">{product.description}</p>\r\n                          <div className=\"flex items-center gap-4\">\r\n                            <p className=\"text-yellow-400 font-semibold flex items-center gap-1\">\r\n                              <Coins className=\"w-4 h-4\" /> {product.price}\r\n                            </p>\r\n                            {product.image_url && (\r\n                              <img\r\n                                src={product.image_url}\r\n                                alt={product.name}\r\n                                className=\"w-12 h-12 object-cover rounded\"\r\n                                onError={(e) => {\r\n                                  (e.target as HTMLImageElement).style.display = 'none'\r\n                                }}\r\n                              />\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                          <button\r\n                            onClick={() => handleEdit(product)}\r\n                            className=\"p-2 bg-blue-900/30 text-blue-400 rounded hover:bg-blue-900/50 transition-colors\"\r\n                          >\r\n                            <Edit className=\"w-4 h-4\" />\r\n                          </button>\r\n                          <button\r\n                            onClick={() => deleteProduct(product.id)}\r\n                            className=\"p-2 bg-red-900/30 text-red-400 rounded hover:bg-red-900/50 transition-colors\"\r\n                          >\r\n                            <Trash className=\"w-4 h-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                    {products.length === 0 && (\r\n                      <div className=\"text-center py-12 text-gray-500\">\r\n                        <Package className=\"w-12 h-12 mx-auto mb-2 opacity-20\" />\r\n                        <p>No products listed yet.</p>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {activeTab === 'requirements' && (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C]\">\r\n                  <h2 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\r\n                    <FileText className=\"w-5 h-5 text-orange-400\" />\r\n                    Seller Requirements\r\n                  </h2>\r\n\r\n                  <div className=\"space-y-4\">\r\n                    <div className=\"bg-red-900/20 border border-red-500/30 rounded-lg p-4\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <AlertTriangle className=\"w-5 h-5 text-red-400 mt-0.5 flex-shrink-0\" />\r\n                        <div>\r\n                          <h3 className=\"font-semibold text-red-400 mb-1\">Application Required</h3>\r\n                          <p className=\"text-gray-300 text-sm\">All users must apply to become sellers. Your application will be reviewed before approval.</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"bg-blue-900/20 border border-blue-500/30 rounded-lg p-4\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <Truck className=\"w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0\" />\r\n                        <div>\r\n                          <h3 className=\"font-semibold text-blue-400 mb-1\">Shipping Costs</h3>\r\n                          <p className=\"text-gray-300 text-sm\">Sellers are responsible for all shipping costs. Calculate shipping fees into your product prices.</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <DollarSign className=\"w-5 h-5 text-yellow-400 mt-0.5 flex-shrink-0\" />\r\n                        <div>\r\n                          <h3 className=\"font-semibold text-yellow-400 mb-1\">Weekly Platform Fee</h3>\r\n                          <p className=\"text-gray-300 text-sm\">Platform access requires a weekly fee paid in Troll Coins. If you cannot afford the fee, pause your shop anytime to avoid charges.</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"bg-purple-900/20 border border-purple-500/30 rounded-lg p-4\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <Coins className=\"w-5 h-5 text-purple-400 mt-0.5 flex-shrink-0\" />\r\n                        <div>\r\n                          <h3 className=\"font-semibold text-purple-400 mb-1\">Payment Processing</h3>\r\n                          <p className=\"text-gray-300 text-sm\">All marketplace purchases use Troll Coins only. Set item prices in coins; fiat payments are not supported.</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n              </div>\r\n\r\n              <div className=\"mt-6 p-4 bg-gray-900/50 rounded-lg\">\r\n                {isVerifiedSeller ? (\r\n                  <div className=\"text-center\">\r\n                    <div className=\"bg-green-900/20 border border-green-500/30 rounded-lg p-4 mb-4\">\r\n                      <CheckCircle className=\"w-8 h-8 text-green-400 mx-auto mb-2\" />\r\n                      <p className=\"text-green-400 font-semibold\">Application Approved!</p>\r\n                      <p className=\"text-gray-400 text-sm\">You can now create and manage your shop. Switch to the Overview tab to get started.</p>\r\n                    </div>\r\n                  </div>\r\n                ) : existingApplication?.status === 'rejected' ? (\r\n                  <div className=\"text-center\">\r\n                    <div className=\"bg-red-900/20 border border-red-500/30 rounded-lg p-4 mb-4\">\r\n                      <XCircle className=\"w-8 h-8 text-red-400 mx-auto mb-2\" />\r\n                      <p className=\"text-red-400 font-semibold\">Application Rejected</p>\r\n                      <p className=\"text-gray-400 text-sm\">Your application was not approved. Please contact support for more information.</p>\r\n                    </div>\r\n                  </div>\r\n                ) : existingApplication ? (\r\n                  <div className=\"text-center\">\r\n                    <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 mb-4\">\r\n                      <Clock className=\"w-8 h-8 text-yellow-400 mx-auto mb-2\" />\r\n                      <p className=\"text-yellow-400 font-semibold\">Application Under Review</p>\r\n                      <p className=\"text-gray-400 text-sm\">Your application has been submitted and is being reviewed by admins. You'll receive a notification when it's processed.</p>\r\n                    </div>\r\n                    <p className=\"text-gray-400 text-sm\">Application submitted on {new Date(existingApplication.created_at).toLocaleDateString()}</p>\r\n                  </div>\r\n                ) : (\r\n                  <>\r\n                    <h3 className=\"font-semibold mb-2\">Ready to Apply?</h3>\r\n                    <p className=\"text-gray-400 text-sm mb-4\">\r\n                      Fill out the application form below. Once submitted, it will be reviewed by admins.\r\n                      Approval unlocks seller features and shop creation.\r\n                    </p>\r\n\r\n                    <form onSubmit={submitApplication} className=\"space-y-4\">\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                          Store Name *\r\n                        </label>\r\n                        <input\r\n                          type=\"text\"\r\n                          value={storeName}\r\n                          onChange={(e) => setStoreName(e.target.value)}\r\n                          className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 focus:outline-none text-white\"\r\n                          placeholder=\"e.g. Troll Collectibles Shop\"\r\n                          required\r\n                        />\r\n                      </div>\r\n\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                          Store Description *\r\n                        </label>\r\n                        <textarea\r\n                          value={storeDescription}\r\n                          onChange={(e) => setStoreDescription(e.target.value)}\r\n                          className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 focus:outline-none text-white resize-none h-24\"\r\n                          placeholder=\"Describe what your store sells and your unique selling points...\"\r\n                          required\r\n                        />\r\n                      </div>\r\n\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                          Product Types\r\n                        </label>\r\n                        <input\r\n                          type=\"text\"\r\n                          value={productTypes}\r\n                          onChange={(e) => setProductTypes(e.target.value)}\r\n                          className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 focus:outline-none text-white\"\r\n                          placeholder=\"e.g. Digital art, collectibles, merchandise\"\r\n                        />\r\n                      </div>\r\n\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                          Contact Email *\r\n                        </label>\r\n                        <input\r\n                          type=\"email\"\r\n                          value={contactEmail}\r\n                          onChange={(e) => setContactEmail(e.target.value)}\r\n                          className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-purple-500 focus:outline-none text-white\"\r\n                          placeholder=\"your@email.com\"\r\n                          required\r\n                        />\r\n                      </div>\r\n\r\n                      <button\r\n                        type=\"submit\"\r\n                        disabled={applicationLoading}\r\n                        className=\"w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 rounded-lg transition-colors font-semibold\"\r\n                      >\r\n                        {applicationLoading ? 'Submitting Application...' : 'Submit Seller Application'}\r\n                      </button>\r\n                    </form>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'earnings' && shop && (\r\n          <div className=\"space-y-6\">\r\n            <div className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C]\">\r\n              <h2 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\r\n                <TrendingUp className=\"w-5 h-5 text-green-400\" />\r\n                Shop Earnings\r\n              </h2>\r\n\r\n              {earnings && earnings.length > 0 ? (\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\r\n                    <div className=\"bg-green-900/20 border border-green-500/30 rounded-lg p-4 text-center\">\r\n                      <p className=\"text-2xl font-bold text-green-400\">\r\n                        ${earnings.reduce((sum: number, tx: any) => sum + (tx.amount || 0), 0).toFixed(2)}\r\n                      </p>\r\n                      <p className=\"text-sm text-gray-400\">Total Sales</p>\r\n                    </div>\r\n                    <div className=\"bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 text-center\">\r\n                      <p className=\"text-2xl font-bold text-blue-400\">\r\n                        {earnings.length}\r\n                      </p>\r\n                      <p className=\"text-sm text-gray-400\">Total Orders</p>\r\n                    </div>\r\n                    <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 text-center\">\r\n                      <p className=\"text-2xl font-bold text-yellow-400\">\r\n                        ${(earnings.reduce((sum: number, tx: any) => sum + (tx.amount || 0), 0) * 0.1).toFixed(2)}\r\n                      </p>\r\n                      <p className=\"text-sm text-gray-400\">Platform Fees</p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"space-y-2\">\r\n                    <h3 className=\"font-semibold\">Recent Transactions</h3>\r\n                    {earnings.slice(0, 10).map((tx: any) => (\r\n                      <div key={tx.id} className=\"flex items-center justify-between bg-gray-900/50 rounded-lg p-3\">\r\n                        <div>\r\n                          <p className=\"font-medium\">{tx.item_name || 'Item Sale'}</p>\r\n                          <p className=\"text-sm text-gray-400\">{new Date(tx.created_at).toLocaleDateString()}</p>\r\n                        </div>\r\n                        <p className=\"text-green-400 font-bold\">${tx.amount?.toFixed(2)}</p>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div className=\"text-center py-8\">\r\n                  <TrendingUp className=\"w-16 h-16 text-gray-500 mx-auto mb-4\" />\r\n                  <h3 className=\"text-lg font-semibold mb-2\">No Earnings Yet</h3>\r\n                  <p className=\"text-gray-400\">Start selling products to see your earnings here</p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Delete Shop Confirmation Modal */}\r\n        {showDeleteModal && (\r\n          <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-[#1A1A1A] rounded-xl p-6 max-w-md w-full border border-red-500/30\">\r\n              <h3 className=\"text-xl font-bold mb-4 text-center text-red-400\">Delete Shop</h3>\r\n              <div className=\"text-center mb-6\">\r\n                <p className=\"text-gray-300 mb-2\">\r\n                  Are you sure you want to delete <span className=\"text-red-400 font-bold\">\"{shop?.name}\"</span>?\r\n                </p>\r\n                <p className=\"text-sm text-gray-400\">\r\n                  This action cannot be undone. Your shop will be removed from the marketplace and all products will be deleted.\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-6\">\r\n                <p className=\"text-sm text-red-300\">\r\n                  ‚ö†Ô∏è Deleting your shop will permanently remove it from the marketplace. Any pending orders may be affected.\r\n                </p>\r\n              </div>\r\n              <div className=\"flex gap-3\">\r\n                <button\r\n                  onClick={() => setShowDeleteModal(false)}\r\n                  className=\"flex-1 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-colors\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  onClick={deleteShop}\r\n                  disabled={deletingShop}\r\n                  className=\"flex-1 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-colors flex items-center justify-center gap-2\"\r\n                >\r\n                  {deletingShop ? (\r\n                    <>\r\n                      <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\r\n                      Deleting...\r\n                    </>\r\n                  ) : (\r\n                    'Delete Shop'\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ShopDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ShopEarnings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ShopPartnerPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\ShopView.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":339,"column":57,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[11566,11610],"text":"This shop doesn&apos;t have any items listed yet."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[11566,11610],"text":"This shop doesn&lsquo;t have any items listed yet."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[11566,11610],"text":"This shop doesn&#39;t have any items listed yet."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[11566,11610],"text":"This shop doesn&rsquo;t have any items listed yet."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useParams, useNavigate } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { deductCoins } from '../lib/coinTransactions'\r\nimport { Store, ShoppingCart, Coins, ArrowLeft, Package, Receipt, X } from 'lucide-react'\r\n\r\nexport default function ShopView() {\r\n  const { username } = useParams<{ username: string }>()\r\n  const { user } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [shop, setShop] = useState<any>(null)\r\n  const [items, setItems] = useState<any[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [purchasing, setPurchasing] = useState<string | null>(null)\r\n  const [showReceipt, setShowReceipt] = useState(false)\r\n  const [purchaseReceipt, setPurchaseReceipt] = useState<any>(null)\r\n\r\n  const loadShop = useCallback(async () => {\r\n    if (!username) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      // Resolve owner by username\r\n      const { data: owner, error: ownerErr } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username')\r\n        .eq('username', username)\r\n        .single()\r\n      if (ownerErr) throw ownerErr\r\n      if (!owner?.id) {\r\n        toast.error('Seller not found')\r\n        navigate('/marketplace')\r\n        return\r\n      }\r\n\r\n      // Load shop details by owner_id\r\n      const { data: shopData, error: shopError } = await supabase\r\n        .from('trollcity_shops')\r\n        .select('*')\r\n        .eq('owner_id', owner.id)\r\n        .eq('is_active', true)\r\n        .single()\r\n\r\n      if (shopError) throw shopError\r\n      if (!shopData) {\r\n        toast.error('Shop not found')\r\n        navigate('/marketplace')\r\n        return\r\n      }\r\n\r\n      setShop(shopData)\r\n\r\n      // Load shop items\r\n      const { data: itemsData, error: itemsError } = await supabase\r\n        .from('shop_items')\r\n        .select('*')\r\n        .eq('shop_id', shopData.id)\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (itemsError) throw itemsError\r\n      setItems(itemsData || [])\r\n\r\n    } catch (err) {\r\n      console.error('Error loading shop:', err)\r\n      toast.error('Failed to load shop')\r\n      navigate('/marketplace')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [username, navigate])\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/auth', { replace: true })\r\n      return\r\n    }\r\n    if (username) {\r\n      loadShop()\r\n    }\r\n  }, [user, username, navigate, loadShop])\r\n\r\n  const purchaseItem = async (item: any) => {\r\n    if (!user) return\r\n\r\n    setPurchasing(item.id)\r\n    try {\r\n      // Check if user has enough troll_coins (purchases use troll_coins specifically)\r\n      const { data: profile } = await supabase\r\n        .from('user_profiles')\r\n        .select('troll_coins')\r\n        .eq('id', user.id)\r\n        .single()\r\n\r\n      if ((profile?.troll_coins || 0) < item.price) {\r\n        toast.error('Not enough troll coins!')\r\n        return\r\n      }\r\n\r\n      // Check item availability (if limited stock)\r\n      if (item.stock_quantity !== null && item.stock_quantity <= 0) {\r\n        toast.error('This item is out of stock!')\r\n        return\r\n      }\r\n\r\n      // Deduct coins using the coin transaction system\r\n      const deductResult = await deductCoins({\r\n        userId: user.id,\r\n        amount: item.price,\r\n        type: 'purchase',\r\n        description: `Purchase: ${item.name} from ${shop.name}`,\r\n        metadata: {\r\n          shop_id: shop.id,\r\n          item_id: item.id,\r\n          seller_id: shop.owner_id\r\n        }\r\n      })\r\n\r\n      if (!deductResult.success) {\r\n        toast.error('Failed to process payment')\r\n        return\r\n      }\r\n\r\n      // Ensure a marketplace item exists to reference with a UUID\r\n      const { data: createdMarketplaceItem, error: marketplaceItemError } = await supabase\r\n        .from('marketplace_items')\r\n        .insert([{\r\n          seller_id: shop.owner_id,\r\n          title: item.name,\r\n          description: item.description,\r\n          price_coins: item.price,\r\n          stock: item.stock_quantity ?? null,\r\n          thumbnail_url: item.thumbnail_url ?? null,\r\n          type: item.category,\r\n          status: 'active'\r\n        }])\r\n        .select()\r\n        .single()\r\n\r\n      if (marketplaceItemError) {\r\n        throw marketplaceItemError\r\n      }\r\n\r\n      const marketplaceItemId = createdMarketplaceItem?.id\r\n      if (!marketplaceItemId) {\r\n        throw new Error('Failed to create marketplace item reference')\r\n      }\r\n\r\n      // Create purchase record (uses marketplace item UUID)\r\n      const platformFee = 0\r\n      const sellerEarnings = item.price\r\n\r\n      const { data: purchaseData, error: purchaseError } = await supabase\r\n        .from('marketplace_purchases')\r\n        .insert([{\r\n          buyer_id: user.id,\r\n          seller_id: shop.owner_id,\r\n          item_id: marketplaceItemId,\r\n          price_paid: item.price,\r\n          platform_fee: platformFee,\r\n          seller_earnings: sellerEarnings,\r\n          purchase_date: new Date().toISOString()\r\n        }])\r\n        .select()\r\n        .single()\r\n\r\n      if (purchaseError) throw purchaseError\r\n\r\n      // Update item stock (if limited)\r\n      if (item.stock_quantity !== null) {\r\n        const { error: stockError } = await supabase\r\n          .from('shop_items')\r\n          .update({ stock_quantity: item.stock_quantity - 1 })\r\n          .eq('id', item.id)\r\n\r\n        if (stockError) {\r\n          console.error('Error updating stock:', stockError)\r\n          // Don't fail the purchase for stock update errors\r\n        }\r\n\r\n        // Update local state\r\n        setItems(prev => prev.map(i =>\r\n          i.id === item.id\r\n            ? { ...i, stock_quantity: i.stock_quantity - 1 }\r\n            : i\r\n        ))\r\n      }\r\n\r\n      // Add to user inventory (references marketplace item UUID)\r\n      const { error: inventoryError } = await supabase\r\n        .from('user_inventory')\r\n        .insert([{\r\n          user_id: user.id,\r\n          item_id: marketplaceItemId,\r\n          acquired_at: new Date().toISOString()\r\n        }])\r\n\r\n      if (inventoryError) throw inventoryError\r\n\r\n      const { error: transactionError } = await supabase\r\n        .from('shop_transactions')\r\n        .insert({\r\n          item_id: item.id,\r\n          quantity: 1,\r\n          coins_spent: item.price\r\n        })\r\n\r\n      if (transactionError) throw transactionError\r\n\r\n      // Handle insurance auto-expire\r\n      if (item.category === 'insurance') {\r\n        const expireDate = new Date()\r\n        expireDate.setDate(expireDate.getDate() + 30) // 30 days for insurance\r\n\r\n        const { error: expireError } = await supabase\r\n          .from('user_inventory')\r\n          .update({ expires_at: expireDate.toISOString() })\r\n          .eq('user_id', user.id)\r\n          .eq('item_id', item.id)\r\n          .eq('acquired_at', new Date().toISOString())\r\n\r\n        if (expireError) {\r\n          console.error('Error setting insurance expiration:', expireError)\r\n        }\r\n      }\r\n\r\n      // Create receipt data\r\n      const receipt = {\r\n        id: purchaseData.id,\r\n        item: item,\r\n        shop: shop,\r\n        price: item.price,\r\n        platformFee: platformFee,\r\n        sellerEarnings: sellerEarnings,\r\n        purchaseDate: purchaseData.purchase_date,\r\n        buyerId: user.id\r\n      }\r\n\r\n      setPurchaseReceipt(receipt)\r\n      setShowReceipt(true)\r\n\r\n      toast.success(`Purchased ${item.name}!`)\r\n\r\n    } catch (err: any) {\r\n      console.error('Purchase error:', err)\r\n      toast.error('Purchase failed: ' + err.message)\r\n    } finally {\r\n      setPurchasing(null)\r\n    }\r\n  }\r\n\r\n  if (!user) return null\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <div className=\"animate-pulse\">\r\n            <div className=\"h-8 bg-gray-700 rounded w-1/3 mb-6\"></div>\r\n            <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 text-sm text-yellow-300 mb-6\">\r\n              All sales are final. Illegal items or sales are strictly prohibited and will result in enforcement actions.\r\n            </div>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n              {[1,2,3,4,5,6].map(i => (\r\n                <div key={i} className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C]\">\r\n                  <div className=\"h-4 bg-gray-700 rounded w-1/2 mb-2\"></div>\r\n                  <div className=\"h-8 bg-gray-700 rounded w-3/4\"></div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!shop) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n        <div className=\"max-w-4xl mx-auto text-center py-12\">\r\n          <Store className=\"w-16 h-16 text-gray-500 mx-auto mb-4\" />\r\n          <h2 className=\"text-2xl font-bold mb-2\">Shop Not Found</h2>\r\n          <p className=\"text-gray-400 mb-6\">This shop may have been removed or is no longer available.</p>\r\n          <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 text-sm text-yellow-300 mb-6\">\r\n            All sales are final. Illegal items or sales are strictly prohibited and will result in enforcement actions.\r\n          </div>\r\n          <button\r\n            onClick={() => navigate('/marketplace')}\r\n            className=\"px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold\"\r\n          >\r\n            Back to Marketplace\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <button\r\n              onClick={() => navigate('/marketplace')}\r\n              className=\"p-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors\"\r\n            >\r\n              <ArrowLeft className=\"w-5 h-5\" />\r\n            </button>\r\n            <div>\r\n              <h1 className=\"text-3xl font-bold flex items-center gap-3\">\r\n                <Store className=\"w-8 h-8 text-purple-400\" />\r\n                {shop.name}\r\n              </h1>\r\n              <p className=\"text-gray-400\">Browse and purchase items from this shop</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Shop Info */}\r\n        <div className=\"bg-zinc-900 rounded-xl p-6 border border-purple-500/20\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h2 className=\"text-xl font-semibold text-purple-300\">{shop.name}</h2>\r\n            </div>\r\n            <div className=\"text-right\">\r\n              <p className=\"text-sm text-gray-400\">Items Available</p>\r\n              <p className=\"text-2xl font-bold text-green-400\">{items.length}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Items Grid */}\r\n        {items.length === 0 ? (\r\n          <div className=\"text-center py-12\">\r\n            <Package className=\"w-16 h-16 text-gray-500 mx-auto mb-4\" />\r\n            <h2 className=\"text-2xl font-bold mb-2\">No Items Available</h2>\r\n            <p className=\"text-gray-400\">This shop doesn't have any items listed yet.</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {items.map((item) => (\r\n              <div key={item.id} className=\"bg-zinc-900 rounded-xl p-6 border border-purple-500/20 hover:border-purple-500/40 transition-all\">\r\n                {item.image_url && (\r\n                  <img\r\n                    src={item.image_url}\r\n                    alt={item.name}\r\n                    className=\"w-full h-32 object-cover rounded-lg mb-4\"\r\n                    onError={(e) => {\r\n                      (e.target as HTMLImageElement).style.display = 'none'\r\n                    }}\r\n                  />\r\n                )}\r\n\r\n                <div className=\"mb-4\">\r\n                  <h3 className=\"text-lg font-bold text-purple-300 mb-2\">{item.name}</h3>\r\n                  {item.description && (\r\n                    <p className=\"text-sm text-gray-400 mb-3\">{item.description}</p>\r\n                  )}\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Coins className=\"w-4 h-4 text-yellow-400\" />\r\n                      <span className=\"text-xl font-bold text-yellow-400\">{item.price.toLocaleString()}</span>\r\n                      <span className=\"text-sm text-gray-400\">Troll Coins</span>\r\n                    </div>\r\n                    {item.stock_quantity !== null && (\r\n                      <div className=\"text-xs text-gray-400\">\r\n                        {item.item_type === 'broadcast_consumable' ? '' : (item.stock_quantity > 0 ? `${item.stock_quantity} left` : 'Out of stock')}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                <button\r\n                  onClick={() => purchaseItem(item)}\r\n                  disabled={purchasing === item.id || (item.stock_quantity !== null && item.stock_quantity <= 0)}\r\n                  className=\"w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\r\n                >\r\n                  {purchasing === item.id ? (\r\n                    <>Processing...</>\r\n                  ) : item.stock_quantity !== null && item.stock_quantity <= 0 ? (\r\n                    <>{item.item_type !== 'broadcast_consumable' && <>Out of Stock</>}</>\r\n                  ) : (\r\n                    <>\r\n                      <ShoppingCart className=\"w-4 h-4\" />\r\n                      Purchase\r\n                    </>\r\n                  )}\r\n                </button>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {/* Purchase Receipt Modal */}\r\n        {showReceipt && purchaseReceipt && (\r\n          <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-zinc-900 rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <h3 className=\"text-xl font-bold flex items-center gap-2\">\r\n                  <Receipt className=\"w-5 h-5 text-green-400\" />\r\n                  Purchase Receipt\r\n                </h3>\r\n                <button\r\n                  onClick={() => {\r\n                    setShowReceipt(false)\r\n                    setPurchaseReceipt(null)\r\n                    navigate('/inventory')\r\n                  }}\r\n                  className=\"p-1 hover:bg-zinc-700 rounded\"\r\n                >\r\n                  <X className=\"w-5 h-5\" />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                {/* Item Details */}\r\n                <div className=\"bg-zinc-800 rounded-lg p-4\">\r\n                  <div className=\"flex items-center gap-3 mb-3\">\r\n                    {purchaseReceipt.item.image_url && (\r\n                      <img\r\n                        src={purchaseReceipt.item.image_url}\r\n                        alt={purchaseReceipt.item.name}\r\n                        className=\"w-12 h-12 object-cover rounded\"\r\n                      />\r\n                    )}\r\n                    <div>\r\n                      <h4 className=\"font-semibold text-purple-300\">{purchaseReceipt.item.name}</h4>\r\n                      <p className=\"text-sm text-gray-400\">from {purchaseReceipt.shop.name}</p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {purchaseReceipt.item.description && (\r\n                    <p className=\"text-sm text-gray-300 mb-3\">{purchaseReceipt.item.description}</p>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Transaction Details */}\r\n                <div className=\"bg-zinc-800 rounded-lg p-4 space-y-2\">\r\n                  <div className=\"flex justify-between text-sm\">\r\n                    <span>Item Price:</span>\r\n                    <span className=\"text-yellow-400\">{purchaseReceipt.price.toLocaleString()} coins</span>\r\n                  </div>\r\n                  {purchaseReceipt.platformFee > 0 && (\r\n                    <>\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>Platform Fee:</span>\r\n                        <span className=\"text-red-400\">-{purchaseReceipt.platformFee} coins</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between text-sm font-semibold border-t border-zinc-600 pt-2\">\r\n                        <span>Seller Earnings:</span>\r\n                        <span className=\"text-green-400\">{purchaseReceipt.sellerEarnings} coins</span>\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Receipt Info */}\r\n                <div className=\"bg-zinc-800 rounded-lg p-4 space-y-2 text-sm\">\r\n                  <div className=\"flex justify-between\">\r\n                    <span>Receipt ID:</span>\r\n                    <span className=\"font-mono text-xs\">{purchaseReceipt.id.slice(0, 8)}...</span>\r\n                  </div>\r\n                  <div className=\"flex justify-between\">\r\n                    <span>Purchase Date:</span>\r\n                    <span>{new Date(purchaseReceipt.purchaseDate).toLocaleString()}</span>\r\n                  </div>\r\n                  <div className=\"flex justify-between\">\r\n                    <span>Buyer ID:</span>\r\n                    <span className=\"font-mono text-xs\">{purchaseReceipt.buyerId.slice(0, 8)}...</span>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Insurance Notice */}\r\n                {purchaseReceipt.item.category === 'insurance' && (\r\n                  <div className=\"bg-blue-900/30 border border-blue-500/30 rounded-lg p-4\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <Package className=\"w-4 h-4 text-blue-400\" />\r\n                      <span className=\"font-semibold text-blue-400\">Insurance Item</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-gray-300\">\r\n                      This insurance policy will automatically expire 30 days from purchase.\r\n                      You can view its status in your inventory.\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"flex gap-3 mt-6\">\r\n                <button\r\n                  onClick={() => {\r\n                    setShowReceipt(false)\r\n                    setPurchaseReceipt(null)\r\n                    navigate('/inventory')\r\n                  }}\r\n                  className=\"flex-1 py-2 bg-purple-600 hover:bg-purple-700 rounded font-semibold transition-colors\"\r\n                >\r\n                  View in Inventory\r\n                </button>\r\n                <button\r\n                  onClick={() => {\r\n                    setShowReceipt(false)\r\n                    setPurchaseReceipt(null)\r\n                  }}\r\n                  className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold transition-colors\"\r\n                >\r\n                  Close\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Stats.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'balances.trollmonds'. Either include it or remove the dependency array.","line":118,"column":6,"nodeType":"ArrayExpression","endLine":118,"endColumn":158,"suggestions":[{"desc":"Update the dependencies array to be: [user.id, level, xpTotal, xpToNext, profile?.role, profile?.troll_role, balances.troll_coins, balances.paid_coins, fetchXP, subscribeToXP, unsubscribe, balances.trollmonds]","fix":{"range":[3737,3889],"text":"[user.id, level, xpTotal, xpToNext, profile?.role, profile?.troll_role, balances.troll_coins, balances.paid_coins, fetchXP, subscribeToXP, unsubscribe, balances.trollmonds]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { useCoins } from '../lib/hooks/useCoins'\r\nimport { supabase } from '../lib/supabase'\r\nimport { getFamilySeasonStats } from '../lib/familySeasons'\r\nimport { useXPStore } from '../stores/useXPStore'\r\nimport { useCreditScore } from '../lib/hooks/useCreditScore'\r\nimport CreditScoreBadge from '../components/CreditScoreBadge'\r\nimport { Crown, Sword, Trophy, Coins, Star, TrendingUp, Shield } from 'lucide-react'\r\n\r\ninterface UserStats {\r\n  level: number\r\n  xp: number\r\n  totalXp: number\r\n  nextLevelXp: number\r\n  troll_coins: number\r\n  paid_coins: number\r\n  familyName?: string\r\n  familyLevel?: number\r\n  familyXp?: number\r\n  seasonScore?: number\r\n  warWins?: number\r\n  warLosses?: number\r\n  warStreak?: string\r\n  warTier?: string\r\n  badges: string[]\r\n}\r\n\r\nexport default function Stats() {\r\n  const { user, profile } = useAuthStore()\r\n  const { balances, loading: coinsLoading } = useCoins()\r\n  const { xpTotal, level, xpToNext, progress, fetchXP, subscribeToXP, unsubscribe } = useXPStore()\r\n  const { data: creditData, loading: creditLoading } = useCreditScore()\r\n  const [stats, setStats] = useState<UserStats | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    const loadStats = async () => {\r\n      if (!user?.id) return\r\n\r\n      try {\r\n        setLoading(true)\r\n\r\n        // Fetch XP from store and subscribe to real-time updates\r\n        await fetchXP(user.id)\r\n        subscribeToXP(user.id)\r\n\r\n        // Load family data\r\n        let familyData = null\r\n        const { data: familyMember } = await supabase\r\n          .from('family_members')\r\n          .select('family_id, role')\r\n          .eq('user_id', user.id)\r\n          .maybeSingle()\r\n\r\n        if (familyMember?.family_id) {\r\n          const familyStats = await getFamilySeasonStats(familyMember.family_id)\r\n          const { data: family, error: familyError2 } = await supabase\r\n            .from('troll_families')\r\n            .select('name')\r\n            .eq('id', familyMember.family_id)\r\n            .maybeSingle()\r\n\r\n          if (familyError2) {\r\n            console.error('Error fetching family:', familyError2)\r\n          }\r\n\r\n          if (family) {\r\n            familyData = {\r\n              familyName: family.name,\r\n              familyLevel: familyStats.seasonRank || 1,\r\n              familyXp: familyStats.weeklyCoins || 0,\r\n              seasonScore: familyStats.seasonCoins || 0\r\n            }\r\n          }\r\n        }\r\n\r\n        // Load war stats (placeholder for now)\r\n        const warStats = {\r\n          warWins: 0,\r\n          warLosses: 0,\r\n          warStreak: 0,\r\n          warTier: 'Bronze'\r\n        }\r\n\r\n        // Calculate badges\r\n        const badges = []\r\n        if (profile?.role === 'admin' || profile?.troll_role === 'admin') badges.push('üõ°Ô∏è Admin')\r\n        if (familyMember) badges.push('‚öîÔ∏è Family War')\r\n        if (level >= 10) badges.push('üëë Top Rank')\r\n        if (balances.paid_coins > 1000) badges.push('üí∞ Big Spender')\r\n        if (balances.trollmonds > 100) badges.push('üíé Diamond Holder')\r\n\r\n        setStats({\r\n          level: level,\r\n          xp: xpTotal,\r\n          totalXp: xpTotal,\r\n          nextLevelXp: xpToNext + xpTotal,\r\n          troll_coins: balances.troll_coins || 0,\r\n          paid_coins: balances.paid_coins || 0,\r\n          trollmonds: balances.trollmonds || 0,\r\n          ...familyData,\r\n          ...warStats,\r\n          badges\r\n        })\r\n      } catch (error) {\r\n        console.error('Failed to load stats:', error)\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n\r\n    loadStats()\r\n\r\n    return () => {\r\n      unsubscribe()\r\n    }\r\n  }, [user?.id, level, xpTotal, xpToNext, profile?.role, profile?.troll_role, balances.troll_coins, balances.paid_coins, fetchXP, subscribeToXP, unsubscribe])\r\n\r\n  const computedProgress =\r\n    progress === 0 || progress\r\n      ? (progress ?? 0) * 100\r\n      : stats\r\n        ? (stats.level / (stats.level + 1)) * 100\r\n        : 0\r\n\r\n  const levelProgress = Math.min(computedProgress, 100)\r\n  const familyXpProgress = stats?.familyXp ? Math.min((stats.familyXp / 1000) * 100, 100) : 0\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-8\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-400 bg-clip-text text-transparent mb-2\">\r\n            Player Stats\r\n          </h1>\r\n          <p className=\"text-gray-400\">View your comprehensive game statistics and achievements</p>\r\n        </div>\r\n\r\n        {loading || coinsLoading ? (\r\n          <div className=\"text-center py-12 text-gray-400\">Loading stats...</div>\r\n        ) : stats ? (\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* LEVEL & XP */}\r\n            <div className=\"bg-[#1A1A24] border border-purple-500/30 rounded-2xl p-6 hover:border-purple-500/60 transition-colors\">\r\n              <h3 className=\"text-purple-300 font-semibold mb-4 flex items-center gap-2 text-lg\">\r\n                <Star className=\"w-5 h-5\" />\r\n                LEVEL & XP\r\n              </h3>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"text-white font-bold text-2xl\">Level {stats.level}</span>\r\n                  <span className=\"text-gray-300 text-sm\">\r\n                    {stats.level} ‚Üí {stats.level + 1}\r\n                  </span>\r\n                </div>\r\n                <div className=\"w-full bg-[#2A2A34] rounded-full h-4 overflow-hidden\">\r\n                  <div\r\n                    className=\"h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full transition-all duration-300\"\r\n                    style={{ width: `${levelProgress}%` }}\r\n                  />\r\n                </div>\r\n                <div className=\"text-center text-sm text-gray-400\">\r\n                  {Math.round(levelProgress)}% to next level\r\n                </div>\r\n                <div className=\"pt-4 border-t border-[#2C2C2C] space-y-2\">\r\n                  <div className=\"flex justify-between items-center text-sm text-gray-300\">\r\n                    <span>Current Level</span>\r\n                    <span className=\"text-purple-400 font-semibold\">{stats.level} / 2000</span>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2 text-xs text-green-400\">\r\n                    <TrendingUp className=\"w-3 h-3\" />\r\n                    <span>Real-time sync enabled</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* CREDIT SCORE */}\r\n            <div className=\"bg-[#0F172A] border border-emerald-500/30 rounded-2xl p-6 hover:border-emerald-500/60 transition-colors\">\r\n              <h3 className=\"text-emerald-300 font-semibold mb-4 flex items-center gap-2 text-lg\">\r\n                <Shield className=\"w-5 h-5\" />\r\n                CREDIT SCORE\r\n              </h3>\r\n              <CreditScoreBadge\r\n                score={creditData?.score}\r\n                tier={creditData?.tier}\r\n                trend7d={creditData?.trend_7d}\r\n                loading={creditLoading}\r\n              />\r\n              <p className=\"text-xs text-gray-400 mt-3\">\r\n                Public credit score (0-800) reflecting reliability, loans, and community behavior.\r\n              </p>\r\n            </div>\r\n\r\n            {/* FAMILY STATUS */}\r\n            {stats.familyName && (\r\n              <div className=\"bg-[#1A1A24] border border-cyan-500/30 rounded-2xl p-6 hover:border-cyan-500/60 transition-colors\">\r\n                <h3 className=\"text-cyan-300 font-semibold mb-4 flex items-center gap-2 text-lg\">\r\n                  <Crown className=\"w-5 h-5\" />\r\n                  FAMILY STATUS\r\n                </h3>\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"flex justify-between items-center\">\r\n                    <span className=\"text-white font-bold text-xl flex items-center gap-2\">\r\n                      üî• {stats.familyName}\r\n                    </span>\r\n                    <span className=\"text-cyan-300 font-semibold\">Level {stats.familyLevel}</span>\r\n                  </div>\r\n                  <div className=\"bg-[#2A2A34] rounded-lg p-3 space-y-2\">\r\n                    <div className=\"text-sm text-gray-300\">\r\n                      Family XP: <span className=\"text-cyan-400 font-semibold\">{stats.familyXp?.toLocaleString() || 0}</span>\r\n                    </div>\r\n                    <div className=\"w-full bg-black/50 rounded-full h-2 overflow-hidden\">\r\n                      <div\r\n                        className=\"h-full bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full\"\r\n                        style={{ width: `${familyXpProgress}%` }}\r\n                      />\r\n                    </div>\r\n                    <div className=\"text-sm text-gray-300 pt-2 border-t border-[#1A1A24]\">\r\n                      Season Score: <span className=\"text-cyan-400 font-semibold\">{stats.seasonScore?.toLocaleString() || 0}</span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* BATTLE / WAR STATS */}\r\n            <div className=\"bg-[#1A1A24] border border-red-500/30 rounded-2xl p-6 hover:border-red-500/60 transition-colors\">\r\n              <h3 className=\"text-red-300 font-semibold mb-4 flex items-center gap-2 text-lg\">\r\n                <Sword className=\"w-5 h-5\" />\r\n                BATTLE / WAR STATS\r\n              </h3>\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"bg-[#2A2A34] rounded-lg p-4 space-y-2\">\r\n                  <div className=\"text-sm text-gray-400\">Wins</div>\r\n                  <div className=\"text-3xl font-bold text-green-400\">{stats.warWins}</div>\r\n                </div>\r\n                <div className=\"bg-[#2A2A34] rounded-lg p-4 space-y-2\">\r\n                  <div className=\"text-sm text-gray-400\">Losses</div>\r\n                  <div className=\"text-3xl font-bold text-red-400\">{stats.warLosses}</div>\r\n                </div>\r\n                <div className=\"bg-[#2A2A34] rounded-lg p-4 space-y-2\">\r\n                  <div className=\"text-sm text-gray-400\">Streak</div>\r\n                  <div className=\"text-3xl font-bold text-orange-400 flex items-center gap-2\">\r\n                    {stats.warStreak}\r\n                    {Number(stats.warStreak) > 0 && <span className=\"text-2xl\">üî•</span>}\r\n                  </div>\r\n                </div>\r\n                <div className=\"bg-[#2A2A34] rounded-lg p-4 space-y-2\">\r\n                  <div className=\"text-sm text-gray-400\">Tier</div>\r\n                  <div className=\"text-xl font-bold text-yellow-400\">{stats.warTier}</div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* CURRENCY */}\r\n            <div className=\"bg-[#1A1A24] border border-green-500/30 rounded-2xl p-6 hover:border-green-500/60 transition-colors\">\r\n              <h3 className=\"text-green-300 font-semibold mb-4 flex items-center gap-2 text-lg\">\r\n                <Coins className=\"w-5 h-5\" />\r\n                CURRENCY & ASSETS\r\n              </h3>\r\n              <div className=\"space-y-3\">\r\n                <div className=\"bg-[#2A2A34] rounded-lg p-4 flex justify-between items-center\">\r\n                  <span className=\"text-white flex items-center gap-2\">\r\n                    <span className=\"text-2xl\">üé´</span>\r\n                    Troll Coins\r\n                  </span>\r\n                  <span className=\"font-bold text-yellow-400 text-xl\">\r\n                    {stats.troll_coins.toLocaleString()}\r\n                  </span>\r\n                </div>\r\n                <div className=\"bg-[#2A2A34] rounded-lg p-4 flex justify-between items-center relative group\">\r\n                  <span className=\"text-white flex items-center gap-2\">\r\n                    <span className=\"text-2xl\">üí∞</span>\r\n                    Gifted Coins\r\n                  </span>\r\n                  <span className=\"font-bold text-green-400 text-xl\">\r\n                    {stats.paid_coins.toLocaleString()}\r\n                  </span>\r\n                  <div className=\"absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap\">\r\n                    Purchased/Gifted Coins\r\n                  </div>\r\n                </div>\r\n                <div className=\"bg-[#1A1A24] border border-white/10 rounded-lg p-4\">\r\n                  <div className=\"flex justify-between items-center mb-2\">\r\n                    <span className=\"text-gray-300\">Total Coins Value</span>\r\n                    <span className=\"font-bold text-yellow-400 text-lg\">\r\n                      ${((stats.troll_coins * 0.0001) + (stats.paid_coins * 0.0001)).toFixed(2)}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"text-xs text-gray-500\">\r\n                    Estimated value based on current rates\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* BADGES */}\r\n            <div className=\"bg-[#1A1A24] border border-yellow-500/30 rounded-2xl p-6 hover:border-yellow-500/60 transition-colors lg:col-span-2\">\r\n              <h3 className=\"text-yellow-300 font-semibold mb-4 flex items-center gap-2 text-lg\">\r\n                <Trophy className=\"w-5 h-5\" />\r\n                BADGES & ACHIEVEMENTS\r\n              </h3>\r\n              <div className=\"flex flex-wrap gap-3\">\r\n                {stats.badges.length > 0 ? (\r\n                  stats.badges.map((badge, index) => (\r\n                    <span\r\n                      key={index}\r\n                      className=\"px-4 py-2 bg-yellow-500/20 border border-yellow-500/40 rounded-full text-yellow-300 font-medium hover:border-yellow-500/60 transition-colors\"\r\n                    >\r\n                      {badge}\r\n                    </span>\r\n                  ))\r\n                ) : (\r\n                  <span className=\"text-gray-400\">No badges earned yet. Keep playing to unlock achievements!</span>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-center py-12 text-gray-400\">Failed to load stats</div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\StreamPicture.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Support.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'profile?.is_admin'. Either include it or remove the dependency array.","line":29,"column":6,"nodeType":"ArrayExpression","endLine":29,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [profile?.role, navigate, profile?.is_admin]","fix":{"range":[876,901],"text":"[profile?.role, navigate, profile?.is_admin]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { notifyAdmins } from '../lib/notifications'\r\nimport { toast } from 'sonner'\r\nimport { FileText, Send, Trash2 } from 'lucide-react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport api from '../lib/api'\r\n\r\ninterface UserTicket {\r\n  id: string\r\n  subject: string\r\n  category: string\r\n  message: string\r\n  status: string\r\n  created_at: string\r\n  admin_response?: string\r\n}\r\n\r\nexport default function Support() {\r\n  const { user, profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n\r\n  // If user is admin, redirect to admin dashboard support tab\r\n  useEffect(() => {\r\n    if (profile?.role === 'admin' || profile?.is_admin) {\r\n      navigate('/admin/support-tickets', { replace: true })\r\n    }\r\n  }, [profile?.role, navigate])\r\n  const [subject, setSubject] = useState('')\r\n  const [category, setCategory] = useState<'general' | 'appeal'>('general')\r\n  const [message, setMessage] = useState('')\r\n  const [reportId, setReportId] = useState('')\r\n  const [loading, setLoading] = useState(false)\r\n  const [myTickets, setMyTickets] = useState<UserTicket[]>([])\r\n  const [loadingTickets, setLoadingTickets] = useState(false)\r\n\r\n  const loadMyTickets = useCallback(async () => {\r\n    if (!user?.id) return\r\n    setLoadingTickets(true)\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('support_tickets')\r\n        .select('id, subject, category, message, status, created_at, admin_response')\r\n        .eq('user_id', user.id)\r\n        .order('created_at', { ascending: false })\r\n      \r\n      if (error) throw error\r\n      setMyTickets(data || [])\r\n    } catch (err) {\r\n      console.error('Failed to load tickets:', err)\r\n    } finally {\r\n      setLoadingTickets(false)\r\n    }\r\n  }, [user?.id])\r\n\r\n  useEffect(() => {\r\n    loadMyTickets()\r\n  }, [loadMyTickets])\r\n\r\n  const deleteMyTicket = async (ticketId: string) => {\r\n    if (!confirm('Delete this ticket permanently?')) return\r\n    \r\n    try {\r\n      // Optimistically remove from UI\r\n      setMyTickets(prev => prev.filter(t => t.id !== ticketId))\r\n      \r\n      const { error } = await supabase\r\n        .from('support_tickets')\r\n        .delete()\r\n        .eq('id', ticketId)\r\n        .eq('user_id', user?.id) // Extra safety check\r\n      \r\n      if (error) {\r\n        toast.error('Failed to delete ticket')\r\n        // Reload on error\r\n        loadMyTickets()\r\n      } else {\r\n        toast.success('Ticket deleted')\r\n      }\r\n    } catch (err) {\r\n      console.error('Delete failed:', err)\r\n      toast.error('Failed to delete ticket')\r\n      loadMyTickets()\r\n    }\r\n  }\r\n\r\n  const submit = async () => {\r\n    if (!user || !profile) { toast.error('Sign in required'); return }\r\n    if (!subject.trim() || !message.trim()) { toast.error('Enter subject and message'); return }\r\n    setLoading(true)\r\n    try {\r\n      // If appeal, submit as moderation report\r\n      if (category === 'appeal') {\r\n        const response = await api.post('/moderation', {\r\n          action: 'submit_report',\r\n          reporter_id: profile.id,\r\n          target_user_id: null,\r\n          stream_id: null,\r\n          reason: 'appeal',\r\n          description: `Subject: ${subject}\\n\\nReport ID: ${reportId || 'N/A'}\\n\\nMessage: ${message}`\r\n        })\r\n\r\n        if (response.success) {\r\n          toast.success('Appeal submitted. Our Troll Officers will review soon.')\r\n          setSubject('')\r\n          setMessage('')\r\n          setReportId('')\r\n          setCategory('general')\r\n        } else {\r\n          toast.error(response.error || 'Failed to submit appeal')\r\n        }\r\n      } else {\r\n        // Regular support ticket\r\n        const payload = {\r\n          user_id: profile.id,\r\n          username: profile.username,\r\n          email: user.email,\r\n          subject: subject.trim(),\r\n          category,\r\n          message: message.trim(),\r\n          status: 'open',\r\n          created_at: new Date().toISOString()\r\n        }\r\n        const { data: ticket, error } = await supabase.from('support_tickets').insert([payload]).select().single()\r\n        if (!error && ticket) {\r\n          // Notify admins\r\n          await notifyAdmins(\r\n            'New Support Ticket',\r\n            `${profile.username}: ${subject}`,\r\n            'support_ticket',\r\n            { ticketId: ticket.id, userId: profile.id, category: payload.category }\r\n          )\r\n        }\r\n        \r\n        if (!error) {\r\n          toast.success('Support ticket submitted')\r\n          setSubject('')\r\n          setMessage('')\r\n          setCategory('general')\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Support submission error:', err)\r\n      toast.error('Failed to submit')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#05030B] text-white p-6\">\r\n      <div className=\"max-w-3xl mx-auto\">\r\n        <h1 className=\"text-3xl font-extrabold mb-2 flex items-center gap-2\">\r\n          <FileText className=\"text-troll-gold w-7 h-7\" />\r\n          Support Ticket\r\n        </h1>\r\n        <p className=\"text-sm text-gray-300 mb-4\">Having issues with the app or payouts? Send a message to Admin.</p>\r\n\r\n        <div className=\"bg-[#0E0A1A] rounded-xl border border-purple-700/40 p-6 space-y-4\">\r\n          <div>\r\n            <label className=\"block text-sm mb-1\">Subject</label>\r\n            <input value={subject} onChange={e=>setSubject(e.target.value)} className=\"w-full bg-[#171427] border border-purple-500/40 rounded px-3 py-2 text-sm\" placeholder=\"Issue summary\" />\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm mb-1\">Category</label>\r\n            <select value={category} onChange={e=>setCategory(e.target.value as 'general' | 'appeal')} className=\"w-full bg-[#171427] border border-purple-500/40 rounded px-3 py-2 text-sm\">\r\n              <option value=\"general\">General Support</option>\r\n              <option value=\"appeal\">Appeal Moderation Action</option>\r\n              <option value=\"payouts\">Payouts</option>\r\n              <option value=\"payments\">Payments</option>\r\n              <option value=\"streams\">Streams</option>\r\n              <option value=\"account\">Account</option>\r\n            </select>\r\n            \r\n            {category === 'appeal' && (\r\n              <div>\r\n                <label className=\"block text-sm mb-1\">Report ID (Optional)</label>\r\n                <input \r\n                  type=\"text\"\r\n                  value={reportId}\r\n                  onChange={e => setReportId(e.target.value)}\r\n                  placeholder=\"Enter the report ID if you have it...\"\r\n                  className=\"w-full bg-[#171427] border border-purple-500/40 rounded px-3 py-2 text-sm\"\r\n                />\r\n              </div>\r\n            )}\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm mb-1\">Message</label>\r\n            <textarea value={message} onChange={e=>setMessage(e.target.value)} rows={6} className=\"w-full bg-[#171427] border border-purple-500/40 rounded px-3 py-2 text-sm\" placeholder=\"Describe the issue, steps to reproduce, screenshots/links (optional)\" />\r\n          </div>\r\n          <button onClick={submit} disabled={loading} className=\"w-full mt-2 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-60\">\r\n            {loading ? 'Submitting‚Ä¶' : (<><Send className=\"w-4 h-4\" /> Submit Ticket</>)}\r\n          </button>\r\n        </div>\r\n\r\n        {/* My Tickets Section */}\r\n        <div className=\"mt-8\">\r\n          <h2 className=\"text-2xl font-bold mb-4\">My Tickets</h2>\r\n          {loadingTickets ? (\r\n            <p className=\"text-gray-400 text-center py-8\">Loading tickets...</p>\r\n          ) : myTickets.length === 0 ? (\r\n            <p className=\"text-gray-400 text-center py-8\">No tickets submitted yet.</p>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {myTickets.map(ticket => (\r\n                <div key={ticket.id} className=\"bg-[#0E0A1A] rounded-xl border border-purple-700/40 p-4\">\r\n                  <div className=\"flex justify-between items-start mb-2\">\r\n                    <div className=\"flex-1\">\r\n                      <h3 className=\"font-bold text-white\">{ticket.subject}</h3>\r\n                      <div className=\"flex gap-2 items-center mt-1\">\r\n                        <span className=\"text-xs px-2 py-1 rounded bg-purple-900/50 text-purple-200\">{ticket.category}</span>\r\n                        <span className={`text-xs px-2 py-1 rounded ${\r\n                          ticket.status === 'resolved' ? 'bg-green-900/50 text-green-200' : \r\n                          ticket.status === 'closed' ? 'bg-gray-700 text-gray-300' : \r\n                          'bg-yellow-900/50 text-yellow-200'\r\n                        }`}>{ticket.status}</span>\r\n                        <span className=\"text-xs text-gray-400\">{new Date(ticket.created_at).toLocaleDateString()}</span>\r\n                      </div>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => deleteMyTicket(ticket.id)}\r\n                      className=\"p-2 hover:bg-red-900/30 rounded-lg transition-colors text-red-400 hover:text-red-300\"\r\n                      title=\"Delete ticket\"\r\n                    >\r\n                      <Trash2 className=\"w-4 h-4\" />\r\n                    </button>\r\n                  </div>\r\n                  <p className=\"text-sm text-gray-300 mt-2\">{ticket.message}</p>\r\n                  {ticket.admin_response && (\r\n                    <div className=\"mt-3 p-3 bg-green-900/20 border border-green-700/30 rounded-lg\">\r\n                      <p className=\"text-xs text-green-400 font-semibold mb-1\">Admin Response:</p>\r\n                      <p className=\"text-sm text-gray-200\">{ticket.admin_response}</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TCPS.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TMVPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TaxOnboarding.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":95,"column":24,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3209,3428],"text":"\r\n              Since you&apos;ve earned $600+ this year, we must collect your tax information for IRS reporting (Form 1099).\r\n              This information is securely stored and only used for tax compliance.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3209,3428],"text":"\r\n              Since you&lsquo;ve earned $600+ this year, we must collect your tax information for IRS reporting (Form 1099).\r\n              This information is securely stored and only used for tax compliance.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3209,3428],"text":"\r\n              Since you&#39;ve earned $600+ this year, we must collect your tax information for IRS reporting (Form 1099).\r\n              This information is securely stored and only used for tax compliance.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3209,3428],"text":"\r\n              Since you&rsquo;ve earned $600+ this year, we must collect your tax information for IRS reporting (Form 1099).\r\n              This information is securely stored and only used for tax compliance.\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { supabase } from '../lib/supabase';\r\nimport { toast } from 'sonner';\r\nimport { ArrowLeft, FileText } from 'lucide-react';\r\n\r\nexport default function TaxOnboarding() {\r\n  const { profile } = useAuthStore();\r\n  const navigate = useNavigate();\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [formData, setFormData] = useState({\r\n    fullName: '',\r\n    email: profile?.email || '',\r\n    ssn: '',\r\n    ein: '',\r\n    address: '',\r\n    city: '',\r\n    state: '',\r\n    zipCode: '',\r\n    taxClassification: 'individual', // individual or business\r\n    agreed: false\r\n  });\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!formData.agreed) {\r\n      toast.error('You must agree to the terms');\r\n      return;\r\n    }\r\n\r\n    if (!formData.fullName || !formData.email || (!formData.ssn && !formData.ein)) {\r\n      toast.error('Please fill in all required fields');\r\n      return;\r\n    }\r\n\r\n    setSubmitting(true);\r\n    try {\r\n      // Save tax information\r\n      const { error } = await supabase\r\n        .from('user_tax_info')\r\n        .upsert({\r\n          user_id: profile?.id,\r\n          full_name: formData.fullName,\r\n          email: formData.email,\r\n          ssn: formData.ssn || null,\r\n          ein: formData.ein || null,\r\n          address: formData.address,\r\n          city: formData.city,\r\n          state: formData.state,\r\n          zip_code: formData.zipCode,\r\n          tax_classification: formData.taxClassification,\r\n          w9_completed: true,\r\n          updated_at: new Date().toISOString()\r\n        });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Tax information saved successfully');\r\n      navigate('/profile');\r\n    } catch (error: any) {\r\n      console.error('Error saving tax info:', error);\r\n      toast.error('Failed to save tax information');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (!profile) {\r\n    return <div className=\"min-h-screen bg-[#0A0814] text-white flex items-center justify-center\">Loading...</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white\">\r\n      <div className=\"max-w-2xl mx-auto p-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center gap-4 mb-8\">\r\n          <button\r\n            onClick={() => navigate(-1)}\r\n            className=\"p-2 rounded-lg bg-[#1A1A1A] border border-[#2C2C2C] hover:bg-[#2A2A2A] transition\"\r\n          >\r\n            <ArrowLeft className=\"w-5 h-5\" />\r\n          </button>\r\n          <FileText className=\"w-8 h-8 text-troll-neon-blue\" />\r\n          <h1 className=\"text-3xl font-bold bg-gradient-to-r from-purple-400 to-green-400 bg-clip-text text-transparent\">\r\n            Tax Information (W-9)\r\n          </h1>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-8\">\r\n          <div className=\"mb-6\">\r\n            <h2 className=\"text-xl font-bold text-white mb-2\">Why We Need This</h2>\r\n            <p className=\"text-gray-300 text-sm\">\r\n              Since you've earned $600+ this year, we must collect your tax information for IRS reporting (Form 1099).\r\n              This information is securely stored and only used for tax compliance.\r\n            </p>\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n            {/* Tax Classification */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                Tax Classification *\r\n              </label>\r\n              <select\r\n                value={formData.taxClassification}\r\n                onChange={(e) => setFormData(prev => ({ ...prev, taxClassification: e.target.value }))}\r\n                className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                required\r\n              >\r\n                <option value=\"individual\">Individual/sole proprietor</option>\r\n                <option value=\"business\">Business entity (LLC, Corp, etc.)</option>\r\n              </select>\r\n            </div>\r\n\r\n            {/* Full Name */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                Full Legal Name *\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.fullName}\r\n                onChange={(e) => setFormData(prev => ({ ...prev, fullName: e.target.value }))}\r\n                className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                placeholder=\"As it appears on your tax documents\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                Email Address *\r\n              </label>\r\n              <input\r\n                type=\"email\"\r\n                value={formData.email}\r\n                onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}\r\n                className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            {/* SSN or EIN */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  SSN (Last 4 Digits)\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.ssn}\r\n                  onChange={(e) => {\r\n                    const val = e.target.value.replace(/\\D/g, '').slice(0, 4);\r\n                    setFormData(prev => ({ ...prev, ssn: val }));\r\n                  }}\r\n                  className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                  placeholder=\"XXXX\"\r\n                  pattern=\"\\d{4}\"\r\n                  maxLength={4}\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  Employer ID Number (EIN)\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.ein}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, ein: e.target.value }))}\r\n                  className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                  placeholder=\"XX-XXXXXXX\"\r\n                  pattern=\"\\d{2}-\\d{7}\"\r\n                />\r\n              </div>\r\n            </div>\r\n            <p className=\"text-xs text-gray-400\">* One of SSN or EIN is required</p>\r\n\r\n            {/* Address */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                Street Address *\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.address}\r\n                onChange={(e) => setFormData(prev => ({ ...prev, address: e.target.value }))}\r\n                className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            {/* City, State, ZIP */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  City *\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.city}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, city: e.target.value }))}\r\n                  className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                  required\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  State *\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.state}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, state: e.target.value }))}\r\n                  className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                  required\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  ZIP Code *\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.zipCode}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, zipCode: e.target.value }))}\r\n                  className=\"w-full px-3 py-2 bg-[#0D0D1A] border border-[#2C2C2C] rounded-lg text-white focus:border-troll-purple\"\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Agreement */}\r\n            <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4\">\r\n              <label className=\"flex items-start gap-3 cursor-pointer\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={formData.agreed}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, agreed: e.target.checked }))}\r\n                  className=\"mt-1 w-5 h-5 accent-troll-purple\"\r\n                />\r\n                <span className=\"text-gray-300 text-sm\">\r\n                  I certify that the information provided is true and correct.\r\n                  I understand that false information may result in penalties under federal law.\r\n                  I authorize Troll City to report my earnings to the IRS.\r\n                </span>\r\n              </label>\r\n            </div>\r\n\r\n            {/* Submit Button */}\r\n            <button\r\n              type=\"submit\"\r\n              disabled={submitting || !formData.agreed}\r\n              className=\"w-full px-6 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold rounded-lg\r\n                       disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 transition transform\"\r\n            >\r\n              {submitting ? 'Saving...' : 'Save Tax Information'}\r\n            </button>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TaxUpload.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":236,"column":20,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You&apos;ll be notified once it's processed.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You&lsquo;ll be notified once it's processed.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You&#39;ll be notified once it's processed.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You&rsquo;ll be notified once it's processed.\r\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":236,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You'll be notified once it&apos;s processed.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You'll be notified once it&lsquo;s processed.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You'll be notified once it&#39;s processed.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[9100,9255],"text":"\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You'll be notified once it&rsquo;s processed.\r\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { Upload, FileText, CheckCircle2, XCircle, AlertTriangle } from 'lucide-react'\r\n\r\nexport default function TaxUploadPage() {\r\n  const { user, profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [file, setFile] = useState<File | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n  const [uploaded, setUploaded] = useState(false)\r\n\r\n  if (!user) {\r\n    navigate('/')\r\n    return null\r\n  }\r\n\r\n  const uploadTaxForm = async () => {\r\n    if (!file || !user) {\r\n      toast.error('Please select a file')\r\n      return\r\n    }\r\n\r\n    // Validate file type\r\n    if (file.type !== 'application/pdf') {\r\n      toast.error('Only PDF files are accepted')\r\n      return\r\n    }\r\n\r\n    // Validate file size (max 10MB)\r\n    if (file.size > 10 * 1024 * 1024) {\r\n      toast.error('File size must be less than 10MB')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n\r\n    try {\r\n      // Upload to Supabase Storage\r\n      const filePath = `w9/${user.id}_${Date.now()}.pdf`\r\n      const { error: uploadError } = await supabase.storage\r\n        .from('tax_forms')\r\n        .upload(filePath, file, { \r\n          upsert: false,\r\n          contentType: 'application/pdf'\r\n        })\r\n\r\n      if (uploadError) {\r\n        console.error('Upload error:', uploadError)\r\n        throw uploadError\r\n      }\r\n\r\n      // Get public URL (or signed URL for private bucket)\r\n      supabase.storage\r\n        .from('tax_forms')\r\n        .getPublicUrl(filePath)\r\n\r\n      // Update user profile\r\n      const { error: updateError } = await supabase\r\n        .from('user_profiles')\r\n        .update({\r\n          tax_form_url: filePath, // Store path, not full URL\r\n          tax_status: 'submitted',\r\n          tax_last_updated: new Date().toISOString(),\r\n        })\r\n        .eq('id', user.id)\r\n\r\n      if (updateError) {\r\n        console.error('Update error:', updateError)\r\n        throw updateError\r\n      }\r\n\r\n      // Refresh profile\r\n      const { data: updatedProfile } = await supabase\r\n        .from('user_profiles')\r\n        .select('*')\r\n        .eq('id', user.id)\r\n        .single()\r\n\r\n      if (updatedProfile) {\r\n        useAuthStore.getState().setProfile(updatedProfile as any)\r\n      }\r\n\r\n      setUploaded(true)\r\n      toast.success('W-9 form submitted successfully!')\r\n      \r\n      // Redirect after 2 seconds\r\n      setTimeout(() => {\r\n        navigate('/profile/setup')\r\n      }, 2000)\r\n    } catch (error: any) {\r\n      console.error('Tax form upload error:', error)\r\n      toast.error(error.message || 'Failed to upload tax form. Please try again.')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const currentStatus = profile?.tax_status || 'not_required'\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-2xl mx-auto\">\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n          <div className=\"flex items-center gap-3 mb-6\">\r\n            <FileText className=\"w-6 h-6 text-purple-400\" />\r\n            <h1 className=\"text-2xl font-bold\">Submit W-9 Tax Form</h1>\r\n          </div>\r\n\r\n          {/* Status Display */}\r\n          <div className=\"mb-6 p-4 rounded-lg bg-[#1A1A1A] border border-[#2C2C2C]\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              {currentStatus === 'approved' && (\r\n                <>\r\n                  <CheckCircle2 className=\"w-5 h-5 text-green-400\" />\r\n                  <span className=\"text-green-400 font-semibold\">Tax Form Approved</span>\r\n                </>\r\n              )}\r\n              {currentStatus === 'submitted' && (\r\n                <>\r\n                  <Upload className=\"w-5 h-5 text-yellow-400\" />\r\n                  <span className=\"text-yellow-400 font-semibold\">Tax Form Submitted - Pending Review</span>\r\n                </>\r\n              )}\r\n              {currentStatus === 'rejected' && (\r\n                <>\r\n                  <XCircle className=\"w-5 h-5 text-red-400\" />\r\n                  <span className=\"text-red-400 font-semibold\">Tax Form Rejected</span>\r\n                </>\r\n              )}\r\n              {currentStatus === 'required' && (\r\n                <>\r\n                  <AlertTriangle className=\"w-5 h-5 text-orange-400\" />\r\n                  <span className=\"text-orange-400 font-semibold\">Tax Form Required</span>\r\n                </>\r\n              )}\r\n            </div>\r\n            <p className=\"text-sm text-gray-400\">\r\n              {currentStatus === 'approved' && 'Your tax form has been approved. You can now request payouts.'}\r\n              {currentStatus === 'submitted' && 'Your tax form is under review. You will be notified once it\\'s processed.'}\r\n              {currentStatus === 'rejected' && 'Your tax form was rejected. Please upload a new, valid W-9 form.'}\r\n              {currentStatus === 'required' && 'You\\'ve earned over $600 this year! Please submit a W-9 form to continue cashing out.'}\r\n              {currentStatus === 'not_required' && 'You haven\\'t reached the $600 threshold yet. No tax form required at this time.'}\r\n            </p>\r\n          </div>\r\n\r\n          {/* Upload Form */}\r\n          {currentStatus !== 'approved' && (\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  Upload W-9 Form (PDF only)\r\n                </label>\r\n                <div className=\"border-2 border-dashed border-[#2C2C2C] rounded-lg p-6 text-center hover:border-purple-500 transition-colors\">\r\n                  <input\r\n                    type=\"file\"\r\n                    accept=\"application/pdf\"\r\n                    onChange={(e) => setFile(e.target.files?.[0] || null)}\r\n                    className=\"hidden\"\r\n                    id=\"tax-file-input\"\r\n                    disabled={loading || uploaded}\r\n                  />\r\n                  <label\r\n                    htmlFor=\"tax-file-input\"\r\n                    className=\"cursor-pointer flex flex-col items-center gap-2\"\r\n                  >\r\n                    <Upload className=\"w-8 h-8 text-gray-400\" />\r\n                    <span className=\"text-sm text-gray-400\">\r\n                      {file ? file.name : 'Click to select PDF file'}\r\n                    </span>\r\n                    <span className=\"text-xs text-gray-500\">\r\n                      Maximum file size: 10MB\r\n                    </span>\r\n                  </label>\r\n                </div>\r\n              </div>\r\n\r\n              {file && (\r\n                <div className=\"p-3 bg-[#1A1A1A] rounded-lg flex items-center justify-between\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <FileText className=\"w-4 h-4 text-purple-400\" />\r\n                    <span className=\"text-sm text-gray-300\">{file.name}</span>\r\n                    <span className=\"text-xs text-gray-500\">\r\n                      ({(file.size / 1024 / 1024).toFixed(2)} MB)\r\n                    </span>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => setFile(null)}\r\n                    className=\"text-red-400 hover:text-red-300 text-sm\"\r\n                    disabled={loading}\r\n                  >\r\n                    Remove\r\n                  </button>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4\">\r\n                <p className=\"text-sm text-blue-300\">\r\n                  <strong>Privacy Notice:</strong> Your W-9 form is stored securely and privately. \r\n                  Only authorized administrators can access your tax documents.\r\n                </p>\r\n              </div>\r\n\r\n              <button\r\n                disabled={!file || loading || uploaded}\r\n                onClick={uploadTaxForm}\r\n                className=\"w-full px-4 py-3 rounded-lg bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold transition-colors flex items-center justify-center gap-2\"\r\n              >\r\n                {loading ? (\r\n                  <>\r\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white\"></div>\r\n                    Uploading...\r\n                  </>\r\n                ) : uploaded ? (\r\n                  <>\r\n                    <CheckCircle2 className=\"w-4 h-4\" />\r\n                    Uploaded Successfully\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Upload className=\"w-4 h-4\" />\r\n                    Submit W-9 Form\r\n                  </>\r\n                )}\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {/* Success Message */}\r\n          {uploaded && (\r\n            <div className=\"mt-4 p-4 bg-green-500/10 border border-green-500/30 rounded-lg\">\r\n              <p className=\"text-green-400 text-sm\">\r\n                ‚úì Your W-9 form has been submitted and is pending admin review. \r\n                You'll be notified once it's processed.\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Back Button */}\r\n          <button\r\n            onClick={() => navigate(-1)}\r\n            className=\"mt-6 text-sm text-gray-400 hover:text-gray-300\"\r\n          >\r\n            ‚Üê Back\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TermsAgreement.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":223,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9403,9484],"text":"By clicking &quot;Agree & Continue\" below, you acknowledge and agree to the following:"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9403,9484],"text":"By clicking &ldquo;Agree & Continue\" below, you acknowledge and agree to the following:"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9403,9484],"text":"By clicking &#34;Agree & Continue\" below, you acknowledge and agree to the following:"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9403,9484],"text":"By clicking &rdquo;Agree & Continue\" below, you acknowledge and agree to the following:"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":223,"column":82,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9403,9484],"text":"By clicking \"Agree & Continue&quot; below, you acknowledge and agree to the following:"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9403,9484],"text":"By clicking \"Agree & Continue&ldquo; below, you acknowledge and agree to the following:"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9403,9484],"text":"By clicking \"Agree & Continue&#34; below, you acknowledge and agree to the following:"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9403,9484],"text":"By clicking \"Agree & Continue&rdquo; below, you acknowledge and agree to the following:"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react'\r\nimport { useNavigate, Link } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { CheckCircle, XCircle, FileText } from 'lucide-react'\r\n\r\nexport default function TermsAgreement() {\r\n  const { profile, session, refreshProfile, setProfile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [submitting, setSubmitting] = useState(false)\r\n  const [authChecked, setAuthChecked] = useState(false)\r\n  const [authRequired, setAuthRequired] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (session?.user) {\r\n      setAuthChecked(true)\r\n      return\r\n    }\r\n\r\n    let mounted = true\r\n    supabase.auth\r\n      .getSession()\r\n      .then(({ data }) => {\r\n        if (!mounted) return\r\n        if (!data?.session?.user) {\r\n          setAuthRequired(true)\r\n          navigate('/auth', { replace: true })\r\n          return\r\n        }\r\n        setAuthChecked(true)\r\n      })\r\n      .catch((error) => {\r\n        if (!mounted) return\r\n        console.error('[Terms] auth check failed', error)\r\n        setAuthRequired(true)\r\n        navigate('/auth', { replace: true })\r\n      })\r\n\r\n    return () => {\r\n      mounted = false\r\n    }\r\n  }, [navigate, session])\r\n\r\n  if (!authChecked) {\r\n    return (\r\n      <div className=\"fixed inset-0 z-[100000] bg-[#0A0814] text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"text-lg text-gray-300\">Checking authentication...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const handleAgree = async () => {\r\n    if (!authChecked || authRequired) {\r\n      toast.error('You need to be logged in to accept the terms.')\r\n      return\r\n    }\r\n    setSubmitting(true)\r\n    try {\r\n      const functionsUrl = import.meta.env.VITE_EDGE_FUNCTIONS_URL || 'https://yjxpwfalenorzrqxwmtr.supabase.co/functions/v1'\r\n      const token =\r\n        session?.access_token ||\r\n        (await supabase.auth.getSession()).data.session?.access_token\r\n\r\n      if (!token) {\r\n        throw new Error('Missing authentication token')\r\n      }\r\n\r\n      const response = await fetch(`${functionsUrl}/user-agreements?action=accept_agreement`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ agreement_version: '1.0' })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorBody = await response.json().catch(() => ({}))\r\n        throw new Error(errorBody?.error || 'Failed to record agreement acceptance')\r\n      }\r\n\r\n      if (refreshProfile) {\r\n        await refreshProfile()\r\n      }\r\n\r\n      let updatedProfile = profile\r\n      try {\r\n        const sessionUserId =\r\n          session?.user?.id ||\r\n          (await supabase.auth.getSession()).data.session?.user?.id\r\n        if (!sessionUserId) {\r\n          throw new Error('Missing session user id')\r\n        }\r\n        const { data: refreshed } = await supabase\r\n          .from('user_profiles')\r\n          .select('*')\r\n          .eq('id', sessionUserId)\r\n          .maybeSingle()\r\n        if (refreshed) {\r\n          updatedProfile = refreshed as any\r\n          if (setProfile) setProfile(refreshed as any)\r\n        }\r\n      } catch (profileErr) {\r\n        console.warn('[Terms] profile refresh failed:', profileErr)\r\n      }\r\n\r\n      toast.success('Welcome to Troll City!')\r\n      // If this user is an admin, send them to the admin dashboard after accepting\r\n      try {\r\n        if (updatedProfile?.role === 'admin') {\r\n          navigate('/admin')\r\n        } else if (!updatedProfile?.username) {\r\n          navigate('/profile/setup')\r\n        } else {\r\n          navigate('/')\r\n        }\r\n      } catch {\r\n        navigate('/')\r\n      }\r\n    } catch (err: any) {\r\n      console.error('[Terms] Agreement error:', err)\r\n      toast.error(err?.message || 'Failed to save agreement')\r\n    } finally {\r\n      setSubmitting(false)\r\n    }\r\n  }\r\n\r\n  const terms = {\r\n    pros: [\r\n      { icon: 'üí∞', title: 'Earn Real Money', desc: 'Cash out your earned coins through streaming and engagement' },\r\n      { icon: 'üéÆ', title: 'Interactive Features', desc: 'Engage with gifts, family wars, and more' },\r\n      { icon: 'üèÜ', title: 'Level Up System', desc: 'Progress through 100 levels with custom tier names and rewards' },\r\n      { icon: 'üëë', title: 'Exclusive Badges', desc: 'Earn OG badges, admin badges, and family crowns' },\r\n      { icon: 'üéØ', title: 'Fair Play', desc: 'Transparent rules and moderation for all users' },\r\n      { icon: 'üåü', title: 'Community', desc: 'Join troll families and compete in weekly wars' },\r\n    ],\r\n    rules: [\r\n      { icon: 'üö´', title: 'Zero Tolerance Policy', desc: 'Harassment, hate speech, or illegal content results in immediate permanent ban' },\r\n      { icon: '‚ö†Ô∏è', title: 'Account Responsibility', desc: 'You are responsible for all activity on your account. Secure your credentials.' },\r\n      { icon: 'üí∏', title: 'No Chargebacks', desc: 'All coin purchases are final. Chargebacks will result in permanent ban.' },\r\n      { icon: 'üîí', title: 'Account Reset on Ban', desc: 'Banned users lose ALL progress: coins, XP, level, badges reset to 0' },\r\n      { icon: 'üìä', title: 'Platform Fees', desc: 'All transactions include platform fees. See cashout page for current rates.' },\r\n      { icon: 'üé•', title: 'Content Ownership', desc: 'By streaming, you grant Troll City rights to use your content for promotion' },\r\n      { icon: '‚öñÔ∏è', title: 'Dispute Resolution', desc: 'All disputes must go through our support ticket system first' },\r\n      { icon: 'üîÑ', title: 'Terms Can Change', desc: 'We reserve the right to update these terms. Continued use means acceptance.' },\r\n    ]\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[100000] overflow-y-auto bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white pointer-events-auto\">\r\n      <div className=\"max-w-5xl mx-auto p-6 pb-20\">\r\n        {/* Header */}\r\n        <div className=\"text-center mb-8\">\r\n          <FileText className=\"w-16 h-16 mx-auto mb-4 text-troll-neon-blue\" />\r\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-purple-400 to-green-400 bg-clip-text text-transparent mb-2\">\r\n            Welcome to Troll City\r\n          </h1>\r\n          <p className=\"text-gray-400\">Please read and agree to our platform terms before continuing</p>\r\n        </div>\r\n\r\n        {/* Pros Section */}\r\n        <div className=\"bg-[#1A1A1A] rounded-xl border border-green-500/30 p-6 mb-6\">\r\n          <h2 className=\"text-2xl font-bold text-green-400 mb-4 flex items-center gap-2\">\r\n            <CheckCircle className=\"w-6 h-6\" />\r\n            Platform Benefits\r\n          </h2>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            {terms.pros.map((pro, i) => (\r\n              <div key={i} className=\"flex gap-3 p-4 bg-[#0D0D1A] rounded-lg border border-[#2C2C2C]\">\r\n                <span className=\"text-3xl\">{pro.icon}</span>\r\n                <div>\r\n                  <h3 className=\"font-semibold text-green-300\">{pro.title}</h3>\r\n                  <p className=\"text-sm text-gray-400\">{pro.desc}</p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Rules Section */}\r\n        <div className=\"bg-[#1A1A1A] rounded-xl border border-red-500/30 p-6 mb-6\">\r\n          <h2 className=\"text-2xl font-bold text-red-400 mb-4 flex items-center gap-2\">\r\n            <XCircle className=\"w-6 h-6\" />\r\n            Platform Rules & Consequences\r\n          </h2>\r\n          <div className=\"grid grid-cols-1 gap-4\">\r\n            {terms.rules.map((rule, i) => (\r\n              <div key={i} className=\"flex gap-3 p-4 bg-[#0D0D1A] rounded-lg border border-[#2C2C2C]\">\r\n                <span className=\"text-3xl\">{rule.icon}</span>\r\n                <div>\r\n                  <h3 className=\"font-semibold text-red-300\">{rule.title}</h3>\r\n                  <p className=\"text-sm text-gray-400\">{rule.desc}</p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Key Highlight */}\r\n        <div className=\"bg-gradient-to-r from-red-900/50 to-orange-900/50 border-2 border-red-500 rounded-xl p-6 mb-6\">\r\n          <h3 className=\"text-xl font-bold text-red-300 mb-2\">‚ö†Ô∏è CRITICAL: Ban Policy</h3>\r\n          <p className=\"text-white\">\r\n            When you are banned, your account is <strong>completely reset</strong>. You will lose:\r\n          </p>\r\n          <ul className=\"list-disc list-inside mt-2 text-gray-200 space-y-1\">\r\n            <li>All troll_coins (non-refundable)</li>\r\n            <li>All free coins</li>\r\n            <li>All XP and levels (back to Level 1)</li>\r\n            <li>All badges and achievements</li>\r\n            <li>All earnings history</li>\r\n          </ul>\r\n          <p className=\"mt-3 text-yellow-300 font-semibold\">\r\n            Follow the rules. Play fair. Build your legacy.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Agreement Text */}\r\n        <div className=\"relative z-[9999] bg-[#1A1A1A] rounded-xl border border-[#2C2C2C] p-6 mb-6 space-y-4 pointer-events-auto\" style={{ zIndex: 99999 }}>\r\n          <div className=\"space-y-4 text-gray-300\">\r\n            <p className=\"font-semibold text-white\">By clicking \"Agree & Continue\" below, you acknowledge and agree to the following:</p>\r\n            \r\n            <ul className=\"list-disc list-inside space-y-2 ml-2\">\r\n              <li>\r\n                I have read and agree to the <Link to=\"/terms-of-service\" target=\"_blank\" className=\"text-troll-purple underline hover:text-troll-neon-blue\">Terms of Service</Link> and <Link to=\"/privacy-policy\" target=\"_blank\" className=\"text-troll-purple underline hover:text-troll-neon-blue\">Privacy Policy</Link>.\r\n              </li>\r\n              <li>\r\n                I consent to the collection and processing of my personal data as described in the Privacy Policy.\r\n              </li>\r\n              <li>\r\n                I agree to the <Link to=\"/payment-terms\" target=\"_blank\" className=\"text-troll-purple underline hover:text-troll-neon-blue\">Payment Terms</Link> and understand that all purchases are final and non-refundable.\r\n              </li>\r\n              <li>\r\n                I have read and agree to the <Link to=\"/creator-agreement\" target=\"_blank\" className=\"text-troll-purple underline hover:text-troll-neon-blue\">Creator Earning / Cashout Agreement</Link>, including 1099 tax reporting requirements.\r\n              </li>\r\n            </ul>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Action Buttons */}\r\n        <div className=\"flex gap-4 justify-center\">\r\n          <button\r\n            onClick={async () => {\r\n              try {\r\n                try {\r\n                  const { data: sessionData } = await supabase.auth.getSession()\r\n                  const hasSession = !!sessionData?.session\r\n                  if (hasSession) {\r\n                    const { error } = await supabase.auth.signOut()\r\n                    if (error) console.warn('supabase.signOut returned error:', error)\r\n                  } else {\r\n                    console.debug('No active session; skipping supabase.auth.signOut()')\r\n                  }\r\n                } catch (innerErr) {\r\n                  console.warn('Error during sign-out (ignored):', innerErr)\r\n                }\r\n              } finally {\r\n                navigate('/auth')\r\n              }\r\n            }}\r\n            className=\"px-8 py-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition\"\r\n          >\r\n            Decline & Sign Out\r\n          </button>\r\n          <button\r\n            onClick={handleAgree}\r\n            disabled={submitting}\r\n            className=\"px-8 py-3 rounded-lg bg-gradient-to-r from-troll-purple to-troll-neon-blue\r\n                     disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 transition font-bold\"\r\n          >\r\n            {submitting ? 'Processing...' : 'Agree & Continue'}\r\n          </button>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <p className=\"text-center text-gray-500 text-sm mt-8\">\r\n          Questions? Contact support at trollcity2025@gmail.com\r\n        </p>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TermsOfService.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TransactionHistory.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollBank.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":352,"column":89,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[15368,15388],"text":"Why you can&apos;t apply:"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[15368,15388],"text":"Why you can&lsquo;t apply:"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[15368,15388],"text":"Why you can&#39;t apply:"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[15368,15388],"text":"Why you can&rsquo;t apply:"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/pages/TrollBank.tsx\r\nimport React, { useEffect, useState } from 'react'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { useAuthStore } from '@/lib/store'\r\nimport { useBank } from '@/lib/hooks/useBank'\r\nimport { useCoins } from '@/lib/hooks/useCoins'\r\nimport { toast } from 'sonner'\r\nimport { Coins, CreditCard, Landmark, History, AlertCircle, CheckCircle, Lock } from 'lucide-react'\r\n\r\n// Interfaces are now handled by useBank hook, but we keep local usage aligned\r\n\r\nexport default function TrollBank() {\r\n  const { profile } = useAuthStore()\r\n  const { balances, refreshCoins } = useCoins()\r\n  const { loans, ledger, tiers, refresh, applyForLoan, payLoan } = useBank()\n  const activeLoan = loans && loans.length > 0 ? loans[0] : null\r\n  \r\n  const [bankBalance, setBankBalance] = useState<number | null>(null)\r\n  \r\n  // Fetch and Subscribe to Bank Reserves\r\n  useEffect(() => {\r\n    const fetchReserves = async () => {\r\n      try {\r\n        const { data, error } = await supabase.rpc('get_bank_reserves')\r\n        if (error) throw error\r\n        setBankBalance(data)\r\n      } catch (err) {\r\n        console.error('Failed to fetch bank reserves:', err)\r\n      }\r\n    }\r\n\r\n    fetchReserves()\r\n\r\n    // Subscribe to ledger changes to update reserves instantly\r\n    const channel = supabase\r\n      .channel('bank_reserves_updates')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: 'INSERT', schema: 'public', table: 'coin_ledger' },\r\n        () => fetchReserves()\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel)\r\n    }\r\n  }, [])\r\n\r\n  const [applying, setApplying] = useState(false)\r\n  const [requestedAmount, setRequestedAmount] = useState(100)\r\n  const [payAmount, setPayAmount] = useState<string>('')\r\n  const [paying, setPaying] = useState(false)\r\n\r\n  const handlePayLoan = async () => {\r\n    if (!activeLoan || !payAmount) return\r\n    const amount = parseInt(payAmount)\r\n    if (isNaN(amount) || amount <= 0) {\r\n      toast.error('Invalid amount')\r\n      return\r\n    }\r\n    \r\n    setPaying(true)\r\n    const result = await payLoan(activeLoan.id, amount)\r\n    setPaying(false)\r\n    \r\n    if (result.success) {\r\n      setPayAmount('')\r\n      refreshCoins() // Update user coin balance in UI\r\n    }\r\n  }\r\n  \r\n  // Eligibility State\r\n  const [eligibility, setEligibility] = useState<{\r\n    canApply: boolean\r\n    reasons: string[]\r\n    maxAmount: number\r\n  }>({ canApply: false, reasons: [], maxAmount: 0 })\r\n\r\n  useEffect(() => {\r\n    if (profile?.id) {\r\n      refresh()\r\n    }\r\n  }, [profile?.id, refresh])\r\n\r\n  // Re-check eligibility whenever data changes\r\n  useEffect(() => {\r\n    const checkEligibility = (currentLoan: any, currentLedger: any[], bankTiers: any[]) => {\r\n      const reasons: string[] = []\r\n      let canApply = true\r\n\r\n      if (currentLoan) {\r\n        reasons.push('You already have an active loan.')\r\n        canApply = false\r\n      }\r\n\r\n      // Calculate account age\r\n      const created = new Date(profile?.created_at || Date.now())\r\n      const diffTime = Math.abs(Date.now() - created.getTime())\r\n      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) \r\n\r\n      // Find eligible tier\r\n      const sortedTiers = [...(bankTiers || [])].sort((a, b) => b.min_tenure_days - a.min_tenure_days)\r\n      const eligibleTier = sortedTiers.find(t => diffDays >= t.min_tenure_days)\r\n\r\n      if (!eligibleTier) {\r\n        // Fallback if no tiers loaded yet (or 0-day tier missing)\r\n        if (bankTiers.length > 0) {\r\n           reasons.push(`Account too new for any loan tier.`)\r\n           canApply = false\r\n        }\r\n        // If tiers not loaded, we might just wait (canApply defaults false if reasons empty? No, let's allow basic 100 if tiers fail to load?)\r\n        // Better to block until tiers load.\r\n      }\r\n\r\n      const maxAmount = eligibleTier ? eligibleTier.max_loan_coins : 0\r\n      \r\n      // Ensure requested amount is within limit\r\n      // We don't block applying here based on amount, but we validate it on submit\r\n      \r\n      setEligibility({ canApply: canApply && maxAmount > 0, reasons, maxAmount })\r\n    }\r\n\r\n    checkEligibility(activeLoan, ledger || [], tiers || [])\r\n  }, [activeLoan, ledger, tiers, profile?.created_at])\r\n\r\n  const handleApply = async () => {\r\n    if (!eligibility.canApply) return\r\n    if (requestedAmount > eligibility.maxAmount) {\r\n        toast.error(`Maximum loan amount for your tier is ${eligibility.maxAmount} coins.`)\r\n        return\r\n    }\r\n    \r\n    setApplying(true)\r\n    try {\r\n      const { success } = await applyForLoan(requestedAmount)\r\n\r\n      if (success) {\r\n        // toast handled by hook\r\n        await refreshCoins()\r\n        setRequestedAmount(100)\r\n      }\r\n    } catch (err: any) {\r\n      toast.error(err.message || 'Failed to apply for loan.')\r\n    } finally {\r\n      setApplying(false)\r\n    }\r\n  }\r\n\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6 pb-24\">\r\n      <div className=\"max-w-4xl mx-auto space-y-8\">\r\n        \r\n        {/* Header */}\r\n        <div className=\"flex items-center gap-4\">\r\n          <div className=\"p-3 bg-gradient-to-br from-yellow-500 to-yellow-700 rounded-xl shadow-lg shadow-yellow-900/20\">\r\n            <Landmark className=\"w-8 h-8 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400\">\r\n              Troll Bank\r\n            </h1>\r\n            <p className=\"text-gray-400\">Secure Coin Storage & Lending Services</p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Balance Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n          {/* Main Balance */}\r\n          <div className=\"bg-[#13111C] border border-white/5 rounded-2xl p-6 relative overflow-hidden group\">\r\n            <div className=\"absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\r\n              <Coins className=\"w-32 h-32\" />\r\n            </div>\r\n            <div className=\"relative z-10\">\r\n              <p className=\"text-gray-400 text-sm font-medium mb-1\">Available Balance</p>\r\n              <div className=\"flex items-baseline gap-2\">\r\n                <span className=\"text-4xl font-bold text-yellow-400\">{balances.troll_coins.toLocaleString()}</span>\r\n                <span className=\"text-sm text-yellow-400/70\">coins</span>\r\n              </div>\r\n              <div className=\"mt-4 flex items-center gap-2 text-xs text-gray-500\">\r\n                <Lock className=\"w-3 h-3\" />\r\n                <span>Protected by Troll Bank Security</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Bank Reserves */}\r\n          <div className=\"bg-[#13111C] border border-white/5 rounded-2xl p-6 relative overflow-hidden group\">\r\n            <div className=\"absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\r\n              <Landmark className=\"w-32 h-32\" />\r\n            </div>\r\n            <div className=\"relative z-10\">\r\n              <p className=\"text-gray-400 text-sm font-medium mb-1\">Bank Reserves</p>\r\n              <div className=\"flex items-baseline gap-2\">\r\n                <span className=\"text-4xl font-bold text-emerald-400\">\r\n                  {bankBalance !== null ? bankBalance.toLocaleString() : '---'}\r\n                </span>\r\n                <span className=\"text-sm text-emerald-400/70\">coins</span>\r\n              </div>\r\n              <div className=\"mt-4 flex items-center gap-2 text-xs text-gray-500\">\r\n                <CheckCircle className=\"w-3 h-3\" />\r\n                <span>Verified Bank Holdings</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Loan Status */}\r\n          <div className=\"bg-[#13111C] border border-white/5 rounded-2xl p-6 relative overflow-hidden\">\r\n            <div className=\"absolute top-0 right-0 p-4 opacity-10\">\r\n              <CreditCard className=\"w-32 h-32\" />\r\n            </div>\r\n            <div className=\"relative z-10\">\r\n              <p className=\"text-gray-400 text-sm font-medium mb-1\">Active Loan</p>\r\n              {activeLoan ? (\r\n                <div>\r\n                  <div className=\"flex items-baseline gap-2\">\r\n                    <span className=\"text-4xl font-bold text-red-400\">{activeLoan.balance.toLocaleString()}</span>\r\n                    <span className=\"text-sm text-red-400/70\">due</span>\r\n                  </div>\r\n                  <div className=\"mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg\">\r\n                    <p className=\"text-xs text-red-200\">\r\n                      <strong>Auto-Repayment Active:</strong> 50% of all incoming purchased coins will be automatically deducted to repay this loan.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div>\r\n                  <div className=\"flex items-baseline gap-2\">\r\n                    <span className=\"text-4xl font-bold text-green-400\">None</span>\r\n                  </div>\r\n                  <p className=\"mt-2 text-sm text-gray-400\">You are debt free!</p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Loan Application / Management */}\r\n        <div className=\"bg-[#13111C] border border-white/5 rounded-2xl p-6\">\r\n          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n            <CreditCard className=\"w-5 h-5 text-purple-400\" />\r\n            Loan Services\r\n          </h2>\r\n          \r\n          {activeLoan ? (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl\">\r\n                <h3 className=\"font-semibold text-emerald-400 mb-2\">Manual Repayment</h3>\r\n                <p className=\"text-sm text-gray-300 mb-4\">\r\n                  Pay off your loan manually. Fully paying off a loan increases your credit score by 5% of the loan amount!\r\n                </p>\r\n                <div className=\"flex gap-2\">\r\n                  <input\r\n                    type=\"number\"\r\n                    value={payAmount}\r\n                    onChange={(e) => setPayAmount(e.target.value)}\r\n                    placeholder=\"Amount to pay\"\r\n                    className=\"flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-emerald-500/50\"\r\n                  />\r\n                  <button\r\n                    onClick={handlePayLoan}\r\n                    disabled={paying || !payAmount}\r\n                    className=\"bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-semibold transition-colors\"\r\n                  >\r\n                    {paying ? 'Paying...' : 'Pay'}\r\n                  </button>\r\n                  <button\r\n                    onClick={() => setPayAmount(activeLoan.balance.toString())}\r\n                    className=\"bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg font-medium transition-colors\"\r\n                  >\r\n                    Max\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl flex items-start gap-3\">\r\n                <AlertCircle className=\"w-5 h-5 text-blue-400 mt-0.5\" />\r\n                <div>\r\n                  <h3 className=\"font-semibold text-blue-400\">Repayment Information</h3>\r\n                  <p className=\"text-sm text-gray-300 mt-1\">\r\n                    Loans are repaid automatically when you purchase or receive paid coins. \r\n                    There is no interest if paid within 30 days (currently indefinite).\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-6\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                <div>\r\n                  <h3 className=\"font-semibold text-white mb-2\">Apply for a Loan</h3>\r\n                  <p className=\"text-sm text-gray-400 mb-4\">\r\n                    Get coins instantly and pay them back later automatically.\r\n                  </p>\r\n                  \r\n                  <div className=\"space-y-4\">\r\n                    <div>\r\n                      <label className=\"block text-xs font-medium text-gray-400 mb-1\">\r\n                        Amount (Coins) - Max: {eligibility.maxAmount}\r\n                      </label>\r\n                      <input \r\n                        type=\"number\"\r\n                        value={requestedAmount}\r\n                        onChange={(e) => setRequestedAmount(Number(e.target.value))}\r\n                        className=\"w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500 transition-colors\"\r\n                        min={100}\r\n                        max={eligibility.maxAmount || 100}\r\n                      />\r\n                    </div>\r\n                    \r\n                    <button\r\n                      onClick={handleApply}\r\n                      disabled={!eligibility.canApply || applying}\r\n                      className=\"w-full py-3 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-lg transition-all\"\r\n                    >\r\n                      {applying ? 'Processing...' : 'Apply for Loan'}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"bg-black/20 rounded-xl p-4\">\r\n                  <h3 className=\"font-semibold text-white mb-3\">Eligibility Requirements</h3>\r\n                  <ul className=\"space-y-2\">\r\n                    <Requirement \r\n                      label=\"No active loans\" \r\n                      met={!activeLoan} \r\n                    />\r\n                    <Requirement \r\n                      label=\"Account age check\" \r\n                      met={eligibility.maxAmount > 0} \r\n                      note={`(Limit: ${eligibility.maxAmount})`}\r\n                    />\r\n                    {profile?.credit_score !== undefined && (\r\n                      <li className=\"flex items-center gap-2 text-sm\">\r\n                        <span className=\"text-cyan-400\">Credit Score:</span>\r\n                        <span className=\"font-semibold\">{profile.credit_score}</span>\r\n                      </li>\r\n                    )}\r\n                    {profile?.created_at && (\r\n                      <li className=\"flex items-center gap-2 text-sm\">\r\n                        <span className=\"text-cyan-400\">Account Age:</span>\r\n                        <span className=\"font-semibold\">\r\n                          {Math.ceil(Math.abs(Date.now() - new Date(profile.created_at).getTime()) / (1000 * 60 * 60 * 24))} days\r\n                        </span>\r\n                      </li>\r\n                    )}\r\n                    {/* Removed explicit spend check from UI as it's now implicit or removed */}\r\n                  </ul>\r\n                  \r\n                  {eligibility.reasons.length > 0 && (\r\n                    <div className=\"mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg\">\r\n                      <p className=\"text-xs text-red-300 font-semibold mb-1\">Why you can't apply:</p>\r\n                      <ul className=\"list-disc list-inside text-xs text-red-200/80\">\r\n                        {eligibility.reasons.map((r, i) => <li key={i}>{r}</li>)}\r\n                      </ul>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Ledger / History */}\r\n        <div className=\"bg-[#13111C] border border-white/5 rounded-2xl p-6\">\r\n          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n            <History className=\"w-5 h-5 text-gray-400\" />\r\n            Recent Transactions\r\n          </h2>\r\n          \r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full text-left border-collapse\">\r\n              <thead>\r\n                <tr className=\"text-xs text-gray-500 border-b border-white/5\">\r\n                  <th className=\"py-3 px-4\">Date</th>\r\n                  <th className=\"py-3 px-4\">Type</th>\r\n                  <th className=\"py-3 px-4\">Source</th>\r\n                  <th className=\"py-3 px-4 text-right\">Amount</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"text-sm\">\r\n                {ledger.map((entry) => (\r\n                  <tr key={entry.id} className=\"border-b border-white/5 hover:bg-white/5 transition-colors\">\r\n                    <td className=\"py-3 px-4 text-gray-400\">\r\n                      {new Date(entry.created_at).toLocaleDateString()}\r\n                    </td>\r\n                    <td className=\"py-3 px-4\">\r\n                      <span className={`px-2 py-1 rounded text-xs font-medium ${\r\n                        entry.bucket === 'repayment' ? 'bg-red-500/20 text-red-300' :\r\n                        entry.bucket === 'loan' ? 'bg-purple-500/20 text-purple-300' :\r\n                        'bg-gray-500/20 text-gray-300'\r\n                      }`}>\r\n                        {entry.bucket.toUpperCase()}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-gray-400\">{entry.source}</td>\r\n                    <td className={`py-3 px-4 text-right font-mono font-medium ${\r\n                      entry.delta > 0 ? 'text-green-400' : 'text-red-400'\r\n                    }`}>\r\n                      {entry.delta > 0 ? '+' : ''}{entry.delta}\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n                {ledger.length === 0 && (\r\n                  <tr>\r\n                    <td colSpan={4} className=\"py-8 text-center text-gray-500\">\r\n                      No transactions found.\r\n                    </td>\r\n                  </tr>\r\n                )}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction Requirement({ label, met, note }: { label: string, met: boolean, note?: string }) {\r\n  return (\r\n    <li className=\"flex items-center gap-2 text-sm\">\r\n      {met ? (\r\n        <CheckCircle className=\"w-4 h-4 text-green-500\" />\r\n      ) : (\r\n        <div className=\"w-4 h-4 rounded-full border border-gray-600\" />\r\n      )}\r\n      <span className={met ? 'text-gray-200' : 'text-gray-500'}>\r\n        {label} {note && <span className=\"text-xs opacity-50\">{note}</span>}\r\n      </span>\r\n    </li>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollBattleSetup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollCityWall.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollCourt.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":564,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[23733,23734],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[23733,23734],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[23733,23734],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[23733,23734],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":564,"column":81,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[23749,23750],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[23749,23750],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[23749,23750],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[23749,23750],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\n\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase, UserRole } from '../lib/supabase'\r\nimport { startCourtSession } from '../lib/courtSessions'\r\nimport { Scale, Gavel, Users, Clock, AlertTriangle, CheckCircle, Search, X } from 'lucide-react'\r\nimport FileLawsuitModal from '../components/FileLawsuitModal'\r\nimport JudgeRulingModal from '../components/JudgeRulingModal'\r\nimport { toast } from 'sonner'\r\nimport UserSearchDropdown from '../components/UserSearchDropdown'\r\n\r\n\r\nexport default function TrollCourt() {\r\n  const { user, profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [courtSession, setCourtSession] = useState<any>(null)\r\n  const [isStartingSession, setIsStartingSession] = useState(false)\r\n  const [pendingSummons, setPendingSummons] = useState<any[]>([])\r\n  // New state for features\r\n  const [recentCases, setRecentCases] = useState<any[]>([])\r\n  const [myCivilCases, setMyCivilCases] = useState<any[]>([])\r\n  const [assignedCases, setAssignedCases] = useState<any[]>([])\r\n  const [selectedCaseForRuling, setSelectedCaseForRuling] = useState<any>(null)\r\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false)\r\n  const [searchQuery, setSearchQuery] = useState('')\r\n  const [isFileLawsuitModalOpen, setIsFileLawsuitModalOpen] = useState(false)\r\n  const [_userList, setUserList] = useState<any[]>([])\r\n  const [selectedUser, setSelectedUser] = useState<any>(null)\r\n  const [_isSearchingUsers, setIsSearchingUsers] = useState(false)\r\n  const [selectedCaseType, setSelectedCaseType] = useState<string>('')\r\n  const [showDropdown, setShowDropdown] = useState(false)\r\n\r\n  // Timer for next Sunday opening (must be inside component)\r\n  const [timeUntilOpen, setTimeUntilOpen] = useState('');\r\n  // Court opens every Sunday at 1 PM\r\n  const getNextSundayAt1PM = () => {\r\n    const now = new Date();\r\n    const day = now.getDay(); // 0 = Sunday\r\n    const hour = now.getHours();\r\n    const minute = now.getMinutes();\r\n    let daysUntilSunday = (7 - day) % 7;\r\n    // If today is Sunday and before 1 PM, open today at 1 PM\r\n    if (day === 0 && (hour < 13 || (hour === 13 && minute === 0))) {\r\n      daysUntilSunday = 0;\r\n    } else if (day === 0 && hour >= 13) {\r\n      daysUntilSunday = 7;\r\n    }\r\n    const nextSunday = new Date(now);\r\n    nextSunday.setDate(now.getDate() + daysUntilSunday);\r\n    nextSunday.setHours(13, 0, 0, 0); // 1 PM\r\n    return nextSunday;\r\n  };\r\n  useEffect(() => {\r\n    if (courtSession) return;\r\n    const updateTimer = () => {\r\n      const now = new Date();\r\n      const nextOpen = getNextSundayAt1PM();\r\n      const diff = nextOpen.getTime() - now.getTime();\r\n      if (diff <= 0) {\r\n        setTimeUntilOpen('Now');\r\n        return;\r\n      }\r\n      const days = Math.floor(diff / (1000 * 60 * 60 * 24));\r\n      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\r\n      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\r\n      let timeString = '';\r\n      if (days > 0) timeString += `${days}d `;\r\n      timeString += `${hours}h ${minutes.toString().padStart(2, '0')}m`;\r\n      setTimeUntilOpen(timeString.trim());\r\n    };\r\n    updateTimer();\r\n    const interval = setInterval(updateTimer, 1000 * 30); // update every 30s\r\n    return () => clearInterval(interval);\r\n  }, [courtSession]);\r\n\r\n  const CASE_TYPES = [\r\n    'Harassment / Threats',\r\n    'Hate Speech / Discrimination',\r\n    'Nudity / Sexual Content',\r\n    'Doxxing / Personal Info',\r\n    'Scamming / Fraud',\r\n    'Chargeback / Payment Abuse',\r\n    'Gift Manipulation / Fake gifting',\r\n    'Ban Evasion',\r\n    'Family War Dispute',\r\n    'Streamer Misconduct',\r\n    'Officer Misconduct',\r\n    'Appeal Case',\r\n    'Copyright / Content Claim',\r\n    'TrollCourt Civil Case',\r\n    'TrollCity Policy Violation'\r\n  ]\r\n\r\n  const canStartCourt =\r\n    profile?.role === UserRole.ADMIN ||\r\n    profile?.role === UserRole.LEAD_TROLL_OFFICER ||\r\n    profile?.role === UserRole.SECRETARY ||\r\n    (profile as any)?.is_admin === true ||\r\n    (profile as any)?.is_lead_officer === true\r\n\r\n  // Fetch recent cases\r\n  useEffect(() => {\r\n    const fetchCases = async () => {\r\n      const { data } = await supabase\r\n        .from('court_cases')\r\n        .select('*, defendant:defendant_id(username), plaintiff:plaintiff_id(username)')\r\n        .order('created_at', { ascending: false })\r\n        .limit(5)\r\n      \r\n      if (data) setRecentCases(data)\r\n    }\r\n    fetchCases()\r\n  }, [])\r\n\r\n  // Fetch my civil cases\r\n  useEffect(() => {\r\n    if (!user) return\r\n    const fetchMyCivilCases = async () => {\r\n      const { data } = await supabase\r\n        .from('troll_court_cases')\r\n        .select('*, defendant:defendant_id(username), plaintiff:plaintiff_id(username)')\r\n        .or(`plaintiff_id.eq.${user.id},defendant_id.eq.${user.id}`)\r\n        .order('created_at', { ascending: false })\r\n      if (data) setMyCivilCases(data)\r\n\r\n      // Fetch assigned cases (if judge)\r\n      if (profile?.role === 'admin' || profile?.role === 'lead_troll_officer') {\r\n        const { data: assigned } = await supabase\r\n            .from('troll_court_cases')\r\n            .select('*, defendant:defendant_id(username), plaintiff:plaintiff_id(username)')\r\n            .eq('assigned_judge_id', user.id)\r\n            .neq('status', 'ruled')\r\n            .neq('status', 'dismissed')\r\n            .order('created_at', { ascending: true })\r\n        if (assigned) setAssignedCases(assigned)\r\n      }\r\n    }\r\n    fetchMyCivilCases()\r\n  }, [user, isFileLawsuitModalOpen, profile, selectedCaseForRuling]) // Reload when modal closes (potentially filed new case)\r\n\r\n  // Search users\r\n  useEffect(() => {\r\n    const searchUsers = async () => {\r\n      setIsSearchingUsers(true)\r\n      try {\r\n        let query = supabase\r\n          .from('user_profiles')\r\n          .select('id, username, avatar_url')\r\n          .limit(50)\r\n\r\n        if (searchQuery.length >= 3) {\r\n          query = query.ilike('username', `%${searchQuery}%`)\r\n        }\r\n\r\n        const { data } = await query\r\n        if (data) setUserList(data)\r\n      } catch (err) {\r\n        console.error('Error searching users:', err)\r\n      } finally {\r\n        setIsSearchingUsers(false)\r\n      }\r\n    }\r\n    \r\n    const timer = setTimeout(searchUsers, 300)\r\n    return () => clearTimeout(timer)\r\n  }, [searchQuery])\r\n\r\n  const loadCourtState = useCallback(async () => {\r\n    try {\r\n      const { data: currentSession, error: sessionError } = await supabase.rpc('get_current_court_session')\r\n      if (sessionError) {\r\n        console.warn('Court session RPC error; falling back to direct query', sessionError)\r\n        throw new Error('RPC not available')\r\n      }\r\n\r\n      let session = Array.isArray(currentSession) ? currentSession[0] : currentSession\r\n\r\n      // If RPC returned nothing, check via direct query just in case (for 'active' status support)\r\n      if (!session || !session.id) {\r\n        const { data: fallbackSession } = await supabase\r\n          .from('court_sessions')\r\n          .select('*')\r\n          .in('status', ['live', 'active', 'waiting'])\r\n          .order('created_at', { ascending: false })\r\n          .limit(1)\r\n          .maybeSingle()\r\n        \r\n        if (fallbackSession) {\r\n          session = fallbackSession\r\n        }\r\n      }\r\n\r\n      // Ensure session has a valid ID before setting it\r\n      if (session && session.id) {\r\n        setCourtSession(session)\r\n      } else {\r\n        setCourtSession(null)\r\n      }\r\n    } catch {\r\n      try {\r\n        const { data: session } = await supabase\r\n          .from('court_sessions')\r\n          .select('*')\r\n          .in('status', ['live', 'active', 'waiting'])\r\n          .order('created_at', { ascending: false })\r\n          .limit(1)\r\n          .maybeSingle()\r\n\r\n        setCourtSession(session || null)\r\n      } catch {\r\n        setCourtSession(null)\r\n      }\r\n    } finally {\r\n      if (user?.id) {\r\n        const { data: summons } = await supabase\r\n          .from('court_summons')\r\n          .select('*')\r\n          .eq('summoned_user_id', user.id)\r\n          .eq('status', 'pending')\r\n          .order('created_at', { ascending: false })\r\n\r\n        setPendingSummons(summons || [])\r\n      } else {\r\n        setPendingSummons([])\r\n      }\r\n    }\r\n  }, [user?.id])\r\n\r\n  // Load current court session (global) on mount\r\n  useEffect(() => {\r\n    loadCourtState()\r\n    const id = window.setInterval(loadCourtState, 5000)\r\n    return () => window.clearInterval(id)\r\n  }, [user?.id, loadCourtState])\r\n\r\n  const openCreateModal = () => {\r\n    if (!canStartCourt) return\r\n    setIsCreateModalOpen(true)\r\n    setSearchQuery('')\r\n    setSelectedUser(null)\r\n  }\r\n\r\n  const handleSummonOrStart = async () => {\r\n    if (!canStartCourt || !user) return\r\n\r\n    setIsStartingSession(true)\r\n    try {\r\n      let activeSessionId = courtSession?.id\r\n\r\n      // 1. If no active session, start one\r\n      if (!activeSessionId) {\r\n        const newSessionId = crypto.randomUUID()\r\n        const { data, error: startError } = await startCourtSession({\r\n          sessionId: newSessionId,\r\n          maxBoxes: 2,\r\n          roomName: newSessionId,\r\n          userId: user.id,\r\n          defendantId: selectedUser?.id\r\n        })\r\n\r\n        if (startError) throw startError\r\n        const resolvedSessionId = data?.id || newSessionId\r\n        activeSessionId = resolvedSessionId\r\n        setCourtSession(data)\r\n      }\r\n\r\n      // 2. If a case type and defendant are selected, create the official case\r\n      if (selectedCaseType && selectedUser && activeSessionId) {\r\n        try {\r\n          const { error: caseError } = await supabase.rpc('create_court_case', {\r\n            p_case_type: selectedCaseType,\r\n            p_plaintiff_id: user.id,\r\n            p_defendant_id: selectedUser.id,\r\n            p_court_session_id: activeSessionId\r\n          })\r\n          \r\n          if (caseError) {\r\n            console.error('Error creating case record:', caseError)\r\n            toast.error('Session active, but failed to create case record')\r\n          } else {\r\n            toast.success(courtSession ? 'User Summoned to Current Session' : 'Court Session Started & Case Docketed')\r\n          }\r\n        } catch (e) {\r\n          console.error('Exception creating case:', e)\r\n        }\r\n      }\r\n\r\n      setIsCreateModalOpen(false)\r\n      if (!courtSession && activeSessionId) {\r\n         navigate(`/court/${activeSessionId}`)\r\n      }\r\n    } catch (startError) {\r\n      console.error('Error starting/summoning:', startError)\r\n      const message =\r\n        (startError as any)?.message ||\r\n        (typeof startError === 'string' ? startError : 'Failed to action')\r\n      toast.error(`Error: ${message}`)\r\n    } finally {\r\n      setIsStartingSession(false)\r\n    }\r\n  }\r\n\r\n  const handleEndCourtSession = async () => {\r\n    if (!courtSession?.id) {\r\n      toast.error('No active court session ID found')\r\n      return\r\n    }\r\n    \r\n    if (!confirm('Are you sure you want to end this court session?')) return\r\n\r\n    try {\r\n      console.log('Ending court session RPC, sessionId=', String(courtSession.id))\r\n      const { error } = await supabase.rpc('end_court_session', { p_session_id: String(courtSession.id) })\r\n      \r\n      if (error) {\r\n        console.error('end_court_session RPC error:', error)\r\n        throw error\r\n      }\r\n      \r\n      setCourtSession(null)\r\n      toast.success('Court session ended')\r\n      loadCourtState() // Force refresh to confirm\r\n    } catch (err: any) {\r\n      console.error('Failed to end court session:', err)\r\n      toast.error(`Failed to end court session: ${err?.message || err}`)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"text-center\">\r\n          <div className=\"flex items-center justify-center gap-3 mb-4\">\r\n            <Scale className=\"w-12 h-12 text-purple-400\" />\r\n            <div>\r\n              <h1 className=\"text-4xl font-bold\">Troll Court</h1>\r\n              <p className=\"text-gray-400\">Justice, drama, and official rulings for Troll City</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Court Status */}\r\n        <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <Gavel className=\"w-6 h-6 text-purple-400\" />\r\n              <h2 className=\"text-xl font-bold\">Court Status</h2>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              {courtSession ? (\r\n                <span className=\"px-3 py-1 bg-green-600 text-white rounded-full text-sm flex items-center gap-1\">\r\n                  <div className=\"w-2 h-2 bg-green-400 rounded-full animate-pulse\"></div>\r\n                  In Session\r\n                </span>\r\n              ) : (\r\n                <span className=\"px-3 py-1 bg-gray-600 text-white rounded-full text-sm flex items-center gap-2\">\r\n                  <Clock className=\"w-4 h-4 text-purple-400\" />\r\n                  CLOSED ‚Ä¢ OPENS IN {timeUntilOpen}\r\n                </span>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {courtSession ? (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"bg-green-900/20 border border-green-500/30 rounded-lg p-4\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <CheckCircle className=\"w-5 h-5 text-green-400\" />\r\n                  <span className=\"font-semibold text-green-400\">Court is in Session</span>\r\n                </div>\r\n                <p className=\"text-sm text-gray-300\">\r\n                  Session started by authorized personnel. Official rulings and judgments may be issued.\r\n                </p>\r\n                <div className=\"mt-3 text-xs text-gray-400\">\r\n                  Started: {new Date(courtSession.created_at || courtSession.startedAt).toLocaleString()}\r\n                </div>\r\n              </div>\r\n\r\n              <button\r\n                onClick={() => setIsFileLawsuitModalOpen(true)}\r\n                className=\"w-full bg-red-900/20 hover:bg-red-900/40 border border-red-500/50 text-red-200 py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all\"\r\n              >\r\n                <Gavel className=\"w-5 h-5\" />\r\n                Take User To Court (File Lawsuit)\r\n              </button>\r\n\r\n              <div className=\"space-y-3\">\r\n                <button\r\n                  onClick={() => navigate(`/court/${courtSession.id}`)}\r\n                  className=\"w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2\"\r\n                >\r\n                  <Users className=\"w-4 h-4\" />\r\n                  Enter Court Room\r\n                </button>\r\n                {canStartCourt && (\r\n                  <>\r\n                    <button\r\n                      onClick={openCreateModal}\r\n                      className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2\"\r\n                    >\r\n                      <Gavel className=\"w-4 h-4\" />\r\n                      Summon User\r\n                    </button>\r\n                    <button\r\n                      onClick={handleEndCourtSession}\r\n                      className=\"w-full py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-colors\"\r\n                    >\r\n                      End Court Session\r\n                    </button>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {pendingSummons.length > 0 && (\r\n                <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <AlertTriangle className=\"w-5 h-5 text-yellow-400\" />\r\n                    <span className=\"font-semibold text-yellow-300\">You have a court summon</span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-300\">\r\n                    {pendingSummons[0]?.reason ? pendingSummons[0].reason : 'You have been summoned to Troll Court.'}\r\n                  </div>\r\n                </div>\r\n              )}\r\n              <div className=\"bg-gray-900/50 border border-gray-500/30 rounded-lg p-4\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <Clock className=\"w-5 h-5 text-gray-400\" />\r\n                  <span className=\"font-semibold text-gray-400\">Court is Adjourned</span>\r\n                </div>\r\n                <p className=\"text-sm text-gray-300\">\r\n                  No active court session. Troll Court is available for viewing official rulings and case history.\r\n                </p>\r\n                \r\n                <button\r\n                  onClick={() => setIsFileLawsuitModalOpen(true)}\r\n                  className=\"mt-4 w-full bg-red-900/20 hover:bg-red-900/40 border border-red-500/50 text-red-200 py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all\"\r\n                >\r\n                  <Gavel className=\"w-5 h-5\" />\r\n                  Take User To Court (File Lawsuit)\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-3\">\r\n                <button\r\n                  disabled\r\n                  className=\"w-full py-3 bg-gray-600 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 cursor-not-allowed\"\r\n                >\r\n                  <Users className=\"w-4 h-4\" />\r\n                  No Active Session\r\n                </button>\r\n                {canStartCourt ? (\r\n                  <button\r\n                    onClick={openCreateModal}\r\n                    disabled={isStartingSession}\r\n                    className=\"w-full py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2\"\r\n                  >\r\n                    {isStartingSession ? (\r\n                      <>\r\n                        <div className=\"animate-spin h-4 w-4 border-2 border-white rounded-full border-b-transparent\"></div>\r\n                        Starting Session...\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <Gavel className=\"w-4 h-4\" />\r\n                        Start Court Session\r\n                      </>\r\n                    )}\r\n                  </button>\r\n                ) : (\r\n                  <div className=\"bg-red-900/20 border border-red-500/30 rounded-lg p-4\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <AlertTriangle className=\"w-5 h-5 text-red-400\" />\r\n                      <span className=\"font-semibold text-red-400\">Access Restricted</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-gray-300\">\r\n                      You are not authorized to start a court session. Only Troll Officers and administrators may initiate official court proceedings.\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Court Rules */}\r\n        <div className=\"grid md:grid-cols-2 gap-6\">\r\n          <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n            <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n              <Scale className=\"w-5 h-5 text-purple-400\" />\r\n              Court Rules\r\n            </h3>\r\n            <div className=\"space-y-3 text-sm text-gray-300\">\r\n              <div className=\"flex items-start gap-2\">\r\n                <div className=\"w-2 h-2 bg-purple-400 rounded-full mt-2 flex-shrink-0\"></div>\r\n                <p>All rulings must be issued by authorized Troll Court officials</p>\r\n              </div>\r\n              <div className=\"flex items-start gap-2\">\r\n                <div className=\"w-2 h-2 bg-purple-400 rounded-full mt-2 flex-shrink-0\"></div>\r\n                <p>Evidence must be presented before any judgment is made</p>\r\n              </div>\r\n              <div className=\"flex items-start gap-2\">\r\n                <div className=\"w-2 h-2 bg-purple-400 rounded-full mt-2 flex-shrink-0\"></div>\r\n                <p>Appeals may be filed within 24 hours of ruling</p>\r\n              </div>\r\n              <div className=\"flex items-start gap-2\">\r\n                <div className=\"w-2 h-2 bg-purple-400 rounded-full mt-2 flex-shrink-0\"></div>\r\n                <p>All court sessions are recorded for transparency</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n            <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n              <Users className=\"w-5 h-5 text-purple-400\" />\r\n              Court Officials\r\n            </h3>\r\n            <div className=\"space-y-3\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-sm\">Chief Justice</span>\r\n                <span className=\"text-xs px-2 py-1 bg-purple-600 rounded-full\">Admin</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-sm\">Senior Judges</span>\r\n                <span className=\"text-xs px-2 py-1 bg-blue-600 rounded-full\">Lead Officers</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-sm\">Court Officers</span>\r\n                <span className=\"text-xs px-2 py-1 bg-green-600 rounded-full\">Troll Officers</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-sm\">Court Clerk</span>\r\n                <span className=\"text-xs px-2 py-1 bg-gray-600 rounded-full\">System</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Assigned Cases (Judge View) */}\r\n        {assignedCases.length > 0 && (\r\n          <div className=\"bg-zinc-900 rounded-xl border border-purple-500/50 p-6 shadow-lg shadow-purple-900/10\">\r\n            <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n              <Gavel className=\"w-5 h-5 text-purple-400\" />\r\n              Court Docket (Assigned to You)\r\n            </h3>\r\n            <div className=\"space-y-3\">\r\n              {assignedCases.map((c) => (\r\n                <div key={c.id} className=\"bg-purple-900/20 rounded-lg p-4 border border-purple-500/30\">\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <span className=\"font-semibold text-purple-200\">\r\n                      Case #{c.case_number}: {c.category}\r\n                    </span>\r\n                    <span className=\"text-xs px-2 py-1 bg-purple-600 rounded-full text-white\">\r\n                      ACTION REQUIRED\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex justify-between text-sm text-gray-300 mb-2\">\r\n                    <span>Plaintiff: {c.plaintiff?.username}</span>\r\n                    <span>Defendant: {c.defendant?.username}</span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-400 italic\">\"{c.description}\"</div>\r\n                  \r\n                  <div className=\"mt-3 flex gap-2\">\r\n                      <button \r\n                        onClick={() => setSelectedCaseForRuling(c)}\r\n                        className=\"text-xs bg-purple-600 hover:bg-purple-500 px-3 py-1 rounded text-white font-semibold\"\r\n                      >\r\n                          Open Case File\r\n                      </button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* My Civil Cases */}\r\n        {myCivilCases.length > 0 && (\r\n          <div className=\"bg-zinc-900 rounded-xl border border-red-500/20 p-6\">\r\n            <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n              <Scale className=\"w-5 h-5 text-red-400\" />\r\n              My Civil Lawsuits\r\n            </h3>\r\n\r\n            <div className=\"space-y-3\">\r\n              {myCivilCases.map((c) => (\r\n                <div key={c.id} className=\"bg-gray-900/50 rounded-lg p-4 border border-red-500/10\">\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <span className=\"font-semibold text-red-200\">\r\n                      {c.category} \r\n                      <span className=\"text-gray-500 text-xs ml-2\">#{c.case_number}</span>\r\n                    </span>\r\n                    <span className={`text-xs px-2 py-1 rounded-full ${\r\n                      c.status === 'ruled' ? 'bg-green-600' : \r\n                      c.status === 'dismissed' ? 'bg-gray-600' : 'bg-yellow-600'\r\n                    }`}>\r\n                      {c.status.toUpperCase()}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex justify-between text-sm text-gray-300\">\r\n                    <span>vs {c.defendant_id === user?.id ? c.plaintiff?.username : c.defendant?.username}</span>\r\n                    <span>Claim: {c.claim_amount} coins</span>\r\n                  </div>\r\n                  {c.ruling_verdict && (\r\n                    <div className=\"mt-2 text-xs bg-black/20 p-2 rounded text-gray-300\">\r\n                        Verdict: <span className=\"font-bold text-white\">{c.ruling_verdict}</span>\r\n                        {c.judgment_amount > 0 && ` - Award: ${c.judgment_amount}`}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Recent Cases */}\r\n        <div className=\"bg-zinc-900 rounded-xl border border-purple-500/20 p-6\">\r\n          <h3 className=\"text-lg font-bold mb-4 flex items-center gap-2\">\r\n            <Gavel className=\"w-5 h-5 text-purple-400\" />\r\n            Recent Court Cases\r\n          </h3>\r\n\r\n          <div className=\"space-y-3\">\r\n            {recentCases.length > 0 ? (\r\n              recentCases.map((c) => (\r\n                <div key={c.id} className=\"bg-gray-900/50 rounded-lg p-4\">\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <span className=\"font-semibold\">{c.title || `Case #${c.id.slice(0, 8)}`}</span>\r\n                    <span className={`text-xs px-2 py-1 rounded-full ${\r\n                      c.status === 'resolved' ? 'bg-green-600' : \r\n                      c.status === 'in_session' ? 'bg-purple-600' : 'bg-yellow-600'\r\n                    }`}>\r\n                      {c.status === 'in_session' ? 'In Session' : \r\n                       c.status === 'resolved' ? 'Resolved' : 'Pending'}\r\n                    </span>\r\n                  </div>\r\n                  <p className=\"text-sm text-gray-300\">{c.description || 'No description provided'}</p>\r\n                  <div className=\"text-xs text-gray-500 mt-1 flex justify-between\">\r\n                    <span>\r\n                      {c.defendant?.username ? `Defendant: ${c.defendant.username}` : ''}\r\n                    </span>\r\n                    <span>\r\n                      {new Date(c.created_at).toLocaleDateString()}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              ))\r\n            ) : (\r\n              <div className=\"text-center text-gray-500 py-4\">No recent cases found</div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Create Session Modal */}\r\n      {isCreateModalOpen && (\r\n        <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-[#171427] border border-purple-500/30 rounded-xl p-6 max-w-md w-full shadow-2xl\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h3 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n                <Gavel className=\"w-5 h-5 text-purple-400\" />\r\n                Start Court Session\r\n              </h3>\r\n              <button \r\n                onClick={() => setIsCreateModalOpen(false)}\r\n                className=\"text-gray-400 hover:text-white transition-colors\"\r\n              >\r\n                <X className=\"w-6 h-6\" />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"space-y-4\">\r\n              {/* Case Type Selection */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  Case Type (Required for Summoning)\r\n                </label>\r\n                <select\r\n                  value={selectedCaseType}\r\n                  onChange={(e) => setSelectedCaseType(e.target.value)}\r\n                  className=\"w-full bg-[#0E0A1A] border border-purple-500/30 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-purple-500 appearance-none cursor-pointer\"\r\n                >\r\n                  <option value=\"\">-- Select Case Reason --</option>\r\n                  {CASE_TYPES.map((type) => (\r\n                    <option key={type} value={type}>\r\n                      {type}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\r\n                  Select Defendant (Optional)\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <Search className=\"absolute left-3 top-3 w-5 h-5 text-gray-500\" />\r\n                  <input\r\n                    type=\"text\"\r\n                    value={searchQuery}\r\n                    onChange={(e) => {\r\n                      setSearchQuery(e.target.value)\r\n                      setShowDropdown(true)\r\n                      if (selectedUser) setSelectedUser(null)\r\n                    }}\r\n                    onFocus={() => setShowDropdown(true)}\r\n                    onBlur={() => setTimeout(() => setShowDropdown(false), 200)}\r\n                    placeholder=\"Search username (min 3 chars)...\"\r\n                    className=\"w-full bg-[#0E0A1A] border border-purple-500/30 rounded-lg pl-10 pr-4 py-2.5 text-white focus:outline-none focus:border-purple-500\"\r\n                  />\r\n                  {showDropdown && (\r\n                    <UserSearchDropdown\r\n                      query={searchQuery}\r\n                      onSelect={(userId, username) => {\r\n                        setSelectedUser({ id: userId, username })\r\n                        setSearchQuery(username)\r\n                        setShowDropdown(false)\r\n                      }}\r\n                      onClose={() => setShowDropdown(false)}\r\n                      disableNavigation\r\n                    />\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {selectedUser && (\r\n                <div className=\"bg-purple-900/20 border border-purple-500/30 rounded-lg p-3 flex items-center gap-3\">\r\n                  <div className=\"text-sm text-purple-300\">Selected Defendant:</div>\r\n                  <div className=\"font-semibold text-white\">{selectedUser.username}</div>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"flex gap-3 mt-6\">\r\n                <button\r\n                  onClick={() => setIsCreateModalOpen(false)}\r\n                  className=\"flex-1 py-2.5 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition-colors\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  onClick={handleSummonOrStart}\r\n                  disabled={isStartingSession}\r\n                  className=\"flex-1 py-2.5 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2\"\r\n                >\r\n                  {isStartingSession ? 'Processing...' : (courtSession ? 'Summon User' : 'Start Session')}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <FileLawsuitModal\r\n        isOpen={isFileLawsuitModalOpen}\r\n        onClose={() => setIsFileLawsuitModalOpen(false)}\r\n        onSuccess={() => {\r\n            // Refresh cases if needed\r\n         }}\r\n       />\r\n\r\n       <JudgeRulingModal\r\n         isOpen={!!selectedCaseForRuling}\r\n         caseData={selectedCaseForRuling}\r\n         onClose={() => setSelectedCaseForRuling(null)}\r\n         onSuccess={() => {\r\n            setSelectedCaseForRuling(null)\r\n            // Ideally trigger refresh here, but for now user can refresh page or wait for next interval if any\r\n            // We should add a refresh trigger to dependency array of useEffect if we want auto-refresh\r\n         }}\r\n       />\r\n     </div>\r\n   )\r\n }\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollCourtSession.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollFamily.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollFamilyCity.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollIdentityLab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollMart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollOfficerApplication.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollOfficerLounge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollerApplication.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":117,"column":67,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4117,4138],"text":"DO&apos;s - Best Practices"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4117,4138],"text":"DO&lsquo;s - Best Practices"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4117,4138],"text":"DO&#39;s - Best Practices"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4117,4138],"text":"DO&rsquo;s - Best Practices"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":146,"column":40,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5957,6018],"text":"Follow Troll City&apos;s Terms of Service and Community Guidelines"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5957,6018],"text":"Follow Troll City&lsquo;s Terms of Service and Community Guidelines"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5957,6018],"text":"Follow Troll City&#39;s Terms of Service and Community Guidelines"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5957,6018],"text":"Follow Troll City&rsquo;s Terms of Service and Community Guidelines"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":171,"column":66,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7411,7438],"text":"DON&apos;Ts - Prohibited Actions"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7411,7438],"text":"DON&lsquo;Ts - Prohibited Actions"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7411,7438],"text":"DON&#39;Ts - Prohibited Actions"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7411,7438],"text":"DON&rsquo;Ts - Prohibited Actions"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":432,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City&apos;s Community Guidelines, Terms of Service, and the DO's and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City&lsquo;s Community Guidelines, Terms of Service, and the DO's and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City&#39;s Community Guidelines, Terms of Service, and the DO's and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City&rsquo;s Community Guidelines, Terms of Service, and the DO's and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":432,"column":112,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO&apos;s and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO&lsquo;s and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO&#39;s and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO&rsquo;s and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":432,"column":122,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO's and DON&apos;Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO's and DON&lsquo;Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO's and DON&#39;Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[19871,20135],"text":"\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO's and DON&rsquo;Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { CheckCircle, XCircle } from 'lucide-react'\r\n\r\nexport default function TrollerApplication() {\r\n  const { profile } = useAuthStore()\r\n  const [formData, setFormData] = useState({\r\n    fullName: '',\r\n    email: '',\r\n    age: '',\r\n    location: '',\r\n    bio: '',\r\n    contentStyle: '',\r\n    streamingExperience: '',\r\n    goals: '',\r\n    uniqueValue: '',\r\n    availability: '',\r\n    equipment: '',\r\n    socialMedia: ''\r\n  })\r\n  const [agreedToGuidelines, setAgreedToGuidelines] = useState(false)\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\r\n    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }))\r\n  }\r\n\r\n  const submit = async (e?: React.FormEvent) => {\r\n    e?.preventDefault()\r\n    if (!profile) return toast.error('Please sign in')\r\n    \r\n    const requiredFields = ['fullName', 'email', 'age', 'bio', 'contentStyle', 'goals', 'availability']\r\n    const missingFields = requiredFields.filter(field => !formData[field as keyof typeof formData].trim())\r\n    \r\n    if (missingFields.length > 0) {\r\n      return toast.error('Please complete all required fields')\r\n    }\r\n\r\n    if (!agreedToGuidelines) {\r\n      return toast.error('You must agree to the Community Guidelines')\r\n    }\r\n\r\n    try {\r\n      setLoading(true)\r\n      \r\n      const applicationData = {\r\n        user_id: profile.id,\r\n        type: 'troller',\r\n        reason: formData.bio,\r\n        goals: formData.goals,\r\n        data: {\r\n          username: profile.username,\r\n          fullName: formData.fullName,\r\n          email: formData.email,\r\n          age: formData.age,\r\n          location: formData.location,\r\n          contentStyle: formData.contentStyle,\r\n          streamingExperience: formData.streamingExperience,\r\n          uniqueValue: formData.uniqueValue,\r\n          availability: formData.availability,\r\n          equipment: formData.equipment,\r\n          socialMedia: formData.socialMedia\r\n        },\r\n        status: 'pending'\r\n      }\r\n      \r\n      const { error } = await supabase.from('applications').insert([applicationData])\r\n      \r\n      if (error) {\r\n        console.error('[Troller App] Submission error:', error)\r\n        toast.error(error.message || 'Failed to submit application')\r\n        throw error\r\n      }\r\n      \r\n      toast.success('Application submitted successfully! We will review your application and get back to you within 3-5 business days.')\r\n      setFormData({\r\n        fullName: '',\r\n        email: '',\r\n        age: '',\r\n        location: '',\r\n        bio: '',\r\n        contentStyle: '',\r\n        streamingExperience: '',\r\n        goals: '',\r\n        uniqueValue: '',\r\n        availability: '',\r\n        equipment: '',\r\n        socialMedia: ''\r\n      })\r\n      setAgreedToGuidelines(false)\r\n    } catch (err) {\r\n      console.error('Submit error:', err)\r\n      toast.error('Failed to submit application')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-8\">\r\n      <div className=\"max-w-5xl mx-auto\">\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-cyan-400 via-pink-400 to-purple-400 bg-clip-text text-transparent mb-2\">\r\n            Troller Application\r\n          </h1>\r\n          <p className=\"text-[#E2E2E2]/60\">Join the Troll City streaming community</p>\r\n        </div>\r\n\r\n        {/* Guidelines Section */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\r\n          {/* DO's */}\r\n          <div className=\"bg-gradient-to-br from-green-900/20 to-green-800/10 rounded-xl p-6 border border-green-500/30\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <CheckCircle className=\"text-green-400\" size={32} />\r\n              <h2 className=\"text-2xl font-bold text-green-400\">DO's - Best Practices</h2>\r\n            </div>\r\n            <ul className=\"space-y-3 text-sm text-[#E2E2E2]/90\">\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span><strong>Do troll with all means</strong> - Bring your unique trolling style and creativity</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Create engaging, entertaining content that brings positive energy</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Interact actively with your viewers and build community</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Stream consistently and maintain a regular schedule</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Respect all community members and promote inclusivity</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Use high-quality audio and video equipment when possible</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Follow Troll City's Terms of Service and Community Guidelines</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Promote your streams on social media to grow your audience</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Thank viewers for gifts and engagement</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Collaborate with other streamers to cross-promote</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <CheckCircle className=\"text-green-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Report any technical issues or violations to officers/admins</span>\r\n              </li>\r\n            </ul>\r\n          </div>\r\n\r\n          {/* DON'Ts */}\r\n          <div className=\"bg-gradient-to-br from-red-900/20 to-red-800/10 rounded-xl p-6 border border-red-500/30\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <XCircle className=\"text-red-400\" size={32} />\r\n              <h2 className=\"text-2xl font-bold text-red-400\">DON'Ts - Prohibited Actions</h2>\r\n            </div>\r\n            <ul className=\"space-y-3 text-sm text-[#E2E2E2]/90\">\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Stream illegal activities, violence, or harmful content</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Engage in harassment, bullying, or hate speech</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Share explicit adult content or nudity</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Use bots or fake accounts to inflate viewer numbers</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Spam chat or encourage spam from viewers</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Stream copyrighted content without permission</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Dox or share personal information of others</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Engage in or promote illegal gambling or scams</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Stream while intoxicated or under the influence</span>\r\n              </li>\r\n              <li className=\"flex items-start gap-2\">\r\n                <XCircle className=\"text-red-400 mt-0.5 flex-shrink-0\" size={16} />\r\n                <span>Attempt to manipulate the platform or abuse features</span>\r\n              </li>\r\n            </ul>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Application Form */}\r\n        <form onSubmit={submit} className=\"bg-[#1A1A1A] rounded-xl p-6 border border-[#2C2C2C] space-y-6\">\r\n          {/* Personal Information */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">Personal Information</h3>\r\n            \r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Full Name <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  name=\"fullName\"\r\n                  value={formData.fullName}\r\n                  onChange={handleChange}\r\n                  placeholder=\"First and Last Name\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                  required\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Email Address <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"email\"\r\n                  name=\"email\"\r\n                  value={formData.email}\r\n                  onChange={handleChange}\r\n                  placeholder=\"your.email@example.com\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Age <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"number\"\r\n                  name=\"age\"\r\n                  value={formData.age}\r\n                  onChange={handleChange}\r\n                  placeholder=\"Must be 18+\"\r\n                  min=\"18\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                  required\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                  Location <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  name=\"location\"\r\n                  value={formData.location}\r\n                  onChange={handleChange}\r\n                  placeholder=\"City, Country\"\r\n                  className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* About You */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">About You</h3>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Tell us about yourself <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <textarea\r\n                name=\"bio\"\r\n                value={formData.bio}\r\n                onChange={handleChange}\r\n                placeholder=\"Share your personality, interests, and what makes you unique...\"\r\n                rows={4}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Content Style & Niche <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <textarea\r\n                name=\"contentStyle\"\r\n                value={formData.contentStyle}\r\n                onChange={handleChange}\r\n                placeholder=\"What type of content will you create? (e.g., gaming, music, talk shows, creative arts, lifestyle, etc.)\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Previous Streaming Experience <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <textarea\r\n                name=\"streamingExperience\"\r\n                value={formData.streamingExperience}\r\n                onChange={handleChange}\r\n                placeholder=\"Have you streamed before? On which platforms? Share your experience...\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Goals & Vision */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">Goals & Vision</h3>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Your Goals as a Troller <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <textarea\r\n                name=\"goals\"\r\n                value={formData.goals}\r\n                onChange={handleChange}\r\n                placeholder=\"What do you hope to achieve on Troll City? How will you engage and grow your community?\"\r\n                rows={4}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                What makes you unique? <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <textarea\r\n                name=\"uniqueValue\"\r\n                value={formData.uniqueValue}\r\n                onChange={handleChange}\r\n                placeholder=\"What will set you apart from other streamers? What unique value do you bring?\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Technical & Logistics */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold text-pink-400 border-b border-[#2C2C2C] pb-2\">Technical & Availability</h3>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Streaming Availability <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"availability\"\r\n                value={formData.availability}\r\n                onChange={handleChange}\r\n                placeholder=\"e.g., Weekdays 6PM-10PM EST, Weekends flexible\"\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Equipment & Setup <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <textarea\r\n                name=\"equipment\"\r\n                value={formData.equipment}\r\n                onChange={handleChange}\r\n                placeholder=\"Describe your streaming setup (camera, microphone, internet speed, software, etc.)\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none resize-none\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-[#E2E2E2]/90 mb-2\">\r\n                Social Media Links <span className=\"text-[#E2E2E2]/50\">(Optional)</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"socialMedia\"\r\n                value={formData.socialMedia}\r\n                onChange={handleChange}\r\n                placeholder=\"Instagram, TikTok, Twitter/X, YouTube, etc.\"\r\n                className=\"w-full px-4 py-3 bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg focus:border-cyan-400 focus:outline-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Agreement */}\r\n          <div className=\"bg-[#0D0D0D] border border-[#2C2C2C] rounded-lg p-4\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"guidelines\"\r\n                checked={agreedToGuidelines}\r\n                onChange={(e) => setAgreedToGuidelines(e.target.checked)}\r\n                className=\"mt-1 w-5 h-5 rounded border-gray-600 bg-[#1A1A1A] focus:ring-cyan-400 focus:ring-offset-0\"\r\n                required\r\n              />\r\n              <label htmlFor=\"guidelines\" className=\"text-sm text-[#E2E2E2]/80 cursor-pointer\">\r\n                I have read and agree to follow Troll City's Community Guidelines, Terms of Service, and the DO's and DON'Ts listed above. \r\n                I understand that violations may result in suspension or permanent ban from the platform.\r\n              </label>\r\n            </div>\r\n          </div>\r\n\r\n          <button\r\n            type=\"submit\"\r\n            disabled={loading || !agreedToGuidelines}\r\n            className=\"w-full px-6 py-4 bg-gradient-to-r from-[#FFC93C] to-[#FFD700] text-black rounded-lg font-bold text-lg hover:shadow-lg hover:shadow-[#FFC93C]/30 disabled:opacity-50 disabled:cursor-not-allowed transition-all\"\r\n          >\r\n            {loading ? 'Submitting Application...' : 'Submit Application'}\r\n          </button>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollerInsurance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Trollifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TrollsTownPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TromodyShow.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TromodyShow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\TromodyShowBroadcast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Troting.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isEligible' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":41,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":20}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkEligibility'. Either include it or remove the dependency array.","line":53,"column":6,"nodeType":"ArrayExpression","endLine":53,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [checkEligibility, user]","fix":{"range":[1755,1761],"text":"[checkEligibility, user]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { Vote, Calendar, Trophy, Plus, AlertCircle, Loader2, XCircle, ShieldAlert, Trash2, ThumbsUp, ThumbsDown } from 'lucide-react'\r\nimport { getWeeklyTopBroadcasters } from '../lib/leaderboards'\r\nimport TrotingAdminView from '../components/TrotingAdminView'\r\n\r\ninterface Pitch {\r\n  id: string\r\n  title: string\r\n  description: string\r\n  image_url?: string\r\n  user_id: string\r\n  vote_count: number\r\n  up_votes: number\r\n  down_votes: number\r\n  created_at: string\r\n  author?: {\r\n    username: string\r\n    avatar_url: string\r\n  }\r\n}\r\n\r\ninterface Contest {\r\n  id: string\r\n  week_start: string\r\n  week_end: string\r\n  status: 'submission' | 'voting' | 'review' | 'completed'\r\n}\r\n\r\nexport default function Troting() {\r\n  const { user, profile } = useAuthStore()\r\n  const [activeTab, setActiveTab] = useState<'active' | 'upcoming' | 'results' | 'admin'>('active')\r\n  const [contest, setContest] = useState<Contest | null>(null)\r\n  const [pitches, setPitches] = useState<Pitch[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [submitting, setSubmitting] = useState(false)\r\n  const [votingId, setVotingId] = useState<string | null>(null)\r\n  const [showSubmitModal, setShowSubmitModal] = useState(false)\r\n  const [isEligible, setIsEligible] = useState(false)\r\n  \r\n  const isAdmin = profile?.role === 'admin' || profile?.is_admin\r\n\r\n  // Form State\r\n  const [title, setTitle] = useState('')\r\n  const [description, setDescription] = useState('')\r\n\r\n  useEffect(() => {\r\n    loadContest()\r\n    checkEligibility()\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user])\r\n\r\n  // Subscribe to real-time updates for votes\r\n  useEffect(() => {\r\n    if (!contest?.id) return\r\n\r\n    const channel = supabase\r\n      .channel('pitch_updates')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'UPDATE',\r\n          schema: 'public',\r\n          table: 'pitches',\r\n          filter: `contest_id=eq.${contest.id}`\r\n        },\r\n        (payload) => {\r\n          setPitches(current => \r\n            current.map(p => \r\n              p.id === payload.new.id \r\n                ? { ...p, vote_count: payload.new.vote_count }\r\n                : p\r\n            )\r\n          )\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel)\r\n    }\r\n  }, [contest?.id])\r\n\r\n  const checkEligibility = async () => {\r\n    if (!user) return\r\n    // Check if user is in top 5 broadcasters\r\n    const topBroadcasters = await getWeeklyTopBroadcasters(5)\r\n    const eligible = topBroadcasters.some(b => b.user_id === user.id)\r\n    setIsEligible(eligible)\r\n  }\r\n\r\n  const loadContest = async () => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Get current active or submission contest\r\n      const { data: contests, error } = await supabase\r\n        .from('pitch_contests')\r\n        .select('*')\r\n        .in('status', ['voting', 'submission'])\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n\r\n      if (error) throw error\r\n\r\n      const currentContest = contests?.[0]\r\n      setContest(currentContest || null)\r\n\r\n      if (currentContest) {\r\n        const { data: pitchData, error: pitchError } = await supabase\r\n          .from('pitches')\r\n          .select('*, author:user_profiles(username, avatar_url)')\r\n          .eq('contest_id', currentContest.id)\r\n          .order('vote_count', { ascending: false })\r\n\r\n        if (pitchError) throw pitchError\r\n        setPitches(pitchData || [])\r\n      }\r\n    } catch (err) {\r\n      console.error('Error loading contest:', err)\r\n      toast.error('Failed to load contest data')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleVote = async (pitch: Pitch) => {\r\n    if (!user) return\r\n    \r\n    try {\r\n      setVotingId(pitch.id)\r\n      \r\n      const { data, error } = await supabase.rpc('vote_for_pitch', {\r\n        p_pitch_id: pitch.id,\r\n        p_voter_id: user.id\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data.success) {\r\n        toast.success(`Voted for ${pitch.title}!`)\r\n        // Update local state optimistically or wait for subscription\r\n      } else {\r\n        toast.error(data.error || 'Failed to vote')\r\n      }\r\n    } catch (err) {\r\n      console.error('Vote error:', err)\r\n      toast.error('Failed to process vote')\r\n    } finally {\r\n      setVotingId(null)\r\n    }\r\n  }\r\n\r\n  const handleDeletePitch = async (pitch: Pitch) => {\n    if (!isAdmin && user?.id !== pitch.user_id) return\n    \n    if (!window.confirm('Are you sure you want to delete this pitch?')) return\n\n    try {\n      const { error } = await supabase\n        .from('pitches')\n        .delete()\n        .eq('id', pitch.id)\n\n      if (error) throw error\n\n      toast.success('Pitch deleted')\n      loadContest()\n    } catch (err) {\n      console.error('Delete error:', err)\n      toast.error('Failed to delete pitch')\n    }\n  }\n\n  const handleSubmitPitch = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (!user || !contest) return\r\n\r\n    try {\r\n      setSubmitting(true)\r\n      \r\n      const { error } = await supabase\r\n        .from('pitches')\r\n        .insert({\r\n          contest_id: contest.id,\r\n          user_id: user.id,\r\n          title,\r\n          description,\r\n          status: 'approved' // Auto-approve for now or 'pending' if moderation needed\r\n        })\r\n\r\n      if (error) throw error\r\n\r\n      toast.success('Pitch submitted successfully!')\r\n      setShowSubmitModal(false)\r\n      setTitle('')\r\n      setDescription('')\r\n      loadContest() // Reload to see new pitch\r\n    } catch (err) {\r\n      console.error('Submit error:', err)\r\n      toast.error('Failed to submit pitch')\r\n    } finally {\r\n      setSubmitting(false)\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"w-8 h-8 animate-spin text-purple-500\" />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-4 md:p-8 pb-24\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <div className=\"flex items-center justify-between mb-8\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Vote className=\"w-8 h-8 text-purple-400\" />\r\n            <div>\r\n              <h1 className=\"text-3xl font-bold\">Troting</h1>\r\n              <p className=\"text-gray-400\">Troll City Voting & Pitch Contests</p>\r\n            </div>\r\n          </div>\r\n          \r\n          {contest?.status === 'submission' && (\r\n            <button\r\n              onClick={() => setShowSubmitModal(true)}\r\n              className=\"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors\"\r\n            >\r\n              <Plus className=\"w-4 h-4\" />\r\n              Submit Pitch\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {/* Tabs */}\r\n        <div className=\"flex gap-4 mb-8 border-b border-gray-800 pb-2\">\r\n          <button\r\n            onClick={() => setActiveTab('active')}\r\n            className={`pb-2 px-2 font-medium transition-colors ${\r\n              activeTab === 'active' \r\n                ? 'text-purple-400 border-b-2 border-purple-400' \r\n                : 'text-gray-400 hover:text-white'\r\n            }`}\r\n          >\r\n            Active Votes\r\n          </button>\r\n          <button\r\n            onClick={() => setActiveTab('upcoming')}\r\n            className={`pb-2 px-2 font-medium transition-colors ${\r\n              activeTab === 'upcoming' \r\n                ? 'text-purple-400 border-b-2 border-purple-400' \r\n                : 'text-gray-400 hover:text-white'\r\n            }`}\r\n          >\r\n            Upcoming\r\n          </button>\r\n          <button\r\n            onClick={() => setActiveTab('results')}\r\n            className={`pb-2 px-2 font-medium transition-colors ${\r\n              activeTab === 'results' \r\n                ? 'text-purple-400 border-b-2 border-purple-400' \r\n                : 'text-gray-400 hover:text-white'\r\n            }`}\r\n          >\r\n            Past Results\r\n          </button>\r\n          \r\n          {isAdmin && (\r\n            <button\r\n              onClick={() => setActiveTab('admin')}\r\n              className={`pb-2 px-2 font-medium transition-colors flex items-center gap-2 ${\r\n                activeTab === 'admin' \r\n                  ? 'text-red-400 border-b-2 border-red-400' \r\n                  : 'text-gray-400 hover:text-red-400'\r\n              }`}\r\n            >\r\n              <ShieldAlert className=\"w-4 h-4\" />\r\n              Admin\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {/* Content */}\r\n        {activeTab === 'admin' && isAdmin && (\r\n          <TrotingAdminView />\r\n        )}\r\n\r\n        {activeTab === 'active' && (\r\n          <div>\r\n            {!contest ? (\r\n              <div className=\"text-center py-12 bg-gray-900/50 rounded-xl border border-gray-800\">\r\n                <Calendar className=\"w-12 h-12 text-gray-600 mx-auto mb-4\" />\r\n                <h3 className=\"text-xl font-semibold text-gray-300\">No Active Contests</h3>\r\n                <p className=\"text-gray-500 mt-2\">Check back later for new voting events.</p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"bg-purple-900/20 border border-purple-500/30 rounded-xl p-6\">\r\n                  <div className=\"flex items-center justify-between mb-4\">\r\n                    <h2 className=\"text-2xl font-bold flex items-center gap-2\">\r\n                      <Trophy className=\"w-6 h-6 text-yellow-400\" />\r\n                      Weekly Pitch Contest\r\n                    </h2>\r\n                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${\r\n                      contest.status === 'voting' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'\r\n                    }`}>\r\n                      {contest.status === 'voting' ? 'Voting Open' : 'Submissions Open'}\r\n                    </span>\r\n                  </div>\r\n                  <p className=\"text-gray-300\">\r\n                    Vote for your favorite broadcaster idea! Voting is free.\r\n                    {contest.status === 'submission' && ' Voting starts soon.'}\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                  {pitches.map((pitch) => (\r\n                    <div key={pitch.id} className=\"bg-gray-900 rounded-xl border border-gray-800 overflow-hidden hover:border-purple-500/50 transition-all\">\r\n                      <div className=\"p-6\">\r\n                        <div className=\"flex items-center gap-3 mb-4\">\r\n                          <img \r\n                            src={pitch.author?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${pitch.user_id}`} \r\n                            alt={pitch.author?.username}\r\n                            className=\"w-10 h-10 rounded-full bg-gray-800\"\r\n                          />\r\n                          <div>\r\n                            <h3 className=\"font-semibold text-white\">{pitch.title}</h3>\r\n                            <p className=\"text-sm text-gray-400\">by {pitch.author?.username}</p>\r\n                          </div>\r\n                        </div>\r\n                        \r\n                        <p className=\"text-gray-300 mb-6 min-h-[4.5rem] line-clamp-3\">\r\n                          {pitch.description}\r\n                        </p>\r\n\r\n                        <div className=\"flex items-center justify-between mt-auto\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <div className=\"text-2xl font-bold text-white\">{pitch.vote_count}</div>\r\n                            <span className=\"text-sm text-gray-500\">votes</span>\r\n                          </div>\r\n                          \r\n                          {contest.status === 'voting' && (\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <button\r\n                                    onClick={() => handleVote(pitch, 'up')}\r\n                                    disabled={votingId === pitch.id}\r\n                                    className=\"px-3 py-2 bg-green-600/20 hover:bg-green-600/30 text-green-400 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50\"\r\n                                >\r\n                                    <ThumbsUp className=\"w-5 h-5\" />\r\n                                    <span className=\"font-bold\">{pitch.up_votes || 0}</span>\r\n                                </button>\r\n                                \r\n                                <button\r\n                                    onClick={() => handleVote(pitch, 'down')}\r\n                                    disabled={votingId === pitch.id}\r\n                                    className=\"px-3 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50\"\r\n                                >\r\n                                    <ThumbsDown className=\"w-5 h-5\" />\r\n                                    <span className=\"font-bold\">{pitch.down_votes || 0}</span>\r\n                                </button>\r\n                            </div>\r\n                          )}\r\n                          \r\n                          {(isAdmin || (user && user.id === pitch.user_id)) && (\r\n                            <button\r\n                              onClick={() => handleDeletePitch(pitch)}\r\n                              className=\"p-2 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded-lg transition-colors ml-2\"\r\n                              title=\"Delete Pitch\"\r\n                            >\r\n                              <Trash2 className=\"w-5 h-5\" />\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'upcoming' && (\r\n          <div className=\"text-center py-12\">\r\n            <Calendar className=\"w-16 h-16 text-gray-700 mx-auto mb-4\" />\r\n            <h3 className=\"text-xl font-semibold text-gray-400\">No Upcoming Events</h3>\r\n            <p className=\"text-gray-600 mt-2\">Stay tuned for future contests!</p>\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'results' && (\r\n           <div className=\"text-center py-12\">\r\n            <Trophy className=\"w-16 h-16 text-gray-700 mx-auto mb-4\" />\r\n            <h3 className=\"text-xl font-semibold text-gray-400\">No Past Results</h3>\r\n            <p className=\"text-gray-600 mt-2\">Completed contest results will appear here.</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Submit Pitch Modal */}\r\n      {showSubmitModal && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4\">\r\n          <div className=\"bg-gray-900 rounded-xl max-w-lg w-full p-6 border border-gray-800\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-2xl font-bold\">Submit Pitch</h2>\r\n              <button \r\n                onClick={() => setShowSubmitModal(false)}\r\n                className=\"text-gray-400 hover:text-white\"\r\n              >\r\n                <XCircle className=\"w-6 h-6\" />\r\n              </button>\r\n            </div>\r\n            \r\n            <form onSubmit={handleSubmitPitch} className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-400 mb-1\">Title</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={title}\r\n                  onChange={(e) => setTitle(e.target.value)}\r\n                  className=\"w-full bg-black/50 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500\"\r\n                  placeholder=\"e.g. New Game Show Idea\"\r\n                  required\r\n                />\r\n              </div>\r\n              \r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-400 mb-1\">Description</label>\r\n                <textarea\r\n                  value={description}\r\n                  onChange={(e) => setDescription(e.target.value)}\r\n                  className=\"w-full bg-black/50 border border-gray-700 rounded-lg px-4 py-2 text-white h-32 focus:outline-none focus:border-purple-500\"\r\n                  placeholder=\"Describe your pitch...\"\r\n                  required\r\n                />\r\n              </div>\r\n\r\n              <div className=\"bg-yellow-900/20 border border-yellow-500/20 rounded-lg p-4 flex gap-3\">\r\n                <AlertCircle className=\"w-5 h-5 text-yellow-500 flex-shrink-0\" />\r\n                <p className=\"text-sm text-yellow-200\">\r\n                  By submitting, you agree that your pitch will be visible to all users and subject to community voting.\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end gap-3 pt-4\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowSubmitModal(false)}\r\n                  className=\"px-4 py-2 text-gray-400 hover:text-white\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={submitting}\r\n                  className=\"px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50\"\r\n                >\r\n                  {submitting ? 'Submitting...' : 'Submit Pitch'}\r\n                </button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\UserInventory.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AvatarCustomizer' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AvatarCustomizer"},"fix":{"range":[622,671],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cars' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"cars"},"fix":{"range":[673,712],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'loadInventory'. Either include it or remove the dependency array.","line":123,"column":6,"nodeType":"ArrayExpression","endLine":123,"endColumn":59,"suggestions":[{"desc":"Update the dependencies array to be: [user.id, inventory, perks, insurances, activeItems, loadInventory]","fix":{"range":[5945,5998],"text":"[user.id, inventory, perks, insurances, activeItems, loadInventory]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1233,"column":29,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click &quot;Activate\" on digital items"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click &ldquo;Activate\" on digital items"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click &#34;Activate\" on digital items"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click &rdquo;Activate\" on digital items"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1233,"column":38,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click \"Activate&quot; on digital items"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click \"Activate&ldquo; on digital items"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click \"Activate&#34; on digital items"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[55102,55137],"text":"‚Ä¢ Click \"Activate&rdquo; on digital items"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { supabase } from '../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { Package, Zap, Crown, Star, Palette, CheckCircle, XCircle, Sparkles, Shield, Phone, X, Car, Home } from 'lucide-react'\r\nimport { PERK_CONFIG } from '../lib/perkSystem'\r\nimport { ENTRANCE_EFFECTS_MAP, ROLE_BASED_ENTRANCE_EFFECTS, USER_SPECIFIC_ENTRANCE_EFFECTS } from '../lib/entranceEffects'\r\nimport { GlowingUsernameColorPicker } from '../components/GlowingUsernameColorPicker'\r\nimport AvatarCustomizer from './AvatarCustomizer'\r\nimport { cars } from '../data/vehicles'\r\nimport TitleDeedModal from '../components/TitleDeedModal'\r\nimport ShopConsumablesSection from '../components/ShopConsumablesSection'\r\n\r\nexport default function UserInventory({ embedded = false }: { embedded?: boolean }) {\r\n  const { user, profile, refreshProfile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [inventory, setInventory] = useState<any[]>([])\r\n  const [entranceEffects, setEntranceEffects] = useState<any[]>([])\r\n  const [perks, setPerks] = useState<any[]>([])\r\n  const [insurances, setInsurances] = useState<any[]>([])\r\n  const [callSounds, setCallSounds] = useState<any[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [activeItems, setActiveItems] = useState<Set<string>>(new Set())\r\n  const [showColorPickerModal, setShowColorPickerModal] = useState(false)\r\n  const [activeTab, setActiveTab] = useState<'items' | 'titles' | 'deeds' | 'shop'>('items')\r\n  const [userTitles, setUserTitles] = useState<any[]>([])\r\n  const [userDeeds, setUserDeeds] = useState<any[]>([])\r\n  const [selectedTitleDeed, setSelectedTitleDeed] = useState<any>(null)\r\n\r\n  // Delete all expired purchases, perks, and insurances\r\n  const deleteAllExpiredPurchases = useCallback(async () => {\r\n    if (!user?.id) return;\r\n    \r\n    // 10 second buffer - items expire 10 seconds AFTER their expiration time\r\n    const cutoffTime = new Date(Date.now() - 10000); // 10 seconds ago\r\n\r\n    // Expired inventory\r\n    const expiredInventory = inventory.filter(item => item.expires_at && new Date(item.expires_at) < cutoffTime && !activeItems.has(item.item_id));\r\n    // Expired perks\r\n    const expiredPerks = perks.filter(perk => perk.expires_at && new Date(perk.expires_at) < cutoffTime);\r\n    // Expired insurances\r\n    const expiredInsurances = insurances.filter(ins => ins.expires_at && new Date(ins.expires_at) < cutoffTime);\r\n    console.log('Expired inventory (buffered):', expiredInventory);\r\n    console.log('Expired perks (buffered):', expiredPerks);\r\n    console.log('Expired insurances (buffered):', expiredInsurances);\r\n\r\n    // Always attempt delete on Supabase, even if local state is empty, to ensure server is in sync\r\n    if (expiredInventory.length === 0 && expiredPerks.length === 0 && expiredInsurances.length === 0) {\r\n      // Try to delete any expired items from Supabase in case local state is out of sync\r\n      try {\r\n        const nowIso = cutoffTime.toISOString();\r\n        const invResp = await supabase.from('user_inventory')\r\n          .delete()\r\n          .not('expires_at', 'is', null)\r\n          .filter('expires_at', 'lt', nowIso)\r\n          .eq('user_id', user.id);\r\n        const perkResp = await supabase.from('user_perks')\r\n          .delete()\r\n          .not('expires_at', 'is', null)\r\n          .filter('expires_at', 'lt', nowIso)\r\n          .eq('user_id', user.id);\r\n        const insResp = await supabase.from('user_insurances')\r\n          .delete()\r\n          .not('expires_at', 'is', null)\r\n          .filter('expires_at', 'lt', nowIso)\r\n          .eq('user_id', user.id);\r\n        console.log('Delete responses:', { invResp, perkResp, insResp });\r\n        await loadInventory();\r\n      } catch (err) {\r\n        console.error('Delete all expired error:', err);\r\n      }\r\n      toast.info('No expired items to delete (checked with 10s buffer).');\r\n      return;\r\n    }\r\n    try {\r\n      console.log('Deleting expired inventory:', expiredInventory.map(i => i.id));\r\n      console.log('Deleting expired perks:', expiredPerks.map(i => i.id));\r\n      console.log('Deleting expired insurances:', expiredInsurances.map(i => i.id));\r\n      let deletedCount = 0;\r\n      // Delete expired inventory\r\n      if (expiredInventory.length > 0) {\r\n        const ids = expiredInventory.map(item => item.id);\r\n        const { error } = await supabase\r\n          .from('user_inventory')\r\n          .delete()\r\n          .in('id', ids)\r\n          .eq('user_id', user.id);\r\n        if (error) throw error;\r\n        setInventory(prev => prev.filter(entry => !ids.includes(entry.id)));\r\n        deletedCount += ids.length;\r\n      }\r\n      // Delete expired perks\r\n      if (expiredPerks.length > 0) {\r\n        const ids = expiredPerks.map(perk => perk.id);\r\n        const { error } = await supabase\r\n          .from('user_perks')\r\n          .delete()\r\n          .in('id', ids)\r\n          .eq('user_id', user.id);\r\n        if (error) throw error;\r\n        setPerks(prev => prev.filter(entry => !ids.includes(entry.id)));\r\n        deletedCount += ids.length;\r\n      }\r\n      // Delete expired insurances\r\n      if (expiredInsurances.length > 0) {\r\n        const ids = expiredInsurances.map(ins => ins.id);\r\n        const { error } = await supabase\r\n          .from('user_insurances')\r\n          .delete()\r\n          .in('id', ids)\r\n          .eq('user_id', user.id);\r\n        if (error) throw error;\r\n        setInsurances(prev => prev.filter(entry => !ids.includes(entry.id)));\r\n        deletedCount += ids.length;\r\n      }\r\n      await loadInventory();\r\n      toast.success(`Deleted ${deletedCount} expired item${deletedCount !== 1 ? 's' : ''}.`);\r\n    } catch (err) {\r\n      console.error('Error deleting expired items:', err);\r\n      toast.error('Failed to delete expired items');\r\n    }\r\n  }, [user?.id, inventory, perks, insurances, activeItems]);\r\n\r\n  const roleEffectKey = (() => {\r\n    if (!profile) return null;\r\n    const username = (profile.username || '').toLowerCase();\r\n    const userSpecific = Object.keys(USER_SPECIFIC_ENTRANCE_EFFECTS).find((k) => k.toLowerCase() === username);\r\n    if (userSpecific) return `user_${username}`;\r\n    if (profile.role === 'admin' || profile.troll_role === 'admin' || profile.is_admin) return 'admin';\r\n    if (profile.role === 'secretary' || profile.troll_role === 'secretary') return 'secretary';\r\n    if (profile.role === 'lead_troll_officer' || profile.troll_role === 'lead_troll_officer' || profile.is_lead_officer) return 'lead_troll_officer';\r\n    if (profile.role === 'troll_officer' || profile.troll_role === 'troll_officer') return 'troll_officer';\r\n    return null;\r\n  })();\r\n  const roleEffect = (() => {\r\n    if (!profile) return null;\r\n    const username = (profile.username || '').toLowerCase();\r\n    const userConfig = Object.entries(USER_SPECIFIC_ENTRANCE_EFFECTS).find(\r\n      ([key]) => key.toLowerCase() === username\r\n    )?.[1];\r\n    if (userConfig) return { ...userConfig, type: 'User Exclusive' };\r\n    const roleKey = roleEffectKey;\r\n    return roleKey && ROLE_BASED_ENTRANCE_EFFECTS[roleKey] ? ROLE_BASED_ENTRANCE_EFFECTS[roleKey] : null;\r\n  })();\r\n\r\n  const deleteInventoryItem = useCallback(\r\n    async (recordId: string, itemId: string) => {\r\n      if (!user?.id) return\r\n\r\n      if (activeItems.has(itemId)) {\r\n        toast.error('Deactivate item before deleting')\r\n        return\r\n      }\r\n\r\n      try {\r\n        const { error } = await supabase\r\n          .from('user_inventory')\r\n          .delete()\r\n          .eq('id', recordId)\r\n          .eq('user_id', user.id)\r\n\r\n        if (error) throw error\r\n\r\n        setInventory(prev => prev.filter(entry => entry.id !== recordId))\r\n        toast.success('Item deleted from inventory')\r\n      } catch (err) {\r\n        console.error('Error deleting inventory item:', err)\r\n        toast.error('Failed to delete item')\r\n      }\r\n    },\r\n    [user?.id, activeItems]\r\n  )\r\n  const loadInventory = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n\r\n      // Parallel fetch of all inventory types\r\n      const results = await Promise.all([\r\n        supabase.from('user_inventory').select('*').eq('user_id', user!.id).order('acquired_at', { ascending: false }),\r\n        supabase.from('user_entrance_effects').select('*').eq('user_id', user!.id).order('purchased_at', { ascending: false }),\r\n        supabase.from('user_perks').select('*').eq('user_id', user!.id).order('created_at', { ascending: false }),\r\n        supabase.from('user_insurances').select('*').eq('user_id', user!.id).order('created_at', { ascending: false }),\r\n        supabase\r\n          .from('user_active_items')\r\n          .select('item_id, item_type')\r\n          .eq('user_id', user!.id)\r\n          .eq('is_active', true),\r\n        supabase\r\n          .from('user_call_sounds')\r\n          .select('sound_id,is_active,call_sound_catalog(id,slug,name,sound_type,asset_url,price_coins)')\r\n          .eq('user_id', user!.id),\r\n        supabase.from('user_cars').select('*').eq('user_id', user!.id).order('purchased_at', { ascending: false }),\r\n        supabase.from('properties').select('*').eq('owner_id', user!.id).order('created_at', { ascending: false }),\r\n        supabase.from('vehicles_catalog').select('*')\r\n      ]);\r\n\r\n      const inventoryRes = results[0];\r\n      const effectsRes = results[1];\r\n      const perksRes = results[2];\r\n      const insuranceRes = results[3];\r\n      const activeRes = results[4];\r\n      const callSoundsRes = results[5];\r\n      const titlesRes = results[6];\r\n      const deedsRes = results[7];\r\n      const catalogRes = results[8];\r\n      \r\n      const carsCatalog = catalogRes.data || [];\r\n\r\n      // 1. Process Standard Inventory\r\n      const inventoryData = inventoryRes.data || []\r\n      const itemIds = Array.from(new Set(inventoryData.map((e: any) => e.item_id).filter(Boolean)))\r\n      \r\n      const itemDetailsMap: Record<string, any> = {}\r\n      if (itemIds.length) {\r\n        const { data: itemsData } = await supabase\r\n          .from('marketplace_items')\r\n          .select('id, title, description, type')\r\n          .in('id', itemIds)\r\n        itemsData?.forEach((item) => { itemDetailsMap[item.id] = item })\r\n      }\r\n      \r\n      setInventory(inventoryData.map((entry) => ({\r\n        ...entry,\r\n        marketplace_item: itemDetailsMap[entry.item_id] || null,\r\n      })).filter((item: any) => item.marketplace_item?.type !== 'physical'))\r\n\r\n      // 2. Process Entrance Effects\r\n      const effectsData = effectsRes.data || []\r\n      setEntranceEffects(effectsData.map(e => ({\r\n        ...e,\r\n        config: ENTRANCE_EFFECTS_MAP[e.effect_id]\r\n      })))\r\n\r\n      // 3. Process Perks\r\n      const perksData = perksRes.data || []\r\n      setPerks(perksData.map(p => ({\r\n        ...p,\r\n        config: PERK_CONFIG[p.perk_id as keyof typeof PERK_CONFIG]\r\n      })))\r\n\r\n      // 4. Process Insurance\r\n      const insuranceData = insuranceRes.data || []\r\n      const planIds = Array.from(new Set(insuranceData.map((i: any) => i.insurance_id).filter(Boolean)))\r\n      const insuranceMap: Record<string, any> = {}\r\n      \r\n      if (planIds.length > 0) {\r\n        // Fetch plan names from insurance_plans if available, or insurance_options\r\n        // Trying insurance_options first as per CoinStoreModal\r\n        const { data: plans } = await supabase\r\n          .from('insurance_options') \r\n          .select('id, name, description, icon')\r\n          .in('id', planIds)\r\n        \r\n        plans?.forEach((p) => { insuranceMap[p.id] = p })\r\n      }\r\n\r\n      setInsurances(insuranceData.map(i => ({\r\n        ...i,\r\n        plan: insuranceMap[i.insurance_id] || { name: 'Insurance Plan', description: 'Protection' }\r\n      })))\r\n\r\n      const callSoundsData = (callSoundsRes?.data || []).map((row: any) => ({\r\n        ...row,\r\n        catalog: row.call_sound_catalog\r\n      }));\r\n      setCallSounds(callSoundsData)\r\n\r\n      // Process Titles and Deeds\r\n      // Only show active vehicle title (one vehicle per user)\r\n      const allTitlesData = titlesRes.data || [];\r\n      const activeTitle = allTitlesData.find((t: any) => t.is_active === true);\r\n      const titlesData = activeTitle ? [activeTitle] : [];\r\n      const deedsData = deedsRes.data || [];\r\n      \r\n      setUserTitles(titlesData.map((t: any) => {\r\n         // Find car details for display\r\n         // Try matching by model_url first (reliable), then by car_id (legacy)\r\n         const carDef = carsCatalog.find((c: any) => \r\n             c.model_url === t.model_url || \r\n             c.id === t.car_id || \r\n             c.slug === t.car_id\r\n         );\r\n         return { ...t, carDef };\r\n      }));\r\n      \r\n      setUserDeeds(deedsData);\r\n      \r\n      // 5. Active Items\r\n      const activeSet = new Set(activeRes.data?.map(item => item.item_id) || [])\r\n      \r\n      // Also check active perks (they have is_active column)\r\n      perksData.forEach(p => {\r\n        if (p.is_active) activeSet.add(p.id)\r\n      })\r\n\r\n      // Also check active insurance\r\n      insuranceData.forEach(i => {\r\n        if (i.is_active) activeSet.add(i.id)\r\n      })\r\n\r\n      // Also check active entrance effects\r\n      // Note: user_entrance_effects usually doesn't have is_active for toggle, but let's check\r\n      // If we are using user_active_items table for entrance effects, then activeSet covers it.\r\n      // But if user_entrance_effects has is_active column, we should check it.\r\n      // Based on schema, user_entrance_effects might not have is_active, but we use user_active_items for effects.\r\n      \r\n      setActiveItems(activeSet)\r\n\r\n    } catch (err) {\r\n      console.error('Error loading inventory:', err)\r\n      toast.error('Failed to load inventory')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user])\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/auth', { replace: true })\r\n      return\r\n    }\r\n    \r\n    // Initial cleanup\r\n    const cleanup = async () => {\r\n      try {\r\n        await supabase.rpc('cleanup_expired_user_purchases')\r\n        loadInventory()\r\n      } catch (err) {\r\n        console.warn('Auto-cleanup failed:', err)\r\n        loadInventory()\r\n      }\r\n    }\r\n    \r\n    cleanup()\r\n    \r\n    // Periodic cleanup check (every 10s)\r\n    const interval = setInterval(() => {\r\n       cleanup()\r\n    }, 10000)\r\n\r\n    return () => clearInterval(interval)\r\n  }, [user, navigate, loadInventory])\r\n\r\n  const deleteItem = async (recordId: string, itemId: string, tableName: string, stateSetter: React.Dispatch<React.SetStateAction<any[]>>) => {\r\n    if (!user?.id) return;\r\n    if (activeItems.has(itemId)) {\r\n      toast.error('Deactivate item before deleting');\r\n      return;\r\n    }\r\n    // Confirmation is handled by caller if needed, but we can double check or just proceed.\r\n    // The caller at line 912 already confirms.\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(tableName)\r\n        .delete()\r\n        .eq('id', recordId)\r\n        .eq('user_id', user.id);\r\n\r\n      if (error) throw error;\r\n\r\n      stateSetter(prev => prev.filter(entry => entry.id !== recordId));\r\n      toast.success('Item deleted');\r\n    } catch (err) {\r\n      console.error('Error deleting item:', err);\r\n      toast.error('Failed to delete item');\r\n    }\r\n  };\r\n\r\n  const toggleEntranceEffect = async (effectId: string, isActive: boolean) => {\r\n    try {\r\n      // If we are deactivating, just set active effect to null\r\n      const newEffectId = isActive ? null : effectId;\r\n      \r\n      const { error } = await supabase.rpc('set_active_entrance_effect', { \r\n        p_effect_id: newEffectId,\r\n        p_item_type: 'effect'\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      // Update local state\r\n      setActiveItems(prev => {\r\n        const newSet = new Set(prev);\r\n        // Remove all entrance effects from active set (since DB deactivates all)\r\n        entranceEffects.forEach(e => newSet.delete(e.effect_id));\r\n        \r\n        // Also remove role effect if active\r\n        if (roleEffectKey) newSet.delete(`role_effect_${roleEffectKey}`);\r\n\r\n        // Add new one if activating\r\n        if (newEffectId) {\r\n          newSet.add(newEffectId);\r\n        }\r\n        return newSet;\r\n      });\r\n\r\n      toast.success(isActive ? 'Effect deactivated' : 'Effect activated');\r\n      loadInventory(); // Reload to be sure\r\n    } catch (err) {\r\n      console.error('Error toggling effect:', err);\r\n      toast.error('Failed to toggle effect');\r\n    }\r\n  };\r\n\r\n  const toggleRoleEffect = async (isActive: boolean) => {\r\n      if (!roleEffect) return;\r\n      const roleEffectId = `role_effect_${roleEffectKey || 'default'}`;\r\n\r\n      try {\r\n          if (isActive) {\r\n              // Deactivate\r\n              const { error } = await supabase.rpc('set_active_entrance_effect', { p_effect_id: null });\r\n              if (error) throw error;\r\n\r\n              setActiveItems(prev => {\r\n                  const newSet = new Set(prev);\r\n                  newSet.delete(roleEffectId);\r\n                  return newSet;\r\n              });\r\n              toast.success('Role effect deactivated');\r\n          } else {\r\n              // Activate\r\n              const { error } = await supabase.rpc('set_active_entrance_effect', { \r\n                  p_effect_id: roleEffectId,\r\n                  p_item_type: 'role_effect'\r\n              });\r\n              if (error) throw error;\r\n\r\n              setActiveItems(prev => {\r\n                  const newSet = new Set(prev);\r\n                  // Remove purchased effects from local state\r\n                  entranceEffects.forEach(e => newSet.delete(e.effect_id));\r\n                  // Add role effect\r\n                  newSet.add(roleEffectId);\r\n                  return newSet;\r\n              });\r\n              toast.success('Role effect activated');\r\n          }\r\n          loadInventory();\r\n      } catch (err) {\r\n          console.error('Error toggling role effect:', err);\r\n          toast.error('Failed to toggle role effect');\r\n      }\r\n  };\r\n\r\n  const toggleItemActivation = async (itemId: string, itemType: string) => {\r\n    try {\r\n      if (!itemType) {\r\n        toast.error('Item type is missing. Cannot activate.')\r\n        return\r\n      }\r\n\r\n      if (itemType === 'physical') {\r\n        toast.info('Physical items cannot be activated.')\r\n        return\r\n      }\r\n\r\n      if (activeItems.has(itemId)) {\r\n        const { error } = await supabase\r\n          .from('user_active_items')\r\n          .update({ is_active: false, updated_at: new Date().toISOString() })\r\n          .eq('user_id', user!.id)\r\n          .eq('item_id', itemId)\r\n          .eq('item_type', itemType)\r\n\r\n        if (error) throw error\r\n\r\n        setActiveItems(prev => {\r\n          const newSet = new Set(prev)\r\n          newSet.delete(itemId)\r\n          return newSet\r\n        })\r\n\r\n        toast.success('Item deactivated')\r\n      } else {\r\n        const allowMultiple = itemType === 'effect' || itemType === 'badge'\r\n\r\n        if (!allowMultiple) {\r\n          await supabase\r\n            .from('user_active_items')\r\n            .update({ is_active: false, updated_at: new Date().toISOString() })\r\n            .eq('user_id', user!.id)\r\n            .eq('item_type', itemType)\r\n        }\r\n\r\n        const { error } = await supabase\r\n          .from('user_active_items')\r\n          .upsert(\r\n            {\r\n              user_id: user!.id,\r\n              item_id: itemId,\r\n              item_type: itemType,\r\n              is_active: true,\r\n              activated_at: new Date().toISOString(),\r\n              updated_at: new Date().toISOString()\r\n            },\r\n            { onConflict: 'user_id,item_id' }\r\n          )\r\n\r\n        if (error) throw error\r\n\r\n        setActiveItems(prev => new Set([...prev, itemId]))\r\n        toast.success('Item activated!')\r\n      }\r\n    } catch (err) {\r\n      console.error('Error toggling item:', err)\r\n      toast.error('Failed to toggle item')\r\n    }\r\n  }\r\n\r\n  const togglePerk = async (perkId: string, isActive: boolean) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_perks')\r\n        .update({ is_active: !isActive })\r\n        .eq('id', perkId)\r\n\r\n      if (error) throw error\r\n\r\n      await supabase\r\n        .from('user_active_items')\r\n        .update({ is_active: false, updated_at: new Date().toISOString() })\r\n        .eq('user_id', user!.id)\r\n        .eq('item_type', 'perk')\r\n\r\n      if (!isActive) {\r\n        await supabase.from('user_active_items').upsert({\r\n          user_id: user!.id,\r\n          item_id: perkId,\r\n          item_type: 'perk',\r\n          is_active: true,\r\n          activated_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        }, { onConflict: 'user_id,item_id' })\r\n      }\r\n      \r\n      const perkEntry = perks.find((p) => p.id === perkId)\r\n      if (perkEntry?.perk_id === 'perk_rgb_username') {\r\n        const rgbValue = isActive ? null : perkEntry.expires_at\r\n        const { error: rgbError } = await supabase\r\n          .from('user_profiles')\r\n          .update({ rgb_username_expires_at: rgbValue })\r\n          .eq('id', user?.id)\r\n\r\n        if (rgbError) {\r\n          console.error('Failed to update RGB username status:', rgbError)\r\n        } else {\r\n          await refreshProfile()\r\n        }\r\n      }\r\n\r\n      setActiveItems(prev => {\r\n        const newSet = new Set(prev);\r\n        if (isActive) newSet.delete(perkId);\r\n        else newSet.add(perkId);\r\n        return newSet;\r\n      });\r\n      \r\n      toast.success(isActive ? 'Perk deactivated' : 'Perk activated');\r\n    } catch (err) {\r\n      console.error('Error toggling perk:', err);\r\n      toast.error('Failed to toggle perk');\r\n    }\r\n  };\r\n\r\n  const getItemIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'effect': return <Zap className=\"w-5 h-5 text-yellow-400\" />\r\n      case 'badge': return <Crown className=\"w-5 h-5 text-purple-400\" />\r\n      case 'ticket': return <Star className=\"w-5 h-5 text-blue-400\" />\r\n      case 'digital': return <Palette className=\"w-5 h-5 text-green-400\" />\r\n      case 'theme': return <Palette className=\"w-5 h-5 text-emerald-400\" />\r\n      case 'ringtone': return <Phone className=\"w-5 h-5 text-cyan-400\" />\r\n      case 'clothing': return <Sparkles className=\"w-5 h-5 text-pink-400\" />\r\n      case 'call_minutes': return <Phone className=\"w-5 h-5 text-sky-400\" />\r\n      case 'perk': return <Star className=\"w-5 h-5 text-pink-400\" />\r\n      case 'insurance': return <CheckCircle className=\"w-5 h-5 text-orange-400\" />\r\n      default: return <Package className=\"w-5 h-5 text-gray-400\" />\r\n    }\r\n  }\r\n\r\n  const toggleCallSound = async (soundId: string, soundType: string, isActive: boolean) => {\r\n    if (!user?.id) return\r\n    try {\r\n      if (isActive) {\r\n        const { error } = await supabase\r\n          .from('user_call_sounds')\r\n          .update({ is_active: false })\r\n          .eq('user_id', user.id)\r\n          .eq('sound_id', soundId)\r\n        if (error) throw error\r\n        toast.success('Call sound deactivated')\r\n      } else {\r\n        const { data, error } = await supabase.rpc('set_active_call_sound', {\r\n          p_user_id: user.id,\r\n          p_sound_id: soundId\r\n        })\r\n        if (error || data?.success === false) {\r\n          throw new Error(data?.error || error?.message || 'Failed to activate sound')\r\n        }\r\n        toast.success('Call sound activated')\r\n      }\r\n      loadInventory()\r\n    } catch (err) {\r\n      console.error('Failed to toggle call sound', err)\r\n      toast.error('Failed to toggle call sound')\r\n    }\r\n  }\r\n\r\n  const getItemTypeLabel = (type: string) => {\r\n    switch (type) {\r\n      case 'effect': return 'Effect'\r\n      case 'badge': return 'Badge'\r\n      case 'ticket': return 'Ticket'\r\n      case 'digital': return 'Digital Item'\r\n      case 'theme': return 'Theme'\r\n      case 'ringtone': return 'Ringtone'\r\n      case 'clothing': return 'Clothing'\r\n      case 'call_minutes': return 'Call Minutes'\r\n      case 'physical': return 'Physical Item'\r\n      case 'perk': return 'Perk'\r\n      case 'insurance': return 'Insurance'\r\n      case 'title': return 'Title'\r\n      case 'deed': return 'Deed'\r\n      default: return 'Item'\r\n    }\r\n  }\r\n\r\n  if (!user) return null\r\n\r\n  const content = (\r\n    <div className=\"max-w-6xl mx-auto space-y-6\">\r\n      {/* Delete All Expired Purchases Button */}\r\n      {activeTab === 'items' && (\r\n        <div className=\"flex justify-end mb-4\">\r\n          <button\r\n            onClick={deleteAllExpiredPurchases}\r\n            className=\"px-5 py-2 bg-red-700 hover:bg-red-800 text-white rounded-lg font-semibold shadow transition-colors\"\r\n          >\r\n            Delete All Expired Purchases\r\n          </button>\r\n        </div>\r\n      )}\r\n      {!embedded && (\r\n        <div className=\"text-center\">\r\n          <h1 className=\"text-4xl font-bold mb-2 flex items-center justify-center gap-3\">\r\n            <Package className=\"w-8 h-8 text-purple-400\" />\r\n            My Inventory\r\n          </h1>\r\n          <p className=\"text-gray-400\">Manage your purchased items and activate digital effects</p>\r\n        </div>\r\n      )}\r\n\r\n        <div className=\"flex items-center justify-center\">\r\n          <div className=\"inline-flex bg-black/40 border border-[#2C2C2C] rounded-full p-1\">\r\n            <button\r\n              onClick={() => setActiveTab('items')}\r\n              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${\r\n                activeTab === 'items'\r\n                  ? 'bg-purple-600 text-white'\r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              Items\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('titles')}\r\n              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${\r\n                activeTab === 'titles'\r\n                  ? 'bg-purple-600 text-white'\r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              Titles\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('deeds')}\r\n              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${\r\n                activeTab === 'deeds'\r\n                  ? 'bg-purple-600 text-white'\r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              Deeds\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('shop')}\r\n              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${\r\n                activeTab === 'shop'\r\n                  ? 'bg-purple-600 text-white'\r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              Shop\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n    {loading ? (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {[1,2,3,4,5,6].map(i => (\r\n              <div key={i} className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C] animate-pulse\">\r\n                <div className=\"h-4 bg-gray-700 rounded w-1/2 mb-2\"></div>\r\n                <div className=\"h-8 bg-gray-700 rounded w-3/4\"></div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        ) : activeTab === 'shop' ? (\r\n          <ShopConsumablesSection />\r\n        ) : activeTab === 'titles' ? (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {userTitles.length === 0 ? (\r\n              <div className=\"col-span-full text-center py-12\">\r\n                <Car className=\"w-16 h-16 text-gray-500 mx-auto mb-4\" />\r\n                <h2 className=\"text-2xl font-bold mb-2\">No Vehicle Titles</h2>\r\n                <p className=\"text-gray-400 mb-6\">Visit the Dealership to buy vehicles.</p>\r\n                <button\r\n                  onClick={() => navigate('/dealership')}\r\n                  className=\"px-6 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold\"\r\n                >\r\n                  Go to Dealership\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              userTitles.map((title) => {\r\n                const car = title.carDef;\r\n                return (\r\n                  <div key={title.id} className=\"bg-zinc-900 rounded-xl p-6 border border-emerald-500/20 hover:border-emerald-500/40 transition-all cursor-pointer\" onClick={() => setSelectedTitleDeed({ type: 'title', ...title })}>\r\n                    <div className=\"flex items-center gap-2 mb-4\">\r\n                      <Car className=\"w-5 h-5 text-emerald-400\" />\r\n                      <span className=\"text-sm text-emerald-400 font-bold uppercase tracking-wider\">Title</span>\r\n                    </div>\r\n                    <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                      {car?.name || `Vehicle #${title.car_id || title.id.slice(0,8)}`}\r\n                    </h3>\r\n                    <p className=\"text-gray-400 text-sm mb-4\">\r\n                      Purchased: {new Date(title.purchased_at).toLocaleDateString()}\r\n                    </p>\r\n                    <div className=\"flex items-center justify-between text-sm\">\r\n                      <span className=\"text-zinc-500\">Value</span>\r\n                      <span className=\"text-white font-mono\">\r\n                        {(title.current_value || car?.price || 0).toLocaleString()} coins\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })\r\n            )}\r\n          </div>\r\n        ) : activeTab === 'deeds' ? (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {userDeeds.length === 0 ? (\r\n              <div className=\"col-span-full text-center py-12\">\r\n                <Home className=\"w-16 h-16 text-gray-500 mx-auto mb-4\" />\r\n                <h2 className=\"text-2xl font-bold mb-2\">No Property Deeds</h2>\r\n                <p className=\"text-gray-400 mb-6\">Visit the Living section to buy properties.</p>\r\n                <button\r\n                  onClick={() => navigate('/living')}\r\n                  className=\"px-6 py-3 bg-amber-600 hover:bg-amber-700 rounded-lg font-semibold\"\r\n                >\r\n                  Find a Home\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              userDeeds.map((deed) => (\r\n                <div key={deed.id} className=\"bg-zinc-900 rounded-xl p-6 border border-amber-500/20 hover:border-amber-500/40 transition-all cursor-pointer\" onClick={() => navigate('/living')}>\r\n                  <div className=\"flex items-center gap-2 mb-4\">\r\n                    <Home className=\"w-5 h-5 text-amber-400\" />\r\n                    <span className=\"text-sm text-amber-400 font-bold uppercase tracking-wider\">Deed</span>\r\n                  </div>\r\n                  <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                    {deed.name || `Property #${deed.id.slice(0, 8)}`}\r\n                  </h3>\r\n                  <p className=\"text-gray-400 text-sm mb-4\">\r\n                    {deed.address || 'No address'}\r\n                  </p>\r\n                  <div className=\"flex items-center justify-between text-sm\">\r\n                    <span className=\"text-zinc-500\">Rent Income</span>\r\n                    <span className=\"text-white font-mono\">\r\n                      {(deed.rent_amount || 0).toLocaleString()} coins/week\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </div>\r\n        ) : (inventory.length === 0 && entranceEffects.length === 0 && perks.length === 0 && insurances.length === 0 && callSounds.length === 0) ? (\r\n          <div className=\"text-center py-12\">\r\n            <Package className=\"w-16 h-16 text-gray-500 mx-auto mb-4\" />\r\n            <h2 className=\"text-2xl font-bold mb-2\">Your Inventory is Empty</h2>\r\n            <p className=\"text-gray-400 mb-6\">Purchase items from the store to see them here</p>\r\n            <button\r\n              onClick={() => navigate('/marketplace')}\r\n              className=\"px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold\"\r\n            >\r\n              Browse Store\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-8\">\r\n            {/* Perks Section */}\r\n            {perks.length > 0 && (\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Zap className=\"w-6 h-6 text-pink-400\" />\r\n                  Active Perks\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                  {perks.map((perk) => {\r\n                    const isActive = activeItems.has(perk.id)\r\n                    const isExpired = perk.expires_at && new Date(perk.expires_at) < new Date()\r\n                    \r\n                    return (\r\n                      <div key={perk.id} className=\"bg-zinc-900 rounded-xl p-6 border border-pink-500/20 hover:border-pink-500/40 transition-all\">\r\n                        <div className=\"mb-4\">\r\n                          <div className=\"flex items-center gap-2 mb-2\">\r\n                            <Star className=\"w-5 h-5 text-pink-400\" />\r\n                            <span className=\"text-sm text-gray-400\">Perk</span>\r\n                            {isActive && !isExpired && (\r\n                              <span className=\"bg-green-600 text-white text-xs px-2 py-1 rounded-full\">ACTIVE</span>\r\n                            )}\r\n                            {isExpired && (\r\n                              <span className=\"bg-red-600 text-white text-xs px-2 py-1 rounded-full\">EXPIRED</span>\r\n                            )}\r\n                          </div>\r\n                          <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                            {perk.config?.name || 'Unknown Perk'}\r\n                          </h3>\r\n                          <p className=\"text-gray-400 text-sm mb-2\">\r\n                            {perk.config?.description || 'No description'}\r\n                          </p>\r\n                          {perk.expires_at && (\r\n                            <p className=\"text-xs text-gray-500\">\r\n                              Expires: {new Date(perk.expires_at).toLocaleString()}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                          <button\r\n                            onClick={() => togglePerk(perk.id, isActive)}\r\n                            disabled={isExpired}\r\n                            className={`w-full py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${\r\n                              isExpired \r\n                                ? 'bg-gray-700 text-gray-400 cursor-not-allowed'\r\n                                : isActive\r\n                                  ? 'bg-red-600 hover:bg-red-700 text-white'\r\n                                  : 'bg-green-600 hover:bg-green-700 text-white'\r\n                            }`}\r\n                          >\r\n                            {isExpired ? 'Expired' : isActive ? 'Deactivate' : 'Activate'}\r\n                          </button>\r\n                          {/* Show color picker button for glowing username perks */}\r\n                          {perk.perk_id === 'perk_global_highlight' && isActive && !isExpired && (\r\n                            <button\r\n                              onClick={() => {\r\n                                setShowColorPickerModal(true)\r\n                              }}\r\n                              className=\"w-full py-2 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white text-sm\"\r\n                            >\r\n                              <Palette className=\"w-4 h-4\" />\r\n                              Choose Glow Color\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Insurance Section */}\r\n            {insurances.length > 0 && (\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Shield className=\"w-6 h-6 text-blue-400\" />\r\n                  Insurance Plans\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                  {insurances.map((ins) => {\r\n                    const isActive = activeItems.has(ins.id)\r\n                    const isExpired = ins.expires_at && new Date(ins.expires_at) < new Date()\r\n                    \r\n                    return (\r\n                      <div key={ins.id} className=\"bg-zinc-900 rounded-xl p-6 border border-blue-500/20 hover:border-blue-500/40 transition-all\">\r\n                        <div className=\"mb-4\">\r\n                          <div className=\"flex items-center gap-2 mb-2\">\r\n                            <Shield className=\"w-5 h-5 text-blue-400\" />\r\n                            <span className=\"text-sm text-gray-400\">Insurance</span>\r\n                            {isActive && !isExpired && (\r\n                              <span className=\"bg-green-600 text-white text-xs px-2 py-1 rounded-full\">ACTIVE</span>\r\n                            )}\r\n                            {isExpired && (\r\n                              <span className=\"bg-red-600 text-white text-xs px-2 py-1 rounded-full\">EXPIRED</span>\r\n                            )}\r\n                          </div>\r\n                          <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                            {ins.plan?.name || 'Insurance Plan'}\r\n                          </h3>\r\n                          <p className=\"text-gray-400 text-sm mb-2\">\r\n                            {ins.plan?.description || 'Protection plan'}\r\n                          </p>\r\n                          {ins.expires_at && (\r\n                            <p className=\"text-xs text-gray-500\">\r\n                              Expires: {new Date(ins.expires_at).toLocaleString()}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"text-center py-2 bg-zinc-800 rounded text-xs text-gray-400\">\r\n                          {isActive ? 'Protection Active' : 'Protection Inactive'}\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Role Bonus Section */}\r\n            {roleEffect && (\r\n              <div className=\"mb-8\">\r\n                <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Crown className=\"w-6 h-6 text-yellow-400\" />\r\n                  Role Bonus\r\n                </h2>\r\n                <div className=\"bg-gradient-to-r from-yellow-900/40 to-black rounded-xl p-6 border border-yellow-500/40\">\r\n                  <div className=\"flex items-start gap-4\">\r\n                    <div className=\"p-3 bg-yellow-500/20 rounded-lg\">\r\n                      <Sparkles className=\"w-8 h-8 text-yellow-400\" />\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center gap-2 mb-1\">\r\n                        <h3 className=\"text-xl font-bold text-white\">{roleEffect.name}</h3>\r\n                        <span className=\"bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full uppercase\">\r\n                          Permanent\r\n                        </span>\r\n                        {activeItems.has(`role_effect_${roleEffectKey || 'default'}`) && (\r\n                             <span className=\"bg-green-600 text-white text-xs px-2 py-1 rounded-full\">ACTIVE</span>\r\n                        )}\r\n                      </div>\r\n                      <p className=\"text-gray-300 mb-2\">{roleEffect.description}</p>\r\n                      <div className=\"flex items-center gap-4 mt-4\">\r\n                        <button\r\n                          onClick={() => toggleRoleEffect(activeItems.has(`role_effect_${roleEffectKey || 'default'}`))}\r\n                          className={`px-6 py-2 rounded-lg font-semibold transition-colors flex items-center gap-2 ${\r\n                            activeItems.has(`role_effect_${roleEffectKey || 'default'}`)\r\n                              ? 'bg-red-600 hover:bg-red-700 text-white'\r\n                              : 'bg-green-600 hover:bg-green-700 text-white'\r\n                          }`}\r\n                        >\r\n                          {activeItems.has(`role_effect_${roleEffectKey || 'default'}`) ? (\r\n                            <>\r\n                              <XCircle className=\"w-4 h-4\" />\r\n                              Deactivate\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <CheckCircle className=\"w-4 h-4\" />\r\n                              Activate\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Entrance Effects Section */}\r\n            {entranceEffects.length > 0 && (\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Sparkles className=\"w-6 h-6 text-yellow-400\" />\r\n                  Entrance Effects\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                  {entranceEffects.map((effect) => {\r\n                    const isActive = activeItems.has(effect.effect_id)\r\n                    return (\r\n                      <div key={effect.id} className=\"relative bg-zinc-900 rounded-xl p-6 border border-yellow-500/20 hover:border-yellow-500/40 transition-all group\">\r\n                        <button\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            if (window.confirm('Delete this effect?')) {\r\n                              deleteItem(effect.id, effect.effect_id, 'user_entrance_effects', setEntranceEffects);\r\n                            }\r\n                          }}\r\n                          className=\"absolute top-4 right-4 text-gray-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                          title=\"Delete Effect\"\r\n                        >\r\n                          <X className=\"w-5 h-5\" />\r\n                        </button>\r\n                        <div className=\"mb-4\">\r\n                          <div className=\"flex items-center gap-2 mb-2\">\r\n                            <Zap className=\"w-5 h-5 text-yellow-400\" />\r\n                            <span className=\"text-sm text-gray-400\">Entrance Effect</span>\r\n                            {isActive && (\r\n                              <span className=\"bg-green-600 text-white text-xs px-2 py-1 rounded-full\">\r\n                                ACTIVE\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                          <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                            {effect.config?.name || effect.effect_id}\r\n                          </h3>\r\n                          <p className=\"text-gray-400 text-sm mb-2\">\r\n                            {effect.config?.description || 'No description available'}\r\n                          </p>\r\n                          <p className=\"text-xs text-gray-500\">\r\n                            Acquired: {new Date(effect.acquired_at).toLocaleDateString()}\r\n                          </p>\r\n                        </div>\r\n                        <button\r\n                          onClick={() => toggleEntranceEffect(effect.effect_id, isActive)}\r\n                          className={`w-full py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${\r\n                            isActive\r\n                              ? 'bg-red-600 hover:bg-red-700 text-white'\r\n                              : 'bg-green-600 hover:bg-green-700 text-white'\r\n                          }`}\r\n                        >\r\n                          {isActive ? (\r\n                            <>\r\n                              <XCircle className=\"w-4 h-4\" />\r\n                              Deactivate\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <CheckCircle className=\"w-4 h-4\" />\r\n                              Activate\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Call Sounds Section */}\r\n            {callSounds.length > 0 && (\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Phone className=\"w-6 h-6 text-cyan-300\" />\r\n                  Call Sounds\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                  {callSounds.map((sound) => {\r\n                    const isActive = sound.is_active;\r\n                    const catalog = sound.catalog || {};\r\n                    return (\r\n                      <div key={sound.sound_id} className=\"bg-zinc-900 rounded-xl p-6 border border-cyan-500/20 hover:border-cyan-500/40 transition-all\">\r\n                        <div className=\"mb-4\">\r\n                          <div className=\"flex items-center gap-2 mb-2\">\r\n                            <Phone className=\"w-5 h-5 text-cyan-300\" />\r\n                            <span className=\"text-sm text-gray-400\">{catalog.sound_type || 'call sound'}</span>\r\n                            {isActive && (\r\n                              <span className=\"bg-green-600 text-white text-xs px-2 py-1 rounded-full\">\r\n                                ACTIVE\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                          <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                            {catalog.name || 'Call Sound'}\r\n                          </h3>\r\n                          <p className=\"text-gray-400 text-sm mb-2\">\r\n                            {catalog.asset_url}\r\n                          </p>\r\n                        </div>\r\n                        <button\r\n                          onClick={() => toggleCallSound(sound.sound_id, catalog.sound_type, isActive)}\r\n                          className={`w-full py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${\r\n                            isActive\r\n                              ? 'bg-red-600 hover:bg-red-700 text-white'\r\n                              : 'bg-green-600 hover:bg-green-700 text-white'\r\n                          }`}\r\n                        >\r\n                          {isActive ? (\r\n                            <>\r\n                              <XCircle className=\"w-4 h-4\" />\r\n                              Deactivate\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <CheckCircle className=\"w-4 h-4\" />\r\n                              Activate\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* General Inventory Section */}\r\n            {inventory.length > 0 && (\r\n              <div>\r\n                 <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                  <Package className=\"w-6 h-6 text-purple-400\" />\r\n                  Items\r\n                </h2>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                  {inventory.map((item) => {\r\n                    const isActive = activeItems.has(item.item_id)\r\n                    const isDigital = ['effect', 'badge', 'digital'].includes(item.marketplace_item?.type)\r\n                    const isExpired = item.expires_at && new Date(item.expires_at) < new Date()\r\n\r\n                    return (\r\n                      <div key={item.id} className=\"relative bg-zinc-900 rounded-xl p-6 border border-purple-500/20 hover:border-purple-500/40 transition-all group\">\r\n                        <div className=\"mb-4\">\r\n                          <div className=\"flex items-center gap-2 mb-2\">\r\n                            {getItemIcon(item.marketplace_item?.type)}\r\n                            <span className=\"text-sm text-gray-400\">\r\n                              {getItemTypeLabel(item.marketplace_item?.type)}\r\n                            </span>\r\n                            {isActive && (\r\n                              <span className=\"bg-green-600 text-white text-xs px-2 py-1 rounded-full\">\r\n                                ACTIVE\r\n                              </span>\r\n                            )}\r\n                            {isExpired && (\r\n                              <span className=\"bg-red-600 text-white text-xs px-2 py-1 rounded-full ml-2\">\r\n                                EXPIRED\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n\r\n                          <h3 className=\"text-xl font-bold text-white mb-1\">\r\n                            {item.marketplace_item?.title}\r\n                          </h3>\r\n\r\n                          <p className=\"text-gray-400 text-sm mb-2\">\r\n                            {item.marketplace_item?.description}\r\n                          </p>\r\n\r\n                          <p className=\"text-xs text-gray-500\">\r\n                            Acquired: {new Date(item.acquired_at).toLocaleDateString()}\r\n                          </p>\r\n                          {item.expires_at && (\r\n                            <p className=\"text-xs text-gray-500\">\r\n                              Expires: {new Date(item.expires_at).toLocaleString()}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n\r\n                        {isDigital ? (\r\n                          <div className=\"space-y-2\">\r\n                            <button\r\n                              onClick={() => toggleItemActivation(item.item_id, item.marketplace_item?.type)}\r\n                              className={`w-full py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${\r\n                                isActive\r\n                                  ? 'bg-red-600 hover:bg-red-700 text-white'\r\n                                  : 'bg-green-600 hover:bg-green-700 text-white'\r\n                              }`}\r\n                            >\r\n                              {isActive ? (\r\n                                <>\r\n                                  <XCircle className=\"w-4 h-4\" />\r\n                                  Deactivate\r\n                                </>\r\n                              ) : (\r\n                                <>\r\n                                  <CheckCircle className=\"w-4 h-4\" />\r\n                                  Activate\r\n                                </>\r\n                              )}\r\n                            </button>\r\n\r\n                            {/* Show delete button only for expired items and only if not active */}\r\n                            {isExpired && !isActive && (\r\n                              <button\r\n                                onClick={() => deleteInventoryItem(item.id, item.item_id)}\r\n                                className=\"w-full py-2 rounded-lg font-semibold border border-red-600 text-red-400 hover:bg-red-600 hover:text-white transition-colors text-sm\"\r\n                              >\r\n                                Delete (Expired)\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        ) : (\r\n                          <div className=\"space-y-2\">\r\n                            <div className=\"text-center py-3 text-gray-400\">\r\n                              <Package className=\"w-5 h-5 mx-auto mb-1\" />\r\n                              <p className=\"text-sm\">Physical Item</p>\r\n                              <p className=\"text-xs\">Contact seller for delivery</p>\r\n                            </div>\r\n                            {/* Show delete button only for expired items */}\r\n                            {isExpired && (\r\n                              <button\r\n                                onClick={() => deleteInventoryItem(item.id, item.item_id)}\r\n                                className=\"w-full py-2 rounded-lg font-semibold border border-red-600 text-red-400 hover:bg-red-600 hover:text-white transition-colors text-sm\"\r\n                              >\r\n                                Delete (Expired)\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Digital Items Info */}\r\n        <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C]\">\r\n          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n            <Zap className=\"w-5 h-5 text-purple-400\" />\r\n            Digital Item Effects\r\n          </h2>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div className=\"space-y-3\">\r\n              <h3 className=\"font-semibold text-purple-400\">Available Effects:</h3>\r\n              <ul className=\"space-y-2 text-sm text-gray-300\">\r\n                <li>‚Ä¢ Entrance animations when joining streams</li>\r\n                <li>‚Ä¢ Special profile borders and frames</li>\r\n                <li>‚Ä¢ Animated badges and titles</li>\r\n                <li>‚Ä¢ Premium chat colors and styles</li>\r\n                <li>‚Ä¢ Troll-themed visual effects</li>\r\n              </ul>\r\n            </div>\r\n\r\n            <div className=\"space-y-3\">\r\n              <h3 className=\"font-semibold text-purple-400\">How to Use:</h3>\r\n              <ul className=\"space-y-2 text-sm text-gray-300\">\r\n                <li>‚Ä¢ Click \"Activate\" on digital items</li>\r\n                <li>‚Ä¢ Effects apply automatically across the app</li>\r\n                <li>‚Ä¢ Multiple effects can be active simultaneously</li>\r\n                <li>‚Ä¢ Deactivate anytime to remove effects</li>\r\n                <li>‚Ä¢ Physical items require manual redemption</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </div>\r\n    </div>\r\n  )\r\n\r\n  if (embedded) {\r\n    return <div className=\"text-white\">{content}</div>\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n        {content}\r\n      </div>\r\n      \r\n      {/* Glowing Username Color Picker Modal */}\r\n      {showColorPickerModal && user?.id && (\r\n        <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4\">\r\n          <div className=\"bg-[#0A0A14] border border-[#2C2C2C] rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto\">\r\n            <div className=\"flex items-center justify-between p-6 border-b border-[#2C2C2C]\">\r\n              <h2 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n                <Sparkles className=\"w-5 h-5 text-yellow-400\" />\r\n                Choose Glow Color\r\n              </h2>\r\n              <button\r\n                onClick={() => setShowColorPickerModal(false)}\r\n                className=\"text-gray-400 hover:text-white transition-colors\"\r\n              >\r\n                <X className=\"w-6 h-6\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-6\">\r\n              <GlowingUsernameColorPicker\r\n                userId={user.id}\r\n                onColorSelected={() => {\r\n                  setShowColorPickerModal(false)\r\n                  toast.success('Color saved!')\r\n                }}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Title/Deed Details Modal */}\r\n      <TitleDeedModal \r\n        isOpen={!!selectedTitleDeed} \r\n        onClose={() => setSelectedTitleDeed(null)} \r\n        item={selectedTitleDeed} \r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\VerificationComplete.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\VerificationPage.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":34,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1410,1426],"text":"You&apos;re Verified!"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1410,1426],"text":"You&lsquo;re Verified!"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1410,1426],"text":"You&#39;re Verified!"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1410,1426],"text":"You&rsquo;re Verified!"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { CheckCircle, Coins, Shield } from 'lucide-react'\r\n\r\nexport default function VerificationPage() {\r\n  const { user, profile, refreshProfile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  const [processing, setProcessing] = useState<'coins' | null>(null)\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"mb-4\">Please log in to get verified</p>\r\n          <button\r\n            onClick={() => navigate('/auth')}\r\n            className=\"px-4 py-2 bg-purple-600 rounded-lg\"\r\n          >\r\n            Log In\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (profile?.is_verified) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white flex items-center justify-center\">\r\n        <div className=\"max-w-lg mx-auto bg-[#1A1A1A] border-2 border-green-500/30 rounded-xl p-8 text-center\">\r\n          <CheckCircle className=\"w-16 h-16 text-green-400 mx-auto mb-4\" />\r\n          <h1 className=\"text-2xl font-bold mb-2\">You're Verified!</h1>\r\n          <p className=\"opacity-80 mb-6\">\r\n            Your account is verified. Enjoy your verified badge!\r\n          </p>\r\n          <button\r\n            onClick={() => navigate('/')}\r\n            className=\"px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg\"\r\n          >\r\n            Go Home\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const payWithCoins = async () => {\r\n    if (processing) return\r\n\r\n    const troll_coins = profile?.troll_coins || 0\r\n    if (troll_coins < 500) {\r\n      toast.error('You need 500 troll_coins to verify. You have ' + troll_coins)\r\n      return\r\n    }\r\n\r\n    setProcessing('coins')\r\n    try {\r\n      // Check if deduct_troll_coins RPC exists, otherwise use direct update\r\n      const { error: deductError } = await supabase.rpc('rpc_deduct_troll_coins', {\r\n        p_user_id: user.id,\r\n        p_amount: 500\r\n      })\r\n\r\n      if (deductError) {\r\n        // Fallback: direct update\r\n        const { data: currentProfile } = await supabase\r\n          .from('user_profiles')\r\n          .select('troll_coins')\r\n          .eq('id', user.id)\r\n          .single()\r\n\r\n        if ((currentProfile?.troll_coins || 0) < 500) {\r\n          throw new Error('Insufficient troll_coins')\r\n        }\r\n\r\n        await supabase\r\n          .from('user_profiles')\r\n          .update({\r\n            troll_coins: (currentProfile?.troll_coins || 0) - 500\r\n          })\r\n          .eq('id', user.id)\r\n      }\r\n\r\n      // Verify user\r\n      const { error: verifyError } = await supabase.rpc('verify_user', {\r\n        p_user_id: user.id,\r\n        p_payment_method: 'coins',\r\n        p_amount: 500,\r\n        p_payment_reference: null\r\n      })\r\n\r\n      if (verifyError) {\r\n        throw verifyError\r\n      }\r\n\r\n      toast.success('Verification successful!')\r\n      if (refreshProfile) await refreshProfile()\r\n      \r\n      // Log transaction\r\n      await supabase.from('coin_transactions').insert({\r\n        user_id: user.id,\r\n        coins: -500,\r\n        type: 'verification_purchase',\r\n        description: 'Account verification',\r\n        source: 'coins'\r\n      })\r\n    } catch (error: any) {\r\n      console.error('Error verifying with coins:', error)\r\n      toast.error(error?.message || 'Failed to verify')\r\n    } finally {\r\n      setProcessing(null)\r\n    }\r\n  }\r\n\r\n  const troll_coins = profile?.troll_coins || 0\r\n  const canPayWithCoins = troll_coins >= 500\r\n  const handleSkip = () => {\r\n    navigate('/tcps')\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-lg mx-auto bg-[#1A1A1A] border-2 border-purple-500/30 rounded-xl p-8\">\r\n        <div className=\"flex items-center gap-3 mb-4\">\r\n          <Shield className=\"w-8 h-8 text-purple-400\" />\r\n          <h1 className=\"text-3xl font-bold\">Get Verified</h1>\r\n        </div>\r\n\r\n        <p className=\"opacity-80 mb-6\">\r\n          Stand out with a verified badge. Build trust. Boost visibility. Get recognized as a trusted member of Troll City.\r\n        </p>\r\n\r\n        {/* Benefits */}\r\n        <div className=\"bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-6\">\r\n          <h3 className=\"font-semibold mb-2\">Benefits:</h3>\r\n          <ul className=\"text-sm space-y-1 opacity-80\">\r\n            <li>‚úì Verified badge on your profile and in chat</li>\r\n            <li>‚úì Increased trust and credibility</li>\r\n            <li>‚úì Priority support</li>\r\n            <li>‚úì Exclusive verified-only features</li>\r\n          </ul>\r\n        </div>\r\n\r\n        {/* Payment Options */}\r\n        <div className=\"space-y-4\">\r\n          <div className=\"relative\">\r\n            <button\r\n              onClick={payWithCoins}\r\n              disabled={processing !== null || !canPayWithCoins}\r\n              className=\"w-full px-6 py-4 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\r\n            >\r\n              <Coins className=\"w-5 h-5\" />\r\n              {processing === 'coins' \r\n                ? 'Processing...' \r\n                : `Pay 500 troll_coins ${canPayWithCoins ? `(You have ${troll_coins})` : `(Need ${500 - troll_coins} more)`}`\r\n              }\r\n            </button>\r\n            {!canPayWithCoins && (\r\n              <p className=\"text-xs text-red-400 mt-2 text-center\">\r\n                Insufficient troll_coins. You need 500, but only have {troll_coins}.\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-6 flex flex-col gap-2 items-center\">\r\n          <p className=\"text-xs text-gray-400 text-center\">\r\n            Not ready to verify yet? You can still access TCPS and grab it later from the store.\r\n          </p>\r\n          <button\r\n            onClick={handleSkip}\r\n            className=\"px-6 py-3 bg-white text-black rounded-lg font-semibold hover:bg-gray-200 transition-colors\"\r\n          >\r\n            Not right now ‚Äî Take me to TCPS\r\n          </button>\r\n        </div>\r\n\r\n        <p className=\"text-xs opacity-60 mt-6 text-center\">\r\n          Verification is a one-time payment. Badge remains active unless account is permanently banned.\r\n        </p>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\WallPostPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Wallet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\WatchPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'p' is defined but never used. Allowed unused args must match /^_/u.","line":790,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":790,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { \r\n  useCallback, \r\n  useEffect, \r\n  useMemo, \r\n  useRef,\r\n  useState \r\n} from 'react';\r\nimport { useParams, useLocation, useNavigate } from 'react-router-dom';\r\nimport { useLiveKit } from '../hooks/useLiveKit';\r\nimport { useLiveKitSession } from '../hooks/useLiveKitSession';\r\nimport { useStreamEndListener } from '../hooks/useStreamEndListener';\r\nimport { useAuthStore } from '../lib/store';\r\nimport { supabase } from '../lib/supabase';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  Users,\r\n  Heart,\r\n  Gift,\r\n  MessageCircle,\r\n  Tv\r\n} from 'lucide-react';\r\nimport ChatBox from '../components/broadcast/ChatBox';\r\nimport GiftModal from '../components/broadcast/GiftModal';\r\nimport ProfileModal from '../components/broadcast/ProfileModal';\r\nimport CoinStoreModal from '../components/broadcast/CoinStoreModal';\r\nimport GiftEventOverlay from './GiftEventOverlay';\r\nimport { useGiftEvents } from '../lib/hooks/useGiftEvents';\r\nimport EntranceEffect from '../components/broadcast/EntranceEffect';\r\nimport { getUserEntranceEffect } from '../lib/entranceEffects';\r\nimport { attachLiveKitDebug } from '../lib/livekit-debug';\r\nimport ResponsiveVideoGrid from '../components/stream/ResponsiveVideoGrid';\r\nimport { useRoomParticipants } from '../hooks/useRoomParticipants';\r\nimport { useSeatRoster } from '../hooks/useSeatRoster';\r\nimport { useViewerTracking } from '../hooks/useViewerTracking';\r\n\r\n// Constants\r\nconst STREAM_POLL_INTERVAL = 2000;\r\nconst MOBILE_NAV_HEIGHT = 76;\r\n\r\n// Types\r\ninterface StreamRow {\r\n  id: string;\r\n  broadcaster_id: string;\r\n  status: string;\r\n  is_live: boolean;\r\n  current_viewers?: number;\r\n  total_gifts_coins?: number;\r\n  total_likes?: number;\r\n  start_time?: string;\r\n  title?: string;\r\n  is_private?: boolean;\r\n}\r\n\r\nexport default function WatchPage() {\r\n  const { streamId } = useParams<{ streamId: string }>();\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  \r\n  const { user, profile } = useAuthStore();\r\n  \r\n  const stableIdentity = useMemo(() => {\r\n    const id = user?.id || profile?.id;\r\n    if (!id) console.warn('[WatchPage] No stable identity found');\r\n    return id;\r\n  }, [user?.id, profile?.id]);\r\n  \r\n  const [stream, setStream] = useState<StreamRow | null>(null);\r\n  const [, setIsLoadingStream] = useState(true);\r\n  const [privateAccessGranted, setPrivateAccessGranted] = useState(false);\r\n  const [privatePasswordInput, setPrivatePasswordInput] = useState('');\r\n  const [privateAuthError, setPrivateAuthError] = useState('');\r\n  const privateAccessStorageKey = streamId ? `private-stream-access:${streamId}` : null;\r\n  const [broadcastTheme, setBroadcastTheme] = useState<any>(null);\r\n  const [broadcastThemeStyle, setBroadcastThemeStyle] = useState<React.CSSProperties | undefined>(undefined);\r\n  const [lastThemeId, setLastThemeId] = useState<string | null>(null);\r\n  const [reactiveEvent, setReactiveEvent] = useState<{ key: number; style: string; intensity: number } | null>(null);\r\n  const [isMobile, setIsMobile] = useState(false);\r\n  const [activeMobilePanel, setActiveMobilePanel] = useState<'seats' | 'gifts' | 'chat'>('seats');\r\n  const [boxCount, setBoxCount] = useState(0);\r\n  const [loggedOutAt, setLoggedOutAt] = useState<number | null>(null);\n\r\n  const liveKit = useLiveKit();\r\n  const roomName = useMemo(() => String(streamId || ''), [streamId]);\r\n\r\n  const hasValidStreamId = !!streamId && typeof streamId === 'string' && streamId.trim() !== '';\r\n  const sessionReady = !!user && !!profile && hasValidStreamId;\r\n  const needsPrivateGate = Boolean(stream?.is_private && stream?.broadcaster_id && stream?.broadcaster_id !== user?.id);\r\n  const canAccessPrivate = !needsPrivateGate || privateAccessGranted;\r\n  const canJoinStream = sessionReady && hasValidStreamId && canAccessPrivate;\r\n  const effectiveRoomName = canJoinStream ? roomName : '';\r\n\r\n  const { seats } = useSeatRoster(effectiveRoomName);\r\n  const participants = useRoomParticipants(liveKit.getRoom());\r\n  const { startWatchTracking, stopWatchTracking, updateWatchTime } = useXPTracking();\r\n\r\n  useEffect(() => {\r\n    if (!streamId || !user) return;\r\n\r\n    startWatchTracking(streamId);\r\n    const interval = setInterval(() => updateWatchTime(streamId), 60000);\r\n\r\n    return () => {\r\n      clearInterval(interval);\r\n      stopWatchTracking(streamId);\r\n    };\r\n  }, [streamId, user, startWatchTracking, stopWatchTracking, updateWatchTime]);\r\n\r\n  const refreshBoxCountFromMessages = useCallback(async () => {\r\n    if (!streamId) return;\r\n    try {\r\n      const { data } = await supabase\r\n        .from('messages')\r\n        .select('content')\r\n        .eq('stream_id', streamId)\r\n        .eq('message_type', 'system')\r\n        .like('content', 'BOX_COUNT_UPDATE:%')\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (data) {\r\n        const parts = (data.content as string).split(':');\r\n        if (parts.length >= 2) {\r\n          const parsed = parseInt(parts[1], 10);\r\n          if (!isNaN(parsed)) {\r\n            setBoxCount(parsed);\r\n          }\r\n        }\r\n      } else {\r\n        // Default to 5 if no update found, assuming standard broadcast\r\n        setBoxCount(5);\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to refresh box count:', err);\r\n    }\r\n  }, [streamId]);\r\n\r\n  useEffect(() => {\r\n    refreshBoxCountFromMessages();\r\n  }, [refreshBoxCountFromMessages]);\r\n\r\n  useViewerTracking(canJoinStream ? streamId || null : null, stableIdentity || null);\r\n\r\n  const livekitIdentity = useMemo(() => {\r\n    const id = stableIdentity;\r\n    if (!id) console.warn('[WatchPage] No identity found for LiveKit');\r\n    return id;\r\n  }, [stableIdentity]);\r\n\r\n  // Always viewer\r\n  const {\r\n    isConnected,\r\n  } = useLiveKitSession({\r\n    roomName: effectiveRoomName,\r\n    connect: canJoinStream,\r\n    user: sessionReady && user\r\n      ? { ...user, identity: livekitIdentity, role: 'viewer' }\r\n      : null,\r\n    role: 'viewer',\r\n    allowPublish: false,\r\n    autoPublish: false,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (isConnected) {\r\n      const room = liveKit.getRoom();\r\n      attachLiveKitDebug(room);\r\n    }\r\n  }, [isConnected, liveKit]);\r\n\r\n  useEffect(() => {\n    if (user?.id) {\n      setLoggedOutAt(null);\n    } else {\n      setLoggedOutAt((prev) => prev ?? Date.now());\n    }\n  }, [user?.id]);\n\n  const messageIconClass = useMemo(() => {\n    if (stream?.is_live) return 'text-red-500';\n    if (user?.id) return 'text-green-500';\n    if (loggedOutAt && Date.now() - loggedOutAt > 30000) return 'text-orange-500';\n    return '';\n  }, [stream?.is_live, user?.id, loggedOutAt]);\n\n  useEffect(() => {\n    if (!streamId) return;\n\n    const channel = supabase\n      .channel(`box-count-${streamId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'messages',\n          filter: `stream_id=eq.${streamId}`,\n        },\n        (payload) => {\n          const newMsg = payload.new;\n          if (newMsg.message_type === 'system' && newMsg.content?.startsWith('BOX_COUNT_UPDATE:')) {\n            const parts = newMsg.content.split(':');\n            if (parts.length >= 2) {\n              const parsed = parseInt(parts[1], 10);\n              if (!isNaN(parsed)) {\n                setBoxCount(parsed);\n              }\n            }\n          }\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [streamId]);\n\n  // Auth/Session checks (defensive)\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      try {\r\n        const { data, error } = await supabase.auth.getSession();\r\n        if (!mounted) return;\r\n        if (error || !data?.session) {\r\n          try { await supabase.auth.signOut(); } catch {}\r\n          navigate('/auth');\r\n        }\r\n      } catch {\r\n        if (mounted) navigate('/auth');\r\n      }\r\n    })();\r\n    return () => { mounted = false };\r\n  }, [navigate]);\r\n\r\n  // UI State\r\n  const [isGiftModalOpen, setIsGiftModalOpen] = useState(false);\r\n  const [selectedProfile, setSelectedProfile] = useState<any>(null);\r\n  const [isCoinStoreOpen, setIsCoinStoreOpen] = useState(false);\r\n  const [giftRecipient, setGiftRecipient] = useState<any>(null);\r\n  const [entranceEffect, setEntranceEffect] = useState<any>(null);\r\n  const entranceSentRef = useRef(false);\r\n  const leaveCleanupRef = useRef(false);\r\n\r\n  // Load Stream Data\r\n  const loadStreamData = useCallback(async () => {\r\n    if (!streamId) {\r\n      setIsLoadingStream(false);\r\n      return;\r\n    }\r\n\r\n    const streamDataFromState = location.state?.streamData;\r\n    if (streamDataFromState && streamDataFromState.id === streamId) {\r\n      setStream(streamDataFromState as StreamRow);\r\n      // setCoinCount(Number(streamDataFromState.total_gifts_coins || 0));\r\n      setIsLoadingStream(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoadingStream(true);\r\n    \r\n    try {\r\n        const { data: streamRow, error } = await supabase\r\n          .from(\"streams\")\r\n        .select(\"id, broadcaster_id, title, category, status, start_time, end_time, current_viewers, total_gifts_coins, total_unique_gifters, is_live, is_private, thumbnail_url, created_at, updated_at\")\r\n          .eq(\"id\", streamId)\r\n          .maybeSingle();\r\n\r\n        if (error || !streamRow) {\r\n            toast.error(\"Stream not found.\");\r\n            setIsLoadingStream(false);\r\n            return;\r\n        }\r\n\r\n        setStream(streamRow as StreamRow);\r\n        // setCoinCount(Number(streamRow.total_gifts_coins || 0));\r\n    } catch (err) {\r\n        console.error(\"Failed to load stream:\", err);\r\n        toast.error(\"Failed to load stream information.\");\r\n    } finally {\r\n        setIsLoadingStream(false);\r\n    }\r\n  }, [streamId, location.state]);\r\n\r\n  useEffect(() => {\r\n    loadStreamData();\r\n  }, [loadStreamData]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    const media = window.matchMedia('(max-width: 767px)');\r\n    const handleChange = () => setIsMobile(media.matches);\r\n    handleChange();\r\n    media.addEventListener('change', handleChange);\r\n    return () => media.removeEventListener('change', handleChange);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isMobile) {\r\n      setActiveMobilePanel('seats');\r\n    }\r\n  }, [isMobile]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId || !stream) {\r\n      setPrivateAccessGranted(false);\r\n      setPrivatePasswordInput('');\r\n      setPrivateAuthError('');\r\n      return;\r\n    }\r\n\r\n    if (!privateAccessStorageKey) {\r\n      setPrivateAccessGranted(true);\r\n      return;\r\n    }\r\n\r\n    if (stream.is_private && stream.broadcaster_id !== user?.id) {\r\n      const stored = localStorage.getItem(privateAccessStorageKey);\r\n      setPrivateAccessGranted(Boolean(stored));\r\n    } else {\r\n      setPrivateAccessGranted(true);\r\n      if (privateAccessStorageKey) {\r\n        localStorage.removeItem(privateAccessStorageKey);\r\n      }\r\n    }\r\n  }, [streamId, stream?.is_private, stream?.broadcaster_id, user?.id, privateAccessStorageKey, stream]);\r\n\r\n  const handlePrivatePasswordSubmit = async () => {\r\n    setPrivateAuthError('');\r\n    if (!streamId) {\r\n      setPrivateAuthError('Stream unavailable');\r\n      return;\r\n    }\r\n    if (!user) {\r\n      setPrivateAuthError('Sign in to unlock this stream');\r\n      return;\r\n    }\r\n    if (!privatePasswordInput.trim()) {\r\n      setPrivateAuthError('Enter the stream password');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase.rpc('verify_stream_password', {\r\n        p_stream_id: streamId,\r\n        p_password: privatePasswordInput.trim(),\r\n      });\r\n      if (error) throw error;\r\n      if (data?.success) {\r\n        setPrivateAccessGranted(true);\r\n        if (privateAccessStorageKey) {\r\n          localStorage.setItem(privateAccessStorageKey, '1');\r\n        }\r\n        setPrivateAuthError('');\r\n        toast.success('Private access granted');\r\n      } else {\r\n        setPrivateAuthError('Incorrect password');\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Private password verification failed:', err);\r\n      setPrivateAuthError('Unable to verify password right now');\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const broadcasterId = stream?.broadcaster_id;\r\n    if (!broadcasterId) return;\r\n    let isActive = true;\r\n\r\n    const loadTheme = async () => {\r\n      const { data: state } = await supabase\r\n        .from('user_broadcast_theme_state')\r\n        .select('active_theme_id')\r\n        .eq('user_id', broadcasterId)\r\n        .maybeSingle();\r\n\r\n      if (!isActive) return;\r\n      if (!state?.active_theme_id) {\r\n        setBroadcastThemeStyle(undefined);\r\n        setBroadcastTheme(null);\r\n        setLastThemeId(null);\r\n        return;\r\n      }\r\n\r\n      const { data: theme } = await supabase\r\n        .from('broadcast_background_themes')\r\n        .select('id, asset_type, video_webm_url, video_mp4_url, image_url, background_css, background_asset_url, reactive_enabled, reactive_style, reactive_intensity')\r\n        .eq('id', state.active_theme_id)\r\n        .maybeSingle();\r\n\r\n      if (!isActive) return;\r\n      if (!theme) {\r\n        setBroadcastThemeStyle(undefined);\r\n        setBroadcastTheme(null);\r\n        setLastThemeId(null);\r\n        return;\r\n      }\r\n\r\n      if (theme.background_css) {\r\n        setBroadcastThemeStyle({ background: theme.background_css });\r\n        setBroadcastTheme(theme);\r\n        setLastThemeId(theme.id || null);\r\n        return;\r\n      }\r\n      if (theme.background_asset_url) {\r\n        setBroadcastThemeStyle({\r\n          backgroundImage: `url(${theme.background_asset_url})`,\r\n          backgroundSize: 'cover',\r\n          backgroundPosition: 'center',\r\n          backgroundRepeat: 'no-repeat'\r\n        });\r\n        setBroadcastTheme(theme);\r\n        setLastThemeId(theme.id || null);\r\n        return;\r\n      }\r\n      if (theme.image_url) {\r\n        setBroadcastThemeStyle({\r\n          backgroundImage: `url(${theme.image_url})`,\r\n          backgroundSize: 'cover',\r\n          backgroundPosition: 'center',\r\n          backgroundRepeat: 'no-repeat'\r\n        });\r\n        setBroadcastTheme(theme);\r\n        setLastThemeId(theme.id || null);\r\n        return;\r\n      }\r\n      setBroadcastThemeStyle(undefined);\r\n      setBroadcastTheme(theme);\r\n      setLastThemeId(theme.id || null);\r\n    };\r\n\r\n    loadTheme();\r\n  return () => {\r\n    isActive = false;\r\n  };\r\n}, [stream?.broadcaster_id]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n    const channel = supabase\r\n      .channel(`broadcast-theme-events-watch-${streamId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'broadcast_theme_events',\r\n          filter: `room_id=eq.${streamId}`,\r\n        },\r\n        (payload) => {\r\n          if (!broadcastTheme?.reactive_enabled) return;\r\n          const eventType = payload.new?.event_type || 'gift';\r\n          const baseIntensity = Number(broadcastTheme?.reactive_intensity || 2);\r\n          const intensityBoost = eventType === 'super_gift' ? 2 : eventType === 'gift' ? 1 : 0;\r\n          const intensity = Math.max(1, Math.min(5, baseIntensity + intensityBoost));\r\n          const style = String(broadcastTheme?.reactive_style || 'pulse');\r\n          setReactiveEvent({ key: Date.now(), style, intensity });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [streamId, broadcastTheme?.reactive_enabled, broadcastTheme?.reactive_intensity, broadcastTheme?.reactive_style]);\r\n\r\n  useEffect(() => {\r\n    if (!reactiveEvent?.key) return;\r\n    const timer = window.setTimeout(() => setReactiveEvent(null), 900);\r\n    return () => window.clearTimeout(timer);\r\n  }, [reactiveEvent?.key]);\r\n\r\n  // Stream polling\r\n  useEffect(() => {\r\n    if (!streamId) return;\r\n    const interval = setInterval(async () => {\r\n      const { data } = await supabase.from(\"streams\").select(\"status,is_live,current_viewers,total_gifts_coins\").eq(\"id\", streamId).maybeSingle();\r\n      if (data) {\r\n        setStream(prev => prev ? { ...prev, ...data } : prev);\r\n        // if (data.total_gifts_coins !== undefined) setCoinCount(Number(data.total_gifts_coins || 0));\r\n      }\r\n    }, STREAM_POLL_INTERVAL);\r\n    return () => clearInterval(interval);\r\n  }, [streamId]);\r\n\r\n  useStreamEndListener({\r\n    streamId: streamId || '',\r\n    enabled: !!streamId,\r\n    redirectToSummary: true,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (!stream?.id) return;\r\n\r\n    const channel = supabase\r\n      .channel(`live-updates-${stream.id}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'messages',\r\n          filter: `stream_id=eq.${stream.id}`,\r\n        },\r\n        (payload) => {\r\n          const msg = payload.new;\r\n          if (msg.message_type === 'entrance') {\r\n            try {\r\n              const rawContent = msg.content;\r\n              const data = typeof rawContent === 'string'\r\n                ? JSON.parse(rawContent)\r\n                : (rawContent || {});\r\n              const payloadUserId =\r\n                data.user_id || data.sender_id || msg.user_id || msg.sender_id;\r\n\r\n              setEntranceEffect({\r\n                ...data,\r\n                userId: payloadUserId || null,\r\n              });\r\n              setTimeout(() => setEntranceEffect(null), 5000);\r\n            } catch (error) {\r\n              console.error('Failed to parse entrance effect', error);\r\n            }\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [stream?.id]);\r\n\r\n  // Gift subscription\r\n  const lastGift = useGiftEvents(streamId);\r\n\r\n  // Join Stream (Participant Tracking)\r\n  useEffect(() => {\r\n    if (!streamId || !user?.id) return;\r\n\r\n    const joinStream = async () => {\r\n      // Check existing participant record\r\n      const { data: existing } = await supabase\r\n        .from('streams_participants')\r\n        .select('is_active, can_chat')\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', user.id)\r\n        .maybeSingle();\r\n\r\n      if (existing) {\r\n        if (!existing.is_active) {\r\n          toast.error(\"You have been kicked from this stream.\");\r\n          navigate('/'); \r\n          return;\r\n        }\r\n      } else {\r\n        // Create new record\r\n        await supabase.from('streams_participants').insert({\r\n          stream_id: streamId,\r\n          user_id: user.id,\r\n          is_active: true,\r\n          can_chat: true,\r\n          role: 'viewer'\r\n        });\r\n      }\r\n    };\r\n    \r\n    joinStream();\r\n  }, [streamId, user?.id, navigate]);\r\n\r\n  const markParticipantInactive = useCallback(async () => {\r\n    if (!streamId || !user?.id) return;\r\n    if (leaveCleanupRef.current) return;\r\n    leaveCleanupRef.current = true;\r\n    try {\r\n      await supabase\r\n        .from('streams_participants')\r\n        .update({ is_active: false, left_at: new Date().toISOString() })\r\n        .eq('stream_id', streamId)\r\n        .eq('user_id', user.id);\r\n    } catch (err) {\r\n      console.error('Failed to mark participant inactive', err);\r\n    }\r\n  }, [streamId, user?.id]);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      void markParticipantInactive();\r\n    };\r\n  }, [markParticipantInactive]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    const handleBeforeUnload = () => {\r\n      void markParticipantInactive();\r\n    };\r\n    window.addEventListener('beforeunload', handleBeforeUnload);\r\n    return () => {\r\n      window.removeEventListener('beforeunload', handleBeforeUnload);\r\n    };\r\n  }, [markParticipantInactive]);\r\n\r\n  useEffect(() => {\r\n    leaveCleanupRef.current = false;\r\n  }, [streamId, user?.id]);\r\n\r\n  useEffect(() => {\r\n    entranceSentRef.current = false;\r\n  }, [streamId, user?.id]);\r\n\r\n  useEffect(() => {\r\n    if (!streamId || !user?.id || !isConnected) return;\r\n    if (entranceSentRef.current) return;\r\n    entranceSentRef.current = true;\r\n\r\n    const sendEntrance = async () => {\r\n      try {\r\n        if (profile?.is_ghost_mode) {\r\n          return;\r\n        }\r\n        const { effectKey, config } = await getUserEntranceEffect(user.id);\r\n        if (!effectKey) return;\r\n\r\n        await supabase.from('messages').insert({\r\n          stream_id: streamId,\r\n          user_id: user.id,\r\n          message_type: 'entrance',\r\n          content: JSON.stringify({\r\n            username: profile?.username || user.email,\r\n            role: profile?.role || 'viewer',\r\n            effectKey,\r\n            effect: config,\r\n          })\r\n        });\r\n      } catch (err) {\r\n        console.error('Failed to send entrance effect message', err);\r\n      }\r\n    };\r\n\r\n    void sendEntrance();\r\n  }, [streamId, user?.id, isConnected, profile?.username, profile?.role, profile?.is_ghost_mode, user?.email]);\r\n\r\n  const handleGiftFromProfile = useCallback((profile: any) => {\r\n      setGiftRecipient(profile);\r\n      setIsGiftModalOpen(true);\r\n      setSelectedProfile(null);\r\n      if (isMobile) {\r\n        setActiveMobilePanel('gifts');\r\n      }\r\n  }, [isMobile]);\r\n\r\n  const handleMobilePanelChange = useCallback((panel: 'seats' | 'gifts' | 'chat') => {\r\n    setActiveMobilePanel(panel);\r\n    if (panel !== 'gifts') {\r\n      setIsGiftModalOpen(false);\r\n    } else {\r\n      setIsGiftModalOpen(true);\r\n    }\r\n  }, []);\r\n\r\n  const closeGiftPanel = useCallback(() => {\r\n    setIsGiftModalOpen(false);\r\n    if (isMobile) {\r\n      setActiveMobilePanel('seats');\r\n    }\r\n  }, [isMobile]);\r\n\r\n  const toGiftSlug = (value?: string) => {\r\n    if (!value) return 'gift';\r\n    return value\r\n      .toLowerCase()\r\n      .trim()\r\n      .replace(/[^a-z0-9]+/g, '_')\r\n      .replace(/^_+|_+$/g, '') || 'gift';\r\n  };\r\n\r\n  const handleGiftSent = useCallback(async (amountOrGift: any) => {\r\n    let totalCoins = 0;\r\n    let quantity = 1;\r\n    let giftName = 'Manual Gift';\r\n    let giftSlug: string | undefined;\r\n\r\n    if (typeof amountOrGift === 'number') {\r\n      totalCoins = amountOrGift;\r\n    } else if (amountOrGift && typeof amountOrGift === 'object') {\r\n      const g = amountOrGift;\r\n      quantity = Math.max(1, Number(g.quantity) || 1);\r\n      const per = Number(g.coins) || 0;\r\n      totalCoins = per * quantity;\r\n      giftName = g.name || giftName;\r\n      giftSlug = g.slug || toGiftSlug(giftName);\r\n    }\r\n\r\n    setIsGiftModalOpen(false);\r\n    if (isMobile) {\r\n      setActiveMobilePanel('seats');\r\n    }\r\n\r\n    const receiverId = giftRecipient?.id || null;\r\n    setGiftRecipient(null);\r\n\r\n    const senderId = user?.id;\r\n    const streamIdValue = stream?.id;\r\n    const broadcasterId = stream?.broadcaster_id;\r\n    const canonicalGiftSlug = giftSlug || toGiftSlug(giftName);\r\n\r\n    if (!senderId || !streamIdValue) {\r\n      toast.error('Unable to send gift right now.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { error } = await supabase.from('gifts').insert({\r\n        stream_id: streamIdValue,\r\n        sender_id: senderId,\r\n        receiver_id: receiverId,\r\n        coins_spent: totalCoins,\r\n        gift_type: 'paid',\r\n        message: giftName,\r\n        gift_slug: canonicalGiftSlug,\r\n        quantity: quantity,\r\n      });\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      if (streamIdValue && broadcasterId) {\r\n        const eventType = totalCoins >= 1000 ? 'super_gift' : 'gift';\r\n        const themeIdToUse = lastThemeId || broadcastTheme?.id;\r\n        if (!themeIdToUse) {\r\n          console.warn('[WatchPage] Skipping broadcast_theme_events insert because no theme is active');\r\n        } else {\r\n          await supabase.from('broadcast_theme_events').insert({\r\n            room_id: streamIdValue,\r\n            broadcaster_id: broadcasterId,\r\n            user_id: senderId,\r\n            theme_id: themeIdToUse,\r\n            event_type: eventType,\r\n            payload: {\r\n              gift_slug: canonicalGiftSlug,\r\n              coins: totalCoins,\r\n              sender_id: senderId\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to record manual gift event:', e);\r\n    }\r\n  }, [stream?.id, stream?.broadcaster_id, user?.id, giftRecipient?.id, broadcastTheme?.id, lastThemeId, isMobile]);\r\n\r\n  const handleCoinsPurchased = useCallback(() => {\r\n    setIsCoinStoreOpen(false);\r\n  }, []);\r\n\r\n  const handleSendCoins = useCallback((amount: number) => {\r\n    // TODO: Implement direct coin transfer\r\n    console.log('Sending coins:', amount);\r\n    toast.info(`Sent ${amount} coins!`);\r\n  }, []);\r\n\r\n  const videoStage = (\r\n    <div className=\"relative h-full w-full rounded-2xl overflow-hidden bg-black border border-white/10 shadow-inner\">\r\n      {broadcastTheme?.asset_type === 'video' && (broadcastTheme?.video_webm_url || broadcastTheme?.video_mp4_url) ? (\r\n        <video className=\"absolute inset-0 w-full h-full object-cover\" muted loop autoPlay playsInline>\r\n          {broadcastTheme?.video_webm_url && (\r\n            <source src={broadcastTheme.video_webm_url} type=\"video/webm\" />\r\n          )}\r\n          {broadcastTheme?.video_mp4_url && (\r\n            <source src={broadcastTheme.video_mp4_url} type=\"video/mp4\" />\r\n          )}\r\n        </video>\r\n      ) : (\r\n        <div className=\"absolute inset-0\" style={broadcastThemeStyle} />\r\n      )}\r\n      <div className=\"absolute inset-0 bg-black/35\" />\r\n      <div\r\n        className={`absolute inset-0 pointer-events-none ${\r\n          reactiveEvent ? `theme-reactive-${reactiveEvent.style} theme-reactive-intensity-${reactiveEvent.intensity}` : ''\r\n        }`}\r\n      />\r\n      <ResponsiveVideoGrid\r\n        participants={participants}\r\n        localParticipant={liveKit.getRoom()?.localParticipant}\r\n        broadcasterId={stream?.broadcaster_id}\r\n        seats={seats}\r\n        isHost={false}\r\n        boxCount={boxCount}\r\n        onUserClick={(p) => {\r\n          // Find profile from participants if possible, or just ignore\r\n        }}\r\n      />\r\n      {lastGift && <GiftEventOverlay gift={lastGift} onProfileClick={setSelectedProfile} />}\r\n    </div>\r\n  );\r\n\r\n  // Layout\r\n  if (!profile) {\r\n    return (\r\n        <div className=\"min-h-screen bg-[#03010c] via-[#05031a] to-[#110117] text-white flex items-center justify-center\">\r\n            <div className=\"text-center space-y-4\">\r\n            <div className=\"w-16 h-16 rounded-full border-2 border-purple-500/60 animate-pulse\" />\r\n            <p className=\"text-sm text-gray-300\">Loading profile...</p>\r\n            </div>\r\n        </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#03010c] via-[#05031a] to-[#110117] text-white\">\r\n      {needsPrivateGate && !privateAccessGranted && (\r\n        <div className=\"fixed inset-0 z-[210] flex items-center justify-center bg-black/90 px-4\">\r\n          <div className=\"w-full max-w-sm rounded-2xl border border-white/10 bg-[#0c0a16] p-6 shadow-xl\">\r\n            <h3 className=\"text-lg font-semibold text-white mb-2\">Private stream</h3>\r\n            <p className=\"text-sm text-gray-300 mb-4\">\r\n              This broadcast requires a password provided by the broadcaster. Enter it below to join.\r\n            </p>\r\n            <input\r\n              type=\"password\"\r\n              value={privatePasswordInput}\r\n              onChange={(e) => setPrivatePasswordInput(e.target.value)}\r\n              placeholder=\"Enter stream password\"\r\n              className=\"w-full bg-[#05060f] border border-purple-500/40 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-300 focus:outline-none mb-2\"\r\n            />\r\n            {privateAuthError && (\r\n              <p className=\"text-xs text-red-400 mb-2\">{privateAuthError}</p>\r\n            )}\r\n            <button\r\n              className=\"w-full py-2 rounded-lg bg-purple-600 hover:bg-purple-500 font-semibold text-sm\"\r\n              onClick={handlePrivatePasswordSubmit}\r\n            >\r\n              Submit password\r\n            </button>\r\n            {!user && (\r\n              <p className=\"mt-3 text-xs text-gray-400\">\r\n                You must be signed in to enter the password.\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n      {entranceEffect && (\r\n        <EntranceEffect\r\n          username={entranceEffect.username}\r\n          role={entranceEffect.role}\r\n          profile={entranceEffect.profile}\r\n          userId={entranceEffect.userId}\r\n        />\r\n      )}\r\n\r\n      {isMobile ? (\r\n        <div className=\"flex min-h-[100dvh] flex-col\">\r\n          <main\r\n            className=\"flex-1 flex flex-col min-h-0 px-3 py-3\"\r\n            style={{ paddingBottom: `calc(${MOBILE_NAV_HEIGHT}px + env(safe-area-inset-bottom, 0px))` }}\r\n          >\r\n            <section className=\"flex h-full min-h-0 flex-col gap-3 rounded-[24px] border border-white/10 bg-gradient-to-b from-[#050113] to-[#0b091f] p-4 shadow-2xl\">\r\n              <div className=\"flex items-center justify-between gap-3 shrink-0\">\r\n                <div>\r\n                  <p className=\"text-[11px] uppercase tracking-[0.3em] text-white/50\">Live Stream</p>\r\n                  <p className=\"text-sm text-white/80\">{stream?.title || 'Loading Stream...'}</p>\r\n                </div>\r\n                <div className=\"flex items-center gap-2 text-xs\">\r\n                  <div className=\"px-3 py-2 bg-white/5 rounded-lg border border-white/10 flex items-center gap-2\">\r\n                    <Users size={14} className=\"text-green-400\" />\r\n                    <span className=\"font-bold\">{(stream?.current_viewers || 0).toLocaleString()}</span>\r\n                  </div>\r\n                  {stream?.is_live && <div className=\"px-2 py-1 bg-red-600 rounded-full text-[11px] font-bold animate-pulse\">LIVE</div>}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"relative flex-1 min-h-0 rounded-2xl border border-white/5 bg-black/30 backdrop-blur-sm overflow-visible\">\r\n                {activeMobilePanel === 'seats' && (\r\n                  <div className=\"absolute inset-0 flex flex-col\">{videoStage}</div>\r\n                )}\r\n                {activeMobilePanel === 'chat' && (\r\n                  <div\r\n                    className=\"absolute inset-0 flex flex-col rounded-2xl bg-[#050113] border border-white/5 overflow-hidden\"\r\n                    style={{ paddingBottom: 'env(safe-area-inset-bottom, 0px)' }}\r\n                  >\r\n                    <div className=\"flex items-center justify-between px-3 py-2 border-b border-white/10 bg-black/30\">\r\n                      <span className=\"text-sm font-semibold\">Live Chat</span>\r\n                      <button\r\n                        className=\"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/20\"\r\n                        onClick={() => handleMobilePanelChange('seats')}\r\n                      >\r\n                        Close\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"flex-1 min-h-0 overflow-hidden\">\r\n                      {hasValidStreamId && (\r\n                        <ChatBox\r\n                          streamId={streamId!}\r\n                          onProfileClick={setSelectedProfile}\r\n                        />\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                {activeMobilePanel === 'gifts' && isGiftModalOpen && (\r\n                  <div className=\"absolute inset-0 flex flex-col\">\r\n                    <GiftModal\r\n                      variant=\"sheet\"\r\n                      onClose={closeGiftPanel}\r\n                      onSendGift={handleGiftSent}\r\n                      recipientName={giftRecipient?.username || giftRecipient?.name || 'Broadcaster'}\r\n                      profile={profile}\r\n                    />\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"sticky bottom-0 z-20\">\r\n                <div\r\n                  className=\"flex items-center gap-2 rounded-full bg-white/5 border border-white/10 p-2 backdrop-blur-md shadow-lg\"\r\n                  style={{ paddingBottom: 'max(0px, env(safe-area-inset-bottom, 0px))' }}\r\n                >\r\n                  <button\r\n                    className={`flex-1 inline-flex items-center justify-center gap-2 rounded-full px-3 py-2 text-sm font-semibold transition ${\r\n                      activeMobilePanel === 'seats' ? 'bg-purple-600/80 text-white shadow-lg' : 'bg-white/5 text-white/70'\r\n                    }`}\r\n                    aria-pressed={activeMobilePanel === 'seats'}\r\n                    onClick={() => handleMobilePanelChange('seats')}\r\n                  >\r\n                    <Tv size={16} /> Seats\r\n                  </button>\r\n                  <button\r\n                    className={`flex-1 inline-flex items-center justify-center gap-2 rounded-full px-3 py-2 text-sm font-semibold transition ${\r\n                      activeMobilePanel === 'gifts' ? 'bg-purple-600/80 text-white shadow-lg' : 'bg-white/5 text-white/70'\r\n                    }`}\r\n                    aria-pressed={activeMobilePanel === 'gifts'}\r\n                    onClick={() => handleMobilePanelChange('gifts')}\r\n                  >\r\n                    <Gift size={16} /> Gifts\r\n                  </button>\r\n                  <button\r\n                    className={`flex-1 inline-flex items-center justify-center gap-2 rounded-full px-3 py-2 text-sm font-semibold transition ${\r\n                      activeMobilePanel === 'chat' ? 'bg-purple-600/80 text-white shadow-lg' : 'bg-white/5 text-white/70'\r\n                    }`}\r\n                    aria-pressed={activeMobilePanel === 'chat'}\r\n                    onClick={() => handleMobilePanelChange('chat')}\r\n                  >\r\n                  <MessageCircle size={16} className={messageIconClass} /> Chat\n                  </button>\r\n                </div>\r\n              </div>\r\n            </section>\r\n          </main>\r\n        </div>\r\n      ) : (\r\n        <div className=\"flex h-screen flex-col\">\r\n          <main className=\"flex-1 px-6 py-5\">\r\n            <section className=\"h-full rounded-[32px] border border-white/10 bg-gradient-to-b from-[#050113] to-[#0b091f] p-6 shadow-2xl flex flex-col\">\r\n              <div className=\"mb-5 flex items-center justify-between shrink-0\">\r\n                <div>\r\n                  <p className=\"text-xs uppercase tracking-[0.4em] text-white/50\">Live Stream</p>\r\n                  <p className=\"text-sm text-white/70\">{stream?.title || 'Loading Stream...'}</p>\r\n                </div>\r\n                <div className=\"flex items-center gap-4\">\r\n                  <div className=\"px-4 py-2 bg-white/5 rounded-lg border border-white/10 flex items-center gap-2\">\r\n                    <Heart size={16} className=\"text-purple-400\" /> <span className=\"font-bold\">{stream?.total_likes || 0}</span>\r\n                  </div>\r\n                  <div className=\"px-4 py-2 bg-white/5 rounded-lg border border-white/10 flex items-center gap-2\">\r\n                    <Users size={16} className=\"text-green-400\" /> <span className=\"font-bold\">{(stream?.current_viewers || 0).toLocaleString()}</span>\r\n                  </div>\r\n                  <div className=\"px-4 py-2 bg-white/5 rounded-lg border border-yellow-500/30 flex items-center gap-2\">\r\n                    <div className=\"w-4 h-4 rounded-full bg-yellow-500 flex items-center justify-center text-black font-bold text-[8px]\">C</div>\r\n                    <span className=\"font-bold text-yellow-400\">{(stream?.total_gifts_coins || 0).toLocaleString()}</span>\r\n                  </div>\r\n                  {stream?.is_live && <div className=\"px-3 py-1 bg-red-600 rounded-full text-xs font-bold animate-pulse\">LIVE</div>}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-4 gap-6\">\r\n                <div className=\"lg:col-span-3 h-full\">{videoStage}</div>\r\n                <div className=\"lg:col-span-1 h-full flex flex-col gap-4 min-h-0\">\r\n                  {hasValidStreamId && (\r\n                    <ChatBox\r\n                      streamId={streamId!}\r\n                      onProfileClick={setSelectedProfile}\r\n                    />\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </section>\r\n          </main>\r\n        </div>\r\n      )}\r\n\r\n      {isGiftModalOpen && !isMobile && (\r\n        <GiftModal\r\n          onClose={() => setIsGiftModalOpen(false)}\r\n          onSendGift={handleGiftSent}\r\n          recipientName={giftRecipient?.username || giftRecipient?.name || 'Broadcaster'}\r\n          profile={profile}\r\n        />\r\n      )}\r\n      {selectedProfile && (\r\n        <ProfileModal\r\n          profile={selectedProfile}\r\n          onClose={() => setSelectedProfile(null)}\r\n          onSendCoins={handleSendCoins}\r\n          currentUser={user}\r\n          onGift={handleGiftFromProfile}\r\n        />\r\n      )}\r\n      {isCoinStoreOpen && <CoinStoreModal onClose={() => setIsCoinStoreOpen(false)} onPurchase={handleCoinsPurchased} />}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\WeeklyFamilyChallenge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\Withdraw.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminEarningsDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RefreshCw' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":12,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RefreshCw"},"fix":{"range":[334,348],"text":""},"desc":"Remove unused variable \"RefreshCw\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useMemo } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { \r\n  Loader, DollarSign, Users, \r\n  Search, TrendingUp,\r\n  Building, Settings, Plus, Trash,\r\n  RefreshCw\r\n} from 'lucide-react'\r\nimport { EarningsView } from '../../types/earnings'\r\nimport AutomatedPayouts from './components/AutomatedPayouts'\r\n\r\ninterface CreatorEarnings extends EarningsView {\r\n  w9_status?: string\r\n}\r\n\r\ninterface AdminProperty {\r\n  id: string\r\n  name: string\r\n  base_value: number\r\n  ask_price: number\r\n  address_line1: string\r\n  owner_user_id: string\r\n  updated_at: string\r\n}\r\n\r\nconst AdminEarningsDashboard: React.FC = () => {\r\n  const { profile } = useAuthStore()\r\n  const navigate = useNavigate()\r\n  \r\n  // Tabs state\r\n  const [activeTab, setActiveTab] = useState<'creators' | 'properties' | 'settings'>('creators')\r\n\r\n  // Creators State\r\n  const [creators, setCreators] = useState<CreatorEarnings[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [statusFilter] = useState<'all' | 'over_threshold' | 'nearing_threshold' | 'below_threshold'>('all')\r\n  const [sortBy] = useState<'earnings' | 'payouts' | 'threshold'>('earnings')\r\n\r\n  // Properties State\r\n  const [properties, setProperties] = useState<AdminProperty[]>([])\r\n  const [loadingProps, setLoadingProps] = useState(false)\r\n\r\n  // Settings State\r\n  const [providerSettings, setProviderSettings] = useState<{[key: string]: number}>({})\r\n  const [newProviderName, setNewProviderName] = useState('')\r\n  const [newProviderCost, setNewProviderCost] = useState('')\r\n  const [loadingSettings, setLoadingSettings] = useState(false)\r\n\r\n  // Access Control\r\n  useEffect(() => {\r\n    if (profile && profile.role !== 'admin') {\r\n      toast.error('Access denied. Admin only.')\r\n      navigate('/')\r\n    }\r\n  }, [profile, navigate])\r\n\r\n  // Initial Load\r\n  useEffect(() => {\r\n    if (profile?.role === 'admin' || profile?.is_admin) {\r\n      loadCreators()\r\n    } else {\r\n      setLoading(false)\r\n    }\r\n  }, [profile])\r\n\r\n  // Load Data on Tab Change\r\n  useEffect(() => {\r\n    if (activeTab === 'properties') {\r\n      loadProperties()\r\n    } else if (activeTab === 'settings') {\r\n      loadSettings()\r\n    }\r\n  }, [activeTab])\r\n\r\n  const loadCreators = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const { data, error } = await supabase\r\n        .from('earnings_view')\r\n        .select('*')\r\n        .order('total_earned_coins', { ascending: false })\r\n\r\n      if (error) throw error\r\n      if (data) setCreators(data as CreatorEarnings[])\r\n    } catch (err) {\r\n      // Fallback logic omitted for brevity as per original, but keeping structure\r\n      console.warn('Using fallback load', err)\r\n      const { data } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, total_earned_coins, troll_coins')\r\n        .gt('total_earned_coins', 0)\r\n        .order('total_earned_coins', { ascending: false })\r\n        .limit(100)\r\n        \r\n      if (data) {\r\n        setCreators(data.map(p => ({\r\n          id: p.id,\r\n          username: p.username || '',\r\n          total_earned_coins: p.total_earned_coins || 0,\r\n          troll_coins: p.troll_coins || 0,\r\n          current_month_earnings: 0,\r\n          current_month_transactions: 0,\r\n          current_month_paid_out: 0,\r\n          current_month_pending: 0,\r\n          current_month_approved: 0,\r\n          current_month_paid_count: 0,\r\n          current_month_pending_count: 0,\r\n          yearly_paid_usd: 0,\r\n          yearly_payout_count: 0,\r\n          tax_year: new Date().getFullYear(),\r\n          irs_threshold_status: 'below_threshold' as const,\r\n          last_payout_at: null,\r\n          pending_requests_count: 0,\r\n          lifetime_paid_usd: 0\r\n        })))\r\n      }\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const loadProperties = async () => {\r\n    try {\r\n      setLoadingProps(true)\r\n      // Get all admin IDs first\r\n      const { data: admins } = await supabase\r\n        .from('user_profiles')\r\n        .select('id')\r\n        .or('role.eq.admin,is_admin.eq.true')\r\n      \r\n      if (!admins || admins.length === 0) return\r\n\r\n      const adminIds = admins.map(a => a.id)\r\n      const { data: props, error } = await supabase\r\n        .from('properties')\r\n        .select('*')\r\n        .in('owner_user_id', adminIds)\r\n        .order('updated_at', { ascending: false })\r\n\r\n      if (error) throw error\r\n      setProperties(props || [])\r\n    } catch (err) {\r\n      console.error('Failed to load properties', err)\r\n      toast.error('Failed to load properties')\r\n    } finally {\r\n      setLoadingProps(false)\r\n    }\r\n  }\r\n\r\n  const loadSettings = async () => {\r\n    try {\r\n      setLoadingSettings(true)\r\n      const { data, error } = await supabase\r\n        .from('admin_app_settings')\r\n        .select('setting_value')\r\n        .eq('setting_key', 'provider_costs')\r\n        .single()\r\n      \r\n      if (error && error.code !== 'PGRST116') throw error // Ignore not found\r\n      if (data) {\r\n        setProviderSettings(data.setting_value)\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to load settings', err)\r\n      toast.error('Failed to load settings')\r\n    } finally {\r\n      setLoadingSettings(false)\r\n    }\r\n  }\r\n\r\n  const saveSettings = async (newSettings: {[key: string]: number}) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('admin_app_settings')\r\n        .upsert({ \r\n          setting_key: 'provider_costs', \r\n          setting_value: newSettings \r\n        })\r\n      \r\n      if (error) throw error\r\n      setProviderSettings(newSettings)\r\n      toast.success('Settings saved')\r\n    } catch (err) {\r\n      console.error('Failed to save settings', err)\r\n      toast.error('Failed to save settings')\r\n    }\r\n  }\r\n\r\n  const handleAddProvider = () => {\r\n    if (!newProviderName || !newProviderCost) return\r\n    const cost = parseInt(newProviderCost)\r\n    if (isNaN(cost)) {\r\n      toast.error('Invalid cost')\r\n      return\r\n    }\r\n    const updated = { ...providerSettings, [newProviderName]: cost }\r\n    saveSettings(updated)\r\n    setNewProviderName('')\r\n    setNewProviderCost('')\r\n  }\r\n\r\n  const handleDeleteProvider = (name: string) => {\r\n    const updated = { ...providerSettings }\r\n    delete updated[name]\r\n    saveSettings(updated)\r\n  }\r\n\r\n  // Filter Logic for Creators\r\n  const filteredCreators = useMemo(() => {\r\n    let filtered = creators\r\n    if (searchTerm) {\r\n      filtered = filtered.filter(c => c.username.toLowerCase().includes(searchTerm.toLowerCase()))\r\n    }\r\n    if (statusFilter !== 'all') {\r\n      filtered = filtered.filter(c => c.irs_threshold_status === statusFilter)\r\n    }\r\n    filtered = [...filtered].sort((a, b) => {\r\n      switch (sortBy) {\r\n        case 'earnings': return b.total_earned_coins - a.total_earned_coins\r\n        case 'payouts': return b.lifetime_paid_usd - a.lifetime_paid_usd\r\n        case 'threshold': return b.yearly_paid_usd - a.yearly_paid_usd\r\n        default: return 0\r\n      }\r\n    })\r\n    return filtered\r\n  }, [creators, searchTerm, statusFilter, sortBy])\r\n\r\n  if (profile && profile.role !== 'admin') return null // Handled by useEffect redirect\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-7xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-white flex items-center gap-3\">\r\n              <DollarSign className=\"w-8 h-8 text-green-400\" />\r\n              Admin Dashboard\r\n            </h1>\r\n            <p className=\"text-gray-400 mt-1\">Manage earnings, properties, and system settings</p>\r\n          </div>\r\n          \r\n          {/* Tab Navigation */}\r\n          <div className=\"flex bg-zinc-900/50 p-1 rounded-lg border border-white/10\">\r\n            <button\r\n              onClick={() => setActiveTab('creators')}\r\n              className={`px-4 py-2 rounded-md text-sm font-semibold transition-all ${\r\n                activeTab === 'creators' \r\n                  ? 'bg-purple-600 text-white shadow-lg' \r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              <div className=\"flex items-center gap-2\">\r\n                <Users size={16} />\r\n                <span>Creators</span>\r\n              </div>\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('properties')}\r\n              className={`px-4 py-2 rounded-md text-sm font-semibold transition-all ${\r\n                activeTab === 'properties' \r\n                  ? 'bg-purple-600 text-white shadow-lg' \r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              <div className=\"flex items-center gap-2\">\r\n                <Building size={16} />\r\n                <span>Bank Properties</span>\r\n              </div>\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('settings')}\r\n              className={`px-4 py-2 rounded-md text-sm font-semibold transition-all ${\r\n                activeTab === 'settings' \r\n                  ? 'bg-purple-600 text-white shadow-lg' \r\n                  : 'text-gray-400 hover:text-white'\r\n              }`}\r\n            >\r\n              <div className=\"flex items-center gap-2\">\r\n                <Settings size={16} />\r\n                <span>Settings</span>\r\n              </div>\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tab Content */}\r\n        {activeTab === 'automated' && (\r\n          <div className=\"animate-fade-in\">\r\n             <AutomatedPayouts />\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'creators' && (\r\n          <div className=\"space-y-6 animate-fade-in\">\r\n            {/* Summary Cards */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n               {/* ... (Summary cards preserved from original) ... */}\r\n               <div className=\"bg-zinc-900 rounded-xl p-4 border border-green-500/30\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <TrendingUp className=\"w-5 h-5 text-green-400\" />\r\n                    <span className=\"text-sm text-gray-400\">Total Earnings</span>\r\n                  </div>\r\n                  <p className=\"text-2xl font-bold text-green-400\">\r\n                    {creators.reduce((sum, c) => sum + c.total_earned_coins, 0).toLocaleString()}\r\n                  </p>\r\n               </div>\r\n               {/* Simplified summary for brevity */}\r\n            </div>\r\n\r\n            {/* Filters & Table */}\r\n            <div className=\"bg-zinc-900 rounded-xl p-4 border border-[#2C2C2C]\">\r\n              {/* Filters UI */}\r\n              <div className=\"flex gap-4 mb-4\">\r\n                 <div className=\"relative flex-1\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400\" />\r\n                    <input \r\n                      type=\"text\" \r\n                      placeholder=\"Search...\" \r\n                      value={searchTerm}\r\n                      onChange={e => setSearchTerm(e.target.value)}\r\n                      className=\"w-full pl-10 pr-4 py-2 bg-zinc-800 border border-gray-700 rounded-lg\"\r\n                    />\r\n                 </div>\r\n              </div>\r\n\r\n              {loading ? (\r\n                <div className=\"text-center py-10\"><Loader className=\"animate-spin mx-auto\" /></div>\r\n              ) : (\r\n                <div className=\"overflow-x-auto\">\r\n                  <table className=\"w-full text-sm\">\r\n                    <thead>\r\n                      <tr className=\"border-b border-gray-700 text-gray-400\">\r\n                        <th className=\"text-left py-2\">Username</th>\r\n                        <th className=\"text-right py-2\">Total Earned</th>\r\n                        <th className=\"text-right py-2\">Pending Payout</th>\r\n                        <th className=\"text-center py-2\">Status</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {filteredCreators.map(creator => (\r\n                        <tr key={creator.id} className=\"border-b border-gray-800\">\r\n                          <td className=\"py-2\">{creator.username}</td>\r\n                          <td className=\"text-right py-2 text-green-400\">{creator.total_earned_coins.toLocaleString()}</td>\r\n                          <td className=\"text-right py-2\">{creator.current_month_pending > 0 ? `$${creator.current_month_pending}` : '-'}</td>\r\n                          <td className=\"text-center py-2\">{creator.irs_threshold_status === 'over_threshold' ? '‚ö†Ô∏è Over Limit' : 'OK'}</td>\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'properties' && (\r\n          <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C] animate-fade-in\">\r\n            <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n              <Building className=\"w-5 h-5 text-blue-400\" />\r\n              Bank Owned Properties\r\n            </h2>\r\n            \r\n            {loadingProps ? (\r\n               <div className=\"text-center py-10\"><Loader className=\"animate-spin mx-auto\" /></div>\r\n            ) : properties.length === 0 ? (\r\n               <div className=\"text-center py-10 text-gray-500\">No properties owned by the bank.</div>\r\n            ) : (\r\n               <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {properties.map(prop => (\r\n                    <div key={prop.id} className=\"bg-black/40 border border-white/10 rounded-lg p-4\">\r\n                       <h3 className=\"font-bold text-lg\">{prop.name || 'Unnamed Property'}</h3>\r\n                       <p className=\"text-gray-400 text-sm mb-2\">{prop.address_line1}</p>\r\n                       <div className=\"flex justify-between items-center mt-4\">\r\n                          <div className=\"text-emerald-400 font-bold\">\r\n                             {prop.base_value?.toLocaleString()} Coins\r\n                          </div>\r\n                          <div className=\"text-xs text-gray-500\">\r\n                             Acquired: {new Date(prop.updated_at).toLocaleDateString()}\r\n                          </div>\r\n                       </div>\r\n                    </div>\r\n                  ))}\r\n               </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {activeTab === 'settings' && (\r\n          <div className=\"bg-zinc-900 rounded-xl p-6 border border-[#2C2C2C] animate-fade-in\">\r\n            <h2 className=\"text-xl font-bold mb-6 flex items-center gap-2\">\r\n              <Settings className=\"w-5 h-5 text-purple-400\" />\r\n              Provider Costs & Allocations\r\n            </h2>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\r\n               {/* Provider List */}\r\n               <div className=\"space-y-4\">\r\n                  <h3 className=\"text-lg font-semibold text-gray-300\">Current Providers</h3>\r\n                  {loadingSettings ? (\r\n                    <Loader className=\"animate-spin\" />\r\n                  ) : Object.keys(providerSettings).length === 0 ? (\r\n                    <p className=\"text-gray-500\">No providers configured.</p>\r\n                  ) : (\r\n                    <div className=\"space-y-2\">\r\n                       {Object.entries(providerSettings).map(([name, cost]) => (\r\n                         <div key={name} className=\"flex items-center justify-between bg-black/20 p-3 rounded-lg border border-white/5\">\r\n                            <div>\r\n                               <div className=\"font-bold\">{name}</div>\r\n                               <div className=\"text-sm text-gray-400\">Monthly Cost: <span className=\"text-yellow-400\">{cost.toLocaleString()} Coins</span></div>\r\n                            </div>\r\n                            <button \r\n                              onClick={() => handleDeleteProvider(name)}\r\n                              className=\"p-2 hover:bg-red-500/20 text-red-400 rounded-lg transition\"\r\n                            >\r\n                               <Trash size={16} />\r\n                            </button>\r\n                         </div>\r\n                       ))}\r\n                    </div>\r\n                  )}\r\n               </div>\r\n\r\n               {/* Add New */}\r\n               <div className=\"bg-black/20 p-6 rounded-xl border border-white/5 h-fit\">\r\n                  <h3 className=\"text-lg font-semibold text-gray-300 mb-4\">Add Provider</h3>\r\n                  <div className=\"space-y-4\">\r\n                     <div>\r\n                        <label className=\"block text-xs uppercase text-gray-500 mb-1\">Provider Name</label>\r\n                        <input \r\n                          type=\"text\" \r\n                          value={newProviderName}\r\n                          onChange={e => setNewProviderName(e.target.value)}\r\n                          className=\"w-full bg-zinc-800 border border-gray-700 rounded-lg px-3 py-2 focus:border-purple-500 outline-none\"\r\n                          placeholder=\"e.g. Vercel\"\r\n                        />\r\n                     </div>\r\n                     <div>\r\n                        <label className=\"block text-xs uppercase text-gray-500 mb-1\">Monthly Cost (Coins)</label>\r\n                        <input \r\n                          type=\"number\" \r\n                          value={newProviderCost}\r\n                          onChange={e => setNewProviderCost(e.target.value)}\r\n                          className=\"w-full bg-zinc-800 border border-gray-700 rounded-lg px-3 py-2 focus:border-purple-500 outline-none\"\r\n                          placeholder=\"e.g. 5000\"\r\n                        />\r\n                     </div>\r\n                     <button \r\n                        onClick={handleAddProvider}\r\n                        disabled={!newProviderName || !newProviderCost}\r\n                        className=\"w-full py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\r\n                     >\r\n                        <Plus size={16} />\r\n                        Add Provider\r\n                     </button>\r\n                  </div>\r\n               </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default AdminEarningsDashboard\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminErrors.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminFinanceDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminHR.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminLiveOfficersTracker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminMarketplace.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminOfficerReports.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminPayoutMobile.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminPoliciesDocs.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":76,"column":60,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin &quot;Payout Requests\"\r\n            view, then marked as "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin &ldquo;Payout Requests\"\r\n            view, then marked as "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin &#34;Payout Requests\"\r\n            view, then marked as "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin &rdquo;Payout Requests\"\r\n            view, then marked as "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":76,"column":76,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin \"Payout Requests&quot;\r\n            view, then marked as "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin \"Payout Requests&ldquo;\r\n            view, then marked as "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin \"Payout Requests&#34;\r\n            view, then marked as "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2564,2677],"text":"\r\n            ‚Ä¢ Payouts are processed manually via the Admin \"Payout Requests&rdquo;\r\n            view, then marked as "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { FileText } from 'lucide-react'\r\n\r\ntype SectionProps = {\r\n  title: string\r\n  children: React.ReactNode\r\n}\r\n\r\nfunction DocSection({ title, children }: SectionProps) {\r\n  return (\r\n    <section className=\"rounded-2xl border border-purple-600/30 bg-black/60 p-4\">\r\n      <h2 className=\"text-sm font-semibold uppercase tracking-[0.18em] text-purple-300 mb-2\">\r\n        {title}\r\n      </h2>\r\n      <div className=\"mt-2 space-y-2 text-sm text-gray-200\">{children}</div>\r\n    </section>\r\n  )\r\n}\r\n\r\nexport default function AdminPoliciesDocsPage() {\r\n  const { profile } = useAuthStore()\r\n  const isAdmin = profile?.role === 'admin' || profile?.is_admin\r\n\r\n  if (!isAdmin) {\r\n    return (\r\n      <div className=\"p-6 text-center text-white\">\r\n        Admin access only.\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-6xl mx-auto text-white min-h-screen\">\r\n      <header className=\"flex flex-col gap-1 mb-6\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <FileText className=\"w-6 h-6 text-purple-400\" />\r\n          <p className=\"text-xs uppercase tracking-[0.2em] text-purple-300\">\r\n            Internal Docs\r\n          </p>\r\n        </div>\r\n        <h1 className=\"text-2xl font-bold text-white\">\r\n          Troll City Policy & Economy Overview\r\n        </h1>\r\n        <p className=\"text-xs text-gray-400\">\r\n          Quick reference for admins: payouts, officer rules, bans, and economy\r\n          logic. This page does not replace the public Terms of Service.\r\n        </p>\r\n      </header>\r\n\r\n      <div className=\"grid gap-4 md:grid-cols-2\">\r\n        <DocSection title=\"Coin Economy\">\r\n          <p>\r\n            ‚Ä¢ <strong>Free Coins:</strong> Earned via events, officer shifts, bonuses.\r\n            Cannot be cashed out directly.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ <strong>troll_coins:</strong> Purchased or converted. Only balance that is\r\n            eligible for payouts.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ <strong>Current internal conversion:</strong> 100,000 Free ‚Üí 10 Paid\r\n            Coins (configurable in <code className=\"text-purple-300\">app_settings</code>).\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Admins must never manually mint or delete coins. Adjust via audited\r\n            transactions only.\r\n          </p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Payout Rules\">\r\n          <p>\r\n            ‚Ä¢ Minimum payout threshold: <strong>12,000 troll_coins</strong>.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Payouts are processed manually via the Admin \"Payout Requests\"\r\n            view, then marked as <code className=\"text-purple-300\">paid_at</code>/<code className=\"text-purple-300\">paid_by</code>.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ KYC / ID verification & W-9 (US) required before first payout.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Accounts with chargebacks, fraud flags, or active bans are not eligible\r\n            for payout.\r\n          </p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Troll Officers\">\r\n          <p>\r\n            ‚Ä¢ Officers are independent contractors, not employees. Coins earned are\r\n            logged in <code className=\"text-purple-300\">officer_shift_logs</code>.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Auto clock-out when inactive for more than 20 minutes.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Monthly payroll summary available via <code className=\"text-purple-300\">officer_monthly_payroll</code>{' '}\r\n            view, with export to PDF.\r\n          </p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Moderation & Bans\">\r\n          <p>\r\n            ‚Ä¢ Severe violations (self-harm, minors, hate, explicit content) ‚Üí immediate\r\n            ban and escalation.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Use the <code className=\"text-purple-300\">moderation_reports</code> view to review AI and officer\r\n            reports.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Bans are recorded with <code className=\"text-purple-300\">is_banned</code> and{' '}\r\n            <code className=\"text-purple-300\">ban_expires_at</code> fields on <code className=\"text-purple-300\">user_profiles</code>.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Admins should always log a <strong>ban_reason</strong> and timestamp.\r\n          </p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Badges & Eligibility\">\r\n          <p>‚Ä¢ <strong>OG Badge:</strong> joined before Jan 1, 2026.</p>\r\n          <p>‚Ä¢ <strong>Officer Badge:</strong> approved Troll Officer role.</p>\r\n          <p>‚Ä¢ <strong>Influencer Badge:</strong> verified + influencer tier active (200+ followers, 5000+ coins received).</p>\r\n          <p>‚Ä¢ <strong>Verified Badge:</strong> AI verification passed + payment ($5 PayPal or 500 troll_coins).</p>\r\n          <p>‚Ä¢ <strong>VIP / high-spender:</strong> based on coin purchases; thresholds stored in settings.</p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Officer Tiers\">\r\n          <p>\r\n            ‚Ä¢ Shift rules: Manual clock-in required, auto clock-out after 20 mins inactivity\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Earnings logged in <code className=\"text-purple-300\">officer_shift_logs</code>\r\n          </p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Verification System\">\r\n          <p>\r\n            ‚Ä¢ <strong>AI Verification:</strong> ID upload + selfie matching via OpenAI Vision API\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ <strong>Payment:</strong> $5 PayPal or 500 troll_coins\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ <strong>Auto-approval:</strong> AI match score ‚â•75 AND behavior score ‚â•75\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ <strong>Review required:</strong> Scores 50-74 go to admin review\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ <strong>Denial:</strong> Scores &lt;50 automatically denied\r\n          </p>\r\n        </DocSection>\r\n\r\n        <DocSection title=\"Audit & Safety Notes\">\r\n          <p>\r\n            ‚Ä¢ All economy-critical changes (rates, thresholds, bonus campaigns) should\r\n            be stored in <code className=\"text-purple-300\">app_settings</code> and not hard-coded in frontend.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ Never override or edit <code className=\"text-purple-300\">coin_transactions</code> directly; use\r\n            dedicated admin flows.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ For legal questions about payouts, taxes, and labor classification,\r\n            consult counsel before changing rules.\r\n          </p>\r\n          <p>\r\n            ‚Ä¢ All moderation actions are logged in <code className=\"text-purple-300\">moderation_events</code> and\r\n            graded by Observer Bot AI.\r\n          </p>\r\n        </DocSection>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminResetPanel.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":163,"column":16,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5358,5411],"text":"\r\n          Type &quot;RESET\" to enable buttons:\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5358,5411],"text":"\r\n          Type &ldquo;RESET\" to enable buttons:\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5358,5411],"text":"\r\n          Type &#34;RESET\" to enable buttons:\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5358,5411],"text":"\r\n          Type &rdquo;RESET\" to enable buttons:\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":163,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5358,5411],"text":"\r\n          Type \"RESET&quot; to enable buttons:\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5358,5411],"text":"\r\n          Type \"RESET&ldquo; to enable buttons:\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5358,5411],"text":"\r\n          Type \"RESET&#34; to enable buttons:\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5358,5411],"text":"\r\n          Type \"RESET&rdquo; to enable buttons:\r\n        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// AdminResetPanel: Admin-only reset and maintenance tools\r\nimport React, { useState } from 'react'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { Trash2, PowerOff, Coins, AlertTriangle, Loader2 } from 'lucide-react'\r\n\r\nexport default function AdminResetPanel() {\r\n  const { profile } = useAuthStore()\r\n  const [loading, setLoading] = useState<string | null>(null)\r\n  const [confirmText, setConfirmText] = useState('')\r\n\r\n  if (!profile || (profile.role !== 'admin' && !profile.is_admin)) {\r\n    return (\r\n      <div className=\"bg-red-500/10 border border-red-500 rounded-xl p-6 text-red-400\">\r\n        <AlertTriangle className=\"w-6 h-6 mb-2\" />\r\n        <p>Admin access required</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const handleReset = async (action: string, actionName: string) => {\r\n    if (confirmText !== 'RESET') {\r\n      toast.error('Please type \"RESET\" to confirm')\r\n      return\r\n    }\r\n\r\n    setLoading(action)\r\n    \r\n    // Handle reset_troll_coinss with direct RPC call\r\n    if (action === 'reset_troll_coinss') {\r\n      try {\r\n        const { error } = await supabase.rpc(\"reset_troll_coinss\", {})\r\n\r\n        if (error) {\r\n          console.error('Reset error:', error)\r\n          toast.error('Failed to reset balances.')\r\n          return\r\n        }\r\n\r\n        toast.success('Coin balances reset successfully!')\r\n      } catch (err) {\r\n        console.error('Error Reset Coin Balances:', err)\r\n        toast.error('Failed to reset coin balances')\r\n      } finally {\r\n        setLoading(null)\r\n        setConfirmText('')\r\n      }\r\n      return\r\n    }\r\n\r\n    // Handle delete all livestreams\r\n    if (action === 'delete_all_livestreams') {\r\n      try {\r\n        toast.info('Deleting all livestreams... This may take a moment.')\r\n\r\n        // First, get count of streams to be deleted\r\n        const { count: streamCount } = await supabase\r\n          .from('streams')\r\n          .select('*', { count: 'exact', head: true })\r\n\r\n        if (streamCount === 0) {\r\n          toast.info('No livestreams found to delete')\r\n          setLoading(null)\r\n          setConfirmText('')\r\n          return\r\n        }\r\n\r\n        // Delete all streams\r\n        const { error } = await supabase\r\n          .from('streams')\r\n          .delete()\r\n          .neq('id', '00000000-0000-0000-0000-000000000000') // Delete all (this condition is always true)\r\n\r\n        if (error) {\r\n          console.error('Delete streams error:', error)\r\n          toast.error(`Failed to delete streams: ${error.message}`)\r\n          return\r\n        }\r\n\r\n        toast.success(`Successfully deleted ${streamCount} livestream${streamCount === 1 ? '' : 's'}!`)\r\n      } catch (err: any) {\r\n        console.error('Error deleting livestreams:', err)\r\n        toast.error(err.message || 'Failed to delete livestreams')\r\n      } finally {\r\n        setLoading(null)\r\n        setConfirmText('')\r\n      }\r\n      return\r\n    }\r\n\r\n    // Handle comprehensive app reset\r\n    if (action === 'reset_all_for_launch') {\r\n      try {\r\n        toast.info('Starting comprehensive reset... This may take a moment.')\r\n\r\n        const { data, error } = await supabase.rpc(\"reset_app_for_launch\", {})\r\n\r\n        if (error) {\r\n          console.error('Reset error:', error)\r\n          toast.error(`Failed to reset app: ${error.message}`)\r\n          return\r\n        }\r\n\r\n        if (data?.success) {\r\n          toast.success('App reset for launch completed! All test data cleared.', {\r\n            description: JSON.stringify(data.deleted_counts || {})\r\n          })\r\n        } else {\r\n          toast.error(data?.error || 'Failed to reset app')\r\n        }\r\n      } catch (err: any) {\r\n        console.error('Error resetting app:', err)\r\n        toast.error(err.message || 'Failed to reset app')\r\n      } finally {\r\n        setLoading(null)\r\n        setConfirmText('')\r\n      }\r\n      return\r\n    }\r\n\r\n    // Handle other actions with edge function call\r\n    try {\r\n      const { data: sessionData } = await supabase.auth.getSession()\r\n      const response = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/admin-reset`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${sessionData.session?.access_token || ''}`\r\n        },\r\n        body: JSON.stringify({ action })\r\n      })\r\n\r\n      const result = await response.json()\r\n\r\n      if (!response.ok) {\r\n        throw new Error(result.error || 'Failed to perform action')\r\n      }\r\n\r\n      toast.success(`${actionName} completed`, {\r\n        description: JSON.stringify(result.deleted || result),\r\n      })\r\n    } catch (error: any) {\r\n      console.error(`Error ${actionName}:`, error)\r\n      toast.error(error.message || `Failed to ${actionName.toLowerCase()}`)\r\n    } finally {\r\n      setLoading(null)\r\n      setConfirmText('')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-6\">\r\n      <div className=\"mb-6\">\r\n        <h2 className=\"text-2xl font-bold mb-2\">Reset & Maintenance</h2>\r\n        <p className=\"text-gray-400 text-sm\">\r\n          ‚ö†Ô∏è These actions cannot be undone. Use with extreme caution.\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"mb-4\">\r\n        <label className=\"block text-sm font-semibold mb-2\">\r\n          Type \"RESET\" to enable buttons:\r\n        </label>\r\n        <input\r\n          type=\"text\"\r\n          value={confirmText}\r\n          onChange={(e) => setConfirmText(e.target.value)}\r\n          className=\"w-full px-4 py-2 bg-[#0A0814] border border-[#2C2C2C] rounded-lg focus:outline-none focus:border-red-500\"\r\n          placeholder=\"RESET\"\r\n        />\r\n      </div>\r\n\r\n      <div className=\"space-y-4\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => handleReset('reset_test_data', 'Reset Test Data')}\r\n          disabled={loading !== null || confirmText !== 'RESET'}\r\n          className=\"w-full bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors\"\r\n        >\r\n          {loading === 'reset_test_data' ? (\r\n            <>\r\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n              Resetting...\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Trash2 className=\"w-5 h-5\" />\r\n              Reset Test Data\r\n            </>\r\n          )}\r\n        </button>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={(e) => {\r\n            e.preventDefault()\r\n            e.stopPropagation()\r\n            handleReset('reset_live_streams', 'End All Live Streams')\r\n          }}\r\n          disabled={loading !== null || confirmText !== 'RESET'}\r\n          className=\"w-full bg-orange-600 hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors\"\r\n        >\r\n          {loading === 'reset_live_streams' ? (\r\n            <>\r\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n              Ending streams...\r\n            </>\r\n          ) : (\r\n            <>\r\n              <PowerOff className=\"w-5 h-5\" />\r\n              End All Live Streams\r\n            </>\r\n          )}\r\n        </button>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={(e) => {\r\n            e.preventDefault()\r\n            e.stopPropagation()\r\n            handleReset('delete_all_livestreams', 'Delete All Livestreams')\r\n          }}\r\n          disabled={loading !== null || confirmText !== 'RESET'}\r\n          className=\"w-full bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors\"\r\n        >\r\n          {loading === 'delete_all_livestreams' ? (\r\n            <>\r\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n              Deleting streams...\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Trash2 className=\"w-5 h-5\" />\r\n              Delete All Livestreams\r\n            </>\r\n          )}\r\n        </button>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={(e) => {\r\n            e.preventDefault()\r\n            e.stopPropagation()\r\n            handleReset('reset_troll_coinss', 'Reset Coin Balances')\r\n          }}\r\n          disabled={loading !== null || confirmText !== 'RESET'}\r\n          className=\"w-full bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors\"\r\n        >\r\n          {loading === 'reset_troll_coinss' ? (\r\n            <>\r\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n              Resetting balances...\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Coins className=\"w-5 h-5\" />\r\n              Reset Coin Balances\r\n            </>\r\n          )}\r\n        </button>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={(e) => {\r\n            e.preventDefault()\r\n            e.stopPropagation()\r\n            handleReset('reset_all_for_launch', 'Reset All for Launch')\r\n          }}\r\n          disabled={loading !== null || confirmText !== 'RESET'}\r\n          className=\"w-full bg-red-700 hover:bg-red-800 disabled:opacity-50 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors border-2 border-red-500\"\r\n        >\r\n          {loading === 'reset_all_for_launch' ? (\r\n            <>\r\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n              Resetting all data...\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Trash2 className=\"w-5 h-5\" />\r\n              Reset All for Launch (Transactions, Payouts, Everything)\r\n            </>\r\n          )}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminSupportTicketsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminTrollTownDeeds.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":468,"column":47,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[18295,18344],"text":"\r\n                      No users found matching &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[18295,18344],"text":"\r\n                      No users found matching &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[18295,18344],"text":"\r\n                      No users found matching &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[18295,18344],"text":"\r\n                      No users found matching &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":468,"column":60,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[18356,18377],"text":"&quot;\r\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[18356,18377],"text":"&ldquo;\r\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[18356,18377],"text":"&#34;\r\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[18356,18377],"text":"&rdquo;\r\n                  "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from 'react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { useAuthStore } from '../../lib/store'\r\nimport { toast } from 'sonner'\r\nimport { Link } from 'react-router-dom'\r\nimport { ArrowLeft, Home, Filter, Activity, AlertTriangle, Eye, Gavel, Search, ChevronDown, ChevronUp } from 'lucide-react'\r\nimport ClickableUsername from '../../components/ClickableUsername'\r\n\r\ntype DeedTransferRow = {\r\n  id: string\r\n  property_id: string\r\n  seller_user_id: string\r\n  buyer_user_id: string\r\n  sale_price: number\r\n  deed_fee: number\r\n  seller_net: number\r\n  system_value_at_sale: number | null\r\n  created_at: string\r\n  seller_username?: string\r\n  buyer_username?: string\r\n}\r\n\r\ntype UserDeed = {\r\n  deed_id: string\r\n  property_id: string\r\n}\r\n\r\ntype UserDeedGroup = {\r\n  user_id: string\r\n  username?: string\r\n  deeds: UserDeed[]\r\n}\r\n\r\nconst UserDeedCard = ({ group, onSelectDeed }: { group: UserDeedGroup, onSelectDeed: (deed: UserDeed) => void }) => {\r\n  const [isExpanded, setIsExpanded] = useState(false)\r\n\r\n  return (\r\n    <div className=\"bg-slate-950/60 border border-slate-800 rounded-lg p-3 space-y-2\">\r\n      <div \r\n        className=\"flex items-center justify-between gap-2 cursor-pointer hover:bg-slate-900/50 p-1 rounded transition-colors\"\r\n        onClick={() => setIsExpanded(!isExpanded)}\r\n      >\r\n        <div className=\"font-semibold text-slate-100 text-sm flex items-center gap-2\">\r\n          <span className={group.deeds.length > 5 ? 'text-amber-400' : ''}>\r\n             {group.username || group.user_id.slice(0, 6)}\r\n          </span>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n            <div className=\"text-[11px] text-slate-400\">\r\n            {group.deeds.length} deed{group.deeds.length === 1 ? '' : 's'}\r\n            </div>\r\n            {isExpanded ? <ChevronUp className=\"w-4 h-4 text-slate-500\" /> : <ChevronDown className=\"w-4 h-4 text-slate-500\" />}\r\n        </div>\r\n      </div>\r\n      \r\n      {isExpanded && (\r\n          <div className=\"space-y-1 mt-2 max-h-40 overflow-y-auto custom-scrollbar animate-in slide-in-from-top-2 duration-200\">\r\n            {group.deeds.map(deed => (\r\n              <button\r\n                key={deed.deed_id}\r\n                onClick={(e) => {\r\n                    e.stopPropagation()\r\n                    onSelectDeed(deed)\r\n                }}\r\n                className=\"w-full text-left text-xs px-2 py-1.5 rounded bg-slate-900 hover:bg-slate-800 flex items-center justify-between group transition-colors\"\r\n              >\r\n                <span className=\"text-slate-300\">Home {deed.property_id.slice(0, 6).toUpperCase()}</span>\r\n                <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                    <span className=\"text-cyan-400 text-[10px] font-medium uppercase tracking-wider\">Manage</span>\r\n                    <Eye className=\"w-3 h-3 text-cyan-400\" />\r\n                </div>\r\n              </button>\r\n            ))}\r\n          </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default function AdminTrollTownDeeds() {\r\n  const { profile } = useAuthStore()\r\n  const [rows, setRows] = useState<DeedTransferRow[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [adminPoolBalance, setAdminPoolBalance] = useState<number | null>(null)\r\n  const [userDeedGroups, setUserDeedGroups] = useState<UserDeedGroup[]>([])\r\n  const [userSearch, setUserSearch] = useState('')\r\n  const [filterSeller, setFilterSeller] = useState('')\r\n  const [filterBuyer, setFilterBuyer] = useState('')\r\n  const [filterMinPrice, setFilterMinPrice] = useState('')\r\n  const [filterMaxPrice, setFilterMaxPrice] = useState('')\r\n  const [filterStartDate, setFilterStartDate] = useState('')\r\n  const [filterEndDate, setFilterEndDate] = useState('')\r\n  const [selectedDeed, setSelectedDeed] = useState<UserDeed | null>(null)\r\n  const [foreclosing, setForeclosing] = useState(false)\r\n\r\n  const handleForeclose = async (deedId: string) => {\r\n    if (!confirm('Are you sure you want to FORECLOSE this property? This action cannot be undone.')) return\r\n    \r\n    setForeclosing(true)\r\n    try {\r\n        const { error } = await supabase.rpc('foreclose_property', { p_deed_id: deedId })\r\n        if (error) throw error\r\n        toast.success('Property foreclosed successfully')\r\n        setSelectedDeed(null)\r\n    } catch (err: any) {\r\n        toast.error(err.message)\r\n    } finally {\r\n        setForeclosing(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    const load = async () => {\r\n      setLoading(true)\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('deed_transfers')\r\n          .select('*')\r\n          .order('created_at', { ascending: false })\r\n          .limit(500)\r\n\r\n        if (error) {\r\n          if (error.code === '42P01' || error.code === 'PGRST116' || error.code === 'PGRST106') {\r\n            setRows([])\r\n          } else {\r\n            throw error\r\n          }\r\n        } else {\r\n          const transfers = (data || []) as any[]\r\n\r\n          // Use the admin oversight view if available, otherwise fall back to deeds table\r\n          let deedRows: any[] = []\r\n          const { data: oversightRows, error: oversightError } = await supabase\r\n            .from('admin_deed_oversight')\r\n            .select('*')\r\n          \r\n          if (!oversightError && oversightRows) {\r\n             deedRows = oversightRows.map(r => ({\r\n                 id: r.deed_id,\r\n                 property_id: r.property_id,\r\n                 current_owner_user_id: r.current_owner_user_id,\r\n                 property_name: r.property_name,\r\n                 owner_username: r.owner_username\r\n             }))\r\n          } else {\r\n             const { data: rawDeeds, error: deedsError } = await supabase\r\n                .from('deeds')\r\n                .select('id, property_id, current_owner_user_id, property_name, owner_username')\r\n             \r\n             if (!deedsError && rawDeeds) {\r\n                 deedRows = rawDeeds\r\n             }\r\n          }\r\n\r\n          const userIds = new Set<string>()\r\n          transfers.forEach(row => {\r\n            if (row.seller_user_id) userIds.add(row.seller_user_id)\r\n            if (row.buyer_user_id) userIds.add(row.buyer_user_id)\r\n          })\r\n\r\n          deedRows.forEach(row => {\r\n              if (row.current_owner_user_id) {\r\n                userIds.add(row.current_owner_user_id as string)\r\n              }\r\n          })\r\n\r\n          const usernames = new Map<string, string>()\r\n          // Pre-fill usernames from deedRows if available\r\n          deedRows.forEach(row => {\r\n              if (row.current_owner_user_id && row.owner_username) {\r\n                  usernames.set(row.current_owner_user_id, row.owner_username)\r\n              }\r\n          })\r\n\r\n          // Fetch remaining usernames\r\n          const missingUserIds = Array.from(userIds).filter(id => !usernames.has(id))\r\n          if (missingUserIds.length > 0) {\r\n            const { data: profiles } = await supabase\r\n              .from('user_profiles')\r\n              .select('id, username')\r\n              .in('id', missingUserIds);\r\n            (profiles || []).forEach((p: any) => {\r\n                usernames.set(p.id, p.username)\r\n            })\r\n          }\r\n\r\n          const mapped: DeedTransferRow[] = transfers.map(row => ({\r\n            id: row.id,\r\n            property_id: row.property_id,\r\n            seller_user_id: row.seller_user_id,\r\n            buyer_user_id: row.buyer_user_id,\r\n            sale_price: Number(row.sale_price || 0),\r\n            deed_fee: Number(row.deed_fee || 0),\r\n            seller_net: Number(row.seller_net || 0),\r\n            system_value_at_sale: row.system_value_at_sale\r\n              ? Number(row.system_value_at_sale)\r\n              : null,\r\n            created_at: row.created_at,\r\n            seller_username: usernames.get(row.seller_user_id) || undefined,\r\n            buyer_username: usernames.get(row.buyer_user_id) || undefined\r\n          }))\r\n          setRows(mapped)\r\n\r\n          if (deedRows.length > 0) {\r\n            const groups = new Map<string, UserDeedGroup>()\r\n\r\n            deedRows.forEach(row => {\r\n              const ownerId = row.current_owner_user_id as string | null\r\n              if (!ownerId) return\r\n\r\n              const existing = groups.get(ownerId)\r\n              const deed: UserDeed = {\r\n                deed_id: row.id as string,\r\n                property_id: row.property_id as string\r\n              }\r\n\r\n              if (existing) {\r\n                existing.deeds.push(deed)\r\n              } else {\r\n                groups.set(ownerId, {\r\n                  user_id: ownerId,\r\n                  username: usernames.get(ownerId),\r\n                  deeds: [deed]\r\n                })\r\n              }\r\n            })\r\n\r\n            const sortedGroups = Array.from(groups.values()).sort((a, b) => {\r\n              const an = (a.username || '').toLowerCase()\r\n              const bn = (b.username || '').toLowerCase()\r\n              if (an && bn) return an.localeCompare(bn)\r\n              if (an) return -1\r\n              if (bn) return 1\r\n              return a.user_id.localeCompare(b.user_id)\r\n            })\r\n\r\n            setUserDeedGroups(sortedGroups)\r\n          } else {\r\n            setUserDeedGroups([])\r\n          }\r\n        }\r\n\r\n        const { data: poolRow } = await supabase\r\n          .from('admin_pool')\r\n          .select('trollcoins_balance')\r\n          .maybeSingle()\r\n        if (poolRow) {\r\n          setAdminPoolBalance(Number(poolRow.trollcoins_balance || 0))\r\n        } else {\r\n          setAdminPoolBalance(null)\r\n        }\r\n      } catch (error: any) {\r\n        toast.error(error?.message || 'Failed to load Troll Town deeds')\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n\r\n    load()\r\n\r\n    // Real-time subscriptions\r\n    const transferSub = supabase\r\n      .channel('admin-deed-transfers')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'deed_transfers' },\r\n        () => {\r\n            console.log('Deed transfers updated, reloading...')\r\n            load()\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    const deedsSub = supabase\r\n      .channel('admin-deeds')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'deeds' },\r\n        () => {\r\n            console.log('Deeds updated, reloading...')\r\n            load()\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n        transferSub.unsubscribe()\r\n        deedsSub.unsubscribe()\r\n    }\r\n  }, [])\r\n\r\n  const filteredUserGroups = useMemo(() => {\r\n    if (!userSearch) return userDeedGroups\r\n    const q = userSearch.toLowerCase()\r\n    return userDeedGroups.filter(g => \r\n        (g.username || '').toLowerCase().includes(q) || \r\n        g.user_id.toLowerCase().includes(q) ||\r\n        g.deeds.some(d => d.property_id.toLowerCase().includes(q))\r\n    )\r\n  }, [userDeedGroups, userSearch])\r\n\r\n  const filteredRows = useMemo(() => {\r\n    return rows.filter(row => {\r\n      if (filterSeller) {\r\n        const match = row.seller_username || ''\r\n        if (!match.toLowerCase().includes(filterSeller.toLowerCase())) return false\r\n      }\r\n      if (filterBuyer) {\r\n        const match = row.buyer_username || ''\r\n        if (!match.toLowerCase().includes(filterBuyer.toLowerCase())) return false\r\n      }\r\n      if (filterMinPrice) {\r\n        const min = Number(filterMinPrice)\r\n        if (!Number.isNaN(min) && row.sale_price < min) return false\r\n      }\r\n      if (filterMaxPrice) {\r\n        const max = Number(filterMaxPrice)\r\n        if (!Number.isNaN(max) && row.sale_price > max) return false\r\n      }\r\n      if (filterStartDate) {\r\n        const start = new Date(filterStartDate).getTime()\r\n        if (new Date(row.created_at).getTime() < start) return false\r\n      }\r\n      if (filterEndDate) {\r\n        const end = new Date(filterEndDate).getTime()\r\n        if (new Date(row.created_at).getTime() > end) return false\r\n      }\r\n      return true\r\n    })\r\n  }, [rows, filterSeller, filterBuyer, filterMinPrice, filterMaxPrice, filterStartDate, filterEndDate])\r\n\r\n  const summary = useMemo(() => {\r\n    if (filteredRows.length === 0) {\r\n      return {\r\n        totalSales: 0,\r\n        totalFees: 0,\r\n        totalNetToSellers: 0,\r\n        avgFeePercent: 0\r\n      }\r\n    }\r\n    const totals = filteredRows.reduce(\r\n      (acc, row) => {\r\n        acc.totalSales += row.sale_price\r\n        acc.totalFees += row.deed_fee\r\n        acc.totalNetToSellers += row.seller_net\r\n        return acc\r\n      },\r\n      { totalSales: 0, totalFees: 0, totalNetToSellers: 0 }\r\n    )\r\n    const avgFeePercent =\r\n      totals.totalSales > 0 ? (totals.totalFees / totals.totalSales) * 100 : 0\r\n    return {\r\n      totalSales: totals.totalSales,\r\n      totalFees: totals.totalFees,\r\n      totalNetToSellers: totals.totalNetToSellers,\r\n      avgFeePercent\r\n    }\r\n  }, [filteredRows])\r\n\r\n  const hasAnomalies = useMemo(() => {\r\n    return filteredRows.some(row => {\r\n      if (!row.sale_price) return false\r\n      const pct = (row.deed_fee / row.sale_price) * 100\r\n      return pct < 8 || pct > 12\r\n    })\r\n  }, [filteredRows])\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-950 text-white\">\r\n      <div className=\"max-w-7xl mx-auto px-4 py-6 space-y-6\">\r\n        <div className=\"flex items-center justify-between gap-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Link\r\n              to=\"/admin\"\r\n              className=\"inline-flex items-center gap-2 text-slate-400 hover:text-white text-sm\"\r\n            >\r\n              <ArrowLeft className=\"w-4 h-4\" />\r\n              Back to Admin Dashboard\r\n            </Link>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n          <div>\r\n            <h1 className=\"text-2xl md:text-3xl font-bold flex items-center gap-2\">\r\n              <Home className=\"w-7 h-7 text-emerald-400\" />\r\n              Troll Town Deed Oversight\r\n            </h1>\r\n            <p className=\"text-sm text-slate-400 mt-1\">\r\n              System-wide view of property transfers and deed fees. Designed for abuse monitoring.\r\n            </p>\r\n            {profile?.username && (\r\n              <p className=\"text-xs text-slate-500 mt-1\">\r\n                Signed in as {profile.username}\r\n              </p>\r\n            )}\r\n          </div>\r\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-3 text-xs\">\r\n            <div className=\"bg-slate-900/80 border border-slate-700 rounded-xl p-3\">\r\n              <p className=\"text-slate-400\">Total Sale Volume</p>\r\n              <p className=\"text-lg font-semibold text-emerald-300\">\r\n                {summary.totalSales.toLocaleString()} TrollCoins\r\n              </p>\r\n            </div>\r\n            <div className=\"bg-slate-900/80 border border-slate-700 rounded-xl p-3\">\r\n              <p className=\"text-slate-400\">Total Deed Fees</p>\r\n              <p className=\"text-lg font-semibold text-yellow-300\">\r\n                {summary.totalFees.toLocaleString()} TrollCoins\r\n              </p>\r\n            </div>\r\n            <div className=\"bg-slate-900/80 border border-slate-700 rounded-xl p-3\">\r\n              <p className=\"text-slate-400\">Admin Pool Balance</p>\r\n              <p className=\"text-lg font-semibold text-emerald-300\">\r\n                {adminPoolBalance === null\r\n                  ? '‚Äî'\r\n                  : `${adminPoolBalance.toLocaleString()} TrollCoins`}\r\n              </p>\r\n            </div>\r\n            <div className=\"bg-slate-900/80 border border-slate-700 rounded-xl p-3 col-span-2 sm:col-span-3 flex items-center justify-between gap-3\">\r\n              <div className=\"flex flex-col gap-1\">\r\n                <div className=\"flex items-center gap-2 text-slate-400\">\r\n                  <Activity className=\"w-4 h-4 text-emerald-400\" />\r\n                  <span>Average deed fee rate (filtered)</span>\r\n                </div>\r\n                <div className=\"text-xs text-slate-500\">\r\n                  Expected rate is 10%. Rows outside 8‚Äì12% are flagged.\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-3\">\r\n                {hasAnomalies && (\r\n                  <div className=\"flex items-center gap-1 px-2 py-1 rounded-full bg-amber-500/10 border border-amber-400/40 text-amber-200 text-[11px] font-semibold\">\r\n                    <AlertTriangle className=\"w-3 h-3\" />\r\n                    <span>Anomalies</span>\r\n                  </div>\r\n                )}\r\n                <div className=\"text-lg font-semibold text-emerald-300\">\r\n                  {summary.avgFeePercent.toFixed(1)}%\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {(userDeedGroups.length > 0 || userSearch) && (\r\n          <div className=\"bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-3\">\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n              <div className=\"flex flex-col\">\r\n                  <span className=\"text-sm text-slate-300\">Current Deeds by User</span>\r\n                  <span className=\"text-xs text-slate-500\">\r\n                    Snapshot of deed ownership across Troll Town\r\n                  </span>\r\n              </div>\r\n              <div className=\"relative w-full md:w-64\">\r\n                  <input \r\n                      type=\"text\" \r\n                      value={userSearch}\r\n                      onChange={(e) => setUserSearch(e.target.value)}\r\n                      placeholder=\"Search user or property...\" \r\n                      className=\"w-full pl-9 pr-3 py-2 bg-slate-950 border border-slate-700 rounded-lg text-xs focus:border-emerald-500 outline-none transition-colors\"\r\n                  />\r\n                  <Search className=\"w-3.5 h-3.5 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2\" />\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-xs\">\r\n              {filteredUserGroups.length === 0 ? (\r\n                  <div className=\"col-span-full py-8 text-center text-slate-500\">\r\n                      No users found matching \"{userSearch}\"\r\n                  </div>\r\n              ) : (\r\n                  filteredUserGroups.map(group => (\r\n                    <UserDeedCard \r\n                        key={group.user_id} \r\n                        group={group} \r\n                        onSelectDeed={setSelectedDeed} \r\n                    />\r\n                  ))\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Deed Management Modal */}\r\n        {selectedDeed && (\r\n            <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm\">\r\n                <div className=\"bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-md w-full shadow-2xl space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <h3 className=\"text-lg font-bold text-white flex items-center gap-2\">\r\n                            <Home className=\"w-5 h-5 text-emerald-400\" />\r\n                            Manage Deed\r\n                        </h3>\r\n                        <button \r\n                            onClick={() => setSelectedDeed(null)}\r\n                            className=\"text-slate-400 hover:text-white\"\r\n                        >\r\n                            ‚úï\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"bg-slate-950/50 rounded-xl p-4 space-y-2 border border-slate-800\">\r\n                        <div className=\"flex justify-between text-sm\">\r\n                            <span className=\"text-slate-400\">Deed ID</span>\r\n                            <span className=\"font-mono text-slate-200\">{selectedDeed.deed_id.slice(0, 8)}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between text-sm\">\r\n                            <span className=\"text-slate-400\">Property ID</span>\r\n                            <span className=\"font-mono text-slate-200\">{selectedDeed.property_id.slice(0, 8)}</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"pt-2 space-y-3\">\r\n                        <button \r\n                            disabled={foreclosing}\r\n                            onClick={() => handleForeclose(selectedDeed.deed_id)}\r\n                            className=\"w-full py-2.5 rounded-xl bg-red-500/10 hover:bg-red-500/20 border border-red-500/50 text-red-200 font-semibold flex items-center justify-center gap-2 transition-colors\"\r\n                        >\r\n                            {foreclosing ? (\r\n                                <span className=\"animate-spin\">‚è≥</span>\r\n                            ) : (\r\n                                <Gavel className=\"w-4 h-4\" />\r\n                            )}\r\n                            Foreclose Property\r\n                        </button>\r\n                        <p className=\"text-[10px] text-slate-500 text-center\">\r\n                            Foreclosing will immediately revoke ownership and return the property to the bank.\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        )}\r\n\r\n        <div className=\"bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4\">\r\n          <div className=\"flex items-center gap-2 text-sm text-slate-300\">\r\n            <Filter className=\"w-4 h-4 text-emerald-400\" />\r\n            <span>Filter transfers</span>\r\n          </div>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-5 gap-3 text-xs\">\r\n            <input\r\n              value={filterSeller}\r\n              onChange={e => setFilterSeller(e.target.value)}\r\n              placeholder=\"Filter by seller username\"\r\n              className=\"px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 outline-none focus:border-emerald-500\"\r\n            />\r\n            <input\r\n              value={filterBuyer}\r\n              onChange={e => setFilterBuyer(e.target.value)}\r\n              placeholder=\"Filter by buyer username\"\r\n              className=\"px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 outline-none focus:border-emerald-500\"\r\n            />\r\n            <input\r\n              value={filterMinPrice}\r\n              onChange={e => setFilterMinPrice(e.target.value)}\r\n              placeholder=\"Min sale price\"\r\n              className=\"px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 outline-none focus:border-emerald-500\"\r\n            />\r\n            <input\r\n              value={filterMaxPrice}\r\n              onChange={e => setFilterMaxPrice(e.target.value)}\r\n              placeholder=\"Max sale price\"\r\n              className=\"px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 outline-none focus:border-emerald-500\"\r\n            />\r\n            <div className=\"flex gap-2\">\r\n              <input\r\n                type=\"date\"\r\n                value={filterStartDate}\r\n                onChange={e => setFilterStartDate(e.target.value)}\r\n                className=\"flex-1 px-2 py-2 rounded-lg bg-slate-950 border border-slate-700 outline-none focus:border-emerald-500\"\r\n              />\r\n              <input\r\n                type=\"date\"\r\n                value={filterEndDate}\r\n                onChange={e => setFilterEndDate(e.target.value)}\r\n                className=\"flex-1 px-2 py-2 rounded-lg bg-slate-950 border border-slate-700 outline-none focus:border-emerald-500\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"border border-slate-800 rounded-xl overflow-hidden\">\r\n            <div className=\"max-h-[520px] overflow-y-auto\">\r\n              <table className=\"min-w-full text-xs\">\r\n                <thead className=\"bg-slate-900/90 sticky top-0 z-10\">\r\n                  <tr className=\"text-slate-300\">\r\n                    <th className=\"px-3 py-2 text-left font-semibold\">Date/Time</th>\r\n                    <th className=\"px-3 py-2 text-left font-semibold\">Property</th>\r\n                    <th className=\"px-3 py-2 text-left font-semibold\">Seller</th>\r\n                    <th className=\"px-3 py-2 text-left font-semibold\">Buyer</th>\r\n                    <th className=\"px-3 py-2 text-right font-semibold\">Sale Price</th>\r\n                    <th className=\"px-3 py-2 text-right font-semibold\">Deed Fee</th>\r\n                    <th className=\"px-3 py-2 text-right font-semibold\">Fee %</th>\r\n                    <th className=\"px-3 py-2 text-right font-semibold\">Seller Net</th>\r\n                    <th className=\"px-3 py-2 text-right font-semibold\">System Value</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {loading ? (\r\n                    <tr>\r\n                      <td\r\n                        colSpan={8}\r\n                        className=\"px-3 py-6 text-center text-slate-500\"\r\n                      >\r\n                        Loading deeds...\r\n                      </td>\r\n                    </tr>\r\n                  ) : filteredRows.length === 0 ? (\r\n                    <tr>\r\n                      <td\r\n                        colSpan={8}\r\n                        className=\"px-3 py-6 text-center text-slate-500\"\r\n                      >\r\n                        No deed transfers found for the selected filters.\r\n                      </td>\r\n                    </tr>\r\n                  ) : (\r\n                    filteredRows.map(row => (\r\n                      <tr\r\n                        key={row.id}\r\n                        className=\"border-t border-slate-800/80 hover:bg-slate-900/80\"\r\n                      >\r\n                        <td className=\"px-3 py-2 text-slate-300\">\r\n                          {new Date(row.created_at).toLocaleString()}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-slate-300\">\r\n                          Home {row.property_id.slice(0, 6).toUpperCase()}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-slate-300\">\r\n                          {row.seller_username ? (\r\n                            <ClickableUsername\r\n                              username={row.seller_username}\r\n                              userId={row.seller_user_id}\r\n                              className=\"text-emerald-200\"\r\n                              prefix=\"\"\r\n                            />\r\n                          ) : (\r\n                            row.seller_user_id.slice(0, 6)\r\n                          )}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-slate-300\">\r\n                          {row.buyer_username ? (\r\n                            <ClickableUsername\r\n                              username={row.buyer_username}\r\n                              userId={row.buyer_user_id}\r\n                              className=\"text-emerald-200\"\r\n                              prefix=\"\"\r\n                            />\r\n                          ) : (\r\n                            row.buyer_user_id.slice(0, 6)\r\n                          )}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-right text-emerald-300\">\r\n                          {row.sale_price.toLocaleString()}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-right text-yellow-300\">\r\n                          {row.deed_fee.toLocaleString()}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-right\">\r\n                          {row.sale_price\r\n                            ? `${((row.deed_fee / row.sale_price) * 100).toFixed(1)}%`\r\n                            : '‚Äî'}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-right text-slate-200\">\r\n                          {row.seller_net.toLocaleString()}\r\n                        </td>\r\n                        <td className=\"px-3 py-2 text-right text-slate-300\">\r\n                          {row.system_value_at_sale\r\n                            ? row.system_value_at_sale.toLocaleString()\r\n                            : '‚Äî'}\r\n                        </td>\r\n                      </tr>\r\n                    ))\r\n                  )}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminVerificationReview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\AdminVerifiedUsers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\Announcements.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBroadcastHistory'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadBroadcastHistory]","fix":{"range":[1977,1979],"text":"[loadBroadcastHistory]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\Applications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\BanManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\BucketsDashboard.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":549,"column":63,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as &quot;pending_funds\" until money is available"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as &ldquo;pending_funds\" until money is available"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as &#34;pending_funds\" until money is available"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as &rdquo;pending_funds\" until money is available"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":549,"column":77,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as \"pending_funds&quot; until money is available"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as \"pending_funds&ldquo; until money is available"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as \"pending_funds&#34; until money is available"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[22227,22309],"text":"‚Ä¢ Insufficient funds will mark payouts as \"pending_funds&rdquo; until money is available"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/pages/admin/BucketsDashboard.tsx\r\nimport React, { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { useAuthStore } from '../../lib/store';\r\nimport { toast } from 'sonner';\r\nimport { \r\n  DollarSign, \r\n  Coins, \r\n  Shield, \r\n  Lock, \r\n  CheckCircle, \r\n  AlertTriangle,\r\n  RefreshCw,\r\n  ArrowUpRight,\r\n  FileText,\r\n  Clock\r\n} from 'lucide-react';\r\n\r\ninterface BucketData {\r\n  bucket_type: string;\r\n  balance_usd: number;\r\n  balance_coins: number;\r\n  total_coins_issued: number;\r\n  total_coins_earned: number;\r\n  estimated_liability_usd: number;\r\n  last_updated_at: string;\r\n  description: string;\r\n}\r\n\r\ninterface LedgerTransaction {\r\n  id: string;\r\n  transaction_type: string;\r\n  source_type: string;\r\n  source_id: string;\r\n  usd_amount: number;\r\n  coin_amount: number;\r\n  description: string;\r\n  created_at: string;\r\n  user_username?: string;\r\n}\r\n\r\ninterface PayoutSummary {\r\n  pending_count: number;\r\n  pending_amount: number;\r\n  pending_funds_count: number;\r\n  pending_funds_amount: number;\r\n  approved_count: number;\r\n  approved_amount: number;\r\n}\r\n\r\nexport default function BucketsDashboard() {\r\n  const { user } = useAuthStore();\r\n  const [isAuthorized, setIsAuthorized] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSecretary, setIsSecretary] = useState(false);\r\n  \r\n  const [buckets, setBuckets] = useState<BucketData[]>([]);\r\n  const [transactions, setTransactions] = useState<LedgerTransaction[]>([]);\r\n  const [payoutSummary, setPayoutSummary] = useState<PayoutSummary | null>(null);\r\n  const [isRefreshing, setIsRefreshing] = useState(false);\r\n\r\n  const checkAccess = useCallback(async () => {\r\n    if (!user) {\r\n      setIsAuthorized(false);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data: profileData, error } = await supabase\r\n        .from('user_profiles')\r\n        .select('role, is_admin')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error checking access:', error);\r\n        setIsAuthorized(false);\r\n        return;\r\n      }\r\n\r\n      const isAdmin = profileData?.role === 'admin' || profileData?.is_admin === true;\r\n      const isSecretaryRole = profileData?.role === 'secretary';\r\n\r\n      setIsAuthorized(isAdmin);\r\n      setIsSecretary(isSecretaryRole);\r\n    } catch (err) {\r\n      console.error('Access check error:', err);\r\n      setIsAuthorized(false);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  const loadBuckets = useCallback(async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .rpc('get_buckets_summary_for_user');\r\n\r\n      if (error) {\r\n        console.error('Error loading buckets:', error);\r\n        toast.error('Failed to load bucket data');\r\n        return;\r\n      }\r\n\r\n      if (data && data.length > 0) {\r\n        const summary = data[0];\r\n        // Convert to bucket format for the UI\r\n        const bucketData: BucketData[] = [];\r\n        \r\n        // Admin spendable (only visible if can_view_admin_spendable is true)\r\n        if (summary.can_view_admin_spendable && summary.admin_spendable_usd !== null) {\r\n          bucketData.push({\r\n            bucket_type: 'admin_spendable',\r\n            balance_usd: summary.admin_spendable_usd || 0,\r\n            balance_coins: 0,\r\n            total_coins_issued: 0,\r\n            total_coins_earned: 0,\r\n            estimated_liability_usd: 0,\r\n            last_updated_at: new Date().toISOString(),\r\n            description: 'üí∞ Admin Spendable - Money you can personally spend'\r\n          });\r\n        }\r\n        \r\n        bucketData.push({\r\n          bucket_type: 'broadcaster_liability',\r\n          balance_usd: summary.broadcaster_liability_usd || 0,\r\n          balance_coins: 0,\r\n          total_coins_issued: 0,\r\n          total_coins_earned: summary.total_coins_earned || 0,\r\n          estimated_liability_usd: 0,\r\n          last_updated_at: new Date().toISOString(),\r\n          description: 'üìä Broadcaster Liability - Money owed to broadcasters (DO NOT SPEND)'\r\n        });\r\n        \r\n        if (!isSecretary) {\r\n          bucketData.push({\r\n            bucket_type: 'admin_issued_coins_liability',\r\n            balance_usd: summary.admin_issued_liability_usd || 0,\r\n            balance_coins: summary.admin_issued_coins_coins || 0,\r\n            total_coins_issued: summary.total_coins_issued || 0,\r\n            total_coins_earned: 0,\r\n            estimated_liability_usd: summary.admin_issued_liability_usd || 0,\r\n            last_updated_at: new Date().toISOString(),\r\n            description: 'ü™ô Admin Issued Coins - Coins granted by admin with payout liability'\r\n          });\r\n        }\r\n        \r\n        bucketData.push({\r\n          bucket_type: 'reserved_payout',\r\n          balance_usd: summary.reserved_payout_usd || 0,\r\n          balance_coins: 0,\r\n          total_coins_issued: 0,\r\n          total_coins_earned: 0,\r\n          estimated_liability_usd: 0,\r\n          last_updated_at: new Date().toISOString(),\r\n          description: 'üîí Reserved Payout - Funds reserved for pending payouts'\r\n        });\r\n        \r\n        bucketData.push({\r\n          bucket_type: 'paid_out',\r\n          balance_usd: summary.paid_out_usd || 0,\r\n          balance_coins: 0,\r\n          total_coins_issued: 0,\r\n          total_coins_earned: 0,\r\n          estimated_liability_usd: 0,\r\n          last_updated_at: new Date().toISOString(),\r\n          description: '‚úÖ Paid Out - Total funds paid out to broadcasters'\r\n        });\r\n        \r\n        setBuckets(bucketData);\r\n      }\r\n    } catch (err) {\r\n      console.error('Buckets load error:', err);\r\n    }\r\n  }, [isSecretary]);\r\n\r\n  const loadTransactions = useCallback(async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('ledger_recent')\r\n        .select('*')\r\n        .limit(50);\r\n\r\n      if (error) {\r\n        console.error('Error loading transactions:', error);\r\n        return;\r\n      }\r\n\r\n      setTransactions(data || []);\r\n    } catch (err) {\r\n      console.error('Transactions load error:', err);\r\n    }\r\n  }, []);\r\n\r\n  const loadPayoutSummary = useCallback(async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .rpc('get_pending_payouts_summary');\r\n\r\n      if (error) {\r\n        console.error('Error loading payout summary:', error);\r\n        return;\r\n      }\r\n\r\n      setPayoutSummary(data as PayoutSummary);\r\n    } catch (err) {\r\n      console.error('Payout summary load error:', err);\r\n    }\r\n  }, []);\r\n\r\n  const loadAllData = useCallback(async () => {\r\n    setIsRefreshing(true);\r\n    await Promise.all([\r\n      loadBuckets(),\r\n      loadTransactions(),\r\n      loadPayoutSummary()\r\n    ]);\r\n    setIsRefreshing(false);\r\n  }, [loadBuckets, loadTransactions, loadPayoutSummary]);\r\n\r\n  useEffect(() => {\r\n    checkAccess();\r\n  }, [checkAccess]);\r\n\r\n  useEffect(() => {\r\n    if (isAuthorized) {\r\n      loadAllData();\r\n      \r\n      // Auto-refresh every 30 seconds\r\n      const interval = setInterval(loadAllData, 30000);\r\n      return () => clearInterval(interval);\r\n    }\r\n  }, [isAuthorized, loadAllData]);\r\n\r\n  // Helper functions\r\n  const getAdminSpendable = () => {\r\n    const bucket = buckets.find(b => b.bucket_type === 'admin_spendable');\r\n    return bucket?.balance_usd || 0;\r\n  };\r\n\r\n  const getBroadcasterLiability = () => {\r\n    const bucket = buckets.find(b => b.bucket_type === 'broadcaster_liability');\r\n    return bucket?.balance_usd || 0;\r\n  };\r\n\r\n  const getReservedPayout = () => {\r\n    const bucket = buckets.find(b => b.bucket_type === 'reserved_payout');\r\n    return bucket?.balance_usd || 0;\r\n  };\r\n\r\n  const getPaidOut = () => {\r\n    const bucket = buckets.find(b => b.bucket_type === 'paid_out');\r\n    return bucket?.balance_usd || 0;\r\n  };\r\n\r\n  const getAvailableForPayout = () => {\r\n    return getBroadcasterLiability() - getReservedPayout();\r\n  };\r\n\r\n  const getAdminIssuedCoins = () => {\r\n    const bucket = buckets.find(b => b.bucket_type === 'admin_issued_coins_liability');\r\n    return bucket?.balance_coins || 0;\r\n  };\r\n\r\n  const getAdminIssuedLiability = () => {\r\n    const bucket = buckets.find(b => b.bucket_type === 'admin_issued_coins_liability');\r\n    return bucket?.estimated_liability_usd || 0;\r\n  };\r\n\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'USD',\r\n      minimumFractionDigits: 2,\r\n      maximumFractionDigits: 2\r\n    }).format(amount);\r\n  };\r\n\r\n  const formatCoins = (amount: number) => {\r\n    return new Intl.NumberFormat('en-US').format(amount);\r\n  };\r\n\r\n  const getTransactionTypeColor = (type: string) => {\r\n    switch (type) {\r\n      case 'paypal_purchase': return 'text-green-400';\r\n      case 'coin_grant_admin': return 'text-yellow-400';\r\n      case 'coin_grant_broadcast': return 'text-blue-400';\r\n      case 'payout_reserved': return 'text-orange-400';\r\n      case 'payout_completed': return 'text-purple-400';\r\n      case 'payout_released': return 'text-gray-400';\r\n      default: return 'text-white';\r\n    }\r\n  };\r\n\r\n  const getTransactionTypeIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'paypal_purchase': return <ArrowUpRight className=\"w-4 h-4\" />;\r\n      case 'payout_completed': return <CheckCircle className=\"w-4 h-4\" />;\r\n      case 'payout_reserved': return <Lock className=\"w-4 h-4\" />;\r\n      case 'coin_grant_admin': return <Coins className=\"w-4 h-4\" />;\r\n      default: return <FileText className=\"w-4 h-4\" />;\r\n    }\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white flex items-center justify-center\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!isAuthorized) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] text-white flex items-center justify-center\">\r\n        <div className=\"px-6 py-3 rounded bg-red-950 border border-red-500 text-center\">\r\n          <p className=\"font-bold mb-1\">Access Restricted</p>\r\n          <p className=\"text-sm text-red-200\">\r\n            This dashboard is limited to administrators only.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-7xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-2xl font-bold text-white\">üí∞ Financial Buckets Dashboard</h1>\r\n            <p className=\"text-gray-400 text-sm\">\r\n              Real-time tracking of platform funds and payout reserves\r\n            </p>\r\n          </div>\r\n          <button\r\n            onClick={loadAllData}\r\n            disabled={isRefreshing}\r\n            className=\"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg transition disabled:opacity-50\"\r\n          >\r\n            <RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} />\r\n            Refresh\r\n          </button>\r\n        </div>\r\n\r\n        {/* Main Balance Card - Available to Spend */}\r\n        <div className=\"bg-gradient-to-r from-green-900/50 to-emerald-900/50 border border-green-500/30 rounded-xl p-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-green-400 text-sm font-medium uppercase tracking-wider\">Available to Spend</p>\r\n              <p className=\"text-4xl font-bold text-white mt-1\">{formatCurrency(getAdminSpendable())}</p>\r\n              <p className=\"text-gray-400 text-sm mt-2\">\r\n                üí° This is your personal spending balance from PayPal purchases\r\n              </p>\r\n            </div>\r\n            <div className=\"w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center\">\r\n              <DollarSign className=\"w-8 h-8 text-green-400\" />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Bucket Cards Grid */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n          {/* Admin Spendable */}\r\n          <div className=\"bg-[#1A1A1A] border border-green-500/30 rounded-xl p-5\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <div className=\"w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center\">\r\n                <DollarSign className=\"w-5 h-5 text-green-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-semibold text-white\">Admin Spendable</h3>\r\n                <p className=\"text-xs text-gray-400\">Your personal funds</p>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-green-400\">{formatCurrency(getAdminSpendable())}</p>\r\n            <p className=\"text-xs text-gray-500 mt-1\">From $1 per PayPal transaction</p>\r\n          </div>\r\n\r\n          {/* Broadcaster Liability */}\r\n          <div className=\"bg-[#1A1A1A] border border-yellow-500/30 rounded-xl p-5\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <div className=\"w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center\">\r\n                <Shield className=\"w-5 h-5 text-yellow-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-semibold text-white\">Broadcaster Liability</h3>\r\n                <p className=\"text-xs text-gray-400\">DO NOT SPEND</p>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-yellow-400\">{formatCurrency(getBroadcasterLiability())}</p>\r\n            <p className=\"text-xs text-gray-500 mt-1\">Money owed to broadcasters</p>\r\n          </div>\r\n\r\n          {/* Reserved Payout */}\r\n          <div className=\"bg-[#1A1A1A] border border-orange-500/30 rounded-xl p-5\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <div className=\"w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center\">\r\n                <Lock className=\"w-5 h-5 text-orange-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-semibold text-white\">Reserved Payout</h3>\r\n                <p className=\"text-xs text-gray-400\">Pending payouts</p>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-orange-400\">{formatCurrency(getReservedPayout())}</p>\r\n            <p className=\"text-xs text-gray-500 mt-1\">Reserved for approved payouts</p>\r\n          </div>\r\n\r\n          {/* Available for Payout */}\r\n          <div className=\"bg-[#1A1A1A] border border-blue-500/30 rounded-xl p-5\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <div className=\"w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center\">\r\n                <ArrowUpRight className=\"w-5 h-5 text-blue-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-semibold text-white\">Available for Payout</h3>\r\n                <p className=\"text-xs text-gray-400\">Can be paid out</p>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-blue-400\">{formatCurrency(getAvailableForPayout())}</p>\r\n            <p className=\"text-xs text-gray-500 mt-1\">Liability - Reserved</p>\r\n          </div>\r\n\r\n          {/* Paid Out */}\r\n          <div className=\"bg-[#1A1A1A] border border-purple-500/30 rounded-xl p-5\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <div className=\"w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center\">\r\n                <CheckCircle className=\"w-5 h-5 text-purple-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-semibold text-white\">Paid Out</h3>\r\n                <p className=\"text-xs text-gray-400\">Total completed payouts</p>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-2xl font-bold text-purple-400\">{formatCurrency(getPaidOut())}</p>\r\n            <p className=\"text-xs text-gray-500 mt-1\">Lifetime payout total</p>\r\n          </div>\r\n\r\n          {/* Admin Issued Coins */}\r\n          {!isSecretary && (\r\n            <div className=\"bg-[#1A1A1A] border border-yellow-500/30 rounded-xl p-5\">\r\n              <div className=\"flex items-center gap-3 mb-4\">\r\n                <div className=\"w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center\">\r\n                  <Coins className=\"w-5 h-5 text-yellow-400\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"font-semibold text-white\">Admin Issued Coins</h3>\r\n                  <p className=\"text-xs text-gray-400\">System-granted coins</p>\r\n                </div>\r\n              </div>\r\n              <p className=\"text-2xl font-bold text-yellow-400\">{formatCoins(getAdminIssuedCoins())}</p>\r\n              <p className=\"text-xs text-gray-500 mt-1\">‚âà {formatCurrency(getAdminIssuedLiability())} liability</p>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Payout Safeguard Status */}\r\n        {payoutSummary && (\r\n          <div className=\"bg-[#1A1A1A] border border-[#2C2C2C] rounded-xl p-5\">\r\n            <h3 className=\"font-semibold text-white mb-4\">üõ°Ô∏è Payout Safeguard Status</h3>\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n              <div className=\"bg-[#0A0814] rounded-lg p-3\">\r\n                <p className=\"text-gray-400 text-xs\">Pending</p>\r\n                <p className=\"text-xl font-bold text-white\">{payoutSummary.pending_count}</p>\r\n                <p className=\"text-xs text-gray-500\">{formatCurrency(payoutSummary.pending_amount)}</p>\r\n              </div>\r\n              <div className=\"bg-[#0A0814] rounded-lg p-3\">\r\n                <p className=\"text-orange-400 text-xs\">Pending Funds ‚ö†Ô∏è</p>\r\n                <p className=\"text-xl font-bold text-orange-400\">{payoutSummary.pending_funds_count}</p>\r\n                <p className=\"text-xs text-gray-500\">{formatCurrency(payoutSummary.pending_funds_amount)}</p>\r\n              </div>\r\n              <div className=\"bg-[#0A0814] rounded-lg p-3\">\r\n                <p className=\"text-green-400 text-xs\">Approved</p>\r\n                <p className=\"text-xl font-bold text-green-400\">{payoutSummary.approved_count}</p>\r\n                <p className=\"text-xs text-gray-500\">{formatCurrency(payoutSummary.approved_amount)}</p>\r\n              </div>\r\n              <div className=\"bg-[#0A0814] rounded-lg p-3\">\r\n                <p className=\"text-blue-400 text-xs\">Total Reserved</p>\r\n                <p className=\"text-xl font-bold text-blue-400\">{formatCurrency(getReservedPayout())}</p>\r\n                <p className=\"text-xs text-gray-500\">For approved payouts</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Ledger Transactions Table */}\r\n        <div className=\"bg-[#1A1A1A] border border-[#2C2C2C] rounded-xl p-5\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <h3 className=\"font-semibold text-white\">üìã Recent Ledger Transactions</h3>\r\n            <span className=\"text-xs text-gray-400\">Last 50 transactions</span>\r\n          </div>\r\n          \r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full text-sm\">\r\n              <thead>\r\n                <tr className=\"text-left text-gray-400 border-b border-[#2C2C2C]\">\r\n                  <th className=\"pb-3 pr-4\">Type</th>\r\n                  <th className=\"pb-3 pr-4\">Source</th>\r\n                  <th className=\"pb-3 pr-4\">USD Amount</th>\r\n                  <th className=\"pb-3 pr-4\">Coins</th>\r\n                  <th className=\"pb-3 pr-4\">Description</th>\r\n                  <th className=\"pb-3\">Date</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {transactions.map((tx) => (\r\n                  <tr key={tx.id} className=\"border-b border-[#2C2C2C] hover:bg-[#252525]\">\r\n                    <td className=\"py-3 pr-4\">\r\n                      <div className={`flex items-center gap-2 ${getTransactionTypeColor(tx.transaction_type)}`}>\r\n                        {getTransactionTypeIcon(tx.transaction_type)}\r\n                        <span className=\"capitalize\">{tx.transaction_type.replace(/_/g, ' ')}</span>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"py-3 pr-4 text-gray-400\">{tx.source_type}</td>\r\n                    <td className=\"py-3 pr-4 text-green-400\">{tx.usd_amount > 0 ? formatCurrency(tx.usd_amount) : '-'}</td>\r\n                    <td className=\"py-3 pr-4 text-yellow-400\">{tx.coin_amount > 0 ? formatCoins(tx.coin_amount) : '-'}</td>\r\n                    <td className=\"py-3 pr-4 text-gray-300 max-w-xs truncate\">{tx.description || '-'}</td>\r\n                    <td className=\"py-3 text-gray-400\">\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <Clock className=\"w-3 h-3\" />\r\n                        {new Date(tx.created_at).toLocaleDateString()}\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n          \r\n          {transactions.length === 0 && (\r\n            <div className=\"text-center py-8 text-gray-400\">\r\n              No transactions yet. PayPal purchases will appear here.\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Safety Notice */}\r\n        <div className=\"bg-yellow-900/20 border border-yellow-500/30 rounded-xl p-4\">\r\n          <div className=\"flex items-start gap-3\">\r\n            <AlertTriangle className=\"w-5 h-5 text-yellow-400 mt-0.5\" />\r\n            <div>\r\n              <h4 className=\"font-semibold text-yellow-400\">Safety Guidelines</h4>\r\n              <ul className=\"text-sm text-gray-300 mt-2 space-y-1\">\r\n                <li>‚Ä¢ Only spend from the <strong>Admin Spendable</strong> bucket</li>\r\n                <li>‚Ä¢ Never touch <strong>Broadcaster Liability</strong> - this money belongs to creators</li>\r\n                <li>‚Ä¢ Payout requests are validated against broadcaster liability before approval</li>\r\n                <li>‚Ä¢ Insufficient funds will mark payouts as \"pending_funds\" until money is available</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CacheClear.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CashoutManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ChatModeration.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CityControlCenter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CityEventsManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ControlPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CourtDocketsManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CreateSchedule.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\CriticalAlertsManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\DatabaseBackup.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLastBackup' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":18,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":28,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { \r\n  Database, \r\n  Download, \r\n  RefreshCw, \r\n  Shield, \r\n  Clock, \r\n  CheckCircle, \r\n  AlertTriangle,\r\n  FileJson,\r\n  Archive\r\n} from 'lucide-react';\r\nimport { supabase } from '../../lib/supabase';\r\n\r\nconst DatabaseBackup: React.FC = () => {\r\n  const [loading, setLoading] = useState(false);\r\n  const [backupStatus, setBackupStatus] = useState<'idle' | 'processing' | 'success' | 'error'>('idle');\r\n  const [lastBackup, setLastBackup] = useState<string>(new Date(Date.now() - 86400000).toLocaleString());\r\n\r\n  const handleCreateBackup = async () => {\r\n    setLoading(true);\r\n    setBackupStatus('processing');\r\n    try {\r\n      // Trigger a real backup request via RPC\r\n      const { data: user } = await supabase.auth.getUser();\r\n      if (!user.user) throw new Error(\"Not authenticated\");\r\n\r\n      const { data, error } = await supabase.rpc('trigger_manual_backup', {\r\n        p_admin_id: user.user.id\r\n      });\r\n      \r\n      if (error) throw error;\r\n      \r\n      // We don't fake success anymore. We wait for the system to process it.\r\n      // For UX, we show \"Request Sent\" and let the user know it's queued.\r\n      toast.success(\"Backup request queued successfully\");\r\n      setBackupStatus('idle'); // Reset to idle so they can request again if needed, or we could track the active request.\r\n      \r\n      // In a real app with a background worker, we would subscribe to the request status.\r\n      // For now, we just acknowledge the request.\r\n    } catch (error: any) {\r\n      console.error(error);\r\n      toast.error(error.message || \"Backup request failed\");\r\n      setBackupStatus('error');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleExportData = async (table: string, filename?: string) => {\r\n    try {\r\n      const { data, error } = await supabase.from(table).select('*').limit(1000);\r\n      if (error) throw error;\r\n\r\n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\r\n      const url = window.URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = `${filename || table}_export_${new Date().toISOString().split('T')[0]}.json`;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      window.URL.revokeObjectURL(url);\r\n      document.body.removeChild(a);\r\n    } catch (error) {\r\n      console.error(`Error exporting ${table}:`, error);\r\n      alert(`Failed to export ${table}`);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto space-y-8\">\r\n        \r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold flex items-center gap-3\">\r\n              <Database className=\"w-8 h-8 text-purple-400\" />\r\n              Database Management\r\n            </h1>\r\n            <p className=\"text-gray-400 mt-2\">Manage system backups and data exports</p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 px-4 py-2 bg-green-500/10 border border-green-500/20 rounded-lg\">\r\n            <Shield className=\"w-4 h-4 text-green-400\" />\r\n            <span className=\"text-green-400 text-sm font-medium\">System Healthy</span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Backup Controls */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n          \r\n          {/* Automatic Backups Card */}\r\n          <div className=\"bg-[#111] border border-gray-800 rounded-xl p-6 relative overflow-hidden group\">\r\n            <div className=\"absolute top-0 right-0 w-32 h-32 bg-purple-500/5 rounded-full blur-2xl group-hover:bg-purple-500/10 transition-all\" />\r\n            \r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-xl font-semibold flex items-center gap-2\">\r\n                <Clock className=\"w-5 h-5 text-purple-400\" />\r\n                Automated Backups\r\n              </h2>\r\n              <span className=\"px-2 py-1 bg-purple-500/10 rounded text-xs text-purple-400\">Daily</span>\r\n            </div>\r\n\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <span className=\"text-gray-400\">Last Successful Backup</span>\r\n                <span className=\"text-white font-mono\">{lastBackup}</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <span className=\"text-gray-400\">Next Scheduled</span>\r\n                <span className=\"text-white font-mono\">00:00 UTC</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <span className=\"text-gray-400\">Retention Policy</span>\r\n                <span className=\"text-white\">30 Days</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Manual Backup Card */}\r\n          <div className=\"bg-[#111] border border-gray-800 rounded-xl p-6 relative overflow-hidden\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-xl font-semibold flex items-center gap-2\">\r\n                <Archive className=\"w-5 h-5 text-blue-400\" />\r\n                Manual Backup\r\n              </h2>\r\n            </div>\r\n\r\n            <div className=\"space-y-4\">\r\n              <p className=\"text-sm text-gray-400\">\r\n                Trigger an immediate full database backup. This operation may take several minutes depending on database size.\r\n              </p>\r\n              \r\n              <button\r\n                onClick={handleCreateBackup}\r\n                disabled={loading}\r\n                className={`w-full py-3 px-4 rounded-lg flex items-center justify-center gap-2 font-medium transition-all ${\r\n                  backupStatus === 'success' \r\n                    ? 'bg-green-500/20 text-green-400 border border-green-500/50'\r\n                    : 'bg-blue-600 hover:bg-blue-500 text-white'\r\n                } disabled:opacity-50 disabled:cursor-not-allowed`}\r\n              >\r\n                {loading ? (\r\n                  <RefreshCw className=\"w-4 h-4 animate-spin\" />\r\n                ) : backupStatus === 'success' ? (\r\n                  <CheckCircle className=\"w-4 h-4\" />\r\n                ) : (\r\n                  <Database className=\"w-4 h-4\" />\r\n                )}\r\n                {loading ? 'Processing...' : backupStatus === 'success' ? 'Backup Complete' : 'Start Backup Now'}\r\n              </button>\r\n\r\n              {backupStatus === 'error' && (\r\n                <div className=\"flex items-center gap-2 text-red-400 text-sm mt-2\">\r\n                  <AlertTriangle className=\"w-4 h-4\" />\r\n                  <span>Backup failed. Please check server logs.</span>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Data Export Section */}\r\n        <div className=\"bg-[#111] border border-gray-800 rounded-xl p-6\">\r\n          <h2 className=\"text-xl font-semibold mb-6 flex items-center gap-2\">\r\n            <Download className=\"w-5 h-5 text-orange-400\" />\r\n            Data Export\r\n          </h2>\r\n\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n            {[\r\n              { label: 'User Profiles', table: 'user_profiles' },\r\n              { label: 'Transactions', table: 'coin_transactions' },\r\n              { label: 'Stream Chats', table: 'messages', filename: 'stream_chat_logs' },\r\n              { label: 'Direct Messages', table: 'conversation_messages', filename: 'dm_logs' },\r\n              { label: 'Audit Logs', table: 'audit_logs', filename: 'system_audit_logs' }\r\n            ].map((item) => (\r\n              <button\r\n                key={item.table + item.label}\r\n                onClick={() => handleExportData(item.table, item.filename)}\r\n                className=\"flex items-center justify-between p-4 bg-[#1a1a24] hover:bg-[#252532] border border-gray-800 hover:border-gray-700 rounded-lg transition-all group\"\r\n              >\r\n                <div className=\"flex items-center gap-3\">\r\n                  <FileJson className=\"w-5 h-5 text-gray-500 group-hover:text-orange-400 transition-colors\" />\r\n                  <span className=\"text-sm font-medium text-gray-300 group-hover:text-white\">{item.label}</span>\r\n                </div>\r\n                <Download className=\"w-4 h-4 text-gray-600 group-hover:text-white opacity-0 group-hover:opacity-100 transition-all\" />\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default DatabaseBackup;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\EconomyDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\EmpireApplications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\EmpireApplicationsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\EscalationMatrix.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ExecutiveIntake.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ExecutiveReports.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ExecutiveSecretaries.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ExportData.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\GiftCardsManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\GrantCoins.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\LaunchTrial.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\MediaLibrary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\MobileAdminDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\OfficerManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\OfficerOperations.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\OfficerShifts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\PaymentLogs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\PaymentsDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ReferralBonusPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ReferralBonuses.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ReportsQueue.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ReputationDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\ResetMaintenance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\RoleManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\SendNotifications.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":290,"column":25,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use &quot;Troll Drop\" type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use &ldquo;Troll Drop\" type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use &#34;Troll Drop\" type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use &rdquo;Troll Drop\" type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":290,"column":36,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use \"Troll Drop&quot; type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use \"Troll Drop&ldquo; type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use \"Troll Drop&#34; type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[10823,10891],"text":"‚Ä¢ Use \"Troll Drop&rdquo; type for coin giveaways (includes coins metadata)"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { NotificationType } from '../../lib/sendNotification';\r\nimport { toast } from 'sonner';\r\nimport { Bell, Users, Send, AlertCircle, CheckCircle } from 'lucide-react';\r\n\r\nconst NOTIFICATION_TYPES: { value: NotificationType; label: string }[] = [\r\n  { value: 'stream_live', label: 'Stream Live' },\r\n  { value: 'join_approved', label: 'Join Approved' },\r\n  { value: 'moderation_alert', label: 'Moderation Alert' },\r\n  { value: 'new_follower', label: 'New Follower' },\r\n  { value: 'gift_received', label: 'Gift Received' },\r\n  { value: 'message', label: 'Message' },\r\n  { value: 'support_reply', label: 'Support Reply' },\r\n  { value: 'payout_update', label: 'Payout Update' },\r\n  { value: 'role_update', label: 'Role Update' },\r\n  { value: 'application_result', label: 'Application Result' },\r\n  { value: 'troll_drop', label: 'Troll Drop' },\r\n];\r\n\r\nexport default function SendNotifications() {\r\n  const [type, setType] = useState<NotificationType>('stream_live');\r\n  const [title, setTitle] = useState('');\r\n  const [message, setMessage] = useState('');\r\n  const [metadata, setMetadata] = useState('{}');\r\n  const [sendToAll, setSendToAll] = useState(true);\r\n  const [sending, setSending] = useState(false);\r\n  const [result, setResult] = useState<{\r\n    success: boolean;\r\n    notificationCount?: number;\r\n    failedCount?: number;\r\n    message?: string;\r\n  } | null>(null);\r\n\r\n  const handleSend = async () => {\r\n    if (!title.trim() || !message.trim()) {\r\n      toast.error('Please enter both title and message');\r\n      return;\r\n    }\r\n\r\n    let metadataObj = {};\r\n    try {\r\n      if (metadata.trim()) {\r\n        metadataObj = JSON.parse(metadata);\r\n      }\r\n    } catch {\r\n      toast.error('Invalid JSON in metadata');\r\n      return;\r\n    }\r\n\r\n    setSending(true);\r\n    setResult(null);\r\n\r\n    try {\r\n      const { data: session } = await supabase.auth.getSession();\r\n      const token = session.session?.access_token;\r\n\r\n      if (!token) {\r\n        throw new Error('Not authenticated');\r\n      }\r\n\r\n      const functionsUrl = import.meta.env.VITE_SUPABASE_URL \r\n        ? `${import.meta.env.VITE_SUPABASE_URL}/functions/v1`\r\n        : 'https://yjxpwfalenorzrqxwmtr.supabase.co/functions/v1';\r\n\r\n      const response = await fetch(`${functionsUrl}/send-bulk-notifications`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({\r\n          type,\r\n          title: title.trim(),\r\n          message: message.trim(),\r\n          metadata: metadataObj,\r\n          targetUserIds: sendToAll ? [] : undefined,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || 'Failed to send notifications');\r\n      }\r\n\r\n      setResult({\r\n        success: true,\r\n        notificationCount: data.notificationCount,\r\n        failedCount: data.failedCount,\r\n        message: data.message,\r\n      });\r\n\r\n      toast.success(`‚úÖ ${data.message}`);\r\n      \r\n      // Reset form on success\r\n      setTitle('');\r\n      setMessage('');\r\n      setMetadata('{}');\r\n\r\n    } catch (error: any) {\r\n      console.error('Error sending notifications:', error);\r\n      setResult({\r\n        success: false,\r\n        message: error.message || 'Unknown error',\r\n      });\r\n      toast.error(error.message || 'Failed to send notifications');\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-2xl font-bold flex items-center gap-3\">\r\n            <Bell className=\"w-8 h-8 text-purple-400\" />\r\n            Send Notifications\r\n          </h1>\r\n          <p className=\"text-gray-400 mt-2\">\r\n            Send notifications to all users or specific users\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid gap-6\">\r\n          {/* Notification Form */}\r\n          <div className=\"bg-[#1A1A24] border border-gray-700 rounded-xl p-6\">\r\n            <h2 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\r\n              <Send className=\"w-5 h-5 text-blue-400\" />\r\n              Create Notification\r\n            </h2>\r\n\r\n            <div className=\"grid gap-4\">\r\n              {/* Notification Type */}\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">\r\n                  Notification Type\r\n                </label>\r\n                <select\r\n                  value={type}\r\n                  onChange={(e) => setType(e.target.value as NotificationType)}\r\n                  className=\"w-full bg-[#0A0814] border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none\"\r\n                >\r\n                  {NOTIFICATION_TYPES.map((nt) => (\r\n                    <option key={nt.value} value={nt.value}>\r\n                      {nt.label}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n\r\n              {/* Title */}\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">\r\n                  Title *\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={title}\r\n                  onChange={(e) => setTitle(e.target.value)}\r\n                  placeholder=\"Enter notification title...\"\r\n                  className=\"w-full bg-[#0A0814] border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none\"\r\n                />\r\n              </div>\r\n\r\n              {/* Message */}\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">\r\n                  Message *\r\n                </label>\r\n                <textarea\r\n                  value={message}\r\n                  onChange={(e) => setMessage(e.target.value)}\r\n                  placeholder=\"Enter notification message...\"\r\n                  rows={4}\r\n                  className=\"w-full bg-[#0A0814] border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none resize-none\"\r\n                />\r\n              </div>\r\n\r\n              {/* Metadata */}\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">\r\n                  Metadata (JSON, optional)\r\n                </label>\r\n                <textarea\r\n                  value={metadata}\r\n                  onChange={(e) => setMetadata(e.target.value)}\r\n                  placeholder='{\"key\": \"value\"}'\r\n                  rows={2}\r\n                  className=\"w-full bg-[#0A0814] border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none resize-none font-mono text-sm\"\r\n                />\r\n              </div>\r\n\r\n              {/* Target Audience */}\r\n              <div>\r\n                <label className=\"block text-sm text-gray-400 mb-2\">\r\n                  Target Audience\r\n                </label>\r\n                <div className=\"flex gap-4\">\r\n                  <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                    <input\r\n                      type=\"radio\"\r\n                      name=\"target\"\r\n                      checked={sendToAll}\r\n                      onChange={() => setSendToAll(true)}\r\n                      className=\"w-4 h-4 text-purple-500\"\r\n                    />\r\n                    <span className=\"flex items-center gap-2\">\r\n                      <Users className=\"w-4 h-4\" />\r\n                      All Users\r\n                    </span>\r\n                  </label>\r\n                  <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                    <input\r\n                      type=\"radio\"\r\n                      name=\"target\"\r\n                      checked={!sendToAll}\r\n                      onChange={() => setSendToAll(false)}\r\n                      className=\"w-4 h-4 text-purple-500\"\r\n                    />\r\n                    <span>Specific Users (Coming Soon)</span>\r\n                  </label>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Send Button */}\r\n              <button\r\n                onClick={handleSend}\r\n                disabled={sending || !title.trim() || !message.trim()}\r\n                className=\"w-full py-3 bg-purple-600 hover:bg-purple-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-semibold transition flex items-center justify-center gap-2\"\r\n              >\r\n                {sending ? (\r\n                  <>\r\n                    <div className=\"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin\" />\r\n                    Sending...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Send className=\"w-5 h-5\" />\r\n                    Send Notification\r\n                  </>\r\n                )}\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Result Display */}\r\n          {result && (\r\n            <div className={`border rounded-xl p-6 ${\r\n              result.success \r\n                ? 'bg-green-900/20 border-green-500/50' \r\n                : 'bg-red-900/20 border-red-500/50'\r\n            }`}>\r\n              <h3 className={`text-lg font-semibold flex items-center gap-2 mb-3 ${\r\n                result.success ? 'text-green-400' : 'text-red-400'\r\n              }`}>\r\n                {result.success ? (\r\n                  <>\r\n                    <CheckCircle className=\"w-5 h-5\" />\r\n                    Success\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <AlertCircle className=\"w-5 h-5\" />\r\n                    Failed\r\n                  </>\r\n                )}\r\n              </h3>\r\n              \r\n              <p className=\"text-gray-300\">\r\n                {result.message || result.message}\r\n              </p>\r\n              \r\n              {result.success && result.notificationCount !== undefined && (\r\n                <div className=\"mt-3 text-sm text-gray-400\">\r\n                  <p>‚úÖ Notifications sent: {result.notificationCount}</p>\r\n                  {result.failedCount && result.failedCount > 0 && (\r\n                    <p>‚ùå Failed: {result.failedCount}</p>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Info Box */}\r\n          <div className=\"bg-blue-900/20 border border-blue-500/30 rounded-xl p-4\">\r\n            <h3 className=\"text-blue-400 font-semibold mb-2\">Tips</h3>\r\n            <ul className=\"text-gray-300 text-sm space-y-1\">\r\n              <li>‚Ä¢ Use \"Troll Drop\" type for coin giveaways (includes coins metadata)</li>\r\n              <li>‚Ä¢ Metadata can include extra data like action URLs, amounts, etc.</li>\r\n              <li>‚Ä¢ Notifications are sent immediately to all users</li>\r\n              <li>‚Ä¢ Users will see notifications in their bell icon</li>\r\n            </ul>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\StoreDebug.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\StreamMonitorPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\SystemConfig.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":48,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":104,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":164,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":164,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { useAuthStore } from '../../lib/store';\r\n\r\ninterface AppSetting {\r\n  setting_key: string;\r\n  setting_value: any;\r\n  description: string;\r\n  updated_at: string;\r\n}\r\n\r\nconst SystemConfig: React.FC = () => {\r\n  const [settings, setSettings] = useState<AppSetting[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [saving, setSaving] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const { user } = useAuthStore();\r\n\r\n  useEffect(() => {\r\n    fetchSettings();\r\n  }, []);\r\n\r\n  const fetchSettings = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('admin_app_settings')\r\n        .select('*')\r\n        .order('setting_key');\r\n\r\n      if (error) throw error;\r\n      setSettings(data || []);\r\n    } catch (err: any) {\r\n      console.error('Error fetching settings:', err);\r\n      setError(err.message);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleUpdate = async (key: string, newValue: any) => {\r\n    setSaving(key);\r\n    try {\r\n      // Parse if string is passed (from textarea)\r\n      let parsedValue = newValue;\r\n      if (typeof newValue === 'string') {\r\n        try {\r\n          parsedValue = JSON.parse(newValue);\r\n        } catch (e) {\r\n          // Keep as string if not valid JSON, or throw error depending on strictness\r\n          // But for now, we assume admin knows what they are doing or we provide specific UI\r\n          // If the original value was an object, we must parse.\r\n          // Let's rely on specific handlers for specific keys if possible.\r\n        }\r\n      }\r\n\r\n      const { error } = await supabase\r\n        .from('admin_app_settings')\r\n        .update({ \r\n          setting_value: parsedValue,\r\n          updated_at: new Date().toISOString(),\r\n          updated_by: user?.id \r\n        })\r\n        .eq('setting_key', key);\r\n\r\n      if (error) throw error;\r\n      \r\n      // Refresh local state to confirm\r\n      await fetchSettings();\r\n    } catch (err: any) {\r\n      console.error('Error updating setting:', err);\r\n      setError(`Failed to update ${key}: ${err.message}`);\r\n    } finally {\r\n      setSaving(null);\r\n    }\r\n  };\r\n\r\n  const renderSettingInput = (setting: AppSetting) => {\r\n    const { setting_key, setting_value } = setting;\r\n\r\n    // Special handling for Maintenance Mode\r\n    if (setting_key === 'maintenance_mode') {\r\n      const isEnabled = setting_value?.enabled || false;\r\n      const message = setting_value?.message || '';\r\n\r\n      return (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <label className=\"switch\">\r\n              <input \r\n                type=\"checkbox\" \r\n                checked={isEnabled}\r\n                onChange={(e) => handleUpdate(setting_key, { ...setting_value, enabled: e.target.checked })}\r\n              />\r\n              <span className=\"slider round\"></span>\r\n            </label>\r\n            <span className={isEnabled ? 'text-red-400 font-bold' : 'text-green-400'}>\r\n              {isEnabled ? 'MAINTENANCE ON' : 'MAINTENANCE OFF'}\r\n            </span>\r\n          </div>\r\n          <input\r\n            type=\"text\"\r\n            className=\"w-full bg-black/40 border border-purple-500/30 rounded px-3 py-2 text-white\"\r\n            value={message}\r\n            onChange={(e) => {\r\n              // Defer update or handle blur? For now, let's just show input and add a save button for text\r\n            }}\r\n            onBlur={(e) => handleUpdate(setting_key, { ...setting_value, message: e.target.value })}\r\n            placeholder=\"Maintenance message...\"\r\n          />\r\n        </div>\r\n      );\r\n    }\r\n\r\n    // Special handling for Global Announcement\r\n    if (setting_key === 'global_announcement') {\r\n      const isActive = setting_value?.active || false;\r\n      const message = setting_value?.message || '';\r\n      const type = setting_value?.type || 'info';\r\n\r\n      return (\r\n        <div className=\"space-y-2\">\r\n           <div className=\"flex items-center gap-2\">\r\n            <label className=\"switch\">\r\n              <input \r\n                type=\"checkbox\" \r\n                checked={isActive}\r\n                onChange={(e) => handleUpdate(setting_key, { ...setting_value, active: e.target.checked })}\r\n              />\r\n              <span className=\"slider round\"></span>\r\n            </label>\r\n            <span>{isActive ? 'Announcement Active' : 'Announcement Inactive'}</span>\r\n          </div>\r\n          <input\r\n            type=\"text\"\r\n            className=\"w-full bg-black/40 border border-purple-500/30 rounded px-3 py-2 text-white\"\r\n            defaultValue={message}\r\n            onBlur={(e) => handleUpdate(setting_key, { ...setting_value, message: e.target.value })}\r\n            placeholder=\"Announcement text...\"\r\n          />\r\n           <select \r\n             className=\"bg-black/40 border border-purple-500/30 rounded px-2 py-1\"\r\n             value={type}\r\n             onChange={(e) => handleUpdate(setting_key, { ...setting_value, type: e.target.value })}\r\n           >\r\n             <option value=\"info\">Info (Blue)</option>\r\n             <option value=\"warning\">Warning (Yellow)</option>\r\n             <option value=\"error\">Critical (Red)</option>\r\n             <option value=\"success\">Success (Green)</option>\r\n           </select>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    // Default JSON editor for everything else\r\n    return (\r\n      <div className=\"space-y-2\">\r\n        <textarea\r\n          className=\"w-full h-24 bg-black/40 border border-purple-500/30 rounded p-2 font-mono text-xs text-green-300\"\r\n          defaultValue={JSON.stringify(setting_value, null, 2)}\r\n          onBlur={(e) => {\r\n            try {\r\n              const val = JSON.parse(e.target.value);\r\n              handleUpdate(setting_key, val);\r\n            } catch (err) {\r\n              alert('Invalid JSON');\r\n            }\r\n          }}\r\n        />\r\n        <p className=\"text-xs text-gray-500\">Edit JSON directly and click outside to save.</p>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  if (loading) return <div className=\"p-8 text-center\">Loading configuration...</div>;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <h1 className=\"text-3xl font-bold mb-6 flex items-center gap-2\">\r\n          <span className=\"text-purple-400\">‚öôÔ∏è</span> System Configuration\r\n        </h1>\r\n        \r\n        {error && (\r\n          <div className=\"bg-red-900/50 border border-red-500 p-4 rounded mb-6 text-red-200\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n          {settings.map(setting => (\r\n            <div key={setting.setting_key} className=\"bg-black/60 border border-purple-600/30 rounded-xl p-6 hover:border-purple-500/50 transition-colors\">\r\n              <div className=\"flex justify-between items-start mb-4\">\r\n                <div>\r\n                  <h3 className=\"text-xl font-semibold text-purple-300\">{setting.setting_key.replace(/_/g, ' ').toUpperCase()}</h3>\r\n                  <p className=\"text-sm text-gray-400\">{setting.description}</p>\r\n                </div>\r\n                {saving === setting.setting_key && (\r\n                  <span className=\"text-xs bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded animate-pulse\">\r\n                    Saving...\r\n                  </span>\r\n                )}\r\n              </div>\r\n              \r\n              <div className=\"bg-[#0f0f13] rounded p-4 border border-white/5\">\r\n                {renderSettingInput(setting)}\r\n              </div>\r\n              \r\n              <div className=\"mt-2 text-right\">\r\n                <span className=\"text-xs text-gray-600\">Last updated: {new Date(setting.updated_at).toLocaleString()}</span>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SystemConfig;","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\TaxReviewPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\TestDiagnosticsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\TrollFamily.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":228,"column":28,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7602,7660],"text":"\r\n                      Admin&apos;s Wife\r\n                    "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7602,7660],"text":"\r\n                      Admin&lsquo;s Wife\r\n                    "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7602,7660],"text":"\r\n                      Admin&#39;s Wife\r\n                    "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7602,7660],"text":"\r\n                      Admin&rsquo;s Wife\r\n                    "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":252,"column":28,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8879,8940],"text":"\r\n                      Admin&apos;s Husband\r\n                    "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8879,8940],"text":"\r\n                      Admin&lsquo;s Husband\r\n                    "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8879,8940],"text":"\r\n                      Admin&#39;s Husband\r\n                    "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8879,8940],"text":"\r\n                      Admin&rsquo;s Husband\r\n                    "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport {\r\n  Crown,\r\n  Users,\r\n  Trophy,\r\n  TrendingUp,\r\n  UserPlus,\r\n  UserMinus,\r\n  Edit,\r\n  Star\r\n} from 'lucide-react'\r\n\r\ninterface RoyalFamilyStatus {\r\n  admin_id: string\r\n  current_wife: any\r\n  current_husband: any\r\n  gift_leaderboard: any[]\r\n  honorary_members: any[]\r\n}\r\n\r\ninterface LeaderboardEntry {\r\n  user_id: string\r\n  username: string\r\n  total_coins: number\r\n  gender: string\r\n  last_gift_at: string\r\n  rank: number\r\n}\r\n\r\nexport default function TrollFamily() {\r\n  const [familyStatus, setFamilyStatus] = useState<RoyalFamilyStatus | null>(null)\r\n  const [leaderboard, setLeaderboard] = useState<LeaderboardEntry[]>([])\r\n  const [honoraryMembers, setHonoraryMembers] = useState<any[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [showAddMember, setShowAddMember] = useState(false)\r\n  const [newMemberUsername, setNewMemberUsername] = useState('')\r\n  const [newMemberTitle, setNewMemberTitle] = useState('Honorary Family Member')\r\n\r\n  const loadFamilyData = React.useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n\r\n      // Get royal family status for all admins\r\n      const { data: statusData, error: statusError } = await supabase.rpc('get_royal_family_status')\r\n\r\n      if (statusError) throw statusError\r\n\r\n      // For now, we'll focus on the first admin (assuming single admin system)\r\n      // In a multi-admin system, this would need to be filtered by current admin\r\n      const adminStatus = statusData?.[0]\r\n      if (adminStatus) {\r\n        setFamilyStatus(adminStatus)\r\n        setHonoraryMembers(adminStatus.honorary_members || [])\r\n      }\r\n\r\n      // Get leaderboard\r\n      const { data: leaderboardData, error: leaderboardError } = await supabase\r\n        .from('royal_family_leaderboard')\r\n        .select('*')\r\n        .limit(20)\r\n\r\n      if (leaderboardError) {\r\n        console.warn('Leaderboard not available yet:', leaderboardError)\r\n      } else {\r\n        setLeaderboard(leaderboardData || [])\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error loading family data:', error)\r\n      toast.error('Failed to load family data')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    loadFamilyData()\r\n  }, [loadFamilyData])\r\n\r\n  const addHonoraryMember = async () => {\r\n    if (!newMemberUsername.trim()) {\r\n      toast.error('Please enter a username')\r\n      return\r\n    }\r\n\r\n    try {\r\n      // Find user by username\r\n      const { data: userData, error: userError } = await supabase\r\n        .from('user_profiles')\r\n        .select('id')\r\n        .eq('username', newMemberUsername.trim())\r\n        .single()\r\n\r\n      if (userError || !userData) {\r\n        toast.error('User not found')\r\n        return\r\n      }\r\n\r\n      // Add honorary member\r\n      const { data, error } = await supabase.rpc('manage_honorary_family_member', {\r\n        p_user_id: userData.id,\r\n        p_admin_id: familyStatus?.admin_id,\r\n        p_action: 'add',\r\n        p_title: newMemberTitle\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success('Honorary member added successfully')\r\n        setShowAddMember(false)\r\n        setNewMemberUsername('')\r\n        setNewMemberTitle('Honorary Family Member')\r\n        loadFamilyData()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to add member')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error adding honorary member:', error)\r\n      toast.error(error.message || 'Failed to add member')\r\n    }\r\n  }\r\n\r\n  const removeHonoraryMember = async (userId: string) => {\r\n    if (!confirm('Are you sure you want to remove this honorary member?')) return\r\n\r\n    try {\r\n      const { data, error } = await supabase.rpc('manage_honorary_family_member', {\r\n        p_user_id: userId,\r\n        p_admin_id: familyStatus?.admin_id,\r\n        p_action: 'remove'\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success('Honorary member removed successfully')\r\n        loadFamilyData()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to remove member')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error removing honorary member:', error)\r\n      toast.error(error.message || 'Failed to remove member')\r\n    }\r\n  }\r\n\r\n  const updateMemberTitle = async (userId: string, newTitle: string) => {\r\n    try {\r\n      const { data, error } = await supabase.rpc('manage_honorary_family_member', {\r\n        p_user_id: userId,\r\n        p_admin_id: familyStatus?.admin_id,\r\n        p_action: 'update_title',\r\n        p_title: newTitle\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data?.success) {\r\n        toast.success('Member title updated successfully')\r\n        loadFamilyData()\r\n      } else {\r\n        toast.error(data?.error || 'Failed to update title')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error updating member title:', error)\r\n      toast.error(error.message || 'Failed to update title')\r\n    }\r\n  }\r\n\r\n  const getProgressToNext = (currentCoins: number, threshold: number = 50000) => {\r\n    const progress = Math.min((currentCoins / threshold) * 100, 100)\r\n    const remaining = Math.max(threshold - currentCoins, 0)\r\n    return { progress, remaining }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n        <div className=\"max-w-6xl mx-auto\">\r\n          <div className=\"animate-pulse space-y-6\">\r\n            <div className=\"h-8 bg-gray-700 rounded w-1/4\"></div>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n              <div className=\"h-64 bg-gray-700 rounded\"></div>\r\n              <div className=\"h-64 bg-gray-700 rounded\"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6\">\r\n      <div className=\"max-w-6xl mx-auto space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"text-center\">\r\n          <h1 className=\"text-4xl font-bold mb-2 flex items-center justify-center gap-3\">\r\n            <Crown className=\"w-8 h-8 text-yellow-400\" />\r\n            Troll Family Royal Court\r\n          </h1>\r\n          <p className=\"text-gray-400\">Manage the royal family hierarchy and honorary members</p>\r\n        </div>\r\n\r\n        {/* Current Royal Family */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n          {/* Current Wife/Husband */}\r\n          <div className=\"bg-zinc-900 rounded-xl border border-purple-500/30 p-6\">\r\n            <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n              <Crown className=\"w-5 h-5 text-yellow-400\" />\r\n              Current Royal Consort\r\n            </h2>\r\n\r\n            {familyStatus?.current_wife ? (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center gap-4\">\r\n                  <div className=\"w-16 h-16 rounded-full overflow-hidden border-2 border-yellow-400\">\r\n                    <img\r\n                      src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${familyStatus.current_wife.username}`}\r\n                      alt={familyStatus.current_wife.username}\r\n                      className=\"w-full h-full object-cover\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-yellow-400\">\r\n                      Admin's Wife\r\n                    </h3>\r\n                    <p className=\"text-white font-semibold\">@{familyStatus.current_wife.username}</p>\r\n                    <p className=\"text-sm text-gray-400\">\r\n                      {familyStatus.current_wife.total_coins?.toLocaleString()} family tokens gifted\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-500\">\r\n                      {familyStatus.current_wife.duration_days || 0} days holding title\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ) : familyStatus?.current_husband ? (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center gap-4\">\r\n                  <div className=\"w-16 h-16 rounded-full overflow-hidden border-2 border-yellow-400\">\r\n                    <img\r\n                      src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${familyStatus.current_husband.username}`}\r\n                      alt={familyStatus.current_husband.username}\r\n                      className=\"w-full h-full object-cover\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-yellow-400\">\r\n                      Admin's Husband\r\n                    </h3>\r\n                    <p className=\"text-white font-semibold\">@{familyStatus.current_husband.username}</p>\r\n                    <p className=\"text-sm text-gray-400\">\r\n                      {familyStatus.current_husband.total_coins?.toLocaleString()} family tokens gifted\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-500\">\r\n                      {familyStatus.current_husband.duration_days || 0} days holding title\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-center py-8 text-gray-500\">\r\n                <Crown className=\"w-12 h-12 mx-auto mb-2 opacity-20\" />\r\n                <p>No royal consort currently</p>\r\n                <p className=\"text-sm\">First to gift 50,000+ family tokens becomes the consort</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Progress to Next Contender */}\r\n          <div className=\"bg-zinc-900 rounded-xl border border-blue-500/30 p-6\">\r\n            <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n              <TrendingUp className=\"w-5 h-5 text-blue-400\" />\r\n              Next Contender Progress\r\n            </h2>\r\n\r\n            {leaderboard.length > 0 && (\r\n              <div className=\"space-y-4\">\r\n                {leaderboard.slice(0, 3).map((entry, index) => {\r\n                  const { progress, remaining } = getProgressToNext(entry.total_coins)\r\n                  const isCurrentConsort = (\r\n                    (familyStatus?.current_wife?.user_id === entry.user_id) ||\r\n                    (familyStatus?.current_husband?.user_id === entry.user_id)\r\n                  )\r\n\r\n                  return (\r\n                    <div key={entry.user_id} className=\"space-y-2\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span className={`text-sm font-bold ${\r\n                            index === 0 ? 'text-yellow-400' :\r\n                            index === 1 ? 'text-gray-400' :\r\n                            'text-orange-400'\r\n                          }`}>\r\n                            #{entry.rank}\r\n                          </span>\r\n                          <span className=\"font-semibold\">@{entry.username}</span>\r\n                          {isCurrentConsort && (\r\n                            <Crown className=\"w-4 h-4 text-yellow-400\" />\r\n                          )}\r\n                        </div>\r\n                        <span className=\"text-sm text-gray-400\">\r\n                          {entry.total_coins.toLocaleString()} family tokens\r\n                        </span>\r\n                      </div>\r\n\r\n                      {!isCurrentConsort && (\r\n                        <div className=\"space-y-1\">\r\n                          <div className=\"w-full bg-gray-700 rounded-full h-2\">\r\n                            <div\r\n                              className=\"bg-blue-500 h-2 rounded-full transition-all duration-300\"\r\n                              style={{ width: `${progress}%` }}\r\n                            />\r\n                          </div>\r\n                          <p className=\"text-xs text-gray-400\">\r\n                            {remaining.toLocaleString()} family tokens to qualify\r\n                          </p>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  )\r\n                })}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Gift Leaderboard */}\r\n        <div className=\"bg-zinc-900 rounded-xl border border-green-500/30 p-6\">\r\n          <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\r\n            <Trophy className=\"w-5 h-5 text-green-400\" />\r\n            Royal Family Gift Leaderboard\r\n          </h2>\r\n\r\n          <div className=\"space-y-3\">\r\n            {leaderboard.map((entry, index) => {\r\n              const isConsort = (\r\n                (familyStatus?.current_wife?.user_id === entry.user_id) ||\r\n                (familyStatus?.current_husband?.user_id === entry.user_id)\r\n              )\r\n\r\n              return (\r\n                <div key={entry.user_id} className={`flex items-center justify-between p-3 rounded-lg ${\r\n                  isConsort ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-[#1A1A1A]'\r\n                }`}>\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${\r\n                      index === 0 ? 'bg-yellow-500 text-black' :\r\n                      index === 1 ? 'bg-gray-500 text-white' :\r\n                      index === 2 ? 'bg-orange-500 text-white' :\r\n                      'bg-gray-700 text-white'\r\n                    }`}>\r\n                      {index + 1}\r\n                    </div>\r\n                    <div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"font-semibold\">@{entry.username}</span>\r\n                        {isConsort && <Crown className=\"w-4 h-4 text-yellow-400\" />}\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-400\">\r\n                        {entry.total_coins.toLocaleString()} family tokens ‚Ä¢ {entry.gender}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"text-right\">\r\n                    <div className=\"text-sm text-gray-400\">\r\n                      Last gift: {new Date(entry.last_gift_at).toLocaleDateString()}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )\r\n            })}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Honorary Family Members */}\r\n        <div className=\"bg-zinc-900 rounded-xl border border-purple-500/30 p-6\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <h2 className=\"text-xl font-bold flex items-center gap-2\">\r\n              <Users className=\"w-5 h-5 text-purple-400\" />\r\n              Honorary Family Members\r\n            </h2>\r\n            <button\r\n              onClick={() => setShowAddMember(true)}\r\n              className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors flex items-center gap-2\"\r\n            >\r\n              <UserPlus className=\"w-4 h-4\" />\r\n              Add Member\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"space-y-3\">\r\n            {honoraryMembers.map((member) => (\r\n              <div key={member.user_id} className=\"flex items-center justify-between p-3 bg-[#1A1A1A] rounded-lg\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"w-10 h-10 rounded-full overflow-hidden\">\r\n                    <img\r\n                      src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${member.username}`}\r\n                      alt={member.username}\r\n                      className=\"w-full h-full object-cover\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"font-semibold\">@{member.username}</span>\r\n                      <Star className=\"w-4 h-4 text-purple-400\" />\r\n                    </div>\r\n                    <div className=\"text-sm text-gray-400\">{member.title}</div>\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      Added {new Date(member.assigned_at).toLocaleDateString()}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      const newTitle = prompt('Enter new title:', member.title)\r\n                      if (newTitle && newTitle !== member.title) {\r\n                        updateMemberTitle(member.user_id, newTitle)\r\n                      }\r\n                    }}\r\n                    className=\"p-2 hover:bg-gray-700 rounded transition-colors\"\r\n                    title=\"Edit title\"\r\n                  >\r\n                    <Edit className=\"w-4 h-4\" />\r\n                  </button>\r\n                  <button\r\n                    onClick={() => removeHonoraryMember(member.user_id)}\r\n                    className=\"p-2 hover:bg-red-600/20 text-red-400 hover:text-red-300 rounded transition-colors\"\r\n                    title=\"Remove member\"\r\n                  >\r\n                    <UserMinus className=\"w-4 h-4\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ))}\r\n\r\n            {honoraryMembers.length === 0 && (\r\n              <div className=\"text-center py-8 text-gray-500\">\r\n                <Users className=\"w-12 h-12 mx-auto mb-2 opacity-20\" />\r\n                <p>No honorary family members yet</p>\r\n                <p className=\"text-sm\">Add special members to the royal court</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Add Member Modal */}\r\n        {showAddMember && (\r\n          <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-[#0A0A14] rounded-xl border border-purple-500/30 p-6 w-full max-w-md\">\r\n              <h3 className=\"text-xl font-bold mb-4\">Add Honorary Family Member</h3>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-200 mb-1\">\r\n                    Username\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={newMemberUsername}\r\n                    onChange={(e) => setNewMemberUsername(e.target.value)}\r\n                    className=\"w-full px-3 py-2 bg-[#1A1A1A] border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500\"\r\n                    placeholder=\"Enter username\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-200 mb-1\">\r\n                    Title\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={newMemberTitle}\r\n                    onChange={(e) => setNewMemberTitle(e.target.value)}\r\n                    className=\"w-full px-3 py-2 bg-[#1A1A1A] border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500\"\r\n                    placeholder=\"Honorary Family Member\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex gap-3 pt-4\">\r\n                  <button\r\n                    onClick={() => {\r\n                      setShowAddMember(false)\r\n                      setNewMemberUsername('')\r\n                      setNewMemberTitle('Honorary Family Member')\r\n                    }}\r\n                    className=\"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors\"\r\n                  >\r\n                    Cancel\r\n                  </button>\r\n                  <button\r\n                    onClick={addHonoraryMember}\r\n                    className=\"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors\"\r\n                  >\r\n                    Add Member\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\TrotingAdminPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\UserSearch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\WeeklyReportsView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\adminRoutes.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdditionalTasksGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminApplications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminCallsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminControlPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminCostDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminManualOrders.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminPayoutDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminPoolTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AdminSupportTickets.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AgreementsManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AllApplications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\ApplicationsHub.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\AutomatedPayouts.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[176,191],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Lock' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":86,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Lock"},"fix":{"range":[213,219],"text":""},"desc":"Remove unused variable \"Lock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Unlock' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":88,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":94,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Unlock"},"fix":{"range":[219,227],"text":""},"desc":"Remove unused variable \"Unlock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":115,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":115,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'runId' is defined but never used. Allowed unused args must match /^_/u.","line":151,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":151,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":159,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":159,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { supabase } from '../../../lib/supabase';\nimport { toast } from 'sonner';\nimport { ChevronDown, ChevronUp, RefreshCw, AlertTriangle, CheckCircle, XCircle, Lock, Unlock, PauseCircle, PlayCircle } from 'lucide-react';\n\ninterface PayoutRun {\n  id: string;\n  run_date: string;\n  status: 'processing' | 'completed' | 'failed';\n  started_at: string;\n  completed_at: string | null;\n  total_payouts: number;\n  total_coins: number;\n  total_usd: number;\n  paypal_batch_id: string | null;\n  logs: any;\n}\n\ninterface PayoutItem {\n  id: string;\n  user_id: string;\n  paypal_email: string;\n  amount_coins: number;\n  amount_usd: number;\n  status: string;\n  paypal_payout_item_id: string | null;\n  failure_reason: string | null;\n  user_profiles?: { username: string };\n}\n\nexport default function AutomatedPayouts() {\n  const [runs, setRuns] = useState<PayoutRun[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [expandedRunId, setExpandedRunId] = useState<string | null>(null);\n  const [runDetails, setRunDetails] = useState<Record<string, PayoutItem[]>>({});\n  const [loadingDetails, setLoadingDetails] = useState<string | null>(null);\n  const [payoutsEnabled, setPayoutsEnabled] = useState(false);\n  const [configLoading, setConfigLoading] = useState(true);\n\n  const loadConfig = async () => {\n    try {\n      const { data, error } = await supabase\n        .from('admin_app_settings')\n        .select('setting_value')\n        .eq('setting_key', 'automated_payouts_enabled')\n        .maybeSingle();\n\n      if (error) throw error;\n      \n      if (data) {\n        setPayoutsEnabled(data.setting_value?.enabled || false);\n      } else {\n        // Default to disabled if setting doesn't exist\n        setPayoutsEnabled(false);\n      }\n    } catch (err) {\n      console.error('Error loading payout config:', err);\n    } finally {\n      setConfigLoading(false);\n    }\n  };\n\n  const togglePayouts = async () => {\n    setConfigLoading(true);\n    const newValue = !payoutsEnabled;\n    try {\n      const { error } = await supabase\n        .from('admin_app_settings')\n        .upsert({\n          setting_key: 'automated_payouts_enabled',\n          setting_value: { enabled: newValue },\n          description: 'Master switch for automated payout runs'\n        });\n\n      if (error) throw error;\n      setPayoutsEnabled(newValue);\n      toast.success(newValue ? 'Automated payouts ENABLED' : 'Automated payouts PAUSED');\n    } catch (err: any) {\n      toast.error('Failed to update settings');\n      console.error(err);\n    } finally {\n      setConfigLoading(false);\n    }\n  };\n\n  const loadRuns = async () => {\n    setLoading(true);\n    try {\n      const { data, error } = await supabase\n        .from('payout_runs')\n        .select('*')\n        .order('started_at', { ascending: false });\n\n      if (error) throw error;\n      setRuns(data || []);\n    } catch (err: any) {\n      toast.error('Failed to load payout runs');\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadRunDetails = async (runId: string) => {\n    if (runDetails[runId]) return;\n    setLoadingDetails(runId);\n    try {\n      const { data, error } = await supabase\n        .from('payouts')\n        .select('*, user_profiles(username)')\n        .eq('run_id', runId);\n\n      if (error) throw error;\n      setRunDetails(prev => ({ ...prev, [runId]: data || [] }));\n    } catch (err: any) {\n      toast.error('Failed to load run details');\n    } finally {\n      setLoadingDetails(null);\n    }\n  };\n\n  const toggleExpand = (runId: string) => {\n    if (expandedRunId === runId) {\n      setExpandedRunId(null);\n    } else {\n      setExpandedRunId(runId);\n      loadRunDetails(runId);\n    }\n  };\n\n  const handleRefundRun = async (runId: string) => {\n    if (!window.confirm('Are you sure you want to refund this ENTIRE run? This will return coins to all users in this run.')) return;\n    \n    const toastId = toast.loading('Refunding run...');\n    try {\n      const { error } = await supabase.rpc('refund_payout_run', { p_run_id: runId });\n      if (error) throw error;\n      toast.success('Run refunded successfully', { id: toastId });\n      loadRuns();\n      setRunDetails(prev => {\n        const newDetails = { ...prev };\n        delete newDetails[runId]; // Force reload\n        return newDetails;\n      });\n      if (expandedRunId === runId) loadRunDetails(runId);\n    } catch (err: any) {\n      toast.error(`Refund failed: ${err.message}`, { id: toastId });\n    }\n  };\n\n  const handleRetryRun = async (runId: string) => {\n      // Logic to retry logic (e.g. call edge function manually if needed, or just re-run the process)\n      // Since edge function is scheduled, maybe just a \"Trigger Now\" button for the general process?\n      // Or if a run is failed but not refunded, maybe we want to retry submission?\n      // For now, let's just allow triggering the generic payout process which picks up queued items.\n      \n      const toastId = toast.loading('Triggering payout process...');\n      try {\n          const { data, error } = await supabase.functions.invoke('payouts', { method: 'POST' });\n          if (error) throw error;\n          toast.success('Process triggered', { id: toastId });\n          loadRuns();\n      } catch (err: any) {\n          toast.error(`Trigger failed: ${err.message}`, { id: toastId });\n      }\n  };\n\n  useEffect(() => {\n    loadRuns();\n    loadConfig();\n    \n    const channel = supabase.channel('payout_runs_updates')\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'payout_runs' }, () => loadRuns())\n      .subscribe();\n      \n    return () => { supabase.removeChannel(channel) };\n  }, []);\n\n  if (loading && runs.length === 0) return <div className=\"p-4 text-gray-400\">Loading runs...</div>;\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4 bg-black/20 p-4 rounded-lg border border-gray-800\">\n        <div>\n          <h2 className=\"text-xl font-bold text-white flex items-center gap-2\">\n            Automated Payout Runs\n            {configLoading ? (\n               <span className=\"text-xs text-gray-500 animate-pulse\">(Loading status...)</span>\n            ) : payoutsEnabled ? (\n               <span className=\"px-2 py-0.5 rounded-full bg-green-900/50 border border-green-500/50 text-green-400 text-xs flex items-center gap-1\">\n                 <PlayCircle className=\"w-3 h-3\" /> Active\n               </span>\n            ) : (\n               <span className=\"px-2 py-0.5 rounded-full bg-red-900/50 border border-red-500/50 text-red-400 text-xs flex items-center gap-1\">\n                 <PauseCircle className=\"w-3 h-3\" /> Paused\n               </span>\n            )}\n          </h2>\n          <p className=\"text-sm text-gray-400 mt-1\">\n            {payoutsEnabled \n              ? \"System is running normally. Scheduled payouts will execute on Mondays and Fridays.\" \n              : \"System is on hold. No new payout runs will be generated.\"}\n          </p>\n        </div>\n        \n        <div className=\"flex items-center gap-3\">\n            <button\n                onClick={togglePayouts}\n                disabled={configLoading}\n                className={`px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors ${\n                    payoutsEnabled \n                    ? 'bg-red-900/30 text-red-400 border border-red-500/30 hover:bg-red-900/50' \n                    : 'bg-green-900/30 text-green-400 border border-green-500/30 hover:bg-green-900/50'\n                }`}\n            >\n                {payoutsEnabled ? (\n                    <>\n                        <PauseCircle className=\"w-4 h-4\" /> Hold Payouts\n                    </>\n                ) : (\n                    <>\n                        <PlayCircle className=\"w-4 h-4\" /> Release Payouts\n                    </>\n                )}\n            </button>\n\n            <button \n                onClick={() => handleRetryRun('')}\n                className=\"px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-medium flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                disabled={!payoutsEnabled}\n                title={!payoutsEnabled ? \"Enable payouts to trigger manually\" : \"Trigger manual check\"}\n            >\n                <RefreshCw className=\"w-4 h-4\" /> Trigger Now\n            </button>\n        </div>\n      </div>\n\n      {runs.length === 0 ? (\n        <div className=\"p-8 border border-gray-800 rounded-lg text-center text-gray-500 bg-black/20\">\n          No automated payout runs found.\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          {runs.map(run => (\n            <div key={run.id} className=\"border border-gray-700 rounded-lg bg-[#111] overflow-hidden\">\n              <div \n                className=\"p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors\"\n                onClick={() => toggleExpand(run.id)}\n              >\n                <div className=\"flex items-center gap-4\">\n                    {run.status === 'completed' ? <CheckCircle className=\"text-green-500\" /> : \n                     run.status === 'failed' ? <XCircle className=\"text-red-500\" /> : \n                     <RefreshCw className=\"text-yellow-500 animate-spin\" />}\n                    \n                    <div>\n                        <div className=\"font-mono text-sm text-gray-400\">{run.id.slice(0, 8)}...</div>\n                        <div className=\"font-semibold text-white\">{new Date(run.started_at).toLocaleString()}</div>\n                    </div>\n                </div>\n                \n                <div className=\"flex items-center gap-6\">\n                    <div className=\"text-right\">\n                        <div className=\"text-xs text-gray-400\">Total</div>\n                        <div className=\"font-bold text-green-400\">${run.total_usd.toLocaleString()}</div>\n                    </div>\n                    <div className=\"text-right\">\n                        <div className=\"text-xs text-gray-400\">Payouts</div>\n                        <div className=\"font-bold text-white\">{run.total_payouts}</div>\n                    </div>\n                    {expandedRunId === run.id ? <ChevronUp /> : <ChevronDown />}\n                </div>\n              </div>\n              \n              {expandedRunId === run.id && (\n                <div className=\"border-t border-gray-800 bg-black/40 p-4\">\n                    <div className=\"flex justify-end gap-2 mb-4\">\n                        {run.status === 'failed' && (\n                            <button \n                                onClick={(e) => { e.stopPropagation(); handleRefundRun(run.id); }}\n                                className=\"px-3 py-1 bg-red-900/50 border border-red-700 text-red-200 rounded text-sm hover:bg-red-900\"\n                            >\n                                Refund Run\n                            </button>\n                        )}\n                        <div className=\"text-xs text-gray-500 font-mono self-center\">\n                            Batch: {run.paypal_batch_id || 'N/A'}\n                        </div>\n                    </div>\n                    \n                    {loadingDetails === run.id ? (\n                        <div className=\"text-center py-4 text-gray-500\">Loading details...</div>\n                    ) : (\n                        <div className=\"overflow-x-auto\">\n                            <table className=\"w-full text-sm text-left\">\n                                <thead className=\"text-xs text-gray-500 uppercase bg-black/20\">\n                                    <tr>\n                                        <th className=\"px-3 py-2\">User</th>\n                                        <th className=\"px-3 py-2\">PayPal Email</th>\n                                        <th className=\"px-3 py-2 text-right\">Amount</th>\n                                        <th className=\"px-3 py-2 text-center\">Status</th>\n                                        <th className=\"px-3 py-2\">Details</th>\n                                    </tr>\n                                </thead>\n                                <tbody className=\"divide-y divide-gray-800\">\n                                    {runDetails[run.id]?.map(item => (\n                                        <tr key={item.id} className=\"hover:bg-white/5\">\n                                            <td className=\"px-3 py-2\">\n                                                <div className=\"font-medium text-white\">{item.user_profiles?.username || 'Unknown'}</div>\n                                                <div className=\"text-xs text-gray-500\">{item.user_id.slice(0, 8)}...</div>\n                                            </td>\n                                            <td className=\"px-3 py-2 text-gray-300\">{item.paypal_email}</td>\n                                            <td className=\"px-3 py-2 text-right\">\n                                                <div className=\"text-green-400 font-bold\">${item.amount_usd}</div>\n                                                <div className=\"text-xs text-gray-500\">{item.amount_coins.toLocaleString()} coins</div>\n                                            </td>\n                                            <td className=\"px-3 py-2 text-center\">\n                                                <span className={`px-2 py-0.5 rounded text-xs ${\n                                                    item.status === 'success' ? 'bg-green-900 text-green-200' :\n                                                    item.status === 'failed' ? 'bg-red-900 text-red-200' :\n                                                    item.status === 'returned' ? 'bg-orange-900 text-orange-200' :\n                                                    'bg-blue-900 text-blue-200'\n                                                }`}>\n                                                    {item.status}\n                                                </span>\n                                            </td>\n                                            <td className=\"px-3 py-2 text-xs text-gray-500\">\n                                                {item.failure_reason && <div className=\"text-red-400\">{item.failure_reason}</div>}\n                                                <div>{item.paypal_payout_item_id || '-'}</div>\n                                            </td>\n                                        </tr>\n                                    ))}\n                                </tbody>\n                            </table>\n                        </div>\n                    )}\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\BroadcastLockDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"User"},"fix":{"range":[294,300],"text":""},"desc":"Remove unused variable \"User\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '../../../lib/supabase';\r\nimport { useAuthStore } from '../../../lib/store';\r\nimport { toast } from 'sonner';\r\nimport { \r\n  Lock, Unlock, Users, Shield, AlertTriangle, \r\n  CheckCircle, XCircle, RefreshCw, User, Crown, Settings\r\n} from 'lucide-react';\r\n\r\ninterface Broadcaster {\r\n  id: string;\r\n  username: string;\r\n  avatar_url: string | null;\r\n  has_broadcast_badge: boolean;\r\n  is_broadcast_locked: boolean;\r\n  is_admin: boolean;\r\n  role: string | null;\r\n  created_at: string;\r\n}\r\n\r\ninterface LockdownSettings {\r\n  is_enabled: boolean;\r\n  admin_id: string | null;\r\n  reason: string | null;\r\n  updated_at: string | null;\r\n}\r\n\r\ninterface BroadcasterLimits {\r\n  max_broadcasters: number;\r\n  current_count: number;\r\n}\r\n\r\nexport default function BroadcastLockDashboard() {\r\n  const { profile, user } = useAuthStore();\r\n  const [lockdownSettings, setLockdownSettings] = useState<LockdownSettings>({\r\n    is_enabled: false,\r\n    admin_id: null,\r\n    reason: null,\r\n    updated_at: null\r\n  });\r\n  const [broadcasterLimits, setBroadcasterLimits] = useState<BroadcasterLimits>({\r\n    max_broadcasters: 100,\r\n    current_count: 0\r\n  });\r\n  const [broadcasters, setBroadcasters] = useState<Broadcaster[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [lockingUser, setLockingUser] = useState<string | null>(null);\r\n  const [grantBadgeUser, setGrantBadgeUser] = useState<string | null>(null);\r\n  const [revokeBadgeUser, setRevokeBadgeUser] = useState<string | null>(null);\r\n  const [reason, setReason] = useState('');\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [editingLimit, setEditingLimit] = useState(false);\r\n  const [newLimit, setNewLimit] = useState(100);\r\n  const [updatingLimit, setUpdatingLimit] = useState(false);\r\n\r\n  const isAdmin = profile?.is_admin || profile?.role === 'admin';\r\n\r\n  const loadData = useCallback(async () => {\r\n    if (!isAdmin) return;\r\n    \r\n    setLoading(true);\r\n    try {\r\n      // Load lockdown settings\r\n      const { data: lockdownData } = await supabase\r\n        .from('broadcast_lockdown')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n       \r\n      if (lockdownData) {\r\n        setLockdownSettings({\r\n          is_enabled: lockdownData.is_enabled || false,\r\n          admin_id: lockdownData.admin_id,\r\n          reason: lockdownData.reason,\r\n          updated_at: lockdownData.updated_at\r\n        });\r\n      }\r\n\r\n      // Load broadcaster limits\r\n      const { data: limitData } = await supabase\r\n        .from('broadcaster_limits')\r\n        .select('*')\r\n        .order('updated_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n      \r\n      if (limitData) {\r\n        setBroadcasterLimits({\r\n          max_broadcasters: limitData.max_broadcasters || 100,\r\n          current_count: limitData.current_count || 0\r\n        });\r\n        setNewLimit(limitData.max_broadcasters || 100);\r\n      }\r\n\r\n      // Load broadcasters with badges\r\n      const { data: broadcasterData } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, avatar_url, has_broadcast_badge, is_broadcast_locked, is_admin, role, created_at')\r\n        .or('has_broadcast_badge.eq.true,is_admin.eq.true')\r\n        .order('created_at', { ascending: false })\r\n        .limit(200);\r\n\r\n      setBroadcasters(broadcasterData || []);\r\n    } catch (err) {\r\n      console.error('Error loading data:', err);\r\n      toast.error('Failed to load broadcast data');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [isAdmin]);\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n\r\n    // Subscribe to changes\r\n    const channel = supabase\r\n      .channel('broadcast_lock_changes')\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'broadcast_lockdown' }, loadData)\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'user_profiles' }, loadData)\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'broadcaster_limits' }, loadData)\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [loadData]);\r\n\r\n  const toggleGlobalLockdown = async () => {\r\n    if (!user) return;\r\n    \r\n    try {\r\n      const { error } = await supabase.rpc('toggle_broadcast_lockdown', {\r\n        p_admin_id: user.id,\r\n        p_enabled: !lockdownSettings.is_enabled,\r\n        p_reason: reason || null\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success(lockdownSettings.is_enabled \r\n        ? 'Broadcast lockdown DISABLED - Everyone can broadcast' \r\n        : 'Broadcast lockdown ENABLED - Only admins can broadcast');\r\n      \r\n      setReason('');\r\n      loadData();\r\n    } catch (err: any) {\r\n      console.error('Error toggling lockdown:', err);\r\n      toast.error(err.message || 'Failed to toggle lockdown');\r\n    }\r\n  };\r\n\r\n  const lockIndividualBroadcaster = async (userId: string, locked: boolean) => {\r\n    setLockingUser(userId);\r\n    try {\r\n      const { error } = await supabase.rpc('lock_broadcaster', {\r\n        p_user_id: userId,\r\n        p_locked: locked\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success(`${locked ? 'Locked' : 'Unlocked'} broadcaster`);\r\n      loadData();\r\n    } catch (err: any) {\r\n      console.error('Error locking broadcaster:', err);\r\n      toast.error(err.message || 'Failed to update broadcaster');\r\n    } finally {\r\n      setLockingUser(null);\r\n    }\r\n  };\r\n\r\n  const grantBadge = async (userId: string) => {\r\n    setGrantBadgeUser(userId);\r\n    try {\r\n      const { error } = await supabase.rpc('grant_broadcaster_badge', {\r\n        p_user_id: userId\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Broadcast badge granted');\r\n      loadData();\r\n    } catch (err: any) {\r\n      console.error('Error granting badge:', err);\r\n      toast.error(err.message || 'Failed to grant badge');\r\n    } finally {\r\n      setGrantBadgeUser(null);\r\n    }\r\n  };\r\n\r\n  const revokeBadge = async (userId: string) => {\r\n    setRevokeBadgeUser(userId);\r\n    try {\r\n      const { error } = await supabase.rpc('revoke_broadcaster_badge', {\r\n        p_user_id: userId\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Broadcast badge revoked');\r\n      loadData();\r\n    } catch (err: any) {\r\n      console.error('Error revoking badge:', err);\r\n      toast.error(err.message || 'Failed to revoke badge');\r\n    } finally {\r\n      setRevokeBadgeUser(null);\r\n    }\r\n  };\r\n\r\n  const updateMaxBroadcasters = async () => {\r\n    if (newLimit < 1 || newLimit > 500) {\r\n      toast.error('Limit must be between 1 and 500');\r\n      return;\r\n    }\r\n    \r\n    setUpdatingLimit(true);\r\n    try {\r\n      const { error } = await supabase\r\n        .from('broadcaster_limits')\r\n        .upsert({\r\n          max_broadcasters: newLimit,\r\n          updated_at: new Date().toISOString()\r\n        }, { onConflict: 'id' });\r\n      \r\n      if (error) throw error;\r\n      \r\n      toast.success(`Max broadcasters updated to ${newLimit}`);\r\n      setEditingLimit(false);\r\n      loadData();\r\n    } catch (err: any) {\r\n      console.error('Error updating limit:', err);\r\n      toast.error(err.message || 'Failed to update limit');\r\n    } finally {\r\n      setUpdatingLimit(false);\r\n    }\r\n  };\r\n\r\n  if (!isAdmin) {\r\n    return (\r\n      <div className=\"p-6 text-center text-gray-400\">\r\n        <Shield className=\"w-12 h-12 mx-auto mb-4 text-gray-500\" />\r\n        <p>Access denied. Admin privileges required.</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const filteredBroadcasters = broadcasters.filter(b => \r\n    b.username?.toLowerCase().includes(searchTerm.toLowerCase()) || false\r\n  );\r\n\r\n  const badgeCount = broadcasters.filter(b => b.has_broadcast_badge).length;\r\n  const lockedCount = broadcasters.filter(b => b.is_broadcast_locked).length;\r\n  const adminCount = broadcasters.filter(b => b.is_admin || b.role === 'admin').length;\r\n  const isAtLimit = broadcasterLimits.current_count >= broadcasterLimits.max_broadcasters;\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold text-white flex items-center gap-3\">\r\n            <Lock className=\"w-6 h-6 text-purple-400\" />\r\n            Broadcast Lock Control\r\n          </h2>\r\n          <p className=\"text-gray-400 text-sm mt-1\">\r\n            Manage global broadcast locks and individual broadcaster permissions\r\n          </p>\r\n        </div>\r\n        <button\r\n          onClick={loadData}\r\n          className=\"p-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors\"\r\n        >\r\n          <RefreshCw className=\"w-4 h-4 text-gray-400\" />\r\n        </button>\r\n      </div>\r\n\r\n      {/* Stats */}\r\n      <div className=\"grid grid-cols-5 gap-4\">\r\n        <div className=\"bg-[#1A1A1A] border border-gray-700 rounded-xl p-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className={`p-2 rounded-lg ${lockdownSettings.is_enabled ? 'bg-red-500/20' : 'bg-green-500/20'}`}>\r\n              {lockdownSettings.is_enabled ? (\r\n                <Lock className=\"w-5 h-5 text-red-400\" />\r\n              ) : (\r\n                <Unlock className=\"w-5 h-5 text-green-400\" />\r\n              )}\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs text-gray-400\">Global Lock</p>\r\n              <p className={`font-bold ${lockdownSettings.is_enabled ? 'text-red-400' : 'text-green-400'}`}>\r\n                {lockdownSettings.is_enabled ? 'ENABLED' : 'DISABLED'}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-[#1A1A1A] border border-gray-700 rounded-xl p-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"p-2 rounded-lg bg-purple-500/20\">\r\n              <Crown className=\"w-5 h-5 text-purple-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs text-gray-400\">Authorized</p>\r\n              <p className=\"font-bold text-purple-400\">{badgeCount}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-[#1A1A1A] border border-gray-700 rounded-xl p-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"p-2 rounded-lg bg-red-500/20\">\r\n              <Lock className=\"w-5 h-5 text-red-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs text-gray-400\">Locked Users</p>\r\n              <p className=\"font-bold text-red-400\">{lockedCount}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-[#1A1A1A] border border-gray-700 rounded-xl p-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"p-2 rounded-lg bg-blue-500/20\">\r\n              <Shield className=\"w-5 h-5 text-blue-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs text-gray-400\">Admins</p>\r\n              <p className=\"font-bold text-blue-400\">{adminCount}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className={`bg-[#1A1A1A] border rounded-xl p-4 ${isAtLimit ? 'border-yellow-500/50' : 'border-gray-700'}`}>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className={`p-2 rounded-lg ${isAtLimit ? 'bg-yellow-500/20' : 'bg-green-500/20'}`}>\r\n              <Users className={`w-5 h-5 ${isAtLimit ? 'text-yellow-400' : 'text-green-400'}`} />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs text-gray-400\">Slots Used</p>\r\n              <p className={`font-bold ${isAtLimit ? 'text-yellow-400' : 'text-green-400'}`}>\r\n                {broadcasterLimits.current_count} / {broadcasterLimits.max_broadcasters}\r\n              </p>\r\n              {isAtLimit && (\r\n                <p className=\"text-xs text-yellow-500\">FULL</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Global Lockdown Control */}\r\n      <div className=\"bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-xl border border-purple-500/50 p-6\">\r\n        <div className=\"flex items-start justify-between mb-4\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className={`p-4 rounded-xl ${lockdownSettings.is_enabled ? 'bg-red-500/20' : 'bg-green-500/20'}`}>\r\n              {lockdownSettings.is_enabled ? (\r\n                <Lock className=\"w-8 h-8 text-red-400\" />\r\n              ) : (\r\n                <Unlock className=\"w-8 h-8 text-green-400\" />\r\n              )}\r\n            </div>\r\n            <div>\r\n              <h3 className=\"text-xl font-bold text-white\">\r\n                Global Broadcast Lockdown\r\n              </h3>\r\n              <p className=\"text-gray-300 mt-1\">\r\n                {lockdownSettings.is_enabled ? (\r\n                  <>\r\n                    <span className=\"text-red-400 font-semibold\">üî¥ LOCKDOWN ACTIVE</span>\r\n                    <br />\r\n                    Only administrators can create broadcasts. All other users are blocked.\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <span className=\"text-green-400 font-semibold\">üü¢ NORMAL MODE</span>\r\n                    <br />\r\n                    All authorized users can broadcast normally.\r\n                  </>\r\n                )}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {lockdownSettings.is_enabled && lockdownSettings.reason && (\r\n          <div className=\"bg-red-500/10 border border-red-500/30 rounded-lg p-3 mb-4\">\r\n            <p className=\"text-sm text-red-300\">\r\n              <AlertTriangle className=\"w-4 h-4 inline mr-2\" />\r\n              Reason: {lockdownSettings.reason}\r\n            </p>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"flex items-center gap-4\">\r\n          <input\r\n            type=\"text\"\r\n            value={reason}\r\n            onChange={(e) => setReason(e.target.value)}\r\n            placeholder=\"Reason for lockdown (optional)\"\r\n            className=\"flex-1 bg-black/40 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-purple-400 focus:outline-none\"\r\n          />\r\n          <button\r\n            onClick={toggleGlobalLockdown}\r\n            disabled={loading}\r\n            className={`px-6 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 ${\r\n              lockdownSettings.is_enabled\r\n                ? 'bg-green-600 hover:bg-green-500 text-white'\r\n                : 'bg-red-600 hover:bg-red-500 text-white'\r\n            } disabled:opacity-50`}\r\n          >\r\n            {loading ? (\r\n              <RefreshCw className=\"w-4 h-4 animate-spin\" />\r\n            ) : lockdownSettings.is_enabled ? (\r\n              <>\r\n                <Unlock className=\"w-4 h-4\" />\r\n                Disable Lockdown\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Lock className=\"w-4 h-4\" />\r\n                Enable Lockdown\r\n              </>\r\n            )}\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Broadcaster Limit Control */}\r\n      <div className=\"bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-xl border border-blue-500/50 p-6\">\r\n        <div className=\"flex items-start justify-between mb-4\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"p-4 rounded-xl bg-blue-500/20\">\r\n              <Settings className=\"w-8 h-8 text-blue-400\" />\r\n            </div>\r\n            <div>\r\n              <h3 className=\"text-xl font-bold text-white\">\r\n                Broadcaster Limit\r\n              </h3>\r\n              <p className=\"text-gray-300 mt-1\">\r\n                Maximum number of users allowed to broadcast: <span className=\"text-blue-400 font-bold\">{broadcasterLimits.max_broadcasters}</span>\r\n              </p>\r\n              <p className=\"text-gray-400 text-sm mt-1\">\r\n                Currently <span className={isAtLimit ? 'text-yellow-400 font-bold' : 'text-green-400'}>\r\n                  {broadcasterLimits.current_count}\r\n                </span> of {broadcasterLimits.max_broadcasters} slots used\r\n              </p>\r\n              {isAtLimit && (\r\n                <div className=\"mt-2 flex items-center gap-2 text-yellow-400\">\r\n                  <AlertTriangle className=\"w-4 h-4\" />\r\n                  <span className=\"text-sm\">Broadcasting limit reached - no new badges can be granted</span>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {editingLimit ? (\r\n          <div className=\"flex items-center gap-4\">\r\n            <input\r\n              type=\"number\"\r\n              value={newLimit}\r\n              onChange={(e) => setNewLimit(parseInt(e.target.value) || 1)}\r\n              min={1}\r\n              max={500}\r\n              className=\"w-24 bg-black/40 border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-blue-400 focus:outline-none\"\r\n            />\r\n            <button\r\n              onClick={updateMaxBroadcasters}\r\n              disabled={updatingLimit}\r\n              className=\"px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold disabled:opacity-50\"\r\n            >\r\n              {updatingLimit ? <RefreshCw className=\"w-4 h-4 animate-spin\" /> : 'Save'}\r\n            </button>\r\n            <button\r\n              onClick={() => setEditingLimit(false)}\r\n              className=\"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-semibold\"\r\n            >\r\n              Cancel\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <button\r\n            onClick={() => setEditingLimit(true)}\r\n            className=\"px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold flex items-center gap-2\"\r\n          >\r\n            <Settings className=\"w-4 h-4\" />\r\n            Adjust Limit\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Broadcaster List */}\r\n      <div className=\"bg-[#1A1A1A] border border-gray-700 rounded-xl p-6\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <h3 className=\"text-lg font-bold text-white flex items-center gap-2\">\r\n            <Users className=\"w-5 h-5 text-purple-400\" />\r\n            Broadcasters & Permissions\r\n          </h3>\r\n          <input\r\n            type=\"text\"\r\n            value={searchTerm}\r\n            onChange={(e) => setSearchTerm(e.target.value)}\r\n            placeholder=\"Search broadcasters...\"\r\n            className=\"bg-black/40 border border-gray-600 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:border-purple-400 focus:outline-none\"\r\n          />\r\n        </div>\r\n\r\n        {loading ? (\r\n          <div className=\"text-center py-8 text-gray-400\">\r\n            <RefreshCw className=\"w-8 h-8 mx-auto animate-spin mb-2\" />\r\n            Loading broadcasters...\r\n          </div>\r\n        ) : filteredBroadcasters.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-400\">\r\n            No broadcasters found\r\n          </div>\r\n        ) : (\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"text-left text-xs text-gray-400 uppercase tracking-wider\">\r\n                  <th className=\"pb-3 pl-2\">User</th>\r\n                  <th className=\"pb-3\">Status</th>\r\n                  <th className=\"pb-3\">Badge</th>\r\n                  <th className=\"pb-3 text-right pr-2\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"divide-y divide-gray-800\">\r\n                {filteredBroadcasters.map((broadcaster) => (\r\n                  <tr key={broadcaster.id} className=\"hover:bg-gray-800/50\">\r\n                    <td className=\"py-3 pl-2\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-8 h-8 rounded-full bg-purple-900/30 border border-purple-500/20 overflow-hidden\">\r\n                          {broadcaster.avatar_url ? (\r\n                            <img src={broadcaster.avatar_url} alt=\"\" className=\"w-full h-full object-cover\" />\r\n                          ) : (\r\n                            <div className=\"w-full h-full flex items-center justify-center text-purple-300 font-bold\">\r\n                              {broadcaster.username?.charAt(0).toUpperCase()}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <div>\r\n                          <p className=\"font-medium text-white\">{broadcaster.username}</p>\r\n                          <p className=\"text-xs text-gray-500\">{broadcaster.id.slice(0, 8)}...</p>\r\n                        </div>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"py-3\">\r\n                      {broadcaster.is_broadcast_locked ? (\r\n                        <span className=\"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-500/20 text-red-400 text-xs font-medium\">\r\n                          <XCircle className=\"w-3 h-3\" />\r\n                          Locked\r\n                        </span>\r\n                      ) : (\r\n                        <span className=\"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-medium\">\r\n                          <CheckCircle className=\"w-3 h-3\" />\r\n                          Active\r\n                        </span>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"py-3\">\r\n                      {broadcaster.has_broadcast_badge ? (\r\n                        <span className=\"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-500/20 text-purple-400 text-xs font-medium\">\r\n                          <Crown className=\"w-3 h-3\" />\r\n                          Has Badge\r\n                        </span>\r\n                      ) : (\r\n                        <span className=\"text-gray-500 text-xs\">No Badge</span>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"py-3 text-right pr-2\">\r\n                      <div className=\"flex items-center justify-end gap-2\">\r\n                        {broadcaster.is_admin || broadcaster.role === 'admin' ? (\r\n                          <span className=\"text-xs text-blue-400 px-2 py-1 bg-blue-500/10 rounded\">\r\n                            Admin\r\n                          </span>\r\n                        ) : (\r\n                          <>\r\n                            <button\r\n                              onClick={() => lockIndividualBroadcaster(\r\n                                broadcaster.id, \r\n                                !broadcaster.is_broadcast_locked\r\n                              )}\r\n                              disabled={lockingUser === broadcaster.id}\r\n                              className={`px-3 py-1 rounded text-xs font-medium transition-colors ${\r\n                                broadcaster.is_broadcast_locked\r\n                                  ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30'\r\n                                  : 'bg-red-500/20 text-red-400 hover:bg-red-500/30'\r\n                              } disabled:opacity-50`}\r\n                            >\r\n                              {lockingUser === broadcaster.id ? (\r\n                                <RefreshCw className=\"w-3 h-3 animate-spin\" />\r\n                              ) : broadcaster.is_broadcast_locked ? (\r\n                                'Unlock'\r\n                              ) : (\r\n                                'Lock'\r\n                              )}\r\n                            </button>\r\n                            \r\n                            {broadcaster.has_broadcast_badge ? (\r\n                              <button\r\n                                onClick={() => revokeBadge(broadcaster.id)}\r\n                                disabled={revokeBadgeUser === broadcaster.id}\r\n                                className=\"px-3 py-1 rounded text-xs font-medium bg-red-500/20 text-red-400 hover:bg-red-500/30 disabled:opacity-50\"\r\n                              >\r\n                                {revokeBadgeUser === broadcaster.id ? (\r\n                                  <RefreshCw className=\"w-3 h-3 animate-spin\" />\r\n                                ) : (\r\n                                  'Revoke Badge'\r\n                                )}\r\n                              </button>\r\n                            ) : (\r\n                              <button\r\n                                onClick={() => grantBadge(broadcaster.id)}\r\n                                disabled={grantBadgeUser === broadcaster.id || isAtLimit}\r\n                                className=\"px-3 py-1 rounded text-xs font-medium bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 disabled:opacity-50\"\r\n                              >\r\n                                {grantBadgeUser === broadcaster.id ? (\r\n                                  <RefreshCw className=\"w-3 h-3 animate-spin\" />\r\n                                ) : isAtLimit ? (\r\n                                  'Limit Reached'\r\n                                ) : (\r\n                                  'Grant Badge'\r\n                                )}\r\n                              </button>\r\n                            )}\r\n                          </>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\BroadcastLockTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":9,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[194,201],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Ban' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Ban"},"fix":{"range":[263,268],"text":""},"desc":"Remove unused variable \"Ban\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'count' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":36,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":26},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUsers'. Either include it or remove the dependency array.","line":61,"column":6,"nodeType":"ArrayExpression","endLine":61,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [loadUsers, page, search]","fix":{"range":[1989,2003],"text":"[loadUsers, page, search]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":86,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":86,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":110,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { useBroadcastLockdown } from '../../../lib/hooks/useBroadcastLockdown';\nimport { supabase } from '../../../lib/supabase';\nimport { \n  Shield, ShieldAlert, ShieldCheck, Search, Lock, Unlock, \n  BadgeCheck, Ban, Save, RefreshCw, ChevronLeft, ChevronRight \n} from 'lucide-react';\nimport { toast } from 'sonner';\n\nexport default function BroadcastLockTab() {\n  const { settings, maxBroadcasters, loading: hookLoading, updateSettings, updateMaxBroadcasters } = useBroadcastLockdown();\n  \n  // Local state for table\n  const [users, setUsers] = useState<any[]>([]);\n  const [search, setSearch] = useState('');\n  const [page, setPage] = useState(0);\n  const [loadingUsers, setLoadingUsers] = useState(false);\n  const [broadcasterCount, setBroadcasterCount] = useState(0);\n  const [newLimit, setNewLimit] = useState(maxBroadcasters);\n\n  useEffect(() => {\n    setNewLimit(maxBroadcasters);\n  }, [maxBroadcasters]);\n\n  const loadUsers = async () => {\n    setLoadingUsers(true);\n    try {\n      let query = supabase\n        .from('user_profiles')\n        .select('id, username, avatar_url, role, is_broadcast_locked, has_broadcast_badge', { count: 'exact' });\n\n      if (search) {\n        query = query.ilike('username', `%${search}%`);\n      }\n\n      const { data, count, error } = await query\n        .order('created_at', { ascending: false })\n        .range(page * 20, (page + 1) * 20 - 1);\n\n      if (error) throw error;\n      setUsers(data || []);\n      \n      // Get total badge count\n      const { count: badgeCount } = await supabase\n        .from('user_profiles')\n        .select('id', { count: 'exact', head: true })\n        .eq('has_broadcast_badge', true);\n        \n      setBroadcasterCount(badgeCount || 0);\n\n    } catch (err: any) {\n      console.error('Error loading users:', err);\n      toast.error('Failed to load users');\n    } finally {\n      setLoadingUsers(false);\n    }\n  };\n\n  useEffect(() => {\n    loadUsers();\n  }, [page, search]);\n\n  const handleToggleLockdown = async () => {\n    await updateSettings({\n      ...settings,\n      enabled: !settings.enabled,\n      admin_broadcast_room: settings.admin_broadcast_room || null\n    });\n  };\n\n  const handleUpdateLimit = async () => {\n    await updateMaxBroadcasters(newLimit);\n  };\n\n  const toggleUserLock = async (userId: string, currentStatus: boolean) => {\n    try {\n      const { error } = await supabase\n        .from('user_profiles')\n        .update({ is_broadcast_locked: !currentStatus })\n        .eq('id', userId);\n\n      if (error) throw error;\n      \n      setUsers(users.map(u => u.id === userId ? { ...u, is_broadcast_locked: !currentStatus } : u));\n      toast.success(`User ${!currentStatus ? 'locked' : 'unlocked'}`);\n    } catch (err: any) {\n      toast.error('Failed to update user lock');\n    }\n  };\n\n  const toggleUserBadge = async (userId: string, currentStatus: boolean) => {\n    try {\n        // If granting, check limit locally first for better UX (though RPC checks too if we used it)\n        if (!currentStatus && broadcasterCount >= maxBroadcasters) {\n            // Warn but allow admin to override? Or strictly enforce?\n            // Admin should be able to override, but let's warn.\n            toast.warning('Broadcaster limit reached! Increasing count beyond limit.');\n        }\n\n      const { error } = await supabase\n        .from('user_profiles')\n        .update({ has_broadcast_badge: !currentStatus })\n        .eq('id', userId);\n\n      if (error) throw error;\n      \n      setUsers(users.map(u => u.id === userId ? { ...u, has_broadcast_badge: !currentStatus } : u));\n      setBroadcasterCount(prev => !currentStatus ? prev + 1 : prev - 1);\n      toast.success(`Badge ${!currentStatus ? 'granted' : 'removed'}`);\n    } catch (err: any) {\n      toast.error('Failed to update badge');\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-col md:flex-row gap-6\">\n        {/* Global Lockdown Panel */}\n        <div className=\"flex-1 bg-slate-900 border border-slate-700 rounded-xl p-6\">\n            <div className=\"flex items-center gap-3 mb-4\">\n                {settings.enabled ? (\n                    <ShieldAlert className=\"w-8 h-8 text-red-500\" />\n                ) : (\n                    <ShieldCheck className=\"w-8 h-8 text-green-500\" />\n                )}\n                <div>\n                    <h2 className=\"text-xl font-bold text-white\">Global Broadcast Lock</h2>\n                    <p className=\"text-sm text-gray-400\">\n                        {settings.enabled ? 'Only admins can broadcast.' : 'Authorized users can broadcast.'}\n                    </p>\n                </div>\n            </div>\n            \n            <button\n                onClick={handleToggleLockdown}\n                disabled={hookLoading}\n                className={`w-full py-3 rounded-lg font-bold text-white transition-all ${\n                    settings.enabled \n                    ? 'bg-green-600 hover:bg-green-700' \n                    : 'bg-red-600 hover:bg-red-700'\n                }`}\n            >\n                {settings.enabled ? 'Disable Lockdown' : 'Enable Lockdown'}\n            </button>\n        </div>\n\n        {/* Broadcaster Limit Panel */}\n        <div className=\"flex-1 bg-slate-900 border border-slate-700 rounded-xl p-6\">\n            <div className=\"flex items-center gap-3 mb-4\">\n                <BadgeCheck className=\"w-8 h-8 text-purple-500\" />\n                <div>\n                    <h2 className=\"text-xl font-bold text-white\">Broadcaster Limit</h2>\n                    <p className=\"text-sm text-gray-400\">\n                        Current: <span className=\"text-purple-400 font-bold\">{broadcasterCount}</span> / {maxBroadcasters} Badges\n                    </p>\n                </div>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n                <input \n                    type=\"number\" \n                    value={newLimit}\n                    onChange={(e) => setNewLimit(parseInt(e.target.value))}\n                    className=\"flex-1 bg-black border border-slate-600 rounded-lg px-4 py-2 text-white\"\n                />\n                <button\n                    onClick={handleUpdateLimit}\n                    disabled={hookLoading}\n                    className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex items-center gap-2\"\n                >\n                    <Save className=\"w-4 h-4\" /> Save\n                </button>\n            </div>\n            <div className=\"w-full bg-slate-800 h-2 mt-4 rounded-full overflow-hidden\">\n                <div \n                    className=\"bg-purple-500 h-full transition-all duration-500\"\n                    style={{ width: `${Math.min((broadcasterCount / maxBroadcasters) * 100, 100)}%` }}\n                />\n            </div>\n        </div>\n      </div>\n\n      {/* User Management Table */}\n      <div className=\"bg-slate-900 border border-slate-700 rounded-xl overflow-hidden\">\n        <div className=\"p-4 border-b border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4\">\n            <h3 className=\"text-lg font-bold text-white flex items-center gap-2\">\n                <Search className=\"w-5 h-5 text-blue-400\" />\n                Manage Broadcasters\n            </h3>\n            <div className=\"flex items-center gap-2 w-full md:w-auto\">\n                <input\n                    placeholder=\"Search username...\"\n                    value={search}\n                    onChange={(e) => setSearch(e.target.value)}\n                    className=\"bg-black border border-slate-600 rounded-lg px-4 py-2 text-white text-sm w-full md:w-64\"\n                />\n                <button \n                    onClick={() => loadUsers()}\n                    className=\"p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-white\"\n                >\n                    <RefreshCw className={`w-4 h-4 ${loadingUsers ? 'animate-spin' : ''}`} />\n                </button>\n            </div>\n        </div>\n\n        <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-left text-sm text-gray-400\">\n                <thead className=\"bg-slate-800 text-gray-200 uppercase font-bold\">\n                    <tr>\n                        <th className=\"px-6 py-3\">User</th>\n                        <th className=\"px-6 py-3\">Role</th>\n                        <th className=\"px-6 py-3 text-center\">Badge</th>\n                        <th className=\"px-6 py-3 text-center\">Lock Status</th>\n                    </tr>\n                </thead>\n                <tbody className=\"divide-y divide-slate-700\">\n                    {users.map((user) => (\n                        <tr key={user.id} className=\"hover:bg-slate-800/50 transition-colors\">\n                            <td className=\"px-6 py-4 flex items-center gap-3\">\n                                <img \n                                    src={user.avatar_url || 'https://via.placeholder.com/40'} \n                                    className=\"w-8 h-8 rounded-full bg-slate-700\"\n                                    alt={user.username}\n                                />\n                                <span className=\"font-medium text-white\">{user.username}</span>\n                            </td>\n                            <td className=\"px-6 py-4\">\n                                <span className={`px-2 py-1 rounded text-xs font-bold ${\n                                    user.role === 'admin' ? 'bg-red-900/50 text-red-400' : 'bg-slate-700 text-gray-300'\n                                }`}>\n                                    {user.role}\n                                </span>\n                            </td>\n                            <td className=\"px-6 py-4 text-center\">\n                                <button\n                                    onClick={() => toggleUserBadge(user.id, user.has_broadcast_badge)}\n                                    className={`p-2 rounded-lg transition-colors ${\n                                        user.has_broadcast_badge \n                                        ? 'bg-purple-900/30 text-purple-400 hover:bg-purple-900/50' \n                                        : 'bg-slate-800 text-slate-500 hover:bg-slate-700'\n                                    }`}\n                                    title={user.has_broadcast_badge ? \"Revoke Badge\" : \"Grant Badge\"}\n                                >\n                                    {user.has_broadcast_badge ? <BadgeCheck className=\"w-5 h-5\" /> : <BadgeCheck className=\"w-5 h-5 opacity-50\" />}\n                                </button>\n                            </td>\n                            <td className=\"px-6 py-4 text-center\">\n                                <button\n                                    onClick={() => toggleUserLock(user.id, user.is_broadcast_locked)}\n                                    className={`p-2 rounded-lg transition-colors ${\n                                        user.is_broadcast_locked \n                                        ? 'bg-red-900/30 text-red-400 hover:bg-red-900/50' \n                                        : 'bg-green-900/30 text-green-400 hover:bg-green-900/50'\n                                    }`}\n                                    title={user.is_broadcast_locked ? \"Unlock User\" : \"Lock User\"}\n                                >\n                                    {user.is_broadcast_locked ? <Lock className=\"w-5 h-5\" /> : <Unlock className=\"w-5 h-5\" />}\n                                </button>\n                            </td>\n                        </tr>\n                    ))}\n                    {users.length === 0 && !loadingUsers && (\n                        <tr>\n                            <td colSpan={4} className=\"px-6 py-8 text-center text-gray-500\">\n                                No users found.\n                            </td>\n                        </tr>\n                    )}\n                </tbody>\n            </table>\n        </div>\n\n        <div className=\"p-4 border-t border-slate-700 flex justify-between items-center\">\n            <button\n                disabled={page === 0}\n                onClick={() => setPage(p => p - 1)}\n                className=\"px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 disabled:opacity-50 text-white\"\n            >\n                <ChevronLeft className=\"w-5 h-5\" />\n            </button>\n            <span className=\"text-gray-400\">Page {page + 1}</span>\n            <button\n                disabled={users.length < 20}\n                onClick={() => setPage(p => p + 1)}\n                className=\"px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 disabled:opacity-50 text-white\"\n            >\n                <ChevronRight className=\"w-5 h-5\" />\n            </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\BroadcastLockdownControl.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[132,139],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":25,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":19},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":82,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3002,3208],"text":"\r\n          When enabled, regular users will see a message on the Go Live page and their broadcast button will be disabled.\r\n          They can still join and participate in the admin&apos;s broadcast.\r\n        "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3002,3208],"text":"\r\n          When enabled, regular users will see a message on the Go Live page and their broadcast button will be disabled.\r\n          They can still join and participate in the admin&lsquo;s broadcast.\r\n        "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3002,3208],"text":"\r\n          When enabled, regular users will see a message on the Go Live page and their broadcast button will be disabled.\r\n          They can still join and participate in the admin&#39;s broadcast.\r\n        "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3002,3208],"text":"\r\n          When enabled, regular users will see a message on the Go Live page and their broadcast button will be disabled.\r\n          They can still join and participate in the admin&rsquo;s broadcast.\r\n        "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useBroadcastLockdown } from '../../../lib/hooks/useBroadcastLockdown';\r\nimport { Shield, ShieldAlert, ShieldCheck } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\n\r\nexport default function BroadcastLockdownControl() {\r\n  const { settings, loading, updateSettings } = useBroadcastLockdown();\r\n  const [isUpdating, setIsUpdating] = useState(false);\r\n\r\n  const handleToggleLockdown = async () => {\r\n    setIsUpdating(true);\r\n    try {\r\n      const success = await updateSettings({\r\n        ...settings,\r\n        enabled: !settings.enabled,\r\n        admin_broadcast_room: settings.admin_broadcast_room || null\r\n      });\r\n      if (success) {\r\n        toast.success(\r\n          settings.enabled\r\n            ? 'Broadcast Lockdown disabled - everyone can now broadcast!'\r\n            : 'Broadcast Lockdown enabled - only admins can broadcast!'\r\n        );\r\n      }\r\n    } catch (error) {\r\n      toast.error('Failed to update broadcast lockdown settings');\r\n    } finally {\r\n      setIsUpdating(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-[#1a003a] border border-purple-700/40 rounded-xl p-6 space-y-4\">\r\n      <div className=\"flex items-center gap-3\">\r\n        {settings.enabled ? (\r\n          <ShieldAlert className=\"w-6 h-6 text-red-400\" />\r\n        ) : (\r\n          <ShieldCheck className=\"w-6 h-6 text-green-400\" />\r\n        )}\r\n        <div>\r\n          <h3 className=\"text-lg font-semibold text-white\">Broadcast Lockdown Control</h3>\r\n          <p className=\"text-sm text-gray-400\">\r\n            {settings.enabled\r\n              ? 'Only admins can start broadcasts'\r\n              : 'Everyone can start broadcasts'}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex items-center justify-between pt-2\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <span className={`text-sm font-medium ${settings.enabled ? 'text-red-400' : 'text-green-400'}`}>\r\n            {settings.enabled ? 'üî¥ Lockdown Active' : 'üü¢ Normal Mode'}\r\n          </span>\r\n        </div>\r\n\r\n        <button\r\n          onClick={handleToggleLockdown}\r\n          disabled={isUpdating || loading}\r\n          className={`px-4 py-2 rounded-lg font-medium transition-all duration-200 ${\r\n            settings.enabled\r\n              ? 'bg-green-600 hover:bg-green-500 text-white'\r\n              : 'bg-red-600 hover:bg-red-500 text-white'\r\n          } disabled:opacity-50 disabled:cursor-not-allowed`}\r\n        >\r\n          {isUpdating ? (\r\n            <span className=\"flex items-center gap-2\">\r\n              <div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\r\n              Updating...\r\n            </span>\r\n          ) : settings.enabled ? (\r\n            'Disable Lockdown'\r\n          ) : (\r\n            'Enable Lockdown'\r\n          )}\r\n        </button>\r\n      </div>\r\n\r\n      {settings.enabled && (\r\n        <p className=\"text-xs text-gray-500 pt-2 border-t border-purple-700/30\">\r\n          When enabled, regular users will see a message on the Go Live page and their broadcast button will be disabled.\r\n          They can still join and participate in the admin's broadcast.\r\n        </p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\CityControlsHealth.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\CitySummaryBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\CreateSchedulePanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\CreatorSwitchApprovals.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\EarningsTaxOverview.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setMonthlyData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":44,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":37},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has a missing dependency: 'selectedYear'. Either include it or remove the dependency array.","line":105,"column":6,"nodeType":"ArrayExpression","endLine":105,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [selectedYear]","fix":{"range":[3841,3843],"text":"[selectedYear]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has unnecessary dependencies: 'loadCreatorsList' and 'loadMonthlyEarnings'. Either exclude them or remove the dependency array. Outer scope values like 'loadMonthlyEarnings' aren't valid dependencies because mutating them doesn't re-render the component.","line":122,"column":6,"nodeType":"ArrayExpression","endLine":122,"endColumn":65,"suggestions":[{"desc":"Update the dependencies array to be: [loadDashboardCards]","fix":{"range":[4285,4344],"text":"[loadDashboardCards]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { \r\n  DollarSign, Users, FileText, TrendingUp, Filter, \r\n  Calendar, X, Download, ExternalLink\r\n} from 'lucide-react'\r\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts'\r\n\r\ninterface EarningsData {\r\n  totalLiability: number\r\n  creatorsOverThreshold: number\r\n  totalPayouts: number\r\n  platformKept: number\r\n  forms1099Sent: number\r\n}\r\n\r\ninterface MonthlyEarnings {\r\n  month: string\r\n  total_usd: number\r\n  creator_count: number\r\n}\r\n\r\ninterface CreatorEarnings {\r\n  user_id: string\r\n  username: string\r\n  total_earnings_usd: number\r\n  reached_threshold: boolean\r\n  form_1099_generated: boolean\r\n  documents_status: string\r\n  country?: string\r\n  monthly_breakdown?: { month: string; earnings: number }[]\r\n}\r\n\r\nexport default function EarningsTaxOverview() {\r\n  const [loading, setLoading] = useState(false)\r\n  const [earningsData, setEarningsData] = useState<EarningsData>({\r\n    totalLiability: 0,\r\n    creatorsOverThreshold: 0,\r\n    totalPayouts: 0,\r\n    platformKept: 0,\r\n    forms1099Sent: 0\r\n  })\r\n  const [monthlyData, setMonthlyData] = useState<MonthlyEarnings[]>([])\r\n  const [creators, setCreators] = useState<CreatorEarnings[]>([])\r\n  const [filteredCreators, setFilteredCreators] = useState<CreatorEarnings[]>([])\r\n  const [selectedCreator, setSelectedCreator] = useState<CreatorEarnings | null>(null)\r\n  const [showOnlyOver600, setShowOnlyOver600] = useState(false)\r\n  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear())\r\n  const [sortOrder, setSortOrder] = useState<'high' | 'low'>('high')\r\n\r\n  const loadDashboardCards = React.useCallback(async () => {\r\n    try {\r\n      // 1. Get creators tax status for selected year\r\n      const { data: taxData, error: taxError } = await supabase\r\n        .from('view_admin_creator_tax_status')\r\n        .select('*')\r\n        .eq('tax_year', selectedYear)\r\n\r\n      if (taxError) throw taxError\r\n\r\n      // 2. Get payouts for selected year\r\n      const startDate = new Date(selectedYear, 0, 1).toISOString()\r\n      const endDate = new Date(selectedYear, 11, 31, 23, 59, 59).toISOString()\r\n      \r\n      const { data: payouts } = await supabase\r\n        .from('payout_requests')\r\n        .select('cash_amount')\r\n        .eq('status', 'paid')\r\n        .gte('created_at', startDate)\r\n        .lte('created_at', endDate)\r\n\r\n      // Calculate Metrics\r\n      const totalLiability = taxData?.reduce((sum, item) => sum + (Number(item.total_earnings_usd) || 0), 0) || 0\r\n      const creatorsOverThreshold = taxData?.filter(item => item.is_irs_threshold_met).length || 0\r\n      const totalPayouts = payouts?.reduce((sum, p) => sum + (Number(p.cash_amount) || 0), 0) || 0\r\n      const platformKept = Math.max(0, totalLiability - totalPayouts)\r\n      const forms1099Sent = taxData?.filter(item => item.has_tax_form).length || 0\r\n\r\n      setEarningsData({\r\n        totalLiability,\r\n        creatorsOverThreshold,\r\n        totalPayouts,\r\n        platformKept,\r\n        forms1099Sent\r\n      })\r\n\r\n      // Set Creators List\r\n      const creatorsList: CreatorEarnings[] = taxData?.map(item => ({\r\n        user_id: item.user_id,\r\n        username: item.username || 'Unknown',\r\n        total_earnings_usd: Number(item.total_earnings_usd),\r\n        reached_threshold: item.is_irs_threshold_met,\r\n        form_1099_generated: item.has_tax_form,\r\n        documents_status: item.document_status,\r\n        country: 'US', // Default or fetch from profile if needed\r\n        monthly_breakdown: [] // We can fetch this if detailed view is opened\r\n      })) || []\r\n\r\n      setCreators(creatorsList)\r\n\r\n    } catch (error) {\r\n      console.error('Error loading creators list:', error)\r\n    }\r\n  }, [])\r\n\r\n  const loadData = React.useCallback(async () => {\r\n    setLoading(true)\r\n    try {\r\n      // Load dashboard cards data\r\n      await Promise.all([\r\n        loadDashboardCards(),\r\n        loadMonthlyEarnings(),\r\n        loadCreatorsList()\r\n      ])\r\n    } catch (error) {\r\n      console.error('Error loading earnings data:', error)\r\n      toast.error('Failed to load earnings data')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [loadDashboardCards, loadMonthlyEarnings, loadCreatorsList])\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [loadData])\r\n\r\n  const filterAndSortCreators = React.useCallback(() => {\r\n    let filtered = [...creators]\r\n\r\n    // Filter by threshold\r\n    if (showOnlyOver600) {\r\n      filtered = filtered.filter(c => c.reached_threshold)\r\n    }\r\n\r\n    // Sort\r\n    filtered.sort((a, b) => {\r\n      if (sortOrder === 'high') {\r\n        return b.total_earnings_usd - a.total_earnings_usd\r\n      } else {\r\n        return a.total_earnings_usd - b.total_earnings_usd\r\n      }\r\n    })\r\n\r\n    setFilteredCreators(filtered)\r\n  }, [creators, showOnlyOver600, sortOrder])\r\n\r\n  useEffect(() => {\r\n    filterAndSortCreators()\r\n  }, [filterAndSortCreators])\r\n\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'USD'\r\n    }).format(amount)\r\n  }\r\n\r\n  const handleDownload1099 = async (creator: CreatorEarnings) => {\r\n    if (!creator.form_1099_generated) {\r\n      toast.error('1099 form not yet generated for this creator')\r\n      return\r\n    }\r\n    \r\n    // In a real implementation, this would generate/download the PDF\r\n    toast.info('1099 form download would be implemented here')\r\n  }\r\n\r\n  const handleViewStripe = (_creator: CreatorEarnings) => {\r\n    // Open Stripe dashboard in new tab\r\n    window.open('https://dashboard.stripe.com/customers', '_blank')\r\n    toast.info('Opening Stripe dashboard')\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <h2 className=\"text-2xl font-bold text-white flex items-center gap-2\">\r\n          <DollarSign className=\"w-6 h-6 text-green-400\" />\r\n          Earnings & Tax Overview\r\n        </h2>\r\n        <button\r\n          onClick={loadData}\r\n          disabled={loading}\r\n          className=\"px-3 py-1 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white rounded-lg text-sm flex items-center gap-2\"\r\n        >\r\n          <TrendingUp className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />\r\n          Refresh\r\n        </button>\r\n      </div>\r\n\r\n      {/* Dashboard Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        <div className=\"bg-[#0D0D0D] border border-green-500/30 rounded-xl p-6\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-sm text-gray-400\">Total Liability</span>\r\n            <DollarSign className=\"w-5 h-5 text-green-400\" />\r\n          </div>\r\n          <div className=\"text-2xl font-bold text-green-400\">\r\n            {formatCurrency(earningsData.totalLiability)}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-[#0D0D0D] border border-purple-500/30 rounded-xl p-6\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-sm text-gray-400\">Creators Over $600</span>\r\n            <Users className=\"w-5 h-5 text-purple-400\" />\r\n          </div>\r\n          <div className=\"text-2xl font-bold text-purple-400\">\r\n            {earningsData.creatorsOverThreshold}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-[#0D0D0D] border border-yellow-500/30 rounded-xl p-6\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-sm text-gray-400\">1099 Forms Sent</span>\r\n            <FileText className=\"w-5 h-5 text-yellow-400\" />\r\n          </div>\r\n          <div className=\"text-2xl font-bold text-yellow-400\">\r\n            {earningsData.forms1099Sent}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-[#0D0D0D] border border-cyan-500/30 rounded-xl p-6\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-sm text-gray-400\">Platform Revenue</span>\r\n            <TrendingUp className=\"w-5 h-5 text-cyan-400\" />\r\n          </div>\r\n          <div className=\"text-2xl font-bold text-cyan-400\">\r\n            {formatCurrency(earningsData.platformKept)}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Monthly Earnings Chart */}\r\n      <div className=\"bg-[#0D0D0D] border border-[#2C2C2C] rounded-xl p-6\">\r\n        <h3 className=\"text-lg font-semibold text-white mb-4\">Monthly Earnings - {selectedYear}</h3>\r\n        {monthlyData.length > 0 ? (\r\n          <ResponsiveContainer width=\"100%\" height={300}>\r\n            <LineChart data={monthlyData}>\r\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#2C2C2C\" />\r\n              <XAxis \r\n                dataKey=\"month\" \r\n                stroke=\"#9CA3AF\"\r\n                style={{ fontSize: '12px' }}\r\n              />\r\n              <YAxis \r\n                stroke=\"#9CA3AF\"\r\n                style={{ fontSize: '12px' }}\r\n                tickFormatter={(value) => `$${value}`}\r\n              />\r\n              <Tooltip \r\n                contentStyle={{ \r\n                  backgroundColor: '#1A1A1A', \r\n                  border: '1px solid #2C2C2C',\r\n                  borderRadius: '8px'\r\n                }}\r\n                formatter={(value: number) => formatCurrency(value)}\r\n              />\r\n              <Legend />\r\n              <Line \r\n                type=\"monotone\" \r\n                dataKey=\"total_usd\" \r\n                stroke=\"#10B981\" \r\n                strokeWidth={2} \r\n                dot={{ fill: '#10B981', r: 4 }}\r\n                name=\"Total Earnings (USD)\"\r\n              />\r\n            </LineChart>\r\n          </ResponsiveContainer>\r\n        ) : (\r\n          <div className=\"h-[300px] flex items-center justify-center text-gray-400\">\r\n            No earnings data for {selectedYear}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"bg-[#0D0D0D] border border-[#2C2C2C] rounded-xl p-4 flex items-center gap-4\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Filter className=\"w-4 h-4 text-gray-400\" />\r\n          <label className=\"flex items-center gap-2 text-sm text-gray-300\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={showOnlyOver600}\r\n              onChange={(e) => setShowOnlyOver600(e.target.checked)}\r\n              className=\"w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500\"\r\n            />\r\n            Only Over $600\r\n          </label>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2\">\r\n          <Calendar className=\"w-4 h-4 text-gray-400\" />\r\n          <select\r\n            value={selectedYear}\r\n            onChange={(e) => setSelectedYear(Number(e.target.value))}\r\n            className=\"bg-[#1A1A1A] border border-gray-700 rounded-lg px-3 py-1 text-white text-sm\"\r\n          >\r\n            {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i).map(year => (\r\n              <option key={year} value={year}>{year}</option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2\">\r\n          <select\r\n            value={sortOrder}\r\n            onChange={(e) => setSortOrder(e.target.value as 'high' | 'low')}\r\n            className=\"bg-[#1A1A1A] border border-gray-700 rounded-lg px-3 py-1 text-white text-sm\"\r\n          >\r\n            <option value=\"high\">High ‚Üí Low</option>\r\n            <option value=\"low\">Low ‚Üí High</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div className=\"ml-auto text-sm text-gray-400\">\r\n          Showing {filteredCreators.length} of {creators.length} creators\r\n        </div>\r\n      </div>\r\n\r\n      {/* Creators Table */}\r\n      <div className=\"bg-[#0D0D0D] border border-[#2C2C2C] rounded-xl overflow-hidden\">\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"min-w-full text-xs\">\r\n            <thead>\r\n              <tr className=\"border-b border-gray-700 bg-[#1A1A1A]\">\r\n                <th className=\"px-4 py-3 text-left text-gray-400\">Username</th>\r\n                <th className=\"px-4 py-3 text-left text-gray-400\">Total $</th>\r\n                <th className=\"px-4 py-3 text-left text-gray-400\">Over IRS Limit?</th>\r\n                <th className=\"px-4 py-3 text-left text-gray-400\">1099 Sent?</th>\r\n                <th className=\"px-4 py-3 text-left text-gray-400\">Documents Status</th>\r\n                <th className=\"px-4 py-3 text-left text-gray-400\">Year</th>\r\n                <th className=\"px-4 py-3 text-right text-gray-400\">Actions</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {filteredCreators.map((creator) => (\r\n                <tr \r\n                  key={creator.user_id} \r\n                  className=\"border-b border-gray-800 hover:bg-[#1A1A1A] transition-colors cursor-pointer\"\r\n                  onClick={() => setSelectedCreator(creator)}\r\n                >\r\n                  <td className=\"px-4 py-3 font-medium text-white\">{creator.username}</td>\r\n                  <td className=\"px-4 py-3 text-green-400 font-semibold\">\r\n                    {formatCurrency(creator.total_earnings_usd)}\r\n                  </td>\r\n                  <td className=\"px-4 py-3\">\r\n                    {creator.reached_threshold ? (\r\n                      <span className=\"text-green-400\">‚úî Yes</span>\r\n                    ) : (\r\n                      <span className=\"text-gray-500\">‚ùå No</span>\r\n                    )}\r\n                  </td>\r\n                  <td className=\"px-4 py-3\">\r\n                    {creator.form_1099_generated ? (\r\n                      <span className=\"text-green-400\">‚úî Yes</span>\r\n                    ) : (\r\n                      <span className=\"text-gray-500\">‚ùå No</span>\r\n                    )}\r\n                  </td>\r\n                  <td className=\"px-4 py-3\">\r\n                    <span className={`px-2 py-1 rounded text-[10px] ${\r\n                      creator.documents_status === 'Submitted' ? 'bg-green-500/20 text-green-400' :\r\n                      creator.documents_status === 'Required' ? 'bg-yellow-500/20 text-yellow-400' :\r\n                      'bg-gray-500/20 text-gray-400'\r\n                    }`}>\r\n                      {creator.documents_status}\r\n                    </span>\r\n                  </td>\r\n                  <td className=\"px-4 py-3 text-gray-400\">{selectedYear}</td>\r\n                  <td className=\"px-4 py-3 text-right\">\r\n                    <button\r\n                      onClick={(e) => {\r\n                        e.stopPropagation()\r\n                        setSelectedCreator(creator)\r\n                      }}\r\n                      className=\"px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-[10px]\"\r\n                    >\r\n                      View\r\n                    </button>\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n        {filteredCreators.length === 0 && (\r\n          <div className=\"p-8 text-center text-gray-400\">No creators found</div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Detailed View Modal */}\r\n      {selectedCreator && (\r\n        <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-[#1A1A1A] rounded-xl border border-purple-500/30 max-w-3xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"sticky top-0 bg-[#1A1A1A] border-b border-purple-500/30 p-6 flex items-center justify-between\">\r\n              <h3 className=\"text-xl font-bold text-white\">Creator Details</h3>\r\n              <button\r\n                onClick={() => setSelectedCreator(null)}\r\n                className=\"text-gray-400 hover:text-white\"\r\n              >\r\n                <X className=\"w-6 h-6\" />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"p-6 space-y-6\">\r\n              {/* Basic Info */}\r\n              <div className=\"bg-[#0D0D0D] rounded-lg p-4 border border-gray-700\">\r\n                <h4 className=\"text-sm font-semibold text-purple-400 mb-3\">Creator Information</h4>\r\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                  <div>\r\n                    <div className=\"text-gray-400\">Username</div>\r\n                    <div className=\"text-white font-medium\">{selectedCreator.username}</div>\r\n                  </div>\r\n                  {selectedCreator.country && (\r\n                    <div>\r\n                      <div className=\"text-gray-400\">Country</div>\r\n                      <div className=\"text-white\">{selectedCreator.country}</div>\r\n                    </div>\r\n                  )}\r\n                  <div>\r\n                    <div className=\"text-gray-400\">Total Earnings</div>\r\n                    <div className=\"text-green-400 font-bold text-lg\">\r\n                      {formatCurrency(selectedCreator.total_earnings_usd)}\r\n                    </div>\r\n                  </div>\r\n                  <div>\r\n                    <div className=\"text-gray-400\">IRS Threshold Status</div>\r\n                    <div className={selectedCreator.reached_threshold ? 'text-green-400' : 'text-gray-400'}>\r\n                      {selectedCreator.reached_threshold ? 'Over $600' : 'Under $600'}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Monthly Breakdown */}\r\n              {selectedCreator.monthly_breakdown && selectedCreator.monthly_breakdown.length > 0 && (\r\n                <div className=\"bg-[#0D0D0D] rounded-lg p-4 border border-gray-700\">\r\n                  <h4 className=\"text-sm font-semibold text-purple-400 mb-3\">Monthly Earnings Breakdown</h4>\r\n                  <div className=\"space-y-2\">\r\n                    {selectedCreator.monthly_breakdown.map((month, idx) => (\r\n                      <div key={idx} className=\"flex justify-between items-center text-sm\">\r\n                        <span className=\"text-gray-400\">{month.month}</span>\r\n                        <span className=\"text-white font-medium\">{formatCurrency(month.earnings)}</span>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Tax Reporting Status */}\r\n              <div className=\"bg-[#0D0D0D] rounded-lg p-4 border border-gray-700\">\r\n                <h4 className=\"text-sm font-semibold text-purple-400 mb-3\">Tax Reporting Status</h4>\r\n                <div className=\"space-y-3 text-sm\">\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-gray-400\">1099 Form Generated</span>\r\n                    <span className={selectedCreator.form_1099_generated ? 'text-green-400' : 'text-gray-400'}>\r\n                      {selectedCreator.form_1099_generated ? 'Yes' : 'No'}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-gray-400\">Documents Status</span>\r\n                    <span className={`px-2 py-1 rounded text-xs ${\r\n                      selectedCreator.documents_status === 'Submitted' ? 'bg-green-500/20 text-green-400' :\r\n                      selectedCreator.documents_status === 'Required' ? 'bg-yellow-500/20 text-yellow-400' :\r\n                      'bg-gray-500/20 text-gray-400'\r\n                    }`}>\r\n                      {selectedCreator.documents_status}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Actions */}\r\n              <div className=\"flex gap-3\">\r\n                <button\r\n                  onClick={() => handleDownload1099(selectedCreator)}\r\n                  disabled={!selectedCreator.form_1099_generated}\r\n                  className=\"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium flex items-center justify-center gap-2\"\r\n                >\r\n                  <Download className=\"w-4 h-4\" />\r\n                  Download 1099\r\n                </button>\r\n                <button\r\n                  onClick={() => handleViewStripe(selectedCreator)}\r\n                  className=\"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium flex items-center justify-center gap-2\"\r\n                >\r\n                  <ExternalLink className=\"w-4 h-4\" />\r\n                  Stripe Dashboard\r\n                </button>\r\n              </div>\r\n\r\n              {/* Security Notice */}\r\n              <div className=\"bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4\">\r\n                <p className=\"text-xs text-yellow-400\">\r\n                  <strong>Security Notice:</strong> Sensitive tax information (SSN, bank details) is not displayed here. \r\n                  All identity verification is handled securely via third-party providers (Stripe/Persona).\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\ExecutiveSecretariesTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\FinanceEconomyCenter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\IPTracking.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\LiveKitUsageTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\MetricsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\OfficerManagementTab.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":351,"column":23,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[14799,14824],"text":"\r\n                      &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[14799,14824],"text":"\r\n                      &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[14799,14824],"text":"\r\n                      &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[14799,14824],"text":"\r\n                      &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":351,"column":36,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[14836,14859],"text":"&quot;\r\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[14836,14859],"text":"&ldquo;\r\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[14836,14859],"text":"&#34;\r\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[14836,14859],"text":"&rdquo;\r\n                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport { RoleChangeLog, OfficerBadge } from '../../../types/admin'\r\nimport { toast } from 'sonner'\r\nimport { Shield, Award, History, Ban, ArrowUp, ArrowDown } from 'lucide-react'\r\nimport { useAuthStore } from '../../../lib/store'\r\n\r\ninterface UserProfile {\r\n  id: string\r\n  username: string\r\n  avatar_url: string\r\n  role: string\r\n  is_officer_active: boolean\r\n  is_lead_officer: boolean\r\n  troll_role: string\r\n}\r\n\r\nexport default function OfficerManagementTab() {\r\n  const { user } = useAuthStore()\r\n  const [searchQuery, setSearchQuery] = useState('')\r\n  const [selectedUser, setSelectedUser] = useState<UserProfile | null>(null)\r\n  const [searchResults, setSearchResults] = useState<UserProfile[]>([])\r\n  const [badges, setBadges] = useState<OfficerBadge[]>([])\r\n  const [logs, setLogs] = useState<RoleChangeLog[]>([])\r\n  const [actionReason, setActionReason] = useState('')\r\n  const [loadingLogs, setLoadingLogs] = useState(false)\r\n\r\n  const handleSearch = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (searchQuery.length < 3) return\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, avatar_url, role, is_officer_active, is_lead_officer, troll_role')\r\n        .ilike('username', `%${searchQuery}%`)\r\n        .limit(10)\r\n\r\n      if (error) throw error\r\n      setSearchResults(data || [])\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Search failed')\r\n    }\r\n  }\r\n\r\n  const selectUser = async (profile: UserProfile) => {\r\n    setSelectedUser(profile)\r\n    setSearchResults([])\r\n    setSearchQuery('')\r\n    fetchUserDetails(profile.id)\r\n  }\r\n\r\n  const fetchUserDetails = async (userId: string) => {\r\n    // Fetch badges\r\n    const { data: badgeData } = await supabase\r\n      .from('officer_badges')\r\n      .select('*')\r\n      .eq('user_id', userId)\r\n    \r\n    setBadges(badgeData || [])\r\n\r\n    // Fetch logs\r\n    setLoadingLogs(true)\r\n    const { data: logData } = await supabase\r\n      .from('role_change_log')\r\n      .select('*')\r\n      .eq('target_user', userId)\r\n      .order('created_at', { ascending: false })\r\n    \r\n    setLogs(logData || [])\r\n    setLoadingLogs(false)\r\n  }\r\n\r\n  const handleSetRole = async (newRole: string) => {\r\n    if (!selectedUser || !user || !actionReason) {\r\n      toast.error('Please provide a reason')\r\n      return\r\n    }\r\n\r\n    try {\r\n      const { error } = await supabase.rpc('set_user_role', {\r\n        target_user: selectedUser.id,\r\n        new_role: newRole,\r\n        reason: actionReason\r\n      })\r\n\r\n      if (error) throw error\r\n      toast.success(`Role updated to ${newRole}`)\r\n      \r\n      // Refresh user data\r\n      const { data } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, avatar_url, role, is_officer_active, is_lead_officer, troll_role')\r\n        .eq('id', selectedUser.id)\r\n        .single()\r\n      \r\n      if (data) setSelectedUser(data)\r\n      fetchUserDetails(selectedUser.id)\r\n      setActionReason('')\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to update role')\r\n    }\r\n  }\r\n\r\n  const handleSetStatus = async (status: boolean) => {\r\n    if (!selectedUser || !user || !actionReason) {\r\n      toast.error('Please provide a reason')\r\n      return\r\n    }\r\n\r\n    try {\r\n      const { error } = await supabase.rpc('set_officer_status', {\r\n        target_user_id: selectedUser.id,\r\n        new_status: status,\r\n        reason: actionReason\r\n      })\r\n\r\n      if (error) throw error\r\n      toast.success(`Officer status updated to ${status ? 'Active' : 'Suspended'}`)\r\n      \r\n      // Refresh user data\r\n      const { data } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, avatar_url, role, is_officer_active, is_lead_officer, troll_role')\r\n        .eq('id', selectedUser.id)\r\n        .single()\r\n      \r\n      if (data) setSelectedUser(data)\r\n      fetchUserDetails(selectedUser.id)\r\n      setActionReason('')\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to update status')\r\n    }\r\n  }\r\n\r\n  const handleToggleLeadOfficer = async () => {\r\n    if (!selectedUser || !user) return\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({ is_lead_officer: !selectedUser.is_lead_officer })\r\n        .eq('id', selectedUser.id)\r\n\r\n      if (error) throw error\r\n      toast.success(`User ${selectedUser.is_lead_officer ? 'demoted from' : 'promoted to'} Lead Officer`)\r\n\r\n      // Refresh user data\r\n      const { data } = await supabase\r\n        .from('user_profiles')\r\n        .select('id, username, avatar_url, role, is_officer_active, is_lead_officer, troll_role')\r\n        .eq('id', selectedUser.id)\r\n        .single()\r\n      \r\n      if (data) setSelectedUser(data)\r\n      fetchUserDetails(selectedUser.id)\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to update lead officer status')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-slate-800 rounded-lg border border-slate-700 p-6\">\r\n      <h2 className=\"text-xl font-bold text-white mb-6 flex items-center gap-2\">\r\n        <Shield className=\"w-5 h-5 text-blue-400\" />\r\n        Officer Management\r\n      </h2>\r\n\r\n      {/* Search */}\r\n      <div className=\"mb-8\">\r\n        <form onSubmit={handleSearch} className=\"flex gap-2\">\r\n          <input\r\n            type=\"text\"\r\n            placeholder=\"Search username...\"\r\n            className=\"flex-1 bg-slate-900 border border-slate-600 rounded-lg p-3 text-white\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n          />\r\n          <button type=\"submit\" className=\"bg-blue-600 px-6 rounded-lg text-white font-bold\">Search</button>\r\n        </form>\r\n        \r\n        {searchResults.length > 0 && (\r\n          <div className=\"mt-2 bg-slate-900 border border-slate-600 rounded-lg overflow-hidden\">\r\n            {searchResults.map(result => (\r\n              <div \r\n                key={result.id}\r\n                className=\"p-3 hover:bg-slate-800 cursor-pointer flex items-center justify-between border-b border-slate-700 last:border-0\"\r\n                onClick={() => selectUser(result)}\r\n              >\r\n                <div className=\"flex items-center gap-3\">\r\n                  <img src={result.avatar_url || 'https://via.placeholder.com/40'} className=\"w-8 h-8 rounded-full\" />\r\n                  <span className=\"text-white\">{result.username}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs bg-slate-800 px-2 py-1 rounded text-slate-300\">{result.role}</span>\r\n                  {result.is_lead_officer && (\r\n                    <span className=\"text-xs bg-amber-900/40 border border-amber-700 px-2 py-1 rounded text-amber-300\">LEAD</span>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {selectedUser && (\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\r\n          {/* Controls */}\r\n          <div>\r\n            <div className=\"bg-slate-900/50 p-6 rounded-lg border border-slate-700 mb-6\">\r\n              <div className=\"flex items-center gap-4 mb-6\">\r\n                <img src={selectedUser.avatar_url || 'https://via.placeholder.com/60'} className=\"w-16 h-16 rounded-full border-2 border-blue-500\" />\r\n                <div>\r\n                  <h3 className=\"text-xl font-bold text-white\">{selectedUser.username}</h3>\r\n                  <div className=\"flex gap-2 mt-1\">\r\n                    <span className=\"px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded text-xs border border-blue-500/50\">\r\n                      {selectedUser.role}\r\n                    </span>\r\n                    {selectedUser.troll_role && (\r\n                      <span className=\"px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded text-xs border border-purple-500/50\">\r\n                        {selectedUser.troll_role}\r\n                      </span>\r\n                    )}\r\n                    <span className={`px-2 py-0.5 rounded text-xs border ${\r\n                      selectedUser.is_officer_active \r\n                        ? 'bg-green-500/20 text-green-300 border-green-500/50' \r\n                        : 'bg-red-500/20 text-red-300 border-red-500/50'\r\n                    }`}>\r\n                      {selectedUser.is_officer_active ? 'ACTIVE' : 'SUSPENDED'}\r\n                    </span>\r\n                    {selectedUser.is_lead_officer && (\r\n                      <span className=\"px-2 py-0.5 bg-amber-900/20 text-amber-300 rounded text-xs border border-amber-500/50\">\r\n                        LEAD\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"text-sm text-slate-400 block mb-1\">Reason for Action (Required)</label>\r\n                  <textarea \r\n                    className=\"w-full bg-slate-800 border border-slate-600 rounded p-2 text-white h-20\"\r\n                    placeholder=\"Why are you changing this user's status?\"\r\n                    value={actionReason}\r\n                    onChange={(e) => setActionReason(e.target.value)}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <p className=\"text-xs font-bold text-slate-500 uppercase\">Role Management</p>\r\n                    <button \r\n                      onClick={() => handleSetRole('admin')}\r\n                      className=\"w-full bg-red-900/50 hover:bg-red-900 text-red-200 py-2 rounded text-sm border border-red-800 flex items-center justify-center gap-2\"\r\n                    >\r\n                      <ArrowUp className=\"w-4 h-4\" /> Promote to Admin\r\n                    </button>\r\n                    <button \r\n                      onClick={() => handleSetRole('moderator')}\r\n                      className=\"w-full bg-blue-900/50 hover:bg-blue-900 text-blue-200 py-2 rounded text-sm border border-blue-800 flex items-center justify-center gap-2\"\r\n                    >\r\n                      <Shield className=\"w-4 h-4\" /> Set as Moderator\r\n                    </button>\r\n                    <button \r\n                      onClick={() => handleSetRole('user')}\r\n                      className=\"w-full bg-slate-700 hover:bg-slate-600 text-slate-200 py-2 rounded text-sm flex items-center justify-center gap-2\"\r\n                    >\r\n                      <ArrowDown className=\"w-4 h-4\" /> Demote to User\r\n                    </button>\r\n                  </div>\r\n                  \r\n                  <div className=\"space-y-2\">\r\n                    <p className=\"text-xs font-bold text-slate-500 uppercase\">Status</p>\r\n                    {selectedUser.is_officer_active ? (\r\n                      <button \r\n                        onClick={() => handleSetStatus(false)}\r\n                        className=\"w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded text-sm flex items-center justify-center gap-2\"\r\n                      >\r\n                        <Ban className=\"w-4 h-4\" /> Suspend Officer\r\n                      </button>\r\n                    ) : (\r\n                      <button \r\n                        onClick={() => handleSetStatus(true)}\r\n                        className=\"w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded text-sm flex items-center justify-center gap-2\"\r\n                      >\r\n                        <CheckCircle className=\"w-4 h-4\" /> Reactivate Officer\r\n                      </button>\r\n                    )}\r\n                    \r\n                    <button \r\n                      onClick={handleToggleLeadOfficer}\r\n                      className={`w-full py-2 rounded text-sm flex items-center justify-center gap-2 border ${\r\n                        selectedUser.is_lead_officer\r\n                          ? 'bg-amber-900/20 border-amber-500/30 text-amber-400 hover:bg-amber-900/40'\r\n                          : 'bg-amber-600 hover:bg-amber-500 text-white'\r\n                      }`}\r\n                    >\r\n                      <Award className=\"w-4 h-4\" /> \r\n                      {selectedUser.is_lead_officer ? 'Remove Lead Status' : 'Promote to Lead Officer'}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Badges */}\r\n            <div className=\"bg-slate-900/50 p-6 rounded-lg border border-slate-700\">\r\n              <h3 className=\"text-lg font-bold text-white mb-4 flex items-center gap-2\">\r\n                <Award className=\"w-5 h-5 text-yellow-400\" />\r\n                Officer Badges\r\n              </h3>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {badges.length === 0 ? (\r\n                  <p className=\"text-slate-500 text-sm italic\">No badges awarded</p>\r\n                ) : (\r\n                  badges.map((badge, idx) => (\r\n                    <div key={idx} className=\"bg-slate-800 border border-slate-600 px-3 py-1 rounded-full text-sm text-yellow-200 flex items-center gap-2\">\r\n                      <Award className=\"w-3 h-3\" /> {badge.badge_type}\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* History */}\r\n          <div className=\"bg-slate-900/50 p-6 rounded-lg border border-slate-700 max-h-[600px] overflow-y-auto\">\r\n            <h3 className=\"text-lg font-bold text-white mb-4 flex items-center gap-2\">\r\n              <History className=\"w-5 h-5 text-slate-400\" />\r\n              Role History\r\n            </h3>\r\n            <div className=\"space-y-4\">\r\n              {loadingLogs ? (\r\n                <p className=\"text-slate-500\">Loading history...</p>\r\n              ) : logs.length === 0 ? (\r\n                <p className=\"text-slate-500 italic\">No history found</p>\r\n              ) : (\r\n                logs.map(log => (\r\n                  <div key={log.id} className=\"border-l-2 border-slate-700 pl-4 pb-4\">\r\n                    <div className=\"text-sm text-slate-300 font-medium\">\r\n                      Changed from <span className=\"text-red-400\">{log.old_role}</span> to <span className=\"text-green-400\">{log.new_role}</span>\r\n                    </div>\r\n                    <p className=\"text-xs text-slate-500 mt-1\">{new Date(log.created_at).toLocaleString()}</p>\r\n                    <div className=\"mt-2 bg-slate-800 p-2 rounded text-xs text-slate-300 italic\">\r\n                      \"{log.reason}\"\r\n                    </div>\r\n                    <div className=\"mt-1 text-xs text-slate-500\">\r\n                      By Admin ID: {log.changed_by.slice(0, 8)}\r\n                    </div>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nimport { CheckCircle } from 'lucide-react'\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\OfficerShiftsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\OperationsControlDeck.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\PayoutQueue.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\QuickActionsBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\ReceiptUploadModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\ReportsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\StaffManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\StorePriceEditor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\StreamMonitor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\StreamsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\TestDiagnostics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\UserActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\UserFormsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\UserManagementPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\UsersPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\CashoutRequestsList.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":71,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[263,278],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":276,"column":37,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[10967,11006],"text":"\r\n                                    &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[10967,11006],"text":"\r\n                                    &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[10967,11006],"text":"\r\n                                    &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[10967,11006],"text":"\r\n                                    &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":276,"column":55,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11023,11058],"text":"&quot;\r\n                                "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11023,11058],"text":"&ldquo;\r\n                                "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11023,11058],"text":"&#34;\r\n                                "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11023,11058],"text":"&rdquo;\r\n                                "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":389,"column":55,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[16889,16980],"text":"\r\n                This will be securely sent to the user&apos;s Gift Cards page.\r\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[16889,16980],"text":"\r\n                This will be securely sent to the user&lsquo;s Gift Cards page.\r\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[16889,16980],"text":"\r\n                This will be securely sent to the user&#39;s Gift Cards page.\r\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[16889,16980],"text":"\r\n                This will be securely sent to the user&rsquo;s Gift Cards page.\r\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useCallback } from 'react'\r\nimport { supabase } from '../../../../lib/supabase'\r\nimport { CashoutRequest } from '../../../../types/admin'\r\nimport { toast } from 'sonner'\r\nimport { DollarSign, Check, X, CreditCard, Lock, Unlock, AlertTriangle } from 'lucide-react'\r\nimport { useAuthStore } from '../../../../lib/store'\r\n\r\ninterface CashoutRequestsListProps {\r\n  viewMode: 'admin' | 'secretary'\r\n}\r\n\r\ntype ExtendedCashoutRequest = CashoutRequest & {\r\n  user_profile?: {\r\n    username: string;\r\n    email?: string;\r\n  }\r\n  is_held?: boolean;\r\n  held_reason?: string;\r\n  release_date?: string;\r\n  is_new_user_hold?: boolean;\r\n}\r\n\r\nexport default function CashoutRequestsList({ viewMode: _viewMode }: CashoutRequestsListProps) {\r\n  const { user } = useAuthStore()\r\n  const [requests, setRequests] = useState<ExtendedCashoutRequest[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [selectedRequest, setSelectedRequest] = useState<ExtendedCashoutRequest | null>(null)\r\n  const [giftCardCode, setGiftCardCode] = useState('')\r\n  const [isFulfillModalOpen, setIsFulfillModalOpen] = useState(false)\r\n  const [filterStatus, setFilterStatus] = useState<string>('pending')\r\n  const [filterUser, setFilterUser] = useState<string>('')\r\n  const [holdReason, setHoldReason] = useState('')\r\n  const [requestToHold, setRequestToHold] = useState<ExtendedCashoutRequest | null>(null)\r\n\r\n  const fetchRequests = useCallback(async () => {\r\n    setLoading(true)\r\n    try {\r\n      let query = supabase\r\n        .from('cashout_requests')\r\n        .select(`\r\n          *,\r\n          user_profile:user_profiles!cashout_requests_user_id_fkey(username, email)\r\n        `)\r\n        .order('requested_at', { ascending: false })\r\n\r\n      if (filterStatus !== 'all') {\r\n        query = query.eq('status', filterStatus)\r\n      }\r\n\r\n      const { data, error } = await query\r\n\r\n      if (error) throw error\r\n      setRequests(data || [])\r\n    } catch (error) {\r\n      console.error('Error fetching cashouts:', error)\r\n      toast.error('Failed to load cashout requests')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [filterStatus])\r\n\r\n  useEffect(() => {\r\n    fetchRequests()\r\n    \r\n    const subscription = supabase\r\n      .channel('cashout_requests_changes')\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'cashout_requests' }, () => {\r\n        fetchRequests()\r\n      })\r\n      .subscribe()\r\n\r\n    return () => {\r\n      subscription.unsubscribe()\r\n    }\r\n  }, [fetchRequests])\r\n\r\n  const handleUpdateStatus = async (id: string, status: string, notes?: string) => {\r\n    if (!user) return\r\n    try {\r\n      const updates: any = { status }\r\n      \r\n      if (status === 'approved') {\r\n        updates.approved_by = user.id\r\n        updates.approved_at = new Date().toISOString()\r\n        \r\n        const { error } = await supabase\r\n          .from('cashout_requests')\r\n          .update(updates)\r\n          .eq('id', id)\r\n        if (error) throw error\r\n      } else if (status === 'denied') {\r\n        const { error } = await supabase.rpc('process_cashout_refund', {\r\n          p_request_id: id,\r\n          p_admin_id: user.id,\r\n          p_notes: notes || 'Request denied'\r\n        })\r\n        if (error) throw error\r\n      } else {\r\n        const { error } = await supabase\r\n          .from('cashout_requests')\r\n          .update(updates)\r\n          .eq('id', id)\r\n        if (error) throw error\r\n      }\r\n      toast.success(`Request marked as ${status}`)\r\n      fetchRequests()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to update request')\r\n    }\r\n  }\r\n\r\n  const handleToggleHold = async (req: ExtendedCashoutRequest, hold: boolean, reason?: string) => {\r\n    if (!user) return\r\n    try {\r\n      const { error } = await supabase.rpc('toggle_cashout_hold', {\r\n        p_request_id: req.id,\r\n        p_admin_id: user.id,\r\n        p_hold: hold,\r\n        p_reason: reason || null\r\n      })\r\n\r\n      if (error) throw error\r\n      \r\n      toast.success(hold ? 'Request put on hold' : 'Request released from hold')\r\n      setRequestToHold(null)\r\n      setHoldReason('')\r\n      fetchRequests()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to update hold status')\r\n    }\r\n  }\r\n\r\n  const openFulfillModal = (req: ExtendedCashoutRequest) => {\r\n    setSelectedRequest(req)\r\n    setGiftCardCode('')\r\n    setIsFulfillModalOpen(true)\r\n  }\r\n\r\n  const handleFulfill = async () => {\r\n    if (!selectedRequest || !giftCardCode) return\r\n    if (!user) return\r\n\r\n    try {\r\n      const { error } = await supabase.rpc('fulfill_cashout_request', {\r\n        p_request_id: selectedRequest.id,\r\n        p_admin_id: user.id,\r\n        p_notes: 'Fulfilled via admin panel',\r\n        p_gift_card_code: giftCardCode\r\n      })\r\n\r\n      if (error) throw error\r\n      toast.success('Request fulfilled with Gift Card code!')\r\n      setIsFulfillModalOpen(false)\r\n      fetchRequests()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to fulfill request')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-slate-800 rounded-lg border border-slate-700 p-6 relative\">\r\n      \r\n      {/* Schedule Banner */}\r\n      <div className=\"mb-6 bg-blue-900/20 border border-blue-800 rounded-lg p-3 flex items-center gap-3\">\r\n        <div className=\"bg-blue-900/50 p-2 rounded-full\">\r\n            <DollarSign className=\"w-5 h-5 text-blue-400\" />\r\n        </div>\r\n        <div>\r\n            <h4 className=\"text-sm font-bold text-blue-200\">Payout Schedule</h4>\r\n            <p className=\"text-xs text-blue-300/80\">\r\n                Payouts are processed twice a week: <span className=\"text-white font-bold\">Mondays</span> and <span className=\"text-white font-bold\">Fridays</span>.\r\n            </p>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex justify-between items-center gap-4 mb-6 flex-wrap\">\r\n        <h2 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n          <DollarSign className=\"w-5 h-5 text-green-400\" />\r\n          Cashout Requests\r\n        </h2>\r\n        <div className=\"flex items-center gap-3 flex-wrap\">\r\n          <input\r\n            className=\"bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm text-white placeholder:text-slate-500\"\r\n            placeholder=\"Filter by user, email, or ID\"\r\n            value={filterUser}\r\n            onChange={(e) => setFilterUser(e.target.value)}\r\n          />\r\n          <select \r\n            className=\"bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm text-white\"\r\n            value={filterStatus}\r\n            onChange={(e) => setFilterStatus(e.target.value)}\r\n          >\r\n            <option value=\"all\">All Status</option>\r\n            <option value=\"pending\">Pending</option>\r\n            <option value=\"approved\">Approved</option>\r\n            <option value=\"processing\">Processing</option>\r\n            <option value=\"fulfilled\">Fulfilled</option>\r\n            <option value=\"failed\">Failed</option>\r\n            <option value=\"denied\">Denied</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"overflow-x-auto\">\r\n        <table className=\"w-full text-left text-sm text-slate-300\">\r\n          <thead className=\"bg-slate-900/50 text-slate-400 uppercase font-medium\">\r\n            <tr>\r\n              <th className=\"p-3\">User</th>\r\n              <th className=\"p-3\">Amount</th>\r\n              <th className=\"p-3\">Tier</th>\r\n              <th className=\"p-3\">Status</th>\r\n              <th className=\"p-3\">Date</th>\r\n              <th className=\"p-3 text-right\">Actions</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody className=\"divide-y divide-slate-700\">\r\n            {loading ? (\r\n              <tr><td colSpan={6} className=\"p-4 text-center\">Loading...</td></tr>\r\n            ) : requests.length === 0 ? (\r\n              <tr><td colSpan={6} className=\"p-4 text-center\">No requests found</td></tr>\r\n            ) : (\r\n              requests\r\n                .filter(req => {\r\n                  if (!filterUser.trim()) return true\r\n                  const q = filterUser.toLowerCase()\r\n                  return (\r\n                    (req.user_profile?.username || '').toLowerCase().includes(q) ||\r\n                    (req.user_profile?.email || '').toLowerCase().includes(q) ||\r\n                    req.user_id.toLowerCase().includes(q)\r\n                  )\r\n                })\r\n                .map(req => (\r\n                <tr key={req.id} className=\"hover:bg-slate-700/30 transition-colors\">\r\n                  <td className=\"p-3 font-medium text-white\">\r\n                    {req.user_profile?.username || 'Unknown'}\r\n                    <div className=\"text-xs text-slate-500\">{req.user_id.slice(0, 8)}</div>\r\n                    {req.is_new_user_hold && (\r\n                       <div className=\"text-[10px] text-orange-400 mt-1\">New User Hold</div>\r\n                    )}\r\n                  </td>\r\n                  <td className=\"p-3 font-mono text-yellow-400\">\r\n                    {(req.coin_amount || 0).toLocaleString()} coins\r\n                  </td>\r\n                  <td className=\"p-3\">\r\n                    <span className=\"px-2 py-0.5 rounded border border-slate-600 text-xs\">\r\n                      {req.tier || 'Standard'}\r\n                    </span>\r\n                  </td>\r\n                  <td className=\"p-3\">\r\n                    <div className=\"flex flex-col gap-1 items-start\">\r\n                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${\r\n                        req.status === 'pending' ? 'bg-yellow-500/20 text-yellow-300' :\r\n                        req.status === 'approved' ? 'bg-blue-500/20 text-blue-300' :\r\n                        req.status === 'fulfilled' ? 'bg-green-500/20 text-green-300' :\r\n                        req.status === 'denied' ? 'bg-red-500/20 text-red-300' :\r\n                        'bg-slate-500/20 text-slate-300'\r\n                      }`}>\r\n                        {req.status.toUpperCase()}\r\n                      </span>\r\n                      {req.is_held && (\r\n                        <div className=\"flex flex-col gap-0.5\">\r\n                            <span className=\"px-2 py-0.5 rounded-full text-[10px] font-bold bg-orange-500/20 text-orange-300 flex items-center gap-1 w-fit\">\r\n                                <Lock className=\"w-3 h-3\" />\r\n                                HELD\r\n                            </span>\r\n                            {req.release_date && (\r\n                                <span className=\"text-[10px] text-slate-400\">\r\n                                    Release: {new Date(req.release_date).toLocaleDateString()}\r\n                                </span>\r\n                            )}\r\n                             {req.held_reason && (\r\n                                <span className=\"text-[10px] text-slate-500 italic max-w-[150px] truncate\" title={req.held_reason}>\r\n                                    \"{req.held_reason}\"\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </td>\r\n                  <td className=\"p-3 text-slate-400\">\r\n                    {new Date(req.requested_at).toLocaleDateString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right space-x-2\">\r\n                    {req.status === 'pending' && (\r\n                      <>\r\n                        {!req.is_held ? (\r\n                            <>\r\n                                <button \r\n                                  onClick={() => handleUpdateStatus(req.id, 'approved')}\r\n                                  className=\"p-1.5 bg-green-600/20 hover:bg-green-600/40 text-green-400 rounded transition-colors\"\r\n                                  title=\"Approve\"\r\n                                >\r\n                                  <Check className=\"w-4 h-4\" />\r\n                                </button>\r\n                                <button \r\n                                  onClick={() => handleUpdateStatus(req.id, 'denied')}\r\n                                  className=\"p-1.5 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded transition-colors\"\r\n                                  title=\"Deny\"\r\n                                >\r\n                                  <X className=\"w-4 h-4\" />\r\n                                </button>\r\n                                <button \r\n                                  onClick={() => setRequestToHold(req)}\r\n                                  className=\"p-1.5 bg-orange-600/20 hover:bg-orange-600/40 text-orange-400 rounded transition-colors\"\r\n                                  title=\"Hold Request\"\r\n                                >\r\n                                  <Lock className=\"w-4 h-4\" />\r\n                                </button>\r\n                            </>\r\n                        ) : (\r\n                            <button \r\n                              onClick={() => handleToggleHold(req, false)}\r\n                              className=\"p-1.5 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded transition-colors inline-flex items-center gap-1 px-2\"\r\n                              title=\"Release Hold\"\r\n                            >\r\n                              <Unlock className=\"w-4 h-4\" />\r\n                              <span className=\"text-xs font-bold\">Release</span>\r\n                            </button>\r\n                        )}\r\n                      </>\r\n                    )}\r\n                    {req.status === 'approved' && (\r\n                      <button \r\n                        onClick={() => openFulfillModal(req)}\r\n                        className=\"p-1.5 bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 rounded transition-colors flex items-center gap-1 px-2\"\r\n                        title=\"Fulfill with Gift Card\"\r\n                      >\r\n                        <CreditCard className=\"w-4 h-4\" />\r\n                        <span className=\"text-xs font-bold\">Fulfill</span>\r\n                      </button>\r\n                    )}\r\n                    {req.status === 'processing' && (\r\n                      <button \r\n                        onClick={() => openFulfillModal(req)}\r\n                        className=\"p-1.5 bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 rounded transition-colors flex items-center gap-1 px-2\"\r\n                        title=\"Mark Fulfilled\"\r\n                      >\r\n                        <CreditCard className=\"w-4 h-4\" />\r\n                        <span className=\"text-xs font-bold\">Fulfill</span>\r\n                      </button>\r\n                    )}\r\n                  </td>\r\n                </tr>\r\n              ))\r\n            )}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n      {isFulfillModalOpen && selectedRequest && (\r\n        <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-xl max-w-md w-full p-6 space-y-4\">\r\n            <div className=\"flex justify-between items-center\">\r\n              <h3 className=\"text-xl font-bold text-white\">Fulfill Cashout Request</h3>\r\n              <button \r\n                onClick={() => setIsFulfillModalOpen(false)}\r\n                className=\"text-gray-400 hover:text-white\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n            \r\n              <div className=\"bg-[#0D0D16] p-4 rounded-lg space-y-2\">\r\n                <div className=\"flex justify-between text-sm\">\r\n                  <span className=\"text-gray-400\">User:</span>\r\n                  <span className=\"text-white font-medium\">{selectedRequest.user_profile?.username}</span>\r\n                </div>\r\n                <div className=\"flex justify-between text-sm\">\r\n                  <span className=\"text-gray-400\">Amount:</span>\r\n                  <span className=\"text-yellow-400 font-mono\">\r\n                  {(selectedRequest.coin_amount || 0).toLocaleString()} coins\r\n                  </span>\r\n                </div>\r\n              {/* USD value and delivery method omitted due to schema differences */}\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-300\">Gift Card Code / Link</label>\r\n              <input\r\n                type=\"text\"\r\n                value={giftCardCode}\r\n                onChange={(e) => setGiftCardCode(e.target.value)}\r\n                placeholder=\"Enter code or claim link...\"\r\n                className=\"w-full bg-[#0D0D16] border border-[#2C2C2C] rounded-lg p-3 text-white focus:outline-none focus:border-purple-500\"\r\n              />\r\n              <p className=\"text-xs text-gray-500\">\r\n                This will be securely sent to the user's Gift Cards page.\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"flex gap-3 pt-2\">\r\n              <button\r\n                onClick={() => setIsFulfillModalOpen(false)}\r\n                className=\"flex-1 px-4 py-2 rounded-lg border border-[#2C2C2C] text-gray-300 hover:bg-[#2C2C2C] transition-colors\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={handleFulfill}\r\n                disabled={!giftCardCode}\r\n                className=\"flex-1 px-4 py-2 rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                Send Gift Card\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {requestToHold && (\r\n        <div className=\"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-[#1A1A24] border border-[#2C2C2C] rounded-xl max-w-md w-full p-6 space-y-4\">\r\n            <div className=\"flex justify-between items-center\">\r\n              <h3 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n                <Lock className=\"w-5 h-5 text-orange-400\" />\r\n                Hold Payout Request\r\n              </h3>\r\n              <button \r\n                onClick={() => setRequestToHold(null)}\r\n                className=\"text-gray-400 hover:text-white\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"bg-orange-900/10 border border-orange-900/30 p-4 rounded-lg\">\r\n                <p className=\"text-sm text-orange-200/80\">\r\n                    Holding this request will prevent it from being processed. \r\n                    {requestToHold.is_new_user_hold && (\r\n                        <span className=\"block mt-1 font-bold text-orange-300\">\r\n                            Note: This is already flagged as a New User Hold.\r\n                        </span>\r\n                    )}\r\n                </p>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-300\">Reason (Optional)</label>\r\n              <input\r\n                type=\"text\"\r\n                value={holdReason}\r\n                onChange={(e) => setHoldReason(e.target.value)}\r\n                placeholder=\"e.g. Verification needed, Suspicious activity...\"\r\n                className=\"w-full bg-[#0D0D16] border border-[#2C2C2C] rounded-lg p-3 text-white focus:outline-none focus:border-orange-500\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex gap-3 pt-2\">\r\n              <button\r\n                onClick={() => setRequestToHold(null)}\r\n                className=\"flex-1 px-4 py-2 rounded-lg border border-[#2C2C2C] text-gray-300 hover:bg-[#2C2C2C] transition-colors\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={() => handleToggleHold(requestToHold, true, holdReason)}\r\n                className=\"flex-1 px-4 py-2 rounded-lg bg-orange-600 text-white font-medium hover:bg-orange-500 transition-colors\"\r\n              >\r\n                Confirm Hold\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\CriticalAlertsList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\ExecutiveIntakeList.tsx","messages":[{"ruleId":"react/jsx-no-undef","severity":2,"message":"'BadgeCheck' is not defined.","line":266,"column":30,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":266,"endColumn":40}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useCallback } from 'react'\r\nimport { supabase } from '../../../../lib/supabase'\r\nimport { ExecutiveIntake } from '../../../../types/admin'\r\nimport { toast } from 'sonner'\r\nimport { AlertTriangle, CheckCircle, Clock, ArrowUpCircle } from 'lucide-react'\r\nimport { useAuthStore } from '../../../../lib/store'\r\n\r\ninterface ExecutiveIntakeListProps {\r\n  viewMode: 'admin' | 'secretary'\r\n}\r\n\r\nexport default function ExecutiveIntakeList({ viewMode }: ExecutiveIntakeListProps) {\r\n  const { user } = useAuthStore()\r\n  const [intakeItems, setIntakeItems] = useState<ExecutiveIntake[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [filterStatus, setFilterStatus] = useState<string>('all')\r\n  const [filterSeverity, setFilterSeverity] = useState<string>('all')\r\n  const [selectedItem, setSelectedItem] = useState<ExecutiveIntake | null>(null)\r\n  const [notes, setNotes] = useState('')\r\n\r\n  const fetchIntake = useCallback(async () => {\r\n    setLoading(true)\r\n    try {\r\n      const query = supabase\r\n        .from('executive_intake')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (viewMode === 'secretary') {\r\n        // Secretaries might only see their assigned items or unassigned ones?\r\n        // Requirement: \"Intake Inbox: Full view of executive_intake\"\r\n        // So they see everything.\r\n      }\r\n\r\n      const { data, error } = await query\r\n\r\n      if (error) throw error\r\n      setIntakeItems(data || [])\r\n    } catch (error) {\r\n      console.error('Error fetching intake:', error)\r\n      toast.error('Failed to load intake items')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [viewMode])\r\n\r\n  useEffect(() => {\r\n    fetchIntake()\r\n    \r\n    const subscription = supabase\r\n      .channel('executive_intake_changes')\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'executive_intake' }, () => {\r\n        fetchIntake()\r\n      })\r\n      .subscribe()\r\n\r\n    return () => {\r\n      subscription.unsubscribe()\r\n    }\r\n  }, [fetchIntake])\r\n\r\n  const handleUpdateStatus = async (id: string, newStatus: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('executive_intake')\r\n        .update({ status: newStatus })\r\n        .eq('id', id)\r\n\r\n      if (error) throw error\r\n      toast.success('Status updated')\r\n      fetchIntake()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to update status')\r\n    }\r\n  }\r\n\r\n  const handleAssignSelf = async (id: string) => {\r\n    if (!user) return\r\n    try {\r\n      const { error } = await supabase\r\n        .from('executive_intake')\r\n        .update({ assigned_secretary: user.id })\r\n        .eq('id', id)\r\n\r\n      if (error) throw error\r\n      toast.success('Assigned to self')\r\n      fetchIntake()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to assign')\r\n    }\r\n  }\r\n\r\n  const handleSaveNotes = async (id: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('executive_intake')\r\n        .update({ secretary_notes: notes })\r\n        .eq('id', id)\r\n\r\n      if (error) throw error\r\n      toast.success('Notes saved')\r\n      setSelectedItem(null)\r\n      fetchIntake()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to save notes')\r\n    }\r\n  }\r\n\r\n  const handleEscalate = async (id: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('executive_intake')\r\n        .update({ escalated_to_admin: true, status: 'escalated' })\r\n        .eq('id', id)\r\n\r\n      if (error) throw error\r\n      toast.success('Escalated to Admin')\r\n      fetchIntake()\r\n    } catch (error) {\r\n      console.error(error)\r\n      toast.error('Failed to escalate')\r\n    }\r\n  }\r\n\r\n  const filteredItems = intakeItems.filter(item => {\r\n    if (filterStatus !== 'all' && item.status !== filterStatus) return false\r\n    if (filterSeverity !== 'all' && item.severity !== filterSeverity) return false\r\n    return true\r\n  })\r\n\r\n  // Sort: Critical severity first, then payout related (if we had a way to identify them easily, maybe category)\r\n  const sortedItems = [...filteredItems].sort((a, b) => {\r\n    if (a.severity === 'critical' && b.severity !== 'critical') return -1\r\n    if (a.severity !== 'critical' && b.severity === 'critical') return 1\r\n    // Assume category 'payout' or similar exists\r\n    if (a.category === 'payout' && b.category !== 'payout') return -1\r\n    if (a.category !== 'payout' && b.category === 'payout') return 1\r\n    return 0\r\n  })\r\n\r\n  return (\r\n    <div className=\"bg-slate-800 rounded-lg border border-slate-700 p-6\">\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <h2 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n          <Clock className=\"w-5 h-5 text-blue-400\" />\r\n          Executive Intake\r\n        </h2>\r\n        <div className=\"flex gap-2\">\r\n          <select \r\n            className=\"bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm text-white\"\r\n            value={filterStatus}\r\n            onChange={(e) => setFilterStatus(e.target.value)}\r\n          >\r\n            <option value=\"all\">All Status</option>\r\n            <option value=\"new\">New</option>\r\n            <option value=\"in_progress\">In Progress</option>\r\n            <option value=\"resolved\">Resolved</option>\r\n            <option value=\"escalated\">Escalated</option>\r\n          </select>\r\n          <select \r\n            className=\"bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm text-white\"\r\n            value={filterSeverity}\r\n            onChange={(e) => setFilterSeverity(e.target.value)}\r\n          >\r\n            <option value=\"all\">All Severity</option>\r\n            <option value=\"critical\">Critical</option>\r\n            <option value=\"high\">High</option>\r\n            <option value=\"medium\">Medium</option>\r\n            <option value=\"low\">Low</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"space-y-4\">\r\n        {loading ? (\r\n          <div className=\"text-center py-8 text-slate-400\">Loading intake...</div>\r\n        ) : sortedItems.length === 0 ? (\r\n          <div className=\"text-center py-8 text-slate-400\">No intake items found</div>\r\n        ) : (\r\n          sortedItems.map(item => (\r\n            <div \r\n              key={item.id} \r\n              className={`bg-slate-900/50 p-4 rounded-lg border ${\r\n                item.severity === 'critical' ? 'border-red-500/50 bg-red-900/10' : 'border-slate-700'\r\n              }`}\r\n            >\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <div className=\"flex items-center gap-2 mb-1\">\r\n                    {item.severity === 'critical' && <AlertTriangle className=\"w-4 h-4 text-red-500\" />}\r\n                    <span className=\"font-semibold text-white\">{item.title || 'Untitled Request'}</span>\r\n                    <span className={`text-xs px-2 py-0.5 rounded-full ${\r\n                      item.status === 'new' ? 'bg-blue-500/20 text-blue-300' :\r\n                      item.status === 'resolved' ? 'bg-green-500/20 text-green-300' :\r\n                      item.status === 'escalated' ? 'bg-purple-500/20 text-purple-300' :\r\n                      'bg-yellow-500/20 text-yellow-300'\r\n                    }`}>\r\n                      {item.status.toUpperCase()}\r\n                    </span>\r\n                    <span className=\"text-xs text-slate-400 border border-slate-700 px-2 py-0.5 rounded\">\r\n                      {item.category}\r\n                    </span>\r\n                  </div>\r\n                  <p className=\"text-sm text-slate-300 mb-2\">{item.description}</p>\r\n                  <div className=\"text-xs text-slate-500 flex gap-4\">\r\n                    <span>ID: {item.id.slice(0, 8)}</span>\r\n                    <span>{new Date(item.created_at).toLocaleDateString()}</span>\r\n                    {item.assigned_secretary && <span className=\"text-blue-400\">Assigned: {item.assigned_secretary}</span>}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex flex-col gap-2\">\r\n                  {viewMode === 'secretary' && !item.assigned_secretary && (\r\n                    <button \r\n                      onClick={() => handleAssignSelf(item.id)}\r\n                      className=\"px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded transition-colors\"\r\n                    >\r\n                      Assign to Me\r\n                    </button>\r\n                  )}\r\n                  \r\n                  {selectedItem?.id === item.id ? (\r\n                    <div className=\"flex flex-col gap-2 min-w-[200px]\">\r\n                      <textarea\r\n                        className=\"w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white\"\r\n                        placeholder=\"Secretary notes...\"\r\n                        value={notes}\r\n                        onChange={(e) => setNotes(e.target.value)}\r\n                      />\r\n                      <div className=\"flex gap-2\">\r\n                        <button \r\n                          onClick={() => handleSaveNotes(item.id)}\r\n                          className=\"flex-1 bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded\"\r\n                        >\r\n                          Save\r\n                        </button>\r\n                        <button \r\n                          onClick={() => setSelectedItem(null)}\r\n                          className=\"flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs py-1 rounded\"\r\n                        >\r\n                          Cancel\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <button \r\n                      onClick={() => {\r\n                        setSelectedItem(item)\r\n                        setNotes(item.secretary_notes || '')\r\n                      }}\r\n                      className=\"px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors\"\r\n                    >\r\n                      {item.secretary_notes ? 'Edit Notes' : 'Add Notes'}\r\n                    </button>\r\n                  )}\r\n\r\n                  {item.status !== 'resolved' && (\r\n                    item.type === 'vehicle_title' && item.metadata?.car_id ? (\r\n                        <button \r\n                            onClick={() => handleSignTitle(item.id, item.metadata.car_id)}\r\n                            className=\"px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white text-xs rounded transition-colors flex items-center justify-center gap-1\"\r\n                        >\r\n                            <BadgeCheck className=\"w-3 h-3\" /> Notarize Title\r\n                        </button>\r\n                    ) : (\r\n                        <button \r\n                        onClick={() => handleUpdateStatus(item.id, 'resolved')}\r\n                        className=\"px-3 py-1 bg-green-600/20 hover:bg-green-600/30 text-green-300 border border-green-600/50 text-xs rounded transition-colors flex items-center justify-center gap-1\"\r\n                        >\r\n                        <CheckCircle className=\"w-3 h-3\" /> Resolve\r\n                        </button>\r\n                    )\r\n                  )}\r\n\r\n                  {item.status !== 'escalated' && !item.escalated_to_admin && item.type !== 'vehicle_title' && (\r\n                    <button \r\n                      onClick={() => handleEscalate(item.id)}\r\n                      className=\"px-3 py-1 bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 border border-purple-600/50 text-xs rounded transition-colors flex items-center justify-center gap-1\"\r\n                    >\r\n                      <ArrowUpCircle className=\"w-3 h-3\" /> Escalate\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              {item.secretary_notes && selectedItem?.id !== item.id && (\r\n                <div className=\"mt-3 pt-3 border-t border-slate-700/50\">\r\n                  <p className=\"text-xs text-slate-400 font-mono\">NOTES: {item.secretary_notes}</p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          ))\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\ExecutiveReportsList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\GiftCardFulfillmentList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\ManualCoinOrdersList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\ManualTrollPassOrdersList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\components\\shared\\PastorApplicationsList.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[173,180],"text":""},"desc":"Remove unused variable \"Clock\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\nimport { supabase } from '../../../../lib/supabase'\nimport { toast } from 'sonner'\nimport { BookOpen, CheckCircle, XCircle, Clock } from 'lucide-react'\n\ninterface Application {\n  id: string\n  user_id: string\n  type: string\n  status: string\n  data: any\n  created_at: string\n  user_profiles?: {\n    username: string\n    avatar_url: string\n  }\n}\n\nexport default function PastorApplicationsList() {\n  const [apps, setApps] = useState<Application[]>([])\n  const [loading, setLoading] = useState(true)\n\n  const fetchApps = async () => {\n    setLoading(true)\n    try {\n      const { data, error } = await supabase\n        .from('applications')\n        .select(`\n          *,\n          user_profiles:user_id (username, avatar_url)\n        `)\n        .eq('type', 'pastor')\n        .order('created_at', { ascending: false })\n\n      if (error) throw error\n      setApps(data || [])\n    } catch (err) {\n      console.error('Error fetching pastor apps:', err)\n      toast.error('Failed to load applications')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchApps()\n  }, [])\n\n  const handleAction = async (app: Application, status: 'approved' | 'rejected') => {\n    try {\n      // 1. Update application status\n      const { error: appError } = await supabase\n        .from('applications')\n        .update({ status })\n        .eq('id', app.id)\n\n      if (appError) throw appError\n\n      // 2. If approved, grant pastor role\n      if (status === 'approved') {\n        const { error: profileError } = await supabase\n          .from('user_profiles')\n          .update({ is_pastor: true })\n          .eq('id', app.user_id)\n\n        if (profileError) throw profileError\n        toast.success(`Approved ${app.user_profiles?.username} as Pastor`)\n      } else {\n        toast.info('Application rejected')\n      }\n\n      fetchApps()\n    } catch (err) {\n      console.error('Error updating application:', err)\n      toast.error('Failed to update application')\n    }\n  }\n\n  return (\n    <div className=\"bg-slate-800 rounded-lg border border-slate-700 p-6\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <h2 className=\"text-xl font-bold text-white flex items-center gap-2\">\n          <BookOpen className=\"w-5 h-5 text-purple-400\" />\n          Pastor Applications\n        </h2>\n      </div>\n\n      <div className=\"space-y-4\">\n        {loading ? (\n          <div className=\"text-center py-8 text-slate-400\">Loading...</div>\n        ) : apps.length === 0 ? (\n          <div className=\"text-center py-8 text-slate-400\">No pending pastor applications</div>\n        ) : (\n          apps.map(app => (\n            <div key={app.id} className=\"bg-slate-900/50 p-4 rounded-lg border border-slate-700\">\n              <div className=\"flex justify-between items-start mb-4\">\n                <div className=\"flex items-center gap-3\">\n                  <img \n                    src={app.user_profiles?.avatar_url || `https://ui-avatars.com/api/?name=${app.user_profiles?.username}`} \n                    className=\"w-10 h-10 rounded-full bg-slate-800\"\n                  />\n                  <div>\n                    <div className=\"font-bold text-white\">{app.user_profiles?.username}</div>\n                    <div className=\"text-xs text-slate-500\">{new Date(app.created_at).toLocaleDateString()}</div>\n                  </div>\n                </div>\n                <div className={`px-2 py-1 rounded text-xs font-bold uppercase ${\n                  app.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' :\n                  app.status === 'approved' ? 'bg-green-500/20 text-green-400' :\n                  'bg-red-500/20 text-red-400'\n                }`}>\n                  {app.status}\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-300 mb-4\">\n                <div>\n                  <span className=\"text-slate-500 block text-xs\">Denomination</span>\n                  {app.data.denomination}\n                </div>\n                <div>\n                  <span className=\"text-slate-500 block text-xs\">Motivation</span>\n                  {app.data.motivation}\n                </div>\n                <div>\n                  <span className=\"text-slate-500 block text-xs\">Experience</span>\n                  {app.data.experience}\n                </div>\n                <div>\n                  <span className=\"text-slate-500 block text-xs\">Availability</span>\n                  {app.data.availability}\n                </div>\n              </div>\n\n              {app.status === 'pending' && (\n                <div className=\"flex gap-2 justify-end border-t border-slate-700/50 pt-3\">\n                  <button\n                    onClick={() => handleAction(app, 'rejected')}\n                    className=\"px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors flex items-center gap-1.5 text-sm\"\n                  >\n                    <XCircle size={16} /> Reject\n                  </button>\n                  <button\n                    onClick={() => handleAction(app, 'approved')}\n                    className=\"px-3 py-1.5 rounded-lg bg-green-500/10 text-green-400 hover:bg-green-500/20 transition-colors flex items-center gap-1.5 text-sm\"\n                  >\n                    <CheckCircle size={16} /> Approve\n                  </button>\n                </div>\n              )}\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\hooks\\useRealtimeMetrics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\hooks\\useRealtimeStreams.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\hooks\\useRealtimeUsers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\admin\\hooks\\useSupabaseQuery.ts","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'filters' and 'orderBy'. Either include them or remove the dependency array.","line":50,"column":6,"nodeType":"ArrayExpression","endLine":50,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [table, select, filters, orderBy, limit]","fix":{"range":[1710,1756],"text":"[table, select, filters, orderBy, limit]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\church\\PastorDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[174,181],"text":""},"desc":"Remove unused variable \"Users\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Loader2' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Loader2"},"fix":{"range":[181,190],"text":""},"desc":"Remove unused variable \"Loader2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchNotes'. Either include it or remove the dependency array.","line":27,"column":6,"nodeType":"ArrayExpression","endLine":27,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [date, fetchNotes]","fix":{"range":[968,974],"text":"[date, fetchNotes]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":76,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":18},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":161,"column":28,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6193,6253],"text":"\n                      Send &quot;Live\" Alert\n                   "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6193,6253],"text":"\n                      Send &ldquo;Live\" Alert\n                   "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6193,6253],"text":"\n                      Send &#34;Live\" Alert\n                   "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6193,6253],"text":"\n                      Send &rdquo;Live\" Alert\n                   "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":161,"column":33,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6193,6253],"text":"\n                      Send \"Live&quot; Alert\n                   "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6193,6253],"text":"\n                      Send \"Live&ldquo; Alert\n                   "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6193,6253],"text":"\n                      Send \"Live&#34; Alert\n                   "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6193,6253],"text":"\n                      Send \"Live&rdquo; Alert\n                   "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport React, { useState, useEffect } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport { useAuthStore } from '@/lib/store';\nimport { Save, BookOpen, Mic, Gift, Users, Loader2 } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { useNavigate } from 'react-router-dom';\nimport PastorPayouts from './PastorPayouts';\n\nexport default function PastorDashboard() {\n  const { profile } = useAuthStore();\n  const navigate = useNavigate();\n  const [activeTab, setActiveTab] = useState<'sermon' | 'payouts'>('sermon');\n  const [notes, setNotes] = useState('');\n  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    if (profile && !profile.is_pastor && profile.role !== 'admin' && !(profile as any).is_admin) {\n       navigate('/church');\n       toast.error('Unauthorized access');\n    }\n  }, [profile, navigate]);\n\n  useEffect(() => {\n    fetchNotes();\n  }, [date]);\n\n  const fetchNotes = async () => {\n    setLoading(true);\n    try {\n      const { data } = await supabase\n        .from('church_sermon_notes')\n        .select('notes')\n        .eq('pastor_id', profile?.id)\n        .eq('date', date)\n        .maybeSingle();\n      \n      setNotes(data?.notes || '');\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSave = async () => {\n    try {\n      const { error } = await supabase\n        .from('church_sermon_notes')\n        .upsert({\n           pastor_id: profile?.id,\n           date: date,\n           notes: notes,\n           updated_at: new Date().toISOString()\n        }, { onConflict: 'pastor_id, date' });\n\n      if (error) throw error;\n      toast.success('Sermon notes saved');\n    } catch (err) {\n      toast.error('Failed to save notes');\n      console.error(err);\n    }\n  };\n\n  const handleBroadcast = async () => {\n     // Trigger a global announcement for church\n     try {\n       await supabase.from('admin_broadcasts').insert({\n          message: \"Troll Church is now LIVE! Join us for the Sunday Service.\",\n          type: 'info', // or 'church' if supported\n          is_active: true,\n          created_by: profile?.id\n       });\n       toast.success('Broadcast sent!');\n     } catch (err) {\n       toast.error('Failed to send broadcast');\n     }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-slate-950 text-white p-4 md:p-8\">\n       <div className=\"max-w-4xl mx-auto\">\n          <header className=\"mb-8 border-b border-white/10 pb-4 flex justify-between items-end\">\n             <div>\n                <h1 className=\"text-3xl font-bold flex items-center gap-3\">\n                    <BookOpen className=\"text-purple-400\" />\n                    Pastor Dashboard\n                </h1>\n                <p className=\"text-gray-400 mt-2\">Prepare your sermon and manage the service.</p>\n             </div>\n             \n             <div className=\"flex gap-2\">\n                <button \n                  onClick={() => setActiveTab('sermon')}\n                  className={`px-4 py-2 rounded-lg font-medium transition-colors ${activeTab === 'sermon' ? 'bg-purple-600 text-white' : 'bg-zinc-800 text-gray-400 hover:text-white'}`}\n                >\n                    Sermon & Live\n                </button>\n                <button \n                  onClick={() => setActiveTab('payouts')}\n                  className={`px-4 py-2 rounded-lg font-medium transition-colors ${activeTab === 'payouts' ? 'bg-green-600 text-white' : 'bg-zinc-800 text-gray-400 hover:text-white'}`}\n                >\n                    Earnings & Payouts\n                </button>\n             </div>\n          </header>\n\n          {activeTab === 'payouts' ? (\n            <PastorPayouts />\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                {/* Main Editor */}\n                <div className=\"md:col-span-2 space-y-6\">\n                    <div className=\"bg-zinc-900 border border-zinc-800 p-6 rounded-xl\">\n                   <div className=\"flex justify-between items-center mb-4\">\n                      <h2 className=\"font-bold flex items-center gap-2\">\n                         <Save size={18} className=\"text-blue-400\" />\n                         Sermon Notes\n                      </h2>\n                      <input \n                        type=\"date\" \n                        value={date} \n                        onChange={e => setDate(e.target.value)}\n                        className=\"bg-black border border-zinc-700 rounded px-2 py-1 text-sm\"\n                      />\n                   </div>\n                   \n                   <textarea\n                      value={notes}\n                      onChange={e => setNotes(e.target.value)}\n                      className=\"w-full h-96 bg-black/40 border border-zinc-700 rounded-lg p-4 text-gray-200 focus:outline-none focus:border-purple-500 font-mono\"\n                      placeholder=\"Write your sermon notes here...\"\n                   />\n                   \n                   <div className=\"mt-4 flex justify-end\">\n                      <button \n                        onClick={handleSave}\n                        className=\"px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold flex items-center gap-2\"\n                      >\n                         <Save size={18} />\n                         Save Notes\n                      </button>\n                   </div>\n                </div>\n             </div>\n\n             {/* Sidebar Tools */}\n             <div className=\"space-y-6\">\n                <div className=\"bg-zinc-900 border border-zinc-800 p-6 rounded-xl\">\n                   <h2 className=\"font-bold mb-4 flex items-center gap-2\">\n                      <Mic size={18} className=\"text-red-400\" />\n                      Live Controls\n                   </h2>\n                   \n                   <button \n                     onClick={handleBroadcast}\n                     className=\"w-full py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold mb-3 flex items-center justify-center gap-2\"\n                   >\n                      <Mic size={18} />\n                      Send \"Live\" Alert\n                   </button>\n                   <p className=\"text-xs text-gray-500 text-center\">\n                      Sends a global notification that Church is live.\n                   </p>\n                </div>\n\n                <div className=\"bg-zinc-900 border border-zinc-800 p-6 rounded-xl\">\n                   <h2 className=\"font-bold mb-4 flex items-center gap-2\">\n                      <Gift size={18} className=\"text-amber-400\" />\n                      Sunday Gifts\n                   </h2>\n                   <div className=\"text-center py-4 bg-black/20 rounded-lg border border-white/5\">\n                      <p className=\"text-2xl font-bold text-amber-400\">0</p>\n                      <p className=\"text-xs text-gray-500 uppercase tracking-wide\">Coins Received</p>\n                   </div>\n                </div>\n             </div>\n          </div>\n          )}\n       </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\church\\PastorPayouts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\dev\\XPSimulatorPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\government\\GovernmentStreams.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Mic' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":6,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Mic"},"fix":{"range":[204,212],"text":""},"desc":"Remove unused variable \"Mic\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MessageSquare' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MessageSquare"},"fix":{"range":[223,241],"text":""},"desc":"Remove unused variable \"MessageSquare\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'format12hr' is defined but never used. Allowed unused vars must match /^_/u.","line":19,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":20,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"format12hr"},"fix":{"range":[340,388],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useParticipant' is defined but never used. Allowed unused vars must match /^_/u.","line":23,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useParticipant"},"fix":{"range":[438,457],"text":""},"desc":"Remove unused variable \"useParticipant\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Track' is defined but never used. Allowed unused vars must match /^_/u.","line":26,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Track"},"fix":{"range":[515,554],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":67,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":67,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":68,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'stream.broadcaster.avatar_url', 'stream.broadcaster.username', and 'stream.broadcaster_id'. Either include them or remove the dependency array.","line":539,"column":6,"nodeType":"ArrayExpression","endLine":539,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [stream.broadcaster.avatar_url, stream.broadcaster.username, stream.broadcaster_id, stream.id]","fix":{"range":[19596,19607],"text":"[stream.broadcaster.avatar_url, stream.broadcaster.username, stream.broadcaster_id, stream.id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useMemo } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { supabase } from '@/lib/supabase';\nimport { \n  Users, \n  Radio, \n  Shield, \n  Eye, \n  X, \n  Mic, \n  MicOff, \n  MessageSquare, \n  MessageSquareOff, \n  Gavel, \n  StopCircle,\n  Activity,\n  AlertTriangle\n} from 'lucide-react';\nimport { format12hr } from '@/utils/timeFormat';\nimport { LiveKitRoom, \n  VideoTrack, \n  useTracks, \n  useParticipant,\n  RoomAudioRenderer\n} from '@livekit/components-react';\nimport { Track } from 'livekit-client';\nimport { useLiveKitToken } from '@/hooks/useLiveKitToken';\nimport { toast } from 'sonner';\nimport { useAuthStore } from '@/lib/store';\n\n// Types\ninterface OfficerLog {\n  officer_id: string;\n  actions_taken: number;\n  joined_at: string;\n  officer: {\n    username: string;\n    avatar_url: string;\n  };\n}\n\ninterface StreamRow {\n  id: string;\n  broadcaster_id: string;\n  status: string;\n  is_live: boolean;\n  current_viewers: number;\n  title: string;\n  room_name: string;\n  category: string;\n  start_time: string;\n  broadcaster: {\n    username: string;\n    avatar_url: string;\n  };\n  active_officers?: OfficerLog[];\n}\n\ninterface StreamParticipant {\n  user_id: string;\n  username: string;\n  avatar_url?: string;\n  is_active: boolean;\n}\n\nexport default function GovernmentStreams() {\n  const navigate = useNavigate();\n  const { user } = useAuthStore();\n  const [streams, setStreams] = useState<StreamRow[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [selectedStream, setSelectedStream] = useState<StreamRow | null>(null);\n  const [summonModalOpen, setSummonModalOpen] = useState(false);\n  const [summonTargetStream, setSummonTargetStream] = useState<StreamRow | null>(null);\n\n  const fetchStreams = async () => {\n    try {\n      setLoading(true);\n      \n      // Fetch active streams\n      const { data: streamsData, error } = await supabase\n        .from('streams')\n        .select(`\n          *,\n          broadcaster:user_profiles!broadcaster_id(username, avatar_url)\n        `)\n        .eq('is_live', true)\n        .eq('status', 'live')\n        .order('current_viewers', { ascending: false });\n\n      if (error) throw error;\n\n      // Fetch active officers for these streams\n      const streamIds = streamsData.map(s => s.id);\n      const { data: officerLogs } = await supabase\n        .from('officer_stream_logs')\n        .select(`\n          stream_id,\n          officer_id,\n          actions_taken,\n          joined_at,\n          officer:user_profiles!officer_id(username, avatar_url)\n        `)\n        .in('stream_id', streamIds)\n        .is('left_at', null);\n\n      // Merge data\n      const streamsWithOfficers = streamsData.map(stream => ({\n        ...stream,\n        active_officers: officerLogs?.filter(log => log.stream_id === stream.id) || []\n      }));\n\n      setStreams(streamsWithOfficers);\n    } catch (error) {\n      console.error('Error fetching streams:', error);\n      toast.error('Failed to load streams');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchStreams();\n    const interval = setInterval(fetchStreams, 10000); // Refresh every 10s\n    return () => clearInterval(interval);\n  }, []);\n\n  const handleEndLive = async (streamId: string) => {\n    if (!confirm('Are you sure you want to FORCE END this stream?')) return;\n    try {\n      const { error } = await supabase\n        .from('streams')\n        .update({ \n          status: 'ended', \n          is_live: false, \n          ended_at: new Date().toISOString() \n        })\n        .eq('id', streamId);\n\n      if (error) throw error;\n      toast.success('Stream ended successfully');\n      fetchStreams();\n    } catch (error) {\n      console.error('Error ending stream:', error);\n      toast.error('Failed to end stream');\n    }\n  };\n\n  const handleMuteBroadcaster = async (stream: StreamRow) => {\n    if (!confirm(`Are you sure you want to MUTE broadcaster ${stream.broadcaster.username}?`)) return;\n    try {\n      // Mute by disabling their chat capability in participants table (if they are a participant in their own stream logic)\n      // Or if there is a specific 'is_muted' flag. \n      // Based on LivePage logic, we mute participants.\n      // Broadcaster is also a participant usually.\n      \n      // Calculate 10 mins mute\n      const until = new Date(Date.now() + 10 * 60 * 1000).toISOString();\n      \n      await supabase\n        .from('streams_participants')\n        .update({ can_chat: false, chat_mute_until: until })\n        .eq('stream_id', stream.id)\n        .eq('user_id', stream.broadcaster_id);\n        \n      toast.success(`Broadcaster muted for 10 minutes`);\n    } catch (error) {\n      console.error('Error muting broadcaster:', error);\n      toast.error('Failed to mute broadcaster');\n    }\n  };\n\n  const handleDisableAllChats = async (streamId: string) => {\n    if (!confirm('Are you sure you want to DISABLE ALL CHATS for this stream?')) return;\n    try {\n      await supabase\n        .from('streams_participants')\n        .update({ can_chat: false, chat_mute_until: null }) // null means permanent/indefinite until cleared\n        .eq('stream_id', streamId);\n        \n      toast.success('All chats disabled for this stream');\n    } catch (error) {\n      console.error('Error disabling chats:', error);\n      toast.error('Failed to disable chats');\n    }\n  };\n\n  const handleSummonClick = (stream: StreamRow) => {\n    setSummonTargetStream(stream);\n    setSummonModalOpen(true);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#0A0814] via-[#0D0D1A] to-[#14061A] text-white p-6 md:p-10\">\n      <div className=\"max-w-7xl mx-auto space-y-8\">\n        \n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-white/10 pb-6\">\n          <div>\n            <h1 className=\"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400 flex items-center gap-3\">\n              <Shield className=\"w-8 h-8 text-purple-400\" />\n              Government Streams\n            </h1>\n            <p className=\"text-gray-400 mt-2\">Monitor, Moderate, and Enforce Troll City Laws</p>\n          </div>\n          <button \n            onClick={fetchStreams}\n            className=\"px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm font-medium transition-colors flex items-center gap-2\"\n          >\n            <Activity className=\"w-4 h-4\" />\n            Refresh Feed\n          </button>\n        </div>\n\n        {/* Grid */}\n        {loading && streams.length === 0 ? (\n          <div className=\"text-center py-20\">\n            <div className=\"animate-spin w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full mx-auto mb-4\"></div>\n            <p className=\"text-gray-500\">Scanning frequencies...</p>\n          </div>\n        ) : streams.length === 0 ? (\n          <div className=\"text-center py-20 bg-white/5 rounded-2xl border border-white/10\">\n            <Radio className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\n            <h3 className=\"text-xl font-bold text-gray-300\">No Active Broadcasts</h3>\n            <p className=\"text-gray-500 mt-2\">The city is currently quiet.</p>\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n            {streams.map(stream => (\n              <StreamCard \n                key={stream.id} \n                stream={stream} \n                onWatch={() => setSelectedStream(stream)}\n                onEndLive={() => handleEndLive(stream.id)}\n                onMuteBroadcaster={() => handleMuteBroadcaster(stream)}\n                onDisableChats={() => handleDisableAllChats(stream.id)}\n                onSummon={() => handleSummonClick(stream)}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Watch Modal */}\n      {selectedStream && (\n        <WatchModal \n          stream={selectedStream} \n          onClose={() => setSelectedStream(null)} \n        />\n      )}\n\n      {/* Summon Modal */}\n      {summonModalOpen && summonTargetStream && (\n        <SummonModal \n          stream={summonTargetStream} \n          onClose={() => {\n            setSummonModalOpen(false);\n            setSummonTargetStream(null);\n          }} \n        />\n      )}\n    </div>\n  );\n}\n\nfunction StreamCard({ \n  stream, \n  onWatch, \n  onEndLive, \n  onMuteBroadcaster, \n  onDisableChats, \n  onSummon \n}: { \n  stream: StreamRow; \n  onWatch: () => void;\n  onEndLive: () => void;\n  onMuteBroadcaster: () => void;\n  onDisableChats: () => void;\n  onSummon: () => void;\n}) {\n  return (\n    <div className=\"group bg-black/40 border border-purple-900/30 hover:border-purple-500/50 rounded-2xl overflow-hidden transition-all duration-300 flex flex-col\">\n      {/* Header Info */}\n      <div className=\"p-4 bg-gradient-to-r from-purple-900/20 to-transparent border-b border-white/5 flex items-start justify-between\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-full bg-purple-900/50 p-0.5 border border-purple-500/30\">\n            <img \n              src={stream.broadcaster?.avatar_url || `https://ui-avatars.com/api/?name=${stream.broadcaster?.username}&background=random`} \n              alt={stream.broadcaster?.username}\n              className=\"w-full h-full rounded-full object-cover\"\n            />\n          </div>\n          <div>\n            <h3 className=\"font-bold text-white truncate max-w-[150px]\">{stream.title || 'Untitled Stream'}</h3>\n            <div className=\"text-xs text-purple-300 font-medium\">@{stream.broadcaster?.username}</div>\n          </div>\n        </div>\n        <div className=\"flex flex-col items-end gap-1\">\n          <span className=\"flex items-center gap-1.5 px-2 py-0.5 bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] font-bold rounded-full animate-pulse\">\n            <div className=\"w-1.5 h-1.5 rounded-full bg-red-500\"></div>\n            LIVE\n          </span>\n          <span className=\"flex items-center gap-1 text-xs text-gray-400\">\n            <Users className=\"w-3 h-3\" />\n            {stream.current_viewers}\n          </span>\n        </div>\n      </div>\n\n      {/* Officer Presence */}\n      <div className=\"px-4 py-2 bg-black/60 border-b border-white/5 min-h-[40px] flex items-center\">\n        {stream.active_officers && stream.active_officers.length > 0 ? (\n          <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar\">\n            <Shield className=\"w-3 h-3 text-emerald-400 shrink-0\" />\n            {stream.active_officers.map(log => (\n              <div key={log.officer_id} className=\"flex items-center gap-1.5 bg-emerald-900/20 px-2 py-0.5 rounded-full border border-emerald-500/20 shrink-0\">\n                <img src={log.officer.avatar_url} className=\"w-4 h-4 rounded-full\" />\n                <span className=\"text-[10px] text-emerald-300 font-medium\">{log.officer.username}</span>\n                {log.actions_taken > 0 && (\n                  <span className=\"text-[9px] bg-emerald-500/20 text-emerald-200 px-1 rounded-full\">{log.actions_taken} acts</span>\n                )}\n              </div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-xs text-gray-500 italic flex items-center gap-1.5\">\n            <AlertTriangle className=\"w-3 h-3\" />\n            No officers present\n          </div>\n        )}\n      </div>\n\n      {/* Actions Grid */}\n      <div className=\"p-4 grid grid-cols-2 gap-2 mt-auto\">\n        <button \n          onClick={onWatch}\n          className=\"col-span-2 flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold rounded-xl transition-all shadow-[0_4px_12px_rgba(147,51,234,0.3)]\"\n        >\n          <Eye className=\"w-4 h-4\" />\n          Watch Live\n        </button>\n        \n        <button \n          onClick={onEndLive}\n          className=\"flex items-center justify-center gap-1.5 px-3 py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-500/30 text-red-200 text-xs font-semibold rounded-lg transition-colors\"\n        >\n          <StopCircle className=\"w-3.5 h-3.5\" />\n          End Live\n        </button>\n\n        <button \n          onClick={onSummon}\n          className=\"flex items-center justify-center gap-1.5 px-3 py-2 bg-orange-900/30 hover:bg-orange-900/50 border border-orange-500/30 text-orange-200 text-xs font-semibold rounded-lg transition-colors\"\n        >\n          <Gavel className=\"w-3.5 h-3.5\" />\n          Summon\n        </button>\n\n        <button \n          onClick={onMuteBroadcaster}\n          className=\"flex items-center justify-center gap-1.5 px-3 py-2 bg-yellow-900/30 hover:bg-yellow-900/50 border border-yellow-500/30 text-yellow-200 text-xs font-semibold rounded-lg transition-colors\"\n        >\n          <MicOff className=\"w-3.5 h-3.5\" />\n          Mute Host\n        </button>\n\n        <button \n          onClick={onDisableChats}\n          className=\"flex items-center justify-center gap-1.5 px-3 py-2 bg-blue-900/30 hover:bg-blue-900/50 border border-blue-500/30 text-blue-200 text-xs font-semibold rounded-lg transition-colors\"\n        >\n          <MessageSquareOff className=\"w-3.5 h-3.5\" />\n          No Chat\n        </button>\n      </div>\n    </div>\n  );\n}\n\n// Watch Modal using LiveKit\nfunction WatchModal({ stream, onClose }: { stream: StreamRow; onClose: () => void }) {\n  const { user } = useAuthStore();\n  \n  // Logic from LivePage to determine room name\n  const roomName = useMemo(() => {\n    // Note: LivePage uses stream.agora_channel as primary source for legacy reasons, \n    // but newer streams use room_name. \n    // We check both to be safe and match LivePage behavior.\n    const s = stream as any;\n    return s.agora_channel || s.room_name || stream.id;\n  }, [stream]);\n\n  const { token, serverUrl, error } = useLiveKitToken({\n    streamId: stream.id,\n    isHost: false,\n    userId: user?.id,\n    roomName: roomName\n  });\n\n  if (error) {\n    return (\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4\">\n        <div className=\"bg-[#1a1a1a] p-6 rounded-2xl border border-red-500/50 text-center max-w-sm\">\n          <AlertTriangle className=\"w-12 h-12 text-red-500 mx-auto mb-4\" />\n          <h3 className=\"text-xl font-bold text-white mb-2\">Connection Failed</h3>\n          <p className=\"text-gray-400 mb-6\">{error}</p>\n          <button onClick={onClose} className=\"px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white font-bold\">Close</button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-in fade-in duration-200\">\n      <div className=\"relative w-full max-w-5xl aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/10\">\n        <button \n          onClick={onClose}\n          className=\"absolute top-4 right-4 z-50 p-2 bg-black/50 hover:bg-red-600 rounded-full text-white transition-colors\"\n        >\n          <X className=\"w-6 h-6\" />\n        </button>\n        \n        {token && serverUrl ? (\n          <LiveKitRoom\n            token={token}\n            serverUrl={serverUrl}\n            connect={true}\n            video={false}\n            audio={false}\n            onDisconnected={onClose}\n            className=\"w-full h-full\"\n          >\n             <StreamViewer />\n             <RoomAudioRenderer />\n          </LiveKitRoom>\n        ) : (\n          <div className=\"w-full h-full flex items-center justify-center text-white\">\n            <div className=\"animate-spin w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full mr-3\"></div>\n            Connecting to secure feed...\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction StreamViewer() {\n  const tracks = useTracks();\n  \n  // Filter for camera tracks\n  const videoTracks = tracks.filter(track => track.source === 'camera');\n  \n  if (videoTracks.length === 0) {\n    return (\n      <div className=\"w-full h-full flex items-center justify-center bg-zinc-900 text-gray-500\">\n        Waiting for video feed...\n      </div>\n    );\n  }\n\n  // Simple grid for multiple participants\n  const gridClass = videoTracks.length === 1 \n    ? \"grid-cols-1\" \n    : videoTracks.length <= 4 \n      ? \"grid-cols-2\" \n      : \"grid-cols-3\";\n\n  return (\n    <div className={`grid ${gridClass} gap-2 w-full h-full p-2 bg-black`}>\n      {videoTracks.map((track) => (\n        <div key={track.participant.identity} className=\"relative bg-zinc-800 rounded-xl overflow-hidden\">\n          <VideoTrack trackRef={track} className=\"w-full h-full object-cover\" />\n          <div className=\"absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white font-medium\">\n            {track.participant.identity}\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n\n// Summon Modal\nfunction SummonModal({ stream, onClose }: { stream: StreamRow; onClose: () => void }) {\n  const [participants, setParticipants] = useState<StreamParticipant[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [selectedUserId, setSelectedUserId] = useState('');\n  const [reason, setReason] = useState('Disorderly Conduct');\n  const [submitting, setSubmitting] = useState(false);\n\n  useEffect(() => {\n    const loadParticipants = async () => {\n      try {\n        const { data } = await supabase\n          .from('stream_participants') // Note: LivePage uses 'streams_participants' but schema showed 'stream_participants'. I'll check table name again.\n          // Wait, schema tool output showed 'stream_participants' (singular stream).\n          // But LivePage code used 'streams_participants' (plural streams).\n          // I will use 'stream_participants' as per schema tool output, but double check.\n          // Schema output: table \"stream_participants\". Relationships: \"stream_participants_stream_id_fkey\".\n          // LivePage line 222: .from('streams_participants').\n          // This suggests the table name might be `streams_participants` in reality if LivePage works.\n          // Or maybe I misread schema output?\n          // Schema output said: \"name\":\"stream_participants\".\n          // I will try 'stream_participants' first. If it fails, I'll try 'streams_participants'.\n          // Actually, I'll use `stream_participants` as returned by schema tool.\n          .select('user_id, username, is_active')\n          .eq('stream_id', stream.id)\n          .eq('is_active', true);\n\n        if (data) {\n          // Also fetch profiles for avatars\n          const userIds = data.map(p => p.user_id);\n          const { data: profiles } = await supabase\n            .from('user_profiles')\n            .select('id, avatar_url')\n            .in('id', userIds);\n            \n          const merged = data.map(p => ({\n            ...p,\n            avatar_url: profiles?.find(prof => prof.id === p.user_id)?.avatar_url\n          }));\n          \n          // Add broadcaster if not in list\n          if (!merged.find(p => p.user_id === stream.broadcaster_id)) {\n            merged.unshift({\n              user_id: stream.broadcaster_id,\n              username: stream.broadcaster.username,\n              avatar_url: stream.broadcaster.avatar_url,\n              is_active: true\n            });\n          }\n          \n          setParticipants(merged);\n        }\n      } catch (err) {\n        console.error('Error loading participants', err);\n      } finally {\n        setLoading(false);\n      }\n    };\n    loadParticipants();\n  }, [stream.id]);\n\n  const handleSummon = async () => {\n    if (!selectedUserId) {\n      toast.error('Please select a user');\n      return;\n    }\n    setSubmitting(true);\n    try {\n      // Create a court case or docket entry\n      // For now, I'll create a generic notification and log it.\n      // Ideally this creates a row in `court_cases` with status 'summoned'.\n      \n      const { error } = await supabase.from('court_cases').insert({\n        title: `Summon from Stream: ${stream.title}`,\n        description: `User summoned by officer from stream ${stream.id}. Reason: ${reason}`,\n        defendant_id: selectedUserId,\n        status: 'waiting', // or 'summoned' if valid\n        case_type: 'civil', // default\n        severity: '1'\n      });\n\n      if (error) throw error;\n\n      toast.success('User summoned to court successfully');\n      onClose();\n    } catch (err) {\n      console.error('Summon failed', err);\n      toast.error('Failed to summon user');\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4\">\n      <div className=\"bg-[#151515] w-full max-w-md rounded-2xl border border-orange-500/30 shadow-2xl overflow-hidden\">\n        <div className=\"p-4 bg-orange-900/20 border-b border-orange-500/20 flex justify-between items-center\">\n          <h3 className=\"text-lg font-bold text-orange-400 flex items-center gap-2\">\n            <Gavel className=\"w-5 h-5\" />\n            Summon to Court\n          </h3>\n          <button onClick={onClose} className=\"text-gray-400 hover:text-white\"><X className=\"w-5 h-5\" /></button>\n        </div>\n        \n        <div className=\"p-6 space-y-4\">\n          <div>\n            <label className=\"block text-xs font-bold text-gray-400 uppercase mb-2\">Select User from Stream</label>\n            {loading ? (\n              <div className=\"text-center py-4 text-gray-500\">Loading participants...</div>\n            ) : (\n              <select \n                className=\"w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-orange-500 outline-none\"\n                value={selectedUserId}\n                onChange={(e) => setSelectedUserId(e.target.value)}\n              >\n                <option value=\"\">-- Select User --</option>\n                {participants.map(p => (\n                  <option key={p.user_id} value={p.user_id}>\n                    {p.username} {p.user_id === stream.broadcaster_id ? '(Host)' : ''}\n                  </option>\n                ))}\n              </select>\n            )}\n          </div>\n\n          <div>\n            <label className=\"block text-xs font-bold text-gray-400 uppercase mb-2\">Reason for Summons</label>\n            <select \n              className=\"w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-orange-500 outline-none\"\n              value={reason}\n              onChange={(e) => setReason(e.target.value)}\n            >\n              <option value=\"Disorderly Conduct\">Disorderly Conduct</option>\n              <option value=\"Troll Toll Evasion\">Troll Toll Evasion</option>\n              <option value=\"Harassment\">Harassment</option>\n              <option value=\"Illegal Broadcasting\">Illegal Broadcasting</option>\n              <option value=\"Public Nuisance\">Public Nuisance</option>\n              <option value=\"Other\">Other</option>\n            </select>\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button \n              onClick={onClose}\n              className=\"flex-1 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm font-medium transition-colors\"\n            >\n              Cancel\n            </button>\n            <button \n              onClick={handleSummon}\n              disabled={submitting || !selectedUserId}\n              className=\"flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm font-bold text-white transition-colors shadow-lg shadow-orange-900/20\"\n            >\n              {submitting ? 'Issuing...' : 'Issue Summons'}\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\lead-officer\\LeadOfficerDashboard.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadWeeklyReports'. Either include it or remove the dependency array.","line":94,"column":6,"nodeType":"ArrayExpression","endLine":94,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [currentUserId, loadWeeklyReports]","fix":{"range":[3069,3084],"text":"[currentUserId, loadWeeklyReports]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\lead-officer\\Review.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\lead-officer\\TimeOffRequestsList.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":139,"column":95,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4903,4904],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4903,4904],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4903,4904],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4903,4904],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":139,"column":108,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4916,4917],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4916,4917],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4916,4917],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4916,4917],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { CheckCircle, XCircle, Clock } from 'lucide-react'\r\nimport ClickableUsername from '../../components/ClickableUsername'\r\n\r\ninterface TimeOffRequest {\r\n  id: string\r\n  officer_id: string\r\n  date: string\r\n  reason: string | null\r\n  status: string\r\n  created_at: string\r\n  officer: {\r\n    username: string\r\n    avatar_url: string | null\r\n  }\r\n}\r\n\r\nexport default function TimeOffRequestsList() {\r\n  const [requests, setRequests] = useState<TimeOffRequest[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  const loadRequests = async () => {\r\n    setLoading(true)\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('officer_time_off_requests')\r\n        .select(`\r\n          *,\r\n          officer:user_profiles!officer_time_off_requests_officer_id_fkey(username, avatar_url)\r\n        `)\r\n        .eq('status', 'pending')\r\n        .order('created_at', { ascending: true })\r\n\r\n      if (error) throw error\r\n      setRequests(data as any || [])\r\n    } catch (err: any) {\r\n      console.error('Error loading time off requests:', err)\r\n      toast.error('Failed to load time off requests')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleAction = async (requestId: string, action: 'approve' | 'reject', officerId: string, date: string) => {\r\n    if (!confirm(`Are you sure you want to ${action} this request?`)) return\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('officer_time_off_requests')\r\n        .update({\r\n          status: action === 'approve' ? 'approved' : 'rejected',\r\n          reviewed_by: (await supabase.auth.getUser()).data.user?.id,\r\n          reviewed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', requestId)\r\n\r\n      if (error) throw error\r\n\r\n      if (action === 'approve') {\r\n        // Try to delete any existing shift for this date\r\n        const { error: deleteError } = await supabase\r\n          .from('officer_shift_slots')\r\n          .delete()\r\n          .eq('officer_id', officerId)\r\n          .eq('shift_date', date)\r\n          .eq('status', 'scheduled') // Only delete scheduled shifts, not active/completed if that logic exists\r\n\r\n        if (deleteError) {\r\n          console.error('Error deleting shift:', deleteError)\r\n        }\r\n      }\r\n\r\n      // Notify officer\r\n      await supabase.from('notifications').insert({\r\n        user_id: officerId,\r\n        type: 'shift_update',\r\n        message: `Your time off request for ${date} has been ${action}d.${action === 'approve' ? ' Any scheduled shift for this date has been removed.' : ''}`,\r\n        is_read: false\r\n      })\r\n      \r\n      toast.success(`Request ${action}d`)\r\n      loadRequests()\r\n    } catch (err: any) {\r\n      toast.error(err.message)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    loadRequests()\r\n    \r\n    // Subscribe to new requests\r\n    const channel = supabase\r\n      .channel('time_off_requests_changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'officer_time_off_requests'\r\n        },\r\n        () => {\r\n          loadRequests()\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel)\r\n    }\r\n  }, [])\r\n\r\n  if (loading && requests.length === 0) return <div className=\"text-gray-400 text-sm animate-pulse\">Loading requests...</div>\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n        <div className=\"flex items-center justify-between\">\r\n            <h3 className=\"text-lg font-semibold text-white flex items-center gap-2\">\r\n                <Clock className=\"w-5 h-5 text-orange-400\" />\r\n                Pending Time Off Requests\r\n            </h3>\r\n            <button onClick={loadRequests} className=\"text-xs text-blue-400 hover:text-blue-300\">Refresh</button>\r\n        </div>\r\n\r\n      {requests.length === 0 ? (\r\n        <p className=\"text-gray-500 text-sm italic\">No pending time off requests.</p>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 gap-3\">\r\n          {requests.map((req) => (\r\n            <div key={req.id} className=\"bg-black/40 border border-orange-500/20 hover:border-orange-500/40 transition rounded-lg p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n              <div>\r\n                <div className=\"flex items-center gap-2 mb-1\">\r\n                    <ClickableUsername userId={req.officer_id} username={req.officer?.username || 'Unknown'} />\r\n                    <span className=\"text-gray-400 text-sm\">requested off for</span>\r\n                    <span className=\"text-orange-200 font-bold bg-orange-500/10 px-2 py-0.5 rounded\">{req.date}</span>\r\n                </div>\r\n                {req.reason && (\r\n                    <p className=\"text-sm text-gray-400 ml-1 border-l-2 border-gray-700 pl-2\">\"{req.reason}\"</p>\r\n                )}\r\n                <p className=\"text-xs text-gray-600 mt-2\">Requested: {new Date(req.created_at).toLocaleString()}</p>\r\n              </div>\r\n              \r\n              <div className=\"flex gap-2 shrink-0\">\r\n                <button\r\n                  onClick={() => handleAction(req.id, 'approve', req.officer_id, req.date)}\r\n                  className=\"px-3 py-1.5 bg-green-900/30 text-green-400 border border-green-800/50 rounded hover:bg-green-900/50 transition flex items-center gap-2 text-sm font-medium\"\r\n                >\r\n                  <CheckCircle className=\"w-4 h-4\" />\r\n                  Approve\r\n                </button>\r\n                <button\r\n                  onClick={() => handleAction(req.id, 'reject', req.officer_id, req.date)}\r\n                  className=\"px-3 py-1.5 bg-red-900/30 text-red-400 border border-red-800/50 rounded hover:bg-red-900/50 transition flex items-center gap-2 text-sm font-medium\"\r\n                >\r\n                  <XCircle className=\"w-4 h-4\" />\r\n                  Reject\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\CreatorEarnings.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":22,"column":29,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[840,1013],"text":"\r\n              Creators earn coins when viewers send gifts during their streams. All gifted coins are added\r\n              to the creator&apos;s paid coin balance.\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[840,1013],"text":"\r\n              Creators earn coins when viewers send gifts during their streams. All gifted coins are added\r\n              to the creator&lsquo;s paid coin balance.\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[840,1013],"text":"\r\n              Creators earn coins when viewers send gifts during their streams. All gifted coins are added\r\n              to the creator&#39;s paid coin balance.\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[840,1013],"text":"\r\n              Creators earn coins when viewers send gifts during their streams. All gifted coins are added\r\n              to the creator&rsquo;s paid coin balance.\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Creator Earnings Policy page\r\nimport React from 'react'\r\nimport { Link } from 'react-router-dom'\r\nimport { ArrowLeft } from 'lucide-react'\r\n\r\nexport default function CreatorEarnings() {\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        <Link to=\"/legal\" className=\"inline-flex items-center gap-2 text-gray-400 hover:text-white mb-6\">\r\n          <ArrowLeft className=\"w-4 h-4\" />\r\n          Back to Policy Center\r\n        </Link>\r\n\r\n        <h1 className=\"text-4xl font-bold mb-6\">Creator Earnings Policy</h1>\r\n\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-8 space-y-6\">\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">How Creators Earn</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              Creators earn coins when viewers send gifts during their streams. All gifted coins are added\r\n              to the creator's paid coin balance.\r\n            </p>\r\n          </section>\r\n\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Payouts</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              Creators can request payouts when they reach the minimum threshold (12,000 coins ‚âà $36).\r\n              Payouts are processed manually and subject to platform fees (5% commission).\r\n            </p>\r\n          </section>\r\n\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Tax Requirements</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              Creators earning over $600 per year will receive a 1099 tax form as required by IRS regulations.\r\n              You must complete onboarding (W9 information) before receiving payouts.\r\n            </p>\r\n          </section>\r\n\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Platform Fees</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              Platform commission: 5% per gift. Payment processing fees: 2.9% + $0.30 per payout transaction.\r\n            </p>\r\n          </section>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\GamblingDisclosure.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\PartnerProgram.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":37,"column":50,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[1560,1769],"text":"\r\n              Partners earn 5% of a referred user&apos;s earned coins once that user reaches 40,000 coins in a\r\n              calendar month. Bonuses are paid in troll_coins (not cash withdrawable).\r\n            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[1560,1769],"text":"\r\n              Partners earn 5% of a referred user&lsquo;s earned coins once that user reaches 40,000 coins in a\r\n              calendar month. Bonuses are paid in troll_coins (not cash withdrawable).\r\n            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[1560,1769],"text":"\r\n              Partners earn 5% of a referred user&#39;s earned coins once that user reaches 40,000 coins in a\r\n              calendar month. Bonuses are paid in troll_coins (not cash withdrawable).\r\n            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[1560,1769],"text":"\r\n              Partners earn 5% of a referred user&rsquo;s earned coins once that user reaches 40,000 coins in a\r\n              calendar month. Bonuses are paid in troll_coins (not cash withdrawable).\r\n            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Partner Program Terms page\r\nimport React from 'react'\r\nimport { Link } from 'react-router-dom'\r\nimport { ArrowLeft } from 'lucide-react'\r\n\r\nexport default function PartnerProgram() {\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        <Link to=\"/legal\" className=\"inline-flex items-center gap-2 text-gray-400 hover:text-white mb-6\">\r\n          <ArrowLeft className=\"w-4 h-4\" />\r\n          Back to Policy Center\r\n        </Link>\r\n\r\n        <h1 className=\"text-4xl font-bold mb-6\">Troll Empire Partner Program</h1>\r\n\r\n        <div className=\"bg-[#141414] border border-[#2C2C2C] rounded-xl p-8 space-y-6\">\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Program Overview</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              The Troll Empire Partner Program allows approved creators to earn referral bonuses by recruiting\r\n              new users who become active streamers.\r\n            </p>\r\n          </section>\r\n\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Eligibility</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              Partners must apply and pay a one-time fee ($15 or 1500 troll_coins) to join. Only approved\r\n              partners can earn referral bonuses.\r\n            </p>\r\n          </section>\r\n\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Referral Bonus</h2>\r\n            <p className=\"text-gray-300 leading-relaxed\">\r\n              Partners earn 5% of a referred user's earned coins once that user reaches 40,000 coins in a\r\n              calendar month. Bonuses are paid in troll_coins (not cash withdrawable).\r\n            </p>\r\n          </section>\r\n\r\n          <section>\r\n            <h2 className=\"text-2xl font-semibold mb-4\">Rules</h2>\r\n            <ul className=\"list-disc list-inside text-gray-300 space-y-2 ml-4\">\r\n              <li>Referrals must be real, unique, active users</li>\r\n              <li>Abuse or fraud results in permanent program ban</li>\r\n              <li>Bonuses are calculated monthly and paid automatically</li>\r\n            </ul>\r\n          </section>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\PayoutPolicy.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":119,"column":46,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5102,5349],"text":"\r\n          Payouts are processed on Mondays and Fridays. Once processed, funds usually\r\n          arrive in your PayPal account within 24 hours, though some transactions\r\n          may take longer depending on PayPal&apos;s processing times.\r\n        "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5102,5349],"text":"\r\n          Payouts are processed on Mondays and Fridays. Once processed, funds usually\r\n          arrive in your PayPal account within 24 hours, though some transactions\r\n          may take longer depending on PayPal&lsquo;s processing times.\r\n        "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5102,5349],"text":"\r\n          Payouts are processed on Mondays and Fridays. Once processed, funds usually\r\n          arrive in your PayPal account within 24 hours, though some transactions\r\n          may take longer depending on PayPal&#39;s processing times.\r\n        "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5102,5349],"text":"\r\n          Payouts are processed on Mondays and Fridays. Once processed, funds usually\r\n          arrive in your PayPal account within 24 hours, though some transactions\r\n          may take longer depending on PayPal&rsquo;s processing times.\r\n        "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport LegalLayout from '../../components/LegalLayout'\r\n\r\nexport default function PayoutPolicy() {\r\n  return (\r\n    <LegalLayout>\r\n      <article className=\"prose prose-invert max-w-none prose-headings:text-slate-50 prose-a:text-purple-300 prose-strong:text-slate-100\">\r\n        <p className=\"text-xs uppercase tracking-[0.15em] text-purple-300\">\r\n          Legal\r\n        </p>\r\n        <h1 className=\"mb-2 text-2xl font-bold tracking-tight\">\r\n          Creator & Payout Policy\r\n        </h1>\r\n        <p className=\"text-xs text-slate-400 mb-6\">\r\n          Last updated: January 2025\r\n        </p>\r\n\r\n        <h2>1. Eligibility for Payouts</h2>\r\n        <p>\r\n          To be eligible for payouts, you must meet all of the following requirements:\r\n        </p>\r\n        <ul>\r\n          <li>Hold at least <strong>7,000 troll_coins</strong> in your account</li>\r\n          <li>Complete identity verification (KYC/ID check)</li>\r\n          <li>Submit required tax forms (W-9 for US users, or equivalent for international)</li>\r\n          <li>Have a verified email address on file</li>\r\n          <li>Have no active bans, suspensions, or fraud flags</li>\r\n          <li>Have no pending chargebacks or payment disputes</li>\r\n        </ul>\r\n\r\n        <h2>2. Payout Process</h2>\r\n        <p>\r\n          Payouts are processed 2 times a week, on Mondays and Fridays. You can submit a payout request at any time, \r\n          but it will only be processed during these windows.\r\n        </p>\r\n\r\n        <h2>3. Payout Tiers & Conversion Rates</h2>\r\n        <p>\r\n          Payouts are processed according to the following fixed tiers. You must reach the minimum balance for a tier to be eligible.\r\n        </p>\r\n        <ul className=\"list-none space-y-2 pl-0\">\r\n          <li className=\"flex items-center gap-2\">\r\n            <span className=\"w-32 font-bold text-slate-200\">Starter Tier:</span>\r\n            <span>7,000 coins = <span className=\"text-green-400\">$21.00 USD</span></span>\r\n          </li>\r\n          <li className=\"flex items-center gap-2\">\r\n            <span className=\"w-32 font-bold text-bronze-400 text-amber-600\">Bronze Tier:</span>\r\n            <span>14,000 coins = <span className=\"text-green-400\">$49.50 USD</span></span>\r\n          </li>\r\n          <li className=\"flex items-center gap-2\">\r\n            <span className=\"w-32 font-bold text-slate-400\">Silver Tier:</span>\r\n            <span>27,000 coins = <span className=\"text-green-400\">$90.00 USD</span></span>\r\n          </li>\r\n          <li className=\"flex items-center gap-2\">\r\n            <span className=\"w-32 font-bold text-yellow-400\">Gold Tier:</span>\r\n            <span>47,000 coins = <span className=\"text-green-400\">$150.00 USD</span></span>\r\n          </li>\r\n        </ul>\r\n        <p className=\"mt-4 text-sm text-slate-400\">\r\n          Rates and tiers are subject to change. The system automatically selects the highest tier your balance qualifies for.\r\n        </p>\r\n\r\n        <h2>4. Minimum and Maximum Payouts</h2>\r\n        <p>\r\n          Minimum payout: <strong>7,000 troll_coins ($21.00 USD)</strong><br />\r\n          Maximum payout per week: <strong>$10,000 USD</strong>\r\n        </p>\r\n\r\n        <h2>5. Tax Obligations</h2>\r\n        <p>\r\n          <strong>US Users:</strong> If you receive $600 or more in payouts in a\r\n          calendar year, we are required to collect a W-9 form and may issue a\r\n          1099-NEC or 1099-K form for tax reporting purposes.\r\n        </p>\r\n        <p>\r\n          <strong>International Users:</strong> You are responsible for reporting\r\n          and paying any taxes required by your local jurisdiction. We may request\r\n          tax documentation as required by law.\r\n        </p>\r\n        <p>\r\n          <strong>Important:</strong> Payouts may be delayed or denied if required\r\n          tax forms are not submitted and approved.\r\n        </p>\r\n\r\n        <h2>6. Payout Denials</h2>\r\n        <p>\r\n          Payout requests may be denied for the following reasons:\r\n        </p>\r\n        <ul>\r\n          <li>Insufficient Paid Coin balance</li>\r\n          <li>Incomplete identity verification</li>\r\n          <li>Missing or unapproved tax forms</li>\r\n          <li>Active account restrictions (bans, suspensions)</li>\r\n          <li>Suspected fraud or chargeback history</li>\r\n          <li>Violation of Terms of Service</li>\r\n          <li>PayPal account issues or restrictions</li>\r\n        </ul>\r\n        <p>\r\n          If your payout is denied, you will receive a notification with the reason.\r\n          You may address the issue and resubmit your request.\r\n        </p>\r\n\r\n        <h2>7. Processing Fees</h2>\r\n        <p>\r\n          Standard PayPal transaction fees may apply and will be deducted from the\r\n          payout amount. We do not charge an additional platform fee for payouts.\r\n        </p>\r\n\r\n        <h2>8. Payment Method</h2>\r\n        <p>\r\n          Payouts are sent via PayPal. You must have a verified PayPal account\r\n          matching your Troll City account details.\r\n        </p>\r\n\r\n        <h2>9. Payout Timeline</h2>\r\n        <p>\r\n          Payouts are processed on Mondays and Fridays. Once processed, funds usually\r\n          arrive in your PayPal account within 24 hours, though some transactions\r\n          may take longer depending on PayPal's processing times.\r\n        </p>\r\n\r\n        <h2>10. Disputes and Appeals</h2>\r\n        <p>\r\n          If you disagree with a payout denial or have questions about your payout\r\n          status, contact support through the in-app support system. Include your\r\n          payout request ID and any relevant documentation.\r\n        </p>\r\n      </article>\r\n    </LegalLayout>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\PrivacyPolicy.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":69,"column":24,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3275,3296],"text":"6. Children&apos;s Privacy"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3275,3296],"text":"6. Children&lsquo;s Privacy"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3275,3296],"text":"6. Children&#39;s Privacy"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3275,3296],"text":"6. Children&rsquo;s Privacy"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport LegalLayout from '../../components/LegalLayout'\r\n\r\nexport default function PrivacyPolicy() {\r\n  return (\r\n    <LegalLayout>\r\n      <article className=\"prose prose-invert max-w-none prose-headings:text-slate-50 prose-a:text-purple-300 prose-strong:text-slate-100\">\r\n        <p className=\"text-xs uppercase tracking-[0.15em] text-purple-300\">\r\n          Legal\r\n        </p>\r\n        <h1 className=\"mb-2 text-2xl font-bold tracking-tight\">\r\n          Privacy Policy\r\n        </h1>\r\n        <p className=\"text-xs text-slate-400 mb-6\">\r\n          Last updated: January 2026\r\n        </p>\r\n\r\n        <p>\r\n          Your privacy is important to Troll City. This Privacy Policy explains how we collect, use, and protect your information\r\n          when you use our platform.\r\n        </p>\r\n\r\n        <h2>1. Information We Collect</h2>\r\n        <p>\r\n          We collect information you provide directly to us, such as when you create an account, verify your identity,\r\n          request payouts, or contact support. This includes:\r\n        </p>\r\n        <ul>\r\n          <li><strong>Account Information:</strong> Username, email address, date of birth, and profile content.</li>\r\n          <li><strong>Identity Verification:</strong> Legal name, address, tax ID (last 4 digits), and government ID (if required for payouts).</li>\r\n          <li><strong>Payment Information:</strong> Transaction history and payout details (processed securely).</li>\r\n          <li><strong>User Content:</strong> Streaming content, chat messages, and interactions.</li>\r\n        </ul>\r\n\r\n        <h2>2. How We Use Your Information</h2>\r\n        <p>\r\n          We use your information to operate and improve Troll City, including:\r\n        </p>\r\n        <ul>\r\n          <li>Processing transactions and payouts.</li>\r\n          <li>Verifying your identity and age (compliance).</li>\r\n          <li>Providing customer support and moderation.</li>\r\n          <li>Detecting fraud, abuse, and security incidents.</li>\r\n          <li>Complying with legal obligations (e.g., tax reporting).</li>\r\n        </ul>\r\n\r\n        <h2>3. Information Sharing</h2>\r\n        <p>\r\n          We do not sell your personal data. We share information only in the following circumstances:\r\n        </p>\r\n        <ul>\r\n          <li><strong>Service Providers:</strong> With partners who help us provide services (e.g., payment processors, hosting).</li>\r\n          <li><strong>Legal Requirements:</strong> If required by law, subpoena, or legal process.</li>\r\n          <li><strong>Safety:</strong> To protect the rights, property, or safety of Troll City, our users, or others.</li>\r\n        </ul>\r\n\r\n        <h2>4. Data Security</h2>\r\n        <p>\r\n          We implement industry-standard security measures to protect your data. However, no method of transmission over the internet is 100% secure.\r\n          You are responsible for keeping your account credentials confidential.\r\n        </p>\r\n\r\n        <h2>5. Your Rights</h2>\r\n        <p>\r\n          Depending on your location, you may have rights to access, correct, or delete your personal information.\r\n          You can manage most of your data in your Profile Settings. For other requests, contact support.\r\n        </p>\r\n\r\n        <h2>6. Children's Privacy</h2>\r\n        <p>\r\n          Troll City is not intended for children under 13. We do not knowingly collect data from children under 13.\r\n          If we learn we have collected such data, we will delete it. Users must be at least 18 to monetize or use paid features.\r\n        </p>\r\n\r\n        <h2>7. Changes to This Policy</h2>\r\n        <p>\r\n          We may update this Privacy Policy from time to time. We will notify you of significant changes by posting the new policy here.\r\n        </p>\r\n      </article>\r\n    </LegalLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\RefundPolicy.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\SafetyGuidelines.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":113,"column":62,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5323,5377],"text":"Be cautious when interacting with users you don&apos;t know"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5323,5377],"text":"Be cautious when interacting with users you don&lsquo;t know"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5323,5377],"text":"Be cautious when interacting with users you don&#39;t know"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5323,5377],"text":"Be cautious when interacting with users you don&rsquo;t know"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport LegalLayout from '../../components/LegalLayout'\r\n\r\nexport default function SafetyGuidelines() {\r\n  return (\r\n    <LegalLayout>\r\n      <article className=\"prose prose-invert max-w-none prose-headings:text-slate-50 prose-a:text-purple-300 prose-strong:text-slate-100\">\r\n        <p className=\"text-xs uppercase tracking-[0.15em] text-purple-300\">\r\n          Community\r\n        </p>\r\n        <h1 className=\"mb-2 text-2xl font-bold tracking-tight\">\r\n          Safety & Community Guidelines\r\n        </h1>\r\n        <p className=\"text-xs text-slate-400 mb-6\">\r\n          Last updated: January 2025\r\n        </p>\r\n\r\n        <h2>Our Commitment to Safety</h2>\r\n        <p>\r\n          Troll City is committed to providing a safe, respectful, and enjoyable\r\n          environment for all users. These guidelines outline expected behavior and\r\n          the consequences of violations.\r\n        </p>\r\n\r\n        <h2>1. Prohibited Content and Behavior</h2>\r\n        <p>\r\n          The following are strictly prohibited and will result in immediate action:\r\n        </p>\r\n        <ul>\r\n          <li><strong>Harassment and Bullying:</strong> Targeting individuals with\r\n            repeated negative comments, threats, or intimidation</li>\r\n          <li><strong>Hate Speech:</strong> Content promoting hatred, discrimination,\r\n            or violence based on race, religion, gender, sexual orientation, or other\r\n            protected characteristics</li>\r\n          <li><strong>Explicit Content:</strong> Sexual content, nudity, or graphic\r\n            material not appropriate for our platform</li>\r\n          <li><strong>Self-Harm or Suicide:</strong> Content promoting, glorifying, or\r\n            providing instructions for self-harm or suicide</li>\r\n          <li><strong>Minors:</strong> Any content involving or targeting minors in\r\n            inappropriate ways</li>\r\n          <li><strong>Scams and Fraud:</strong> Attempting to defraud users, sell\r\n            fake coins, or engage in financial scams</li>\r\n          <li><strong>Impersonation:</strong> Pretending to be another user, admin,\r\n            or public figure</li>\r\n          <li><strong>Spam:</strong> Repetitive messages, unsolicited promotions,\r\n            or automated bot activity</li>\r\n        </ul>\r\n\r\n        <h2>2. Moderation System</h2>\r\n        <p>\r\n          Troll City uses a multi-layered moderation approach:\r\n        </p>\r\n        <ul>\r\n          <li><strong>Automated Systems:</strong> AI-powered content filtering and\r\n            detection</li>\r\n          <li><strong>Troll Officers:</strong> Trained human moderators who review\r\n            reports and take action</li>\r\n          <li><strong>Admin Review:</strong> Complex cases escalated to administrators</li>\r\n          <li><strong>Observer Bot:</strong> AI system that grades moderation actions\r\n            for quality and consistency</li>\r\n        </ul>\r\n\r\n        <h2>3. Reporting Violations</h2>\r\n        <p>\r\n          If you encounter content or behavior that violates these guidelines:\r\n        </p>\r\n        <ol>\r\n          <li>Use the in-app reporting system to submit a report</li>\r\n          <li>Provide as much context as possible (screenshots, timestamps, etc.)</li>\r\n          <li>Reports are reviewed by Troll Officers or Admins</li>\r\n          <li>You will receive a notification when action is taken</li>\r\n        </ol>\r\n        <p>\r\n          <strong>Emergency Situations:</strong> Troll City is not an emergency service.\r\n          If you or someone else is in immediate danger, contact local emergency\r\n          services (911 in the US) immediately.\r\n        </p>\r\n\r\n        <h2>4. Enforcement Actions</h2>\r\n        <p>\r\n          Violations may result in one or more of the following actions:\r\n        </p>\r\n        <ul>\r\n          <li><strong>Warning:</strong> First-time minor violations</li>\r\n          <li><strong>Mute:</strong> Temporary restriction from chat or messaging</li>\r\n          <li><strong>Shadow Ban:</strong> Your messages are hidden from others\r\n            without your knowledge</li>\r\n          <li><strong>Temporary Ban:</strong> Account suspension for a specified\r\n            duration (hours, days, or weeks)</li>\r\n          <li><strong>Permanent Ban:</strong> Permanent account termination</li>\r\n          <li><strong>Coin Deduction:</strong> Violations may result in deduction\r\n            of coins as a penalty</li>\r\n        </ul>\r\n\r\n        <h2>5. Appeal Process</h2>\r\n        <p>\r\n          If you believe you were banned or restricted in error:\r\n        </p>\r\n        <ol>\r\n          <li>Contact support through the in-app support system</li>\r\n          <li>Provide your account information and the reason for your appeal</li>\r\n          <li>Include any relevant evidence or context</li>\r\n          <li>Appeals are reviewed by administrators</li>\r\n          <li>You will receive a response within 5-7 business days</li>\r\n        </ol>\r\n\r\n        <h2>6. Privacy and Personal Information</h2>\r\n        <ul>\r\n          <li>Do not share personal information (address, phone number, email,\r\n            financial details) publicly</li>\r\n          <li>Do not request personal information from other users</li>\r\n          <li>Report any attempts to collect or misuse personal information</li>\r\n          <li>Be cautious when interacting with users you don't know</li>\r\n        </ul>\r\n\r\n        <h2>7. Account Security</h2>\r\n        <ul>\r\n          <li>Use a strong, unique password</li>\r\n          <li>Never share your account credentials</li>\r\n          <li>Enable two-factor authentication if available</li>\r\n          <li>Report suspicious activity immediately</li>\r\n          <li>Log out from shared or public devices</li>\r\n        </ul>\r\n\r\n        <h2>8. Troll Officers</h2>\r\n        <p>\r\n          Troll Officers are community moderators who help maintain platform safety.\r\n          They have the authority to:\r\n        </p>\r\n        <ul>\r\n          <li>Warn users for violations</li>\r\n          <li>Mute or temporarily ban users</li>\r\n          <li>Submit reports for admin review</li>\r\n          <li>Escalate serious violations</li>\r\n        </ul>\r\n        <p>\r\n          Officers are trained and monitored. If you believe an officer acted\r\n          inappropriately, report it to administrators.\r\n        </p>\r\n\r\n        <h2>9. Age Requirements</h2>\r\n        <p>\r\n          Troll City is intended for users 16 years and older. Users under 18 must\r\n          have parental consent. We do not knowingly collect information from users\r\n          under 16. If we discover a user is underage, their account will be\r\n          immediately terminated.\r\n        </p>\r\n\r\n        <h2>10. Updates to Guidelines</h2>\r\n        <p>\r\n          These guidelines may be updated periodically to reflect changes in our\r\n          platform, community standards, or legal requirements. Continued use of\r\n          Troll City after updates constitutes acceptance of the revised guidelines.\r\n        </p>\r\n\r\n        <h2>11. Contact</h2>\r\n        <p>\r\n          For safety concerns, reporting violations, or questions about these guidelines,\r\n          contact our support team through the in-app support system.\r\n        </p>\r\n      </article>\r\n    </LegalLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\legal\\TermsOfService.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":19,"column":35,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (&quot;Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (&ldquo;Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (&#34;Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (&rdquo;Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":19,"column":41,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms&quot;) govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms&ldquo;) govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms&#34;) govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms&rdquo;) govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":20,"column":72,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (&quot;Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (&ldquo;Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (&#34;Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (&rdquo;Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":20,"column":83,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City&quot;,\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City&ldquo;,\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City&#34;,\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City&rdquo;,\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":21,"column":11,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          &quot;we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          &ldquo;we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          &#34;we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          &rdquo;we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":21,"column":14,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we&quot;, \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we&ldquo;, \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we&#34;, \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we&rdquo;, \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":21,"column":17,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", &quot;us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", &ldquo;us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", &#34;us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", &rdquo;us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":21,"column":20,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us&quot;, or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us&ldquo;, or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us&#34;, or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us&rdquo;, or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":21,"column":26,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or &quot;our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or &ldquo;our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or &#34;our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or &rdquo;our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":21,"column":30,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our&quot;). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our&ldquo;). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our&#34;). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[645,955],"text":"\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our&rdquo;). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":37,"column":21,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (&quot;Coins\") and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (&ldquo;Coins\") and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (&#34;Coins\") and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (&rdquo;Coins\") and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":37,"column":27,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (\"Coins&quot;) and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (\"Coins&ldquo;) and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (\"Coins&#34;) and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1503,1858],"text":"\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (\"Coins&rdquo;) and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":88,"column":85,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4049,4340],"text":"\r\n          Troll City and its logos, artwork, virtual items, and software are protected\r\n          by intellectual property laws. You must not use our marks or assets without\r\n          prior written permission and must not upload content that infringes others&apos;\r\n          rights.\r\n        "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4049,4340],"text":"\r\n          Troll City and its logos, artwork, virtual items, and software are protected\r\n          by intellectual property laws. You must not use our marks or assets without\r\n          prior written permission and must not upload content that infringes others&lsquo;\r\n          rights.\r\n        "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4049,4340],"text":"\r\n          Troll City and its logos, artwork, virtual items, and software are protected\r\n          by intellectual property laws. You must not use our marks or assets without\r\n          prior written permission and must not upload content that infringes others&#39;\r\n          rights.\r\n        "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4049,4340],"text":"\r\n          Troll City and its logos, artwork, virtual items, and software are protected\r\n          by intellectual property laws. You must not use our marks or assets without\r\n          prior written permission and must not upload content that infringes others&rsquo;\r\n          rights.\r\n        "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":94,"column":34,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided &quot;as is\" and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided &ldquo;as is\" and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided &#34;as is\" and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided &rdquo;as is\" and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":94,"column":40,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is&quot; and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is&ldquo; and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is&#34; and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is&rdquo; and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":94,"column":46,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and &quot;as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and &ldquo;as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and &#34;as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and &rdquo;as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":94,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and \"as available&quot; without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and \"as available&ldquo; without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and \"as available&#34; without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4420,4778],"text":"\r\n          Troll City is provided \"as is\" and \"as available&rdquo; without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport LegalLayout from '../../components/LegalLayout'\r\n\r\nexport default function TermsOfService() {\r\n  return (\r\n    <LegalLayout>\r\n      <article className=\"prose prose-invert max-w-none prose-headings:text-slate-50 prose-a:text-purple-300 prose-strong:text-slate-100\">\r\n        <p className=\"text-xs uppercase tracking-[0.15em] text-purple-300\">\r\n          Legal\r\n        </p>\r\n        <h1 className=\"mb-2 text-2xl font-bold tracking-tight\">\r\n          Troll City Terms of Service\r\n        </h1>\r\n        <p className=\"text-xs text-slate-400 mb-6\">\r\n          Last updated: January 2025\r\n        </p>\r\n\r\n        <p>\r\n          These Terms of Service (\"Terms\") govern your access to and use of the Troll\r\n          City platform, websites, applications, and related services (\"Troll City\",\r\n          \"we\", \"us\", or \"our\"). By creating an account or using Troll City, you agree\r\n          to be bound by these Terms.\r\n        </p>\r\n\r\n        <h2>1. Eligibility and Accounts</h2>\r\n        <p>\r\n          You must be at least 16 years old, or the minimum age of digital consent in\r\n          your jurisdiction, to use Troll City. If you are under 18, you may only use\r\n          Troll City with the consent of a parent or legal guardian. You agree to keep\r\n          your registration information accurate and secure and understand that you are\r\n          responsible for all activity under your account.\r\n        </p>\r\n\r\n        <h2>2. Nature of the Service</h2>\r\n        <p>\r\n          Troll City is an interactive entertainment platform that uses virtual\r\n          currency (\"Coins\") and digital gifts. It is not a gambling platform and does\r\n          not guarantee any financial returns. Certain users may be eligible to request\r\n          payouts based on Paid Coin balances, subject to these Terms and our review.\r\n        </p>\r\n\r\n        <h2>3. Virtual Currency and Digital Items</h2>\r\n        <p>\r\n          Troll City may offer Free Coins, troll_coins, and promotional Coins. Coins and\r\n          digital gifts are licenses to use features inside Troll City and have no\r\n          inherent real-world value, except where we explicitly allow payouts of Paid\r\n          Coins through our official payout process. We may update exchange structures,\r\n          conversion eligibility, and coin mechanics at any time.\r\n        </p>\r\n\r\n        <h2>4. Purchases and Refunds</h2>\r\n        <p>\r\n          Purchases of Coins and digital items are generally final and non-refundable,\r\n          except where required by law. Chargebacks or fraudulent activity may result\r\n          in suspension or termination of your account and reversal of associated\r\n          transactions.\r\n        </p>\r\n\r\n        <h2>5. Payouts and Taxes</h2>\r\n        <p>\r\n          Only eligible users may request a payout. At minimum, you must hold at least{' '}\r\n          <strong>12,000 troll_coins</strong>, complete our identity verification, and\r\n          comply with all rules. Payouts are not guaranteed, may be processed manually,\r\n          and are subject to review. You are solely responsible for any taxes related\r\n          to income or benefits you receive from Troll City.\r\n        </p>\r\n\r\n        <h2>6. User Conduct and Content</h2>\r\n        <p>\r\n          You may not use Troll City to harass, threaten, exploit, or harm others, to\r\n          promote hate or illegal activity, or to share infringing or explicit content.\r\n          We may remove content or restrict accounts that violate our policies or\r\n          applicable law.\r\n        </p>\r\n\r\n        <h2>7. Safety, Moderation, and Reporting</h2>\r\n        <p>\r\n          Troll City uses a combination of automated tools and human moderators,\r\n          including Troll Officers, to help keep the platform safe. We may review,\r\n          restrict, or remove content and accounts at our discretion. Troll City is not\r\n          an emergency service; in emergencies, contact local authorities directly.\r\n        </p>\r\n\r\n        <h2>8. Intellectual Property</h2>\r\n        <p>\r\n          Troll City and its logos, artwork, virtual items, and software are protected\r\n          by intellectual property laws. You must not use our marks or assets without\r\n          prior written permission and must not upload content that infringes others'\r\n          rights.\r\n        </p>\r\n\r\n        <h2>9. Disclaimers and Limitation of Liability</h2>\r\n        <p>\r\n          Troll City is provided \"as is\" and \"as available\" without warranties of any\r\n          kind. To the maximum extent permitted by law, we are not liable for indirect\r\n          or consequential damages or for any amount greater than the fees you paid to\r\n          us in the six months before the claim, or USD $100, whichever is greater.\r\n        </p>\r\n\r\n        <h2>10. Termination and Changes</h2>\r\n        <p>\r\n          You may stop using Troll City at any time. We may suspend or terminate your\r\n          access at any time, with or without notice, including for suspected\r\n          violations of these Terms. We may update these Terms periodically; continuing\r\n          to use Troll City after changes take effect constitutes acceptance of the\r\n          revised Terms.\r\n        </p>\r\n\r\n        <h2>11. Contact</h2>\r\n        <p>\r\n          For questions about these Terms or Troll City, contact our support team at\r\n          the email or address listed in the app or on our website.\r\n        </p>\r\n      </article>\r\n    </LegalLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\officer\\OfficerDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\officer\\OfficerPayrollDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\perks\\PerksStore.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'perks' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":19,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setPerks' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":19,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":20,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":20,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'purchasing' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":21,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setPurchasing' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":21,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react'\r\nimport { useAuthStore } from '@/lib/store'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { toast } from 'sonner'\r\nimport { Zap, Lock, Clock } from 'lucide-react'\r\n\r\ninterface Perk {\r\n  id: string\r\n  name: string\r\n  description: string\r\n  category: string\r\n  cost_tokens: number\r\n  required_level: number\r\n  metadata: any\r\n}\r\n\r\nexport default function PerksStore() {\r\n  const { profile, user } = useAuthStore()\r\n  const [perks, setPerks] = useState<Perk[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [purchasing, setPurchasing] = useState<string | null>(null)\r\n\r\n  if (!profile) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] flex items-center justify-center\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return <PerksStoreContent profile={profile} user={user} />\r\n}\r\n\r\nfunction PerksStoreContent({ profile, user }: { profile: any, user: any }) {\r\n  const [perks, setPerks] = useState<Perk[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [purchasing, setPurchasing] = useState<string | null>(null)\r\n\r\n  useEffect(() => {\r\n    loadPerks()\r\n  }, [])\r\n\r\n\r\n  const loadPerks = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('perks')\r\n        .select('*')\r\n        .order('cost_tokens', { ascending: true })\r\n      \r\n      if (error) throw error\r\n      setPerks(data || [])\r\n    } catch (error) {\r\n      console.error('Error loading perks:', error)\r\n      toast.error('Failed to load perks')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handlePrestige = async () => {\r\n    if (!profile) return;\r\n    if (!window.confirm('Are you sure you want to PRESTIGE? This will reset your level to 1, but give you permanent boosts and a prestige badge. This cannot be undone.')) {\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      setLoading(true);\r\n      const { data, error } = await supabase.rpc('prestige_user', {\r\n        p_user_id: user?.id\r\n      });\r\n      \r\n      if (error) throw error;\r\n      \r\n      if (data && data.success) {\r\n        toast.success(data.message);\r\n        window.location.reload();\r\n      } else {\r\n        toast.error(data?.message || 'Prestige failed');\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Prestige error:', error);\r\n      toast.error(error.message);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handlePurchase = async (perk: Perk) => {\r\n    if (!profile) return\r\n\r\n    if (profile.level < perk.required_level) {\r\n      toast.error(`Requires Level ${perk.required_level}`)\r\n      return\r\n    }\r\n\r\n    if ((profile.perk_tokens || 0) < perk.cost_tokens) {\r\n      toast.error('Not enough tokens')\r\n      return\r\n    }\r\n\r\n    setPurchasing(perk.id)\r\n    try {\r\n      const { data, error } = await supabase.rpc('purchase_perk', {\r\n        p_perk_id: perk.id\r\n      })\r\n\r\n      if (error) throw error\r\n\r\n      if (data && data.success) {\r\n        toast.success(data.message)\r\n        // Refresh profile to update tokens (handled by store subscription or manual re-fetch?)\r\n        // Ideally useAuthStore would refresh, but let's manually trigger a profile update if possible, \r\n        // or just rely on the UI update if we had a method. \r\n        // For now, we might need to reload the page or fetch profile again.\r\n        // Assuming real-time or optimistic update isn't setup for RPC side-effects on profile.\r\n        window.location.reload() // Simple way to refresh tokens in Sidebar\r\n      } else {\r\n        toast.error(data?.error || 'Purchase failed')\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Purchase error:', error)\r\n      toast.error(error.message || 'Failed to purchase perk')\r\n    } finally {\r\n      setPurchasing(null)\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-[#0A0814] flex items-center justify-center\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#0A0814] text-white p-6 md:p-8 ml-20 md:ml-64\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <header className=\"mb-8\">\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <Zap className=\"w-8 h-8 text-yellow-400\" />\r\n            <h1 className=\"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500\">\r\n              Perk Store\r\n            </h1>\r\n          </div>\r\n          <p className=\"text-gray-400\">Redeem your Perk Tokens for exclusive rewards and boosts.</p>\r\n        </header>\r\n\r\n        <div className=\"bg-white/5 border border-white/10 rounded-xl p-6 mb-8 flex items-center justify-between\">\r\n          <div>\r\n            <p className=\"text-sm text-gray-400\">Your Balance</p>\r\n            <div className=\"text-3xl font-bold text-yellow-400 flex items-center gap-2\">\r\n              {profile?.perk_tokens || 0} <span className=\"text-lg text-gray-400\">Tokens</span>\r\n            </div>\r\n          </div>\r\n          <div className=\"text-right\">\r\n            <p className=\"text-sm text-gray-400\">Current Level</p>\r\n            <div className=\"text-2xl font-bold text-purple-400 flex items-center gap-2 justify-end\">\r\n               {profile?.prestige_level && profile.prestige_level > 0 && (\r\n                 <span className=\"text-yellow-500 text-lg flex items-center gap-1\" title={`Prestige ${profile.prestige_level}`}>\r\n                   <Zap className=\"w-4 h-4\" fill=\"currentColor\" /> {profile.prestige_level}\r\n                 </span>\r\n               )}\r\n               Level {profile?.level || 1}\r\n            </div>\r\n            {(profile?.level || 1) >= 50 && (\r\n              <button \r\n                onClick={handlePrestige}\r\n                className=\"mt-2 text-xs bg-gradient-to-r from-red-600 to-yellow-600 px-3 py-1 rounded font-bold hover:brightness-110 transition-all animate-pulse\"\r\n              >\r\n                PRESTIGE NOW\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          {perks.map((perk) => {\r\n            const isLocked = (profile?.level || 0) < perk.required_level\r\n            const canAfford = (profile?.perk_tokens || 0) >= perk.cost_tokens\r\n            \r\n            return (\r\n              <div \r\n                key={perk.id} \r\n                className={`relative bg-[#1A1A1A] border border-white/10 rounded-xl p-6 transition-all hover:border-purple-500/50 ${isLocked ? 'opacity-75' : ''}`}\r\n              >\r\n                {isLocked && (\r\n                  <div className=\"absolute inset-0 bg-black/60 rounded-xl flex items-center justify-center z-10 backdrop-blur-[1px]\">\r\n                    <div className=\"bg-black/80 px-4 py-2 rounded-lg flex items-center gap-2 border border-white/10\">\r\n                      <Lock className=\"w-4 h-4 text-red-400\" />\r\n                      <span className=\"text-red-400 font-bold\">Unlocks at Level {perk.required_level}</span>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                <div className=\"flex justify-between items-start mb-4\">\r\n                  <div className={`p-3 rounded-lg ${getCategoryColor(perk.category)} bg-opacity-20`}>\r\n                    <Zap className={`w-6 h-6 ${getCategoryColor(perk.category).replace('bg-', 'text-')}`} />\r\n                  </div>\r\n                  <div className=\"px-3 py-1 bg-white/5 rounded-full text-sm font-medium border border-white/10\">\r\n                    {perk.cost_tokens} Tokens\r\n                  </div>\r\n                </div>\r\n\r\n                <h3 className=\"text-xl font-bold mb-2\">{perk.name}</h3>\r\n                <p className=\"text-gray-400 text-sm mb-4 min-h-[40px]\">{perk.description}</p>\r\n\r\n                <div className=\"flex items-center gap-2 mb-6 text-xs text-gray-500\">\r\n                  <span className=\"uppercase tracking-wider\">{perk.category}</span>\r\n                  {perk.metadata?.duration_hours && (\r\n                    <span className=\"flex items-center gap-1\">\r\n                      ‚Ä¢ <Clock className=\"w-3 h-3\" /> {perk.metadata.duration_hours}h Duration\r\n                    </span>\r\n                  )}\r\n                </div>\r\n\r\n                <button\r\n                  onClick={() => handlePurchase(perk)}\r\n                  disabled={isLocked || !canAfford || purchasing === perk.id}\r\n                  className={`w-full py-2.5 rounded-lg font-bold transition-all flex items-center justify-center gap-2\r\n                    ${isLocked \r\n                      ? 'bg-gray-800 text-gray-500 cursor-not-allowed'\r\n                      : canAfford \r\n                        ? 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white shadow-lg shadow-purple-900/20'\r\n                        : 'bg-gray-700 text-gray-400 cursor-not-allowed'\r\n                    }\r\n                  `}\r\n                >\r\n                  {purchasing === perk.id ? (\r\n                    <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white\"></div>\r\n                  ) : isLocked ? (\r\n                    'Locked'\r\n                  ) : !canAfford ? (\r\n                    'Not Enough Tokens'\r\n                  ) : (\r\n                    'Redeem'\r\n                  )}\r\n                </button>\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction getCategoryColor(category: string) {\r\n  switch (category) {\r\n    case 'streaming': return 'bg-blue-500'\r\n    case 'chat': return 'bg-green-500'\r\n    case 'coins': return 'bg-yellow-500'\r\n    case 'profile': return 'bg-purple-500'\r\n    default: return 'bg-gray-500'\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\pods\\PodChatBox.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[36,49],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[87,95],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":33,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Send, Trash2, Shield, UserX } from \"lucide-react\";\nimport { supabase } from \"../../lib/supabase\";\nimport { toast } from \"sonner\";\n\ninterface PodChatBoxProps {\n  roomId: string;\n  isHost: boolean;\n  currentUserId: string;\n}\n\ninterface Message {\n  id: string;\n  user_id: string;\n  content: string;\n  created_at: string;\n  user?: {\n    username: string;\n    avatar_url: string;\n  };\n}\n\nexport default function PodChatBox({ roomId, isHost, currentUserId }: PodChatBoxProps) {\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [inputValue, setInputValue] = useState(\"\");\n  const chatEndRef = useRef<HTMLDivElement>(null);\n  const [loading, setLoading] = useState(true);\n\n  // Fetch initial messages\n  useEffect(() => {\n    const fetchMessages = async () => {\n      // Step 1: Fetch messages\n      const { data: msgs, error } = await supabase\n        .from('pod_chat_messages')\n        .select('*')\n        .eq('room_id', roomId)\n        .order('created_at', { ascending: false })\n        .limit(50);\n\n      if (msgs) {\n        // Step 2: Fetch user profiles for these messages\n        const userIds = [...new Set(msgs.map(m => m.user_id))];\n        const { data: profiles } = await supabase\n          .from('user_profiles')\n          .select('id, username, avatar_url')\n          .in('id', userIds);\n\n        const msgsWithUsers = msgs.map(m => ({\n          ...m,\n          user: profiles?.find(p => p.id === m.user_id)\n        }));\n\n        setMessages(msgsWithUsers.reverse());\n      }\n      setLoading(false);\n    };\n\n    fetchMessages();\n\n    // Subscribe to new messages\n    const channel = supabase\n      .channel(`pod_chat:${roomId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'pod_chat_messages',\n          filter: `room_id=eq.${roomId}`\n        },\n        async (payload) => {\n          const newMsg = payload.new as Message;\n          // Fetch user details for the new message\n          const { data: userData } = await supabase\n            .from('user_profiles')\n            .select('username, avatar_url')\n            .eq('id', newMsg.user_id)\n            .single();\n\n          setMessages(prev => [...prev, { ...newMsg, user: userData }]);\n          scrollToBottom();\n        }\n      )\n      .on(\n        'postgres_changes',\n        {\n            event: 'DELETE',\n            schema: 'public',\n            table: 'pod_chat_messages',\n            filter: `room_id=eq.${roomId}`\n        },\n        (payload) => {\n            setMessages(prev => prev.filter(m => m.id !== payload.old.id));\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [roomId]);\n\n  const scrollToBottom = () => {\n    setTimeout(() => {\n      chatEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }, 100);\n  };\n\n  const handleSendMessage = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n    if (!inputValue.trim()) return;\n\n    const content = inputValue.trim();\n    setInputValue(\"\");\n\n    const { error } = await supabase\n      .from('pod_chat_messages')\n      .insert({\n        room_id: roomId,\n        user_id: currentUserId,\n        content\n      });\n\n    if (error) {\n      toast.error(\"Failed to send message\");\n      setInputValue(content); // Restore on error\n    }\n  };\n\n  const handleDeleteMessage = async (messageId: string) => {\n    if (!isHost) return;\n    const { error } = await supabase\n      .from('pod_chat_messages')\n      .delete()\n      .eq('id', messageId);\n    \n    if (error) toast.error(\"Failed to delete message\");\n  };\n\n  const handleKickUser = async (userId: string, username: string) => {\n    if (!isHost || userId === currentUserId) return;\n    if (!confirm(`Are you sure you want to kick ${username}?`)) return;\n\n    // Remove from participants\n    await supabase\n      .from('pod_room_participants')\n      .delete()\n      .eq('room_id', roomId)\n      .eq('user_id', userId);\n      \n    // Add to bans to prevent rejoin\n    await supabase\n      .from('pod_bans')\n      .insert({\n        room_id: roomId,\n        user_id: userId\n      });\n\n    toast.success(`${username} kicked and banned`);\n  };\n\n  return (\n    <div className=\"flex flex-col h-full bg-black/40 rounded-xl border border-white/10 overflow-hidden\">\n      <div className=\"p-3 border-b border-white/10 bg-white/5 flex justify-between items-center\">\n        <span className=\"text-xs font-bold uppercase tracking-wider text-white/70\">Pod Chat</span>\n      </div>\n\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-white/10\">\n        {loading && <div className=\"text-center text-white/40 text-xs\">Loading chat...</div>}\n        \n        {messages.map((msg) => (\n          <div key={msg.id} className=\"group flex gap-3 items-start\">\n            <div className=\"w-8 h-8 rounded-full bg-white/10 flex-shrink-0 overflow-hidden\">\n               <img \n                 src={msg.user?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.user?.username}`} \n                 alt={msg.user?.username}\n                 className=\"w-full h-full object-cover\"\n               />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm font-bold text-purple-300 truncate\">\n                  {msg.user?.username || 'Unknown'}\n                </span>\n                <span className=\"text-[10px] text-white/30\">\n                  {new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                </span>\n                {isHost && (\n                    <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                        <button \n                            onClick={() => handleDeleteMessage(msg.id)}\n                            className=\"p-1 text-red-400 hover:text-red-300 rounded\"\n                            title=\"Delete Message\"\n                        >\n                            <Trash2 size={12} />\n                        </button>\n                        {msg.user_id !== currentUserId && (\n                             <button \n                                onClick={() => handleKickUser(msg.user_id, msg.user?.username || '')}\n                                className=\"p-1 text-red-400 hover:text-red-300 rounded\"\n                                title=\"Kick & Ban User\"\n                            >\n                                <UserX size={12} />\n                            </button>\n                        )}\n                    </div>\n                )}\n              </div>\n              <p className=\"text-sm text-white/90 break-words\">{msg.content}</p>\n            </div>\n          </div>\n        ))}\n        <div ref={chatEndRef} />\n      </div>\n\n      <form onSubmit={handleSendMessage} className=\"p-3 border-t border-white/10 bg-white/5\">\n        <div className=\"relative\">\n          <input\n            type=\"text\"\n            value={inputValue}\n            onChange={(e) => setInputValue(e.target.value)}\n            placeholder=\"Say something...\"\n            className=\"w-full bg-black/50 border border-white/10 rounded-full px-4 py-2 pr-10 text-sm text-white focus:outline-none focus:border-purple-500/50\"\n          />\n          <button \n            type=\"submit\"\n            disabled={!inputValue.trim()}\n            className=\"absolute right-1 top-1 p-1.5 bg-purple-600 rounded-full text-white disabled:opacity-50 hover:bg-purple-500 transition-colors\"\n          >\n            <Send size={14} />\n          </button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\pods\\PodParticipantBox.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RemoteParticipant' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":65,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RemoteParticipant"},"fix":{"range":[97,116],"text":""},"desc":"Remove unused variable \"RemoteParticipant\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MoreVertical' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MoreVertical"},"fix":{"range":[186,200],"text":""},"desc":"Remove unused variable \"MoreVertical\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Ban' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Ban"},"fix":{"range":[200,205],"text":""},"desc":"Remove unused variable \"Ban\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showControls' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":26,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowControls' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":26,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pub' is defined but never used. Allowed unused args must match /^_/u.","line":56,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pub' is defined but never used. Allowed unused args must match /^_/u.","line":61,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\nimport { Participant, Track, LocalParticipant, RemoteParticipant, TrackPublication } from 'livekit-client';\nimport { Mic, MicOff, User, MoreVertical, Ban, UserMinus, ArrowDown } from 'lucide-react';\nimport { supabase } from '../../lib/supabase';\n\ninterface PodParticipantBoxProps {\n  participant: Participant;\n  isHost: boolean; // Is the viewer the host of the room?\n  isSelf: boolean; // Is this box for the viewer themselves?\n  onKick?: (identity: string) => void;\n  onMute?: (identity: string) => void;\n  onDemote?: (identity: string) => void;\n}\n\nexport default function PodParticipantBox({\n  participant,\n  isHost,\n  isSelf,\n  onKick,\n  onMute,\n  onDemote\n}: PodParticipantBoxProps) {\n  const [videoTrack, setVideoTrack] = useState<MediaStreamTrack | null>(null);\n  const [audioTrack, setAudioTrack] = useState<MediaStreamTrack | null>(null);\n  const [isMuted, setIsMuted] = useState(false);\n  const [showControls, setShowControls] = useState(false);\n  \n  const isLocal = participant instanceof LocalParticipant;\n\n  // Identity is usually the user_id\n  const userId = participant.identity;\n  const [userProfile, setUserProfile] = useState<{ username: string; avatar_url: string } | null>(null);\n\n  useEffect(() => {\n    // Fetch profile\n    const fetchProfile = async () => {\n      const { data } = await supabase\n        .from('user_profiles')\n        .select('username, avatar_url')\n        .eq('id', userId)\n        .single();\n      if (data) setUserProfile(data);\n    };\n    fetchProfile();\n  }, [userId]);\n\n  useEffect(() => {\n    const getTrack = (source: Track.Source) => {\n        const pub = participant.getTrackPublication(source);\n        return pub?.track?.mediaStreamTrack || null;\n    };\n\n    setVideoTrack(getTrack(Track.Source.Camera));\n    setAudioTrack(getTrack(Track.Source.Microphone));\n\n    const handleTrackSubscribed = (track: Track, pub: TrackPublication) => {\n      if (track.kind === Track.Kind.Video) setVideoTrack(track.mediaStreamTrack);\n      if (track.kind === Track.Kind.Audio) setAudioTrack(track.mediaStreamTrack);\n    };\n\n    const handleTrackUnsubscribed = (track: Track, pub: TrackPublication) => {\n      if (track.kind === Track.Kind.Video) setVideoTrack(null);\n      if (track.kind === Track.Kind.Audio) setAudioTrack(null);\n    };\n    \n    const handleMute = (pub: TrackPublication) => {\n        if (pub.kind === Track.Kind.Microphone) setIsMuted(true);\n    }\n    const handleUnmute = (pub: TrackPublication) => {\n        if (pub.kind === Track.Kind.Microphone) setIsMuted(false);\n    }\n\n    participant.on('trackSubscribed', handleTrackSubscribed);\n    participant.on('trackUnsubscribed', handleTrackUnsubscribed);\n    participant.on('trackMuted', handleMute);\n    participant.on('trackUnmuted', handleUnmute);\n\n    // Initial state\n    setIsMuted(participant.isMicrophoneEnabled === false);\n\n    return () => {\n      participant.off('trackSubscribed', handleTrackSubscribed);\n      participant.off('trackUnsubscribed', handleTrackUnsubscribed);\n      participant.off('trackMuted', handleMute);\n      participant.off('trackUnmuted', handleUnmute);\n    };\n  }, [participant]);\n\n  // Attach video to element\n  const videoRef = React.useRef<HTMLVideoElement>(null);\n  useEffect(() => {\n    if (videoRef.current && videoTrack) {\n      videoRef.current.srcObject = new MediaStream([videoTrack]);\n      videoRef.current.play().catch(e => console.error(\"Video play error\", e));\n    }\n  }, [videoTrack]);\n\n  // Attach audio (if not local)\n  const audioRef = React.useRef<HTMLAudioElement>(null);\n  useEffect(() => {\n    if (isLocal) return; // Don't play own audio\n    if (audioRef.current && audioTrack) {\n      audioRef.current.srcObject = new MediaStream([audioTrack]);\n      audioRef.current.play().catch(e => console.error(\"Audio play error\", e));\n    }\n  }, [audioTrack, isLocal]);\n\n  // RGB Border Style - using global CSS .rgb-frame\n  \n  return (\n    <div className=\"relative group w-full aspect-video rgb-frame rounded-xl\">\n      <div className=\"w-full h-full bg-black relative overflow-hidden rounded-lg\">\n      \n      {/* Video or Avatar */}\n      {videoTrack ? (\n        <video \n          ref={videoRef} \n          className=\"w-full h-full object-cover\" \n          muted={true} // Always mute video element, audio handled separately\n        />\n      ) : (\n        <div className=\"w-full h-full flex items-center justify-center bg-gray-900\">\n          {userProfile?.avatar_url ? (\n            <img src={userProfile.avatar_url} alt={userProfile.username} className=\"w-24 h-24 rounded-full border-2 border-white/20\" />\n          ) : (\n            <User className=\"w-20 h-20 text-gray-500\" />\n          )}\n        </div>\n      )}\n\n      {/* Audio Element */}\n      {!isLocal && <audio ref={audioRef} />}\n\n      {/* Overlay Info */}\n      <div className=\"absolute bottom-2 left-2 z-20 flex items-center gap-2 bg-black/60 px-2 py-1 rounded-full backdrop-blur-sm\">\n        <span className=\"text-white text-sm font-bold truncate max-w-[100px]\">\n          {userProfile?.username || participant.identity}\n        </span>\n        {isMuted ? <MicOff className=\"w-4 h-4 text-red-500\" /> : <Mic className=\"w-4 h-4 text-green-500\" />}\n      </div>\n\n      {/* Host Controls */}\n      {isHost && !isSelf && (\n        <div className=\"absolute top-2 right-2 z-30 opacity-0 group-hover:opacity-100 transition-opacity\">\n          <div className=\"flex flex-col gap-2\">\n            <button \n              onClick={() => onDemote?.(participant.identity)}\n              className=\"p-2 bg-yellow-600/80 hover:bg-yellow-700 rounded-full text-white\"\n              title=\"Remove from Stage\"\n            >\n              <ArrowDown className=\"w-4 h-4\" />\n            </button>\n            <button \n              onClick={() => onMute?.(participant.identity)}\n              className=\"p-2 bg-red-500/80 hover:bg-red-600 rounded-full text-white\"\n              title=\"Mute User\"\n            >\n              <MicOff className=\"w-4 h-4\" />\n            </button>\n            <button \n              onClick={() => onKick?.(participant.identity)}\n              className=\"p-2 bg-red-700/80 hover:bg-red-800 rounded-full text-white\"\n              title=\"Kick User\"\n            >\n              <UserMinus className=\"w-4 h-4\" />\n            </button>\n          </div>\n        </div>\n      )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\pods\\TrollPodRoom.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useRef' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useRef"},"fix":{"range":[35,43],"text":""},"desc":"Remove unused variable \"useRef\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'trollCityTheme' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"trollCityTheme"},"fix":{"range":[166,227],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PhoneOff' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PhoneOff"},"fix":{"range":[255,265],"text":""},"desc":"Remove unused variable \"PhoneOff\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Video' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":66,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Video"},"fix":{"range":[286,293],"text":""},"desc":"Remove unused variable \"Video\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VideoOff' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":76,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"VideoOff"},"fix":{"range":[293,303],"text":""},"desc":"Remove unused variable \"VideoOff\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'currentUser'. Either include it or remove the dependency array.","line":80,"column":6,"nodeType":"ArrayExpression","endLine":80,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [currentUser, currentUser.id, room.id]","fix":{"range":[2452,2478],"text":"[currentUser, currentUser.id, room.id]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":97,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":428,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":428,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useRef } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { supabase } from '../../lib/supabase';\nimport { trollCityTheme } from '../../styles/trollCityTheme';\nimport { Mic, MicOff, Users, PhoneOff, MessageSquare, Hand, Video, VideoOff, UserPlus, UserMinus, UserX } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { LiveKitRoom, useParticipants, useRoomContext, RoomAudioRenderer } from '@livekit/components-react';\nimport '@livekit/components-styles';\nimport { Track } from 'livekit-client';\nimport { useLiveKitToken } from '../../hooks/useLiveKitToken';\nimport { useAuthStore } from '../../lib/store';\nimport { emitEvent as triggerEvent } from '../../lib/events';\nimport PodParticipantBox from './PodParticipantBox';\nimport PodChatBox from './PodChatBox';\n\ninterface Room {\n  id: string;\n  title: string;\n  host_id: string;\n  is_live: boolean;\n  viewer_count: number;\n}\n\ninterface PodParticipant {\n  id: string;\n  room_id: string;\n  user_id: string;\n  role: 'host' | 'speaker' | 'listener';\n  is_muted: boolean;\n  is_hand_raised: boolean;\n  user?: {\n    username: string;\n    avatar_url: string;\n  };\n}\n\n// Inner component to access LiveKit context\nconst PodRoomContent = ({ \n  room, \n  currentUser, \n  isHost,\n  participantsData,\n  onRequestSpeak,\n  onApproveRequest,\n  onRemoveSpeaker,\n  onCancelRequest\n}: { \n  room: Room, \n  currentUser: any, \n  isHost: boolean,\n  participantsData: PodParticipant[],\n  onRequestSpeak: () => void,\n  onApproveRequest: (userId: string) => void,\n  onRemoveSpeaker: (userId: string) => void,\n  onCancelRequest: () => void\n}) => {\n  const participants = useParticipants();\n  const liveKitRoom = useRoomContext();\n  const [showChat, setShowChat] = useState(true);\n  const [showRequests, setShowRequests] = useState(false);\n\n  // Derived state\n  const myRecord = participantsData.find(p => p.user_id === currentUser?.id);\n  const isSpeaker = isHost || myRecord?.role === 'speaker';\n  const isHandRaised = myRecord?.is_hand_raised;\n\n  // Task Tracking: Listen to Pod\n  useEffect(() => {\n    if (!currentUser || !room.id) return;\n\n    // Trigger \"listened\" event every 5 minutes\n    const interval = setInterval(() => {\n        triggerEvent('pod_listened', { \n            userId: currentUser.id, \n            metadata: { roomId: room.id, minutes: 5 } \n        });\n    }, 300000); // 5 minutes\n\n    return () => clearInterval(interval);\n  }, [currentUser?.id, room.id]);\n\n  // Instant Mute Enforcement\n  useEffect(() => {\n    if (myRecord?.is_muted && liveKitRoom.localParticipant.isMicrophoneEnabled) {\n       liveKitRoom.localParticipant.setMicrophoneEnabled(false);\n       toast.error('You have been muted by the host.');\n    }\n  }, [myRecord?.is_muted, liveKitRoom.localParticipant]);\n\n  const handleKick = async (userId: string) => {\n    if (!isHost) return;\n    if (confirm('Are you sure you want to kick and ban this user?')) {\n        try {\n        await supabase.from('pod_room_participants').delete().eq('room_id', room.id).eq('user_id', userId);\n        await supabase.from('pod_bans').insert({ room_id: room.id, user_id: userId });\n        toast.success('User kicked');\n        } catch (err) {\n        toast.error('Failed to kick user');\n        }\n    }\n  };\n\n  const handleMute = async (identity: string) => {\n    if (!isHost) return;\n    await supabase\n      .from('pod_room_participants')\n      .update({ is_muted: true })\n      .eq('room_id', room.id)\n      .eq('user_id', identity);\n    toast.success('Mute command sent');\n  };\n\n  const handleLeave = async () => {\n    if (!currentUser?.id || !room?.id) return;\n\n    if (isHost) {\n        // Host leaving ends the pod\n        if (confirm('Ending the pod will disconnect all users. Continue?')) {\n            await supabase\n                .from('pod_rooms')\n                .update({ is_live: false, ended_at: new Date().toISOString() })\n                .eq('id', room.id);\n            \n            liveKitRoom.disconnect();\n        }\n    } else {\n        // Regular user leaving\n        await supabase.from('pod_room_participants')\n            .delete()\n            .eq('room_id', room.id)\n            .eq('user_id', currentUser.id);\n        \n        liveKitRoom.disconnect();\n    }\n  };\n\n  // Requests List (for Host)\n  const requests = participantsData.filter(p => p.is_hand_raised && p.role === 'listener');\n\n  return (\n    <div className=\"flex h-screen bg-black text-white overflow-hidden font-sans\">\n      {/* Main Content (Participants) */}\n      <div className={`flex-1 flex flex-col transition-all duration-300 ${showChat ? 'mr-80' : 'mr-0'}`}>\n        {/* Header */}\n        <div className=\"h-16 flex items-center justify-between px-4 border-b border-gray-800 bg-gray-900/50 backdrop-blur-sm\">\n          <div className=\"flex items-center gap-3 overflow-hidden\">\n             <div className=\"w-2 h-2 rounded-full bg-red-500 animate-pulse\" />\n             <h1 className=\"text-lg font-bold truncate\">{room.title}</h1>\n          </div>\n          \n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center gap-2 px-3 py-1 bg-gray-800 rounded-full border border-gray-700\">\n              <Users className=\"w-4 h-4 text-gray-400\" />\n              <span className=\"text-sm font-mono\">{participants.length}</span>\n            </div>\n            \n            {isHost && requests.length > 0 && (\n                <button \n                    onClick={() => setShowRequests(!showRequests)}\n                    className=\"relative p-2 bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-500 rounded-full transition-colors\"\n                >\n                    <Hand className=\"w-5 h-5\" />\n                    <span className=\"absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] flex items-center justify-center rounded-full\">\n                        {requests.length}\n                    </span>\n                </button>\n            )}\n\n            <button \n              onClick={() => setShowChat(!showChat)}\n              className={`p-2 rounded-full transition-colors ${showChat ? 'bg-purple-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}\n            >\n              <MessageSquare className=\"w-5 h-5\" />\n            </button>\n            \n            <button \n              onClick={handleLeave}\n              className=\"px-4 py-1.5 bg-red-600/90 hover:bg-red-600 rounded-lg text-sm font-bold transition-colors\"\n            >\n              {isHost ? 'End Pod' : 'Leave'}\n            </button>\n          </div>\n        </div>\n\n        {/* Requests Panel (Overlay) */}\n        {showRequests && isHost && (\n            <div className=\"absolute top-16 right-80 z-50 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-xl p-4\">\n                <h3 className=\"text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider\">Requests to Speak</h3>\n                <div className=\"space-y-2\">\n                    {requests.map(req => (\n                        <div key={req.user_id} className=\"flex items-center justify-between bg-black/40 p-2 rounded\">\n                            <span className=\"text-sm truncate max-w-[100px]\">{req.user?.username || 'User'}</span>\n                            <div className=\"flex gap-1\">\n                                <button \n                                    onClick={() => onApproveRequest(req.user_id)}\n                                    className=\"p-1.5 bg-green-600/20 text-green-500 hover:bg-green-600 hover:text-white rounded\"\n                                    title=\"Approve\"\n                                >\n                                    <UserPlus size={14} />\n                                </button>\n                                <button \n                                    onClick={() => onRemoveSpeaker(req.user_id)} // Technically just denies request (clears hand raise)\n                                    className=\"p-1.5 bg-red-600/20 text-red-500 hover:bg-red-600 hover:text-white rounded\"\n                                    title=\"Deny\"\n                                >\n                                    <UserX size={14} />\n                                </button>\n                            </div>\n                        </div>\n                    ))}\n                    {requests.length === 0 && <div className=\"text-xs text-gray-500 text-center py-2\">No active requests</div>}\n                </div>\n            </div>\n        )}\n\n        {/* Participant Grid (Only Speakers/Host) */}\n        {/* We filter LiveKit participants to only show those who are publishing or are host/speakers in DB */}\n        <div className=\"flex-1 p-4 overflow-y-auto bg-gradient-to-b from-gray-900 to-black\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto\">\n            {participants.map((p) => {\n               const isParticipantHost = p.identity === room.host_id;\n               const isSelf = p.identity === currentUser?.id;\n               \n               // Check Supabase role\n               const sbUser = participantsData.find(pd => pd.user_id === p.identity);\n               const isSpeakerRole = sbUser?.role === 'speaker';\n\n               // Only render if they are host, approved speaker, or have active tracks\n               // We use getTrackPublication because videoTracks/audioTracks properties might not be directly exposed in this version's type def\n               const hasVideo = p.getTrackPublication(Track.Source.Camera) !== undefined;\n               const hasAudio = p.getTrackPublication(Track.Source.Microphone) !== undefined;\n               \n               if (!isParticipantHost && !isSpeakerRole && !hasVideo && !hasAudio) return null; \n\n               return (\n                 <PodParticipantBox\n                   key={p.identity}\n                   participant={p}\n                   isHost={isParticipantHost}\n                   isSelf={isSelf}\n                   onKick={isHost ? handleKick : undefined}\n                   onMute={isHost ? handleMute : undefined}\n                   onDemote={isHost ? onRemoveSpeaker : undefined}\n                 />\n               );\n            })}\n          </div>\n        </div>\n        \n        {/* Controls Bar (Bottom) */}\n        <div className=\"h-24 bg-gray-900/90 backdrop-blur-md border-t border-gray-800 flex items-center justify-center gap-8\">\n            {isSpeaker ? (\n                <>\n                    <button \n                        className={`p-4 rounded-full transition-all duration-200 transform hover:scale-105 ${liveKitRoom.localParticipant.isMicrophoneEnabled ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/20'}`}\n                        onClick={() => liveKitRoom.localParticipant.setMicrophoneEnabled(!liveKitRoom.localParticipant.isMicrophoneEnabled)}\n                    >\n                        {liveKitRoom.localParticipant.isMicrophoneEnabled ? <Mic className=\"w-6 h-6\" /> : <MicOff className=\"w-6 h-6\" />}\n                    </button>\n                    {!isHost && (\n                         <button \n                            className=\"flex flex-col items-center gap-1 text-xs text-gray-400 hover:text-white\"\n                            onClick={() => onRemoveSpeaker(currentUser?.id)}\n                         >\n                            <UserMinus className=\"w-5 h-5\" />\n                            <span>Leave Stage</span>\n                         </button>\n                    )}\n                </>\n            ) : (\n                // Listener Controls\n                <button \n                    onClick={isHandRaised ? onCancelRequest : onRequestSpeak}\n                    className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold transition-all transform hover:scale-105 ${\n                        isHandRaised \n                        ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' \n                        : 'bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg shadow-purple-500/30'\n                    }`}\n                >\n                    <Hand className={`w-5 h-5 ${isHandRaised ? '' : 'animate-bounce'}`} />\n                    {isHandRaised ? 'Cancel Request' : 'Request to Speak'}\n                </button>\n            )}\n        </div>\n      </div>\n\n      {/* Chat Sidebar */}\n      <div className={`fixed right-0 top-0 bottom-0 w-80 bg-gray-900 border-l border-gray-800 transform transition-transform duration-300 z-40 ${showChat ? 'translate-x-0' : 'translate-x-full'}`}>\n         <PodChatBox \n           roomId={room.id} \n           currentUserId={currentUser?.id} \n           isHost={isHost} \n         />\n      </div>\n      \n      <RoomAudioRenderer />\n    </div>\n  );\n};\n\nexport default function TrollPodRoom() {\n  const { roomId } = useParams();\n  const navigate = useNavigate();\n  const [room, setRoom] = useState<Room | null>(null);\n  const { user: currentUser } = useAuthStore();\n  const [participantsData, setParticipantsData] = useState<PodParticipant[]>([]);\n  \n  // Fetch Room Info\n  useEffect(() => {\n    if (!roomId) return;\n\n    const fetchRoom = async () => {\n      const { data, error } = await supabase\n        .from('pod_rooms')\n        .select('*')\n        .eq('id', roomId)\n        .single();\n\n      if (error || !data) {\n        toast.error('Room not found or ended');\n        navigate('/pods');\n        return;\n      }\n      \n      if (!data.is_live) {\n        toast.info('This pod has ended');\n        navigate('/pods');\n        return;\n      }\n\n      setRoom(data);\n    };\n\n    fetchRoom();\n\n    // Subscribe to room updates\n    const roomChannel = supabase\n      .channel(`room:${roomId}`)\n      .on('postgres_changes', { \n        event: 'UPDATE', \n        schema: 'public', \n        table: 'pod_rooms', \n        filter: `id=eq.${roomId}` \n      }, (payload) => {\n        if (payload.new.is_live === false) {\n          toast.info('The pod has ended');\n          navigate('/pods');\n        }\n        setRoom(payload.new as Room);\n      })\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(roomChannel);\n    };\n  }, [roomId, navigate]);\n\n  // Fetch & Subscribe Participants\n  useEffect(() => {\n    if (!roomId) return;\n\n    const fetchParticipants = async () => {\n        // Fetch participants first\n        const { data: participants } = await supabase\n            .from('pod_room_participants')\n            .select('*')\n            .eq('room_id', roomId);\n        \n        if (participants) {\n            // Fetch user profiles manually\n            const userIds = [...new Set(participants.map(p => p.user_id))];\n            const { data: profiles } = await supabase\n                .from('user_profiles')\n                .select('id, username, avatar_url')\n                .in('id', userIds);\n\n            const participantsWithUsers = participants.map(p => ({\n                ...p,\n                user: profiles?.find(profile => profile.id === p.user_id)\n            }));\n\n            // @ts-expect-error - type mismatch but runtime is safe\n            setParticipantsData(participantsWithUsers);\n        }\n    };\n\n    fetchParticipants();\n\n    const participantsChannel = supabase\n        .channel(`participants:${roomId}`)\n        .on('postgres_changes', {\n            event: '*',\n            schema: 'public',\n            table: 'pod_room_participants',\n            filter: `room_id=eq.${roomId}`\n        }, () => {\n            fetchParticipants();\n        })\n        .subscribe();\n    \n    const bansChannel = supabase\n        .channel(`bans:${roomId}`)\n        .on('postgres_changes', { \n            event: 'INSERT', \n            schema: 'public', \n            table: 'pod_bans', \n            filter: `room_id=eq.${roomId}` \n        }, (payload) => {\n            if (payload.new.user_id === currentUser.id) {\n                toast.error('You have been kicked and banned.');\n                navigate('/pods');\n            }\n        })\n        .subscribe();\n\n    return () => {\n        supabase.removeChannel(participantsChannel);\n        supabase.removeChannel(bansChannel);\n    };\n  }, [roomId, currentUser, navigate]);\n\n  // Auto-join as listener to enable chat (RLS requirement)\n  useEffect(() => {\n    if (!roomId || !currentUser) return;\n\n    const joinAsListener = async () => {\n        // Check if already in participants table\n        const { data, error } = await supabase\n            .from('pod_room_participants')\n            .select('id')\n            .eq('room_id', roomId)\n            .eq('user_id', currentUser.id)\n            .single();\n        \n        if (!data) {\n            // Not in table, insert as listener\n            await supabase.from('pod_room_participants').insert({\n                room_id: roomId,\n                user_id: currentUser.id,\n                role: 'listener',\n                is_hand_raised: false\n            });\n        }\n    };\n\n    joinAsListener();\n  }, [roomId, currentUser]);\n\n\n  // Actions\n  const handleRequestSpeak = async () => {\n    if (!currentUser || !roomId) return;\n    \n    // Upsert to handle both \"new joiner\" and \"existing participant\" cases\n    // This avoids race conditions with the auto-join effect\n    const { error } = await supabase.from('pod_room_participants').upsert({\n        room_id: roomId,\n        user_id: currentUser.id,\n        role: 'listener', // Only listeners request to speak\n        is_hand_raised: true\n    }, { onConflict: 'room_id, user_id', ignoreDuplicates: false });\n\n    if (error) {\n        toast.error('Failed to request to speak');\n        console.error(error);\n    } else {\n        toast.success('Request sent to host');\n    }\n  };\n\n  const handleCancelRequest = async () => {\n      if (!currentUser || !roomId) return;\n      await supabase.from('pod_room_participants')\n        .update({ is_hand_raised: false })\n        .eq('room_id', roomId)\n        .eq('user_id', currentUser.id);\n  };\n\n  const handleApproveRequest = async (userId: string) => {\n      await supabase.from('pod_room_participants')\n        .update({ role: 'speaker', is_hand_raised: false })\n        .eq('room_id', roomId)\n        .eq('user_id', userId);\n      toast.success('Speaker approved');\n  };\n\n  const handleRemoveSpeaker = async (userId: string) => {\n      // If it's a request denial (still listener), just clear hand raise\n      // If it's a speaker removal, downgrade to listener\n      // OR we can just delete the row if we want \"Deduct Box\" to mean \"Go back to audience\"\n      \n      const participant = participantsData.find(p => p.user_id === userId);\n      if (!participant) return;\n\n      if (participant.role === 'speaker') {\n           await supabase.from('pod_room_participants')\n            .update({ role: 'listener', is_hand_raised: false })\n            .eq('room_id', roomId)\n            .eq('user_id', userId);\n           toast.success('Speaker removed from stage');\n      } else {\n          // Just deny request\n           await supabase.from('pod_room_participants')\n            .update({ is_hand_raised: false })\n            .eq('room_id', roomId)\n            .eq('user_id', userId);\n           toast.info('Request denied');\n      }\n  };\n\n  // LiveKit Token Logic\n  const isHost = currentUser?.id === room?.host_id;\n  const myRole = participantsData.find(p => p.user_id === currentUser?.id)?.role;\n  const canPublish = isHost || myRole === 'speaker';\n\n  const { token, serverUrl, isLoading, error } = useLiveKitToken({\n    streamId: roomId,\n    roomName: roomId,\n    userId: currentUser?.id,\n    isHost: isHost,\n    canPublish: canPublish\n  });\n\n  if (!room) return <div className=\"flex items-center justify-center h-screen bg-black text-white\">Loading room...</div>;\n  if (isLoading) return <div className=\"flex items-center justify-center h-screen bg-black text-white\">Connecting to Pod...</div>;\n  if (error) return <div className=\"flex items-center justify-center h-screen bg-black text-white\">Error: {error}</div>;\n  if (!token || !serverUrl) return <div className=\"flex items-center justify-center h-screen bg-black text-white\">Initializing connection...</div>;\n\n  return (\n    <LiveKitRoom\n      token={token}\n      serverUrl={serverUrl}\n      connect={true}\n      data-lk-theme=\"default\"\n      style={{ height: '100vh' }}\n      onDisconnected={() => navigate('/pods')}\n    >\n      <PodRoomContent \n        room={room} \n        currentUser={currentUser} \n        isHost={isHost} \n        participantsData={participantsData}\n        onRequestSpeak={handleRequestSpeak}\n        onApproveRequest={handleApproveRequest}\n        onRemoveSpeaker={handleRemoveSpeaker}\n        onCancelRequest={handleCancelRequest}\n      />\n    </LiveKitRoom>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\pods\\TrollPodsListing.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\roles.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\secretary\\SecretaryConsole.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\tcps\\components\\ChatWindow.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":77,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":78,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[139,142],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":39,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadingMore' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":44,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoadingMore' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":44,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'hasMore' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":45,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'oldestLoadedAt' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":46,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setIsTyping' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":51,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'typingTimeoutRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":52,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'channelRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":53,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'profile?.avatar_url', 'profile?.rgb_username_expires_at', and 'profile?.username'. Either include them or remove the dependency array.","line":291,"column":6,"nodeType":"ArrayExpression","endLine":291,"endColumn":105,"suggestions":[{"desc":"Update the dependencies array to be: [actualConversationId, profile?.id, scrollToBottom, user?.id, isAtBottom, fetchMessagesWithSenders, profile?.username, profile?.avatar_url, profile?.rgb_username_expires_at]","fix":{"range":[9797,9896],"text":"[actualConversationId, profile?.id, scrollToBottom, user?.id, isAtBottom, fetchMessagesWithSenders, profile?.username, profile?.avatar_url, profile?.rgb_username_expires_at]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":323,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":323,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isTyping' is defined but never used. Allowed unused args must match /^_/u.","line":374,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":374,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState, useCallback } from 'react'\nimport { MoreVertical, Phone, Video, ArrowLeft, Ban, EyeOff, MessageCircle, X, Check, CheckCheck } from 'lucide-react'\nimport { useNavigate } from 'react-router-dom'\nimport { supabase, createConversation, getConversationMessages, markConversationRead } from '../../../lib/supabase'\nimport { useAuthStore } from '../../../lib/store'\nimport { useChatStore } from '../../../lib/chatStore'\nimport ClickableUsername from '../../../components/ClickableUsername'\nimport { toast } from 'sonner'\nimport MessageInput from './MessageInput'\n\ninterface ChatWindowProps {\n  conversationId: string | null\n  otherUserInfo: {\n    id: string\n    username: string\n    avatar_url: string | null\n    is_online?: boolean\n  } | null\n  isOnline?: boolean\n  onBack: () => void\n}\n\ninterface Message {\n  id: string\n  conversation_id: string\n  sender_id: string\n  content: string\n  created_at: string\n  read_at?: string | null\n  sender_username?: string\n  sender_avatar_url?: string | null\n  sender_rgb_expires_at?: string | null\n  isPending?: boolean\n}\n\nexport default function ChatWindow({ conversationId, otherUserInfo, isOnline, onBack }: ChatWindowProps) {\n  const { user, profile } = useAuthStore()\n  const { openChatBubble } = useChatStore()\n  const navigate = useNavigate()\n  const messagesContainerRef = useRef<HTMLDivElement>(null)\n  \n  const [messages, setMessages] = useState<Message[]>([])\n  const [loading, setLoading] = useState(false)\n  const [loadingMore, setLoadingMore] = useState(false)\n  const [hasMore, setHasMore] = useState(true)\n  const [oldestLoadedAt, setOldestLoadedAt] = useState<string | null>(null)\n  const [isAtBottom, setIsAtBottom] = useState(true)\n  const [actualConversationId, setActualConversationId] = useState<string | null>(conversationId)\n  const [showMenu, setShowMenu] = useState(false)\n  const menuRef = useRef<HTMLDivElement>(null)\n  const [isTyping, setIsTyping] = useState(false)\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null)\n  const channelRef = useRef<any>(null)\n  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null)\n\n  // Close menu on click outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setShowMenu(false)\n      }\n    }\n    document.addEventListener('mousedown', handleClickOutside)\n    return () => document.removeEventListener('mousedown', handleClickOutside)\n  }, [])\n\n  const handleBlock = async () => {\n    if (!otherUserInfo?.id || !user?.id) return\n    if (!confirm(`Are you sure you want to block ${otherUserInfo.username}?`)) return\n    \n    try {\n      const { error } = await supabase\n        .from('user_relationships')\n        .insert({\n          user_id: user.id,\n          related_user_id: otherUserInfo.id,\n          status: 'blocked'\n        })\n      \n      if (error) throw error\n      toast.success(`${otherUserInfo.username} blocked`)\n      onBack()\n    } catch (err) {\n      console.error('Error blocking user:', err)\n      toast.error('Failed to block user')\n    }\n    setShowMenu(false)\n  }\n\n  const handleHideChat = async () => {\n    if (!actualConversationId) return\n    if (!confirm('Hide this conversation? It will reappear if they message you.')) return\n\n    // For now, we'll just navigate back since \"hiding\" usually implies soft delete or just removing from list\n    // A real implementation might need a 'hidden_conversations' table or flag\n    toast.success('Chat hidden')\n    onBack()\n    setShowMenu(false)\n  }\n\n  const handleOpenChatBubble = () => {\n    if (!otherUserInfo) return\n    openChatBubble(otherUserInfo.id, otherUserInfo.username, otherUserInfo.avatar_url)\n    setShowMenu(false)\n    toast.success('Chat bubble opened! You can now navigate anywhere.')\n  }\n\n\n  // Initialize or fetch conversation\n  useEffect(() => {\n    const initChat = async () => {\n      if (!user?.id || !otherUserInfo?.id) return\n\n      // If we have a direct conversationId, use it. \n      // Otherwise, try to find one or create one?\n      // Actually, usually we pass conversationId if it exists. \n      // If it's null, we might need to find it by participants.\n      \n      let targetConvId = conversationId\n\n      if (!targetConvId) {\n        // Try to find existing conversation\n        const { data: existingConvs } = await supabase\n          .from('conversation_members')\n          .select('conversation_id')\n          .eq('user_id', user.id)\n\n        if (existingConvs) {\n           const myConvIds = existingConvs.map(c => c.conversation_id)\n           // Check if other user is in any of these\n           const { data: shared } = await supabase\n             .from('conversation_members')\n             .select('conversation_id')\n             .in('conversation_id', myConvIds)\n             .eq('user_id', otherUserInfo.id)\n             .maybeSingle()\n           \n           if (shared) {\n             targetConvId = shared.conversation_id\n           } else {\n             // Create new conversation\n             try {\n                const newConv = await createConversation([otherUserInfo.id])\n                targetConvId = newConv.id\n             } catch (err) {\n                console.error('Failed to create conversation', err)\n                toast.error('Failed to start chat')\n                return\n             }\n           }\n        }\n      }\n\n      setActualConversationId(targetConvId)\n    }\n\n    initChat()\n  }, [conversationId, otherUserInfo?.id, user?.id])\n\n  const scrollToBottom = useCallback(() => {\n    if (messagesContainerRef.current) {\n      messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight\n    }\n  }, [])\n\n  // Fetch messages and sender info\n  const fetchMessagesWithSenders = useCallback(async (convId: string) => {\n    const messagesData = await getConversationMessages(convId, { limit: 50 })\n    \n    // Enhance with sender info\n    const senderIds = [...new Set(messagesData.map(m => m.sender_id))]\n    const senderMap: Record<string, any> = {}\n    \n    if (senderIds.length > 0) {\n      const { data: usersData } = await supabase\n        .from('user_profiles')\n        .select('id,username,avatar_url,rgb_username_expires_at')\n        .in('id', senderIds)\n      \n      usersData?.forEach(u => {\n        senderMap[u.id] = u\n      })\n    }\n\n    return messagesData.map(m => ({\n      id: m.id,\n      conversation_id: m.conversation_id,\n      sender_id: m.sender_id,\n      content: m.body,\n      created_at: m.created_at,\n      read_at: m.read_at,\n      sender_username: senderMap[m.sender_id]?.username,\n      sender_avatar_url: senderMap[m.sender_id]?.avatar_url,\n      sender_rgb_expires_at: senderMap[m.sender_id]?.rgb_username_expires_at\n    })).reverse()\n  }, [])\n\n  // Load messages\n  useEffect(() => {\n    if (!actualConversationId || !profile?.id) return\n\n    const loadMessages = async () => {\n      setLoading(true)\n      try {\n        const mappedMessages = await fetchMessagesWithSenders(actualConversationId)\n        setMessages(mappedMessages)\n        setOldestLoadedAt(mappedMessages[0]?.created_at || null)\n        setHasMore(mappedMessages.length === 50)\n        \n        // Mark as read\n        await markConversationRead(actualConversationId)\n        \n        setTimeout(scrollToBottom, 100)\n\n      } catch (error) {\n        console.error('Error loading messages:', error)\n      } finally {\n        setLoading(false)\n      }\n    }\n\n    loadMessages()\n\n    // Subscribe to new messages\n    const channel = supabase\n      .channel(`chat:${actualConversationId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'conversation_messages',\n          filter: `conversation_id=eq.${actualConversationId}`\n        },\n        async (payload) => {\n          const newMsgRaw = payload.new\n          // Fetch sender info\n          let senderInfo = {\n             username: 'Unknown',\n             avatar_url: null,\n             rgb_username_expires_at: null\n          }\n          \n          if (newMsgRaw.sender_id === user?.id) {\n             senderInfo = {\n               username: profile?.username || 'You',\n               avatar_url: profile?.avatar_url || null,\n               rgb_username_expires_at: profile?.rgb_username_expires_at || null\n             }\n          } else {\n             const { data } = await supabase.from('user_profiles').select('username,avatar_url,rgb_username_expires_at').eq('id', newMsgRaw.sender_id).single()\n             if (data) senderInfo = data as any\n          }\n\n          const newMsg: Message = {\n            id: newMsgRaw.id,\n            conversation_id: newMsgRaw.conversation_id,\n            sender_id: newMsgRaw.sender_id,\n            content: newMsgRaw.body,\n            created_at: newMsgRaw.created_at,\n            read_at: newMsgRaw.read_at,\n            sender_username: senderInfo.username,\n            sender_avatar_url: senderInfo.avatar_url,\n            sender_rgb_expires_at: senderInfo.rgb_username_expires_at\n          }\n\n          setMessages(prev => {\n            // Remove any pending message that matches\n            const withoutPending = prev.filter(msg => {\n              if (msg.isPending && msg.sender_id === user?.id && msg.content === newMsg.content) {\n                return false\n              }\n              return true\n            })\n            return [...withoutPending, newMsg]\n          })\n          \n          if (newMsg.sender_id !== user?.id) {\n            await markConversationRead(actualConversationId)\n          }\n          if (isAtBottom) {\n            setTimeout(scrollToBottom, 100)\n          }\n        }\n      )\n      .subscribe()\n\n    return () => {\n      supabase.removeChannel(channel)\n    }\n  }, [actualConversationId, profile?.id, scrollToBottom, user?.id, isAtBottom, fetchMessagesWithSenders])\n\n  // Poll for new messages and read status updates every second\n  useEffect(() => {\n    if (!actualConversationId) return\n\n    const pollMessages = async () => {\n      try {\n        const mappedMessages = await fetchMessagesWithSenders(actualConversationId)\n        \n        setMessages(prev => {\n          const prevIds = new Set(prev.map(m => m.id))\n          \n          // Check if there are new messages\n          const hasNewMessages = mappedMessages.some(m => !prevIds.has(m.id))\n          if (hasNewMessages) {\n            return mappedMessages\n          }\n          \n          // Check for read status updates on existing messages\n          const hasReadUpdate = mappedMessages.some((m, idx) => {\n            if (idx < prev.length) {\n              return prev[idx].read_at !== m.read_at\n            }\n            return false\n          })\n          if (hasReadUpdate) {\n            return mappedMessages\n          }\n          \n          return prev\n        })\n      } catch (error) {\n        // Silent fail for polling\n      }\n    }\n\n    // Initial poll\n    pollMessages()\n\n    // Poll every second\n    pollIntervalRef.current = setInterval(pollMessages, 1000)\n\n    return () => {\n      if (pollIntervalRef.current) {\n        clearInterval(pollIntervalRef.current)\n      }\n    }\n  }, [actualConversationId, fetchMessagesWithSenders])\n\n  const handleScroll = () => {\n    if (!messagesContainerRef.current) return\n    const { scrollTop, scrollHeight, clientHeight } = messagesContainerRef.current\n    setIsAtBottom(scrollHeight - scrollTop - clientHeight < 100)\n    \n    // Load more logic could go here if scrollTop is 0\n  }\n\n  if (!otherUserInfo) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center bg-[#0A0A14] text-gray-500\">\n        Select a conversation to start chatting\n      </div>\n    )\n  }\n\n  const handleLocalNewMessage = (newMsg: any) => {\n    // Add message as pending with sender info\n    const pendingMsg: Message = {\n      id: `temp-${Date.now()}`,\n      conversation_id: actualConversationId || '',\n      sender_id: user?.id || '',\n      content: newMsg.content || newMsg.body,\n      created_at: new Date().toISOString(),\n      sender_username: profile?.username,\n      sender_avatar_url: profile?.avatar_url,\n      sender_rgb_expires_at: profile?.rgb_username_expires_at,\n      isPending: true\n    }\n    setMessages(prev => [...prev, pendingMsg])\n    scrollToBottom()\n  }\n\n  const handleLocalTyping = (isTyping: boolean) => {\n    // Optional: handle local typing indication if needed\n  }\n\n  return (\n    <div className=\"flex flex-col h-full bg-[#121212]\">\n      {/* Header */}\n      <div className=\"h-16 border-b border-purple-500/20 flex items-center justify-between px-4 bg-[#14141F]\">\n        <div className=\"flex items-center gap-3\">\n          <button onClick={onBack} className=\"md:hidden text-gray-400 hover:text-white\">\n            <ArrowLeft className=\"w-6 h-6\" />\n          </button>\n          \n          <div className=\"relative\">\n            <img \n              src={otherUserInfo.avatar_url || `https://ui-avatars.com/api/?name=${otherUserInfo.username}&background=random`}\n              alt={otherUserInfo.username}\n              className=\"w-10 h-10 rounded-full border border-purple-500/30\"\n            />\n            {isOnline && (\n              <div className=\"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-[#14141F]\" />\n            )}\n          </div>\n          \n          <div>\n            <ClickableUsername \n              username={otherUserInfo.username} \n              className=\"font-bold text-white leading-none hover:text-purple-400 transition-colors block\"\n            />\n            <span className=\"text-xs text-gray-400\">\n              {isOnline ? 'Online' : 'Offline'}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <button className=\"p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-colors\">\n            <Phone className=\"w-5 h-5\" />\n          </button>\n          <button className=\"p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-colors\">\n            <Video className=\"w-5 h-5\" />\n          </button>\n          <div className=\"relative\" ref={menuRef}>\n            <button \n              onClick={() => setShowMenu(!showMenu)}\n              className={`p-2 hover:text-white hover:bg-white/5 rounded-full transition-colors ${showMenu ? 'text-white bg-white/10' : 'text-gray-400'}`}\n            >\n              <MoreVertical className=\"w-5 h-5\" />\n            </button>\n\n            {showMenu && (\n              <div className=\"absolute right-0 top-full mt-2 w-48 bg-[#1F1F2E] border border-purple-500/20 rounded-lg shadow-xl z-50 overflow-hidden animate-in fade-in zoom-in duration-200\">\n                <button\n                  onClick={handleOpenChatBubble}\n                  className=\"w-full text-left px-4 py-3 text-sm text-gray-200 hover:bg-white/5 hover:text-white flex items-center gap-2 transition-colors\"\n                >\n                  <MessageCircle className=\"w-4 h-4 text-purple-400\" />\n                  Open Chat Bubble\n                </button>\n                <button\n                  onClick={handleHideChat}\n                  className=\"w-full text-left px-4 py-3 text-sm text-gray-200 hover:bg-white/5 hover:text-white flex items-center gap-2 transition-colors\"\n                >\n                  <EyeOff className=\"w-4 h-4 text-gray-400\" />\n                  Hide Chat\n                </button>\n                <div className=\"h-px bg-white/5 mx-2\" />\n                <button\n                  onClick={handleBlock}\n                  className=\"w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 flex items-center gap-2 transition-colors\"\n                >\n                  <Ban className=\"w-4 h-4\" />\n                  Block User\n                </button>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Messages */}\n      <div \n        className=\"flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar\"\n        ref={messagesContainerRef}\n        onScroll={handleScroll}\n      >\n        {loading && (\n          <div className=\"flex justify-center\">\n             <div className=\"w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin\" />\n          </div>\n        )}\n        \n        {messages.map((msg, idx) => {\n          const isMe = msg.sender_id === user?.id\n          const showAvatar = !isMe && (idx === 0 || messages[idx - 1].sender_id !== msg.sender_id)\n          \n          return (\n            <div key={msg.id} className={`flex gap-3 ${isMe ? 'justify-end' : 'justify-start'}`}>\n              {!isMe && (\n                <div className=\"w-8 flex-shrink-0 flex flex-col justify-end\">\n                   {showAvatar ? (\n                     <img \n                       src={msg.sender_avatar_url || `https://ui-avatars.com/api/?name=${msg.sender_username}&background=random`}\n                       className={`w-8 h-8 rounded-full border border-purple-500/20 ${msg.isPending ? 'opacity-50' : ''}`}\n                       alt={msg.sender_username}\n                     />\n                   ) : <div className=\"w-8\" />}\n                </div>\n              )}\n              \n              <div className={`max-w-[70%] space-y-1 ${isMe ? 'items-end' : 'items-start'} flex flex-col`}>\n                {!isMe && showAvatar && (\n                   <ClickableUsername \n                     username={msg.sender_username || ''}\n                     className=\"text-xs text-gray-400 ml-1 hover:text-purple-400\"\n                     profile={{ rgb_username_expires_at: msg.sender_rgb_expires_at || undefined }}\n                   />\n                )}\n                <div \n                  className={`px-4 py-2 rounded-2xl break-words ${\n                    isMe \n                      ? 'bg-purple-600 text-white rounded-tr-none' \n                      : 'bg-[#1F1F2E] text-gray-200 rounded-tl-none border border-purple-500/10'\n                  } ${msg.isPending ? 'opacity-70' : ''}`}\n                >\n                  {msg.content}\n                </div>\n                \n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-[10px] text-gray-500 px-1\">\n                    {new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                  </span>\n                  \n                  {/* Read status for own messages */}\n                  {isMe && (\n                    <span>\n                      {msg.read_at ? (\n                        <CheckCheck className=\"w-3 h-3 text-purple-400\" />\n                      ) : (\n                        <Check className={`w-3 h-3 ${msg.isPending ? 'text-gray-600' : 'text-gray-400'}`} />\n                      )}\n                    </span>\n                  )}\n                </div>\n              </div>\n            </div>\n          )\n        })}\n\n        {/* Typing Indicator */}\n        {isTyping && (\n          <div className=\"flex items-center gap-2 p-2 px-4 text-gray-400 text-xs\">\n            <div className=\"flex gap-1\">\n              <span className=\"animate-bounce delay-0\">.</span>\n              <span className=\"animate-bounce delay-100\">.</span>\n              <span className=\"animate-bounce delay-200\">.</span>\n            </div>\n            <span>{otherUserInfo?.username} is typing</span>\n          </div>\n        )}\n\n        <div className=\"h-1\" /> {/* Spacer */}\n      </div>\n\n      {/* Input */}\n      <div className=\"p-4 bg-[#1A1A1A] border-t border-[#2C2C2C]\">\n        {actualConversationId && otherUserInfo && (\n          <MessageInput \n            conversationId={actualConversationId}\n            otherUserId={otherUserInfo.id}\n            onMessageSent={scrollToBottom}\n            onNewMessage={handleLocalNewMessage}\n            onTyping={handleLocalTyping}\n          />\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\tcps\\components\\InboxSidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Trash2' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Trash2"},"fix":{"range":[95,103],"text":""},"desc":"Remove unused variable \"Trash2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[109,116],"text":""},"desc":"Remove unused variable \"Users\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Archive' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":61,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Archive"},"fix":{"range":[116,125],"text":""},"desc":"Remove unused variable \"Archive\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserRole' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"UserRole"},"fix":{"range":[207,217],"text":""},"desc":"Remove unused variable \"UserRole\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ClickableUsername' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":25,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"ClickableUsername"},"fix":{"range":[384,453],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userId' is defined but never used. Allowed unused args must match /^_/u.","line":57,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":64,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userId' is defined but never used. Allowed unused args must match /^_/u.","line":69,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from 'react'\nimport { Search, MessageCircle, Trash2, Mail, Users, Archive, MoreVertical, Ban, EyeOff, MessageSquare } from 'lucide-react'\nimport { supabase, UserRole } from '../../../lib/supabase'\nimport { useAuthStore } from '../../../lib/store'\nimport { useChatStore } from '../../../lib/chatStore'\nimport { toast } from 'sonner'\nimport ClickableUsername from '../../../components/ClickableUsername'\n\ninterface SidebarConversation {\n  other_user_id: string\n  other_username: string\n  other_avatar_url: string | null\n  last_message: string\n  last_timestamp: string\n  unread_count: number\n  is_online?: boolean\n  rgb_username_expires_at?: string | null\n}\n\ninterface InboxSidebarProps {\n  activeConversation: string | null\n  onSelectConversation: (userId: string) => void\n  onlineUsers: Record<string, boolean>\n  activeTab: string\n  setActiveTab: (tab: string) => void\n  onOpenNewMessage: () => void\n  onConversationsLoaded: (conversations: SidebarConversation[]) => void\n}\n\nexport default function InboxSidebar({\n  activeConversation,\n  onSelectConversation,\n  onlineUsers,\n  activeTab,\n  setActiveTab,\n  onOpenNewMessage,\n  onConversationsLoaded\n}: InboxSidebarProps) {\n  const { user } = useAuthStore()\n  const { openChatBubble } = useChatStore()\n  const [conversations, setConversations] = useState<SidebarConversation[]>([])\n  const [loading, setLoading] = useState(true)\n  const [searchQuery, setSearchQuery] = useState('')\n  const [openMenuId, setOpenMenuId] = useState<string | null>(null)\n  const menuRef = useRef<HTMLDivElement>(null)\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setOpenMenuId(null)\n      }\n    }\n    document.addEventListener('mousedown', handleClickOutside)\n    return () => document.removeEventListener('mousedown', handleClickOutside)\n  }, [])\n\n  const handleBlockUser = async (userId: string) => {\n    if (!user) return\n    try {\n      // Implement block logic here or call a helper\n      // For now just toast\n      toast.success('User blocked (simulation)')\n      setOpenMenuId(null)\n    } catch (error) {\n      toast.error('Failed to block user')\n    }\n  }\n\n  const handleHideChat = async (userId: string) => {\n    // Implement hide chat logic\n    toast.success('Chat hidden (simulation)')\n    setOpenMenuId(null)\n  }\n\n  const handleOpenBubble = (userId: string, username: string, avatarUrl: string | null) => {\n    openChatBubble(userId, username, avatarUrl)\n    setOpenMenuId(null)\n  }\n\n  const fetchConversations = useCallback(async () => {\n    if (!user?.id) return\n    setLoading(true)\n    try {\n      // Use the listUserConversations helper or manual query\n      // The snippet suggested listUserConversations might exist, but we can do it manually for more control over last message\n      \n      // We need last message and unread count.\n      // This is often complex in Supabase without a dedicated view or RPC.\n      // Let's assume we have an RPC or do a client-side join.\n      \n      // Let's try to fetch members and then last message for each.\n      const { data: members, error } = await supabase\n        .from('conversation_members')\n        .select('conversation_id, conversations(created_at)')\n        .eq('user_id', user.id)\n      \n      if (error) throw error\n\n      const convIds = members.map(m => m.conversation_id)\n      \n      if (convIds.length === 0) {\n        setConversations([])\n        onConversationsLoaded([])\n        setLoading(false)\n        return\n      }\n\n      // Fetch other members for these conversations\n      const { data: otherMembers } = await supabase\n        .from('conversation_members')\n        .select('conversation_id, user_id, user_profiles(username, avatar_url, rgb_username_expires_at)')\n        .in('conversation_id', convIds)\n        .neq('user_id', user.id)\n\n      // Fetch last messages (latest per conversation)\n      // This is hard to do in one query efficiently without lateral join.\n      // We'll fetch latest messages for all these conversations.\n      // Or we can just fetch all messages for these convs limit 1 per conv? No.\n      \n      // Let's fetch the most recent message for each conversation individually or use an RPC if available.\n      // Assuming no RPC for \"inbox\", we'll do it naively:\n      \n      const convsWithDetails = await Promise.all(convIds.map(async (cid) => {\n         const { data: msgs } = await supabase\n           .from('conversation_messages')\n           .select('body, created_at, sender_id')\n           .eq('conversation_id', cid)\n           .order('created_at', { ascending: false })\n           .limit(1)\n           .maybeSingle()\n         \n         const lastMsg = msgs || { body: 'No messages yet', created_at: '', sender_id: '' }\n         \n         // Find other member\n         const other = otherMembers?.find(om => om.conversation_id === cid)\n         if (!other || !other.user_profiles) return null\n         \n         // Unread count?\n         // Assuming we have a read_status table or similar, but typically we check last read time.\n         // Let's skip precise unread count for now or mock it.\n         \n         return {\n           other_user_id: other.user_id,\n           other_username: (other.user_profiles as any).username,\n           other_avatar_url: (other.user_profiles as any).avatar_url,\n           rgb_username_expires_at: (other.user_profiles as any).rgb_username_expires_at,\n           last_message: lastMsg.body,\n           last_timestamp: lastMsg.created_at,\n           unread_count: 0 // TODO: Implement unread count\n         }\n      }))\n      \n      const validConvs = convsWithDetails.filter(Boolean) as SidebarConversation[]\n      \n      // Sort by timestamp\n      validConvs.sort((a, b) => new Date(b.last_timestamp).getTime() - new Date(a.last_timestamp).getTime())\n      \n      setConversations(validConvs)\n      onConversationsLoaded(validConvs)\n\n    } catch (err) {\n      console.error('Error fetching conversations:', err)\n    } finally {\n      setLoading(false)\n    }\n  }, [user?.id, onConversationsLoaded])\n\n  useEffect(() => {\n    fetchConversations()\n    \n    // Subscribe to new messages to update sidebar ordering/preview\n    const channel = supabase\n      .channel('sidebar-updates')\n      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'conversation_messages' }, () => {\n         fetchConversations()\n      })\n      .subscribe()\n      \n    return () => {\n      supabase.removeChannel(channel)\n    }\n  }, [fetchConversations])\n\n  const filteredConversations = conversations.filter(c => \n    c.other_username.toLowerCase().includes(searchQuery.toLowerCase())\n  )\n\n  return (\n    <div className=\"flex flex-col h-full bg-[#0F0F1A] border-r border-purple-500/20\">\n      {/* Header */}\n      <div className=\"p-4 border-b border-purple-500/20 space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-xl font-bold text-white flex items-center gap-2\">\n            <Mail className=\"w-5 h-5 text-purple-400\" />\n            TCPS Inbox\n          </h1>\n          <button \n            onClick={onOpenNewMessage}\n            className=\"p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors shadow-lg shadow-purple-900/20\"\n          >\n            <MessageCircle className=\"w-5 h-5\" />\n          </button>\n        </div>\n        \n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400\" />\n          <input \n            type=\"text\" \n            placeholder=\"Search messages...\" \n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"w-full bg-[#0A0A14] border border-purple-500/30 rounded-lg pl-9 pr-4 py-2 text-sm text-white focus:outline-none focus:border-purple-500 transition-colors\"\n          />\n        </div>\n\n        <div className=\"flex gap-2 p-1 bg-[#0A0A14] rounded-lg\">\n          <button \n            onClick={() => setActiveTab('inbox')}\n            className={`flex-1 py-1.5 px-3 rounded text-xs font-medium transition-colors ${\n              activeTab === 'inbox' ? 'bg-[#1F1F2E] text-white shadow-sm' : 'text-gray-400 hover:text-gray-300'\n            }`}\n          >\n            Inbox\n          </button>\n          <button \n             onClick={() => setActiveTab('requests')}\n             className={`flex-1 py-1.5 px-3 rounded text-xs font-medium transition-colors ${\n              activeTab === 'requests' ? 'bg-[#1F1F2E] text-white shadow-sm' : 'text-gray-400 hover:text-gray-300'\n            }`}\n          >\n            Requests\n          </button>\n        </div>\n      </div>\n\n      {/* List */}\n      <div className=\"flex-1 overflow-y-auto\">\n        {loading ? (\n          <div className=\"flex justify-center p-8\">\n            <div className=\"w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin\" />\n          </div>\n        ) : filteredConversations.length === 0 ? (\n          <div className=\"p-8 text-center text-gray-500 text-sm\">\n            {searchQuery ? 'No conversations found' : 'No messages yet'}\n          </div>\n        ) : (\n          <div className=\"divide-y divide-purple-500/10\">\n            {filteredConversations.map((conv) => {\n              const isActive = activeConversation === conv.other_user_id\n              const isOnline = onlineUsers[conv.other_user_id]\n              \n              return (\n                <div\n                  key={conv.other_user_id}\n                  className={`relative group w-full p-4 flex items-start gap-3 hover:bg-white/5 transition-colors text-left ${\n                    isActive ? 'bg-white/5 before:absolute before:left-0 before:top-0 before:bottom-0 before:w-1 before:bg-purple-500' : ''\n                  }`}\n                >\n                  <div \n                    className=\"absolute inset-0 cursor-pointer\"\n                    onClick={() => onSelectConversation(conv.other_user_id)}\n                  />\n\n                  <div className=\"relative flex-shrink-0 pointer-events-none\">\n                    <img \n                      src={conv.other_avatar_url || `https://ui-avatars.com/api/?name=${conv.other_username}&background=random`}\n                      alt={conv.other_username}\n                      className=\"w-12 h-12 rounded-full border border-purple-500/20\"\n                    />\n                    {isOnline && (\n                      <div className=\"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[#0F0F1A]\" />\n                    )}\n                  </div>\n                  \n                  <div className=\"flex-1 min-w-0 pointer-events-none\">\n                    <div className=\"flex items-center justify-between mb-1\">\n                      <span className={`font-medium truncate ${isActive ? 'text-purple-300' : 'text-gray-200'}`}>\n                        {conv.other_username}\n                      </span>\n                      {conv.last_timestamp && (\n                        <span className=\"text-[10px] text-gray-500 flex-shrink-0\">\n                          {new Date(conv.last_timestamp).toLocaleDateString()}\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-gray-400 truncate pr-8\">\n                      {conv.last_message || 'Start a conversation'}\n                    </p>\n                  </div>\n                  \n                  {/* Menu Button */}\n                  <div className=\"relative z-10\">\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation()\n                        setOpenMenuId(openMenuId === conv.other_user_id ? null : conv.other_user_id)\n                      }}\n                      className=\"p-1 text-gray-400 hover:text-white rounded-full hover:bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity\"\n                    >\n                      <MoreVertical className=\"w-4 h-4\" />\n                    </button>\n\n                    {/* Dropdown Menu */}\n                    {openMenuId === conv.other_user_id && (\n                      <div \n                        ref={menuRef}\n                        className=\"absolute right-0 top-full mt-1 w-48 bg-[#1F1F2E] border border-purple-500/20 rounded-lg shadow-xl z-50 overflow-hidden\"\n                      >\n                        <button\n                          onClick={(e) => {\n                            e.stopPropagation()\n                            handleOpenBubble(conv.other_user_id, conv.other_username, conv.other_avatar_url)\n                          }}\n                          className=\"w-full px-4 py-2 text-left text-sm text-gray-300 hover:bg-white/5 flex items-center gap-2\"\n                        >\n                          <MessageSquare className=\"w-4 h-4\" />\n                          Open Chat Bubble\n                        </button>\n                        <button\n                          onClick={(e) => {\n                            e.stopPropagation()\n                            handleHideChat(conv.other_user_id)\n                          }}\n                          className=\"w-full px-4 py-2 text-left text-sm text-gray-300 hover:bg-white/5 flex items-center gap-2\"\n                        >\n                          <EyeOff className=\"w-4 h-4\" />\n                          Hide Chat\n                        </button>\n                        <button\n                          onClick={(e) => {\n                            e.stopPropagation()\n                            handleBlockUser(conv.other_user_id)\n                          }}\n                          className=\"w-full px-4 py-2 text-left text-sm text-red-400 hover:bg-red-500/10 flex items-center gap-2\"\n                        >\n                          <Ban className=\"w-4 h-4\" />\n                          Block User\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                  \n                  {conv.unread_count > 0 && (\n                    <div className=\"absolute right-10 top-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center text-[10px] font-bold text-white shadow-lg shadow-purple-600/50 pointer-events-none\">\n                      {conv.unread_count}\n                    </div>\n                  )}\n                </div>\n              )\n            })}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\tcps\\components\\MessageInput.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":19,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, KeyboardEvent, useRef } from 'react'\nimport { Send, Smile } from 'lucide-react'\nimport { supabase, sendConversationMessage } from '../../../lib/supabase'\nimport { sendNotification } from '../../../lib/sendNotification'\nimport { useAuthStore } from '../../../lib/store'\nimport { canMessageAdmin } from '../../../lib/perkEffects'\nimport { chargeMessageCost } from '../../../lib/profileViewPayment'\nimport { toast } from 'sonner'\n\ninterface MessageInputProps {\n  conversationId: string | null\n  otherUserId: string | null\n  onMessageSent: () => void\n  onNewMessage?: (msg: any) => void\n  onTyping?: (isTyping: boolean) => void\n}\n\nexport default function MessageInput({ conversationId, otherUserId, onMessageSent, onNewMessage, onTyping }: MessageInputProps) {\n  const { user, profile } = useAuthStore()\n  const [message, setMessage] = useState('')\n  const [sending, setSending] = useState(false)\n  const inputRef = useRef<HTMLInputElement>(null)\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null)\n\n  const handleTyping = () => {\n    if (onTyping) {\n      onTyping(true)\n      if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current)\n      typingTimeoutRef.current = setTimeout(() => {\n        onTyping(false)\n      }, 3000)\n    }\n  }\n\n  const sendMessage = async () => {\n    if (!message.trim() || !otherUserId || !profile?.id || sending) return\n    if (!conversationId) {\n      toast.error('Conversation not ready')\n      return\n    }\n\n    if (typingTimeoutRef.current) {\n      clearTimeout(typingTimeoutRef.current)\n      if (onTyping) onTyping(false)\n    }\n\n    setSending(true)\n\n    try {\n      // Check if user needs to pay to message\n      const { data: toUser } = await supabase\n        .from('user_profiles')\n        .select('id, username, message_cost, role, is_troll_officer, is_troller')\n        .eq('id', otherUserId)\n        .single()\n\n      if (!toUser) {\n        toast.error('User not found')\n        return\n      }\n\n      const senderRole = profile.role\n      const senderIsOfficer = profile.is_troll_officer || profile.is_officer\n      const senderIsTroller = profile.is_troller\n      const senderIsAdmin = senderRole === 'admin' || profile.is_admin\n      const hasMessagePerk = await canMessageAdmin(profile.id)\n      const canMessageFree = senderIsAdmin || senderIsOfficer || senderIsTroller || hasMessagePerk\n\n      if (!canMessageFree && toUser.message_cost && toUser.message_cost > 0) {\n        const { success, error: paymentError } = await chargeMessageCost(\n          profile.id,\n          toUser.id,\n          toUser.message_cost\n        )\n\n        if (!success) {\n          toast.error(paymentError || 'Payment required to message this user')\n          setSending(false)\n          return\n        }\n      }\n\n      const newMsg = await sendConversationMessage(conversationId, message)\n      \n      // Notify the user\n      await sendNotification(\n        otherUserId,\n        'message',\n        `New message from ${profile.username}`,\n        message.length > 50 ? message.substring(0, 50) + '...' : message,\n        {\n          conversation_id: conversationId,\n          sender_id: profile.id\n        }\n      )\n\n      setMessage('')\n      if (onNewMessage) {\n        onNewMessage(newMsg)\n      }\n      onMessageSent()\n    } catch (error: any) {\n      console.error('Error sending message:', error)\n      toast.error(error.message || 'Failed to send message')\n    } finally {\n      setSending(false)\n      inputRef.current?.focus()\n    }\n  }\n\n  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault()\n      sendMessage()\n    }\n  }\n\n  return (\n    <div className=\"p-4 bg-[#14141F] border-t border-purple-500/20\">\n      <div className=\"flex items-center gap-2\">\n        <button \n          className=\"p-2 text-gray-400 hover:text-purple-400 transition-colors\"\n          title=\"Emoji\"\n        >\n          <Smile className=\"w-5 h-5\" />\n        </button>\n        <div className=\"flex-1 relative\">\n          <input\n            ref={inputRef}\n            type=\"text\"\n            value={message}\n            onChange={(e) => {\n              setMessage(e.target.value)\n              handleTyping()\n            }}\n            onKeyDown={handleKeyDown}\n            placeholder=\"Type a message...\"\n            className=\"w-full bg-[#0A0A14] border border-purple-500/30 rounded-full px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors\"\n            disabled={sending}\n          />\n        </div>\n        <button\n          onClick={sendMessage}\n          disabled={!message.trim() || sending}\n          className={`p-2 rounded-full transition-all ${\n            message.trim() && !sending\n              ? 'bg-purple-600 hover:bg-purple-500 text-white shadow-[0_0_10px_rgba(147,51,234,0.5)]'\n              : 'bg-gray-800 text-gray-500 cursor-not-allowed'\n          }`}\n        >\n          <Send className=\"w-5 h-5\" />\n        </button>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\tcps\\components\\NewMessageModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadRecentUsers'. Either include it or remove the dependency array.","line":25,"column":6,"nodeType":"ArrayExpression","endLine":25,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, loadRecentUsers]","fix":{"range":[842,850],"text":"[isOpen, loadRecentUsers]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":138,"column":39,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5359,5399],"text":"\n              No users found matching &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5359,5399],"text":"\n              No users found matching &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5359,5399],"text":"\n              No users found matching &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5359,5399],"text":"\n              No users found matching &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":138,"column":53,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5412,5426],"text":"&quot;\n            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5412,5426],"text":"&ldquo;\n            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5412,5426],"text":"&#34;\n            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5412,5426],"text":"&rdquo;\n            "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react'\nimport { X, Search } from 'lucide-react'\nimport { supabase } from '../../../lib/supabase'\nimport { useAuthStore } from '../../../lib/store'\nimport ClickableUsername from '../../../components/ClickableUsername'\n\ninterface NewMessageModalProps {\n  isOpen: boolean\n  onClose: () => void\n  onSelectUser: (userId: string) => void\n}\n\nexport default function NewMessageModal({ isOpen, onClose, onSelectUser }: NewMessageModalProps) {\n  const { user } = useAuthStore()\n  const [searchQuery, setSearchQuery] = useState('')\n  const [searchResults, setSearchResults] = useState<any[]>([])\n  const [loading, setLoading] = useState(false)\n  const [recentUsers, setRecentUsers] = useState<any[]>([])\n\n  useEffect(() => {\n    if (isOpen) {\n      loadRecentUsers()\n      setSearchQuery('')\n    }\n  }, [isOpen])\n\n  const loadRecentUsers = async () => {\n    if (!user?.id) return\n    // Fetch users followed or recent interactions could be here\n    // For now, let's just fetch some random users or top users\n    const { data } = await supabase\n      .from('user_profiles')\n      .select('id, username, avatar_url, role')\n      .neq('id', user.id)\n      .limit(5)\n    \n    if (data) setRecentUsers(data)\n  }\n\n  const handleSearch = useCallback(async (query: string) => {\n    if (!query.trim()) {\n      setSearchResults([])\n      return\n    }\n\n    setLoading(true)\n    try {\n      const { data } = await supabase\n        .from('user_profiles')\n        .select('id, username, avatar_url, role, rgb_username_expires_at')\n        .ilike('username', `%${query}%`)\n        .neq('id', user?.id)\n        .limit(10)\n\n      setSearchResults(data || [])\n    } catch (error) {\n      console.error('Error searching users:', error)\n    } finally {\n      setLoading(false)\n    }\n  }, [user?.id])\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (searchQuery) handleSearch(searchQuery)\n    }, 300)\n    return () => clearTimeout(timer)\n  }, [searchQuery, handleSearch])\n\n  if (!isOpen) return null\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4\">\n      <div className=\"w-full max-w-md bg-[#14141F] rounded-2xl border border-purple-500/20 shadow-[0_0_30px_rgba(147,51,234,0.15)] flex flex-col max-h-[80vh]\">\n        <div className=\"p-4 border-b border-purple-500/20 flex items-center justify-between\">\n          <h2 className=\"text-lg font-bold text-white\">New Message</h2>\n          <button \n            onClick={onClose}\n            className=\"p-1 hover:bg-white/10 rounded-lg transition-colors\"\n          >\n            <X className=\"w-5 h-5 text-gray-400\" />\n          </button>\n        </div>\n\n        <div className=\"p-4 border-b border-purple-500/20\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400\" />\n            <input\n              type=\"text\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              placeholder=\"Search for a user...\"\n              className=\"w-full bg-[#0A0A14] border border-purple-500/30 rounded-lg pl-9 pr-4 py-2 text-white focus:outline-none focus:border-purple-500 transition-colors\"\n              autoFocus\n            />\n          </div>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-2\">\n          {loading ? (\n            <div className=\"flex justify-center p-4\">\n              <div className=\"w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin\" />\n            </div>\n          ) : searchResults.length > 0 ? (\n            <div className=\"space-y-1\">\n              <div className=\"px-2 py-1 text-xs font-medium text-gray-500 uppercase\">Search Results</div>\n              {searchResults.map((result) => (\n                <button\n                  key={result.id}\n                  onClick={() => onSelectUser(result.id)}\n                  className=\"w-full flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-colors text-left group\"\n                >\n                  <img\n                    src={result.avatar_url || `https://ui-avatars.com/api/?name=${result.username}&background=random`}\n                    alt={result.username}\n                    className=\"w-10 h-10 rounded-full border border-purple-500/20 group-hover:border-purple-500/50 transition-colors\"\n                  />\n                  <div>\n                    <div className=\"font-medium text-white flex items-center gap-2\">\n                      <ClickableUsername \n                        username={result.username} \n                        userId={result.id} \n                        rgbExpiresAt={result.rgb_username_expires_at}\n                        className=\"pointer-events-none\" // Disable link since the whole row is clickable\n                      />\n                      {result.role === 'admin' && (\n                        <span className=\"text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded border border-red-500/30\">\n                          ADMIN\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                </button>\n              ))}\n            </div>\n          ) : searchQuery ? (\n            <div className=\"text-center p-8 text-gray-500\">\n              No users found matching \"{searchQuery}\"\n            </div>\n          ) : (\n            <div className=\"space-y-1\">\n              <div className=\"px-2 py-1 text-xs font-medium text-gray-500 uppercase\">Suggested</div>\n              {recentUsers.map((result) => (\n                <button\n                  key={result.id}\n                  onClick={() => onSelectUser(result.id)}\n                  className=\"w-full flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-colors text-left\"\n                >\n                  <img\n                    src={result.avatar_url || `https://ui-avatars.com/api/?name=${result.username}&background=random`}\n                    alt={result.username}\n                    className=\"w-10 h-10 rounded-full border border-purple-500/20\"\n                  />\n                  <span className=\"font-medium text-white\">{result.username}</span>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\useGiftSystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pages\\useStreamEarnings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pwa\\install.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\pwa\\useInstallPrompt.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\service-worker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\services\\badgeEvaluationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\services\\passwordManager.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\services\\xpService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\stores\\useXPStore.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'computeXpState' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":32,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":113,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":113,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { create } from 'zustand'\r\nimport { supabase } from '../supabaseClient'\r\nimport { useAuthStore } from '../lib/store'\r\n\r\ninterface XPState {\r\n  xpTotal: number\r\n  level: number\r\n  xpToNext: number\r\n  progress: number\r\n  isLoading: boolean\r\n  fetchXP: (userId: string) => Promise<void>\r\n  subscribeToXP: (userId: string) => void\r\n  unsubscribe: () => void\r\n}\r\n\r\nexport const useXPStore = create<XPState>((set) => {\r\n  let channel: any = null;\r\n\r\n  const syncAuthProfile = (level: number, totalXp: number, nextLevelXp: number | null) => {\r\n    const auth = useAuthStore.getState()\r\n    if (!auth?.profile || !auth?.setProfile) return\r\n\r\n    auth.setProfile({\r\n      ...auth.profile,\r\n      level: level || auth.profile.level || 1,\r\n      xp: totalXp ?? auth.profile.xp ?? 0,\r\n      total_xp: totalXp ?? auth.profile.total_xp,\r\n      next_level_xp: nextLevelXp ?? auth.profile.next_level_xp,\r\n    })\r\n  }\r\n\r\n  const computeXpState = (data: {\r\n    level?: number; xp?: number; total_xp?: number; next_level_xp?: number;\r\n    current_level?: number; current_xp?: number; buyer_level?: number; buyer_xp?: number; stream_level?: number; stream_xp?: number;\r\n    [key: string]: any;\r\n  }) => {\r\n    // Prefer primary level columns, but use buyer_level/stream_level from user_level table\r\n    // For now, prioritize buyer_level as the main level\r\n    const levelValue = data.level\r\n      ?? data.current_level\r\n      ?? data.buyer_level\r\n      ?? data.stream_level\r\n      ?? 1\r\n\r\n    // Prefer buyer_xp from user_level table as main XP source\r\n    const absoluteXp = data.total_xp\r\n      ?? data.xp\r\n      ?? data.current_xp\r\n      ?? data.buyer_xp\r\n      ?? data.stream_xp\r\n      ?? 0\r\n\r\n    const nextLevelAbsolute = data.next_level_xp ?? (levelValue + 1) * 100\r\n    const prevLevelAbsolute = Math.max(0, levelValue * 100)\r\n\r\n    // If absoluteXp already looks like within-level XP, don't subtract a base\r\n    const looksLikeSegmentXp = absoluteXp <= nextLevelAbsolute && absoluteXp <= 100000 // guard against huge subtraction\r\n    const xpIntoLevel = looksLikeSegmentXp ? Math.max(0, absoluteXp) : Math.max(0, absoluteXp - prevLevelAbsolute)\r\n    const xpNeededThisLevel = Math.max(1, nextLevelAbsolute - prevLevelAbsolute)\r\n    const progressValue = Math.min(1, xpIntoLevel / xpNeededThisLevel)\r\n\r\n    console.log('XP Store computed:', { levelValue, absoluteXp, xpIntoLevel, xpNeededThisLevel, progressValue })\r\n\r\n    return {\r\n      levelValue,\r\n      totalXp: absoluteXp,\r\n      xpToNext: Math.max(0, xpNeededThisLevel - xpIntoLevel),\r\n      progressValue,\r\n      nextLevelAbsolute,\r\n    }\r\n  }\r\n\r\n  return {\r\n    xpTotal: 0,\r\n    level: 1,\r\n    xpToNext: 100,\r\n    progress: 0,\r\n    isLoading: false,\r\n\r\n    fetchXP: async (userId: string) => {\r\n      set({ isLoading: true })\r\n      try {\r\n        console.log('Fetching XP for user:', userId)\r\n        const { data, error } = await supabase\r\n          .from('user_stats')\r\n          .select('*')\r\n          .eq('user_id', userId)\r\n          .single()\r\n\r\n        console.log('user_stats query result:', { data, error })\r\n        \r\n        if (error && error.code !== 'PGRST116') throw error\r\n        \r\n        if (data) {\r\n          const level = data.level || 1\r\n          const xpTotal = data.xp_total || 0\r\n          const progress = data.xp_progress || 0\r\n          const nextLevelTotal = data.xp_to_next_level || 100\r\n          \r\n          const xpToNext = Math.max(0, nextLevelTotal - xpTotal)\r\n\r\n          set({\r\n            xpTotal,\r\n            level,\r\n            xpToNext,\r\n            progress,\r\n            isLoading: false\r\n          })\r\n          \r\n          syncAuthProfile(level, xpTotal, nextLevelTotal)\r\n        } else {\r\n            console.log('No user_stats found, initializing...')\r\n             const { data: newData, error: insertError } = await supabase\r\n                .rpc('grant_xp', { \r\n                    p_user_id: userId, \r\n                    p_amount: 0, \r\n                    p_source: 'init', \r\n                    p_source_id: `init_${Date.now()}` \r\n                })\r\n            \r\n            if (!insertError) {\r\n                 set({\r\n                    xpTotal: 0,\r\n                    level: 1,\r\n                    xpToNext: 100,\r\n                    progress: 0,\r\n                    isLoading: false\r\n                 })\r\n                 syncAuthProfile(1, 0, 100)\r\n            } else {\r\n                set({ isLoading: false })\r\n            }\r\n        }\r\n      } catch (error) {\r\n        console.error('Error fetching XP:', error)\r\n        set({ isLoading: false })\r\n      }\r\n    },\r\n\r\n    subscribeToXP: (userId: string) => {\r\n      if (channel) return\r\n\r\n      channel = supabase\r\n        .channel(`public:user_stats:${userId}`)\r\n        .on(\r\n          'postgres_changes',\r\n          {\r\n            event: '*',\r\n            schema: 'public',\r\n            table: 'user_stats',\r\n            filter: `user_id=eq.${userId}`\r\n          },\r\n          (payload) => {\r\n            console.log('XP Update received:', payload)\r\n            if (payload.new) {\r\n               const data = payload.new\r\n               const level = data.level || 1\r\n               const xpTotal = data.xp_total || 0\r\n               const progress = data.xp_progress || 0\r\n               const nextLevelTotal = data.xp_to_next_level || 100\r\n               const xpToNext = Math.max(0, nextLevelTotal - xpTotal)\r\n\r\n               set({\r\n                 xpTotal,\r\n                 level,\r\n                 xpToNext,\r\n                 progress\r\n               })\r\n               syncAuthProfile(level, xpTotal, nextLevelTotal)\r\n            } else {\r\n                set({\r\n                    xpTotal: 0,\r\n                    level: 1,\r\n                    xpToNext: 100,\r\n                    progress: 0,\r\n                    isLoading: false\r\n                 })\r\n                 syncAuthProfile(1, 0, 100)\r\n            }\r\n          }\r\n        )\r\n        .subscribe()\r\n    },\r\n\r\n    unsubscribe: () => {\r\n      if (channel) {\r\n        supabase.removeChannel(channel)\r\n        channel = null\r\n      }\r\n    }\r\n  }\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\styles\\trollCityTheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\supabaseClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\earnings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\ffmpeg.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\moderation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\purchases.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\trollDrop.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\trollEvents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\trollWall.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\types\\ui-mods.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\utils\\sessionStorage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\utils\\timeFormat.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\_shared\\badges.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\_shared\\cors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\_shared\\purchaseGate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\_shared\\supabaseClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\add-card\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\admin-reset\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\adminScheduler\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\admin\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\ai-detect-ghost-inactivity\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\ai-verify-user\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\apply-punishment\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\auth\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":40,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'benefits' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":317,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":317,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"jsr:@supabase/supabase-js@2\";\n\nconst decodeSettingValue = (value: unknown) => {\n  if (value === null || value === undefined) return null;\n  if (typeof value === \"string\") {\n    try {\n      return JSON.parse(value);\n    } catch {\n      return value;\n    }\n  }\n  return value;\n};\n\nconst buildAppSettingFetcher = (client: ReturnType<typeof createClient>) => async (key: string) => {\n  try {\n    const { data, error } = await client\n      .from(\"app_settings\")\n      .select(\"setting_value\")\n      .eq(\"key\", key)\n      .single();\n\n    if (error) {\n      throw error;\n    }\n\n    return decodeSettingValue(data?.setting_value ?? null);\n  } catch (error: any) {\n    console.warn(\n      `Unable to load app_settings.${key} (row or table may be missing); falling back to defaults.`,\n      error?.message || error\n    );\n    return null;\n  }\n};\n\nasync function waitForProfile(supabase: ReturnType<typeof createClient>, uid: string) {\n  for (let i = 0; i < 10; i++) {\n    const { data, error } = await supabase\n      .from('user_profiles')\n      .select('id')\n      .eq('id', uid)\n      .maybeSingle();\n\n    if (data?.id) return true;\n    // ignore errors briefly; profile may not exist yet\n    await new Promise((r) => setTimeout(r, 250));\n  }\n  return false;\n}\n\nDeno.serve(async (req: Request) => {\n  const supabase = createClient(\n    Deno.env.get(\"SUPABASE_URL\")!,\n    Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!,\n    { auth: { persistSession: false, autoRefreshToken: false } }\n  );\n  const fetchAppSettingValue = buildAppSettingFetcher(supabase);\n\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\n    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n  };\n\n  if (req.method === 'OPTIONS') {\n    return new Response('ok', { headers: corsHeaders });\n  }\n\n  try {\n    const url = new URL(req.url);\n    const path = url.pathname.split('/').pop();\n\n    // /admin-create-user\n    if (path === 'admin-create-user' && req.method === 'POST') {\n      const body = await req.json();\n      const { email, password, role, username } = body;\n      const r = String(role || 'user').toLowerCase();\n      const allowed = ['admin', 'troll_officer', 'troller', 'user'];\n      \n      if (!email || !password || !username) {\n        return new Response(JSON.stringify({ error: 'Missing email, password or username' }), {\n          status: 400,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n      \n      if (!allowed.includes(r)) {\n        return new Response(JSON.stringify({ error: 'Invalid role' }), {\n          status: 400,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      if (r === 'admin') {\n        const { data: exists } = await supabase\n          .from('user_profiles')\n          .select('id')\n          .eq('role', 'admin')\n          .limit(1);\n        if ((exists || []).length > 0) {\n          return new Response(JSON.stringify({ error: 'Admin already initialized' }), {\n            status: 409,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n          });\n        }\n      }\n\n      // 1. Create Auth User\n      const { data: created, error: createErr } = await supabase.auth.admin.createUser({\n        email,\n        password,\n        email_confirm: true,\n        user_metadata: { role: r, username: username }\n      });\n\n      if (createErr || !created.user) {\n        // Handle \"User already registered\" specifically if needed, but generic error is fine\n        return new Response(JSON.stringify({ error: createErr?.message || 'Create failed' }), {\n          status: (createErr?.message?.includes('registered') ? 409 : 500),\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const uid = created.user.id;\n      // const uname = String(username).trim().slice(0, 20);\n      // const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${uname || email.split('@')[0]}`;\n      \n      // 2. Wait for trigger to create profile\n      const ok = await waitForProfile(supabase, uid);\n      if (!ok) {\n        return new Response(JSON.stringify({ \n          error: 'Profile was not created by trigger. Check auth.users triggers / handle_user_signup().' \n        }), { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' }});\n      }\n\n      return new Response(JSON.stringify({ success: true, user_id: uid }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    // /admin-exists\n    if (path === 'admin-exists' && req.method === 'GET') {\n      const { data } = await supabase\n        .from('user_profiles')\n        .select('id')\n        .eq('role', 'admin')\n        .limit(2);\n      const exists = (data || []).length > 0;\n      \n      return new Response(JSON.stringify({ exists }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    // /whoami\n    if (path === 'whoami' && req.method === 'GET') {\n      const authHeader = req.headers.get('Authorization') || '';\n      const token = authHeader.startsWith('Bearer ') ? authHeader.slice(7) : undefined;\n      \n      if (!token) {\n        return new Response(JSON.stringify({ error: 'Missing token' }), {\n          status: 401,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const { data, error } = await supabase.auth.getUser(token);\n      if (error || !data?.user) {\n        return new Response(JSON.stringify({ error: 'Invalid token' }), {\n          status: 401,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      return new Response(JSON.stringify({ success: true, id: data.user.id, email: data.user.email }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    if (path === 'logout' && req.method === 'POST') {\n      return new Response(JSON.stringify({ message: 'Logged out.' }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    if (path === 'delete-account' && req.method === 'POST') {\n      const authHeader = req.headers.get('Authorization') || '';\n      const token = authHeader.startsWith('Bearer ') ? authHeader.slice(7) : undefined;\n\n      if (!token) {\n        return new Response(JSON.stringify({ error: 'Missing token' }), {\n          status: 401,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const { data, error } = await supabase.auth.getUser(token);\n      if (error || !data?.user) {\n        return new Response(JSON.stringify({ error: 'Invalid token' }), {\n          status: 401,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const userId = data.user.id;\n\n      const { error: authError } = await supabase.auth.admin.deleteUser(userId);\n      if (authError) {\n        return new Response(JSON.stringify({ error: authError.message || 'Failed to delete auth user' }), {\n          status: 500,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const { error: profileError } = await supabase\n        .from('user_profiles')\n        .delete()\n        .eq('id', userId);\n\n      if (profileError) {\n        return new Response(JSON.stringify({ error: profileError.message || 'Failed to delete profile' }), {\n          status: 500,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      return new Response(JSON.stringify({ success: true }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    if (path === 'fix-admin-role' && req.method === 'POST') {\n      const authHeader = req.headers.get('Authorization') || '';\n      const token = authHeader.startsWith('Bearer ') ? authHeader.slice(7) : undefined;\n      \n      if (!token) {\n        return new Response(JSON.stringify({ error: 'Missing token' }), {\n          status: 401,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const { data, error } = await supabase.auth.getUser(token);\n      if (error || !data?.user) {\n        return new Response(JSON.stringify({ error: 'Invalid token' }), {\n          status: 401,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const adminEmail = (Deno.env.get('VITE_ADMIN_EMAIL') || 'trollcity2025@gmail.com').trim().toLowerCase();\n      const userEmail = String(data.user.email || '').trim().toLowerCase();\n\n      if (userEmail !== adminEmail) {\n        return new Response(JSON.stringify({ error: 'Not admin email' }), {\n          status: 403,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const { data: existingProfile } = await supabase\n        .from('user_profiles')\n        .select('*')\n        .eq('id', data.user.id)\n        .single();\n\n      if (!existingProfile) {\n        return new Response(JSON.stringify({ error: 'Profile not found' }), {\n          status: 500,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      if (existingProfile.role !== 'admin') {\n        await supabase\n          .from('user_profiles')\n          .update({ role: 'admin', updated_at: new Date().toISOString() })\n          .eq('id', data.user.id);\n        \n        return new Response(JSON.stringify({ success: true, profile: { ...existingProfile, role: 'admin' } }), {\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      return new Response(JSON.stringify({ success: true, profile: existingProfile }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    // /signup - No auth required (user doesn't exist yet)\n    // This endpoint uses service role key internally, so no user auth needed\n    if (path === 'signup' && req.method === 'POST') {\n      const body = await req.json();\n      const { email, password, username, referral_code, role } = body;\n      if (!email || !password || !username) {\n        return new Response(JSON.stringify({ error: 'Missing email, password or username' }), {\n          status: 400,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      // Check testing mode\n      const testingModeSetting = await fetchAppSettingValue('testing_mode');\n      const testingMode = testingModeSetting || { enabled: false, signup_limit: 15, current_signups: 0 };\n      const isTestingMode = testingMode.enabled;\n      if (isTestingMode && testingMode.current_signups >= testingMode.signup_limit) {\n        return new Response(JSON.stringify({ error: 'Signups are currently limited. Testing mode is active and the signup limit has been reached. Please contact an administrator.' }), {\n          status: 403,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      // Get test user benefits\n      const benefitsSetting = await fetchAppSettingValue('test_user_benefits');\n      const benefits = benefitsSetting || { initial_coins: 5000, bypass_family_fee: true, bypass_admin_message_fee: true };\n\n      // Always resolve role name for user_profiles (text only)\n      const roleName = String(role || 'user').toLowerCase();\n\n      const trimmedUsername = username.trim();\n      const { data: created, error: createErr } = await supabase.auth.admin.createUser({\n        email,\n        password,\n        email_confirm: true,\n        user_metadata: { username: trimmedUsername, is_test_user: isTestingMode, role: roleName },\n        app_metadata: { username: trimmedUsername, is_test_user: isTestingMode, role: roleName }\n      });\n\n      if (createErr || !created.user) {\n        return new Response(JSON.stringify({ error: createErr?.message || 'Failed to create user' }), {\n          status: 500,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        });\n      }\n\n      const uid = created.user.id;\n      // const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${trimmedUsername}`;\n      // const initialCoins = isTestingMode ? (benefits.initial_coins ?? benefits.free_coins ?? 0) : 0;\n\n      // Wait for trigger to create profile\n      const ok = await waitForProfile(supabase, uid);\n      if (!ok) {\n        return new Response(JSON.stringify({ \n          error: 'Profile was not created by trigger. Check auth.users triggers / handle_user_signup().' \n        }), { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' }});\n      }\n\n      // Update signup count if testing mode\n      if (isTestingMode) {\n        await supabase\n          .from('app_settings')\n          .update({ setting_value: { ...testingMode, current_signups: testingMode.current_signups + 1 } })\n          .eq('key', 'testing_mode');\n      }\n\n      // Handle referral code if provided\n      if (referral_code) {\n        try {\n          // Verify referral code is a valid user ID\n          const { data: recruiterProfile } = await supabase\n            .from('user_profiles')\n            .select('id')\n            .eq('id', referral_code)\n            .single();\n\n          if (recruiterProfile && recruiterProfile.id !== uid) {\n            // Create referral relationship using new table structure\n            const { error: referralError } = await supabase\n              .from('referrals')\n              .insert({\n                referrer_id: referral_code,\n                referred_user_id: uid,\n                referred_at: new Date().toISOString(),\n                reward_status: 'pending',\n                deadline: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000).toISOString() // 21 days from now\n              });\n\n            if (referralError) {\n              console.error('Error creating referral:', referralError);\n              // Don't fail signup if referral creation fails\n            }\n          }\n        } catch (error) {\n          console.error('Error processing referral code:', error);\n          // Don't fail signup if referral processing fails\n        }\n      }\n\n      return new Response(JSON.stringify({ success: true }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    }\n\n    return new Response(JSON.stringify({ error: 'Not found' }), {\n      status: 404,\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n    });\n\n  } catch (error: any) {\n    let message = 'Unknown error';\n    if (error) {\n      if (typeof error === 'string') {\n        message = error;\n      } else if (error.message) {\n        message = error.message;\n      } else if (error.toString) {\n        message = error.toString();\n      }\n    }\n    return new Response(JSON.stringify({\n      error: message,\n      details: error\n    }), {\n      status: 500,\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n    });\n  }\n})\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\auto-clock-out\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\award-badge\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\bank-apply\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'token' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":35,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":66,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\"\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2.39.3\"\n\nexport const corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Headers\": \"authorization, apikey, content-type, x-client-info\",\n  \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n};\n\nserve(async (req) => {\n  // Handle CORS preflight requests\n  if (req.method === 'OPTIONS') {\n    return new Response('ok', { headers: corsHeaders })\n  }\n\n  try {\n\n\n    const authHeader = req.headers.get(\"authorization\") ?? req.headers.get(\"Authorization\");\n    console.log(\"[bank-apply] has auth header:\", !!authHeader);\n    console.log(\"[bank-apply] auth header prefix:\", authHeader?.slice(0, 15));\n\n    if (!authHeader?.startsWith(\"Bearer \")) {\n      return new Response(\n        JSON.stringify({\n          error: \"Unauthorized\",\n          reason: \"missing bearer token\",\n          hasAuthHeader: !!authHeader,\n          authHeaderPrefix: authHeader?.slice(0, 15) || null\n        }),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    const token = authHeader.replace(\"Bearer \", \"\").trim();\n\n    const supabase = createClient(\n      Deno.env.get(\"SUPABASE_URL\")!,\n      Deno.env.get(\"SUPABASE_ANON_KEY\")!,\n      {\n        global: {\n          headers: { Authorization: authHeader },\n        },\n      }\n    );\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return new Response(\n        JSON.stringify({\n          error: \"Unauthorized\",\n          reason: authError?.message ?? \"user not found\",\n          hasAuthHeader: !!authHeader,\n          authHeaderPrefix: authHeader?.slice(0, 15) || null,\n          authError: authError?.message || null\n        }),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n\n    let body;\n    try {\n      body = await req.json();\n    } catch (e) {\n      return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400, headers: corsHeaders });\n    }\n\n    const coins = body.amount || body.requested_coins;\n    if (!coins) {\n      return new Response(JSON.stringify({ error: 'Missing amount' }), { status: 400, headers: corsHeaders });\n    }\n\n\n\n    // Call the RPC with derived user.id\n    let rpcReached = false;\n    let rpcErrorMsg = null;\n    let rpcData = null;\n    try {\n      const { error: rpcError, data } = await supabase.rpc(\n        'troll_bank_apply_for_loan',\n        {\n          p_requested_coins: coins,\n        }\n      );\n      rpcReached = true;\n      rpcErrorMsg = rpcError?.message || null;\n      rpcData = data;\n      if (rpcError) {\n        return new Response(\n          JSON.stringify({\n            error: rpcError.message,\n            rpcReached,\n            rpcErrorMsg,\n            rpcData\n          }),\n          { status: 400, headers: corsHeaders }\n        );\n      }\n      if (data && data.success === false) {\n        return new Response(\n          JSON.stringify({\n            error: data.reason || data.message || 'Loan application denied',\n            data,\n            rpcReached,\n            rpcErrorMsg,\n            rpcData\n          }),\n          { status: 400, headers: corsHeaders }\n        );\n      }\n    } catch (rpcCatchError) {\n      return new Response(\n        JSON.stringify({\n          error: 'RPC call failed',\n          rpcReached,\n          rpcErrorMsg: rpcCatchError?.message || String(rpcCatchError),\n          rpcData\n        }),\n        { status: 500, headers: corsHeaders }\n      );\n    }\n\n    // Audit Log (using Service Role)\n    try {\n        const supabaseAdmin = createClient(\n            Deno.env.get('SUPABASE_URL') ?? '',\n            Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''\n        )\n        \n        await supabaseAdmin.from('bank_audit_log').insert({\n            action: 'loan_application',\n            performed_by: userId,\n            target_user_id: userId,\n            details: { requested_coins: coins, result: data, via_service: isServiceCall }\n        })\n    } catch (auditError) {\n        console.error('Audit log error:', auditError)\n        // Don't fail the request if audit fails\n    }\n\n    return new Response(JSON.stringify({\n      success: true,\n      hasAuthHeader: !!authHeader,\n      authHeaderPrefix: authHeader?.slice(0, 15) || null,\n      rpcReached,\n      rpcErrorMsg,\n      rpcData\n    }), { headers: corsHeaders })\n  } catch (error) {\n    console.error('Unexpected error:', error)\n    return new Response(JSON.stringify({ error: error.message }), { status: 500, headers: corsHeaders })\n  }\n})\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\bank-credit\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\battles\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\broadcast-seats\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\calc_post_earnings\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\close-officer-vote-cycle\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\complete-ghost-mission\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\credit-daily-maintenance\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\credit-loan-handler\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\credit-record-event\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\cron-tasks\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'req' is defined but never used. Allowed unused args must match /^_/u.","line":8,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'\n\nconst supabaseUrl = Deno.env.get('SUPABASE_URL')!\nconst supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey)\n\nDeno.serve(async (req) => {\n  try {\n    console.log('Starting cron tasks...')\n\n    // 1. Decay Broadcast Levels\n    const { error: decayError } = await supabase.rpc('decay_broadcast_levels')\n    if (decayError) {\n        console.error('Error decaying broadcast levels:', decayError)\n    } else {\n        console.log('Broadcast levels decayed successfully')\n    }\n\n    // 2. Process Admin Queue\n    const { error: queueError } = await supabase.rpc('process_admin_queue')\n    if (queueError) {\n        console.error('Error processing admin queue:', queueError)\n    } else {\n        console.log('Admin queue processed successfully')\n    }\n\n    // 3. Check Loan Defaults\n    const { error: loanError } = await supabase.rpc('check_loan_defaults')\n    if (loanError) {\n        console.error('Error checking loan defaults:', loanError)\n    } else {\n        console.log('Loan defaults checked successfully')\n    }\n\n    return new Response(JSON.stringify({ success: true }), {\n      headers: { 'Content-Type': 'application/json' },\n    })\n  } catch (error) {\n    console.error('Cron task failed:', error)\n    return new Response(JSON.stringify({ error: error.message }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n})\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\dismiss-notification\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\end-home-feature-cycle\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\evaluate-badges-for-event\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\expire-officer-roles\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\fulfill-paypal-purchase\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\gemini-verify-user\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\get-training-scenario\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\go-live-mark-live\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\go-live-prepare-session\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\go-live-refund-hd-boost\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\live\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\livekit-api\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\livekit-token\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\livekit-webhooks\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\loan-payment\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\log-moderation-event\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\manual-coin-order\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\moderation\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\mux-create-stream\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\officer-auto-clockout\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\officer-get-assignment\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\officer-join-stream\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\officer-leave-stream\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\officer-report-abuse\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\officer-touch-activity\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\password-manager\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\payments-status\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\payments\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\payouts\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\paypal-complete-order\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":118,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":118,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\r\nimport { createClient } from \"jsr:@supabase/supabase-js@2\";\r\nimport { corsHeaders } from \"../_shared/cors.ts\";\r\n\r\nconst SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\") ?? \"\";\r\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\") ?? \"\";\r\n\r\nconst supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {\r\n  auth: { persistSession: false, autoRefreshToken: false },\r\n});\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(\"ok\", { headers: corsHeaders });\r\n  }\r\n\r\n  if (req.method !== \"POST\") {\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Method not allowed\" }),\r\n      {\r\n        status: 405,\r\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n      },\r\n    );\r\n  }\r\n\r\n  try {\r\n    const body = await req.json();\r\n    const orderId: string | undefined = body?.orderId ?? body?.orderID;\r\n    const userId: string | undefined = body?.userId ?? body?.user_id;\r\n    const packageId: string | undefined = body?.packageId ?? body?.package_id;\r\n\r\n    if (!orderId || !userId) {\r\n      throw new Error(\"Missing required fields: orderId and userId\");\r\n    }\r\n\r\n    // 0. Check if order already processed\r\n    const { data: existingTx } = await supabase\r\n      .from(\"paypal_transactions\")\r\n      .select(\"*\")\r\n      .eq(\"paypal_order_id\", orderId)\r\n      .maybeSingle();\r\n\r\n    if (existingTx && existingTx.status === \"credited\") {\r\n      return new Response(JSON.stringify({\r\n        success: true,\r\n        coinsAdded: existingTx.coins,\r\n        alreadyProcessed: true,\r\n      }), { status: 200, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } });\r\n    }\r\n\r\n    // 1. Verify and capture payment with PayPal\r\n    const clientId = Deno.env.get(\"PAYPAL_CLIENT_ID\");\r\n    const clientSecret = Deno.env.get(\"PAYPAL_CLIENT_SECRET\");\r\n    const isSandbox = Deno.env.get(\"PAYPAL_MODE\") === \"sandbox\";\r\n    const baseUrl = isSandbox\r\n      ? \"https://api-m.sandbox.paypal.com\"\r\n      : \"https://api-m.paypal.com\";\r\n\r\n    if (!clientId || !clientSecret) {\r\n      throw new Error(\"PayPal credentials not configured\");\r\n    }\r\n\r\n    const auth = btoa(`${clientId}:${clientSecret}`);\r\n\r\n    const tokenRes = await fetch(`${baseUrl}/v1/oauth2/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Basic ${auth}`,\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n      },\r\n      body: \"grant_type=client_credentials\",\r\n    });\r\n\r\n    if (!tokenRes.ok) {\r\n      const text = await tokenRes.text();\r\n      console.error(\"PayPal token error:\", text);\r\n      throw new Error(\"Failed to authenticate with PayPal\");\r\n    }\r\n\r\n    const tokenData = await tokenRes.json();\r\n    const accessToken = tokenData.access_token as string;\r\n\r\n    // Fetch order first\r\n    const orderRes = await fetch(`${baseUrl}/v2/checkout/orders/${orderId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${accessToken}`, \"Content-Type\": \"application/json\" },\r\n    });\r\n    if (!orderRes.ok) {\r\n      const text = await orderRes.text();\r\n      console.error(\"PayPal get order error:\", text);\r\n      throw new Error(\"Failed to fetch PayPal order\");\r\n    }\r\n\r\n    let orderData: any = await orderRes.json();\r\n    let status: string = orderData?.status ?? \"\";\r\n\r\n    // Capture only if approved\r\n    if (status === \"APPROVED\") {\r\n      const captureRes = await fetch(`${baseUrl}/v2/checkout/orders/${orderId}/capture`, {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${accessToken}`, \"Content-Type\": \"application/json\" },\r\n      });\r\n\r\n      if (!captureRes.ok) {\r\n        const text = await captureRes.text();\r\n        console.error(\"PayPal capture error:\", text);\r\n\r\n        let errorMessage = \"Failed to capture PayPal order\";\r\n        try {\r\n          const jsonError = JSON.parse(text);\r\n          const details = jsonError.details?.[0];\r\n          if (details?.issue === \"INSTRUMENT_DECLINED\") {\r\n            errorMessage = \"Payment declined by bank. Please check your funds or try another card.\";\r\n          } else if (jsonError.name === \"UNPROCESSABLE_ENTITY\") {\r\n            errorMessage = \"Payment could not be processed. Please try again.\";\r\n          }\r\n        } catch (e) {\r\n          // Keep default error\r\n        }\r\n\r\n        return new Response(JSON.stringify({\r\n          success: false,\r\n          error: errorMessage,\r\n          paypal_details: text,\r\n          orderId,\r\n          mode: Deno.env.get(\"PAYPAL_MODE\"),\r\n        }), { status: 400, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }});\r\n      }\r\n\r\n      orderData = await captureRes.json();\r\n      status = orderData?.status ?? \"\";\r\n    }\r\n\r\n    // Accept already completed\r\n    const completed =\r\n      status === \"COMPLETED\" ||\r\n      orderData?.purchase_units?.[0]?.payments?.captures?.[0]?.status === \"COMPLETED\";\r\n\r\n    if (!completed) {\r\n      throw new Error(`Payment not completed (status: ${status || \"unknown\"})`);\r\n    }\r\n\r\n    const capture =\r\n      orderData?.purchase_units?.[0]?.payments?.captures?.[0] ?? null;\r\n\r\n    const captureId: string | null = capture?.id ?? null;\r\n\r\n    const amountValueString: string =\r\n      capture?.amount?.value ??\r\n      orderData?.purchase_units?.[0]?.amount?.value ??\r\n      \"0\";\r\n\r\n    const verifiedAmount = parseFloat(amountValueString || \"0\");\r\n    const verifiedCurrency: string =\r\n      capture?.amount?.currency_code ??\r\n      orderData?.purchase_units?.[0]?.amount?.currency_code ??\r\n      \"USD\";\r\n\r\n    // 2. Determine how many coins to credit\r\n    let coinsToCredit = 0;\r\n\r\n    if (packageId) {\r\n      if (String(packageId) === 'troll_pass_bundle') {\r\n        coinsToCredit = 1500;\r\n      } else if (String(packageId) === 'pkg-1000-promo') {\r\n        coinsToCredit = 1000;\r\n      } else if (String(packageId).startsWith(\"custom_\")) {\r\n        const parts = String(packageId).split(\"_\");\r\n        const raw = parts[1];\r\n        const parsed = raw ? parseInt(raw, 10) : NaN;\r\n        if (Number.isFinite(parsed) && parsed > 0) {\r\n          coinsToCredit = parsed;\r\n        }\r\n      } else {\r\n        const { data: pkg, error: pkgError } = await supabase\r\n          .from(\"coin_packages\")\r\n          .select(\"coins\")\r\n          .eq(\"id\", packageId)\r\n          .maybeSingle();\r\n\r\n        if (pkgError) {\r\n          console.error(\"coin_packages lookup error:\", pkgError);\r\n          throw new Error(\"Failed to load coin package\");\r\n        }\r\n\r\n        if (!pkg?.coins || pkg.coins <= 0) {\r\n          console.error(`Invalid coin package ID: ${packageId}`);\r\n          throw new Error(`Invalid coin package: ${packageId}`);\r\n        }\r\n\r\n        coinsToCredit = pkg.coins;\r\n      }\r\n    }\r\n\r\n    if (!coinsToCredit || coinsToCredit <= 0) {\r\n      throw new Error(\"Could not determine coin amount for package\");\r\n    }\r\n\r\n    // 2.5 Record successful capture\r\n    await supabase.from(\"paypal_transactions\").upsert({\r\n      user_id: userId,\r\n      paypal_order_id: orderId,\r\n      paypal_capture_id: captureId,\r\n      amount: verifiedAmount,\r\n      currency: verifiedCurrency,\r\n      coins: coinsToCredit,\r\n      status: \"completed\"\r\n    });\r\n\r\n    // 3. Credit coins using Troll Bank (handles ledger + repayment)\r\n    const refId = captureId || orderId;\r\n\r\n    const { data: bankResult, error: bankError } = await supabase.rpc(\r\n      \"troll_bank_credit_coins\",\r\n      {\r\n        p_user_id: userId,\r\n        p_coins: coinsToCredit,\r\n        p_bucket: \"paid\",\r\n        p_source: \"paypal_purchase\",\r\n        p_ref_id: refId,\r\n      },\r\n    );\r\n\r\n    if (bankError) {\r\n      console.error(\"troll_bank_credit_coins error:\", bankError);\r\n      throw new Error(bankError.message || \"Failed to credit coins\");\r\n    }\r\n\r\n    // 4. Mark transaction as credited\r\n    await supabase\r\n      .from(\"paypal_transactions\")\r\n      .update({ status: \"credited\" })\r\n      .eq(\"paypal_order_id\", orderId);\r\n\r\n    const userGets =\r\n      bankResult && typeof bankResult.user_gets === \"number\"\r\n        ? bankResult.user_gets\r\n        : coinsToCredit;\r\n\r\n    const responseBody = {\r\n      success: true,\r\n      coinsAdded: userGets,\r\n      repay: bankResult?.repay ?? 0,\r\n      newLoanBalance: bankResult?.new_loan_balance ?? null,\r\n      loanStatus: bankResult?.loan_status ?? null,\r\n      paypal: {\r\n        orderId,\r\n        captureId,\r\n        amount: verifiedAmount,\r\n        currency: verifiedCurrency,\r\n        status,\r\n      },\r\n    };\r\n\r\n    return new Response(JSON.stringify(responseBody), {\r\n      status: 200,\r\n      headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"paypal-complete-order error:\", error);\r\n\r\n    return new Response(\r\n      JSON.stringify({\r\n        success: false,\r\n        error: error?.message || \"Unknown error\",\r\n      }),\r\n      {\r\n        status: 400,\r\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n      },\r\n    );\r\n  }\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\paypal-create-order\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\paypal-payout\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\paypal-verify-transaction\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\ping\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\platform-fees\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\process-referral-bonuses\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\rtmp-relay\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\send-announcement\\index.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":2,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":2,"endColumn":15,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\send-bulk-notifications\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\send-push-notification\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\sendEmail\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\shadow-ban-user\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\start-officer-vote-cycle\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\streams-maintenance\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\stripe-create-checkout-session\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\stripe-create-payment-intent\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\stripe-payment-methods\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\stripe-webhook\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\submit-training-response\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\toggle-ghost-mode\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\troll-battle\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\troll-events\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\trollcourt-ai\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\types.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\update-notification-preferences\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\user-agreements\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\verify-user-complete\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\supabase\\functions\\vote-for-officer\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\tailwind.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-auth-endpoint.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-cashout-table.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-concurrent-login.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-insurance.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-manual-orders-fix.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-manual-orders.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-payment-flow.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-signup-login-flow.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test-store-transaction.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test_livekit_auth_improved.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\test_loan_rpc.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\trollcity-stream-engine\\src\\server.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\trollcity-stream-engine\\src\\server.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\trollcity-stream-engine\\src\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\verify-packages.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\verify_rls.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\trollcity-1\\vite.config.ts.timestamp-1768987467505-354fbf9de3bc58.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]